<!DOCTYPE html>
<html lang="en">
  <head>
    
      <title>在 Swift 中对集合类型元素的弱引用 :: iBlog</title>
    
    <meta http-equiv="content-type" content="text/html; charset=utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">
<meta name="description" content="Date Notes Swift Xcode     2018-03-15 更新部分表述，并将题目扩展至集合类型 4.0 9.2   2018-03-08 首次提交 4.0 9.2    Preface 为了方便下述 Demo，这里定义一个 Pencil 类，并会使用 func CFGetRetainCount(_ cf: CoreFoundation.CFTypeRef!) -&amp;gt; CFIndex 方法，即传入一个 CFTypeRef 类型的对象即可获取其引用计数。什么是 CFTypeRef？查阅官方文档即可得知 typealias CFTypeRef = AnyObject，所以 CFTypeRef 其实就是 AnyObject。而 AnyObject 又是所有类隐含遵守的协议。
class Pencil { var type: String var price: Double init(_ type: String, _ price: Double) { self.type = type self.price = price } } CFGetRetainCount(Pencil(&amp;quot;2B&amp;quot;, 1."/>
<meta name="keywords" content="kingcos.me,maimieng.comios,swift,objective-c,obj-c,objc,oc,geek,python,ruby,golang,go,apple,mac"/>
<meta name="robots" content="noodp"/>
<link rel="canonical" href="/posts/2018/weakly_collections/" />





<link rel="stylesheet" href="/assets/style.css">


<link rel="stylesheet" href="/style.css">


<link rel="apple-touch-icon-precomposed" sizes="144x144" href="/img/apple-touch-icon-144-precomposed.png">
<link rel="shortcut icon" href="/img/favicon.png">


<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="在 Swift 中对集合类型元素的弱引用"/>
<meta name="twitter:description" content="在 Swift 中对集合类型元素的弱引用。"/>



<meta property="og:title" content="在 Swift 中对集合类型元素的弱引用" />
<meta property="og:description" content="在 Swift 中对集合类型元素的弱引用。" />
<meta property="og:type" content="article" />
<meta property="og:url" content="/posts/2018/weakly_collections/" />
<meta property="article:published_time" content="2018-03-08T00:00:00+00:00" />
<meta property="article:modified_time" content="2018-03-08T00:00:00+00:00" /><meta property="og:site_name" content="iBlog" />






  </head>
  <body class="dark-theme">
    <div class="container">
      <header class="header">
  <span class="header__inner">
    <a href="/" class="logo" style="text-decoration: none;">
  
    <span class="logo__mark"><svg xmlns="http://www.w3.org/2000/svg" class="greater-icon" viewBox="0 0 44 44">
  <path fill="none" d="M15 8l14.729 14.382L15 35.367"/>
</svg>
</span>
    <span class="logo__text">kingcos.me</span>
    <span class="logo__cursor"></span>
  
</a>

    <span class="header__right">
      
        <nav class="menu">
  <ul class="menu__inner menu__inner--desktop">
    
      
        
          <li><a href="/about">About</a></li>
        
      
        
          <li><a href="/links">Links</a></li>
        
      
        
          <li><a href="/perspective">Perspective</a></li>
        
      
        
          <li><a href="/words">Words</a></li>
        
      
      
    
  </ul>

  <ul class="menu__inner menu__inner--mobile">
    
      
        <li><a href="/about">About</a></li>
      
    
      
        <li><a href="/links">Links</a></li>
      
    
      
        <li><a href="/perspective">Perspective</a></li>
      
    
      
        <li><a href="/words">Words</a></li>
      
    
  </ul>
</nav>

        <span class="menu-trigger">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
            <path d="M0 0h24v24H0z" fill="none"/>
            <path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"/>
          </svg>
        </span>
      
      <span class="theme-toggle">
        <svg class="theme-toggler" width="24" height="24" viewBox="0 0 48 48" fill="none" xmlns="http://www.w3.org/2000/svg">
  <path d="M22 41C32.4934 41 41 32.4934 41 22C41 11.5066 32.4934 3 22
  3C11.5066 3 3 11.5066 3 22C3 32.4934 11.5066 41 22 41ZM7 22C7
  13.7157 13.7157 7 22 7V37C13.7157 37 7 30.2843 7 22Z"/>
</svg>

      </span>
    </span>
  </span>
</header>


      <div class="content">
        
  <div class="post">
    <h2 class="post-title"><a href="/posts/2018/weakly_collections/">在 Swift 中对集合类型元素的弱引用</a></h2>
    <div class="post-meta">
      
        <span class="post-date">
            2018-03-08
        </span>
      
      
      
        <span class="post-read-time">— 2 min read</span>
      
    </div>

    
      <span class="post-tags">
        
          #<a href="/tags/practice/">Practice</a>&nbsp;
        
          #<a href="/tags/ios/">iOS</a>&nbsp;
        
          #<a href="/tags/swift/">Swift</a>&nbsp;
        
      </span>
    

    

    <div class="post-content">
      

<table>
<thead>
<tr>
<th align="center">Date</th>
<th align="center">Notes</th>
<th align="center">Swift</th>
<th align="center">Xcode</th>
</tr>
</thead>

<tbody>
<tr>
<td align="center">2018-03-15</td>
<td align="center">更新部分表述，并将题目扩展至集合类型</td>
<td align="center">4.0</td>
<td align="center">9.2</td>
</tr>

<tr>
<td align="center">2018-03-08</td>
<td align="center">首次提交</td>
<td align="center">4.0</td>
<td align="center">9.2</td>
</tr>
</tbody>
</table>

<h2 id="preface">Preface</h2>

<p>为了方便下述 Demo，这里定义一个 Pencil 类，并会使用 <code>func CFGetRetainCount(_ cf: CoreFoundation.CFTypeRef!) -&gt; CFIndex</code> 方法，即传入一个 <code>CFTypeRef</code> 类型的对象即可获取其引用计数。什么是 <code>CFTypeRef</code>？查阅<a href="https://developer.apple.com/documentation/corefoundation/cftyperef">官方文档</a>即可得知 <code>typealias CFTypeRef = AnyObject</code>，所以 <code>CFTypeRef</code> 其实就是 <code>AnyObject</code>。而 <code>AnyObject</code> 又是所有类隐含遵守的协议。</p>

<pre><code class="language-Swift">class Pencil {
    var type: String
    var price: Double
    
    init(_ type: String, _ price: Double) {
        self.type = type
        self.price = price
    }
}

CFGetRetainCount(Pencil(&quot;2B&quot;, 1.0) as CFTypeRef)
// 1

let pencil2B = Pencil(&quot;2B&quot;, 1.0)
let pencilHB = Pencil(&quot;HB&quot;, 2.0)

CFGetRetainCount(pencil2B as CFTypeRef)
CFGetRetainCount(pencilHB as CFTypeRef)
// 2 2
</code></pre>

<h2 id="what">What</h2>

<p>在 Swift 中，当创建一个数组时，数组本身对于添加进去的对象元素默认是强引用（Strong），会使得其引用计数自增。</p>

<pre><code>let pencilBox = [pencil2B, pencilHB]

CFGetRetainCount(pencil2B as CFTypeRef)
CFGetRetainCount(pencilHB as CFTypeRef)
// 3 3
</code></pre>

<p>那么今天的问题即是，如何使得数组本身对数组元素进行弱引用？</p>

<h2 id="how">How</h2>

<h3 id="weakbox">WeakBox</h3>

<pre><code class="language-Swift">final class WeakBox&lt;A: AnyObject&gt; {
    weak var unbox: A?
    init(_ value: A) {
        unbox = value
    }
}

struct WeakArray&lt;Element: AnyObject&gt; {
    private var items: [WeakBox&lt;Element&gt;] = []
    
    init(_ elements: [Element]) {
        items = elements.map { WeakBox($0) }
    }
}

extension WeakArray: Collection {
    var startIndex: Int { return items.startIndex }
    var endIndex: Int { return items.endIndex }
    
    subscript(_ index: Int) -&gt; Element? {
        return items[index].unbox
    }
    
    func index(after idx: Int) -&gt; Int {
        return items.index(after: idx)
    }
}
</code></pre>

<p>定义好一个可以将所有类型的对象转化为弱引用的类，再通过构建好的新类型，将每个强引用元素转换为弱引用元素。利用 Extension，还可以遵守协议，扩展一些集合方法。</p>

<pre><code class="language-Swift">let weakPencilBox1 = WeakArray([pencil2B, pencilHB])

CFGetRetainCount(pencil2B as CFTypeRef)
CFGetRetainCount(pencilHB as CFTypeRef)
// 3 3

let firstElement = weakPencilBox1.filter { $0 != nil }.first
firstElement!!.type
// 2B

CFGetRetainCount(pencil2B as CFTypeRef)
CFGetRetainCount(pencilHB as CFTypeRef)
// 4 3 Note: 这里的 4 是因为 firstElement 持有（Retain）了 pencil2B，导致其引用计数增 1
</code></pre>

<h3 id="nspointerarray">NSPointerArray</h3>

<pre><code class="language-Swift">let weakPencilBox2 = NSPointerArray.weakObjects()

let pencil2BPoiter = Unmanaged.passUnretained(pencil2B).toOpaque()
let pencilHBPoiter = Unmanaged.passUnretained(pencilHB).toOpaque()

CFGetRetainCount(pencil2B as CFTypeRef)
CFGetRetainCount(pencilHB as CFTypeRef)
// 4 3

weakPencilBox2.addPointer(pencil2BPoiter)
weakPencilBox2.addPointer(pencilHBPoiter)

CFGetRetainCount(pencil2B as CFTypeRef)
CFGetRetainCount(pencilHB as CFTypeRef)
// 4 3
</code></pre>

<blockquote>
<p>A collection similar to an array, but with a broader range of available memory semantics.</p>

<p>— <a href="https://developer.apple.com/documentation/foundation/nspointerarray"><em>Apple Documentation</em></a></p>
</blockquote>

<p>即 <code>NSPointerArray</code> 比普通的 <code>NSArray</code> 多了一层内存语义。可以更方便的控制其中元素的引用关系，但少了 Swift 中着重强调的类型安全，所以更推荐第一种做法。</p>

<h3 id="extension">Extension</h3>

<p>其实不只是数组，集合类型的数据结构对其中的元素默认均是强引用。所以为了更加方便地自定义内存管理方式，Objective-C/Swift 中均有普通类型的对应。但在目前的 Swift 中，<code>NSHashTable</code> 和 <code>NSMapTable</code> 均需要指定类型，更加的类型安全（在网上的过时资料中可以看出，之前的 Swift 也没有规定需指定类型），而在 Objective-C 中只要满足 <code>id</code> 类型即可。</p>

<ul>
<li><p><code>NSHashTable</code>:</p>

<pre><code class="language-Swift">// NSHashTable - NSSet
let weakPencilSet = NSHashTable&lt;Pencil&gt;(options: .weakMemory)

weakPencilSet.add(pencil2B)
weakPencilSet.add(pencilHB)
</code></pre></li>

<li><p><code>NSMapTable</code>:</p>

<pre><code class="language-Swift">// NSMapTable - NSDictionary
class Eraser {
var type: String
    
init(_ type: String) {
    self.type = type
}
}

let weakPencilDict = NSMapTable&lt;Eraser, Pencil&gt;(keyOptions: .strongMemory, valueOptions: .weakMemory)
let paintingEraser = Eraser(&quot;Painting&quot;)

weakPencilDict.setObject(pencil2B, forKey: paintingEraser)
</code></pre></li>

<li><p>Objective-C:</p>

<pre><code class="language-objectivec">NSHashTable *set = [NSHashTable hashTableWithOptions:NSPointerFunctionsWeakMemory];
[set addObject:@&quot;Test&quot;];
[set addObject:@12];
</code></pre></li>
</ul>

<h2 id="reference">Reference</h2>

<ul>
<li><a href="https://www.objc.io/blog/2017/12/28/weak-arrays/">Weakly Arrays - objc.io</a></li>
<li><a href="https://developer.apple.com/library/content/documentation/Swift/Conceptual/Swift_Programming_Language/AutomaticReferenceCounting.html">Automatic Reference Counting - The Swift Programming Language (Swift 4.1)</a></li>
<li><a href="https://www.google.com.sg/url?sa=t&amp;rct=j&amp;q=&amp;esrc=s&amp;source=web&amp;cd=1&amp;cad=rja&amp;uact=8&amp;ved=0ahUKEwi3lrPE4dnZAhWBLo8KHcimAwwQFggqMAA&amp;url=https%3A%2F%2Fstackoverflow.com%2Fquestions%2F24127587%2Fhow-do-i-declare-an-array-of-weak-references-in-swift&amp;usg=AOvVaw0XHV471sUykyviiUH7TX2o">How do I declare an array of weak references in Swift? - StackOverflow</a></li>
<li><a href="https://marcosantadev.com/swift-arrays-holding-elements-weak-references/">Swift Arrays Holding Elements With Weak References - Macro Santa</a></li>
<li><a href="http://www.saitjr.com/ios/nspointerarray-nsmaptable-nshashtable.html">Cocoa 集合类型：NSPointerArray，NSMapTable，NSHashTable</a></li>
</ul>

    </div>
    
      <div class="pagination">
        <div class="pagination__title">
          <span class="pagination__title-h">Read other posts</span>
          <hr />
        </div>
        <div class="pagination__buttons">
          
            <span class="button previous">
              <a href="/posts/2018/jdk_multiple_versions/">
                <span class="button__icon">←</span>
                <span class="button__text">简单管理多版本 JDK</span>
              </a>
            </span>
          
          
            <span class="button next">
              <a href="/posts/2018/swift_autoclosure/">
                <span class="button__text">Swift 中的 @autoclosure</span>
                <span class="button__icon">→</span>
              </a>
            </span>
          
        </div>
      </div>
    

    

    
    
    <div>
      <div id="github-comment">
      </div>

      <script type="text/javascript">
        function getUtterances(isDark) {
          var utterances = document.createElement('script');
          utterances.type = 'text/javascript';
          utterances.async = true;
          utterances.setAttribute('issue-term', "pathname")
          utterances.setAttribute('repo', "kingcos\/kingcos.github.io")
          utterances.setAttribute('label', "comments")
          isDark ? utterances.setAttribute('theme', "github-dark") : utterances.setAttribute('theme', "github-light")
          utterances.crossorigin = 'anonymous';
          utterances.src = 'https://utteranc.es/client.js';

          return utterances
        }

        var themeToggle = document.querySelector(".theme-toggle")
        themeToggle.addEventListener("click", function () {
          var getTheme = window.localStorage && window.localStorage.getItem("theme")
          var divNode = document.getElementById('github-comment')
          while(divNode.hasChildNodes()) {
            divNode.removeChild(divNode.firstChild);
          }
          
          
          

          
          
          
          
          
          
          document.getElementById('github-comment').appendChild(getUtterances(getTheme !== "dark"))
        })

        var getTheme = window.localStorage && window.localStorage.getItem("theme")
        document.getElementById('github-comment').appendChild(getUtterances(getTheme === "dark"))
      </script>
    </div>
    

    </div>

      </div>

      
        <footer class="footer">
  <div class="footer__inner">
    
      <div class="copyright copyright--user">All rights reserved by kingcos.me</div>
    
  </div>
</footer>

<script src="/assets/main.js"></script>
<script src="/assets/prism.js"></script>


      
    </div>

    
      
<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
	(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
	m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
	})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
	ga('create', 'UA-138311951-1', 'auto');
	
	ga('send', 'pageview');
}
</script>

    
  </body>
</html>
