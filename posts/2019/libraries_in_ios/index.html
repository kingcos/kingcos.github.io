<!DOCTYPE html>
<html lang="en" >
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="author" content="kingcos" />
	
	
	
	<title>iOS 中的库与框架 ｜ kingcos</title>
	
    
    
    <meta name="description" content="随着软件工程的发展，很多我们需要的功能前人都已经很好地实现了，为了提高效率避免重复建设，这些功能实现的代码被封装为代码库，有时也称框架。我们只需要在用到的时候通过依赖管理工具将它们以适当的方式引入即可。本文将简单聊聊 iOS 中的库与框架相关概念。" />
    

    
    
    <meta name="keywords" content="ios,static,library,framework,objc,objectivec,objective-c,swift,dev,develop,静态库,静态库,框架" />
    

	
    
    <link rel="shortcut icon" href="https://kingcos.me/images/favicon.png" />

    <link rel="stylesheet" type="text/css" media="screen" href="https://kingcos.me/css/normalize.css" />
    <link rel="stylesheet" type="text/css" media="screen" href="https://cdn.jsdelivr.net/npm/animate.css@4.1.0/animate.min.css" />
    <link rel="stylesheet" type="text/css" media="screen" href="https://kingcos.me/css/zozo.css" />
	<link rel="stylesheet" type="text/css" media="screen" href="https://cdn.jsdelivr.net/npm/remixicon@2.5.0/fonts/remixicon.css" />
    <link rel="stylesheet" type="text/css" media="screen" href="https://kingcos.me/css/highlight.css" />

    
    
</head>

<script data-ad-client="ca-pub-9925978992661955" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>


<body>
    <div class="main animate__animated animate__fadeInDown">
        <div class="nav_container animated fadeInDown">
    <div class="site_nav" id="site_nav">
        <ul>
            
            <li>
                <a href="/">Home</a>
            </li>
            
            <li>
                <a href="/posts/">Archive</a>
            </li>
            
            <li>
                <a href="/tags/">Tags</a>
            </li>
            
            <li>
                <a href="/about/">About</a>
            </li>
            
        </ul>
    </div>
    <div class="menu_icon">
        <a id="menu_icon"><i class="ri-menu-line"></i></a>
    </div>
</div>


<link rel="stylesheet" href="https://kingcos.me/scss/main.min.7b6e5090dd63f35c42913c169ca8464a3ba4c70a9de89e9ca3535ce45de13d3d.css" integrity="sha256-e25QkN1j81xCkTwWnKhGSjukxwqd6J6co1Nc5F3hPT0=" media="screen">

<style>
.nav_container {
  height: 1rem;
}
 
table {
    width: 100%;
    table-layout: fixed;
}

 
.markdown code {
    white-space: normal;
    word-wrap: break-word;
    line-height: 1.5em;
    font-size: 0.85em;
    font-weight: bold;
    display: inline-block;
     
}

 
.menu_icon a {
    font-size: 16px;
}

 
body {
    font-family: 'Hiragino Sans GB', 'SFMono', 'Lato', '-apple-system';
    -webkit-font-smoothing: 'antialiased';
}

 
.markdown strong, .markdown b, .markdown em {
    font-weight: bold;
}

.post .post_content p {
     

    line-height: 1.75em;
}

 
.markdown img {
     
    margin: 0 auto;
    display: block;
}

 
.ri-stack-line {
    vertical-align: middle;
}

 
.ri-map-pin-time-line {
    vertical-align: middle;
}

 

 
.markdown .book-hint::before {
    content: none;
}

.markdown .book-hint {
    margin: 1rem 0;
    padding: 0.5rem 1rem 0.5rem 0.75rem;

    border-inline-start: 0.25rem solid #e9ecef;
    border-radius: 0.25rem;

    font-style: normal;
     
}

.book-hint strong {
    background-color: transparent;
}

.markdown .book-hint.info {
    border-left-color:#6bf;
    background-color:rgba(102,187,255,.1);
}

.markdown .book-hint.warning {
    border-left-color:#fd6;
    background-color:rgba(255,221,102,.1);
}

.markdown .book-hint.danger {
    border-left-color:#f66;
    background-color:rgba(255,102,102,.1);
}

</style>

        <div class="header animated fadeInDown">
    <div class="site_title_container">
        <div class="site_title">
            
                <a href="https://kingcos.me/">
                    
                    <img style="margin-top: -15px;" src="/title.svg" width="150px">
                </a>
            
        </div>
        <div class="description">
            <p class="sub_title">专注、坚持</p>
            <div class="my_socials">
                
                
                <a href="https://github.com/kingcos" title="github" target="_blank"><i class="ri-github-fill"></i></a>
                
                
                
                <a href="https://www.instagram.com/kingcos_v/" title="instagram" target="_blank"><i class="ri-instagram-fill"></i></a>
                
                
                
                <a href="https://twitter.com/kingcos_v" title="twitter" target="_blank"><i class="ri-twitter-fill"></i></a>
                
                
                
                <a href="https://weibo.com/u/1798410923" title="weibo" target="_blank"><i class="ri-weibo-fill"></i></a>
                
                
                
            </div>
        </div>
    </div>
</div>
        <div class="content">
            <div class="post_page">
                <div class="post animate__animated animate__fadeInDown">
                    <div class="post_title post_detail_title">
                        <h2><a href='/posts/2019/libraries_in_ios/'>iOS 中的库与框架</a></h2>
                        <span class="date">2019.10.29</span>
                        <span>by kingcos</span>
                        
                        
                        
                    </div>
                    <div class="post_content markdown"><table>
<thead>
<tr>
<th style="text-align:center">Date</th>
<th style="text-align:center">Notes</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">2019-09-14</td>
<td style="text-align:center">首次提交，持续更新完善</td>
</tr>
<tr>
<td style="text-align:center">2019-09-22</td>
<td style="text-align:center">适配 Xcode 11，持续更新完善</td>
</tr>
<tr>
<td style="text-align:center">2019-10-29</td>
<td style="text-align:center">添加 Demo：<a href="https://github.com/kingcos/libraries_in_ios-demo">libraries_in_ios-demo</a></td>
</tr>
</tbody>
</table>
<p><img src="/img/2019/libraries_in_ios/0.png" alt="0"></p>
<h2 id="preface">Preface</h2>
<p>随着软件工程的发展，很多我们需要的功能前人都已经很好地实现了，为了提高效率避免重复建设，这些功能实现的代码被封装为代码库，有时也称框架。我们只需要在用到的时候通过依赖管理工具将它们以适当的方式引入即可。本文将简单聊聊 iOS 中的库与框架相关概念。</p>
<h2 id="基本概念">基本概念</h2>
<p>在切入正题之前，我们先来达成一些共识。</p>
<p>不管是老派 Obj-C 还是新秀 Swift，它们的本质都是编译型语言。对于编译型语言，源代码会首先经由编译器编译为目标文件，链接器再将多个目标文件链接为可执行文件。针对链接阶段，主要分为静态链接与动态链接。</p>
<p><strong>静态</strong>，即 Static。按照字面意思，静态即一旦确定，就不再容易改变。静态链接，即在链接阶段，直接将多个目标文件链接为一个文件。而静态库就可以理解为共同编译为一个目标文件的源代码集合。</p>
<p><strong>动态</strong>，即 Dynamic。按照字面意思，动态即推迟到运行时动态地决议。动态链接，即在运行时才将各个部分组合形成完整的程序。而动态库就可以理解为支持动态链接方式的源代码集合。</p>
<p>静态链接的好处是，运行时不再额外需要时间动态链接；坏处则是由于链接的粒度是目标文件，那么可能会链接了没有使用到的函数，会造成可执行文件过大；而且当某一个目标文件的源代码改动时，那么所有依赖该目标文件的静态库都需要重新编译；动态链接则解决了静态链接的空间浪费与重复编译问题，比如在 iOS 中，系统库采用了 dyld_shared_cache 动态链接，这样其它程序就无需再将系统库重复链接，当 iOS 系统更新时也无需将所有 app 重新编译。而在移动端开发中，app 的启动时间与包体积大小将是一个权衡问题，值得我们侧重与考量。</p>
<p>另外，虽然广义上的库（Library）与框架（Framework）含义是类似的，但在 iOS 开发中，官方将这两个概念进行了区分，因此下文中我们会明确两个词的使用。</p>
<h2 id="cocoa-touch-static-library">Cocoa Touch Static Library</h2>
<p>我们先从 Xcode 中能够直接创建的 Cocoa Touch Static Library 说起（注意，在 Xcode 11 中，这里已经变成 Framework 与 Library，更加清晰）：</p>
<p><img src="/img/2019/libraries_in_ios/1.png" alt="1"></p>
<p>Cocoa Touch Static Library 即静态库。iOS 上狭义的静态库，即<strong>只包含编译后代码的 <code>.a</code> 文件</strong>。我们创建一个 oc-static-lib 的静态库，为其默认提供的 <code>oc_static_lib</code> 类添加 <code>foo</code> 方法，并添加一个 <code>NSObject</code> 的分类，实现 +load 和 <code>foo</code> 方法：</p>
<div class="highlight"><pre class="chroma"><code class="language-objectivec" data-lang="objectivec"><span class="c1">// oc_static_lib.h
</span><span class="c1"></span>
<span class="cp">#import &lt;Foundation/Foundation.h&gt;
</span><span class="cp"></span>
<span class="k">@interface</span> <span class="nc">oc_static_lib</span> : <span class="nc">NSObject</span>
<span class="p">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">foo</span><span class="p">;</span>
<span class="k">@end</span>

<span class="c1">// oc_static_lib.m
</span><span class="c1"></span>
<span class="cp">#import &#34;oc_static_lib.h&#34;
</span><span class="cp"></span>
<span class="k">@implementation</span> <span class="nc">oc_static_lib</span>
<span class="p">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">foo</span> <span class="p">{</span>
    <span class="n">NSLog</span><span class="p">(</span><span class="s">@&#34;%@ - %@&#34;</span><span class="p">,</span> <span class="n">NSStringFromClass</span><span class="p">([</span><span class="nb">self</span> <span class="k">class</span><span class="p">]),</span> <span class="n">NSStringFromSelector</span><span class="p">(</span><span class="n">_cmd</span><span class="p">));</span>
<span class="p">}</span>
<span class="k">@end</span>

<span class="c1">// NSObject+OC_Static_Lib.h
</span><span class="c1"></span>
<span class="cp">#import &lt;Foundation/Foundation.h&gt;
</span><span class="cp"></span>
<span class="n">NS_ASSUME_NONNULL_BEGIN</span>
<span class="k">@interface</span> <span class="nc">NSObject</span> <span class="nl">(OC_Static_Lib)</span>
<span class="p">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">foo</span><span class="p">;</span>
<span class="k">@end</span>
<span class="n">NS_ASSUME_NONNULL_END</span>

<span class="c1">// NSObject+OC_Static_Lib.m
</span><span class="c1"></span>
<span class="cp">#import &#34;NSObject+OC_Static_Lib.h&#34;
</span><span class="cp"></span>
<span class="k">@implementation</span> <span class="nc">NSObject</span> <span class="nl">(OC_Static_Lib)</span>
<span class="p">+</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">load</span> <span class="p">{</span>
    <span class="n">NSLog</span><span class="p">(</span><span class="s">@&#34;%@ - %@&#34;</span><span class="p">,</span> <span class="n">NSStringFromClass</span><span class="p">([</span><span class="nb">self</span> <span class="k">class</span><span class="p">]),</span> <span class="n">NSStringFromSelector</span><span class="p">(</span><span class="n">_cmd</span><span class="p">));</span>
<span class="p">}</span>
<span class="p">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">foo</span> <span class="p">{</span>
    <span class="n">NSLog</span><span class="p">(</span><span class="s">@&#34;%@ - %@&#34;</span><span class="p">,</span> <span class="n">NSStringFromClass</span><span class="p">([</span><span class="nb">self</span> <span class="k">class</span><span class="p">]),</span> <span class="n">NSStringFromSelector</span><span class="p">(</span><span class="n">_cmd</span><span class="p">));</span>
<span class="p">}</span>
<span class="k">@end</span>
</code></pre></div><p>需要注意的是我们需要将新创建的 <code>.h</code> 加入到 Xcode - Targets - Build Phases - Copy Files 中，这样外界才能通过引入该头文件来访问其中的内容：</p>
<p><img src="/img/2019/libraries_in_ios/2.png" alt="2"></p>
<blockquote>
<p>⚠️ 注意：</p>
<p>这里我们的目标设备选择的是模拟器，所以默认编译后的 <code>.a</code> 文件也将只适用于模拟器架构（x86_64），为了同时能够真机运行和模拟器调试，通常会使用 <code>lipo</code> 命令将多种架构的 <code>.a</code> 文件进行合并为胖二进制（Fat-Binary）文件。</p>
</blockquote>
<h3 id="obj-c-工程引入-obj-c-静态库">Obj-C 工程引入 Obj-C 静态库</h3>
<p><img src="/img/2019/libraries_in_ios/3.png" alt="3"></p>
<p>我们将 oc-static-lib 编译后的 <code>.a</code> 与 <code>.h</code> 一起拖入 Obj-C 工程（勾选「Add to targets」添加至目标 Target，或者手动将 <code>.a</code> 加入到「Link Binary With Libraries」中），即可使用 <code>#import &quot;&quot;</code> 来引入并调用（需要注意的是：静态库中如果存在分类，需要添加 <code>-ObjC</code> 作为 Other Linker Flags，具体可详见《<a href="/posts/2019/+load_in_ios/">iOS 中的 +load 方法</a>》一文）：</p>
<blockquote>
<p><strong>Tips</strong></p>
<p>在 C/C++ 中，为了更加清晰化声明与实现，声明和实现需要分别写在 <code>.h</code>（头文件）和 <code>.c</code> / <code>.cpp</code>（实现文件）中。这样的好处是，开发者可以无需额外的访问控制符即可将需要暴露在外界的声明放置在头文件中，外界使用时通过 <code>#include</code> 引用头文件即可。Obj-C/C++ 也延续了这一传统，不同的是实现文件的后缀分别为 <code>.m</code> 和 <code>.mm</code>，并为了避免重复引用新推出了 <code>#import</code>。</p>
<p><code>#include</code> 和 <code>#import</code> 后面都可以加 <code>&lt;XXX.h&gt;</code> 或 <code>&quot;XXX.h&quot;</code>。通常来说加 <code>&quot;&quot;</code> 的头文件优先从本地当前文件目录查找，其中也可以包含相对路径，即 <code>#import &quot;oc-static-lib/oc_static_lib.h&quot;</code> / <code>#import &quot;NSObject+OC_Static_Lib.h&quot;</code> 都是支持的；而加 <code>&lt;&gt;</code> 的头文件则会使得编译器优先到系统目录下全局查找。</p>
</blockquote>
<h3 id="swift-工程引入-swift-静态库">Swift 工程引入 Swift 静态库</h3>
<p>在 Xcode 9 之后，Swift 也支持了静态库。与 Obj-C 不同，Swift 没有头文件的概念，因此我们需要将暴露给外界的类和函数等使用 <code>public</code> 修饰。编译后的 Swift 静态库也是 <code>.a</code> 文件，但不同的是多了 <code>.swiftmodule</code> 以及 <code>.swiftdoc</code>：</p>
<div class="highlight"><pre class="chroma"><code class="language-shell" data-lang="shell">➜  Debug-iphonesimulator tree
.
├── libswift-static-lib.a
└── swift_static_lib.swiftmodule
    ├── x86_64.swiftdoc
    └── x86_64.swiftmodule

<span class="m">1</span> directory, <span class="m">3</span> files
</code></pre></div><p><code>.swiftmodule</code> 包含了序列化过的 AST（抽象语法树，Abstract Syntax Tree），可能也包含 SIL（Swift 中间语言，Swift Intermediate Language），我们可以将其理解为类似 C 语言库或框架中头文件的二进制格式文件；<code>.swiftdoc</code> 则是 Swift 文档注释生成的二进制文件，由 <code>Serialization::writeDocToStream()</code> 生成，因此并非是必要的。由于 Swift 的 Module 机制，我们需要在 Xcode - Targets - Build Settings - Swift Compiler - Search Paths - Import Paths 中引入：</p>
<p><img src="/img/2019/libraries_in_ios/4.png" alt="4"></p>
<p>这样我们才能在 Swift 工程中正常使用：</p>
<div class="highlight"><pre class="chroma"><code class="language-swift" data-lang="swift"><span class="c1">// swift_static_lib.swift</span>

<span class="kd">import</span> <span class="nc">Foundation</span>

<span class="kr">@objc</span> <span class="kd">public</span> <span class="kd">class</span> <span class="nc">swift_static_lib</span><span class="p">:</span> <span class="n">NSObject</span> <span class="p">{</span>
    <span class="kr">@objc</span> <span class="kd">public</span> <span class="kd">func</span> <span class="nf">foo</span><span class="p">()</span> <span class="p">{</span>
        <span class="bp">print</span><span class="p">(</span><span class="s">&#34;swift_static_lib - </span><span class="si">\(</span><span class="kc">#function</span><span class="si">)</span><span class="s">&#34;</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="c1">// ViewController.swift</span>

<span class="kd">import</span> <span class="nc">UIKit</span>
<span class="kd">import</span> <span class="nc">swift_static_lib</span>

<span class="kd">class</span> <span class="nc">ViewController</span><span class="p">:</span> <span class="n">UIViewController</span> <span class="p">{</span>
    <span class="kr">override</span> <span class="kd">func</span> <span class="nf">viewDidLoad</span><span class="p">()</span> <span class="p">{</span>
        <span class="kc">super</span><span class="p">.</span><span class="n">viewDidLoad</span><span class="p">()</span>
        <span class="n">swift_static_lib</span><span class="p">().</span><span class="n">foo</span><span class="p">()</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div><h3 id="obj-c-工程引入-swift-静态库">Obj-C 工程引入 Swift 静态库</h3>
<p>为了「提拔」新秀，Swift 支持与 Obj-C 混编，然而混编下的各种情况就会变得十分特殊。在同一个工程下 Swift 文件与 Obj-C 文件混编时，Xcode 会提示我们创建桥接头文件 <code>&lt;PROJECT_NAME&gt;-Bridging-Header.h</code>，我们可以将需要暴露给 Swift 的 Obj-C 代码在该桥接文件中引入；而 Obj-C 代码中希望使用 Swift 中的相关定义时，可以引入自动生成但不可见的 <code>&lt;PROJECT_NAME&gt;-Swift.h</code>，另外需要注意的是，暴露给 Obj-C 的类或函数等需要使用 <code>@objc</code> 或 <code>dynamic</code> 修饰，<strong>但前者不能决定函数最终派发方式，而后者则为动态派发</strong>。</p>
<p>那么如果要在 Obj-C 工程引入 Swift 静态库，首先要在工程中引入一个占位 Swift 文件，并创建桥接文件，这样 Xcode 中 Swift 相关的依赖配置才能得以建立：</p>
<p><img src="/img/2019/libraries_in_ios/7.png" alt="7"></p>
<p>Swift 静态库也可以自动生成 <code>&lt;PROJECT_NAME&gt;-Swift.h</code>，但其并没有和最终产物 <code>.a</code> 放置在一起：</p>
<div class="highlight"><pre class="chroma"><code class="language-shell" data-lang="shell">➜  Build tree
.
├── Intermediates.noindex
│   ├── XCBuildData
│   │   └── ...
│   └── swift_static_lib.build
│       └── Debug-iphonesimulator
│           └── swift_static_lib.build
│               ├── DerivedSources
│               │   └── swift_static_lib-Swift.h ⬅️
│               └── ...
└── Products
    └── ...

<span class="m">17</span> directories, <span class="m">41</span> files
</code></pre></div><p>因此我们可以将以下脚本添加到 Xcode - Targets - Build Phases - New Run Script Phase 中，这样每次构建即可将 <code>&lt;PROJECT_NAME&gt;-Swift.h</code> 一并拷贝到产物目录：</p>
<div class="highlight"><pre class="chroma"><code class="language-shell" data-lang="shell"><span class="c1"># Powered by https://paul-samuels.com/blog/2018/01/14/swift-static-library-in-objective-c/</span>

<span class="c1"># BUILT_PRODUCTS_DIR：构建产物目录；PRODUCT_MODULE_NAME：产物名称</span>
<span class="nv">target_dir</span><span class="o">=</span><span class="si">${</span><span class="nv">BUILT_PRODUCTS_DIR</span><span class="si">}</span>/include/<span class="si">${</span><span class="nv">PRODUCT_MODULE_NAME</span><span class="si">}</span>/

<span class="c1"># Ensure the target include path exists</span>
<span class="c1"># 递归创建文件夹</span>
mkdir -p <span class="si">${</span><span class="nv">target_dir</span><span class="si">}</span>

<span class="c1"># Copy any file that looks like a Swift generated header to the include path</span>
<span class="c1"># 复制到产物路径</span>
cp <span class="si">${</span><span class="nv">DERIVED_SOURCES_DIR</span><span class="si">}</span>/*-Swift.h <span class="si">${</span><span class="nv">target_dir</span><span class="si">}</span>
</code></pre></div><p>之后我们需要将生成的产物放 swift_static_lib 文件中一起拖到 Obj-C 工程中（勾选「Add to targets」添加至目标 Target，或者手动将 <code>.a</code> 加入到「Link Binary With Libraries」中）：</p>
<div class="highlight"><pre class="chroma"><code class="language-shell" data-lang="shell">➜  swift_static_lib tree
.
├── include
│   └── swift_static_lib
│       └── swift_static_lib-Swift.h
├── libswift_static_lib.a
└── swift_static_lib.swiftmodule
    ├── x86_64.swiftdoc
    └── x86_64.swiftmodule

<span class="m">3</span> directories, <span class="m">4</span> files
</code></pre></div><!-- 最后再在 Xcode - Targets - Build Settings - Header Search Paths & Library Search Paths 中添加上 `.a` 的父级路径 `$(PROJECT_DIR)/oc-demo-project/swift_static_lib` 即可（比较神奇的是，在 Xcode 11 中即使不手动指定，也可正常编译通过运行）：

![6](/img/2019/libraries_in_ios/6.png) -->
<p>这样，在 Obj-C 工程中通过 <code>#import &quot;swift_static_lib-Swift.h&quot;</code> 即可使用：</p>
<div class="highlight"><pre class="chroma"><code class="language-objectivec" data-lang="objectivec"><span class="c1">// ViewController.m
</span><span class="c1"></span>
<span class="c1">//#import &#34;swift-static-lib/include/swift_static_lib/swift_static_lib-Swift.h&#34;
</span><span class="c1"></span><span class="cp">#import &#34;swift_static_lib-Swift.h&#34;
</span><span class="cp"></span>
<span class="k">@implementation</span> <span class="nc">ViewController</span>

<span class="p">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">viewDidLoad</span> <span class="p">{</span>
    <span class="p">[</span><span class="nb">super</span> <span class="n">viewDidLoad</span><span class="p">];</span>

    <span class="p">[[</span><span class="n">swift_static_lib</span> <span class="n">new</span><span class="p">]</span> <span class="n">foo</span><span class="p">];</span>
<span class="p">}</span>
</code></pre></div><h3 id="swift-工程引入-obj-c-静态库">Swift 工程引入 Obj-C 静态库</h3>
<p>如果想要在 Swift 工程中引入 Obj-C 静态库（注意如有分类仍需加 <code>-ObjC</code>），则也需要桥接头文件作为中介。我们在工程中新建一个占位 Obj-C 文件，按 Xcode 提示创建桥接文件；将 oc-static-lib 编译后的产物一起拖入 Swift 工程，并在桥接文件中引入 Obj-C 静态库中的相关头文件：</p>
<div class="highlight"><pre class="chroma"><code class="language-objectivec" data-lang="objectivec"><span class="c1">// swift-demo-project-Bridging-Header.h
</span><span class="c1"></span>
<span class="c1">//#import &#34;liboc-static-lib/include/oc-static-lib/oc_static_lib.h&#34;
</span><span class="c1"></span><span class="cp">#import &#34;oc_static_lib.h&#34;
</span></code></pre></div><p>之后即可直接在 Swift 中使用：</p>
<div class="highlight"><pre class="chroma"><code class="language-swift" data-lang="swift"><span class="c1">// ViewController.swift</span>

<span class="kd">import</span> <span class="nc">UIKit</span>

<span class="kd">class</span> <span class="nc">ViewController</span><span class="p">:</span> <span class="n">UIViewController</span> <span class="p">{</span>
    <span class="kr">override</span> <span class="kd">func</span> <span class="nf">viewDidLoad</span><span class="p">()</span> <span class="p">{</span>
        <span class="kc">super</span><span class="p">.</span><span class="n">viewDidLoad</span><span class="p">()</span>

        <span class="n">oc_static_lib</span><span class="p">().</span><span class="n">foo</span><span class="p">()</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div><h2 id="cocoa-touch-framework">Cocoa Touch Framework</h2>
<p>Cocoa Touch Framework 是 Xcode 中能够创建的另外一种框架（Framework）类型（注意，在 Xcode 11 中，这里已经变成 Framework 与 Library，更加清晰），而非库（Library）。不同于库，iOS 中的框架指的是包含资源（比如图片、本地化文件、Storyboard 等）、头文件、以及编译后的二进制等的集合。框架的后缀名是 <code>.framework</code>，并可以通过 <code>NSBundle</code> API 访问，不同的是框架可以直接导航到其中的目录内容，便于开发者查看：</p>
<div class="highlight"><pre class="chroma"><code class="language-shell" data-lang="shell">➜  oc_framework.framework tree
.
├── Assets.car ➡️ 工程中的 xcassets 资源将被压缩为 car
├── Headers
│   ├── NSObject+OC_Framework.h
│   ├── OC_Foo.h
│   ├── PublicHeader.h
│   └── oc_framework.h
├── Info.plist
├── Modules
│   └── module.modulemap 🌟
├── _CodeSignature
│   └── CodeResources
└── oc_framework

<span class="m">3</span> directories, <span class="m">9</span> files

➜  swift_framework.framework tree
.
├── Headers
│   ├── swift_framework-Swift.h ➡️ 自动生成的 *-Swift.h 便于 Obj-C 工程使用
│   └── swift_framework.h
├── Info.plist
├── Modules
│   ├── module.modulemap 🌟
│   └── swift_framework.swiftmodule ➡️ 类似 Swift 静态库
│       ├── x86_64.swiftdoc
│       └── x86_64.swiftmodule
├── _CodeSignature
│   └── CodeResources
├── eng.strings ➡️ 工程中的 strings 资源
└── swift_framework

<span class="m">4</span> directories, <span class="m">9</span> files
</code></pre></div><p>Framework 中编译后的 Mach-O 可以根据需要作为动态库、静态库（注意如有分类仍需加 <code>-ObjC</code>）、或者可执行文件等：</p>
<p><img src="/img/2019/libraries_in_ios/8.png" alt="8"></p>
<p>Framework 中需要暴露在外界的头文件，需要在 Xcode - Targets - Build Phases - Headers - Public 中公开（Swift Framework 中的 <code>*-Swift.h</code> 则不需要手动移动）；资源文件则需要加入 Copy Bundle Resources 中（使用时通过 <code>NSBunlde</code> API）：</p>
<p><img src="/img/2019/libraries_in_ios/10.png" alt="10"></p>
<h3 id="obj-c-工程">Obj-C 工程</h3>
<p>在 Obj-C 工程中，只需要将 Framework 产物拖入并在 Xcode - Targets - General - Embedded Binaries &amp; Links Framework and Libraries 中添加即可(Xcode 11 中需将 Framework 在 Xcode - General - Frameworks, Libraries, and Embedded Content 中设置为 Embed）：</p>
<p><img src="/img/2019/libraries_in_ios/9.png" alt="9"></p>
<p>在工程中我们就可以将其引入并使用了：</p>
<p><strong>oc-framework:</strong></p>
<div class="highlight"><pre class="chroma"><code class="language-objectivec" data-lang="objectivec"><span class="c1">// OC_Foo.m
</span><span class="c1"></span>
<span class="cp">#import &#34;OC_Foo.h&#34;
</span><span class="cp"></span>
<span class="k">@implementation</span> <span class="nc">OC_Foo</span>
<span class="p">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">foo</span> <span class="p">{</span>
    <span class="n">NSLog</span><span class="p">(</span><span class="s">@&#34;%@ - %@&#34;</span><span class="p">,</span> <span class="n">NSStringFromClass</span><span class="p">([</span><span class="nb">self</span> <span class="k">class</span><span class="p">]),</span> <span class="n">NSStringFromSelector</span><span class="p">(</span><span class="n">_cmd</span><span class="p">));</span>
<span class="p">}</span>

<span class="p">-</span> <span class="p">(</span><span class="n">UIImage</span> <span class="o">*</span><span class="p">)</span><span class="nf">image</span> <span class="p">{</span>
    <span class="c1">// 通过 NSBundle 获取资源
</span><span class="c1"></span>    <span class="n">NSBundle</span> <span class="o">*</span><span class="n">bundle</span> <span class="o">=</span> <span class="p">[</span><span class="n">NSBundle</span> <span class="nl">bundleForClass</span><span class="p">:[</span><span class="nb">self</span> <span class="k">class</span><span class="p">]];</span>
    <span class="k">return</span> <span class="p">[</span><span class="n">UIImage</span> <span class="nl">imageNamed</span><span class="p">:</span><span class="s">@&#34;blog&#34;</span> <span class="nl">inBundle</span><span class="p">:</span><span class="n">bundle</span> <span class="nl">compatibleWithTraitCollection</span><span class="p">:</span><span class="nb">nil</span><span class="p">];</span>
<span class="p">}</span>
<span class="k">@end</span>
</code></pre></div><p><strong>swift-framework:</strong></p>
<div class="highlight"><pre class="chroma"><code class="language-swift" data-lang="swift"><span class="c1">// Swift_Foo.swift</span>

<span class="kd">import</span> <span class="nc">Foundation</span>

<span class="kr">@objc</span> <span class="kd">public</span> <span class="kd">class</span> <span class="nc">Swift_Foo</span> <span class="p">:</span> <span class="n">NSObject</span> <span class="p">{</span>
    <span class="kr">@objc</span> <span class="kd">public</span> <span class="kd">func</span> <span class="nf">foo</span><span class="p">()</span> <span class="p">{</span>
        <span class="bp">print</span><span class="p">(</span><span class="s">&#34;Swift_Foo - </span><span class="si">\(</span><span class="kc">#function</span><span class="si">)</span><span class="s">&#34;</span><span class="p">)</span>
    <span class="p">}</span>

    <span class="kr">@objc</span> <span class="kd">public</span> <span class="kd">func</span> <span class="nf">strings</span><span class="p">()</span> <span class="p">-&gt;</span> <span class="nb">String</span> <span class="p">{</span>
        <span class="kd">let</span> <span class="nv">bundle</span> <span class="p">=</span> <span class="n">Bundle</span><span class="p">(</span><span class="k">for</span><span class="p">:</span> <span class="n">Swift_Foo</span><span class="p">.</span><span class="kc">self</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">NSLocalizedString</span><span class="p">(</span><span class="s">&#34;my_blog&#34;</span><span class="p">,</span> <span class="n">bundle</span><span class="p">:</span> <span class="n">bundle</span><span class="p">,</span> <span class="n">comment</span><span class="p">:</span> <span class="s">&#34;My blog link.&#34;</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div><p><strong>Obj-C 工程：</strong></p>
<div class="highlight"><pre class="chroma"><code class="language-objectivec" data-lang="objectivec"><span class="c1">// ViewController.m
</span><span class="c1"></span>
<span class="cp">#import &#34;ViewController.h&#34;
</span><span class="cp"></span><span class="p">@</span><span class="n">import</span> <span class="n">oc_framework</span><span class="p">;</span>
<span class="c1">//#import &#34;oc_framework/oc_framework.h&#34;
</span><span class="c1">//#import &lt;oc_framework/oc_framework.h&gt;
</span><span class="c1">//#import &lt;oc_framework/PublicHeader.h&gt;
</span><span class="c1">//#import &lt;oc_framework/OC_Foo.h&gt;
</span><span class="c1"></span>
<span class="p">@</span><span class="n">import</span> <span class="n">swift_framework</span><span class="p">;</span>
<span class="c1">//#import &#34;swift_framework/swift_framework.h&#34;
</span><span class="c1">//#import &#34;swift_framework/swift_framework-Swift.h&#34;
</span><span class="c1">//#import &lt;swift_framework/swift_framework.h&gt;
</span><span class="c1">//#import &lt;swift_framework/swift_framework-Swift.h&gt;
</span><span class="c1"></span>
<span class="k">@interface</span> <span class="nc">ViewController</span> <span class="p">()</span>
<span class="k">@property</span> <span class="p">(</span><span class="k">weak</span><span class="p">,</span> <span class="k">nonatomic</span><span class="p">)</span> <span class="kt">IBOutlet</span> <span class="n">UIImageView</span> <span class="o">*</span><span class="n">imageView</span><span class="p">;</span>
<span class="k">@end</span>

<span class="k">@implementation</span> <span class="nc">ViewController</span>

<span class="p">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">viewDidLoad</span> <span class="p">{</span>
    <span class="p">[</span><span class="nb">super</span> <span class="n">viewDidLoad</span><span class="p">];</span>

    <span class="n">OC_Foo</span> <span class="o">*</span><span class="n">foo</span> <span class="o">=</span> <span class="p">[</span><span class="n">OC_Foo</span> <span class="n">new</span><span class="p">];</span>
    <span class="p">[</span><span class="n">foo</span> <span class="n">foo</span><span class="p">];</span>

    <span class="nb">self</span><span class="p">.</span><span class="n">imageView</span><span class="p">.</span><span class="n">image</span> <span class="o">=</span> <span class="p">[</span><span class="n">foo</span> <span class="n">image</span><span class="p">];</span>

    <span class="n">Swift_Foo</span> <span class="o">*</span><span class="n">sFoo</span> <span class="o">=</span> <span class="p">[[</span><span class="n">Swift_Foo</span> <span class="n">alloc</span><span class="p">]</span> <span class="n">init</span><span class="p">];</span>
    <span class="p">[</span><span class="n">sFoo</span> <span class="n">foo</span><span class="p">];</span>

    <span class="n">NSLog</span><span class="p">(</span><span class="s">@&#34;%@&#34;</span><span class="p">,</span> <span class="p">[</span><span class="n">sFoo</span> <span class="n">strings</span><span class="p">]);</span>
<span class="p">}</span>

<span class="k">@end</span>
</code></pre></div><h3 id="swift-工程">Swift 工程</h3>
<p>Framework 的引入要比静态库简单许多，我们只需要将其直接引入工程中（注意如有分类仍需加 <code>-ObjC</code>），并在 Swift 通过 <code>import &lt;FRAMEWORK_NAME&gt;</code> 导入即可：</p>
<div class="highlight"><pre class="chroma"><code class="language-swift" data-lang="swift"><span class="kd">import</span> <span class="nc">UIKit</span>
<span class="kd">import</span> <span class="nc">oc_framework</span>
<span class="kd">import</span> <span class="nc">swift_framework</span>

<span class="kd">class</span> <span class="nc">ViewController</span><span class="p">:</span> <span class="n">UIViewController</span> <span class="p">{</span>
    <span class="kr">@IBOutlet</span> <span class="kr">weak</span> <span class="kd">var</span> <span class="nv">imageView</span><span class="p">:</span> <span class="n">UIImageView</span><span class="p">!</span>

    <span class="kr">override</span> <span class="kd">func</span> <span class="nf">viewDidLoad</span><span class="p">()</span> <span class="p">{</span>
        <span class="kc">super</span><span class="p">.</span><span class="n">viewDidLoad</span><span class="p">()</span>

        <span class="kd">let</span> <span class="nv">foo</span> <span class="p">=</span> <span class="n">OC_Foo</span><span class="p">()</span>
        <span class="n">foo</span><span class="p">.</span><span class="n">foo</span><span class="p">()</span>
        <span class="c1">// ⚠️ 注意，比较奇怪的是：</span>
        <span class="c1">// 只有当 Obj-C Framework 的 Mach-O 类型为动态库时，以下的资源才有效</span>
        <span class="n">imageView</span><span class="p">.</span><span class="n">image</span> <span class="p">=</span> <span class="n">foo</span><span class="p">.</span><span class="n">image</span><span class="p">()</span>

        <span class="kd">let</span> <span class="nv">sFoo</span> <span class="p">=</span> <span class="n">Swift_Foo</span><span class="p">()</span>
        <span class="n">sFoo</span><span class="p">.</span><span class="n">foo</span><span class="p">()</span>
        <span class="bp">print</span><span class="p">(</span><span class="n">sFoo</span><span class="p">.</span><span class="n">strings</span><span class="p">())</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div><h3 id="aggregate-target">Aggregate Target</h3>
<p><img src="/img/2019/libraries_in_ios/11.png" alt="11"></p>
<p>关于 Aggregate Target，官方提供的可参考资料很少。老版本的 Xcode 中将其描述为「This target is used to aggregate other targets together」，即 aggregate 本身具有聚合、总计之意，而 Aggregate Target 正是用于聚合其它 Target，使得可以在 Xcode 中达到一次性构建多个 Target 的目的。比如我们这里有多个 Framework，即可使用 Aggregate Target 同时构建，但这并不会影响最终产物：</p>
<p><img src="/img/2019/libraries_in_ios/17.png" alt="17"></p>
<h2 id="cocoapods">CocoaPods</h2>
<p>iOS 开发发展的这些年，CocoaPods 是 iOS/macOS 开发的老牌搭档，用来帮助我们管理工程依赖。</p>
<h3 id="非-use_frameworks">非 use_frameworks!</h3>
<h4 id="obj-c-工程与-obj-c-pod">Obj-C 工程与 Obj-C Pod</h4>
<p>使用 <code>pod lib create oc-pod</code> 即可以创建我们的私有 Pod，资源文件的管理这里我们尝试使用两种方式：</p>
<div class="highlight"><pre class="chroma"><code class="language-ruby" data-lang="ruby"><span class="c1"># 将通过脚本引入（将直接把文件本身移动到主 Bundle 下）</span>
<span class="n">s</span><span class="o">.</span><span class="n">resources</span> <span class="o">=</span> <span class="o">[</span><span class="s1">&#39;oc-pod/Assets/info.json&#39;</span><span class="o">]</span>

<span class="c1"># 将创建 oc-pod 的 Bundle（将把 Bundle 移动到主 Bundle 下），等同于 s.resources = [&#39;oc-pod/Assets/oc-pod.bundle&#39;]</span>
<span class="n">s</span><span class="o">.</span><span class="n">resource_bundles</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;oc-pod&#39;</span> <span class="o">=&gt;</span> <span class="o">[</span><span class="s1">&#39;oc-pod/Assets/info-bundle.json&#39;</span><span class="o">]</span>
<span class="p">}</span>
</code></pre></div><p>这里我们将放置在与 oc-demo-project-pod 同一父目录下，并将语言选择 Obj-C，随后在 oc-demo-project-pod 目录下，<code>pod init</code> 并以路径指定方式引用刚才创建的 Pod：</p>
<div class="highlight"><pre class="chroma"><code class="language-ruby" data-lang="ruby"><span class="c1"># Uncomment the next line to define a global platform for your project</span>
<span class="n">platform</span> <span class="ss">:ios</span><span class="p">,</span> <span class="s1">&#39;13.0&#39;</span>

<span class="n">target</span> <span class="s1">&#39;oc-demo-project-pod&#39;</span> <span class="k">do</span>
  <span class="c1"># Uncomment the next line if you&#39;re using Swift or would like to use dynamic frameworks</span>
  <span class="c1"># use_frameworks!</span>

  <span class="c1"># Pods for oc-demo-project-pod</span>
  <span class="n">pod</span> <span class="s1">&#39;oc-pod&#39;</span><span class="p">,</span> <span class="ss">:path</span> <span class="o">=&gt;</span> <span class="s1">&#39;../oc-pod&#39;</span>
<span class="k">end</span>

</code></pre></div><p>我们将上文已有代码放在 oc-pod 的 <code>Classes</code> 文件夹下，并将资源放在 <code>Assets</code> 文件夹下：</p>
<div class="highlight"><pre class="chroma"><code class="language-shell" data-lang="shell">➜  oc-pod git:<span class="o">(</span>master<span class="o">)</span> ✗ tree
.
├── oc-pod
│   ├── Assets  ➡️ 资源
│   │   ├── info-bundle.json
│   │   └── info.json
│   └── Classes ➡️ 源码
│       ├── NSObject+OC_Pod.h
│       ├── NSObject+OC_Pod.m
│       ├── ObjC_Foo.h
│       └── ObjC_Foo.m
└── oc-pod.podspec

<span class="m">3</span> directories, <span class="m">7</span> files

➜  oc-demo-project-pod git:<span class="o">(</span>master<span class="o">)</span> ✗ tree
.
├── Podfile
├── Podfile.lock
├── Pods
│   ├── Headers
│   ├── Local<span class="se">\ </span>Podspecs
│   │   └── oc-pod.podspec.json
│   ├── Manifest.lock
│   ├── Pods.xcodeproj
│   └── Target<span class="se">\ </span>Support<span class="se">\ </span>Files
│       ├── Pods-oc-demo-project-pod
│       │   ├── Pods-oc-demo-project-pod-acknowledgements.markdown
│       │   ├── Pods-oc-demo-project-pod-acknowledgements.plist
│       │   ├── Pods-oc-demo-project-pod-dummy.m
│       │   ├── Pods-oc-demo-project-pod-resources.sh ➡️ resources 处理脚本
│       │   ├── Pods-oc-demo-project-pod.debug.xcconfig
│       │   └── Pods-oc-demo-project-pod.release.xcconfig
│       └── oc-pod
│           ├── ResourceBundle-oc-pod-oc-pod-Info.plist
│           ├── oc-pod-dummy.m
│           ├── oc-pod-prefix.pch
│           └── oc-pod.xcconfig
├── oc-demo-project-pod
├── oc-demo-project-pod.xcodeproj
└── oc-demo-project-pod.xcworkspace

<span class="m">28</span> directories, <span class="m">42</span> files
</code></pre></div><blockquote>
<p><strong>Tips</strong></p>
<p>CocoaPods 现在默认开启了 <code>use_frameworks!</code> 选项，即使用 Framework 方式集成，这里我们将先对其进行注释，看下非 <code>use_frameworks!</code> 的情况。</p>
</blockquote>
<p>此时 Pods 工程将在之后作为单一的静态库以 <code>.a</code> 形式集成到主工程中：</p>
<p><img src="/img/2019/libraries_in_ios/13.png" alt="13"></p>
<p>而我们定义在 Podfile 中的相关依赖如 oc-pod 将作为类似上文中 Cocoa Touch Static Library 一样的 Target 被 Pods 工程自身依赖：</p>
<p><img src="/img/2019/libraries_in_ios/12.png" alt="12"></p>
<p>Resource Bundle 或者 <code>s.dependency</code> 的子依赖将被 oc-pod 依赖：</p>
<p><img src="/img/2019/libraries_in_ios/15.png" alt="15"></p>
<p>如前文所述，<code>.a</code> 仅仅包含了编译后的代码，那么它所以依赖的资源文件将如何处理呢？我们可以看到上上图中的「[CP] Copy Pods Resoureces」执行了如下的脚本：</p>
<div class="highlight"><pre class="chroma"><code class="language-shell" data-lang="shell"><span class="cp">#!/bin/sh
</span><span class="cp"></span><span class="nb">set</span> -e
<span class="nb">set</span> -u
<span class="nb">set</span> -o pipefail <span class="c1"># 一些设置</span>

<span class="c1"># 错误处理</span>
<span class="k">function</span> on_error <span class="o">{</span>
  <span class="nb">echo</span> <span class="s2">&#34;</span><span class="k">$(</span>realpath -mq <span class="s2">&#34;</span><span class="si">${</span><span class="nv">0</span><span class="si">}</span><span class="s2">&#34;</span><span class="k">)</span><span class="s2">:</span><span class="nv">$1</span><span class="s2">: error: Unexpected failure&#34;</span>
<span class="o">}</span>
<span class="nb">trap</span> <span class="s1">&#39;on_error $LINENO&#39;</span> ERR

<span class="c1"># if [ -z STRING ]; 如果字符串 STRING 长度为 0 则为真</span>
<span class="c1"># UNLOCALIZED_RESOURCES_FOLDER_PATH（未本地化资源路径，app 包）：oc-demo-project-pod.app</span>
<span class="k">if</span> <span class="o">[</span> -z <span class="si">${</span><span class="nv">UNLOCALIZED_RESOURCES_FOLDER_PATH</span><span class="p">+x</span><span class="si">}</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
  <span class="c1"># If UNLOCALIZED_RESOURCES_FOLDER_PATH is not set, then there&#39;s nowhere for us to copy</span>
  <span class="c1"># resources to, so exit 0 (signalling the script phase was successful).</span>
  <span class="c1"># 若 UNLOCALIZED_RESOURCES_FOLDER_PATH 未设置，则无需拷贝资源并退出</span>
  <span class="nb">exit</span> <span class="m">0</span>
<span class="k">fi</span>

<span class="c1"># TARGET_BUILD_DIR（目标构建目录）：/Users/kingcos/Library/Developer/Xcode/DerivedData/oc-demo-project-pod-fvrppqpxzudpvicewkjnbszgmrll/Build/Products/Debug-iphonesimulator</span>
<span class="c1"># 递归创建 .app 路径</span>
mkdir -p <span class="s2">&#34;</span><span class="si">${</span><span class="nv">TARGET_BUILD_DIR</span><span class="si">}</span><span class="s2">/</span><span class="si">${</span><span class="nv">UNLOCALIZED_RESOURCES_FOLDER_PATH</span><span class="si">}</span><span class="s2">&#34;</span>

<span class="c1"># RESOURCES_TO_COPY（欲拷贝资源记录临时文件）：oc-demo-project-pod/Pods/resources-to-copy-oc-demo-project-pod.txt</span>
<span class="nv">RESOURCES_TO_COPY</span><span class="o">=</span><span class="si">${</span><span class="nv">PODS_ROOT</span><span class="si">}</span>/resources-to-copy-<span class="si">${</span><span class="nv">TARGETNAME</span><span class="si">}</span>.txt
<span class="c1"># 创建该文件</span>
&gt; <span class="s2">&#34;</span><span class="nv">$RESOURCES_TO_COPY</span><span class="s2">&#34;</span>

<span class="nv">XCASSET_FILES</span><span class="o">=()</span>

<span class="c1"># 防止多个 target 同时拷贝相同的框架依赖</span>
<span class="c1"># This protects against multiple targets copying the same framework dependency at the same time. The solution</span>
<span class="c1"># was originally proposed here: https://lists.samba.org/archive/rsync/2008-February/020158.html</span>
<span class="c1"># RSYNC_PROTECT_TMP_FILES --filter</span>
<span class="nv">RSYNC_PROTECT_TMP_FILES</span><span class="o">=(</span>--filter <span class="s2">&#34;P .*.??????&#34;</span><span class="o">)</span>

<span class="c1"># TARGETED_DEVICE_FAMILY（目标设备家族）：1,2（iPhone &amp; iPad）</span>
<span class="k">case</span> <span class="s2">&#34;</span><span class="si">${</span><span class="nv">TARGETED_DEVICE_FAMILY</span><span class="k">:-</span><span class="si">}</span><span class="s2">&#34;</span> in
  1,2<span class="o">)</span>
    <span class="nv">TARGET_DEVICE_ARGS</span><span class="o">=</span><span class="s2">&#34;--target-device ipad --target-device iphone&#34;</span>
    <span class="p">;;</span>
  1<span class="o">)</span>
    <span class="nv">TARGET_DEVICE_ARGS</span><span class="o">=</span><span class="s2">&#34;--target-device iphone&#34;</span>
    <span class="p">;;</span>
  2<span class="o">)</span>
    <span class="nv">TARGET_DEVICE_ARGS</span><span class="o">=</span><span class="s2">&#34;--target-device ipad&#34;</span>
    <span class="p">;;</span>
  3<span class="o">)</span>
    <span class="nv">TARGET_DEVICE_ARGS</span><span class="o">=</span><span class="s2">&#34;--target-device tv&#34;</span>
    <span class="p">;;</span>
  4<span class="o">)</span>
    <span class="nv">TARGET_DEVICE_ARGS</span><span class="o">=</span><span class="s2">&#34;--target-device watch&#34;</span>
    <span class="p">;;</span>
  *<span class="o">)</span>
    <span class="nv">TARGET_DEVICE_ARGS</span><span class="o">=</span><span class="s2">&#34;--target-device mac&#34;</span>
    <span class="p">;;</span>
<span class="k">esac</span>
<span class="c1"># TARGET_DEVICE_ARGS（目标设备参数）：--target-device ipad --target-device iphone（默认）</span>

<span class="c1"># 安装资源函数</span>
install_resource<span class="o">()</span>
<span class="o">{</span>
  <span class="c1"># 判断是否是根路径（第一个参数开头有无 /），非根路径则添加 Pods 根路径</span>
  <span class="k">if</span> <span class="o">[[</span> <span class="s2">&#34;</span><span class="nv">$1</span><span class="s2">&#34;</span> <span class="o">=</span> /* <span class="o">]]</span> <span class="p">;</span> <span class="k">then</span>
    <span class="nv">RESOURCE_PATH</span><span class="o">=</span><span class="s2">&#34;</span><span class="nv">$1</span><span class="s2">&#34;</span>
  <span class="k">else</span>
    <span class="nv">RESOURCE_PATH</span><span class="o">=</span><span class="s2">&#34;</span><span class="si">${</span><span class="nv">PODS_ROOT</span><span class="si">}</span><span class="s2">/</span><span class="nv">$1</span><span class="s2">&#34;</span>
  <span class="k">fi</span>

  <span class="c1"># RESOURCE_PATH（资源路径）</span>
  <span class="c1"># PATH/TO/libraries_in_ios-demo/oc-demo-project-pod/Pods/../../oc-pod/oc-pod/Assets/info.json</span>
  <span class="c1"># /Users/kingcos/Library/Developer/Xcode/DerivedData/oc-demo-project-pod-aaokquikwvguhaglfagfimosuecy/Build/Products/Debug-iphonesimulator/oc-pod/oc-pod.bundle</span>
  <span class="c1"># PATH/TO/libraries_in_ios-demo/oc-demo-project-pod/Pods/../../swift-pod/swift-pod/Assets/Localizable.strings</span>
  <span class="c1"># 若资源路径不存在则提示并退出</span>
  <span class="k">if</span> <span class="o">[[</span> ! -e <span class="s2">&#34;</span><span class="nv">$RESOURCE_PATH</span><span class="s2">&#34;</span> <span class="o">]]</span> <span class="p">;</span> <span class="k">then</span>
    cat <span class="s">&lt;&lt; EOM
</span><span class="s">error: Resource &#34;$RESOURCE_PATH&#34; not found. Run &#39;pod install&#39; to update the copy resources script.
</span><span class="s">EOM</span>
    <span class="nb">exit</span> <span class="m">1</span>
  <span class="k">fi</span>
  <span class="k">case</span> <span class="nv">$RESOURCE_PATH</span> in
    <span class="c1"># storyboard 资源：编译为 storyboardc</span>
    *.storyboard<span class="o">)</span>
      <span class="nb">echo</span> <span class="s2">&#34;ibtool --reference-external-strings-file --errors --warnings --notices --minimum-deployment-target </span><span class="si">${</span><span class="p">!DEPLOYMENT_TARGET_SETTING_NAME</span><span class="si">}</span><span class="s2"> --output-format human-readable-text --compile </span><span class="si">${</span><span class="nv">TARGET_BUILD_DIR</span><span class="si">}</span><span class="s2">/</span><span class="si">${</span><span class="nv">UNLOCALIZED_RESOURCES_FOLDER_PATH</span><span class="si">}</span><span class="s2">/`basename \&#34;</span><span class="nv">$RESOURCE_PATH</span><span class="s2">\&#34; .storyboard`.storyboardc </span><span class="nv">$RESOURCE_PATH</span><span class="s2"> --sdk </span><span class="si">${</span><span class="nv">SDKROOT</span><span class="si">}</span><span class="s2"> </span><span class="si">${</span><span class="nv">TARGET_DEVICE_ARGS</span><span class="si">}</span><span class="s2">&#34;</span> <span class="o">||</span> <span class="nb">true</span>
      ibtool --reference-external-strings-file --errors --warnings --notices --minimum-deployment-target <span class="si">${</span><span class="p">!DEPLOYMENT_TARGET_SETTING_NAME</span><span class="si">}</span> --output-format human-readable-text --compile <span class="s2">&#34;</span><span class="si">${</span><span class="nv">TARGET_BUILD_DIR</span><span class="si">}</span><span class="s2">/</span><span class="si">${</span><span class="nv">UNLOCALIZED_RESOURCES_FOLDER_PATH</span><span class="si">}</span><span class="s2">/`basename \&#34;</span><span class="nv">$RESOURCE_PATH</span><span class="s2">\&#34; .storyboard`.storyboardc&#34;</span> <span class="s2">&#34;</span><span class="nv">$RESOURCE_PATH</span><span class="s2">&#34;</span> --sdk <span class="s2">&#34;</span><span class="si">${</span><span class="nv">SDKROOT</span><span class="si">}</span><span class="s2">&#34;</span> <span class="si">${</span><span class="nv">TARGET_DEVICE_ARGS</span><span class="si">}</span>
      <span class="p">;;</span>
    <span class="c1"># xib 资源：编译为 nib</span>
    *.xib<span class="o">)</span>
      <span class="nb">echo</span> <span class="s2">&#34;ibtool --reference-external-strings-file --errors --warnings --notices --minimum-deployment-target </span><span class="si">${</span><span class="p">!DEPLOYMENT_TARGET_SETTING_NAME</span><span class="si">}</span><span class="s2"> --output-format human-readable-text --compile </span><span class="si">${</span><span class="nv">TARGET_BUILD_DIR</span><span class="si">}</span><span class="s2">/</span><span class="si">${</span><span class="nv">UNLOCALIZED_RESOURCES_FOLDER_PATH</span><span class="si">}</span><span class="s2">/`basename \&#34;</span><span class="nv">$RESOURCE_PATH</span><span class="s2">\&#34; .xib`.nib </span><span class="nv">$RESOURCE_PATH</span><span class="s2"> --sdk </span><span class="si">${</span><span class="nv">SDKROOT</span><span class="si">}</span><span class="s2"> </span><span class="si">${</span><span class="nv">TARGET_DEVICE_ARGS</span><span class="si">}</span><span class="s2">&#34;</span> <span class="o">||</span> <span class="nb">true</span>
      ibtool --reference-external-strings-file --errors --warnings --notices --minimum-deployment-target <span class="si">${</span><span class="p">!DEPLOYMENT_TARGET_SETTING_NAME</span><span class="si">}</span> --output-format human-readable-text --compile <span class="s2">&#34;</span><span class="si">${</span><span class="nv">TARGET_BUILD_DIR</span><span class="si">}</span><span class="s2">/</span><span class="si">${</span><span class="nv">UNLOCALIZED_RESOURCES_FOLDER_PATH</span><span class="si">}</span><span class="s2">/`basename \&#34;</span><span class="nv">$RESOURCE_PATH</span><span class="s2">\&#34; .xib`.nib&#34;</span> <span class="s2">&#34;</span><span class="nv">$RESOURCE_PATH</span><span class="s2">&#34;</span> --sdk <span class="s2">&#34;</span><span class="si">${</span><span class="nv">SDKROOT</span><span class="si">}</span><span class="s2">&#34;</span> <span class="si">${</span><span class="nv">TARGET_DEVICE_ARGS</span><span class="si">}</span>
      <span class="p">;;</span>
    *.framework<span class="o">)</span>
      <span class="nb">echo</span> <span class="s2">&#34;mkdir -p </span><span class="si">${</span><span class="nv">TARGET_BUILD_DIR</span><span class="si">}</span><span class="s2">/</span><span class="si">${</span><span class="nv">FRAMEWORKS_FOLDER_PATH</span><span class="si">}</span><span class="s2">&#34;</span> <span class="o">||</span> <span class="nb">true</span>
      mkdir -p <span class="s2">&#34;</span><span class="si">${</span><span class="nv">TARGET_BUILD_DIR</span><span class="si">}</span><span class="s2">/</span><span class="si">${</span><span class="nv">FRAMEWORKS_FOLDER_PATH</span><span class="si">}</span><span class="s2">&#34;</span>
      <span class="nb">echo</span> <span class="s2">&#34;rsync --delete -av &#34;</span><span class="si">${</span><span class="nv">RSYNC_PROTECT_TMP_FILES</span><span class="p">[@]</span><span class="si">}</span><span class="s2">&#34; </span><span class="nv">$RESOURCE_PATH</span><span class="s2"> </span><span class="si">${</span><span class="nv">TARGET_BUILD_DIR</span><span class="si">}</span><span class="s2">/</span><span class="si">${</span><span class="nv">FRAMEWORKS_FOLDER_PATH</span><span class="si">}</span><span class="s2">&#34;</span> <span class="o">||</span> <span class="nb">true</span>
      rsync --delete -av <span class="s2">&#34;</span><span class="si">${</span><span class="nv">RSYNC_PROTECT_TMP_FILES</span><span class="p">[@]</span><span class="si">}</span><span class="s2">&#34;</span> <span class="s2">&#34;</span><span class="nv">$RESOURCE_PATH</span><span class="s2">&#34;</span> <span class="s2">&#34;</span><span class="si">${</span><span class="nv">TARGET_BUILD_DIR</span><span class="si">}</span><span class="s2">/</span><span class="si">${</span><span class="nv">FRAMEWORKS_FOLDER_PATH</span><span class="si">}</span><span class="s2">&#34;</span>
      <span class="p">;;</span>
    *.xcdatamodel<span class="o">)</span>
      <span class="nb">echo</span> <span class="s2">&#34;xcrun momc \&#34;</span><span class="nv">$RESOURCE_PATH</span><span class="s2">\&#34; \&#34;</span><span class="si">${</span><span class="nv">TARGET_BUILD_DIR</span><span class="si">}</span><span class="s2">/</span><span class="si">${</span><span class="nv">UNLOCALIZED_RESOURCES_FOLDER_PATH</span><span class="si">}</span><span class="s2">/`basename &#34;</span><span class="nv">$RESOURCE_PATH</span><span class="s2">&#34;`.mom\&#34;&#34;</span> <span class="o">||</span> <span class="nb">true</span>
      xcrun momc <span class="s2">&#34;</span><span class="nv">$RESOURCE_PATH</span><span class="s2">&#34;</span> <span class="s2">&#34;</span><span class="si">${</span><span class="nv">TARGET_BUILD_DIR</span><span class="si">}</span><span class="s2">/</span><span class="si">${</span><span class="nv">UNLOCALIZED_RESOURCES_FOLDER_PATH</span><span class="si">}</span><span class="s2">/`basename &#34;</span><span class="nv">$RESOURCE_PATH</span><span class="s2">&#34; .xcdatamodel`.mom&#34;</span>
      <span class="p">;;</span>
    *.xcdatamodeld<span class="o">)</span>
      <span class="nb">echo</span> <span class="s2">&#34;xcrun momc \&#34;</span><span class="nv">$RESOURCE_PATH</span><span class="s2">\&#34; \&#34;</span><span class="si">${</span><span class="nv">TARGET_BUILD_DIR</span><span class="si">}</span><span class="s2">/</span><span class="si">${</span><span class="nv">UNLOCALIZED_RESOURCES_FOLDER_PATH</span><span class="si">}</span><span class="s2">/`basename &#34;</span><span class="nv">$RESOURCE_PATH</span><span class="s2">&#34; .xcdatamodeld`.momd\&#34;&#34;</span> <span class="o">||</span> <span class="nb">true</span>
      xcrun momc <span class="s2">&#34;</span><span class="nv">$RESOURCE_PATH</span><span class="s2">&#34;</span> <span class="s2">&#34;</span><span class="si">${</span><span class="nv">TARGET_BUILD_DIR</span><span class="si">}</span><span class="s2">/</span><span class="si">${</span><span class="nv">UNLOCALIZED_RESOURCES_FOLDER_PATH</span><span class="si">}</span><span class="s2">/`basename &#34;</span><span class="nv">$RESOURCE_PATH</span><span class="s2">&#34; .xcdatamodeld`.momd&#34;</span>
      <span class="p">;;</span>
    *.xcmappingmodel<span class="o">)</span>
      <span class="nb">echo</span> <span class="s2">&#34;xcrun mapc \&#34;</span><span class="nv">$RESOURCE_PATH</span><span class="s2">\&#34; \&#34;</span><span class="si">${</span><span class="nv">TARGET_BUILD_DIR</span><span class="si">}</span><span class="s2">/</span><span class="si">${</span><span class="nv">UNLOCALIZED_RESOURCES_FOLDER_PATH</span><span class="si">}</span><span class="s2">/`basename &#34;</span><span class="nv">$RESOURCE_PATH</span><span class="s2">&#34; .xcmappingmodel`.cdm\&#34;&#34;</span> <span class="o">||</span> <span class="nb">true</span>
      xcrun mapc <span class="s2">&#34;</span><span class="nv">$RESOURCE_PATH</span><span class="s2">&#34;</span> <span class="s2">&#34;</span><span class="si">${</span><span class="nv">TARGET_BUILD_DIR</span><span class="si">}</span><span class="s2">/</span><span class="si">${</span><span class="nv">UNLOCALIZED_RESOURCES_FOLDER_PATH</span><span class="si">}</span><span class="s2">/`basename &#34;</span><span class="nv">$RESOURCE_PATH</span><span class="s2">&#34; .xcmappingmodel`.cdm&#34;</span>
      <span class="p">;;</span>
    *.xcassets<span class="o">)</span>
      <span class="nv">ABSOLUTE_XCASSET_FILE</span><span class="o">=</span><span class="s2">&#34;</span><span class="nv">$RESOURCE_PATH</span><span class="s2">&#34;</span>
      <span class="nv">XCASSET_FILES</span><span class="o">+=(</span><span class="s2">&#34;</span><span class="nv">$ABSOLUTE_XCASSET_FILE</span><span class="s2">&#34;</span><span class="o">)</span>
      <span class="p">;;</span>
    <span class="c1"># 其它，比如 bundle / json</span>
    *<span class="o">)</span>
      <span class="nb">echo</span> <span class="s2">&#34;</span><span class="nv">$RESOURCE_PATH</span><span class="s2">&#34;</span> <span class="o">||</span> <span class="nb">true</span>
      <span class="c1"># 将资源路径写入欲拷贝资源记录临时文件中</span>
      <span class="nb">echo</span> <span class="s2">&#34;</span><span class="nv">$RESOURCE_PATH</span><span class="s2">&#34;</span> &gt;&gt; <span class="s2">&#34;</span><span class="nv">$RESOURCES_TO_COPY</span><span class="s2">&#34;</span>
      <span class="p">;;</span>
  <span class="k">esac</span>
<span class="o">}</span>

<span class="c1"># CONFIGURATION：运行的 scheme 配置模式，Debug 或 Release</span>
<span class="c1"># 目前 Debug 和 Release 模式处理一致</span>
<span class="k">if</span> <span class="o">[[</span> <span class="s2">&#34;</span><span class="nv">$CONFIGURATION</span><span class="s2">&#34;</span> <span class="o">==</span> <span class="s2">&#34;Debug&#34;</span> <span class="o">]]</span><span class="p">;</span> <span class="k">then</span>
  install_resource <span class="s2">&#34;</span><span class="si">${</span><span class="nv">PODS_ROOT</span><span class="si">}</span><span class="s2">/../../oc-pod/oc-pod/Assets/info.json&#34;</span>
  install_resource <span class="s2">&#34;</span><span class="si">${</span><span class="nv">PODS_CONFIGURATION_BUILD_DIR</span><span class="si">}</span><span class="s2">/oc-pod/oc-pod.bundle&#34;</span>
  install_resource <span class="s2">&#34;</span><span class="si">${</span><span class="nv">PODS_ROOT</span><span class="si">}</span><span class="s2">/../../swift-pod/swift-pod/Assets/Localizable.strings&#34;</span>
<span class="k">fi</span>
<span class="k">if</span> <span class="o">[[</span> <span class="s2">&#34;</span><span class="nv">$CONFIGURATION</span><span class="s2">&#34;</span> <span class="o">==</span> <span class="s2">&#34;Release&#34;</span> <span class="o">]]</span><span class="p">;</span> <span class="k">then</span>
  install_resource <span class="s2">&#34;</span><span class="si">${</span><span class="nv">PODS_ROOT</span><span class="si">}</span><span class="s2">/../../oc-pod/oc-pod/Assets/info.json&#34;</span>
  install_resource <span class="s2">&#34;</span><span class="si">${</span><span class="nv">PODS_CONFIGURATION_BUILD_DIR</span><span class="si">}</span><span class="s2">/oc-pod/oc-pod.bundle&#34;</span>
  install_resource <span class="s2">&#34;</span><span class="si">${</span><span class="nv">PODS_ROOT</span><span class="si">}</span><span class="s2">/../../swift-pod/swift-pod/Assets/Localizable.strings&#34;</span>
<span class="k">fi</span>

<span class="c1"># 再次尝试确保同一文件夹创建</span>
mkdir -p <span class="s2">&#34;</span><span class="si">${</span><span class="nv">TARGET_BUILD_DIR</span><span class="si">}</span><span class="s2">/</span><span class="si">${</span><span class="nv">UNLOCALIZED_RESOURCES_FOLDER_PATH</span><span class="si">}</span><span class="s2">&#34;</span>

<span class="c1"># rsync：快速、多功能、远程（和本地）文件复制工具，-a：保留所有；-v：输出信息；-r：递归；</span>
<span class="c1"># --copy-links：当遇到符号链接时，指向的项目（引用）被复制，而不是符号链接；</span>
<span class="c1"># --no-relative：非相对路径，即绝对路径</span>
<span class="c1"># --exclude：排除某个模式的目录</span>
<span class="c1"># --files-from：文件来源</span>
<span class="c1"># /：文件目的</span>
rsync -avr --copy-links --no-relative --exclude <span class="s1">&#39;*/.svn/*&#39;</span> --files-from<span class="o">=</span><span class="s2">&#34;</span><span class="nv">$RESOURCES_TO_COPY</span><span class="s2">&#34;</span> / <span class="s2">&#34;</span><span class="si">${</span><span class="nv">TARGET_BUILD_DIR</span><span class="si">}</span><span class="s2">/</span><span class="si">${</span><span class="nv">UNLOCALIZED_RESOURCES_FOLDER_PATH</span><span class="si">}</span><span class="s2">&#34;</span>

<span class="c1"># ACTION（行为）：构建即 build，不太清楚何时为 install</span>
<span class="c1"># SKIP_INSTALL（是否跳过安装）：否为 NO</span>
<span class="k">if</span> <span class="o">[[</span> <span class="s2">&#34;</span><span class="si">${</span><span class="nv">ACTION</span><span class="si">}</span><span class="s2">&#34;</span> <span class="o">==</span> <span class="s2">&#34;install&#34;</span> <span class="o">]]</span> <span class="o">&amp;&amp;</span> <span class="o">[[</span> <span class="s2">&#34;</span><span class="si">${</span><span class="nv">SKIP_INSTALL</span><span class="si">}</span><span class="s2">&#34;</span> <span class="o">==</span> <span class="s2">&#34;NO&#34;</span> <span class="o">]]</span><span class="p">;</span> <span class="k">then</span>
  mkdir -p <span class="s2">&#34;</span><span class="si">${</span><span class="nv">INSTALL_DIR</span><span class="si">}</span><span class="s2">/</span><span class="si">${</span><span class="nv">UNLOCALIZED_RESOURCES_FOLDER_PATH</span><span class="si">}</span><span class="s2">&#34;</span>
  rsync -avr --copy-links --no-relative --exclude <span class="s1">&#39;*/.svn/*&#39;</span> --files-from<span class="o">=</span><span class="s2">&#34;</span><span class="nv">$RESOURCES_TO_COPY</span><span class="s2">&#34;</span> / <span class="s2">&#34;</span><span class="si">${</span><span class="nv">INSTALL_DIR</span><span class="si">}</span><span class="s2">/</span><span class="si">${</span><span class="nv">UNLOCALIZED_RESOURCES_FOLDER_PATH</span><span class="si">}</span><span class="s2">&#34;</span>
<span class="k">fi</span>

<span class="c1"># 删除存储资源路径的临时文件</span>
rm -f <span class="s2">&#34;</span><span class="nv">$RESOURCES_TO_COPY</span><span class="s2">&#34;</span>

<span class="c1"># WRAPPER_EXTENSION（扩展）：app</span>
<span class="k">if</span> <span class="o">[[</span> -n <span class="s2">&#34;</span><span class="si">${</span><span class="nv">WRAPPER_EXTENSION</span><span class="si">}</span><span class="s2">&#34;</span> <span class="o">]]</span> <span class="o">&amp;&amp;</span> <span class="o">[</span> <span class="s2">&#34;`xcrun --find actool`&#34;</span> <span class="o">]</span> <span class="o">&amp;&amp;</span> <span class="o">[</span> -n <span class="s2">&#34;</span><span class="si">${</span><span class="nv">XCASSET_FILES</span><span class="k">:-</span><span class="si">}</span><span class="s2">&#34;</span> <span class="o">]</span>
<span class="k">then</span>
  <span class="c1"># Find all other xcassets (this unfortunately includes those of path pods and other targets).</span>
  <span class="c1"># 查找其他所有 xcassets</span>
  <span class="nv">OTHER_XCASSETS</span><span class="o">=</span><span class="k">$(</span>find <span class="s2">&#34;</span><span class="nv">$PWD</span><span class="s2">&#34;</span> -iname <span class="s2">&#34;*.xcassets&#34;</span> -type d<span class="k">)</span>
  <span class="k">while</span> <span class="nb">read</span> line<span class="p">;</span> <span class="k">do</span>
    <span class="k">if</span> <span class="o">[[</span> <span class="nv">$line</span> !<span class="o">=</span> <span class="s2">&#34;</span><span class="si">${</span><span class="nv">PODS_ROOT</span><span class="si">}</span><span class="s2">*&#34;</span> <span class="o">]]</span><span class="p">;</span> <span class="k">then</span>
      <span class="nv">XCASSET_FILES</span><span class="o">+=(</span><span class="s2">&#34;</span><span class="nv">$line</span><span class="s2">&#34;</span><span class="o">)</span>
    <span class="k">fi</span>
  <span class="k">done</span> <span class="o">&lt;&lt;&lt;</span><span class="s2">&#34;</span><span class="nv">$OTHER_XCASSETS</span><span class="s2">&#34;</span>

  <span class="k">if</span> <span class="o">[</span> -z <span class="si">${</span><span class="nv">ASSETCATALOG_COMPILER_APPICON_NAME</span><span class="p">+x</span><span class="si">}</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
    <span class="nb">printf</span> <span class="s2">&#34;%s\0&#34;</span> <span class="s2">&#34;</span><span class="si">${</span><span class="nv">XCASSET_FILES</span><span class="p">[@]</span><span class="si">}</span><span class="s2">&#34;</span> <span class="p">|</span> xargs -0 xcrun actool --output-format human-readable-text --notices --warnings --platform <span class="s2">&#34;</span><span class="si">${</span><span class="nv">PLATFORM_NAME</span><span class="si">}</span><span class="s2">&#34;</span> --minimum-deployment-target <span class="s2">&#34;</span><span class="si">${</span><span class="p">!DEPLOYMENT_TARGET_SETTING_NAME</span><span class="si">}</span><span class="s2">&#34;</span> <span class="si">${</span><span class="nv">TARGET_DEVICE_ARGS</span><span class="si">}</span> --compress-pngs --compile <span class="s2">&#34;</span><span class="si">${</span><span class="nv">BUILT_PRODUCTS_DIR</span><span class="si">}</span><span class="s2">/</span><span class="si">${</span><span class="nv">UNLOCALIZED_RESOURCES_FOLDER_PATH</span><span class="si">}</span><span class="s2">&#34;</span>
  <span class="k">else</span>
    <span class="nb">printf</span> <span class="s2">&#34;%s\0&#34;</span> <span class="s2">&#34;</span><span class="si">${</span><span class="nv">XCASSET_FILES</span><span class="p">[@]</span><span class="si">}</span><span class="s2">&#34;</span> <span class="p">|</span> xargs -0 xcrun actool --output-format human-readable-text --notices --warnings --platform <span class="s2">&#34;</span><span class="si">${</span><span class="nv">PLATFORM_NAME</span><span class="si">}</span><span class="s2">&#34;</span> --minimum-deployment-target <span class="s2">&#34;</span><span class="si">${</span><span class="p">!DEPLOYMENT_TARGET_SETTING_NAME</span><span class="si">}</span><span class="s2">&#34;</span> <span class="si">${</span><span class="nv">TARGET_DEVICE_ARGS</span><span class="si">}</span> --compress-pngs --compile <span class="s2">&#34;</span><span class="si">${</span><span class="nv">BUILT_PRODUCTS_DIR</span><span class="si">}</span><span class="s2">/</span><span class="si">${</span><span class="nv">UNLOCALIZED_RESOURCES_FOLDER_PATH</span><span class="si">}</span><span class="s2">&#34;</span> --app-icon <span class="s2">&#34;</span><span class="si">${</span><span class="nv">ASSETCATALOG_COMPILER_APPICON_NAME</span><span class="si">}</span><span class="s2">&#34;</span> --output-partial-info-plist <span class="s2">&#34;</span><span class="si">${</span><span class="nv">TARGET_TEMP_DIR</span><span class="si">}</span><span class="s2">/assetcatalog_generated_info_cocoapods.plist&#34;</span>
  <span class="k">fi</span>
<span class="k">fi</span>
</code></pre></div><p>因此最终的 <code>oc-demo-project-pod.app</code> 结构如下：</p>
<div class="highlight"><pre class="chroma"><code class="language-shell" data-lang="shell">➜  oc-demo-project-pod.app tree
.
├── Base.lproj
│   ├── LaunchScreen.storyboardc
│   │   ├── 01J-lp-oVM-view-Ze5-6b-2t3.nib
│   │   ├── Info.plist
│   │   └── UIViewController-01J-lp-oVM.nib
│   └── Main.storyboardc
│       ├── BYZ-38-t0r-view-8bC-Xf-vdC.nib
│       ├── Info.plist
│       └── UIViewController-BYZ-38-t0r.nib
├── Info.plist
├── PkgInfo
├── _CodeSignature
│   └── CodeResources
├── info.json  ➡️ 脚本拷贝（s.resources）至此
├── oc-demo-project-pod ➡️ 可执行 Mach-O 文件
└── oc-pod.bundle ➡️ 脚本拷贝（s.resource_bundles）至此
    ├── Info.plist
    ├── _CodeSignature
    │   ├── CodeDirectory
    │   ├── CodeRequirements
    │   ├── CodeRequirements-1
    │   ├── CodeResources
    │   └── CodeSignature
    ├── info-bundle.json
    └── oc-pod.json

<span class="m">6</span> directories, <span class="m">19</span> files
</code></pre></div><p>资源文件 Bundle 以及 JSON 文件被原封不动地挪动到 <code>oc-demo-project-pod.app</code> 下，而第三方和 Pods 中介的 <code>.a</code> 就已经被打入了可执行文件中，我们可以使用 <code>nm</code> 尝试打印其中的符号：</p>
<div class="highlight"><pre class="chroma"><code class="language-shell" data-lang="shell">➜  oc-demo-project-pod.app nm oc-demo-project-pod <span class="p">|</span> grep ObjC_Foo
0000000100038a50 t -<span class="o">[</span>ObjC_Foo foo<span class="o">]</span>
0000000100038b00 t -<span class="o">[</span>ObjC_Foo resources<span class="o">]</span>
<span class="m">0000000100053220</span> S _OBJC_CLASS_<span class="nv">$_ObjC_Foo</span>
00000001000531f8 S _OBJC_METACLASS_<span class="nv">$_ObjC_Foo</span>

➜  oc-demo-project-pod.app nm oc-demo-project-pod <span class="p">|</span> grep Pods
0000000100052b90 S _OBJC_CLASS_<span class="nv">$_PodsDummy_AFNetworking</span>
00000001000532c0 S _OBJC_CLASS_<span class="nv">$_PodsDummy_Pods_oc_demo_project_pod</span>
<span class="m">0000000100053270</span> S _OBJC_CLASS_<span class="nv">$_PodsDummy_oc_pod</span>
0000000100052b68 S _OBJC_METACLASS_<span class="nv">$_PodsDummy_AFNetworking</span>
<span class="m">0000000100053298</span> S _OBJC_METACLASS_<span class="nv">$_PodsDummy_Pods_oc_demo_project_pod</span>
<span class="m">0000000100053248</span> S _OBJC_METACLASS_<span class="nv">$_PodsDummy_oc_pod</span>
</code></pre></div><p>虽然资源均被拷贝到了 <code>.app</code> 下，但在代码中相应的获取方式却有一定差别：</p>
<div class="highlight"><pre class="chroma"><code class="language-objectivec" data-lang="objectivec"><span class="p">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">resources</span> <span class="p">{</span>
    <span class="c1">// s.resources
</span><span class="c1"></span>    <span class="n">NSBundle</span> <span class="o">*</span><span class="n">bundle</span> <span class="o">=</span> <span class="p">[</span><span class="n">NSBundle</span> <span class="nl">bundleForClass</span><span class="p">:[</span><span class="nb">self</span> <span class="k">class</span><span class="p">]];</span>
    <span class="n">NSString</span> <span class="o">*</span><span class="n">path</span> <span class="o">=</span> <span class="p">[</span><span class="n">bundle</span> <span class="nl">pathForResource</span><span class="p">:</span><span class="s">@&#34;info&#34;</span> <span class="nl">ofType</span><span class="p">:</span><span class="s">@&#34;json&#34;</span><span class="p">];</span>
    <span class="n">NSData</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="p">[</span><span class="n">NSData</span> <span class="nl">dataWithContentsOfFile</span><span class="p">:</span><span class="n">path</span><span class="p">];</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">NSDictionary</span> <span class="o">*</span><span class="n">dict</span> <span class="o">=</span> <span class="p">[</span><span class="n">NSJSONSerialization</span> <span class="nl">JSONObjectWithData</span><span class="p">:</span><span class="n">data</span> <span class="nl">options</span><span class="p">:</span><span class="n">NSJSONReadingMutableContainers</span> <span class="nl">error</span><span class="p">:</span><span class="nb">nil</span><span class="p">];</span>
        <span class="n">NSLog</span><span class="p">(</span><span class="s">@&#34;%@ - %@&#34;</span><span class="p">,</span> <span class="n">dict</span><span class="p">[</span><span class="s">@&#34;blog&#34;</span><span class="p">],</span> <span class="n">dict</span><span class="p">[</span><span class="s">@&#34;github&#34;</span><span class="p">]);</span>
    <span class="p">}</span>

    <span class="c1">// s.resource_bundles
</span><span class="c1"></span>    <span class="n">NSBundle</span> <span class="o">*</span><span class="n">bundle2</span> <span class="o">=</span> <span class="p">[</span><span class="n">NSBundle</span> <span class="nl">bundleWithPath</span><span class="p">:[[</span><span class="n">NSBundle</span> <span class="n">mainBundle</span><span class="p">]</span> <span class="nl">pathForResource</span><span class="p">:</span><span class="s">@&#34;oc-pod&#34;</span> <span class="nl">ofType</span><span class="p">:</span><span class="s">@&#34;bundle&#34;</span><span class="p">]];</span>
    <span class="n">NSString</span> <span class="o">*</span><span class="n">path2</span> <span class="o">=</span> <span class="p">[</span><span class="n">bundle2</span> <span class="nl">pathForResource</span><span class="p">:</span><span class="s">@&#34;oc-pod&#34;</span> <span class="nl">ofType</span><span class="p">:</span><span class="s">@&#34;json&#34;</span><span class="p">];</span>
    <span class="n">NSData</span> <span class="o">*</span><span class="n">data2</span> <span class="o">=</span> <span class="p">[</span><span class="n">NSData</span> <span class="nl">dataWithContentsOfFile</span><span class="p">:</span><span class="n">path2</span><span class="p">];</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">data2</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">NSDictionary</span> <span class="o">*</span><span class="n">dict</span> <span class="o">=</span> <span class="p">[</span><span class="n">NSJSONSerialization</span> <span class="nl">JSONObjectWithData</span><span class="p">:</span><span class="n">data</span> <span class="nl">options</span><span class="p">:</span><span class="n">NSJSONReadingMutableContainers</span> <span class="nl">error</span><span class="p">:</span><span class="nb">nil</span><span class="p">];</span>
        <span class="n">NSLog</span><span class="p">(</span><span class="s">@&#34;%@ - %@&#34;</span><span class="p">,</span> <span class="n">dict</span><span class="p">[</span><span class="s">@&#34;blog&#34;</span><span class="p">],</span> <span class="n">dict</span><span class="p">[</span><span class="s">@&#34;github&#34;</span><span class="p">]);</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div><h4 id="obj-c-工程与-swift-pod">Obj-C 工程与 Swift Pod</h4>
<p>在 Obj-C 工程下引入 Swift Pod 与 Obj-C Pod 并无太多差别。不过有时可能会遇到 CocoaPods 提示下面这个问题，或者在编译时提示找不到许多 Swift 相关的符号：</p>
<div class="highlight"><pre class="chroma"><code class="language-shell" data-lang="shell"><span class="o">[</span>!<span class="o">]</span> Unable to determine Swift version <span class="k">for</span> the following pods:

- <span class="sb">`</span>swift-pod<span class="sb">`</span> does not specify a Swift version and none of the targets <span class="o">(</span><span class="sb">`</span>oc-demo-project-pod<span class="sb">`</span><span class="o">)</span> integrating it have the <span class="sb">`</span>SWIFT_VERSION<span class="sb">`</span> attribute set. Please contact the author or <span class="nb">set</span> the <span class="sb">`</span>SWIFT_VERSION<span class="sb">`</span> attribute in at least one of the targets that integrate this pod.
</code></pre></div><p>此时我们可以在 Obj-C 工程中新建一个占位 Swift 文件即可使其获得 Swift 能力：</p>
<p><img src="/img/2019/libraries_in_ios/14.png" alt="14"></p>
<p>另外需要注意的是，Swift Pod 引入时需要使用 <code>@import</code>：</p>
<div class="highlight"><pre class="chroma"><code class="language-objectivec" data-lang="objectivec"><span class="p">@</span><span class="n">import</span> <span class="n">swift_pod</span><span class="p">;</span>

<span class="k">@implementation</span> <span class="nc">ViewController</span>
<span class="p">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">viewDidLoad</span> <span class="p">{</span>
    <span class="p">[</span><span class="nb">super</span> <span class="n">viewDidLoad</span><span class="p">];</span>

    <span class="p">[[[</span><span class="n">Swift_Foo</span> <span class="n">alloc</span><span class="p">]</span> <span class="n">init</span><span class="p">]</span> <span class="n">foo</span><span class="p">];</span>
    <span class="n">NSLog</span><span class="p">(</span><span class="s">@&#34;%@&#34;</span><span class="p">,</span> <span class="p">[[[</span><span class="n">Swift_Foo</span> <span class="n">alloc</span><span class="p">]</span> <span class="n">init</span><span class="p">]</span> <span class="n">strings</span><span class="p">]);</span>
<span class="p">}</span>
<span class="k">@end</span>
</code></pre></div><h4 id="swift-工程与-obj-c-pod">Swift 工程与 Obj-C Pod</h4>
<p>Swift 工程依赖 Obj-C Pod 的方式与 Obj-C 工程一致。但需要注意的是，我们无法直接在 Swift 代码中 <code>import</code> Obj-C Pod。这里也需要桥接文件来引入，我们可以创建 Obj-C 类型的占位文件，并创建桥接文件，在其中引入暴露给 Swift 工程的头文件：</p>
<div class="highlight"><pre class="chroma"><code class="language-objectivec" data-lang="objectivec"><span class="c1">//
</span><span class="c1">//  Use this file to import your target&#39;s public headers that you would like to expose to Swift.
</span><span class="c1">//
</span><span class="c1"></span>
<span class="cp">#import &lt;oc-pod/ObjC_Foo.h&gt;
</span></code></pre></div><p>这样即可在 Swift 工程中使用：</p>
<div class="highlight"><pre class="chroma"><code class="language-swift" data-lang="swift"><span class="kd">import</span> <span class="nc">UIKit</span>

<span class="kd">class</span> <span class="nc">ViewController</span><span class="p">:</span> <span class="n">UIViewController</span> <span class="p">{</span>
    <span class="kr">override</span> <span class="kd">func</span> <span class="nf">viewDidLoad</span><span class="p">()</span> <span class="p">{</span>
        <span class="kc">super</span><span class="p">.</span><span class="n">viewDidLoad</span><span class="p">()</span>

        <span class="n">ObjC_Foo</span><span class="p">().</span><span class="n">foo</span><span class="p">()</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div><p>对于同样未开启 <code>use_frameworks</code> 的 Swift 工程来说，CocoaPods 处理资源的脚本和逻辑是一致的。</p>
<h4 id="swift-工程与-swift-pod">Swift 工程与 Swift Pod</h4>
<p>Swift 工程依赖 Swift Pod 的方式则更加简单，只需要使用 <code>import</code> 引入 Pod 即可：</p>
<div class="highlight"><pre class="chroma"><code class="language-swift" data-lang="swift"><span class="kd">import</span> <span class="nc">swift_pod</span>

<span class="kd">class</span> <span class="nc">ViewController</span><span class="p">:</span> <span class="n">UIViewController</span> <span class="p">{</span>
    <span class="kr">override</span> <span class="kd">func</span> <span class="nf">viewDidLoad</span><span class="p">()</span> <span class="p">{</span>
        <span class="kc">super</span><span class="p">.</span><span class="n">viewDidLoad</span><span class="p">()</span>

        <span class="n">Swift_Foo</span><span class="p">().</span><span class="n">foo</span><span class="p">()</span>
        <span class="bp">print</span><span class="p">(</span><span class="n">Swift_Foo</span><span class="p">().</span><span class="n">strings</span><span class="p">())</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div><h3 id="use_frameworks">use_frameworks!</h3>
<h4 id="obj-c-工程-1">Obj-C 工程</h4>
<p>将 <code>use_frameworks!</code> 开启时，Pods 工程将以框架方式依赖：</p>
<p><img src="/img/2019/libraries_in_ios/16.png" alt="16"></p>
<p>在上面我们了解过 Framework，其中聚合了可执行文件以及资源等文件，因此其一般不再需要单独的脚本来处理资源，而是需要「[CP] Embed Pods Frameworks」来针对 Framework 进行操作：</p>
<div class="highlight"><pre class="chroma"><code class="language-shell" data-lang="shell"><span class="cp">#!/bin/sh
</span><span class="cp"></span><span class="nb">set</span> -e
<span class="nb">set</span> -u
<span class="nb">set</span> -o pipefail <span class="c1"># 一些设置</span>

<span class="c1"># 错误处理</span>
<span class="k">function</span> on_error <span class="o">{</span>
  <span class="nb">echo</span> <span class="s2">&#34;</span><span class="k">$(</span>realpath -mq <span class="s2">&#34;</span><span class="si">${</span><span class="nv">0</span><span class="si">}</span><span class="s2">&#34;</span><span class="k">)</span><span class="s2">:</span><span class="nv">$1</span><span class="s2">: error: Unexpected failure&#34;</span>
<span class="o">}</span>
<span class="nb">trap</span> <span class="s1">&#39;on_error $LINENO&#39;</span> ERR

<span class="c1"># FRAMEWORKS_FOLDER_PATH（框架文件夹路径）：oc-demo-project-pod.app/Frameworks</span>
<span class="k">if</span> <span class="o">[</span> -z <span class="si">${</span><span class="nv">FRAMEWORKS_FOLDER_PATH</span><span class="p">+x</span><span class="si">}</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
  <span class="c1"># If FRAMEWORKS_FOLDER_PATH is not set, then there&#39;s nowhere for us to copy</span>
  <span class="c1"># frameworks to, so exit 0 (signalling the script phase was successful).</span>
  <span class="c1"># FRAMEWORKS_FOLDER_PATH 未设置，则无需拷贝资源并退出</span>
  <span class="nb">exit</span> <span class="m">0</span>
<span class="k">fi</span>

<span class="c1"># CONFIGURATION_BUILD_DIR（配置构建目录）：/Users/kingcos/Library/Developer/Xcode/DerivedData/oc-demo-project-pod-gmhizsqflcuavpebfzsfyychzzuj/Build/Products/Debug-iphonesimulator</span>
<span class="c1"># 递归创建框架路径</span>
<span class="nb">echo</span> <span class="s2">&#34;mkdir -p </span><span class="si">${</span><span class="nv">CONFIGURATION_BUILD_DIR</span><span class="si">}</span><span class="s2">/</span><span class="si">${</span><span class="nv">FRAMEWORKS_FOLDER_PATH</span><span class="si">}</span><span class="s2">&#34;</span>
mkdir -p <span class="s2">&#34;</span><span class="si">${</span><span class="nv">CONFIGURATION_BUILD_DIR</span><span class="si">}</span><span class="s2">/</span><span class="si">${</span><span class="nv">FRAMEWORKS_FOLDER_PATH</span><span class="si">}</span><span class="s2">&#34;</span>

<span class="c1"># COCOAPODS_PARALLEL_CODE_SIGN（CocoaPods 并行签名）：false（默认）</span>
<span class="nv">COCOAPODS_PARALLEL_CODE_SIGN</span><span class="o">=</span><span class="s2">&#34;</span><span class="si">${</span><span class="nv">COCOAPODS_PARALLEL_CODE_SIGN</span><span class="k">:-</span><span class="nv">false</span><span class="si">}</span><span class="s2">&#34;</span>

<span class="c1"># DT_TOOLCHAIN_DIR（工具链目录）：/Applications/Xcode.app/Contents/Developer/Toolchains/XcodeDefault.xctoolchain</span>
<span class="c1"># PLATFORM_NAME（目标平台名）：iphonesimulator</span>
<span class="c1"># SWIFT_STDLIB_PATH（Swift 标准库路径）：/Applications/Xcode.app/Contents/Developer/Toolchains/XcodeDefault.xctoolchain/usr/lib/swift/iphonesimulator</span>
<span class="nv">SWIFT_STDLIB_PATH</span><span class="o">=</span><span class="s2">&#34;</span><span class="si">${</span><span class="nv">DT_TOOLCHAIN_DIR</span><span class="si">}</span><span class="s2">/usr/lib/swift/</span><span class="si">${</span><span class="nv">PLATFORM_NAME</span><span class="si">}</span><span class="s2">&#34;</span>

<span class="c1"># Used as a return value for each invocation of `strip_invalid_archs` function.</span>
<span class="c1"># 作为每次调用 strip_invalid_archs 函数的返回值</span>
<span class="nv">STRIP_BINARY_RETVAL</span><span class="o">=</span><span class="m">0</span>

<span class="c1"># 防止多个 target 同时拷贝相同的框架依赖</span>
<span class="c1"># This protects against multiple targets copying the same framework dependency at the same time. The solution</span>
<span class="c1"># was originally proposed here: https://lists.samba.org/archive/rsync/2008-February/020158.html</span>
<span class="nv">RSYNC_PROTECT_TMP_FILES</span><span class="o">=(</span>--filter <span class="s2">&#34;P .*.??????&#34;</span><span class="o">)</span>

<span class="c1"># Copies and strips a vendored framework</span>
<span class="c1"># 拷贝并删除 vendored 框架</span>
install_framework<span class="o">()</span>
<span class="o">{</span>
  <span class="c1"># BUILT_PRODUCTS_DIR（构建产物目录）：/Users/kingcos/Library/Developer/Xcode/DerivedData/oc-demo-project-pod-gmhizsqflcuavpebfzsfyychzzuj/Build/Products/Debug-iphonesimulator</span>
  <span class="c1"># if [ -r FILE ]; 如果文件 FILE 可读（r：read）则为真</span>
  <span class="k">if</span> <span class="o">[</span> -r <span class="s2">&#34;</span><span class="si">${</span><span class="nv">BUILT_PRODUCTS_DIR</span><span class="si">}</span><span class="s2">/</span><span class="nv">$1</span><span class="s2">&#34;</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
    <span class="nb">local</span> <span class="nv">source</span><span class="o">=</span><span class="s2">&#34;</span><span class="si">${</span><span class="nv">BUILT_PRODUCTS_DIR</span><span class="si">}</span><span class="s2">/</span><span class="nv">$1</span><span class="s2">&#34;</span>
  <span class="k">elif</span> <span class="o">[</span> -r <span class="s2">&#34;</span><span class="si">${</span><span class="nv">BUILT_PRODUCTS_DIR</span><span class="si">}</span><span class="s2">/</span><span class="k">$(</span>basename <span class="s2">&#34;</span><span class="nv">$1</span><span class="s2">&#34;</span><span class="k">)</span><span class="s2">&#34;</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
    <span class="nb">local</span> <span class="nv">source</span><span class="o">=</span><span class="s2">&#34;</span><span class="si">${</span><span class="nv">BUILT_PRODUCTS_DIR</span><span class="si">}</span><span class="s2">/</span><span class="k">$(</span>basename <span class="s2">&#34;</span><span class="nv">$1</span><span class="s2">&#34;</span><span class="k">)</span><span class="s2">&#34;</span>
  <span class="k">elif</span> <span class="o">[</span> -r <span class="s2">&#34;</span><span class="nv">$1</span><span class="s2">&#34;</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
    <span class="nb">local</span> <span class="nv">source</span><span class="o">=</span><span class="s2">&#34;</span><span class="nv">$1</span><span class="s2">&#34;</span>
  <span class="k">fi</span>

  <span class="nb">local</span> <span class="nv">destination</span><span class="o">=</span><span class="s2">&#34;</span><span class="si">${</span><span class="nv">TARGET_BUILD_DIR</span><span class="si">}</span><span class="s2">/</span><span class="si">${</span><span class="nv">FRAMEWORKS_FOLDER_PATH</span><span class="si">}</span><span class="s2">&#34;</span>

  <span class="c1"># if [ -L FILE ]; 如果文件 FILE 是链接（L：Link）文件则为真</span>
  <span class="k">if</span> <span class="o">[</span> -L <span class="s2">&#34;</span><span class="si">${</span><span class="nv">source</span><span class="si">}</span><span class="s2">&#34;</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
    <span class="nb">echo</span> <span class="s2">&#34;Symlinked...&#34;</span>
    <span class="c1"># 读取链接的真实文件</span>
    <span class="nv">source</span><span class="o">=</span><span class="s2">&#34;</span><span class="k">$(</span>readlink <span class="s2">&#34;</span><span class="si">${</span><span class="nv">source</span><span class="si">}</span><span class="s2">&#34;</span><span class="k">)</span><span class="s2">&#34;</span>
  <span class="k">fi</span>

  <span class="c1"># Use filter instead of exclude so missing patterns don&#39;t throw errors.</span>
  <span class="nb">echo</span> <span class="s2">&#34;rsync --delete -av &#34;</span><span class="si">${</span><span class="nv">RSYNC_PROTECT_TMP_FILES</span><span class="p">[@]</span><span class="si">}</span><span class="s2">&#34; --filter \&#34;- CVS/\&#34; --filter \&#34;- .svn/\&#34; --filter \&#34;- .git/\&#34; --filter \&#34;- .hg/\&#34; --filter \&#34;- Headers\&#34; --filter \&#34;- PrivateHeaders\&#34; --filter \&#34;- Modules\&#34; \&#34;</span><span class="si">${</span><span class="nv">source</span><span class="si">}</span><span class="s2">\&#34; \&#34;</span><span class="si">${</span><span class="nv">destination</span><span class="si">}</span><span class="s2">\&#34;&#34;</span>
  rsync --delete -av <span class="s2">&#34;</span><span class="si">${</span><span class="nv">RSYNC_PROTECT_TMP_FILES</span><span class="p">[@]</span><span class="si">}</span><span class="s2">&#34;</span> --filter <span class="s2">&#34;- CVS/&#34;</span> --filter <span class="s2">&#34;- .svn/&#34;</span> --filter <span class="s2">&#34;- .git/&#34;</span> --filter <span class="s2">&#34;- .hg/&#34;</span> --filter <span class="s2">&#34;- Headers&#34;</span> --filter <span class="s2">&#34;- PrivateHeaders&#34;</span> --filter <span class="s2">&#34;- Modules&#34;</span> <span class="s2">&#34;</span><span class="si">${</span><span class="nv">source</span><span class="si">}</span><span class="s2">&#34;</span> <span class="s2">&#34;</span><span class="si">${</span><span class="nv">destination</span><span class="si">}</span><span class="s2">&#34;</span>

  <span class="nb">local</span> basename
  <span class="c1"># basename（基本名）：AFNetworking / oc_pod / swift_pod</span>
  <span class="c1"># binary（二进制路径）</span>
  <span class="nv">basename</span><span class="o">=</span><span class="s2">&#34;</span><span class="k">$(</span>basename -s .framework <span class="s2">&#34;</span><span class="nv">$1</span><span class="s2">&#34;</span><span class="k">)</span><span class="s2">&#34;</span>
  <span class="nv">binary</span><span class="o">=</span><span class="s2">&#34;</span><span class="si">${</span><span class="nv">destination</span><span class="si">}</span><span class="s2">/</span><span class="si">${</span><span class="nv">basename</span><span class="si">}</span><span class="s2">.framework/</span><span class="si">${</span><span class="nv">basename</span><span class="si">}</span><span class="s2">&#34;</span>

  <span class="k">if</span> ! <span class="o">[</span> -r <span class="s2">&#34;</span><span class="nv">$binary</span><span class="s2">&#34;</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
    <span class="nv">binary</span><span class="o">=</span><span class="s2">&#34;</span><span class="si">${</span><span class="nv">destination</span><span class="si">}</span><span class="s2">/</span><span class="si">${</span><span class="nv">basename</span><span class="si">}</span><span class="s2">&#34;</span>
  <span class="k">elif</span> <span class="o">[</span> -L <span class="s2">&#34;</span><span class="si">${</span><span class="nv">binary</span><span class="si">}</span><span class="s2">&#34;</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
    <span class="nb">echo</span> <span class="s2">&#34;Destination binary is symlinked...&#34;</span>
    <span class="nv">dirname</span><span class="o">=</span><span class="s2">&#34;</span><span class="k">$(</span>dirname <span class="s2">&#34;</span><span class="si">${</span><span class="nv">binary</span><span class="si">}</span><span class="s2">&#34;</span><span class="k">)</span><span class="s2">&#34;</span>
    <span class="nv">binary</span><span class="o">=</span><span class="s2">&#34;</span><span class="si">${</span><span class="nv">dirname</span><span class="si">}</span><span class="s2">/</span><span class="k">$(</span>readlink <span class="s2">&#34;</span><span class="si">${</span><span class="nv">binary</span><span class="si">}</span><span class="s2">&#34;</span><span class="k">)</span><span class="s2">&#34;</span>
  <span class="k">fi</span>

  <span class="c1"># /Users/kingcos/Library/Developer/Xcode/DerivedData/oc-demo-project-pod-gmhizsqflcuavpebfzsfyychzzuj/Build/Products/Debug-iphonesimulator/oc-demo-project-pod.app/Frameworks/AFNetworking.framework/AFNetworking: Mach-O 64-bit dynamically linked shared library x86_64</span>
  <span class="c1"># Strip invalid architectures so &#34;fat&#34; simulator / device frameworks work on device</span>
  <span class="k">if</span> <span class="o">[[</span> <span class="s2">&#34;</span><span class="k">$(</span>file <span class="s2">&#34;</span><span class="nv">$binary</span><span class="s2">&#34;</span><span class="k">)</span><span class="s2">&#34;</span> <span class="o">==</span> *<span class="s2">&#34;dynamically linked shared library&#34;</span>* <span class="o">]]</span><span class="p">;</span> <span class="k">then</span>
    <span class="c1"># 若为动态链接共享库，则删除无效架构</span>
    strip_invalid_archs <span class="s2">&#34;</span><span class="nv">$binary</span><span class="s2">&#34;</span>
  <span class="k">fi</span>

  <span class="c1"># Resign the code if required by the build settings to avoid unstable apps</span>
  <span class="c1"># 重签名 Build Settings 里设置为必须的代码，以避免造成 app 不稳定</span>
  code_sign_if_enabled <span class="s2">&#34;</span><span class="si">${</span><span class="nv">destination</span><span class="si">}</span><span class="s2">/</span><span class="k">$(</span>basename <span class="s2">&#34;</span><span class="nv">$1</span><span class="s2">&#34;</span><span class="k">)</span><span class="s2">&#34;</span>

  <span class="c1"># Embed linked Swift runtime libraries. No longer necessary as of Xcode 7.</span>
  <span class="c1"># 嵌入 Swift 运行时库，Xcode 7 之后不再需要。</span>
  <span class="k">if</span> <span class="o">[</span> <span class="s2">&#34;</span><span class="si">${</span><span class="nv">XCODE_VERSION_MAJOR</span><span class="si">}</span><span class="s2">&#34;</span> -lt <span class="m">7</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
    <span class="nb">local</span> swift_runtime_libs
    <span class="nv">swift_runtime_libs</span><span class="o">=</span><span class="k">$(</span>xcrun otool -LX <span class="s2">&#34;</span><span class="nv">$binary</span><span class="s2">&#34;</span> <span class="p">|</span> grep --color<span class="o">=</span>never @rpath/libswift <span class="p">|</span> sed -E s/@rpath<span class="se">\\</span>/<span class="se">\(</span>.+dylib<span class="se">\)</span>.*/<span class="se">\\</span>1/g <span class="p">|</span> uniq -u<span class="k">)</span>
    <span class="k">for</span> lib in <span class="nv">$swift_runtime_libs</span><span class="p">;</span> <span class="k">do</span>
      <span class="nb">echo</span> <span class="s2">&#34;rsync -auv \&#34;</span><span class="si">${</span><span class="nv">SWIFT_STDLIB_PATH</span><span class="si">}</span><span class="s2">/</span><span class="si">${</span><span class="nv">lib</span><span class="si">}</span><span class="s2">\&#34; \&#34;</span><span class="si">${</span><span class="nv">destination</span><span class="si">}</span><span class="s2">\&#34;&#34;</span>
      rsync -auv <span class="s2">&#34;</span><span class="si">${</span><span class="nv">SWIFT_STDLIB_PATH</span><span class="si">}</span><span class="s2">/</span><span class="si">${</span><span class="nv">lib</span><span class="si">}</span><span class="s2">&#34;</span> <span class="s2">&#34;</span><span class="si">${</span><span class="nv">destination</span><span class="si">}</span><span class="s2">&#34;</span>
      code_sign_if_enabled <span class="s2">&#34;</span><span class="si">${</span><span class="nv">destination</span><span class="si">}</span><span class="s2">/</span><span class="si">${</span><span class="nv">lib</span><span class="si">}</span><span class="s2">&#34;</span>
    <span class="k">done</span>
  <span class="k">fi</span>
<span class="o">}</span>

<span class="c1"># Copies and strips a vendored dSYM</span>
<span class="c1"># 拷贝并删除 vendored dSYM</span>
install_dsym<span class="o">()</span> <span class="o">{</span>
  <span class="nb">local</span> <span class="nv">source</span><span class="o">=</span><span class="s2">&#34;</span><span class="nv">$1</span><span class="s2">&#34;</span>
  <span class="k">if</span> <span class="o">[</span> -r <span class="s2">&#34;</span><span class="nv">$source</span><span class="s2">&#34;</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
    <span class="c1"># Copy the dSYM into a the targets temp dir.</span>
    <span class="nb">echo</span> <span class="s2">&#34;rsync --delete -av &#34;</span><span class="si">${</span><span class="nv">RSYNC_PROTECT_TMP_FILES</span><span class="p">[@]</span><span class="si">}</span><span class="s2">&#34; --filter \&#34;- CVS/\&#34; --filter \&#34;- .svn/\&#34; --filter \&#34;- .git/\&#34; --filter \&#34;- .hg/\&#34; --filter \&#34;- Headers\&#34; --filter \&#34;- PrivateHeaders\&#34; --filter \&#34;- Modules\&#34; \&#34;</span><span class="si">${</span><span class="nv">source</span><span class="si">}</span><span class="s2">\&#34; \&#34;</span><span class="si">${</span><span class="nv">DERIVED_FILES_DIR</span><span class="si">}</span><span class="s2">\&#34;&#34;</span>
    rsync --delete -av <span class="s2">&#34;</span><span class="si">${</span><span class="nv">RSYNC_PROTECT_TMP_FILES</span><span class="p">[@]</span><span class="si">}</span><span class="s2">&#34;</span> --filter <span class="s2">&#34;- CVS/&#34;</span> --filter <span class="s2">&#34;- .svn/&#34;</span> --filter <span class="s2">&#34;- .git/&#34;</span> --filter <span class="s2">&#34;- .hg/&#34;</span> --filter <span class="s2">&#34;- Headers&#34;</span> --filter <span class="s2">&#34;- PrivateHeaders&#34;</span> --filter <span class="s2">&#34;- Modules&#34;</span> <span class="s2">&#34;</span><span class="si">${</span><span class="nv">source</span><span class="si">}</span><span class="s2">&#34;</span> <span class="s2">&#34;</span><span class="si">${</span><span class="nv">DERIVED_FILES_DIR</span><span class="si">}</span><span class="s2">&#34;</span>

    <span class="nb">local</span> basename
    <span class="nv">basename</span><span class="o">=</span><span class="s2">&#34;</span><span class="k">$(</span>basename -s .framework.dSYM <span class="s2">&#34;</span><span class="nv">$source</span><span class="s2">&#34;</span><span class="k">)</span><span class="s2">&#34;</span>
    <span class="nv">binary</span><span class="o">=</span><span class="s2">&#34;</span><span class="si">${</span><span class="nv">DERIVED_FILES_DIR</span><span class="si">}</span><span class="s2">/</span><span class="si">${</span><span class="nv">basename</span><span class="si">}</span><span class="s2">.framework.dSYM/Contents/Resources/DWARF/</span><span class="si">${</span><span class="nv">basename</span><span class="si">}</span><span class="s2">&#34;</span>

    <span class="c1"># Strip invalid architectures so &#34;fat&#34; simulator / device frameworks work on device</span>
    <span class="k">if</span> <span class="o">[[</span> <span class="s2">&#34;</span><span class="k">$(</span>file <span class="s2">&#34;</span><span class="nv">$binary</span><span class="s2">&#34;</span><span class="k">)</span><span class="s2">&#34;</span> <span class="o">==</span> *<span class="s2">&#34;Mach-O &#34;</span>*<span class="s2">&#34;dSYM companion&#34;</span>* <span class="o">]]</span><span class="p">;</span> <span class="k">then</span>
      strip_invalid_archs <span class="s2">&#34;</span><span class="nv">$binary</span><span class="s2">&#34;</span>
    <span class="k">fi</span>

    <span class="k">if</span> <span class="o">[[</span> <span class="nv">$STRIP_BINARY_RETVAL</span> <span class="o">==</span> <span class="m">1</span> <span class="o">]]</span><span class="p">;</span> <span class="k">then</span>
      <span class="c1"># Move the stripped file into its final destination.</span>
      <span class="nb">echo</span> <span class="s2">&#34;rsync --delete -av &#34;</span><span class="si">${</span><span class="nv">RSYNC_PROTECT_TMP_FILES</span><span class="p">[@]</span><span class="si">}</span><span class="s2">&#34; --filter \&#34;- CVS/\&#34; --filter \&#34;- .svn/\&#34; --filter \&#34;- .git/\&#34; --filter \&#34;- .hg/\&#34; --filter \&#34;- Headers\&#34; --filter \&#34;- PrivateHeaders\&#34; --filter \&#34;- Modules\&#34; \&#34;</span><span class="si">${</span><span class="nv">DERIVED_FILES_DIR</span><span class="si">}</span><span class="s2">/</span><span class="si">${</span><span class="nv">basename</span><span class="si">}</span><span class="s2">.framework.dSYM\&#34; \&#34;</span><span class="si">${</span><span class="nv">DWARF_DSYM_FOLDER_PATH</span><span class="si">}</span><span class="s2">\&#34;&#34;</span>
      rsync --delete -av <span class="s2">&#34;</span><span class="si">${</span><span class="nv">RSYNC_PROTECT_TMP_FILES</span><span class="p">[@]</span><span class="si">}</span><span class="s2">&#34;</span> --filter <span class="s2">&#34;- CVS/&#34;</span> --filter <span class="s2">&#34;- .svn/&#34;</span> --filter <span class="s2">&#34;- .git/&#34;</span> --filter <span class="s2">&#34;- .hg/&#34;</span> --filter <span class="s2">&#34;- Headers&#34;</span> --filter <span class="s2">&#34;- PrivateHeaders&#34;</span> --filter <span class="s2">&#34;- Modules&#34;</span> <span class="s2">&#34;</span><span class="si">${</span><span class="nv">DERIVED_FILES_DIR</span><span class="si">}</span><span class="s2">/</span><span class="si">${</span><span class="nv">basename</span><span class="si">}</span><span class="s2">.framework.dSYM&#34;</span> <span class="s2">&#34;</span><span class="si">${</span><span class="nv">DWARF_DSYM_FOLDER_PATH</span><span class="si">}</span><span class="s2">&#34;</span>
    <span class="k">else</span>
      <span class="c1"># The dSYM was not stripped at all, in this case touch a fake folder so the input/output paths from Xcode do not reexecute this script because the file is missing.</span>
      touch <span class="s2">&#34;</span><span class="si">${</span><span class="nv">DWARF_DSYM_FOLDER_PATH</span><span class="si">}</span><span class="s2">/</span><span class="si">${</span><span class="nv">basename</span><span class="si">}</span><span class="s2">.framework.dSYM&#34;</span>
    <span class="k">fi</span>
  <span class="k">fi</span>
<span class="o">}</span>

<span class="c1"># Copies the bcsymbolmap files of a vendored framework</span>
<span class="c1"># 复制 vendored 框架的 bcsymbolmap 文件</span>
install_bcsymbolmap<span class="o">()</span> <span class="o">{</span>
    <span class="nb">local</span> <span class="nv">bcsymbolmap_path</span><span class="o">=</span><span class="s2">&#34;</span><span class="nv">$1</span><span class="s2">&#34;</span>
    <span class="nb">local</span> <span class="nv">destination</span><span class="o">=</span><span class="s2">&#34;</span><span class="si">${</span><span class="nv">BUILT_PRODUCTS_DIR</span><span class="si">}</span><span class="s2">&#34;</span>
    <span class="nb">echo</span> <span class="s2">&#34;rsync --delete -av &#34;</span><span class="si">${</span><span class="nv">RSYNC_PROTECT_TMP_FILES</span><span class="p">[@]</span><span class="si">}</span><span class="s2">&#34; --filter &#34;</span>- CVS/<span class="s2">&#34; --filter &#34;</span>- .svn/<span class="s2">&#34; --filter &#34;</span>- .git/<span class="s2">&#34; --filter &#34;</span>- .hg/<span class="s2">&#34; --filter &#34;</span>- Headers<span class="s2">&#34; --filter &#34;</span>- PrivateHeaders<span class="s2">&#34; --filter &#34;</span>- Modules<span class="s2">&#34; &#34;</span><span class="si">${</span><span class="nv">bcsymbolmap_path</span><span class="si">}</span><span class="s2">&#34; &#34;</span><span class="si">${</span><span class="nv">destination</span><span class="si">}</span><span class="s2">&#34;&#34;</span>
    rsync --delete -av <span class="s2">&#34;</span><span class="si">${</span><span class="nv">RSYNC_PROTECT_TMP_FILES</span><span class="p">[@]</span><span class="si">}</span><span class="s2">&#34;</span> --filter <span class="s2">&#34;- CVS/&#34;</span> --filter <span class="s2">&#34;- .svn/&#34;</span> --filter <span class="s2">&#34;- .git/&#34;</span> --filter <span class="s2">&#34;- .hg/&#34;</span> --filter <span class="s2">&#34;- Headers&#34;</span> --filter <span class="s2">&#34;- PrivateHeaders&#34;</span> --filter <span class="s2">&#34;- Modules&#34;</span> <span class="s2">&#34;</span><span class="si">${</span><span class="nv">bcsymbolmap_path</span><span class="si">}</span><span class="s2">&#34;</span> <span class="s2">&#34;</span><span class="si">${</span><span class="nv">destination</span><span class="si">}</span><span class="s2">&#34;</span>
<span class="o">}</span>

<span class="c1"># Signs a framework with the provided identity</span>
<span class="c1"># 使用提供的证明签名框架</span>
code_sign_if_enabled<span class="o">()</span> <span class="o">{</span>
  <span class="k">if</span> <span class="o">[</span> -n <span class="s2">&#34;</span><span class="si">${</span><span class="nv">EXPANDED_CODE_SIGN_IDENTITY</span><span class="k">:-</span><span class="si">}</span><span class="s2">&#34;</span> -a <span class="s2">&#34;</span><span class="si">${</span><span class="nv">CODE_SIGNING_REQUIRED</span><span class="k">:-</span><span class="si">}</span><span class="s2">&#34;</span> !<span class="o">=</span> <span class="s2">&#34;NO&#34;</span> -a <span class="s2">&#34;</span><span class="si">${</span><span class="nv">CODE_SIGNING_ALLOWED</span><span class="si">}</span><span class="s2">&#34;</span> !<span class="o">=</span> <span class="s2">&#34;NO&#34;</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
    <span class="c1"># Use the current code_sign_identity</span>
    <span class="nb">echo</span> <span class="s2">&#34;Code Signing </span><span class="nv">$1</span><span class="s2"> with Identity </span><span class="si">${</span><span class="nv">EXPANDED_CODE_SIGN_IDENTITY_NAME</span><span class="si">}</span><span class="s2">&#34;</span>
    <span class="nb">local</span> <span class="nv">code_sign_cmd</span><span class="o">=</span><span class="s2">&#34;/usr/bin/codesign --force --sign </span><span class="si">${</span><span class="nv">EXPANDED_CODE_SIGN_IDENTITY</span><span class="si">}</span><span class="s2"> </span><span class="si">${</span><span class="nv">OTHER_CODE_SIGN_FLAGS</span><span class="k">:-</span><span class="si">}</span><span class="s2"> --preserve-metadata=identifier,entitlements &#39;</span><span class="nv">$1</span><span class="s2">&#39;&#34;</span>

    <span class="k">if</span> <span class="o">[</span> <span class="s2">&#34;</span><span class="si">${</span><span class="nv">COCOAPODS_PARALLEL_CODE_SIGN</span><span class="si">}</span><span class="s2">&#34;</span> <span class="o">==</span> <span class="s2">&#34;true&#34;</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
      <span class="nv">code_sign_cmd</span><span class="o">=</span><span class="s2">&#34;</span><span class="nv">$code_sign_cmd</span><span class="s2"> &amp;&#34;</span>
    <span class="k">fi</span>
    <span class="nb">echo</span> <span class="s2">&#34;</span><span class="nv">$code_sign_cmd</span><span class="s2">&#34;</span>
    <span class="nb">eval</span> <span class="s2">&#34;</span><span class="nv">$code_sign_cmd</span><span class="s2">&#34;</span>
  <span class="k">fi</span>
<span class="o">}</span>

<span class="c1"># Strip invalid architectures</span>
<span class="c1"># 删除无效架构函数</span>
strip_invalid_archs<span class="o">()</span> <span class="o">{</span>
  <span class="nv">binary</span><span class="o">=</span><span class="s2">&#34;</span><span class="nv">$1</span><span class="s2">&#34;</span>
  <span class="c1"># Get architectures for current target binary</span>
  <span class="c1"># 获取当前二进制架构，x86_64 模拟器</span>
  <span class="nv">binary_archs</span><span class="o">=</span><span class="s2">&#34;</span><span class="k">$(</span>lipo -info <span class="s2">&#34;</span><span class="nv">$binary</span><span class="s2">&#34;</span> <span class="p">|</span> rev <span class="p">|</span> cut -d <span class="s1">&#39;:&#39;</span> -f1 <span class="p">|</span> awk <span class="s1">&#39;{$1=$1;print}&#39;</span> <span class="p">|</span> rev<span class="k">)</span><span class="s2">&#34;</span>

  <span class="c1"># Intersect them with the architectures we are building for</span>
  <span class="c1"># 与目标架构取交集</span>
  <span class="nv">intersected_archs</span><span class="o">=</span><span class="s2">&#34;</span><span class="k">$(</span><span class="nb">echo</span> <span class="si">${</span><span class="nv">ARCHS</span><span class="p">[@]</span><span class="si">}</span> <span class="si">${</span><span class="nv">binary_archs</span><span class="p">[@]</span><span class="si">}</span> <span class="p">|</span> tr <span class="s1">&#39; &#39;</span> <span class="s1">&#39;\n&#39;</span> <span class="p">|</span> sort <span class="p">|</span> uniq -d<span class="k">)</span><span class="s2">&#34;</span>
  <span class="c1"># If there are no archs supported by this binary then warn the user</span>
  <span class="c1"># 如果交集为空，即没有支持的架构，则警告用户</span>
  <span class="k">if</span> <span class="o">[[</span> -z <span class="s2">&#34;</span><span class="nv">$intersected_archs</span><span class="s2">&#34;</span> <span class="o">]]</span><span class="p">;</span> <span class="k">then</span>
    <span class="nb">echo</span> <span class="s2">&#34;warning: [CP] Vendored binary &#39;</span><span class="nv">$binary</span><span class="s2">&#39; contains architectures (</span><span class="nv">$binary_archs</span><span class="s2">) none of which match the current build architectures (</span><span class="nv">$ARCHS</span><span class="s2">).&#34;</span>
    <span class="nv">STRIP_BINARY_RETVAL</span><span class="o">=</span><span class="m">0</span>
    <span class="k">return</span>
  <span class="k">fi</span>
  <span class="nv">stripped</span><span class="o">=</span><span class="s2">&#34;&#34;</span>
  <span class="k">for</span> arch in <span class="nv">$binary_archs</span><span class="p">;</span> <span class="k">do</span>
    <span class="k">if</span> ! <span class="o">[[</span> <span class="s2">&#34;</span><span class="si">${</span><span class="nv">ARCHS</span><span class="si">}</span><span class="s2">&#34;</span> <span class="o">==</span> *<span class="s2">&#34;</span><span class="nv">$arch</span><span class="s2">&#34;</span>* <span class="o">]]</span><span class="p">;</span> <span class="k">then</span>
      <span class="c1"># Strip non-valid architectures in-place</span>
      <span class="c1"># 删除无效架构</span>
      lipo -remove <span class="s2">&#34;</span><span class="nv">$arch</span><span class="s2">&#34;</span> -output <span class="s2">&#34;</span><span class="nv">$binary</span><span class="s2">&#34;</span> <span class="s2">&#34;</span><span class="nv">$binary</span><span class="s2">&#34;</span>
      <span class="nv">stripped</span><span class="o">=</span><span class="s2">&#34;</span><span class="nv">$stripped</span><span class="s2"> </span><span class="nv">$arch</span><span class="s2">&#34;</span>
    <span class="k">fi</span>
  <span class="k">done</span>
  <span class="k">if</span> <span class="o">[[</span> <span class="s2">&#34;</span><span class="nv">$stripped</span><span class="s2">&#34;</span> <span class="o">]]</span><span class="p">;</span> <span class="k">then</span>
    <span class="nb">echo</span> <span class="s2">&#34;Stripped </span><span class="nv">$binary</span><span class="s2"> of architectures:</span><span class="nv">$stripped</span><span class="s2">&#34;</span>
  <span class="k">fi</span>
  <span class="nv">STRIP_BINARY_RETVAL</span><span class="o">=</span><span class="m">1</span>
<span class="o">}</span>

<span class="c1"># CONFIGURATION：运行的 scheme 配置模式，Debug 或 Release</span>
<span class="c1"># 目前 Debug 和 Release 模式处理一致</span>
<span class="c1"># /Users/kingcos/Library/Developer/Xcode/DerivedData/oc-demo-project-pod-gmhizsqflcuavpebfzsfyychzzuj/Build/Products/Debug-iphonesimulator/AFNetworking/AFNetworking.framework</span>

<span class="c1"># /Users/kingcos/Library/Developer/Xcode/DerivedData/oc-demo-project-pod-gmhizsqflcuavpebfzsfyychzzuj/Build/Products/Debug-iphonesimulator/oc-pod/oc_pod.framework</span>
<span class="c1"># /Users/kingcos/Library/Developer/Xcode/DerivedData/oc-demo-project-pod-gmhizsqflcuavpebfzsfyychzzuj/Build/Products/Debug-iphonesimulator/swift-pod/swift_pod.framework</span>
<span class="k">if</span> <span class="o">[[</span> <span class="s2">&#34;</span><span class="nv">$CONFIGURATION</span><span class="s2">&#34;</span> <span class="o">==</span> <span class="s2">&#34;Debug&#34;</span> <span class="o">]]</span><span class="p">;</span> <span class="k">then</span>
  install_framework <span class="s2">&#34;</span><span class="si">${</span><span class="nv">BUILT_PRODUCTS_DIR</span><span class="si">}</span><span class="s2">/AFNetworking/AFNetworking.framework&#34;</span>
  install_framework <span class="s2">&#34;</span><span class="si">${</span><span class="nv">BUILT_PRODUCTS_DIR</span><span class="si">}</span><span class="s2">/oc-pod/oc_pod.framework&#34;</span>
  install_framework <span class="s2">&#34;</span><span class="si">${</span><span class="nv">BUILT_PRODUCTS_DIR</span><span class="si">}</span><span class="s2">/swift-pod/swift_pod.framework&#34;</span>
<span class="k">fi</span>
<span class="k">if</span> <span class="o">[[</span> <span class="s2">&#34;</span><span class="nv">$CONFIGURATION</span><span class="s2">&#34;</span> <span class="o">==</span> <span class="s2">&#34;Release&#34;</span> <span class="o">]]</span><span class="p">;</span> <span class="k">then</span>
  install_framework <span class="s2">&#34;</span><span class="si">${</span><span class="nv">BUILT_PRODUCTS_DIR</span><span class="si">}</span><span class="s2">/AFNetworking/AFNetworking.framework&#34;</span>
  install_framework <span class="s2">&#34;</span><span class="si">${</span><span class="nv">BUILT_PRODUCTS_DIR</span><span class="si">}</span><span class="s2">/oc-pod/oc_pod.framework&#34;</span>
  install_framework <span class="s2">&#34;</span><span class="si">${</span><span class="nv">BUILT_PRODUCTS_DIR</span><span class="si">}</span><span class="s2">/swift-pod/swift_pod.framework&#34;</span>
<span class="k">fi</span>
<span class="k">if</span> <span class="o">[</span> <span class="s2">&#34;</span><span class="si">${</span><span class="nv">COCOAPODS_PARALLEL_CODE_SIGN</span><span class="si">}</span><span class="s2">&#34;</span> <span class="o">==</span> <span class="s2">&#34;true&#34;</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
  <span class="nb">wait</span>
<span class="k">fi</span>
</code></pre></div><p>使用 <code>use_frameworks!</code> 依赖的 Pod 库即可在 Obj-C 工程中使用 <code>@import</code> 引入，或者将共有头文件引入。需要注意的是，不同于上述非 <code>use_frameworks!</code> 情况，<code>#import</code> 是引入相对于 Framework 的头文件位置。对于 Swift Pod 则无不同：</p>
<div class="highlight"><pre class="chroma"><code class="language-objectivec" data-lang="objectivec"><span class="cp">#import &#34;ViewController.h&#34;
</span><span class="cp"></span>
<span class="c1">//#import &lt;oc-pod/ObjC_Foo.h&gt; ❌，仅在非 `use_frameworks!` 下以文件夹相对路径引入而支持 `-`
</span><span class="c1"></span><span class="cp">#import &lt;oc_pod/ObjC_Foo.h&gt;
</span><span class="cp"></span><span class="c1">//#import &lt;ObjC_Foo.h&gt;
</span><span class="c1">//#import &#34;ObjC_Foo.h&#34;
</span><span class="c1">//@import oc_pod;
</span><span class="c1"></span>
<span class="p">@</span><span class="n">import</span> <span class="n">swift_pod</span><span class="p">;</span>

<span class="k">@interface</span> <span class="nc">ViewController</span> <span class="p">()</span>
<span class="k">@end</span>

<span class="k">@implementation</span> <span class="nc">ViewController</span>
<span class="p">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">viewDidLoad</span> <span class="p">{</span>
    <span class="p">[</span><span class="nb">super</span> <span class="n">viewDidLoad</span><span class="p">];</span>

    <span class="p">[[[</span><span class="n">ObjC_Foo</span> <span class="n">alloc</span><span class="p">]</span> <span class="n">init</span><span class="p">]</span> <span class="n">foo</span><span class="p">];</span>

    <span class="p">[[[</span><span class="n">Swift_Foo</span> <span class="n">alloc</span><span class="p">]</span> <span class="n">init</span><span class="p">]</span> <span class="n">foo</span><span class="p">];</span>
    <span class="n">NSLog</span><span class="p">(</span><span class="s">@&#34;%@&#34;</span><span class="p">,</span> <span class="p">[[[</span><span class="n">Swift_Foo</span> <span class="n">alloc</span><span class="p">]</span> <span class="n">init</span><span class="p">]</span> <span class="n">strings</span><span class="p">]);</span>
<span class="p">}</span>
<span class="k">@end</span>
</code></pre></div><h4 id="swift-工程-1">Swift 工程</h4>
<p>Swift 工程下也是类似的，我们可以在桥接文件中使用 <code>@import</code> 引入，或者将共有头文件引入。但其实此时桥接文件本身即是多余的，我们只需要在 Swift 工程中直接使用 <code>import</code> 即可：</p>
<div class="highlight"><pre class="chroma"><code class="language-swift" data-lang="swift"><span class="kd">import</span> <span class="nc">UIKit</span>
<span class="kd">import</span> <span class="nc">swift_pod</span>
<span class="kd">import</span> <span class="nc">oc_pod</span>

<span class="kd">class</span> <span class="nc">ViewController</span><span class="p">:</span> <span class="n">UIViewController</span> <span class="p">{</span>
    <span class="kr">override</span> <span class="kd">func</span> <span class="nf">viewDidLoad</span><span class="p">()</span> <span class="p">{</span>
        <span class="kc">super</span><span class="p">.</span><span class="n">viewDidLoad</span><span class="p">()</span>

        <span class="n">ObjC_Foo</span><span class="p">().</span><span class="n">foo</span><span class="p">()</span>

<span class="c1">//        Swift_Foo().foo()</span>
        <span class="bp">print</span><span class="p">(</span><span class="n">Swift_Foo</span><span class="p">().</span><span class="n">strings</span><span class="p">())</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div><ul>
<li>TODO:</li>
<li><input disabled="" type="checkbox"> @import</li>
<li><input disabled="" type="checkbox"> Module Map</li>
</ul>
<h2 id="reference">Reference</h2>
<!-- - [Linkers and Loaders](https://book.douban.com/subject/1436811/) -->
<ul>
<li><a href="../../2018/dyld_shared_cache/">谈谈 iOS 中的 dyld_shared_cache - kingcos</a></li>
<li><a href="/posts/2019/+load_in_ios/">iOS 中的 +load 方法 - kingcos</a></li>
<li><a href="https://forums.swift.org/t/whats-in-the-file-of-swiftmodule-how-to-open-it/1032">what’s in the file of .swiftmodule?how to open it?</a></li>
<li><a href="https://forums.swift.org/t/looking-for-documentation-insight-on-swiftdoc/6869">Looking for documentation/insight on .swiftdoc</a></li>
<li><a href="https://forums.swift.org/t/swift-static-libraries-dont-copy-generated-objective-c-header/19816">Swift static libraries don’t copy generated Objective-C header</a></li>
<li><a href="https://stackoverflow.com/questions/29580438/use-swift-library-in-objc">Use Swift Library in ObjC - StackOverflow</a></li>
<li><a href="https://paul-samuels.com/blog/2018/01/14/swift-static-library-in-objective-c/">Swift static library in Objective-C - Paul Samuels</a></li>
<li><a href="https://developer.apple.com/library/archive/documentation/MacOSX/Conceptual/BPFrameworks/Frameworks.html">Framework Programming Guide - Apple</a></li>
<li><a href="https://developer.apple.com/library/archive/documentation/CoreFoundation/Conceptual/CFBundles/BundleTypes/BundleTypes.html">Bundle Programming Guide - Apple</a></li>
<li><a href="https://developer.apple.com/library/archive/technotes/tn2435/_index.html">Technical Note TN2435 - Embedding Frameworks In An App - Apple</a></li>
<li><a href="https://www.raywenderlich.com/2430-how-to-create-a-framework-for-ios">How to Create a Framework for iOS - Ray Wenderlich</a></li>
</ul>
</div>
                    <div class="post_footer">
                        
                        <div class="meta">
                            <div class="info">
                                <span class="field tags">
                                    <i class="ri-stack-line"></i>
                                    
                                    <a href="https://kingcos.me/tags/focus/">Focus</a>
                                    
                                    <a href="https://kingcos.me/tags/ios/">iOS</a>
                                    
                                    <a href="https://kingcos.me/tags/obj-c/">Obj-C</a>
                                    
                                    <a href="https://kingcos.me/tags/swift/">Swift</a>
                                    
                                    <a href="https://kingcos.me/tags//">🚧</a>
                                    
                                </span>
                            </div>
                        </div>
                        
                    </div>
                </div>
                <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<table style="border: 0;">
  <tr>
  <td style="border: 0; width: 30%;">
    <img width='100%' src='/img/about/1.jpg'>
  </td>
  <td style="border: 0; width: 50%;">
    <ins class="adsbygoogle"
     style="display:block;width:100%;"
     data-ad-client="ca-pub-9925978992661955"
     data-ad-slot="3213735320"
     data-ad-format="rectangle"
     data-full-width-responsive="false"></ins>
  </td>
  </tr>
</table>

<hr>

<script>
    (adsbygoogle = window.adsbygoogle || []).push({});
</script>
                
                
                <div class="doc_comments"><div id="disqus_thread"></div>
<script type="application/javascript">
    var disqus_config = function () {
    
    
    
    };
    (function() {
        if (["localhost", "127.0.0.1"].indexOf(window.location.hostname) != -1) {
            document.getElementById('disqus_thread').innerHTML = 'Disqus comments not available by default when the website is previewed locally.';
            return;
        }
        var d = document, s = d.createElement('script'); s.async = true;
        s.src = '//' + "kingcos" + '.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="https://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a></div>
                
            </div>
        </div>
    </div>
    <a id="back_to_top" href="#" class="back_to_top"><i class="ri-arrow-up-s-line"></i></a>
    <footer class="footer">
    <div class="powered_by">
        <a href="https://kingcos.me">Powered by kingcos with love.</a>
    </div>

    <div class="footer_slogan">
        <span>❤️</span>
    </div>
</footer>
    <script src="https://kingcos.me/js/jquery-3.5.1.min.js"></script>
<link href="https://kingcos.me/css/fancybox.min.css" rel="stylesheet">
<script src="https://kingcos.me/js/fancybox.min.js"></script>
<script src="https://kingcos.me/js/zozo.js"></script>


<script type="text/javascript" async
    src="https://cdn.bootcss.com/mathjax/2.7.5/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
        MathJax.Hub.Config({
            tex2jax: {
                inlineMath: [['$', '$'], ['\\(', '\\)']],
                displayMath: [['$$', '$$'], ['\[\[', '\]\]']],
                processEscapes: true,
                processEnvironments: true,
                skipTags: ['script', 'noscript', 'style', 'textarea', 'pre'],
                TeX: {
                    equationNumbers: { autoNumber: "AMS" },
                    extensions: ["AMSmath.js", "AMSsymbols.js"]
                }
            }
        });

        MathJax.Hub.Queue(function () {
            
            
            
            var all = MathJax.Hub.getAllJax(), i;
            for (i = 0; i < all.length; i += 1) {
                all[i].SourceElement().parentNode.className += ' has-jax';
            }
        });
    </script>

<style>
    code.has-jax {
        font: inherit;
        font-size: 100%;
        background: inherit;
        border: inherit;
        color: #515151;
    }
</style>



<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-138311951-1', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>

</body>

</html>