<!DOCTYPE html>
<html lang="en">
  <head>
    
      <title>iOS 中的库与框架 :: iBlog</title>
    
    <meta http-equiv="content-type" content="text/html; charset=utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">
<meta name="description" content="Date Notes     2019-09-14 首次提交，持续更新完善   2019-09-22 适配 Xcode 11，持续更新完善   2019-10-29 添加 Demo：libraries_in_ios-demo    Preface 随着软件工程的发展，很多我们需要的功能前人都已经很好地实现了，为了提高效率避免重复建设，这些功能实现的代码被封装为代码库，有时也称框架。我们只需要在用到的时候通过依赖管理工具将它们以适当的方式引入即可。本文将简单聊聊 iOS 中的库与框架相关概念。
基本概念 在切入正题之前，我们先来达成一些共识。
不管是老派 Obj-C 还是新秀 Swift，它们的本质都是编译型语言。对于编译型语言，源代码会首先经由编译器编译为目标文件，链接器再将多个目标文件链接为可执行文件。针对链接阶段，主要分为静态链接与动态链接。
静态，即 Static。按照字面意思，静态即一旦确定，就不再容易改变。静态链接，即在链接阶段，直接将多个目标文件链接为一个文件。而静态库就可以理解为共同编译为一个目标文件的源代码集合。
动态，即 Dynamic。按照字面意思，动态即推迟到运行时动态地决议。动态链接，即在运行时才将各个部分组合形成完整的程序。而动态库就可以理解为支持动态链接方式的源代码集合。
静态链接的好处是，运行时不再额外需要时间动态链接；坏处则是由于链接的粒度是目标文件，那么可能会链接了没有使用到的函数，会造成可执行文件过大；而且当某一个目标文件的源代码改动时，那么所有依赖该目标文件的静态库都需要重新编译；动态链接则解决了静态链接的空间浪费与重复编译问题，比如在 iOS 中，系统库采用了 dyld_shared_cache 动态链接，这样其它程序就无需再将系统库重复链接，当 iOS 系统更新时也无需将所有 app 重新编译。而在移动端开发中，app 的启动时间与包体积大小将是一个权衡问题，值得我们侧重与考量。
另外，虽然广义上的库（Library）与框架（Framework）含义是类似的，但在 iOS 开发中，官方将这两个概念进行了区分，因此下文中我们会明确两个词的使用。
Cocoa Touch Static Library 我们先从 Xcode 中能够直接创建的 Cocoa Touch Static Library 说起（注意，在 Xcode 11 中，这里已经变成 Framework 与 Library，更加清晰）："/>
<meta name="keywords" content="ios,static,library,framework,objc,objectivec,objective-c,swift,dev,develop,静态库,静态库,框架"/>
<meta name="robots" content="noodp"/>
<link rel="canonical" href="/posts/2019/libraries_in_ios/" />





<link rel="stylesheet" href="/assets/style.css">


<link rel="stylesheet" href="/style.css">


<link rel="apple-touch-icon-precomposed" sizes="144x144" href="/img/apple-touch-icon-144-precomposed.png">
<link rel="shortcut icon" href="/img/favicon.png">


<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="iOS 中的库与框架"/>
<meta name="twitter:description" content="随着软件工程的发展，很多我们需要的功能前人都已经很好地实现了，为了提高效率避免重复建设，这些功能实现的代码被封装为代码库，有时也称框架。我们只需要在用到的时候通过依赖管理工具将它们以适当的方式引入即可。本文将简单聊聊 iOS 中的库与框架相关概念。"/>



<meta property="og:title" content="iOS 中的库与框架" />
<meta property="og:description" content="随着软件工程的发展，很多我们需要的功能前人都已经很好地实现了，为了提高效率避免重复建设，这些功能实现的代码被封装为代码库，有时也称框架。我们只需要在用到的时候通过依赖管理工具将它们以适当的方式引入即可。本文将简单聊聊 iOS 中的库与框架相关概念。" />
<meta property="og:type" content="article" />
<meta property="og:url" content="/posts/2019/libraries_in_ios/" />
<meta property="article:published_time" content="2019-10-29T00:00:00+00:00" />
<meta property="article:modified_time" content="2019-10-29T00:00:00+00:00" /><meta property="og:site_name" content="iBlog" />




<script data-ad-client="ca-pub-9925978992661955" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>

  </head>
  <body class="">
    <div class="container">
      <header class="header">
  <span class="header__inner">
    <a href="/" class="logo" style="text-decoration: none;">
  
    <span class="logo__mark"><svg xmlns="http://www.w3.org/2000/svg" class="greater-icon" viewBox="0 0 44 44">
  <path fill="none" d="M15 8l14.729 14.382L15 35.367"/>
</svg>
</span>
    <span class="logo__text">kingcos.me</span>
    <span class="logo__cursor"></span>
  
</a>

    <span class="header__right">
      
        <nav class="menu">
  <ul class="menu__inner menu__inner--desktop">
    
      
        
          <li><a href="/about">About</a></li>
        
      
        
          <li><a href="/links">Links</a></li>
        
      
        
          <li><a href="/perspective">Perspective</a></li>
        
      
        
          <li><a href="/words">Words</a></li>
        
      
      
    
  </ul>

  <ul class="menu__inner menu__inner--mobile">
    
      
        <li><a href="/about">About</a></li>
      
    
      
        <li><a href="/links">Links</a></li>
      
    
      
        <li><a href="/perspective">Perspective</a></li>
      
    
      
        <li><a href="/words">Words</a></li>
      
    
  </ul>
</nav>

        <span class="menu-trigger">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
            <path d="M0 0h24v24H0z" fill="none"/>
            <path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"/>
          </svg>
        </span>
      
      <span class="theme-toggle">
        <svg class="theme-toggler" width="24" height="24" viewBox="0 0 48 48" fill="none" xmlns="http://www.w3.org/2000/svg">
  <path d="M22 41C32.4934 41 41 32.4934 41 22C41 11.5066 32.4934 3 22
  3C11.5066 3 3 11.5066 3 22C3 32.4934 11.5066 41 22 41ZM7 22C7
  13.7157 13.7157 7 22 7V37C13.7157 37 7 30.2843 7 22Z"/>
</svg>

      </span>
    </span>
  </span>
</header>


      <div class="content">
        
  <div class="post">
    <h2 class="post-title"><a href="/posts/2019/libraries_in_ios/">iOS 中的库与框架</a></h2>
    <div class="post-meta">
      
        <span class="post-date">
            2019-10-29
        </span>
      
      
      
        <span class="post-read-time">— 17 min read</span>
      
    </div>

    
      <span class="post-tags">
        
          #<a href="/tags/focus/">Focus</a>&nbsp;
        
          #<a href="/tags/ios/">iOS</a>&nbsp;
        
          #<a href="/tags/obj-c/">Obj-C</a>&nbsp;
        
          #<a href="/tags/swift/">Swift</a>&nbsp;
        
          #<a href="/tags//">🚧</a>&nbsp;
        
      </span>
    

    

    <div class="post-content">
      <table>
<thead>
<tr>
<th style="text-align:center">Date</th>
<th style="text-align:center">Notes</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">2019-09-14</td>
<td style="text-align:center">首次提交，持续更新完善</td>
</tr>
<tr>
<td style="text-align:center">2019-09-22</td>
<td style="text-align:center">适配 Xcode 11，持续更新完善</td>
</tr>
<tr>
<td style="text-align:center">2019-10-29</td>
<td style="text-align:center">添加 Demo：<a href="https://github.com/kingcos/libraries_in_ios-demo">libraries_in_ios-demo</a></td>
</tr>
</tbody>
</table>
<p><img src="/img/2019/libraries_in_ios/0.png" alt="0"></p>
<h2 id="preface">Preface</h2>
<p>随着软件工程的发展，很多我们需要的功能前人都已经很好地实现了，为了提高效率避免重复建设，这些功能实现的代码被封装为代码库，有时也称框架。我们只需要在用到的时候通过依赖管理工具将它们以适当的方式引入即可。本文将简单聊聊 iOS 中的库与框架相关概念。</p>
<h2 id="基本概念">基本概念</h2>
<p>在切入正题之前，我们先来达成一些共识。</p>
<p>不管是老派 Obj-C 还是新秀 Swift，它们的本质都是编译型语言。对于编译型语言，源代码会首先经由编译器编译为目标文件，链接器再将多个目标文件链接为可执行文件。针对链接阶段，主要分为静态链接与动态链接。</p>
<p><strong>静态</strong>，即 Static。按照字面意思，静态即一旦确定，就不再容易改变。静态链接，即在链接阶段，直接将多个目标文件链接为一个文件。而静态库就可以理解为共同编译为一个目标文件的源代码集合。</p>
<p><strong>动态</strong>，即 Dynamic。按照字面意思，动态即推迟到运行时动态地决议。动态链接，即在运行时才将各个部分组合形成完整的程序。而动态库就可以理解为支持动态链接方式的源代码集合。</p>
<p>静态链接的好处是，运行时不再额外需要时间动态链接；坏处则是由于链接的粒度是目标文件，那么可能会链接了没有使用到的函数，会造成可执行文件过大；而且当某一个目标文件的源代码改动时，那么所有依赖该目标文件的静态库都需要重新编译；动态链接则解决了静态链接的空间浪费与重复编译问题，比如在 iOS 中，系统库采用了 dyld_shared_cache 动态链接，这样其它程序就无需再将系统库重复链接，当 iOS 系统更新时也无需将所有 app 重新编译。而在移动端开发中，app 的启动时间与包体积大小将是一个权衡问题，值得我们侧重与考量。</p>
<p>另外，虽然广义上的库（Library）与框架（Framework）含义是类似的，但在 iOS 开发中，官方将这两个概念进行了区分，因此下文中我们会明确两个词的使用。</p>
<h2 id="cocoa-touch-static-library">Cocoa Touch Static Library</h2>
<p>我们先从 Xcode 中能够直接创建的 Cocoa Touch Static Library 说起（注意，在 Xcode 11 中，这里已经变成 Framework 与 Library，更加清晰）：</p>
<p><img src="/img/2019/libraries_in_ios/1.png" alt="1"></p>
<p>Cocoa Touch Static Library 即静态库。iOS 上狭义的静态库，即<strong>只包含编译后代码的 <code>.a</code> 文件</strong>。我们创建一个 oc-static-lib 的静态库，为其默认提供的 <code>oc_static_lib</code> 类添加 <code>foo</code> 方法，并添加一个 <code>NSObject</code> 的分类，实现 +load 和 <code>foo</code> 方法：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-objectivec" data-lang="objectivec"><span style="color:#75715e">// oc_static_lib.h
</span><span style="color:#75715e"></span>
<span style="color:#75715e">#import &lt;Foundation/Foundation.h&gt;
</span><span style="color:#75715e"></span>
<span style="color:#66d9ef">@interface</span> <span style="color:#a6e22e">oc_static_lib</span> : <span style="color:#a6e22e">NSObject</span>
- (<span style="color:#66d9ef">void</span>)<span style="color:#a6e22e">foo</span>;
<span style="color:#66d9ef">@end</span>

<span style="color:#75715e">// oc_static_lib.m
</span><span style="color:#75715e"></span>
<span style="color:#75715e">#import &#34;oc_static_lib.h&#34;
</span><span style="color:#75715e"></span>
<span style="color:#66d9ef">@implementation</span> <span style="color:#a6e22e">oc_static_lib</span>
- (<span style="color:#66d9ef">void</span>)<span style="color:#a6e22e">foo</span> {
    NSLog(<span style="color:#e6db74">@&#34;%@ - %@&#34;</span>, NSStringFromClass([self <span style="color:#66d9ef">class</span>]), NSStringFromSelector(_cmd));
}
<span style="color:#66d9ef">@end</span>

<span style="color:#75715e">// NSObject+OC_Static_Lib.h
</span><span style="color:#75715e"></span>
<span style="color:#75715e">#import &lt;Foundation/Foundation.h&gt;
</span><span style="color:#75715e"></span>
NS_ASSUME_NONNULL_BEGIN
<span style="color:#66d9ef">@interface</span> <span style="color:#a6e22e">NSObject</span> (OC_Static_Lib)
- (<span style="color:#66d9ef">void</span>)<span style="color:#a6e22e">foo</span>;
<span style="color:#66d9ef">@end</span>
NS_ASSUME_NONNULL_END

<span style="color:#75715e">// NSObject+OC_Static_Lib.m
</span><span style="color:#75715e"></span>
<span style="color:#75715e">#import &#34;NSObject+OC_Static_Lib.h&#34;
</span><span style="color:#75715e"></span>
<span style="color:#66d9ef">@implementation</span> <span style="color:#a6e22e">NSObject</span> (OC_Static_Lib)
+ (<span style="color:#66d9ef">void</span>)<span style="color:#a6e22e">load</span> {
    NSLog(<span style="color:#e6db74">@&#34;%@ - %@&#34;</span>, NSStringFromClass([self <span style="color:#66d9ef">class</span>]), NSStringFromSelector(_cmd));
}
- (<span style="color:#66d9ef">void</span>)<span style="color:#a6e22e">foo</span> {
    NSLog(<span style="color:#e6db74">@&#34;%@ - %@&#34;</span>, NSStringFromClass([self <span style="color:#66d9ef">class</span>]), NSStringFromSelector(_cmd));
}
<span style="color:#66d9ef">@end</span>
</code></pre></div><p>需要注意的是我们需要将新创建的 <code>.h</code> 加入到 Xcode - Targets - Build Phases - Copy Files 中，这样外界才能通过引入该头文件来访问其中的内容：</p>
<p><img src="/img/2019/libraries_in_ios/2.png" alt="2"></p>
<blockquote>
<p>⚠️ 注意：</p>
<p>这里我们的目标设备选择的是模拟器，所以默认编译后的 <code>.a</code> 文件也将只适用于模拟器架构（x86_64），为了同时能够真机运行和模拟器调试，通常会使用 <code>lipo</code> 命令将多种架构的 <code>.a</code> 文件进行合并为胖二进制（Fat-Binary）文件。</p>
</blockquote>
<h3 id="obj-c-工程引入-obj-c-静态库">Obj-C 工程引入 Obj-C 静态库</h3>
<p><img src="/img/2019/libraries_in_ios/3.png" alt="3"></p>
<p>我们将 oc-static-lib 编译后的 <code>.a</code> 与 <code>.h</code> 一起拖入 Obj-C 工程（勾选「Add to targets」添加至目标 Target，或者手动将 <code>.a</code> 加入到「Link Binary With Libraries」中），即可使用 <code>#import &quot;&quot;</code> 来引入并调用（需要注意的是：静态库中如果存在分类，需要添加 <code>-ObjC</code> 作为 Other Linker Flags，具体可详见《<a href="/posts/2019/+load_in_ios/">iOS 中的 +load 方法</a>》一文）：</p>
<blockquote>
<p><strong>Tips</strong></p>
<p>在 C/C++ 中，为了更加清晰化声明与实现，声明和实现需要分别写在 <code>.h</code>（头文件）和 <code>.c</code> / <code>.cpp</code>（实现文件）中。这样的好处是，开发者可以无需额外的访问控制符即可将需要暴露在外界的声明放置在头文件中，外界使用时通过 <code>#include</code> 引用头文件即可。Obj-C/C++ 也延续了这一传统，不同的是实现文件的后缀分别为 <code>.m</code> 和 <code>.mm</code>，并为了避免重复引用新推出了 <code>#import</code>。</p>
<p><code>#include</code> 和 <code>#import</code> 后面都可以加 <code>&lt;XXX.h&gt;</code> 或 <code>&quot;XXX.h&quot;</code>。通常来说加 <code>&quot;&quot;</code> 的头文件优先从本地当前文件目录查找，其中也可以包含相对路径，即 <code>#import &quot;oc-static-lib/oc_static_lib.h&quot;</code> / <code>#import &quot;NSObject+OC_Static_Lib.h&quot;</code> 都是支持的；而加 <code>&lt;&gt;</code> 的头文件则会使得编译器优先到系统目录下全局查找。</p>
</blockquote>
<h3 id="swift-工程引入-swift-静态库">Swift 工程引入 Swift 静态库</h3>
<p>在 Xcode 9 之后，Swift 也支持了静态库。与 Obj-C 不同，Swift 没有头文件的概念，因此我们需要将暴露给外界的类和函数等使用 <code>public</code> 修饰。编译后的 Swift 静态库也是 <code>.a</code> 文件，但不同的是多了 <code>.swiftmodule</code> 以及 <code>.swiftdoc</code>：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">➜  Debug-iphonesimulator tree
.
├── libswift-static-lib.a
└── swift_static_lib.swiftmodule
    ├── x86_64.swiftdoc
    └── x86_64.swiftmodule

<span style="color:#ae81ff">1</span> directory, <span style="color:#ae81ff">3</span> files
</code></pre></div><p><code>.swiftmodule</code> 包含了序列化过的 AST（抽象语法树，Abstract Syntax Tree），可能也包含 SIL（Swift 中间语言，Swift Intermediate Language），我们可以将其理解为类似 C 语言库或框架中头文件的二进制格式文件；<code>.swiftdoc</code> 则是 Swift 文档注释生成的二进制文件，由 <code>Serialization::writeDocToStream()</code> 生成，因此并非是必要的。由于 Swift 的 Module 机制，我们需要在 Xcode - Targets - Build Settings - Swift Compiler - Search Paths - Import Paths 中引入：</p>
<p><img src="/img/2019/libraries_in_ios/4.png" alt="4"></p>
<p>这样我们才能在 Swift 工程中正常使用：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-swift" data-lang="swift"><span style="color:#75715e">// swift_static_lib.swift</span>

<span style="color:#66d9ef">import</span> <span style="color:#a6e22e">Foundation</span>

<span style="color:#66d9ef">@objc</span> <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">swift_static_lib</span>: NSObject {
    <span style="color:#66d9ef">@objc</span> <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">func</span> <span style="color:#a6e22e">foo</span>() {
        print(<span style="color:#e6db74">&#34;swift_static_lib - </span><span style="color:#e6db74">\(</span><span style="color:#66d9ef">#function</span><span style="color:#e6db74">)</span><span style="color:#e6db74">&#34;</span>)
    }
}

<span style="color:#75715e">// ViewController.swift</span>

<span style="color:#66d9ef">import</span> <span style="color:#a6e22e">UIKit</span>
<span style="color:#66d9ef">import</span> <span style="color:#a6e22e">swift_static_lib</span>

<span style="color:#66d9ef">class</span> <span style="color:#a6e22e">ViewController</span>: UIViewController {
    <span style="color:#66d9ef">override</span> <span style="color:#66d9ef">func</span> <span style="color:#a6e22e">viewDidLoad</span>() {
        <span style="color:#66d9ef">super</span>.viewDidLoad()
        swift_static_lib().foo()
    }
}
</code></pre></div><h3 id="obj-c-工程引入-swift-静态库">Obj-C 工程引入 Swift 静态库</h3>
<p>为了「提拔」新秀，Swift 支持与 Obj-C 混编，然而混编下的各种情况就会变得十分特殊。在同一个工程下 Swift 文件与 Obj-C 文件混编时，Xcode 会提示我们创建桥接头文件 <code>&lt;PROJECT_NAME&gt;-Bridging-Header.h</code>，我们可以将需要暴露给 Swift 的 Obj-C 代码在该桥接文件中引入；而 Obj-C 代码中希望使用 Swift 中的相关定义时，可以引入自动生成但不可见的 <code>&lt;PROJECT_NAME&gt;-Swift.h</code>，另外需要注意的是，暴露给 Obj-C 的类或函数等需要使用 <code>@objc</code> 或 <code>dynamic</code> 修饰，<strong>但前者不能决定函数最终派发方式，而后者则为动态派发</strong>。</p>
<p>那么如果要在 Obj-C 工程引入 Swift 静态库，首先要在工程中引入一个占位 Swift 文件，并创建桥接文件，这样 Xcode 中 Swift 相关的依赖配置才能得以建立：</p>
<p><img src="/img/2019/libraries_in_ios/7.png" alt="7"></p>
<p>Swift 静态库也可以自动生成 <code>&lt;PROJECT_NAME&gt;-Swift.h</code>，但其并没有和最终产物 <code>.a</code> 放置在一起：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">➜  Build tree
.
├── Intermediates.noindex
│   ├── XCBuildData
│   │   └── ...
│   └── swift_static_lib.build
│       └── Debug-iphonesimulator
│           └── swift_static_lib.build
│               ├── DerivedSources
│               │   └── swift_static_lib-Swift.h ⬅️
│               └── ...
└── Products
    └── ...

<span style="color:#ae81ff">17</span> directories, <span style="color:#ae81ff">41</span> files
</code></pre></div><p>因此我们可以将以下脚本添加到 Xcode - Targets - Build Phases - New Run Script Phase 中，这样每次构建即可将 <code>&lt;PROJECT_NAME&gt;-Swift.h</code> 一并拷贝到产物目录：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="color:#75715e"># Powered by https://paul-samuels.com/blog/2018/01/14/swift-static-library-in-objective-c/</span>

<span style="color:#75715e"># BUILT_PRODUCTS_DIR：构建产物目录；PRODUCT_MODULE_NAME：产物名称</span>
target_dir<span style="color:#f92672">=</span><span style="color:#e6db74">${</span>BUILT_PRODUCTS_DIR<span style="color:#e6db74">}</span>/include/<span style="color:#e6db74">${</span>PRODUCT_MODULE_NAME<span style="color:#e6db74">}</span>/

<span style="color:#75715e"># Ensure the target include path exists</span>
<span style="color:#75715e"># 递归创建文件夹</span>
mkdir -p <span style="color:#e6db74">${</span>target_dir<span style="color:#e6db74">}</span>

<span style="color:#75715e"># Copy any file that looks like a Swift generated header to the include path</span>
<span style="color:#75715e"># 复制到产物路径</span>
cp <span style="color:#e6db74">${</span>DERIVED_SOURCES_DIR<span style="color:#e6db74">}</span>/*-Swift.h <span style="color:#e6db74">${</span>target_dir<span style="color:#e6db74">}</span>
</code></pre></div><p>之后我们需要将生成的产物放 swift_static_lib 文件中一起拖到 Obj-C 工程中（勾选「Add to targets」添加至目标 Target，或者手动将 <code>.a</code> 加入到「Link Binary With Libraries」中）：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">➜  swift_static_lib tree
.
├── include
│   └── swift_static_lib
│       └── swift_static_lib-Swift.h
├── libswift_static_lib.a
└── swift_static_lib.swiftmodule
    ├── x86_64.swiftdoc
    └── x86_64.swiftmodule

<span style="color:#ae81ff">3</span> directories, <span style="color:#ae81ff">4</span> files
</code></pre></div><!-- 最后再在 Xcode - Targets - Build Settings - Header Search Paths & Library Search Paths 中添加上 `.a` 的父级路径 `$(PROJECT_DIR)/oc-demo-project/swift_static_lib` 即可（比较神奇的是，在 Xcode 11 中即使不手动指定，也可正常编译通过运行）：

![6](/img/2019/libraries_in_ios/6.png) -->
<p>这样，在 Obj-C 工程中通过 <code>#import &quot;swift_static_lib-Swift.h&quot;</code> 即可使用：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-objectivec" data-lang="objectivec"><span style="color:#75715e">// ViewController.m
</span><span style="color:#75715e"></span>
<span style="color:#75715e">//#import &#34;swift-static-lib/include/swift_static_lib/swift_static_lib-Swift.h&#34;
</span><span style="color:#75715e"></span><span style="color:#75715e">#import &#34;swift_static_lib-Swift.h&#34;
</span><span style="color:#75715e"></span>
<span style="color:#66d9ef">@implementation</span> <span style="color:#a6e22e">ViewController</span>

- (<span style="color:#66d9ef">void</span>)<span style="color:#a6e22e">viewDidLoad</span> {
    [super viewDidLoad];

    [[swift_static_lib new] foo];
}
</code></pre></div><h3 id="swift-工程引入-obj-c-静态库">Swift 工程引入 Obj-C 静态库</h3>
<p>如果想要在 Swift 工程中引入 Obj-C 静态库（注意如有分类仍需加 <code>-ObjC</code>），则也需要桥接头文件作为中介。我们在工程中新建一个占位 Obj-C 文件，按 Xcode 提示创建桥接文件；将 oc-static-lib 编译后的产物一起拖入 Swift 工程，并在桥接文件中引入 Obj-C 静态库中的相关头文件：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-objectivec" data-lang="objectivec"><span style="color:#75715e">// swift-demo-project-Bridging-Header.h
</span><span style="color:#75715e"></span>
<span style="color:#75715e">//#import &#34;liboc-static-lib/include/oc-static-lib/oc_static_lib.h&#34;
</span><span style="color:#75715e"></span><span style="color:#75715e">#import &#34;oc_static_lib.h&#34;
</span></code></pre></div><p>之后即可直接在 Swift 中使用：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-swift" data-lang="swift"><span style="color:#75715e">// ViewController.swift</span>

<span style="color:#66d9ef">import</span> <span style="color:#a6e22e">UIKit</span>

<span style="color:#66d9ef">class</span> <span style="color:#a6e22e">ViewController</span>: UIViewController {
    <span style="color:#66d9ef">override</span> <span style="color:#66d9ef">func</span> <span style="color:#a6e22e">viewDidLoad</span>() {
        <span style="color:#66d9ef">super</span>.viewDidLoad()

        oc_static_lib().foo()
    }
}
</code></pre></div><h2 id="cocoa-touch-framework">Cocoa Touch Framework</h2>
<p>Cocoa Touch Framework 是 Xcode 中能够创建的另外一种框架（Framework）类型（注意，在 Xcode 11 中，这里已经变成 Framework 与 Library，更加清晰），而非库（Library）。不同于库，iOS 中的框架指的是包含资源（比如图片、本地化文件、Storyboard 等）、头文件、以及编译后的二进制等的集合。框架的后缀名是 <code>.framework</code>，并可以通过 <code>NSBundle</code> API 访问，不同的是框架可以直接导航到其中的目录内容，便于开发者查看：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">➜  oc_framework.framework tree
.
├── Assets.car ➡️ 工程中的 xcassets 资源将被压缩为 car
├── Headers
│   ├── NSObject+OC_Framework.h
│   ├── OC_Foo.h
│   ├── PublicHeader.h
│   └── oc_framework.h
├── Info.plist
├── Modules
│   └── module.modulemap 🌟
├── _CodeSignature
│   └── CodeResources
└── oc_framework

<span style="color:#ae81ff">3</span> directories, <span style="color:#ae81ff">9</span> files

➜  swift_framework.framework tree
.
├── Headers
│   ├── swift_framework-Swift.h ➡️ 自动生成的 *-Swift.h 便于 Obj-C 工程使用
│   └── swift_framework.h
├── Info.plist
├── Modules
│   ├── module.modulemap 🌟
│   └── swift_framework.swiftmodule ➡️ 类似 Swift 静态库
│       ├── x86_64.swiftdoc
│       └── x86_64.swiftmodule
├── _CodeSignature
│   └── CodeResources
├── eng.strings ➡️ 工程中的 strings 资源
└── swift_framework

<span style="color:#ae81ff">4</span> directories, <span style="color:#ae81ff">9</span> files
</code></pre></div><p>Framework 中编译后的 Mach-O 可以根据需要作为动态库、静态库（注意如有分类仍需加 <code>-ObjC</code>）、或者可执行文件等：</p>
<p><img src="/img/2019/libraries_in_ios/8.png" alt="8"></p>
<p>Framework 中需要暴露在外界的头文件，需要在 Xcode - Targets - Build Phases - Headers - Public 中公开（Swift Framework 中的 <code>*-Swift.h</code> 则不需要手动移动）；资源文件则需要加入 Copy Bundle Resources 中（使用时通过 <code>NSBunlde</code> API）：</p>
<p><img src="/img/2019/libraries_in_ios/10.png" alt="10"></p>
<h3 id="obj-c-工程">Obj-C 工程</h3>
<p>在 Obj-C 工程中，只需要将 Framework 产物拖入并在 Xcode - Targets - General - Embedded Binaries &amp; Links Framework and Libraries 中添加即可(Xcode 11 中需将 Framework 在 Xcode - General - Frameworks, Libraries, and Embedded Content 中设置为 Embed）：</p>
<p><img src="/img/2019/libraries_in_ios/9.png" alt="9"></p>
<p>在工程中我们就可以将其引入并使用了：</p>
<p><strong>oc-framework:</strong></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-objectivec" data-lang="objectivec"><span style="color:#75715e">// OC_Foo.m
</span><span style="color:#75715e"></span>
<span style="color:#75715e">#import &#34;OC_Foo.h&#34;
</span><span style="color:#75715e"></span>
<span style="color:#66d9ef">@implementation</span> <span style="color:#a6e22e">OC_Foo</span>
- (<span style="color:#66d9ef">void</span>)<span style="color:#a6e22e">foo</span> {
    NSLog(<span style="color:#e6db74">@&#34;%@ - %@&#34;</span>, NSStringFromClass([self <span style="color:#66d9ef">class</span>]), NSStringFromSelector(_cmd));
}

- (UIImage <span style="color:#f92672">*</span>)<span style="color:#a6e22e">image</span> {
    <span style="color:#75715e">// 通过 NSBundle 获取资源
</span><span style="color:#75715e"></span>    NSBundle <span style="color:#f92672">*</span>bundle <span style="color:#f92672">=</span> [NSBundle bundleForClass:[self <span style="color:#66d9ef">class</span>]];
    <span style="color:#66d9ef">return</span> [UIImage imageNamed:<span style="color:#e6db74">@&#34;blog&#34;</span> inBundle:bundle compatibleWithTraitCollection:nil];
}
<span style="color:#66d9ef">@end</span>
</code></pre></div><p><strong>swift-framework:</strong></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-swift" data-lang="swift"><span style="color:#75715e">// Swift_Foo.swift</span>

<span style="color:#66d9ef">import</span> <span style="color:#a6e22e">Foundation</span>

<span style="color:#66d9ef">@objc</span> <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Swift_Foo</span> : NSObject {
    <span style="color:#66d9ef">@objc</span> <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">func</span> <span style="color:#a6e22e">foo</span>() {
        print(<span style="color:#e6db74">&#34;Swift_Foo - </span><span style="color:#e6db74">\(</span><span style="color:#66d9ef">#function</span><span style="color:#e6db74">)</span><span style="color:#e6db74">&#34;</span>)
    }

    <span style="color:#66d9ef">@objc</span> <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">func</span> <span style="color:#a6e22e">strings</span>() -&gt; String {
        <span style="color:#66d9ef">let</span> bundle = Bundle(<span style="color:#66d9ef">for</span>: Swift_Foo.<span style="color:#66d9ef">self</span>)
        <span style="color:#66d9ef">return</span> NSLocalizedString(<span style="color:#e6db74">&#34;my_blog&#34;</span>, bundle: bundle, comment: <span style="color:#e6db74">&#34;My blog link.&#34;</span>)
    }
}
</code></pre></div><p><strong>Obj-C 工程：</strong></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-objectivec" data-lang="objectivec"><span style="color:#75715e">// ViewController.m
</span><span style="color:#75715e"></span>
<span style="color:#75715e">#import &#34;ViewController.h&#34;
</span><span style="color:#75715e"></span>@import oc_framework;
<span style="color:#75715e">//#import &#34;oc_framework/oc_framework.h&#34;
</span><span style="color:#75715e">//#import &lt;oc_framework/oc_framework.h&gt;
</span><span style="color:#75715e">//#import &lt;oc_framework/PublicHeader.h&gt;
</span><span style="color:#75715e">//#import &lt;oc_framework/OC_Foo.h&gt;
</span><span style="color:#75715e"></span>
@import swift_framework;
<span style="color:#75715e">//#import &#34;swift_framework/swift_framework.h&#34;
</span><span style="color:#75715e">//#import &#34;swift_framework/swift_framework-Swift.h&#34;
</span><span style="color:#75715e">//#import &lt;swift_framework/swift_framework.h&gt;
</span><span style="color:#75715e">//#import &lt;swift_framework/swift_framework-Swift.h&gt;
</span><span style="color:#75715e"></span>
<span style="color:#66d9ef">@interface</span> <span style="color:#a6e22e">ViewController</span> ()
<span style="color:#66d9ef">@property</span> (<span style="color:#66d9ef">weak</span>, <span style="color:#66d9ef">nonatomic</span>) <span style="color:#66d9ef">IBOutlet</span> UIImageView <span style="color:#f92672">*</span>imageView;
<span style="color:#66d9ef">@end</span>

<span style="color:#66d9ef">@implementation</span> <span style="color:#a6e22e">ViewController</span>

- (<span style="color:#66d9ef">void</span>)<span style="color:#a6e22e">viewDidLoad</span> {
    [super viewDidLoad];

    OC_Foo <span style="color:#f92672">*</span>foo <span style="color:#f92672">=</span> [OC_Foo new];
    [foo foo];

    self.imageView.image <span style="color:#f92672">=</span> [foo image];

    Swift_Foo <span style="color:#f92672">*</span>sFoo <span style="color:#f92672">=</span> [[Swift_Foo alloc] init];
    [sFoo foo];

    NSLog(<span style="color:#e6db74">@&#34;%@&#34;</span>, [sFoo strings]);
}

<span style="color:#66d9ef">@end</span>
</code></pre></div><h3 id="swift-工程">Swift 工程</h3>
<p>Framework 的引入要比静态库简单许多，我们只需要将其直接引入工程中（注意如有分类仍需加 <code>-ObjC</code>），并在 Swift 通过 <code>import &lt;FRAMEWORK_NAME&gt;</code> 导入即可：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-swift" data-lang="swift"><span style="color:#66d9ef">import</span> <span style="color:#a6e22e">UIKit</span>
<span style="color:#66d9ef">import</span> <span style="color:#a6e22e">oc_framework</span>
<span style="color:#66d9ef">import</span> <span style="color:#a6e22e">swift_framework</span>

<span style="color:#66d9ef">class</span> <span style="color:#a6e22e">ViewController</span>: UIViewController {
    <span style="color:#66d9ef">@IBOutlet</span> <span style="color:#66d9ef">weak</span> <span style="color:#66d9ef">var</span> imageView: UIImageView!

    <span style="color:#66d9ef">override</span> <span style="color:#66d9ef">func</span> <span style="color:#a6e22e">viewDidLoad</span>() {
        <span style="color:#66d9ef">super</span>.viewDidLoad()

        <span style="color:#66d9ef">let</span> foo = OC_Foo()
        foo.foo()
        <span style="color:#75715e">// ⚠️ 注意，比较奇怪的是：</span>
        <span style="color:#75715e">// 只有当 Obj-C Framework 的 Mach-O 类型为动态库时，以下的资源才有效</span>
        imageView.image = foo.image()

        <span style="color:#66d9ef">let</span> sFoo = Swift_Foo()
        sFoo.foo()
        print(sFoo.strings())
    }
}
</code></pre></div><h3 id="aggregate-target">Aggregate Target</h3>
<p><img src="/img/2019/libraries_in_ios/11.png" alt="11"></p>
<p>关于 Aggregate Target，官方提供的可参考资料很少。老版本的 Xcode 中将其描述为「This target is used to aggregate other targets together」，即 aggregate 本身具有聚合、总计之意，而 Aggregate Target 正是用于聚合其它 Target，使得可以在 Xcode 中达到一次性构建多个 Target 的目的。比如我们这里有多个 Framework，即可使用 Aggregate Target 同时构建，但这并不会影响最终产物：</p>
<p><img src="/img/2019/libraries_in_ios/17.png" alt="17"></p>
<h2 id="cocoapods">CocoaPods</h2>
<p>iOS 开发发展的这些年，CocoaPods 是 iOS/macOS 开发的老牌搭档，用来帮助我们管理工程依赖。</p>
<h3 id="非-use_frameworks">非 use_frameworks!</h3>
<h4 id="obj-c-工程与-obj-c-pod">Obj-C 工程与 Obj-C Pod</h4>
<p>使用 <code>pod lib create oc-pod</code> 即可以创建我们的私有 Pod，资源文件的管理这里我们尝试使用两种方式：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ruby" data-lang="ruby"><span style="color:#75715e"># 将通过脚本引入（将直接把文件本身移动到主 Bundle 下）</span>
s<span style="color:#f92672">.</span>resources <span style="color:#f92672">=</span> <span style="color:#f92672">[</span><span style="color:#e6db74">&#39;oc-pod/Assets/info.json&#39;</span><span style="color:#f92672">]</span>

<span style="color:#75715e"># 将创建 oc-pod 的 Bundle（将把 Bundle 移动到主 Bundle 下），等同于 s.resources = [&#39;oc-pod/Assets/oc-pod.bundle&#39;]</span>
s<span style="color:#f92672">.</span>resource_bundles <span style="color:#f92672">=</span> {
    <span style="color:#e6db74">&#39;oc-pod&#39;</span> <span style="color:#f92672">=&gt;</span> <span style="color:#f92672">[</span><span style="color:#e6db74">&#39;oc-pod/Assets/info-bundle.json&#39;</span><span style="color:#f92672">]</span>
}
</code></pre></div><p>这里我们将放置在与 oc-demo-project-pod 同一父目录下，并将语言选择 Obj-C，随后在 oc-demo-project-pod 目录下，<code>pod init</code> 并以路径指定方式引用刚才创建的 Pod：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ruby" data-lang="ruby"><span style="color:#75715e"># Uncomment the next line to define a global platform for your project</span>
platform <span style="color:#e6db74">:ios</span>, <span style="color:#e6db74">&#39;13.0&#39;</span>

target <span style="color:#e6db74">&#39;oc-demo-project-pod&#39;</span> <span style="color:#66d9ef">do</span>
  <span style="color:#75715e"># Uncomment the next line if you&#39;re using Swift or would like to use dynamic frameworks</span>
  <span style="color:#75715e"># use_frameworks!</span>

  <span style="color:#75715e"># Pods for oc-demo-project-pod</span>
  pod <span style="color:#e6db74">&#39;oc-pod&#39;</span>, <span style="color:#e6db74">:path</span> <span style="color:#f92672">=&gt;</span> <span style="color:#e6db74">&#39;../oc-pod&#39;</span>
<span style="color:#66d9ef">end</span>

</code></pre></div><p>我们将上文已有代码放在 oc-pod 的 <code>Classes</code> 文件夹下，并将资源放在 <code>Assets</code> 文件夹下：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">➜  oc-pod git:<span style="color:#f92672">(</span>master<span style="color:#f92672">)</span> ✗ tree
.
├── oc-pod
│   ├── Assets  ➡️ 资源
│   │   ├── info-bundle.json
│   │   └── info.json
│   └── Classes ➡️ 源码
│       ├── NSObject+OC_Pod.h
│       ├── NSObject+OC_Pod.m
│       ├── ObjC_Foo.h
│       └── ObjC_Foo.m
└── oc-pod.podspec

<span style="color:#ae81ff">3</span> directories, <span style="color:#ae81ff">7</span> files

➜  oc-demo-project-pod git:<span style="color:#f92672">(</span>master<span style="color:#f92672">)</span> ✗ tree
.
├── Podfile
├── Podfile.lock
├── Pods
│   ├── Headers
│   ├── Local<span style="color:#ae81ff">\ </span>Podspecs
│   │   └── oc-pod.podspec.json
│   ├── Manifest.lock
│   ├── Pods.xcodeproj
│   └── Target<span style="color:#ae81ff">\ </span>Support<span style="color:#ae81ff">\ </span>Files
│       ├── Pods-oc-demo-project-pod
│       │   ├── Pods-oc-demo-project-pod-acknowledgements.markdown
│       │   ├── Pods-oc-demo-project-pod-acknowledgements.plist
│       │   ├── Pods-oc-demo-project-pod-dummy.m
│       │   ├── Pods-oc-demo-project-pod-resources.sh ➡️ resources 处理脚本
│       │   ├── Pods-oc-demo-project-pod.debug.xcconfig
│       │   └── Pods-oc-demo-project-pod.release.xcconfig
│       └── oc-pod
│           ├── ResourceBundle-oc-pod-oc-pod-Info.plist
│           ├── oc-pod-dummy.m
│           ├── oc-pod-prefix.pch
│           └── oc-pod.xcconfig
├── oc-demo-project-pod
├── oc-demo-project-pod.xcodeproj
└── oc-demo-project-pod.xcworkspace

<span style="color:#ae81ff">28</span> directories, <span style="color:#ae81ff">42</span> files
</code></pre></div><blockquote>
<p><strong>Tips</strong></p>
<p>CocoaPods 现在默认开启了 <code>use_frameworks!</code> 选项，即使用 Framework 方式集成，这里我们将先对其进行注释，看下非 <code>use_frameworks!</code> 的情况。</p>
</blockquote>
<p>此时 Pods 工程将在之后作为单一的静态库以 <code>.a</code> 形式集成到主工程中：</p>
<p><img src="/img/2019/libraries_in_ios/13.png" alt="13"></p>
<p>而我们定义在 Podfile 中的相关依赖如 oc-pod 将作为类似上文中 Cocoa Touch Static Library 一样的 Target 被 Pods 工程自身依赖：</p>
<p><img src="/img/2019/libraries_in_ios/12.png" alt="12"></p>
<p>Resource Bundle 或者 <code>s.dependency</code> 的子依赖将被 oc-pod 依赖：</p>
<p><img src="/img/2019/libraries_in_ios/15.png" alt="15"></p>
<p>如前文所述，<code>.a</code> 仅仅包含了编译后的代码，那么它所以依赖的资源文件将如何处理呢？我们可以看到上上图中的「[CP] Copy Pods Resoureces」执行了如下的脚本：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="color:#75715e">#!/bin/sh
</span><span style="color:#75715e"></span>set -e
set -u
set -o pipefail <span style="color:#75715e"># 一些设置</span>

<span style="color:#75715e"># 错误处理</span>
<span style="color:#66d9ef">function</span> on_error <span style="color:#f92672">{</span>
  echo <span style="color:#e6db74">&#34;</span><span style="color:#66d9ef">$(</span>realpath -mq <span style="color:#e6db74">&#34;</span><span style="color:#e6db74">${</span>0<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span><span style="color:#66d9ef">)</span><span style="color:#e6db74">:</span>$1<span style="color:#e6db74">: error: Unexpected failure&#34;</span>
<span style="color:#f92672">}</span>
trap <span style="color:#e6db74">&#39;on_error $LINENO&#39;</span> ERR

<span style="color:#75715e"># if [ -z STRING ]; 如果字符串 STRING 长度为 0 则为真</span>
<span style="color:#75715e"># UNLOCALIZED_RESOURCES_FOLDER_PATH（未本地化资源路径，app 包）：oc-demo-project-pod.app</span>
<span style="color:#66d9ef">if</span> <span style="color:#f92672">[</span> -z <span style="color:#e6db74">${</span>UNLOCALIZED_RESOURCES_FOLDER_PATH+x<span style="color:#e6db74">}</span> <span style="color:#f92672">]</span>; <span style="color:#66d9ef">then</span>
  <span style="color:#75715e"># If UNLOCALIZED_RESOURCES_FOLDER_PATH is not set, then there&#39;s nowhere for us to copy</span>
  <span style="color:#75715e"># resources to, so exit 0 (signalling the script phase was successful).</span>
  <span style="color:#75715e"># 若 UNLOCALIZED_RESOURCES_FOLDER_PATH 未设置，则无需拷贝资源并退出</span>
  exit <span style="color:#ae81ff">0</span>
<span style="color:#66d9ef">fi</span>

<span style="color:#75715e"># TARGET_BUILD_DIR（目标构建目录）：/Users/kingcos/Library/Developer/Xcode/DerivedData/oc-demo-project-pod-fvrppqpxzudpvicewkjnbszgmrll/Build/Products/Debug-iphonesimulator</span>
<span style="color:#75715e"># 递归创建 .app 路径</span>
mkdir -p <span style="color:#e6db74">&#34;</span><span style="color:#e6db74">${</span>TARGET_BUILD_DIR<span style="color:#e6db74">}</span><span style="color:#e6db74">/</span><span style="color:#e6db74">${</span>UNLOCALIZED_RESOURCES_FOLDER_PATH<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>

<span style="color:#75715e"># RESOURCES_TO_COPY（欲拷贝资源记录临时文件）：oc-demo-project-pod/Pods/resources-to-copy-oc-demo-project-pod.txt</span>
RESOURCES_TO_COPY<span style="color:#f92672">=</span><span style="color:#e6db74">${</span>PODS_ROOT<span style="color:#e6db74">}</span>/resources-to-copy-<span style="color:#e6db74">${</span>TARGETNAME<span style="color:#e6db74">}</span>.txt
<span style="color:#75715e"># 创建该文件</span>
&gt; <span style="color:#e6db74">&#34;</span>$RESOURCES_TO_COPY<span style="color:#e6db74">&#34;</span>

XCASSET_FILES<span style="color:#f92672">=()</span>

<span style="color:#75715e"># 防止多个 target 同时拷贝相同的框架依赖</span>
<span style="color:#75715e"># This protects against multiple targets copying the same framework dependency at the same time. The solution</span>
<span style="color:#75715e"># was originally proposed here: https://lists.samba.org/archive/rsync/2008-February/020158.html</span>
<span style="color:#75715e"># RSYNC_PROTECT_TMP_FILES --filter</span>
RSYNC_PROTECT_TMP_FILES<span style="color:#f92672">=(</span>--filter <span style="color:#e6db74">&#34;P .*.??????&#34;</span><span style="color:#f92672">)</span>

<span style="color:#75715e"># TARGETED_DEVICE_FAMILY（目标设备家族）：1,2（iPhone &amp; iPad）</span>
<span style="color:#66d9ef">case</span> <span style="color:#e6db74">&#34;</span><span style="color:#e6db74">${</span>TARGETED_DEVICE_FAMILY<span style="color:#66d9ef">:-</span><span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span> in
  1,2<span style="color:#f92672">)</span>
    TARGET_DEVICE_ARGS<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;--target-device ipad --target-device iphone&#34;</span>
    ;;
  1<span style="color:#f92672">)</span>
    TARGET_DEVICE_ARGS<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;--target-device iphone&#34;</span>
    ;;
  2<span style="color:#f92672">)</span>
    TARGET_DEVICE_ARGS<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;--target-device ipad&#34;</span>
    ;;
  3<span style="color:#f92672">)</span>
    TARGET_DEVICE_ARGS<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;--target-device tv&#34;</span>
    ;;
  4<span style="color:#f92672">)</span>
    TARGET_DEVICE_ARGS<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;--target-device watch&#34;</span>
    ;;
  *<span style="color:#f92672">)</span>
    TARGET_DEVICE_ARGS<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;--target-device mac&#34;</span>
    ;;
<span style="color:#66d9ef">esac</span>
<span style="color:#75715e"># TARGET_DEVICE_ARGS（目标设备参数）：--target-device ipad --target-device iphone（默认）</span>

<span style="color:#75715e"># 安装资源函数</span>
install_resource<span style="color:#f92672">()</span>
<span style="color:#f92672">{</span>
  <span style="color:#75715e"># 判断是否是根路径（第一个参数开头有无 /），非根路径则添加 Pods 根路径</span>
  <span style="color:#66d9ef">if</span> <span style="color:#f92672">[[</span> <span style="color:#e6db74">&#34;</span>$1<span style="color:#e6db74">&#34;</span> <span style="color:#f92672">=</span> /* <span style="color:#f92672">]]</span> ; <span style="color:#66d9ef">then</span>
    RESOURCE_PATH<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;</span>$1<span style="color:#e6db74">&#34;</span>
  <span style="color:#66d9ef">else</span>
    RESOURCE_PATH<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">${</span>PODS_ROOT<span style="color:#e6db74">}</span><span style="color:#e6db74">/</span>$1<span style="color:#e6db74">&#34;</span>
  <span style="color:#66d9ef">fi</span>

  <span style="color:#75715e"># RESOURCE_PATH（资源路径）</span>
  <span style="color:#75715e"># PATH/TO/libraries_in_ios-demo/oc-demo-project-pod/Pods/../../oc-pod/oc-pod/Assets/info.json</span>
  <span style="color:#75715e"># /Users/kingcos/Library/Developer/Xcode/DerivedData/oc-demo-project-pod-aaokquikwvguhaglfagfimosuecy/Build/Products/Debug-iphonesimulator/oc-pod/oc-pod.bundle</span>
  <span style="color:#75715e"># PATH/TO/libraries_in_ios-demo/oc-demo-project-pod/Pods/../../swift-pod/swift-pod/Assets/Localizable.strings</span>
  <span style="color:#75715e"># 若资源路径不存在则提示并退出</span>
  <span style="color:#66d9ef">if</span> <span style="color:#f92672">[[</span> ! -e <span style="color:#e6db74">&#34;</span>$RESOURCE_PATH<span style="color:#e6db74">&#34;</span> <span style="color:#f92672">]]</span> ; <span style="color:#66d9ef">then</span>
    cat <span style="color:#e6db74">&lt;&lt; EOM
</span><span style="color:#e6db74">error: Resource &#34;$RESOURCE_PATH&#34; not found. Run &#39;pod install&#39; to update the copy resources script.
</span><span style="color:#e6db74">EOM</span>
    exit <span style="color:#ae81ff">1</span>
  <span style="color:#66d9ef">fi</span>
  <span style="color:#66d9ef">case</span> $RESOURCE_PATH in
    <span style="color:#75715e"># storyboard 资源：编译为 storyboardc</span>
    *.storyboard<span style="color:#f92672">)</span>
      echo <span style="color:#e6db74">&#34;ibtool --reference-external-strings-file --errors --warnings --notices --minimum-deployment-target </span><span style="color:#e6db74">${</span>!DEPLOYMENT_TARGET_SETTING_NAME<span style="color:#e6db74">}</span><span style="color:#e6db74"> --output-format human-readable-text --compile </span><span style="color:#e6db74">${</span>TARGET_BUILD_DIR<span style="color:#e6db74">}</span><span style="color:#e6db74">/</span><span style="color:#e6db74">${</span>UNLOCALIZED_RESOURCES_FOLDER_PATH<span style="color:#e6db74">}</span><span style="color:#e6db74">/`basename \&#34;</span>$RESOURCE_PATH<span style="color:#e6db74">\&#34; .storyboard`.storyboardc </span>$RESOURCE_PATH<span style="color:#e6db74"> --sdk </span><span style="color:#e6db74">${</span>SDKROOT<span style="color:#e6db74">}</span><span style="color:#e6db74"> </span><span style="color:#e6db74">${</span>TARGET_DEVICE_ARGS<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span> <span style="color:#f92672">||</span> true
      ibtool --reference-external-strings-file --errors --warnings --notices --minimum-deployment-target <span style="color:#e6db74">${</span>!DEPLOYMENT_TARGET_SETTING_NAME<span style="color:#e6db74">}</span> --output-format human-readable-text --compile <span style="color:#e6db74">&#34;</span><span style="color:#e6db74">${</span>TARGET_BUILD_DIR<span style="color:#e6db74">}</span><span style="color:#e6db74">/</span><span style="color:#e6db74">${</span>UNLOCALIZED_RESOURCES_FOLDER_PATH<span style="color:#e6db74">}</span><span style="color:#e6db74">/`basename \&#34;</span>$RESOURCE_PATH<span style="color:#e6db74">\&#34; .storyboard`.storyboardc&#34;</span> <span style="color:#e6db74">&#34;</span>$RESOURCE_PATH<span style="color:#e6db74">&#34;</span> --sdk <span style="color:#e6db74">&#34;</span><span style="color:#e6db74">${</span>SDKROOT<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span> <span style="color:#e6db74">${</span>TARGET_DEVICE_ARGS<span style="color:#e6db74">}</span>
      ;;
    <span style="color:#75715e"># xib 资源：编译为 nib</span>
    *.xib<span style="color:#f92672">)</span>
      echo <span style="color:#e6db74">&#34;ibtool --reference-external-strings-file --errors --warnings --notices --minimum-deployment-target </span><span style="color:#e6db74">${</span>!DEPLOYMENT_TARGET_SETTING_NAME<span style="color:#e6db74">}</span><span style="color:#e6db74"> --output-format human-readable-text --compile </span><span style="color:#e6db74">${</span>TARGET_BUILD_DIR<span style="color:#e6db74">}</span><span style="color:#e6db74">/</span><span style="color:#e6db74">${</span>UNLOCALIZED_RESOURCES_FOLDER_PATH<span style="color:#e6db74">}</span><span style="color:#e6db74">/`basename \&#34;</span>$RESOURCE_PATH<span style="color:#e6db74">\&#34; .xib`.nib </span>$RESOURCE_PATH<span style="color:#e6db74"> --sdk </span><span style="color:#e6db74">${</span>SDKROOT<span style="color:#e6db74">}</span><span style="color:#e6db74"> </span><span style="color:#e6db74">${</span>TARGET_DEVICE_ARGS<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span> <span style="color:#f92672">||</span> true
      ibtool --reference-external-strings-file --errors --warnings --notices --minimum-deployment-target <span style="color:#e6db74">${</span>!DEPLOYMENT_TARGET_SETTING_NAME<span style="color:#e6db74">}</span> --output-format human-readable-text --compile <span style="color:#e6db74">&#34;</span><span style="color:#e6db74">${</span>TARGET_BUILD_DIR<span style="color:#e6db74">}</span><span style="color:#e6db74">/</span><span style="color:#e6db74">${</span>UNLOCALIZED_RESOURCES_FOLDER_PATH<span style="color:#e6db74">}</span><span style="color:#e6db74">/`basename \&#34;</span>$RESOURCE_PATH<span style="color:#e6db74">\&#34; .xib`.nib&#34;</span> <span style="color:#e6db74">&#34;</span>$RESOURCE_PATH<span style="color:#e6db74">&#34;</span> --sdk <span style="color:#e6db74">&#34;</span><span style="color:#e6db74">${</span>SDKROOT<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span> <span style="color:#e6db74">${</span>TARGET_DEVICE_ARGS<span style="color:#e6db74">}</span>
      ;;
    *.framework<span style="color:#f92672">)</span>
      echo <span style="color:#e6db74">&#34;mkdir -p </span><span style="color:#e6db74">${</span>TARGET_BUILD_DIR<span style="color:#e6db74">}</span><span style="color:#e6db74">/</span><span style="color:#e6db74">${</span>FRAMEWORKS_FOLDER_PATH<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span> <span style="color:#f92672">||</span> true
      mkdir -p <span style="color:#e6db74">&#34;</span><span style="color:#e6db74">${</span>TARGET_BUILD_DIR<span style="color:#e6db74">}</span><span style="color:#e6db74">/</span><span style="color:#e6db74">${</span>FRAMEWORKS_FOLDER_PATH<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>
      echo <span style="color:#e6db74">&#34;rsync --delete -av &#34;</span><span style="color:#e6db74">${</span>RSYNC_PROTECT_TMP_FILES[@]<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34; </span>$RESOURCE_PATH<span style="color:#e6db74"> </span><span style="color:#e6db74">${</span>TARGET_BUILD_DIR<span style="color:#e6db74">}</span><span style="color:#e6db74">/</span><span style="color:#e6db74">${</span>FRAMEWORKS_FOLDER_PATH<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span> <span style="color:#f92672">||</span> true
      rsync --delete -av <span style="color:#e6db74">&#34;</span><span style="color:#e6db74">${</span>RSYNC_PROTECT_TMP_FILES[@]<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span> <span style="color:#e6db74">&#34;</span>$RESOURCE_PATH<span style="color:#e6db74">&#34;</span> <span style="color:#e6db74">&#34;</span><span style="color:#e6db74">${</span>TARGET_BUILD_DIR<span style="color:#e6db74">}</span><span style="color:#e6db74">/</span><span style="color:#e6db74">${</span>FRAMEWORKS_FOLDER_PATH<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>
      ;;
    *.xcdatamodel<span style="color:#f92672">)</span>
      echo <span style="color:#e6db74">&#34;xcrun momc \&#34;</span>$RESOURCE_PATH<span style="color:#e6db74">\&#34; \&#34;</span><span style="color:#e6db74">${</span>TARGET_BUILD_DIR<span style="color:#e6db74">}</span><span style="color:#e6db74">/</span><span style="color:#e6db74">${</span>UNLOCALIZED_RESOURCES_FOLDER_PATH<span style="color:#e6db74">}</span><span style="color:#e6db74">/`basename &#34;</span>$RESOURCE_PATH<span style="color:#e6db74">&#34;`.mom\&#34;&#34;</span> <span style="color:#f92672">||</span> true
      xcrun momc <span style="color:#e6db74">&#34;</span>$RESOURCE_PATH<span style="color:#e6db74">&#34;</span> <span style="color:#e6db74">&#34;</span><span style="color:#e6db74">${</span>TARGET_BUILD_DIR<span style="color:#e6db74">}</span><span style="color:#e6db74">/</span><span style="color:#e6db74">${</span>UNLOCALIZED_RESOURCES_FOLDER_PATH<span style="color:#e6db74">}</span><span style="color:#e6db74">/`basename &#34;</span>$RESOURCE_PATH<span style="color:#e6db74">&#34; .xcdatamodel`.mom&#34;</span>
      ;;
    *.xcdatamodeld<span style="color:#f92672">)</span>
      echo <span style="color:#e6db74">&#34;xcrun momc \&#34;</span>$RESOURCE_PATH<span style="color:#e6db74">\&#34; \&#34;</span><span style="color:#e6db74">${</span>TARGET_BUILD_DIR<span style="color:#e6db74">}</span><span style="color:#e6db74">/</span><span style="color:#e6db74">${</span>UNLOCALIZED_RESOURCES_FOLDER_PATH<span style="color:#e6db74">}</span><span style="color:#e6db74">/`basename &#34;</span>$RESOURCE_PATH<span style="color:#e6db74">&#34; .xcdatamodeld`.momd\&#34;&#34;</span> <span style="color:#f92672">||</span> true
      xcrun momc <span style="color:#e6db74">&#34;</span>$RESOURCE_PATH<span style="color:#e6db74">&#34;</span> <span style="color:#e6db74">&#34;</span><span style="color:#e6db74">${</span>TARGET_BUILD_DIR<span style="color:#e6db74">}</span><span style="color:#e6db74">/</span><span style="color:#e6db74">${</span>UNLOCALIZED_RESOURCES_FOLDER_PATH<span style="color:#e6db74">}</span><span style="color:#e6db74">/`basename &#34;</span>$RESOURCE_PATH<span style="color:#e6db74">&#34; .xcdatamodeld`.momd&#34;</span>
      ;;
    *.xcmappingmodel<span style="color:#f92672">)</span>
      echo <span style="color:#e6db74">&#34;xcrun mapc \&#34;</span>$RESOURCE_PATH<span style="color:#e6db74">\&#34; \&#34;</span><span style="color:#e6db74">${</span>TARGET_BUILD_DIR<span style="color:#e6db74">}</span><span style="color:#e6db74">/</span><span style="color:#e6db74">${</span>UNLOCALIZED_RESOURCES_FOLDER_PATH<span style="color:#e6db74">}</span><span style="color:#e6db74">/`basename &#34;</span>$RESOURCE_PATH<span style="color:#e6db74">&#34; .xcmappingmodel`.cdm\&#34;&#34;</span> <span style="color:#f92672">||</span> true
      xcrun mapc <span style="color:#e6db74">&#34;</span>$RESOURCE_PATH<span style="color:#e6db74">&#34;</span> <span style="color:#e6db74">&#34;</span><span style="color:#e6db74">${</span>TARGET_BUILD_DIR<span style="color:#e6db74">}</span><span style="color:#e6db74">/</span><span style="color:#e6db74">${</span>UNLOCALIZED_RESOURCES_FOLDER_PATH<span style="color:#e6db74">}</span><span style="color:#e6db74">/`basename &#34;</span>$RESOURCE_PATH<span style="color:#e6db74">&#34; .xcmappingmodel`.cdm&#34;</span>
      ;;
    *.xcassets<span style="color:#f92672">)</span>
      ABSOLUTE_XCASSET_FILE<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;</span>$RESOURCE_PATH<span style="color:#e6db74">&#34;</span>
      XCASSET_FILES<span style="color:#f92672">+=(</span><span style="color:#e6db74">&#34;</span>$ABSOLUTE_XCASSET_FILE<span style="color:#e6db74">&#34;</span><span style="color:#f92672">)</span>
      ;;
    <span style="color:#75715e"># 其它，比如 bundle / json</span>
    *<span style="color:#f92672">)</span>
      echo <span style="color:#e6db74">&#34;</span>$RESOURCE_PATH<span style="color:#e6db74">&#34;</span> <span style="color:#f92672">||</span> true
      <span style="color:#75715e"># 将资源路径写入欲拷贝资源记录临时文件中</span>
      echo <span style="color:#e6db74">&#34;</span>$RESOURCE_PATH<span style="color:#e6db74">&#34;</span> &gt;&gt; <span style="color:#e6db74">&#34;</span>$RESOURCES_TO_COPY<span style="color:#e6db74">&#34;</span>
      ;;
  <span style="color:#66d9ef">esac</span>
<span style="color:#f92672">}</span>

<span style="color:#75715e"># CONFIGURATION：运行的 scheme 配置模式，Debug 或 Release</span>
<span style="color:#75715e"># 目前 Debug 和 Release 模式处理一致</span>
<span style="color:#66d9ef">if</span> <span style="color:#f92672">[[</span> <span style="color:#e6db74">&#34;</span>$CONFIGURATION<span style="color:#e6db74">&#34;</span> <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;Debug&#34;</span> <span style="color:#f92672">]]</span>; <span style="color:#66d9ef">then</span>
  install_resource <span style="color:#e6db74">&#34;</span><span style="color:#e6db74">${</span>PODS_ROOT<span style="color:#e6db74">}</span><span style="color:#e6db74">/../../oc-pod/oc-pod/Assets/info.json&#34;</span>
  install_resource <span style="color:#e6db74">&#34;</span><span style="color:#e6db74">${</span>PODS_CONFIGURATION_BUILD_DIR<span style="color:#e6db74">}</span><span style="color:#e6db74">/oc-pod/oc-pod.bundle&#34;</span>
  install_resource <span style="color:#e6db74">&#34;</span><span style="color:#e6db74">${</span>PODS_ROOT<span style="color:#e6db74">}</span><span style="color:#e6db74">/../../swift-pod/swift-pod/Assets/Localizable.strings&#34;</span>
<span style="color:#66d9ef">fi</span>
<span style="color:#66d9ef">if</span> <span style="color:#f92672">[[</span> <span style="color:#e6db74">&#34;</span>$CONFIGURATION<span style="color:#e6db74">&#34;</span> <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;Release&#34;</span> <span style="color:#f92672">]]</span>; <span style="color:#66d9ef">then</span>
  install_resource <span style="color:#e6db74">&#34;</span><span style="color:#e6db74">${</span>PODS_ROOT<span style="color:#e6db74">}</span><span style="color:#e6db74">/../../oc-pod/oc-pod/Assets/info.json&#34;</span>
  install_resource <span style="color:#e6db74">&#34;</span><span style="color:#e6db74">${</span>PODS_CONFIGURATION_BUILD_DIR<span style="color:#e6db74">}</span><span style="color:#e6db74">/oc-pod/oc-pod.bundle&#34;</span>
  install_resource <span style="color:#e6db74">&#34;</span><span style="color:#e6db74">${</span>PODS_ROOT<span style="color:#e6db74">}</span><span style="color:#e6db74">/../../swift-pod/swift-pod/Assets/Localizable.strings&#34;</span>
<span style="color:#66d9ef">fi</span>

<span style="color:#75715e"># 再次尝试确保同一文件夹创建</span>
mkdir -p <span style="color:#e6db74">&#34;</span><span style="color:#e6db74">${</span>TARGET_BUILD_DIR<span style="color:#e6db74">}</span><span style="color:#e6db74">/</span><span style="color:#e6db74">${</span>UNLOCALIZED_RESOURCES_FOLDER_PATH<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>

<span style="color:#75715e"># rsync：快速、多功能、远程（和本地）文件复制工具，-a：保留所有；-v：输出信息；-r：递归；</span>
<span style="color:#75715e"># --copy-links：当遇到符号链接时，指向的项目（引用）被复制，而不是符号链接；</span>
<span style="color:#75715e"># --no-relative：非相对路径，即绝对路径</span>
<span style="color:#75715e"># --exclude：排除某个模式的目录</span>
<span style="color:#75715e"># --files-from：文件来源</span>
<span style="color:#75715e"># /：文件目的</span>
rsync -avr --copy-links --no-relative --exclude <span style="color:#e6db74">&#39;*/.svn/*&#39;</span> --files-from<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;</span>$RESOURCES_TO_COPY<span style="color:#e6db74">&#34;</span> / <span style="color:#e6db74">&#34;</span><span style="color:#e6db74">${</span>TARGET_BUILD_DIR<span style="color:#e6db74">}</span><span style="color:#e6db74">/</span><span style="color:#e6db74">${</span>UNLOCALIZED_RESOURCES_FOLDER_PATH<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>

<span style="color:#75715e"># ACTION（行为）：构建即 build，不太清楚何时为 install</span>
<span style="color:#75715e"># SKIP_INSTALL（是否跳过安装）：否为 NO</span>
<span style="color:#66d9ef">if</span> <span style="color:#f92672">[[</span> <span style="color:#e6db74">&#34;</span><span style="color:#e6db74">${</span>ACTION<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span> <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;install&#34;</span> <span style="color:#f92672">]]</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#f92672">[[</span> <span style="color:#e6db74">&#34;</span><span style="color:#e6db74">${</span>SKIP_INSTALL<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span> <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;NO&#34;</span> <span style="color:#f92672">]]</span>; <span style="color:#66d9ef">then</span>
  mkdir -p <span style="color:#e6db74">&#34;</span><span style="color:#e6db74">${</span>INSTALL_DIR<span style="color:#e6db74">}</span><span style="color:#e6db74">/</span><span style="color:#e6db74">${</span>UNLOCALIZED_RESOURCES_FOLDER_PATH<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>
  rsync -avr --copy-links --no-relative --exclude <span style="color:#e6db74">&#39;*/.svn/*&#39;</span> --files-from<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;</span>$RESOURCES_TO_COPY<span style="color:#e6db74">&#34;</span> / <span style="color:#e6db74">&#34;</span><span style="color:#e6db74">${</span>INSTALL_DIR<span style="color:#e6db74">}</span><span style="color:#e6db74">/</span><span style="color:#e6db74">${</span>UNLOCALIZED_RESOURCES_FOLDER_PATH<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>
<span style="color:#66d9ef">fi</span>

<span style="color:#75715e"># 删除存储资源路径的临时文件</span>
rm -f <span style="color:#e6db74">&#34;</span>$RESOURCES_TO_COPY<span style="color:#e6db74">&#34;</span>

<span style="color:#75715e"># WRAPPER_EXTENSION（扩展）：app</span>
<span style="color:#66d9ef">if</span> <span style="color:#f92672">[[</span> -n <span style="color:#e6db74">&#34;</span><span style="color:#e6db74">${</span>WRAPPER_EXTENSION<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span> <span style="color:#f92672">]]</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#f92672">[</span> <span style="color:#e6db74">&#34;`xcrun --find actool`&#34;</span> <span style="color:#f92672">]</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#f92672">[</span> -n <span style="color:#e6db74">&#34;</span><span style="color:#e6db74">${</span>XCASSET_FILES<span style="color:#66d9ef">:-</span><span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span> <span style="color:#f92672">]</span>
<span style="color:#66d9ef">then</span>
  <span style="color:#75715e"># Find all other xcassets (this unfortunately includes those of path pods and other targets).</span>
  <span style="color:#75715e"># 查找其他所有 xcassets</span>
  OTHER_XCASSETS<span style="color:#f92672">=</span><span style="color:#66d9ef">$(</span>find <span style="color:#e6db74">&#34;</span>$PWD<span style="color:#e6db74">&#34;</span> -iname <span style="color:#e6db74">&#34;*.xcassets&#34;</span> -type d<span style="color:#66d9ef">)</span>
  <span style="color:#66d9ef">while</span> read line; <span style="color:#66d9ef">do</span>
    <span style="color:#66d9ef">if</span> <span style="color:#f92672">[[</span> $line !<span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;</span><span style="color:#e6db74">${</span>PODS_ROOT<span style="color:#e6db74">}</span><span style="color:#e6db74">*&#34;</span> <span style="color:#f92672">]]</span>; <span style="color:#66d9ef">then</span>
      XCASSET_FILES<span style="color:#f92672">+=(</span><span style="color:#e6db74">&#34;</span>$line<span style="color:#e6db74">&#34;</span><span style="color:#f92672">)</span>
    <span style="color:#66d9ef">fi</span>
  <span style="color:#66d9ef">done</span> <span style="color:#f92672">&lt;&lt;&lt;</span><span style="color:#e6db74">&#34;</span>$OTHER_XCASSETS<span style="color:#e6db74">&#34;</span>

  <span style="color:#66d9ef">if</span> <span style="color:#f92672">[</span> -z <span style="color:#e6db74">${</span>ASSETCATALOG_COMPILER_APPICON_NAME+x<span style="color:#e6db74">}</span> <span style="color:#f92672">]</span>; <span style="color:#66d9ef">then</span>
    printf <span style="color:#e6db74">&#34;%s\0&#34;</span> <span style="color:#e6db74">&#34;</span><span style="color:#e6db74">${</span>XCASSET_FILES[@]<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span> | xargs -0 xcrun actool --output-format human-readable-text --notices --warnings --platform <span style="color:#e6db74">&#34;</span><span style="color:#e6db74">${</span>PLATFORM_NAME<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span> --minimum-deployment-target <span style="color:#e6db74">&#34;</span><span style="color:#e6db74">${</span>!DEPLOYMENT_TARGET_SETTING_NAME<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span> <span style="color:#e6db74">${</span>TARGET_DEVICE_ARGS<span style="color:#e6db74">}</span> --compress-pngs --compile <span style="color:#e6db74">&#34;</span><span style="color:#e6db74">${</span>BUILT_PRODUCTS_DIR<span style="color:#e6db74">}</span><span style="color:#e6db74">/</span><span style="color:#e6db74">${</span>UNLOCALIZED_RESOURCES_FOLDER_PATH<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>
  <span style="color:#66d9ef">else</span>
    printf <span style="color:#e6db74">&#34;%s\0&#34;</span> <span style="color:#e6db74">&#34;</span><span style="color:#e6db74">${</span>XCASSET_FILES[@]<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span> | xargs -0 xcrun actool --output-format human-readable-text --notices --warnings --platform <span style="color:#e6db74">&#34;</span><span style="color:#e6db74">${</span>PLATFORM_NAME<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span> --minimum-deployment-target <span style="color:#e6db74">&#34;</span><span style="color:#e6db74">${</span>!DEPLOYMENT_TARGET_SETTING_NAME<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span> <span style="color:#e6db74">${</span>TARGET_DEVICE_ARGS<span style="color:#e6db74">}</span> --compress-pngs --compile <span style="color:#e6db74">&#34;</span><span style="color:#e6db74">${</span>BUILT_PRODUCTS_DIR<span style="color:#e6db74">}</span><span style="color:#e6db74">/</span><span style="color:#e6db74">${</span>UNLOCALIZED_RESOURCES_FOLDER_PATH<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span> --app-icon <span style="color:#e6db74">&#34;</span><span style="color:#e6db74">${</span>ASSETCATALOG_COMPILER_APPICON_NAME<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span> --output-partial-info-plist <span style="color:#e6db74">&#34;</span><span style="color:#e6db74">${</span>TARGET_TEMP_DIR<span style="color:#e6db74">}</span><span style="color:#e6db74">/assetcatalog_generated_info_cocoapods.plist&#34;</span>
  <span style="color:#66d9ef">fi</span>
<span style="color:#66d9ef">fi</span>
</code></pre></div><p>因此最终的 <code>oc-demo-project-pod.app</code> 结构如下：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">➜  oc-demo-project-pod.app tree
.
├── Base.lproj
│   ├── LaunchScreen.storyboardc
│   │   ├── 01J-lp-oVM-view-Ze5-6b-2t3.nib
│   │   ├── Info.plist
│   │   └── UIViewController-01J-lp-oVM.nib
│   └── Main.storyboardc
│       ├── BYZ-38-t0r-view-8bC-Xf-vdC.nib
│       ├── Info.plist
│       └── UIViewController-BYZ-38-t0r.nib
├── Info.plist
├── PkgInfo
├── _CodeSignature
│   └── CodeResources
├── info.json  ➡️ 脚本拷贝（s.resources）至此
├── oc-demo-project-pod ➡️ 可执行 Mach-O 文件
└── oc-pod.bundle ➡️ 脚本拷贝（s.resource_bundles）至此
    ├── Info.plist
    ├── _CodeSignature
    │   ├── CodeDirectory
    │   ├── CodeRequirements
    │   ├── CodeRequirements-1
    │   ├── CodeResources
    │   └── CodeSignature
    ├── info-bundle.json
    └── oc-pod.json

<span style="color:#ae81ff">6</span> directories, <span style="color:#ae81ff">19</span> files
</code></pre></div><p>资源文件 Bundle 以及 JSON 文件被原封不动地挪动到 <code>oc-demo-project-pod.app</code> 下，而第三方和 Pods 中介的 <code>.a</code> 就已经被打入了可执行文件中，我们可以使用 <code>nm</code> 尝试打印其中的符号：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">➜  oc-demo-project-pod.app nm oc-demo-project-pod | grep ObjC_Foo
0000000100038a50 t -<span style="color:#f92672">[</span>ObjC_Foo foo<span style="color:#f92672">]</span>
0000000100038b00 t -<span style="color:#f92672">[</span>ObjC_Foo resources<span style="color:#f92672">]</span>
<span style="color:#ae81ff">0000000100053220</span> S _OBJC_CLASS_$_ObjC_Foo
00000001000531f8 S _OBJC_METACLASS_$_ObjC_Foo

➜  oc-demo-project-pod.app nm oc-demo-project-pod | grep Pods
0000000100052b90 S _OBJC_CLASS_$_PodsDummy_AFNetworking
00000001000532c0 S _OBJC_CLASS_$_PodsDummy_Pods_oc_demo_project_pod
<span style="color:#ae81ff">0000000100053270</span> S _OBJC_CLASS_$_PodsDummy_oc_pod
0000000100052b68 S _OBJC_METACLASS_$_PodsDummy_AFNetworking
<span style="color:#ae81ff">0000000100053298</span> S _OBJC_METACLASS_$_PodsDummy_Pods_oc_demo_project_pod
<span style="color:#ae81ff">0000000100053248</span> S _OBJC_METACLASS_$_PodsDummy_oc_pod
</code></pre></div><p>虽然资源均被拷贝到了 <code>.app</code> 下，但在代码中相应的获取方式却有一定差别：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-objectivec" data-lang="objectivec">- (<span style="color:#66d9ef">void</span>)<span style="color:#a6e22e">resources</span> {
    <span style="color:#75715e">// s.resources
</span><span style="color:#75715e"></span>    NSBundle <span style="color:#f92672">*</span>bundle <span style="color:#f92672">=</span> [NSBundle bundleForClass:[self <span style="color:#66d9ef">class</span>]];
    NSString <span style="color:#f92672">*</span>path <span style="color:#f92672">=</span> [bundle pathForResource:<span style="color:#e6db74">@&#34;info&#34;</span> ofType:<span style="color:#e6db74">@&#34;json&#34;</span>];
    NSData <span style="color:#f92672">*</span>data <span style="color:#f92672">=</span> [NSData dataWithContentsOfFile:path];

    <span style="color:#66d9ef">if</span> (data) {
        NSDictionary <span style="color:#f92672">*</span>dict <span style="color:#f92672">=</span> [NSJSONSerialization JSONObjectWithData:data options:NSJSONReadingMutableContainers error:nil];
        NSLog(<span style="color:#e6db74">@&#34;%@ - %@&#34;</span>, dict[<span style="color:#e6db74">@&#34;blog&#34;</span>], dict[<span style="color:#e6db74">@&#34;github&#34;</span>]);
    }

    <span style="color:#75715e">// s.resource_bundles
</span><span style="color:#75715e"></span>    NSBundle <span style="color:#f92672">*</span>bundle2 <span style="color:#f92672">=</span> [NSBundle bundleWithPath:[[NSBundle mainBundle] pathForResource:<span style="color:#e6db74">@&#34;oc-pod&#34;</span> ofType:<span style="color:#e6db74">@&#34;bundle&#34;</span>]];
    NSString <span style="color:#f92672">*</span>path2 <span style="color:#f92672">=</span> [bundle2 pathForResource:<span style="color:#e6db74">@&#34;oc-pod&#34;</span> ofType:<span style="color:#e6db74">@&#34;json&#34;</span>];
    NSData <span style="color:#f92672">*</span>data2 <span style="color:#f92672">=</span> [NSData dataWithContentsOfFile:path2];

    <span style="color:#66d9ef">if</span> (data2) {
        NSDictionary <span style="color:#f92672">*</span>dict <span style="color:#f92672">=</span> [NSJSONSerialization JSONObjectWithData:data options:NSJSONReadingMutableContainers error:nil];
        NSLog(<span style="color:#e6db74">@&#34;%@ - %@&#34;</span>, dict[<span style="color:#e6db74">@&#34;blog&#34;</span>], dict[<span style="color:#e6db74">@&#34;github&#34;</span>]);
    }
}
</code></pre></div><h4 id="obj-c-工程与-swift-pod">Obj-C 工程与 Swift Pod</h4>
<p>在 Obj-C 工程下引入 Swift Pod 与 Obj-C Pod 并无太多差别。不过有时可能会遇到 CocoaPods 提示下面这个问题，或者在编译时提示找不到许多 Swift 相关的符号：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="color:#f92672">[</span>!<span style="color:#f92672">]</span> Unable to determine Swift version <span style="color:#66d9ef">for</span> the following pods:

- <span style="color:#e6db74">`</span>swift-pod<span style="color:#e6db74">`</span> does not specify a Swift version and none of the targets <span style="color:#f92672">(</span><span style="color:#e6db74">`</span>oc-demo-project-pod<span style="color:#e6db74">`</span><span style="color:#f92672">)</span> integrating it have the <span style="color:#e6db74">`</span>SWIFT_VERSION<span style="color:#e6db74">`</span> attribute set. Please contact the author or set the <span style="color:#e6db74">`</span>SWIFT_VERSION<span style="color:#e6db74">`</span> attribute in at least one of the targets that integrate this pod.
</code></pre></div><p>此时我们可以在 Obj-C 工程中新建一个占位 Swift 文件即可使其获得 Swift 能力：</p>
<p><img src="/img/2019/libraries_in_ios/14.png" alt="14"></p>
<p>另外需要注意的是，Swift Pod 引入时需要使用 <code>@import</code>：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-objectivec" data-lang="objectivec">@import swift_pod;

<span style="color:#66d9ef">@implementation</span> <span style="color:#a6e22e">ViewController</span>
- (<span style="color:#66d9ef">void</span>)<span style="color:#a6e22e">viewDidLoad</span> {
    [super viewDidLoad];

    [[[Swift_Foo alloc] init] foo];
    NSLog(<span style="color:#e6db74">@&#34;%@&#34;</span>, [[[Swift_Foo alloc] init] strings]);
}
<span style="color:#66d9ef">@end</span>
</code></pre></div><h4 id="swift-工程与-obj-c-pod">Swift 工程与 Obj-C Pod</h4>
<p>Swift 工程依赖 Obj-C Pod 的方式与 Obj-C 工程一致。但需要注意的是，我们无法直接在 Swift 代码中 <code>import</code> Obj-C Pod。这里也需要桥接文件来引入，我们可以创建 Obj-C 类型的占位文件，并创建桥接文件，在其中引入暴露给 Swift 工程的头文件：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-objectivec" data-lang="objectivec"><span style="color:#75715e">//
</span><span style="color:#75715e">//  Use this file to import your target&#39;s public headers that you would like to expose to Swift.
</span><span style="color:#75715e">//
</span><span style="color:#75715e"></span>
<span style="color:#75715e">#import &lt;oc-pod/ObjC_Foo.h&gt;
</span></code></pre></div><p>这样即可在 Swift 工程中使用：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-swift" data-lang="swift"><span style="color:#66d9ef">import</span> <span style="color:#a6e22e">UIKit</span>

<span style="color:#66d9ef">class</span> <span style="color:#a6e22e">ViewController</span>: UIViewController {
    <span style="color:#66d9ef">override</span> <span style="color:#66d9ef">func</span> <span style="color:#a6e22e">viewDidLoad</span>() {
        <span style="color:#66d9ef">super</span>.viewDidLoad()

        ObjC_Foo().foo()
    }
}
</code></pre></div><p>对于同样未开启 <code>use_frameworks</code> 的 Swift 工程来说，CocoaPods 处理资源的脚本和逻辑是一致的。</p>
<h4 id="swift-工程与-swift-pod">Swift 工程与 Swift Pod</h4>
<p>Swift 工程依赖 Swift Pod 的方式则更加简单，只需要使用 <code>import</code> 引入 Pod 即可：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-swift" data-lang="swift"><span style="color:#66d9ef">import</span> <span style="color:#a6e22e">swift_pod</span>

<span style="color:#66d9ef">class</span> <span style="color:#a6e22e">ViewController</span>: UIViewController {
    <span style="color:#66d9ef">override</span> <span style="color:#66d9ef">func</span> <span style="color:#a6e22e">viewDidLoad</span>() {
        <span style="color:#66d9ef">super</span>.viewDidLoad()

        Swift_Foo().foo()
        print(Swift_Foo().strings())
    }
}
</code></pre></div><h3 id="use_frameworks">use_frameworks!</h3>
<h4 id="obj-c-工程-1">Obj-C 工程</h4>
<p>将 <code>use_frameworks!</code> 开启时，Pods 工程将以框架方式依赖：</p>
<p><img src="/img/2019/libraries_in_ios/16.png" alt="16"></p>
<p>在上面我们了解过 Framework，其中聚合了可执行文件以及资源等文件，因此其一般不再需要单独的脚本来处理资源，而是需要「[CP] Embed Pods Frameworks」来针对 Framework 进行操作：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="color:#75715e">#!/bin/sh
</span><span style="color:#75715e"></span>set -e
set -u
set -o pipefail <span style="color:#75715e"># 一些设置</span>

<span style="color:#75715e"># 错误处理</span>
<span style="color:#66d9ef">function</span> on_error <span style="color:#f92672">{</span>
  echo <span style="color:#e6db74">&#34;</span><span style="color:#66d9ef">$(</span>realpath -mq <span style="color:#e6db74">&#34;</span><span style="color:#e6db74">${</span>0<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span><span style="color:#66d9ef">)</span><span style="color:#e6db74">:</span>$1<span style="color:#e6db74">: error: Unexpected failure&#34;</span>
<span style="color:#f92672">}</span>
trap <span style="color:#e6db74">&#39;on_error $LINENO&#39;</span> ERR

<span style="color:#75715e"># FRAMEWORKS_FOLDER_PATH（框架文件夹路径）：oc-demo-project-pod.app/Frameworks</span>
<span style="color:#66d9ef">if</span> <span style="color:#f92672">[</span> -z <span style="color:#e6db74">${</span>FRAMEWORKS_FOLDER_PATH+x<span style="color:#e6db74">}</span> <span style="color:#f92672">]</span>; <span style="color:#66d9ef">then</span>
  <span style="color:#75715e"># If FRAMEWORKS_FOLDER_PATH is not set, then there&#39;s nowhere for us to copy</span>
  <span style="color:#75715e"># frameworks to, so exit 0 (signalling the script phase was successful).</span>
  <span style="color:#75715e"># FRAMEWORKS_FOLDER_PATH 未设置，则无需拷贝资源并退出</span>
  exit <span style="color:#ae81ff">0</span>
<span style="color:#66d9ef">fi</span>

<span style="color:#75715e"># CONFIGURATION_BUILD_DIR（配置构建目录）：/Users/kingcos/Library/Developer/Xcode/DerivedData/oc-demo-project-pod-gmhizsqflcuavpebfzsfyychzzuj/Build/Products/Debug-iphonesimulator</span>
<span style="color:#75715e"># 递归创建框架路径</span>
echo <span style="color:#e6db74">&#34;mkdir -p </span><span style="color:#e6db74">${</span>CONFIGURATION_BUILD_DIR<span style="color:#e6db74">}</span><span style="color:#e6db74">/</span><span style="color:#e6db74">${</span>FRAMEWORKS_FOLDER_PATH<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>
mkdir -p <span style="color:#e6db74">&#34;</span><span style="color:#e6db74">${</span>CONFIGURATION_BUILD_DIR<span style="color:#e6db74">}</span><span style="color:#e6db74">/</span><span style="color:#e6db74">${</span>FRAMEWORKS_FOLDER_PATH<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>

<span style="color:#75715e"># COCOAPODS_PARALLEL_CODE_SIGN（CocoaPods 并行签名）：false（默认）</span>
COCOAPODS_PARALLEL_CODE_SIGN<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">${</span>COCOAPODS_PARALLEL_CODE_SIGN<span style="color:#66d9ef">:-</span>false<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>

<span style="color:#75715e"># DT_TOOLCHAIN_DIR（工具链目录）：/Applications/Xcode.app/Contents/Developer/Toolchains/XcodeDefault.xctoolchain</span>
<span style="color:#75715e"># PLATFORM_NAME（目标平台名）：iphonesimulator</span>
<span style="color:#75715e"># SWIFT_STDLIB_PATH（Swift 标准库路径）：/Applications/Xcode.app/Contents/Developer/Toolchains/XcodeDefault.xctoolchain/usr/lib/swift/iphonesimulator</span>
SWIFT_STDLIB_PATH<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">${</span>DT_TOOLCHAIN_DIR<span style="color:#e6db74">}</span><span style="color:#e6db74">/usr/lib/swift/</span><span style="color:#e6db74">${</span>PLATFORM_NAME<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>

<span style="color:#75715e"># Used as a return value for each invocation of `strip_invalid_archs` function.</span>
<span style="color:#75715e"># 作为每次调用 strip_invalid_archs 函数的返回值</span>
STRIP_BINARY_RETVAL<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>

<span style="color:#75715e"># 防止多个 target 同时拷贝相同的框架依赖</span>
<span style="color:#75715e"># This protects against multiple targets copying the same framework dependency at the same time. The solution</span>
<span style="color:#75715e"># was originally proposed here: https://lists.samba.org/archive/rsync/2008-February/020158.html</span>
RSYNC_PROTECT_TMP_FILES<span style="color:#f92672">=(</span>--filter <span style="color:#e6db74">&#34;P .*.??????&#34;</span><span style="color:#f92672">)</span>

<span style="color:#75715e"># Copies and strips a vendored framework</span>
<span style="color:#75715e"># 拷贝并删除 vendored 框架</span>
install_framework<span style="color:#f92672">()</span>
<span style="color:#f92672">{</span>
  <span style="color:#75715e"># BUILT_PRODUCTS_DIR（构建产物目录）：/Users/kingcos/Library/Developer/Xcode/DerivedData/oc-demo-project-pod-gmhizsqflcuavpebfzsfyychzzuj/Build/Products/Debug-iphonesimulator</span>
  <span style="color:#75715e"># if [ -r FILE ]; 如果文件 FILE 可读（r：read）则为真</span>
  <span style="color:#66d9ef">if</span> <span style="color:#f92672">[</span> -r <span style="color:#e6db74">&#34;</span><span style="color:#e6db74">${</span>BUILT_PRODUCTS_DIR<span style="color:#e6db74">}</span><span style="color:#e6db74">/</span>$1<span style="color:#e6db74">&#34;</span> <span style="color:#f92672">]</span>; <span style="color:#66d9ef">then</span>
    local source<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">${</span>BUILT_PRODUCTS_DIR<span style="color:#e6db74">}</span><span style="color:#e6db74">/</span>$1<span style="color:#e6db74">&#34;</span>
  <span style="color:#66d9ef">elif</span> <span style="color:#f92672">[</span> -r <span style="color:#e6db74">&#34;</span><span style="color:#e6db74">${</span>BUILT_PRODUCTS_DIR<span style="color:#e6db74">}</span><span style="color:#e6db74">/</span><span style="color:#66d9ef">$(</span>basename <span style="color:#e6db74">&#34;</span>$1<span style="color:#e6db74">&#34;</span><span style="color:#66d9ef">)</span><span style="color:#e6db74">&#34;</span> <span style="color:#f92672">]</span>; <span style="color:#66d9ef">then</span>
    local source<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">${</span>BUILT_PRODUCTS_DIR<span style="color:#e6db74">}</span><span style="color:#e6db74">/</span><span style="color:#66d9ef">$(</span>basename <span style="color:#e6db74">&#34;</span>$1<span style="color:#e6db74">&#34;</span><span style="color:#66d9ef">)</span><span style="color:#e6db74">&#34;</span>
  <span style="color:#66d9ef">elif</span> <span style="color:#f92672">[</span> -r <span style="color:#e6db74">&#34;</span>$1<span style="color:#e6db74">&#34;</span> <span style="color:#f92672">]</span>; <span style="color:#66d9ef">then</span>
    local source<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;</span>$1<span style="color:#e6db74">&#34;</span>
  <span style="color:#66d9ef">fi</span>

  local destination<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">${</span>TARGET_BUILD_DIR<span style="color:#e6db74">}</span><span style="color:#e6db74">/</span><span style="color:#e6db74">${</span>FRAMEWORKS_FOLDER_PATH<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>

  <span style="color:#75715e"># if [ -L FILE ]; 如果文件 FILE 是链接（L：Link）文件则为真</span>
  <span style="color:#66d9ef">if</span> <span style="color:#f92672">[</span> -L <span style="color:#e6db74">&#34;</span><span style="color:#e6db74">${</span>source<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span> <span style="color:#f92672">]</span>; <span style="color:#66d9ef">then</span>
    echo <span style="color:#e6db74">&#34;Symlinked...&#34;</span>
    <span style="color:#75715e"># 读取链接的真实文件</span>
    source<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;</span><span style="color:#66d9ef">$(</span>readlink <span style="color:#e6db74">&#34;</span><span style="color:#e6db74">${</span>source<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span><span style="color:#66d9ef">)</span><span style="color:#e6db74">&#34;</span>
  <span style="color:#66d9ef">fi</span>

  <span style="color:#75715e"># Use filter instead of exclude so missing patterns don&#39;t throw errors.</span>
  echo <span style="color:#e6db74">&#34;rsync --delete -av &#34;</span><span style="color:#e6db74">${</span>RSYNC_PROTECT_TMP_FILES[@]<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34; --filter \&#34;- CVS/\&#34; --filter \&#34;- .svn/\&#34; --filter \&#34;- .git/\&#34; --filter \&#34;- .hg/\&#34; --filter \&#34;- Headers\&#34; --filter \&#34;- PrivateHeaders\&#34; --filter \&#34;- Modules\&#34; \&#34;</span><span style="color:#e6db74">${</span>source<span style="color:#e6db74">}</span><span style="color:#e6db74">\&#34; \&#34;</span><span style="color:#e6db74">${</span>destination<span style="color:#e6db74">}</span><span style="color:#e6db74">\&#34;&#34;</span>
  rsync --delete -av <span style="color:#e6db74">&#34;</span><span style="color:#e6db74">${</span>RSYNC_PROTECT_TMP_FILES[@]<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span> --filter <span style="color:#e6db74">&#34;- CVS/&#34;</span> --filter <span style="color:#e6db74">&#34;- .svn/&#34;</span> --filter <span style="color:#e6db74">&#34;- .git/&#34;</span> --filter <span style="color:#e6db74">&#34;- .hg/&#34;</span> --filter <span style="color:#e6db74">&#34;- Headers&#34;</span> --filter <span style="color:#e6db74">&#34;- PrivateHeaders&#34;</span> --filter <span style="color:#e6db74">&#34;- Modules&#34;</span> <span style="color:#e6db74">&#34;</span><span style="color:#e6db74">${</span>source<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span> <span style="color:#e6db74">&#34;</span><span style="color:#e6db74">${</span>destination<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>

  local basename
  <span style="color:#75715e"># basename（基本名）：AFNetworking / oc_pod / swift_pod</span>
  <span style="color:#75715e"># binary（二进制路径）</span>
  basename<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;</span><span style="color:#66d9ef">$(</span>basename -s .framework <span style="color:#e6db74">&#34;</span>$1<span style="color:#e6db74">&#34;</span><span style="color:#66d9ef">)</span><span style="color:#e6db74">&#34;</span>
  binary<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">${</span>destination<span style="color:#e6db74">}</span><span style="color:#e6db74">/</span><span style="color:#e6db74">${</span>basename<span style="color:#e6db74">}</span><span style="color:#e6db74">.framework/</span><span style="color:#e6db74">${</span>basename<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>

  <span style="color:#66d9ef">if</span> ! <span style="color:#f92672">[</span> -r <span style="color:#e6db74">&#34;</span>$binary<span style="color:#e6db74">&#34;</span> <span style="color:#f92672">]</span>; <span style="color:#66d9ef">then</span>
    binary<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">${</span>destination<span style="color:#e6db74">}</span><span style="color:#e6db74">/</span><span style="color:#e6db74">${</span>basename<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>
  <span style="color:#66d9ef">elif</span> <span style="color:#f92672">[</span> -L <span style="color:#e6db74">&#34;</span><span style="color:#e6db74">${</span>binary<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span> <span style="color:#f92672">]</span>; <span style="color:#66d9ef">then</span>
    echo <span style="color:#e6db74">&#34;Destination binary is symlinked...&#34;</span>
    dirname<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;</span><span style="color:#66d9ef">$(</span>dirname <span style="color:#e6db74">&#34;</span><span style="color:#e6db74">${</span>binary<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span><span style="color:#66d9ef">)</span><span style="color:#e6db74">&#34;</span>
    binary<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">${</span>dirname<span style="color:#e6db74">}</span><span style="color:#e6db74">/</span><span style="color:#66d9ef">$(</span>readlink <span style="color:#e6db74">&#34;</span><span style="color:#e6db74">${</span>binary<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span><span style="color:#66d9ef">)</span><span style="color:#e6db74">&#34;</span>
  <span style="color:#66d9ef">fi</span>

  <span style="color:#75715e"># /Users/kingcos/Library/Developer/Xcode/DerivedData/oc-demo-project-pod-gmhizsqflcuavpebfzsfyychzzuj/Build/Products/Debug-iphonesimulator/oc-demo-project-pod.app/Frameworks/AFNetworking.framework/AFNetworking: Mach-O 64-bit dynamically linked shared library x86_64</span>
  <span style="color:#75715e"># Strip invalid architectures so &#34;fat&#34; simulator / device frameworks work on device</span>
  <span style="color:#66d9ef">if</span> <span style="color:#f92672">[[</span> <span style="color:#e6db74">&#34;</span><span style="color:#66d9ef">$(</span>file <span style="color:#e6db74">&#34;</span>$binary<span style="color:#e6db74">&#34;</span><span style="color:#66d9ef">)</span><span style="color:#e6db74">&#34;</span> <span style="color:#f92672">==</span> *<span style="color:#e6db74">&#34;dynamically linked shared library&#34;</span>* <span style="color:#f92672">]]</span>; <span style="color:#66d9ef">then</span>
    <span style="color:#75715e"># 若为动态链接共享库，则删除无效架构</span>
    strip_invalid_archs <span style="color:#e6db74">&#34;</span>$binary<span style="color:#e6db74">&#34;</span>
  <span style="color:#66d9ef">fi</span>

  <span style="color:#75715e"># Resign the code if required by the build settings to avoid unstable apps</span>
  <span style="color:#75715e"># 重签名 Build Settings 里设置为必须的代码，以避免造成 app 不稳定</span>
  code_sign_if_enabled <span style="color:#e6db74">&#34;</span><span style="color:#e6db74">${</span>destination<span style="color:#e6db74">}</span><span style="color:#e6db74">/</span><span style="color:#66d9ef">$(</span>basename <span style="color:#e6db74">&#34;</span>$1<span style="color:#e6db74">&#34;</span><span style="color:#66d9ef">)</span><span style="color:#e6db74">&#34;</span>

  <span style="color:#75715e"># Embed linked Swift runtime libraries. No longer necessary as of Xcode 7.</span>
  <span style="color:#75715e"># 嵌入 Swift 运行时库，Xcode 7 之后不再需要。</span>
  <span style="color:#66d9ef">if</span> <span style="color:#f92672">[</span> <span style="color:#e6db74">&#34;</span><span style="color:#e6db74">${</span>XCODE_VERSION_MAJOR<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span> -lt <span style="color:#ae81ff">7</span> <span style="color:#f92672">]</span>; <span style="color:#66d9ef">then</span>
    local swift_runtime_libs
    swift_runtime_libs<span style="color:#f92672">=</span><span style="color:#66d9ef">$(</span>xcrun otool -LX <span style="color:#e6db74">&#34;</span>$binary<span style="color:#e6db74">&#34;</span> | grep --color<span style="color:#f92672">=</span>never @rpath/libswift | sed -E s/@rpath<span style="color:#ae81ff">\\</span>/<span style="color:#ae81ff">\(</span>.+dylib<span style="color:#ae81ff">\)</span>.*/<span style="color:#ae81ff">\\</span>1/g | uniq -u<span style="color:#66d9ef">)</span>
    <span style="color:#66d9ef">for</span> lib in $swift_runtime_libs; <span style="color:#66d9ef">do</span>
      echo <span style="color:#e6db74">&#34;rsync -auv \&#34;</span><span style="color:#e6db74">${</span>SWIFT_STDLIB_PATH<span style="color:#e6db74">}</span><span style="color:#e6db74">/</span><span style="color:#e6db74">${</span>lib<span style="color:#e6db74">}</span><span style="color:#e6db74">\&#34; \&#34;</span><span style="color:#e6db74">${</span>destination<span style="color:#e6db74">}</span><span style="color:#e6db74">\&#34;&#34;</span>
      rsync -auv <span style="color:#e6db74">&#34;</span><span style="color:#e6db74">${</span>SWIFT_STDLIB_PATH<span style="color:#e6db74">}</span><span style="color:#e6db74">/</span><span style="color:#e6db74">${</span>lib<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span> <span style="color:#e6db74">&#34;</span><span style="color:#e6db74">${</span>destination<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>
      code_sign_if_enabled <span style="color:#e6db74">&#34;</span><span style="color:#e6db74">${</span>destination<span style="color:#e6db74">}</span><span style="color:#e6db74">/</span><span style="color:#e6db74">${</span>lib<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>
    <span style="color:#66d9ef">done</span>
  <span style="color:#66d9ef">fi</span>
<span style="color:#f92672">}</span>

<span style="color:#75715e"># Copies and strips a vendored dSYM</span>
<span style="color:#75715e"># 拷贝并删除 vendored dSYM</span>
install_dsym<span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
  local source<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;</span>$1<span style="color:#e6db74">&#34;</span>
  <span style="color:#66d9ef">if</span> <span style="color:#f92672">[</span> -r <span style="color:#e6db74">&#34;</span>$source<span style="color:#e6db74">&#34;</span> <span style="color:#f92672">]</span>; <span style="color:#66d9ef">then</span>
    <span style="color:#75715e"># Copy the dSYM into a the targets temp dir.</span>
    echo <span style="color:#e6db74">&#34;rsync --delete -av &#34;</span><span style="color:#e6db74">${</span>RSYNC_PROTECT_TMP_FILES[@]<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34; --filter \&#34;- CVS/\&#34; --filter \&#34;- .svn/\&#34; --filter \&#34;- .git/\&#34; --filter \&#34;- .hg/\&#34; --filter \&#34;- Headers\&#34; --filter \&#34;- PrivateHeaders\&#34; --filter \&#34;- Modules\&#34; \&#34;</span><span style="color:#e6db74">${</span>source<span style="color:#e6db74">}</span><span style="color:#e6db74">\&#34; \&#34;</span><span style="color:#e6db74">${</span>DERIVED_FILES_DIR<span style="color:#e6db74">}</span><span style="color:#e6db74">\&#34;&#34;</span>
    rsync --delete -av <span style="color:#e6db74">&#34;</span><span style="color:#e6db74">${</span>RSYNC_PROTECT_TMP_FILES[@]<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span> --filter <span style="color:#e6db74">&#34;- CVS/&#34;</span> --filter <span style="color:#e6db74">&#34;- .svn/&#34;</span> --filter <span style="color:#e6db74">&#34;- .git/&#34;</span> --filter <span style="color:#e6db74">&#34;- .hg/&#34;</span> --filter <span style="color:#e6db74">&#34;- Headers&#34;</span> --filter <span style="color:#e6db74">&#34;- PrivateHeaders&#34;</span> --filter <span style="color:#e6db74">&#34;- Modules&#34;</span> <span style="color:#e6db74">&#34;</span><span style="color:#e6db74">${</span>source<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span> <span style="color:#e6db74">&#34;</span><span style="color:#e6db74">${</span>DERIVED_FILES_DIR<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>

    local basename
    basename<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;</span><span style="color:#66d9ef">$(</span>basename -s .framework.dSYM <span style="color:#e6db74">&#34;</span>$source<span style="color:#e6db74">&#34;</span><span style="color:#66d9ef">)</span><span style="color:#e6db74">&#34;</span>
    binary<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">${</span>DERIVED_FILES_DIR<span style="color:#e6db74">}</span><span style="color:#e6db74">/</span><span style="color:#e6db74">${</span>basename<span style="color:#e6db74">}</span><span style="color:#e6db74">.framework.dSYM/Contents/Resources/DWARF/</span><span style="color:#e6db74">${</span>basename<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>

    <span style="color:#75715e"># Strip invalid architectures so &#34;fat&#34; simulator / device frameworks work on device</span>
    <span style="color:#66d9ef">if</span> <span style="color:#f92672">[[</span> <span style="color:#e6db74">&#34;</span><span style="color:#66d9ef">$(</span>file <span style="color:#e6db74">&#34;</span>$binary<span style="color:#e6db74">&#34;</span><span style="color:#66d9ef">)</span><span style="color:#e6db74">&#34;</span> <span style="color:#f92672">==</span> *<span style="color:#e6db74">&#34;Mach-O &#34;</span>*<span style="color:#e6db74">&#34;dSYM companion&#34;</span>* <span style="color:#f92672">]]</span>; <span style="color:#66d9ef">then</span>
      strip_invalid_archs <span style="color:#e6db74">&#34;</span>$binary<span style="color:#e6db74">&#34;</span>
    <span style="color:#66d9ef">fi</span>

    <span style="color:#66d9ef">if</span> <span style="color:#f92672">[[</span> $STRIP_BINARY_RETVAL <span style="color:#f92672">==</span> <span style="color:#ae81ff">1</span> <span style="color:#f92672">]]</span>; <span style="color:#66d9ef">then</span>
      <span style="color:#75715e"># Move the stripped file into its final destination.</span>
      echo <span style="color:#e6db74">&#34;rsync --delete -av &#34;</span><span style="color:#e6db74">${</span>RSYNC_PROTECT_TMP_FILES[@]<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34; --filter \&#34;- CVS/\&#34; --filter \&#34;- .svn/\&#34; --filter \&#34;- .git/\&#34; --filter \&#34;- .hg/\&#34; --filter \&#34;- Headers\&#34; --filter \&#34;- PrivateHeaders\&#34; --filter \&#34;- Modules\&#34; \&#34;</span><span style="color:#e6db74">${</span>DERIVED_FILES_DIR<span style="color:#e6db74">}</span><span style="color:#e6db74">/</span><span style="color:#e6db74">${</span>basename<span style="color:#e6db74">}</span><span style="color:#e6db74">.framework.dSYM\&#34; \&#34;</span><span style="color:#e6db74">${</span>DWARF_DSYM_FOLDER_PATH<span style="color:#e6db74">}</span><span style="color:#e6db74">\&#34;&#34;</span>
      rsync --delete -av <span style="color:#e6db74">&#34;</span><span style="color:#e6db74">${</span>RSYNC_PROTECT_TMP_FILES[@]<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span> --filter <span style="color:#e6db74">&#34;- CVS/&#34;</span> --filter <span style="color:#e6db74">&#34;- .svn/&#34;</span> --filter <span style="color:#e6db74">&#34;- .git/&#34;</span> --filter <span style="color:#e6db74">&#34;- .hg/&#34;</span> --filter <span style="color:#e6db74">&#34;- Headers&#34;</span> --filter <span style="color:#e6db74">&#34;- PrivateHeaders&#34;</span> --filter <span style="color:#e6db74">&#34;- Modules&#34;</span> <span style="color:#e6db74">&#34;</span><span style="color:#e6db74">${</span>DERIVED_FILES_DIR<span style="color:#e6db74">}</span><span style="color:#e6db74">/</span><span style="color:#e6db74">${</span>basename<span style="color:#e6db74">}</span><span style="color:#e6db74">.framework.dSYM&#34;</span> <span style="color:#e6db74">&#34;</span><span style="color:#e6db74">${</span>DWARF_DSYM_FOLDER_PATH<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>
    <span style="color:#66d9ef">else</span>
      <span style="color:#75715e"># The dSYM was not stripped at all, in this case touch a fake folder so the input/output paths from Xcode do not reexecute this script because the file is missing.</span>
      touch <span style="color:#e6db74">&#34;</span><span style="color:#e6db74">${</span>DWARF_DSYM_FOLDER_PATH<span style="color:#e6db74">}</span><span style="color:#e6db74">/</span><span style="color:#e6db74">${</span>basename<span style="color:#e6db74">}</span><span style="color:#e6db74">.framework.dSYM&#34;</span>
    <span style="color:#66d9ef">fi</span>
  <span style="color:#66d9ef">fi</span>
<span style="color:#f92672">}</span>

<span style="color:#75715e"># Copies the bcsymbolmap files of a vendored framework</span>
<span style="color:#75715e"># 复制 vendored 框架的 bcsymbolmap 文件</span>
install_bcsymbolmap<span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
    local bcsymbolmap_path<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;</span>$1<span style="color:#e6db74">&#34;</span>
    local destination<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">${</span>BUILT_PRODUCTS_DIR<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>
    echo <span style="color:#e6db74">&#34;rsync --delete -av &#34;</span><span style="color:#e6db74">${</span>RSYNC_PROTECT_TMP_FILES[@]<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34; --filter &#34;</span>- CVS/<span style="color:#e6db74">&#34; --filter &#34;</span>- .svn/<span style="color:#e6db74">&#34; --filter &#34;</span>- .git/<span style="color:#e6db74">&#34; --filter &#34;</span>- .hg/<span style="color:#e6db74">&#34; --filter &#34;</span>- Headers<span style="color:#e6db74">&#34; --filter &#34;</span>- PrivateHeaders<span style="color:#e6db74">&#34; --filter &#34;</span>- Modules<span style="color:#e6db74">&#34; &#34;</span><span style="color:#e6db74">${</span>bcsymbolmap_path<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34; &#34;</span><span style="color:#e6db74">${</span>destination<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;&#34;</span>
    rsync --delete -av <span style="color:#e6db74">&#34;</span><span style="color:#e6db74">${</span>RSYNC_PROTECT_TMP_FILES[@]<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span> --filter <span style="color:#e6db74">&#34;- CVS/&#34;</span> --filter <span style="color:#e6db74">&#34;- .svn/&#34;</span> --filter <span style="color:#e6db74">&#34;- .git/&#34;</span> --filter <span style="color:#e6db74">&#34;- .hg/&#34;</span> --filter <span style="color:#e6db74">&#34;- Headers&#34;</span> --filter <span style="color:#e6db74">&#34;- PrivateHeaders&#34;</span> --filter <span style="color:#e6db74">&#34;- Modules&#34;</span> <span style="color:#e6db74">&#34;</span><span style="color:#e6db74">${</span>bcsymbolmap_path<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span> <span style="color:#e6db74">&#34;</span><span style="color:#e6db74">${</span>destination<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>
<span style="color:#f92672">}</span>

<span style="color:#75715e"># Signs a framework with the provided identity</span>
<span style="color:#75715e"># 使用提供的证明签名框架</span>
code_sign_if_enabled<span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
  <span style="color:#66d9ef">if</span> <span style="color:#f92672">[</span> -n <span style="color:#e6db74">&#34;</span><span style="color:#e6db74">${</span>EXPANDED_CODE_SIGN_IDENTITY<span style="color:#66d9ef">:-</span><span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span> -a <span style="color:#e6db74">&#34;</span><span style="color:#e6db74">${</span>CODE_SIGNING_REQUIRED<span style="color:#66d9ef">:-</span><span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span> !<span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;NO&#34;</span> -a <span style="color:#e6db74">&#34;</span><span style="color:#e6db74">${</span>CODE_SIGNING_ALLOWED<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span> !<span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;NO&#34;</span> <span style="color:#f92672">]</span>; <span style="color:#66d9ef">then</span>
    <span style="color:#75715e"># Use the current code_sign_identity</span>
    echo <span style="color:#e6db74">&#34;Code Signing </span>$1<span style="color:#e6db74"> with Identity </span><span style="color:#e6db74">${</span>EXPANDED_CODE_SIGN_IDENTITY_NAME<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>
    local code_sign_cmd<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;/usr/bin/codesign --force --sign </span><span style="color:#e6db74">${</span>EXPANDED_CODE_SIGN_IDENTITY<span style="color:#e6db74">}</span><span style="color:#e6db74"> </span><span style="color:#e6db74">${</span>OTHER_CODE_SIGN_FLAGS<span style="color:#66d9ef">:-</span><span style="color:#e6db74">}</span><span style="color:#e6db74"> --preserve-metadata=identifier,entitlements &#39;</span>$1<span style="color:#e6db74">&#39;&#34;</span>

    <span style="color:#66d9ef">if</span> <span style="color:#f92672">[</span> <span style="color:#e6db74">&#34;</span><span style="color:#e6db74">${</span>COCOAPODS_PARALLEL_CODE_SIGN<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span> <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;true&#34;</span> <span style="color:#f92672">]</span>; <span style="color:#66d9ef">then</span>
      code_sign_cmd<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;</span>$code_sign_cmd<span style="color:#e6db74"> &amp;&#34;</span>
    <span style="color:#66d9ef">fi</span>
    echo <span style="color:#e6db74">&#34;</span>$code_sign_cmd<span style="color:#e6db74">&#34;</span>
    eval <span style="color:#e6db74">&#34;</span>$code_sign_cmd<span style="color:#e6db74">&#34;</span>
  <span style="color:#66d9ef">fi</span>
<span style="color:#f92672">}</span>

<span style="color:#75715e"># Strip invalid architectures</span>
<span style="color:#75715e"># 删除无效架构函数</span>
strip_invalid_archs<span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
  binary<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;</span>$1<span style="color:#e6db74">&#34;</span>
  <span style="color:#75715e"># Get architectures for current target binary</span>
  <span style="color:#75715e"># 获取当前二进制架构，x86_64 模拟器</span>
  binary_archs<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;</span><span style="color:#66d9ef">$(</span>lipo -info <span style="color:#e6db74">&#34;</span>$binary<span style="color:#e6db74">&#34;</span> | rev | cut -d <span style="color:#e6db74">&#39;:&#39;</span> -f1 | awk <span style="color:#e6db74">&#39;{$1=$1;print}&#39;</span> | rev<span style="color:#66d9ef">)</span><span style="color:#e6db74">&#34;</span>

  <span style="color:#75715e"># Intersect them with the architectures we are building for</span>
  <span style="color:#75715e"># 与目标架构取交集</span>
  intersected_archs<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;</span><span style="color:#66d9ef">$(</span>echo <span style="color:#e6db74">${</span>ARCHS[@]<span style="color:#e6db74">}</span> <span style="color:#e6db74">${</span>binary_archs[@]<span style="color:#e6db74">}</span> | tr <span style="color:#e6db74">&#39; &#39;</span> <span style="color:#e6db74">&#39;\n&#39;</span> | sort | uniq -d<span style="color:#66d9ef">)</span><span style="color:#e6db74">&#34;</span>
  <span style="color:#75715e"># If there are no archs supported by this binary then warn the user</span>
  <span style="color:#75715e"># 如果交集为空，即没有支持的架构，则警告用户</span>
  <span style="color:#66d9ef">if</span> <span style="color:#f92672">[[</span> -z <span style="color:#e6db74">&#34;</span>$intersected_archs<span style="color:#e6db74">&#34;</span> <span style="color:#f92672">]]</span>; <span style="color:#66d9ef">then</span>
    echo <span style="color:#e6db74">&#34;warning: [CP] Vendored binary &#39;</span>$binary<span style="color:#e6db74">&#39; contains architectures (</span>$binary_archs<span style="color:#e6db74">) none of which match the current build architectures (</span>$ARCHS<span style="color:#e6db74">).&#34;</span>
    STRIP_BINARY_RETVAL<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>
    <span style="color:#66d9ef">return</span>
  <span style="color:#66d9ef">fi</span>
  stripped<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;&#34;</span>
  <span style="color:#66d9ef">for</span> arch in $binary_archs; <span style="color:#66d9ef">do</span>
    <span style="color:#66d9ef">if</span> ! <span style="color:#f92672">[[</span> <span style="color:#e6db74">&#34;</span><span style="color:#e6db74">${</span>ARCHS<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span> <span style="color:#f92672">==</span> *<span style="color:#e6db74">&#34;</span>$arch<span style="color:#e6db74">&#34;</span>* <span style="color:#f92672">]]</span>; <span style="color:#66d9ef">then</span>
      <span style="color:#75715e"># Strip non-valid architectures in-place</span>
      <span style="color:#75715e"># 删除无效架构</span>
      lipo -remove <span style="color:#e6db74">&#34;</span>$arch<span style="color:#e6db74">&#34;</span> -output <span style="color:#e6db74">&#34;</span>$binary<span style="color:#e6db74">&#34;</span> <span style="color:#e6db74">&#34;</span>$binary<span style="color:#e6db74">&#34;</span>
      stripped<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;</span>$stripped<span style="color:#e6db74"> </span>$arch<span style="color:#e6db74">&#34;</span>
    <span style="color:#66d9ef">fi</span>
  <span style="color:#66d9ef">done</span>
  <span style="color:#66d9ef">if</span> <span style="color:#f92672">[[</span> <span style="color:#e6db74">&#34;</span>$stripped<span style="color:#e6db74">&#34;</span> <span style="color:#f92672">]]</span>; <span style="color:#66d9ef">then</span>
    echo <span style="color:#e6db74">&#34;Stripped </span>$binary<span style="color:#e6db74"> of architectures:</span>$stripped<span style="color:#e6db74">&#34;</span>
  <span style="color:#66d9ef">fi</span>
  STRIP_BINARY_RETVAL<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>
<span style="color:#f92672">}</span>

<span style="color:#75715e"># CONFIGURATION：运行的 scheme 配置模式，Debug 或 Release</span>
<span style="color:#75715e"># 目前 Debug 和 Release 模式处理一致</span>
<span style="color:#75715e"># /Users/kingcos/Library/Developer/Xcode/DerivedData/oc-demo-project-pod-gmhizsqflcuavpebfzsfyychzzuj/Build/Products/Debug-iphonesimulator/AFNetworking/AFNetworking.framework</span>

<span style="color:#75715e"># /Users/kingcos/Library/Developer/Xcode/DerivedData/oc-demo-project-pod-gmhizsqflcuavpebfzsfyychzzuj/Build/Products/Debug-iphonesimulator/oc-pod/oc_pod.framework</span>
<span style="color:#75715e"># /Users/kingcos/Library/Developer/Xcode/DerivedData/oc-demo-project-pod-gmhizsqflcuavpebfzsfyychzzuj/Build/Products/Debug-iphonesimulator/swift-pod/swift_pod.framework</span>
<span style="color:#66d9ef">if</span> <span style="color:#f92672">[[</span> <span style="color:#e6db74">&#34;</span>$CONFIGURATION<span style="color:#e6db74">&#34;</span> <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;Debug&#34;</span> <span style="color:#f92672">]]</span>; <span style="color:#66d9ef">then</span>
  install_framework <span style="color:#e6db74">&#34;</span><span style="color:#e6db74">${</span>BUILT_PRODUCTS_DIR<span style="color:#e6db74">}</span><span style="color:#e6db74">/AFNetworking/AFNetworking.framework&#34;</span>
  install_framework <span style="color:#e6db74">&#34;</span><span style="color:#e6db74">${</span>BUILT_PRODUCTS_DIR<span style="color:#e6db74">}</span><span style="color:#e6db74">/oc-pod/oc_pod.framework&#34;</span>
  install_framework <span style="color:#e6db74">&#34;</span><span style="color:#e6db74">${</span>BUILT_PRODUCTS_DIR<span style="color:#e6db74">}</span><span style="color:#e6db74">/swift-pod/swift_pod.framework&#34;</span>
<span style="color:#66d9ef">fi</span>
<span style="color:#66d9ef">if</span> <span style="color:#f92672">[[</span> <span style="color:#e6db74">&#34;</span>$CONFIGURATION<span style="color:#e6db74">&#34;</span> <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;Release&#34;</span> <span style="color:#f92672">]]</span>; <span style="color:#66d9ef">then</span>
  install_framework <span style="color:#e6db74">&#34;</span><span style="color:#e6db74">${</span>BUILT_PRODUCTS_DIR<span style="color:#e6db74">}</span><span style="color:#e6db74">/AFNetworking/AFNetworking.framework&#34;</span>
  install_framework <span style="color:#e6db74">&#34;</span><span style="color:#e6db74">${</span>BUILT_PRODUCTS_DIR<span style="color:#e6db74">}</span><span style="color:#e6db74">/oc-pod/oc_pod.framework&#34;</span>
  install_framework <span style="color:#e6db74">&#34;</span><span style="color:#e6db74">${</span>BUILT_PRODUCTS_DIR<span style="color:#e6db74">}</span><span style="color:#e6db74">/swift-pod/swift_pod.framework&#34;</span>
<span style="color:#66d9ef">fi</span>
<span style="color:#66d9ef">if</span> <span style="color:#f92672">[</span> <span style="color:#e6db74">&#34;</span><span style="color:#e6db74">${</span>COCOAPODS_PARALLEL_CODE_SIGN<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span> <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;true&#34;</span> <span style="color:#f92672">]</span>; <span style="color:#66d9ef">then</span>
  wait
<span style="color:#66d9ef">fi</span>
</code></pre></div><p>使用 <code>use_frameworks!</code> 依赖的 Pod 库即可在 Obj-C 工程中使用 <code>@import</code> 引入，或者将共有头文件引入。需要注意的是，不同于上述非 <code>use_frameworks!</code> 情况，<code>#import</code> 是引入相对于 Framework 的头文件位置。对于 Swift Pod 则无不同：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-objectivec" data-lang="objectivec"><span style="color:#75715e">#import &#34;ViewController.h&#34;
</span><span style="color:#75715e"></span>
<span style="color:#75715e">//#import &lt;oc-pod/ObjC_Foo.h&gt; ❌，仅在非 `use_frameworks!` 下以文件夹相对路径引入而支持 `-`
</span><span style="color:#75715e"></span><span style="color:#75715e">#import &lt;oc_pod/ObjC_Foo.h&gt;
</span><span style="color:#75715e"></span><span style="color:#75715e">//#import &lt;ObjC_Foo.h&gt;
</span><span style="color:#75715e">//#import &#34;ObjC_Foo.h&#34;
</span><span style="color:#75715e">//@import oc_pod;
</span><span style="color:#75715e"></span>
@import swift_pod;

<span style="color:#66d9ef">@interface</span> <span style="color:#a6e22e">ViewController</span> ()
<span style="color:#66d9ef">@end</span>

<span style="color:#66d9ef">@implementation</span> <span style="color:#a6e22e">ViewController</span>
- (<span style="color:#66d9ef">void</span>)<span style="color:#a6e22e">viewDidLoad</span> {
    [super viewDidLoad];

    [[[ObjC_Foo alloc] init] foo];

    [[[Swift_Foo alloc] init] foo];
    NSLog(<span style="color:#e6db74">@&#34;%@&#34;</span>, [[[Swift_Foo alloc] init] strings]);
}
<span style="color:#66d9ef">@end</span>
</code></pre></div><h4 id="swift-工程-1">Swift 工程</h4>
<p>Swift 工程下也是类似的，我们可以在桥接文件中使用 <code>@import</code> 引入，或者将共有头文件引入。但其实此时桥接文件本身即是多余的，我们只需要在 Swift 工程中直接使用 <code>import</code> 即可：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-swift" data-lang="swift"><span style="color:#66d9ef">import</span> <span style="color:#a6e22e">UIKit</span>
<span style="color:#66d9ef">import</span> <span style="color:#a6e22e">swift_pod</span>
<span style="color:#66d9ef">import</span> <span style="color:#a6e22e">oc_pod</span>

<span style="color:#66d9ef">class</span> <span style="color:#a6e22e">ViewController</span>: UIViewController {
    <span style="color:#66d9ef">override</span> <span style="color:#66d9ef">func</span> <span style="color:#a6e22e">viewDidLoad</span>() {
        <span style="color:#66d9ef">super</span>.viewDidLoad()

        ObjC_Foo().foo()

<span style="color:#75715e">//        Swift_Foo().foo()</span>
        print(Swift_Foo().strings())
    }
}
</code></pre></div><ul>
<li>TODO:</li>
<li><input disabled="" type="checkbox"> @import</li>
<li><input disabled="" type="checkbox"> Module Map</li>
</ul>
<h2 id="reference">Reference</h2>
<!-- - [Linkers and Loaders](https://book.douban.com/subject/1436811/) -->
<ul>
<li><a href="../../2018/dyld_shared_cache/">谈谈 iOS 中的 dyld_shared_cache - kingcos</a></li>
<li><a href="/posts/2019/+load_in_ios/">iOS 中的 +load 方法 - kingcos</a></li>
<li><a href="https://forums.swift.org/t/whats-in-the-file-of-swiftmodule-how-to-open-it/1032">what’s in the file of .swiftmodule?how to open it?</a></li>
<li><a href="https://forums.swift.org/t/looking-for-documentation-insight-on-swiftdoc/6869">Looking for documentation/insight on .swiftdoc</a></li>
<li><a href="https://forums.swift.org/t/swift-static-libraries-dont-copy-generated-objective-c-header/19816">Swift static libraries don’t copy generated Objective-C header</a></li>
<li><a href="https://stackoverflow.com/questions/29580438/use-swift-library-in-objc">Use Swift Library in ObjC - StackOverflow</a></li>
<li><a href="https://paul-samuels.com/blog/2018/01/14/swift-static-library-in-objective-c/">Swift static library in Objective-C - Paul Samuels</a></li>
<li><a href="https://developer.apple.com/library/archive/documentation/MacOSX/Conceptual/BPFrameworks/Frameworks.html">Framework Programming Guide - Apple</a></li>
<li><a href="https://developer.apple.com/library/archive/documentation/CoreFoundation/Conceptual/CFBundles/BundleTypes/BundleTypes.html">Bundle Programming Guide - Apple</a></li>
<li><a href="https://developer.apple.com/library/archive/technotes/tn2435/_index.html">Technical Note TN2435 - Embedding Frameworks In An App - Apple</a></li>
<li><a href="https://www.raywenderlich.com/2430-how-to-create-a-framework-for-ios">How to Create a Framework for iOS - Ray Wenderlich</a></li>
</ul>

    </div>
    
      <div class="pagination">
        <div class="pagination__title">
          <span class="pagination__title-h">Read other posts</span>
          <hr />
        </div>
        <div class="pagination__buttons">
          
            <span class="button previous">
              <a href="/posts/2019/shopping_1111/">
                <span class="button__icon">←</span>
                <span class="button__text">双 11 买买买 - 开始抢购啦 💰</span>
              </a>
            </span>
          
          
            <span class="button next">
              <a href="/posts/2019/category_in_ios/">
                <span class="button__text">iOS 中的 Category</span>
                <span class="button__icon">→</span>
              </a>
            </span>
          
        </div>
      </div>
    

    

<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<table style="border: 0;">
  <tr>
  <td style="border: 0; width: 30%;">
    <img src='/img/about/1.jpg'>
  </td>
  <td style="border: 0;">
    <ins class="adsbygoogle"
     style="display:block"
     data-ad-client="ca-pub-9925978992661955"
     data-ad-slot="3213735320"
     data-ad-format="auto"
     data-full-width-responsive="true"></ins>
  </td>
  </tr>
</table>



<script>
     (adsbygoogle = window.adsbygoogle || []).push({});
</script>


    
    
    <div>
      <div id="github-comment">
      </div>

      <script type="text/javascript">
        function getUtterances(isDark) {
          var utterances = document.createElement('script');
          utterances.type = 'text/javascript';
          utterances.async = true;
          utterances.setAttribute('issue-term', "pathname")
          utterances.setAttribute('repo', "kingcos\/kingcos.github.io")
          utterances.setAttribute('label', "comments")
          isDark ? utterances.setAttribute('theme', "github-dark") : utterances.setAttribute('theme', "github-light")
          utterances.crossorigin = 'anonymous';
          utterances.src = 'https://utteranc.es/client.js';

          return utterances
        }

        var themeToggle = document.querySelector(".theme-toggle")
        themeToggle.addEventListener("click", function () {
          var getTheme = window.localStorage && window.localStorage.getItem("theme")
          var divNode = document.getElementById('github-comment')
          while(divNode.hasChildNodes()) {
            divNode.removeChild(divNode.firstChild);
          }
          
          
          

          
          
          
          
          
          
          document.getElementById('github-comment').appendChild(getUtterances(getTheme !== "dark"))
        })

        var getTheme = window.localStorage && window.localStorage.getItem("theme")
        document.getElementById('github-comment').appendChild(getUtterances(getTheme === "dark"))
      </script>
    </div>
    

    </div>

      </div>

      
        <footer class="footer">
  <div class="footer__inner">
    
      <div class="copyright copyright--user">All rights reserved by kingcos.me</div>
    
  </div>
</footer>

<script src="/assets/main.js"></script>
<script src="/assets/prism.js"></script>



      
    </div>

    
      
<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
	(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
	m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
	})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
	ga('create', 'UA-138311951-1', 'auto');
	
	ga('send', 'pageview');
}
</script>

    
  </body>
</html>
