<!DOCTYPE html>
<html lang="en" >
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="author" content="kingcos" />
	
	
	
	<title>iOS 中的 &#43;load 方法 ｜ kingcos</title>
	
    
    
    <meta name="description" content="在 iOS 开发中，我们经常会使用 &#43;load 方法来做一些在 `main` 函数之前的操作，比如方法交换（Method Swizzle）等。那么本文就来简单了解下 iOS 中 &#43;load 方法。" />
    

    
    
    <meta name="keywords" content="Hugo, theme, zozo" />
    

	
    
    <link rel="shortcut icon" href="https://kingcos.me/images/favicon.png" />

    <link rel="stylesheet" type="text/css" media="screen" href="https://kingcos.me/css/normalize.css" />
    <link rel="stylesheet" type="text/css" media="screen" href="https://cdn.jsdelivr.net/npm/animate.css@4.1.0/animate.min.css" />
    <link rel="stylesheet" type="text/css" media="screen" href="https://kingcos.me/css/zozo.css" />
	<link rel="stylesheet" type="text/css" media="screen" href="https://cdn.jsdelivr.net/npm/remixicon@2.5.0/fonts/remixicon.css" />
    <link rel="stylesheet" type="text/css" media="screen" href="https://kingcos.me/css/highlight.css" />

    
    
</head>

<script data-ad-client="ca-pub-9925978992661955" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>


<body>
    <div class="main animate__animated animate__fadeInDown">
        <div class="nav_container animated fadeInDown">
    <div class="site_nav" id="site_nav">
        <ul>
            
            <li>
                <a href="/">Home</a>
            </li>
            
            <li>
                <a href="/posts/">Archive</a>
            </li>
            
            <li>
                <a href="/tags/">Tags</a>
            </li>
            
            <li>
                <a href="/about/">About</a>
            </li>
            
        </ul>
    </div>
    <div class="menu_icon">
        <a id="menu_icon"><i class="ri-menu-line"></i></a>
    </div>
</div>


<link rel="stylesheet" href="https://kingcos.me/scss/main.min.75b49085bfb07b1bf150a1d59b4773d857e0452a747e37243805218b528a4045.css" integrity="sha256-dbSQhb&#43;wexvxUKHVm0dz2FfgRSp0fjckOAUhi1KKQEU=" media="screen">

<style>
.nav_container {
  height: 1rem;
}
 
table {
    width: 100%;
    table-layout: fixed;
}

 
.markdown code {
    white-space: normal;
    word-wrap: break-word;
    line-height: 1.5em;
    font-size: 0.85em;
    font-weight: bold;
    display: inline-block;
     
}

 
.menu_icon a {
    font-size: 16px;
}

 
body {
    font-family: 'Hiragino Sans GB', 'SFMono', 'Lato', '-apple-system';
    -webkit-font-smoothing: 'antialiased';
}

 
.markdown strong, .markdown b, .markdown em {
    font-weight: bold;
}

.post .post_content p {
     

    line-height: 1.75em;
}

 
.markdown img {
    max-width: 100%;
    margin: 0 auto;
    display: block;
    border-radius: 0.25rem;
}

 
.ri-stack-line {
    vertical-align: middle;
}

 
.ri-map-pin-time-line {
    vertical-align: middle;
}

 

 
.markdown .book-hint::before {
    content: none;
}

.markdown .book-hint {
    margin: 1rem 0;
    padding: 0.5rem 1rem 0.5rem 0.75rem;

    border-inline-start: 0.25rem solid #e9ecef;
    border-radius: 0.25rem;

    font-style: normal;
     
}

.book-hint strong {
    background-color: transparent;
}

.markdown .book-hint.info {
    border-left-color:#6bf;
    background-color:rgba(102,187,255,.1);
}

.markdown .book-hint.warning {
    border-left-color:#fd6;
    background-color:rgba(255,221,102,.1);
}

.markdown .book-hint.danger {
    border-left-color:#f66;
    background-color:rgba(255,102,102,.1);
}

</style>

        <div class="header animated fadeInDown">
    <div class="site_title_container">
        <div class="site_title">
            
                <a href="https://kingcos.me/">
                    
                    <img class="kingcos" style="margin-top: -20px; margin-left: -10px;" src="/title.svg" width="150px">
                </a>
            
        </div>
        <div class="description">
            <p class="sub_title">专注、坚持</p>
            <div class="my_socials">
                
                
                <a href="https://github.com/kingcos" title="github" target="_blank"><i class="ri-github-fill"></i></a>
                
                
                
                <a href="https://www.instagram.com/kingcos_v/" title="instagram" target="_blank"><i class="ri-instagram-fill"></i></a>
                
                
                
                <a href="https://twitter.com/kingcos_v" title="twitter" target="_blank"><i class="ri-twitter-fill"></i></a>
                
                
                
                <a href="https://weibo.com/u/1798410923" title="weibo" target="_blank"><i class="ri-weibo-fill"></i></a>
                
                
                
            </div>
        </div>
    </div>
</div>
        <div class="content">
            <div class="post_page">
                <div class="post animate__animated animate__fadeInDown">
                    <div class="post_title post_detail_title">
                        <h2><a href='/posts/2019/&#43;load_in_ios/'>iOS 中的 &#43;load 方法</a></h2>
                        <span class="date">2019.09.13</span>
                        <span>by kingcos</span>
                        
                        
                        
                        
                    </div>
                    <div class="post_content markdown">
<div class="book-expand">
  <label>
    <div class="book-expand-head flex justify-between">
      <span>Release Notes</span>
      <span>↕</span>
    </div>
    <input type="checkbox" class="hidden" />
    <div class="book-expand-content markdown-inner">
      <table>
<thead>
<tr>
<th style="text-align:center">Date</th>
<th style="text-align:center">Notes</th>
<th style="text-align:center">Source Code</th>
<th style="text-align:center">Demo</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">2019-04-20</td>
<td style="text-align:center">首次提交</td>
<td style="text-align:center"><a href="https://opensource.apple.com/tarballs/objc4/">objc4-750</a></td>
<td style="text-align:center"><a href="https://github.com/kingcos/Perspective/tree/writing/Posts/Practice/%2Bload_in_iOS">Load_Obj-C_Demo</a></td>
</tr>
<tr>
<td style="text-align:center">2019-09-13</td>
<td style="text-align:center">增加 Swift 等部分</td>
<td style="text-align:center">-</td>
<td style="text-align:center">-</td>
</tr>
</tbody>
</table>

    </div>
  </label>
</div>

<p><img src="/img/2019/+load_in_ios/0.png" alt="0"></p>
<h2 id="preface">Preface</h2>
<p>在 iOS 开发中，我们经常会使用 +load 方法来做一些在 <code>main</code> 函数之前的操作，比如方法交换（Method Swizzle）等。那么本文就来简单了解下 iOS 中 +load 方法。</p>
<h2 id="what">What</h2>
<p>iOS 中的 +load 方法指的是 <code>NSObject</code> 中的 <code>+ (void)load</code> 类方法：</p>
<div class="highlight"><pre class="chroma"><code class="language-objectivec" data-lang="objectivec"><span class="c1">// NSObject.h
</span><span class="c1"></span><span class="k">@interface</span> <span class="nc">NSObject</span> <span class="o">&lt;</span><span class="n">NSObject</span><span class="o">&gt;</span> <span class="p">{</span>
<span class="o">+</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="n">load</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div><p>官方文档中的 +load 如下：</p>
<blockquote>
<p>Invoked whenever a class or category is added to the Objective-C runtime; implement this method to perform class-specific behavior upon loading.</p>
<p>The <code>load</code> message is sent to classes and categories that are both dynamically loaded and statically linked, but only if the newly loaded class or category implements a method that can respond.</p>
<p>The order of initialization is as follows:</p>
<ol>
<li>All initializers in any framework you link to.</li>
<li>All <code>+load</code> methods in your image.</li>
<li>All C++ static initializers and C/C++ <code>__attribute__(constructor)</code> functions in your image.</li>
<li>All initializers in frameworks that link to you.</li>
</ol>
<p>In addition:</p>
<ul>
<li>A class’s <code>+load</code> method is called after all of its superclasses’ <code>+load</code> methods.</li>
<li>A category <code>+load</code> method is called after the class’s own <code>+load</code> method.</li>
</ul>
<p>In a custom implementation of <code>load</code> you can therefore safely message other unrelated classes from the same image, but any <code>load</code> methods implemented by those classes may not have run yet.</p>
<blockquote>
<p><strong>Important</strong></p>
<p>Custom implementations of the <code>load</code> method for Swift classes bridged to Objective-C are not called automatically.</p>
</blockquote>
<p>—— Documentation, Apple Developer</p>
<p>译：</p>
<p>当类或分类被添加到 Obj-C 运行时的时候被调用；可以实现该方法用来在加载时刻执行特定类的操作。</p>
<p>动态加载和静态链接都能将 <code>load</code> 消息发送到类和分类，但前提是新加载类或分类实现了要响应的方法。</p>
<p>初始化的顺序如下：</p>
<ol>
<li>链接的所有框架（Framework）中全部的构造器。</li>
<li>镜像（Image）中所有的 <code>+load</code> 方法。</li>
<li>镜像中所有的 C++ 静态构造器，以及 C/C++ 的 <code>__attribute__(constructor)</code> 函数。</li>
<li>框架中链接的所有构造器。</li>
</ol>
<p>另外：</p>
<ul>
<li>类的 <code>+load</code> 方法在其所有父类的 <code>+load</code> 方法调用之后调用。</li>
<li>分类的 <code>+load</code> 方法在其主类的 <code>+load</code> 方法调用之后调用。</li>
</ul>
<p>在 <code>load</code> 的自定义实现中，可以安全地从同一镜像中发送其他不相关的类，但这些类中实现的 <code>load</code> 方法可能还没有运行。</p>
<blockquote>
<p><strong>重点</strong></p>
<p>Swift 类中桥接到 Obj-C 的 <code>load</code> 方法自定义实现将不会自动调用。</p>
</blockquote>
<p>—— 文档，苹果开发者</p>
</blockquote>
<h2 id="how">How</h2>
<p>根据官方文档的描述，我们可以尝试定义一个继承自 <code>NSObject</code> 的 <code>Person</code> 类，并对其添加两个分类 <code>Life</code> 和 <code>Work</code>；再定义一个 <code>Student</code> 类继承自 <code>Person</code>，并对其添加 <code>School</code> 分类。在以上所有类和分类中，均实现 +load：</p>
<div class="highlight"><pre class="chroma"><code class="language-objectivec" data-lang="objectivec"><span class="c1">// Person.m
</span><span class="c1"></span><span class="cp">#import &#34;Person.h&#34;
</span><span class="cp"></span>
<span class="k">@implementation</span> <span class="nc">Person</span>
<span class="p">+</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">load</span> <span class="p">{</span>
    <span class="n">NSLog</span><span class="p">(</span><span class="s">@&#34;Person %s&#34;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
<span class="p">}</span>
<span class="k">@end</span>

<span class="c1">// Person+Life.m
</span><span class="c1"></span><span class="cp">#import &#34;Person+Life.h&#34;
</span><span class="cp"></span>
<span class="k">@implementation</span> <span class="nc">Person</span> <span class="nl">(Life)</span>
<span class="p">+</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">load</span> <span class="p">{</span>
    <span class="n">NSLog</span><span class="p">(</span><span class="s">@&#34;Person+Life %s&#34;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
<span class="p">}</span>
<span class="k">@end</span>

<span class="c1">// Person+Work.m
</span><span class="c1"></span><span class="cp">#import &#34;Person+Work.h&#34;
</span><span class="cp"></span>
<span class="k">@implementation</span> <span class="nc">Person</span> <span class="nl">(Work)</span>
<span class="p">+</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">load</span> <span class="p">{</span>
    <span class="n">NSLog</span><span class="p">(</span><span class="s">@&#34;Person+Work %s&#34;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
<span class="p">}</span>
<span class="k">@end</span>

<span class="c1">// Student.m
</span><span class="c1"></span><span class="cp">#import &#34;Student.h&#34;
</span><span class="cp"></span>
<span class="k">@implementation</span> <span class="nc">Student</span>
<span class="p">+</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">load</span> <span class="p">{</span>
    <span class="n">NSLog</span><span class="p">(</span><span class="s">@&#34;Student %s&#34;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
<span class="p">}</span>
<span class="k">@end</span>

<span class="c1">// Student+School.m
</span><span class="c1"></span><span class="cp">#import &#34;Student+School.h&#34;
</span><span class="cp"></span>
<span class="k">@implementation</span> <span class="nc">Student</span> <span class="nl">(School)</span>
<span class="p">+</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">load</span> <span class="p">{</span>
    <span class="n">NSLog</span><span class="p">(</span><span class="s">@&#34;Student+School %s&#34;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
<span class="p">}</span>
<span class="k">@end</span>

<span class="c1">// OUTPUT:
</span><span class="c1">// Person +[Person load]
</span><span class="c1">// Student +[Student load]
</span><span class="c1">// Person+Life +[Person(Life) load]
</span><span class="c1">// Student+School +[Student(School) load]
</span><span class="c1">// Person+Work +[Person(Work) load]
</span><span class="c1">// Hello, World!
</span></code></pre></div><p>不需要更改 main.m，尝试运行程序，结果正如官方所述，即 <strong>+load 方法会在 <code>main</code> 函数之前被调用；且调用顺序总是先父类再子类再分类</strong>。</p>
<h2 id="why">Why</h2>
<h3 id="实现原理">实现原理</h3>
<blockquote>
<p><strong>Obj-C 运行时的入口是哪里呢？</strong></p>
<p>在 objc4 源码中有一个「libobjc.order」的文件，列举了该库方法符号的调用顺序，我们能看到第一个就是 <code>__objc_init</code>。编译时，C/C++ 方法前会被自动加上 <code>_</code> 前缀作为方法符号（这一点可以在分析 Link Map 或者 Mach-O 时证明），因此这里第一个本质就是 <code>_objc_init</code>。</p>
<p><img src="/img/2019/+load_in_ios/1.png" alt="1"></p>
</blockquote>
<p>为了证明上述结论，我们可以在 objc4 的源码中，从 Obj-C 运行时初始化的入口着手，即 <code>_objc_init</code>：</p>
<div class="highlight"><pre class="chroma"><code class="language-objectivec" data-lang="objectivec"><span class="c1">// objc-os.mm
</span><span class="c1"></span><span class="cm">/***********************************************************************
</span><span class="cm">* _objc_init
</span><span class="cm">* Bootstrap initialization. Registers our image notifier with dyld.
</span><span class="cm">* 引导初始化。使用 dyld 注册镜像通知器。
</span><span class="cm">* Called by libSystem BEFORE library initialization time
</span><span class="cm">* 在库初始化时间之前由 libSystem 调用
</span><span class="cm">**********************************************************************/</span>

<span class="kt">void</span> <span class="nf">_objc_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">static</span> <span class="kt">bool</span> <span class="n">initialized</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">initialized</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span>
    <span class="n">initialized</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>

    <span class="c1">// fixme defer initialization until an objc-using image is found?
</span><span class="c1"></span>    <span class="n">environ_init</span><span class="p">();</span>
    <span class="n">tls_init</span><span class="p">();</span>
    <span class="n">static_init</span><span class="p">();</span>
    <span class="n">lock_init</span><span class="p">();</span>
    <span class="n">exception_init</span><span class="p">();</span>

    <span class="c1">// ➡️ dyld 注册通知；map_images：映射镜像，load_images：加载镜像，unmap_image：反映射镜像
</span><span class="c1"></span>    <span class="n">_dyld_objc_notify_register</span><span class="p">(</span><span class="o">&amp;</span><span class="n">map_images</span><span class="p">,</span> <span class="n">load_images</span><span class="p">,</span> <span class="n">unmap_image</span><span class="p">);</span>
<span class="p">}</span>

<span class="c1">// objc-runtime-new.mm
</span><span class="c1"></span><span class="cm">/***********************************************************************
</span><span class="cm">* load_images
</span><span class="cm">* Process +load in the given images which are being mapped in by dyld.
</span><span class="cm">* 由 dyld 处理给定将要映射的镜像中的 +load。
</span><span class="cm">*
</span><span class="cm">* Locking: write-locks runtimeLock and loadMethodLock
</span><span class="cm">* 锁：写锁 runtimeLock 和 loadMethodLock
</span><span class="cm">**********************************************************************/</span>
<span class="k">extern</span> <span class="kt">bool</span> <span class="nf">hasLoadMethods</span><span class="p">(</span><span class="k">const</span> <span class="n">headerType</span> <span class="o">*</span><span class="n">mhdr</span><span class="p">);</span>
<span class="k">extern</span> <span class="kt">void</span> <span class="nf">prepare_load_methods</span><span class="p">(</span><span class="k">const</span> <span class="n">headerType</span> <span class="o">*</span><span class="n">mhdr</span><span class="p">);</span>

<span class="kt">void</span>
<span class="nf">load_images</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">path</span> <span class="n">__unused</span><span class="p">,</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">mach_header</span> <span class="o">*</span><span class="n">mh</span><span class="p">)</span>
<span class="p">{</span>
    <span class="c1">// Return without taking locks if there are no +load methods here.
</span><span class="c1"></span>    <span class="c1">// ➡️ 如果没有 +load 方法则返回
</span><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">hasLoadMethods</span><span class="p">((</span><span class="k">const</span> <span class="n">headerType</span> <span class="o">*</span><span class="p">)</span><span class="n">mh</span><span class="p">))</span> <span class="k">return</span><span class="p">;</span>

    <span class="c1">// 递归锁
</span><span class="c1"></span>    <span class="n">recursive_mutex_locker_t</span> <span class="n">lock</span><span class="p">(</span><span class="n">loadMethodLock</span><span class="p">);</span>

    <span class="c1">// Discover load methods
</span><span class="c1"></span>    <span class="c1">// 发现 load 方法
</span><span class="c1"></span>    <span class="p">{</span>
        <span class="c1">// 互斥锁
</span><span class="c1"></span>        <span class="n">mutex_locker_t</span> <span class="n">lock2</span><span class="p">(</span><span class="n">runtimeLock</span><span class="p">);</span>
        <span class="c1">// ➡️ 准备加载 load 方法
</span><span class="c1"></span>        <span class="n">prepare_load_methods</span><span class="p">((</span><span class="k">const</span> <span class="n">headerType</span> <span class="o">*</span><span class="p">)</span><span class="n">mh</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="c1">// Call +load methods (without runtimeLock - re-entrant)
</span><span class="c1"></span>    <span class="c1">// ➡️ 调用 +load 方法（不带 runtimeLock - 可重入的（线程安全的））
</span><span class="c1"></span>    <span class="n">call_load_methods</span><span class="p">();</span>
<span class="p">}</span>

<span class="c1">// objc-runtime-new.mm
</span><span class="c1">// Quick scan for +load methods that doesn&#39;t take a lock.
</span><span class="c1">// 不需要加锁地快速搜索 +load 方法
</span><span class="c1"></span><span class="kt">bool</span> <span class="nf">hasLoadMethods</span><span class="p">(</span><span class="k">const</span> <span class="n">headerType</span> <span class="o">*</span><span class="n">mhdr</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">size_t</span> <span class="n">count</span><span class="p">;</span>
    <span class="c1">// 非懒加载类列表（取 Mach-O 中 __objc_nlclslist 节）
</span><span class="c1"></span>    <span class="c1">// GETSECT(_getObjc2NonlazyClassList,    classref_t,      &#34;__objc_nlclslist&#34;);
</span><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="n">_getObjc2NonlazyClassList</span><span class="p">(</span><span class="n">mhdr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">count</span><span class="p">)</span>  <span class="o">&amp;&amp;</span>  <span class="n">count</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
    <span class="c1">// 非懒加载分类列表（取 Mach-O 中 __objc_nlcatlist 节）
</span><span class="c1"></span>    <span class="c1">// GETSECT(_getObjc2NonlazyCategoryList, category_t *,    &#34;__objc_nlcatlist&#34;);
</span><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="n">_getObjc2NonlazyCategoryList</span><span class="p">(</span><span class="n">mhdr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">count</span><span class="p">)</span>  <span class="o">&amp;&amp;</span>  <span class="n">count</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
    <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
<span class="p">}</span>

<span class="c1">// objc-runtime-new.mm
</span><span class="c1"></span><span class="kt">void</span> <span class="nf">prepare_load_methods</span><span class="p">(</span><span class="k">const</span> <span class="n">headerType</span> <span class="o">*</span><span class="n">mhdr</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">size_t</span> <span class="n">count</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>

    <span class="c1">// 断言 runtimeLock 已锁
</span><span class="c1"></span>    <span class="n">runtimeLock</span><span class="p">.</span><span class="n">assertLocked</span><span class="p">();</span>

    <span class="c1">// 1. 非懒加载类列表
</span><span class="c1"></span>    <span class="n">classref_t</span> <span class="o">*</span><span class="n">classlist</span> <span class="o">=</span>
        <span class="n">_getObjc2NonlazyClassList</span><span class="p">(</span><span class="n">mhdr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">count</span><span class="p">);</span>
    <span class="c1">// 遍历所有类
</span><span class="c1"></span>    <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">count</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">// ➡️ 计划 +load 方法调用
</span><span class="c1"></span>        <span class="n">schedule_class_load</span><span class="p">(</span><span class="n">remapClass</span><span class="p">(</span><span class="n">classlist</span><span class="p">[</span><span class="n">i</span><span class="p">]));</span>
    <span class="p">}</span>

    <span class="c1">// 2. 非懒加载分类列表
</span><span class="c1"></span>    <span class="n">category_t</span> <span class="o">**</span><span class="n">categorylist</span> <span class="o">=</span> <span class="n">_getObjc2NonlazyCategoryList</span><span class="p">(</span><span class="n">mhdr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">count</span><span class="p">);</span>
    <span class="c1">// 遍历所有分类
</span><span class="c1"></span>    <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">count</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">category_t</span> <span class="o">*</span><span class="n">cat</span> <span class="o">=</span> <span class="n">categorylist</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
        <span class="c1">// 重映射分类的主类
</span><span class="c1"></span>        <span class="kt">Class</span> <span class="n">cls</span> <span class="o">=</span> <span class="n">remapClass</span><span class="p">(</span><span class="n">cat</span><span class="o">-&gt;</span><span class="n">cls</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cls</span><span class="p">)</span> <span class="k">continue</span><span class="p">;</span>  <span class="c1">// category for ignored weak-linked class 忽略弱链接主类的分类
</span><span class="c1"></span>        <span class="c1">// 实化类（为 cls 执行一次性初始化等操作）
</span><span class="c1"></span>        <span class="n">realizeClass</span><span class="p">(</span><span class="n">cls</span><span class="p">);</span>
        <span class="c1">// 断言类的 isa（元类）已实化
</span><span class="c1"></span>        <span class="n">assert</span><span class="p">(</span><span class="n">cls</span><span class="o">-&gt;</span><span class="n">ISA</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">isRealized</span><span class="p">());</span>
        <span class="c1">// ➡️ 添加分类到可加载列表
</span><span class="c1"></span>        <span class="n">add_category_to_loadable_list</span><span class="p">(</span><span class="n">cat</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="c1">// objc-runtime-new.mm
</span><span class="c1"></span><span class="k">static</span> <span class="kt">Class</span> <span class="nf">remapClass</span><span class="p">(</span><span class="n">classref_t</span> <span class="n">cls</span><span class="p">)</span>
<span class="p">{</span>
    <span class="err">➡️</span> <span class="err">重映射类</span>
    <span class="k">return</span> <span class="n">remapClass</span><span class="p">((</span><span class="kt">Class</span><span class="p">)</span><span class="n">cls</span><span class="p">);</span>
<span class="p">}</span>

<span class="c1">// objc-runtime-new.mm
</span><span class="c1"></span><span class="cm">/***********************************************************************
</span><span class="cm">* remapClass
</span><span class="cm">* Returns the live class pointer for cls, which may be pointing to
</span><span class="cm">* a class struct that has been reallocated.
</span><span class="cm">* 为参数 cls 返回可能指向已经重新分配类结构到活类指针。
</span><span class="cm">* Returns nil if cls is ignored because of weak linking.
</span><span class="cm">* 如果类是弱链接，将返回 nil。
</span><span class="cm">* Locking: runtimeLock must be read- or write-locked by the caller
</span><span class="cm">* 锁：runtimeLock 必须由调用者读取或写入锁定。
</span><span class="cm">**********************************************************************/</span>
<span class="k">static</span> <span class="kt">Class</span> <span class="nf">remapClass</span><span class="p">(</span><span class="kt">Class</span> <span class="n">cls</span><span class="p">)</span>
<span class="p">{</span>
    <span class="c1">// 断言 runtimeLock 已锁
</span><span class="c1"></span>    <span class="n">runtimeLock</span><span class="p">.</span><span class="n">assertLocked</span><span class="p">();</span>

    <span class="kt">Class</span> <span class="n">c2</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cls</span><span class="p">)</span> <span class="k">return</span> <span class="nb">nil</span><span class="p">;</span>

    <span class="n">NXMapTable</span> <span class="o">*</span><span class="n">map</span> <span class="o">=</span> <span class="n">remappedClasses</span><span class="p">(</span><span class="nb">NO</span><span class="p">);</span>
    <span class="c1">// 从 map 中取 cls 对应的值
</span><span class="c1"></span>    <span class="c1">// void *NXMapMember(NXMapTable *table, const void *key, void **value)
</span><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">map</span>  <span class="o">||</span>  <span class="n">NXMapMember</span><span class="p">(</span><span class="n">map</span><span class="p">,</span> <span class="n">cls</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span><span class="o">**</span><span class="p">)</span><span class="o">&amp;</span><span class="n">c2</span><span class="p">)</span> <span class="o">==</span> <span class="n">NX_MAPNOTAKEY</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="n">cls</span><span class="p">;</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="k">return</span> <span class="n">c2</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="c1">// objc-runtime-new.mm
</span><span class="c1"></span><span class="cm">/***********************************************************************
</span><span class="cm">* prepare_load_methods
</span><span class="cm">* Schedule +load for classes in this image, any un-+load-ed
</span><span class="cm">* superclasses in other images, and any categories in this image.
</span><span class="cm">* 为当前镜像中的类、其它镜像中所有未调用过 +load 的父类、以及该镜像中的所有的分类计划调用 +load。
</span><span class="cm">**********************************************************************/</span>
<span class="c1">// Recursively schedule +load for cls and any un-+load-ed superclasses.
</span><span class="c1">// 为 cls 以及所有未调用过 +load 的父类递归计划调用 +load。
</span><span class="c1">// cls must already be connected.
</span><span class="c1">// cls 必须已被连接。
</span><span class="c1"></span><span class="k">static</span> <span class="kt">void</span> <span class="nf">schedule_class_load</span><span class="p">(</span><span class="kt">Class</span> <span class="n">cls</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cls</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span>
    <span class="c1">// 断言类是实化的
</span><span class="c1"></span>    <span class="n">assert</span><span class="p">(</span><span class="n">cls</span><span class="o">-&gt;</span><span class="n">isRealized</span><span class="p">());</span>  <span class="c1">// _read_images should realize
</span><span class="c1"></span>
    <span class="c1">// 判断类的 +load 是否已经被调用
</span><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="n">cls</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">RW_LOADED</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span>

    <span class="c1">// Ensure superclass-first ordering
</span><span class="c1"></span>    <span class="c1">// （递归）确保父类优先调用 +load
</span><span class="c1"></span>    <span class="n">schedule_class_load</span><span class="p">(</span><span class="n">cls</span><span class="o">-&gt;</span><span class="n">superclass</span><span class="p">);</span>

    <span class="c1">// ➡️ 添加类到可加载列表
</span><span class="c1"></span>    <span class="n">add_class_to_loadable_list</span><span class="p">(</span><span class="n">cls</span><span class="p">);</span>
    <span class="c1">// 设置本类 +load 已调用过
</span><span class="c1"></span>    <span class="n">cls</span><span class="o">-&gt;</span><span class="n">setInfo</span><span class="p">(</span><span class="n">RW_LOADED</span><span class="p">);</span>
<span class="p">}</span>



<span class="c1">// objc-loadmethod.mm
</span><span class="c1"></span><span class="cm">/***********************************************************************
</span><span class="cm">* add_class_to_loadable_list
</span><span class="cm">* Class cls has just become connected. Schedule it for +load if
</span><span class="cm">* it implements a +load method.
</span><span class="cm">* cls 刚刚被连接。如果其实现了 +load 方法就将计划调用。
</span><span class="cm">**********************************************************************/</span>
<span class="kt">void</span> <span class="nf">add_class_to_loadable_list</span><span class="p">(</span><span class="kt">Class</span> <span class="n">cls</span><span class="p">)</span>
<span class="p">{</span>
    <span class="kt">IMP</span> <span class="n">method</span><span class="p">;</span>

    <span class="c1">// 断言 loadMethodLock 已锁
</span><span class="c1"></span>    <span class="n">loadMethodLock</span><span class="p">.</span><span class="n">assertLocked</span><span class="p">();</span>

    <span class="c1">// ➡️ 获取类 load 方法
</span><span class="c1"></span>    <span class="n">method</span> <span class="o">=</span> <span class="n">cls</span><span class="o">-&gt;</span><span class="n">getLoadMethod</span><span class="p">();</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">method</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span>  <span class="c1">// Don&#39;t bother if cls has no +load method 没有 +load 就返回
</span><span class="c1"></span>
    <span class="c1">// Xcode 中 OBJC_PRINT_LOAD_METHODS 环境变量值为 YES 时，将可在控制台打印该信息
</span><span class="c1"></span>    <span class="c1">// OPTION(PrintLoading, OBJC_PRINT_LOAD_METHODS, &#34;log calls to class and category +load methods&#34;)
</span><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="n">PrintLoading</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">_objc_inform</span><span class="p">(</span><span class="s">&#34;LOAD: class &#39;%s&#39; scheduled for +load&#34;</span><span class="p">,</span>
                     <span class="n">cls</span><span class="o">-&gt;</span><span class="n">nameForLogging</span><span class="p">());</span>
    <span class="p">}</span>

    <span class="c1">// 如果使用的 == 分配的，需要扩容
</span><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="n">loadable_classes_used</span> <span class="o">==</span> <span class="n">loadable_classes_allocated</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">loadable_classes_allocated</span> <span class="o">=</span> <span class="n">loadable_classes_allocated</span><span class="o">*</span><span class="mi">2</span> <span class="o">+</span> <span class="mi">16</span><span class="p">;</span>
        <span class="n">loadable_classes</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">loadable_class</span> <span class="o">*</span><span class="p">)</span>
            <span class="n">realloc</span><span class="p">(</span><span class="n">loadable_classes</span><span class="p">,</span>
                              <span class="n">loadable_classes_allocated</span> <span class="o">*</span>
                              <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">loadable_class</span><span class="p">));</span>
    <span class="p">}</span>

    <span class="c1">// 添加到 loadable_classes（将在 call_class_loads 中实际调用）
</span><span class="c1"></span>    <span class="n">loadable_classes</span><span class="p">[</span><span class="n">loadable_classes_used</span><span class="p">].</span><span class="n">cls</span> <span class="o">=</span> <span class="n">cls</span><span class="p">;</span>
    <span class="n">loadable_classes</span><span class="p">[</span><span class="n">loadable_classes_used</span><span class="p">].</span><span class="n">method</span> <span class="o">=</span> <span class="n">method</span><span class="p">;</span>
    <span class="n">loadable_classes_used</span><span class="o">++</span><span class="p">;</span>
<span class="p">}</span>

<span class="c1">// objc-runtime-new.mm
</span><span class="c1"></span><span class="cm">/***********************************************************************
</span><span class="cm">* objc_class::getLoadMethod
</span><span class="cm">* fixme
</span><span class="cm">* Called only from add_class_to_loadable_list.
</span><span class="cm">* 只在 add_class_to_loadable_list 中调用。
</span><span class="cm">* Locking: runtimeLock must be read- or write-locked by the caller.
</span><span class="cm">* 锁：runtimeLock 必须由调用者读取或写入锁定。
</span><span class="cm">**********************************************************************/</span>
<span class="kt">IMP</span>
<span class="n">objc_class</span><span class="o">::</span><span class="n">getLoadMethod</span><span class="p">()</span>
<span class="p">{</span>
    <span class="n">runtimeLock</span><span class="p">.</span><span class="n">assertLocked</span><span class="p">();</span>

    <span class="k">const</span> <span class="n">method_list_t</span> <span class="o">*</span><span class="n">mlist</span><span class="p">;</span>

    <span class="c1">// 断言
</span><span class="c1"></span>    <span class="n">assert</span><span class="p">(</span><span class="n">isRealized</span><span class="p">());</span>
    <span class="n">assert</span><span class="p">(</span><span class="n">ISA</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">isRealized</span><span class="p">());</span>
    <span class="n">assert</span><span class="p">(</span><span class="o">!</span><span class="n">isMetaClass</span><span class="p">());</span>
    <span class="n">assert</span><span class="p">(</span><span class="n">ISA</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">isMetaClass</span><span class="p">());</span>

    <span class="c1">// 从只读列表中读取 baseMethods（可参考「iOS 中的 NSObject」）
</span><span class="c1"></span>    <span class="n">mlist</span> <span class="o">=</span> <span class="n">ISA</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">ro</span><span class="o">-&gt;</span><span class="n">baseMethods</span><span class="p">();</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">mlist</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">// 遍历
</span><span class="c1"></span>        <span class="k">for</span> <span class="p">(</span><span class="k">const</span> <span class="k">auto</span><span class="o">&amp;</span> <span class="nl">meth</span> <span class="p">:</span> <span class="o">*</span><span class="n">mlist</span><span class="p">)</span> <span class="p">{</span>
            <span class="c1">// 获取 selector 名称
</span><span class="c1"></span>            <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span> <span class="o">=</span> <span class="n">sel_cname</span><span class="p">(</span><span class="n">meth</span><span class="p">.</span><span class="n">name</span><span class="p">);</span>
            <span class="k">if</span> <span class="p">(</span><span class="mi">0</span> <span class="o">==</span> <span class="n">strcmp</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="s">&#34;load&#34;</span><span class="p">))</span> <span class="p">{</span>
                <span class="c1">// 若为 load 方法，则返回 IMP
</span><span class="c1"></span>                <span class="k">return</span> <span class="n">meth</span><span class="p">.</span><span class="n">imp</span><span class="p">;</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="nb">nil</span><span class="p">;</span>
<span class="p">}</span>

<span class="c1">// objc-loadmethod.mm
</span><span class="c1"></span><span class="cm">/***********************************************************************
</span><span class="cm">* add_category_to_loadable_list
</span><span class="cm">* Category cat&#39;s parent class exists and the category has been attached
</span><span class="cm">* to its class. Schedule this category for +load after its parent class
</span><span class="cm">* becomes connected and has its own +load method called.
</span><span class="cm">* 分类 cat 的主类存在，且分类已经连接到主类的类上了。在父类连接且调用了 +load 后计划调用该分类的 +load。
</span><span class="cm">**********************************************************************/</span>
<span class="kt">void</span> <span class="n">add_category_to_loadable_list</span><span class="p">(</span><span class="n">Category</span> <span class="n">cat</span><span class="p">)</span>
<span class="p">{</span>
    <span class="kt">IMP</span> <span class="n">method</span><span class="p">;</span>

    <span class="c1">// 断言 loadMethodLock 已锁
</span><span class="c1"></span>    <span class="n">loadMethodLock</span><span class="p">.</span><span class="n">assertLocked</span><span class="p">();</span>

    <span class="c1">// ➡️ 获取分类 load 方法
</span><span class="c1"></span>    <span class="n">method</span> <span class="o">=</span> <span class="n">_category_getLoadMethod</span><span class="p">(</span><span class="n">cat</span><span class="p">);</span>

    <span class="c1">// Don&#39;t bother if cat has no +load method
</span><span class="c1"></span>    <span class="c1">// 没有 +load 就返回
</span><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">method</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span>

    <span class="c1">// OPTION(PrintLoading, OBJC_PRINT_LOAD_METHODS, &#34;log calls to class and category +load methods&#34;)
</span><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="n">PrintLoading</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">_objc_inform</span><span class="p">(</span><span class="s">&#34;LOAD: category &#39;%s(%s)&#39; scheduled for +load&#34;</span><span class="p">,</span>
                     <span class="n">_category_getClassName</span><span class="p">(</span><span class="n">cat</span><span class="p">),</span> <span class="n">_category_getName</span><span class="p">(</span><span class="n">cat</span><span class="p">));</span>
    <span class="p">}</span>

    <span class="c1">// 如果使用的 == 分配的，需要扩容
</span><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="n">loadable_categories_used</span> <span class="o">==</span> <span class="n">loadable_categories_allocated</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">loadable_categories_allocated</span> <span class="o">=</span> <span class="n">loadable_categories_allocated</span><span class="o">*</span><span class="mi">2</span> <span class="o">+</span> <span class="mi">16</span><span class="p">;</span>
        <span class="n">loadable_categories</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">loadable_category</span> <span class="o">*</span><span class="p">)</span>
            <span class="n">realloc</span><span class="p">(</span><span class="n">loadable_categories</span><span class="p">,</span>
                              <span class="n">loadable_categories_allocated</span> <span class="o">*</span>
                              <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">loadable_category</span><span class="p">));</span>
    <span class="p">}</span>

	 <span class="c1">// 存入 loadable_categories（将在 call_category_loads 中实际调用）
</span><span class="c1"></span>    <span class="n">loadable_categories</span><span class="p">[</span><span class="n">loadable_categories_used</span><span class="p">].</span><span class="n">cat</span> <span class="o">=</span> <span class="n">cat</span><span class="p">;</span>
    <span class="n">loadable_categories</span><span class="p">[</span><span class="n">loadable_categories_used</span><span class="p">].</span><span class="n">method</span> <span class="o">=</span> <span class="n">method</span><span class="p">;</span>
    <span class="n">loadable_categories_used</span><span class="o">++</span><span class="p">;</span>
<span class="p">}</span>

<span class="c1">// objc-runtime-new.mm
</span><span class="c1"></span><span class="cm">/***********************************************************************
</span><span class="cm">* _category_getLoadMethod
</span><span class="cm">* fixme
</span><span class="cm">* Called only from add_category_to_loadable_list
</span><span class="cm">* 只在 add_category_to_loadable_list 中调用
</span><span class="cm">* Locking: runtimeLock must be read- or write-locked by the caller
</span><span class="cm">* 锁：runtimeLock 必须由调用者读取或写入锁定。
</span><span class="cm">**********************************************************************/</span>
<span class="kt">IMP</span>
<span class="n">_category_getLoadMethod</span><span class="p">(</span><span class="n">Category</span> <span class="n">cat</span><span class="p">)</span>
<span class="p">{</span>
    <span class="c1">// 断言 loadMethodLock 已锁
</span><span class="c1"></span>    <span class="n">runtimeLock</span><span class="p">.</span><span class="n">assertLocked</span><span class="p">();</span>

    <span class="k">const</span> <span class="n">method_list_t</span> <span class="o">*</span><span class="n">mlist</span><span class="p">;</span>

    <span class="c1">// 分类中类方法列表
</span><span class="c1"></span>    <span class="n">mlist</span> <span class="o">=</span> <span class="n">cat</span><span class="o">-&gt;</span><span class="n">classMethods</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">mlist</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">// 遍历
</span><span class="c1"></span>        <span class="k">for</span> <span class="p">(</span><span class="k">const</span> <span class="k">auto</span><span class="o">&amp;</span> <span class="nl">meth</span> <span class="p">:</span> <span class="o">*</span><span class="n">mlist</span><span class="p">)</span> <span class="p">{</span>
            <span class="c1">// 获取 selector 名称
</span><span class="c1"></span>            <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span> <span class="o">=</span> <span class="n">sel_cname</span><span class="p">(</span><span class="n">meth</span><span class="p">.</span><span class="n">name</span><span class="p">);</span>
            <span class="k">if</span> <span class="p">(</span><span class="mi">0</span> <span class="o">==</span> <span class="n">strcmp</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="s">&#34;load&#34;</span><span class="p">))</span> <span class="p">{</span>
                <span class="c1">// 若为 load 方法，则返回 IMP
</span><span class="c1"></span>                <span class="k">return</span> <span class="n">meth</span><span class="p">.</span><span class="n">imp</span><span class="p">;</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="nb">nil</span><span class="p">;</span>
<span class="p">}</span>

<span class="c1">// objc-loadmethod.mm
</span><span class="c1"></span><span class="cm">/***********************************************************************
</span><span class="cm">* call_load_methods
</span><span class="cm">* Call all pending class and category +load methods.
</span><span class="cm">* 调用所有类和分类的 +load  方法。
</span><span class="cm">* Class +load methods are called superclass-first.
</span><span class="cm">* 类的 +load 方法将先调用父类的。
</span><span class="cm">* Category +load methods are not called until after the parent class&#39;s +load.
</span><span class="cm">* 分类的 +load 才需要等到其主类的 +load 调用后才调用。
</span><span class="cm">*
</span><span class="cm">* This method must be RE-ENTRANT, because a +load could trigger
</span><span class="cm">* more image mapping. In addition, the superclass-first ordering
</span><span class="cm">* must be preserved in the face of re-entrant calls. Therefore,
</span><span class="cm">* only the OUTERMOST call of this function will do anything, and
</span><span class="cm">* that call will handle all loadable classes, even those generated
</span><span class="cm">* while it was running.
</span><span class="cm">* 该方法必须是可重入的（线程安全的），因为 +load 可能触发更多镜像映射。
</span><span class="cm">* 另外，面对可重入调用时，必须保留父类优先排序。
</span><span class="cm">* 因此，只有当该函数在最后调用才会执行全部操作，且该调用将处理所有可加载的类，甚至是在运行时生成的类。
</span><span class="cm">*
</span><span class="cm">* The sequence below preserves +load ordering in the face of
</span><span class="cm">* image loading during a +load, and make sure that no
</span><span class="cm">* +load method is forgotten because it was added during
</span><span class="cm">* a +load call.
</span><span class="cm">* 下面的顺序保留了在面对 +load 中加载镜像的 +load 排序，并且因为它是在一个 +load 调用中被添加的，因此可以保证没有 +load 被遗忘，。
</span><span class="cm">* Sequence:
</span><span class="cm">* 顺序
</span><span class="cm">* 1. Repeatedly call class +loads until there aren&#39;t any more
</span><span class="cm">* 1. 重复调用类 +load 直到不再有未调用的 +load
</span><span class="cm">* 2. Call category +loads ONCE.
</span><span class="cm">* 2. 调用分类 +load 一次
</span><span class="cm">* 3. Run more +loads if:
</span><span class="cm">* 3. 执行多次 +load 的情况：
</span><span class="cm">*    (a) there are more classes to load, OR
</span><span class="cm">*    (a) 有多个类要加载，或者
</span><span class="cm">*    (b) there are some potential category +loads that have
</span><span class="cm">*        still never been attempted.
</span><span class="cm">*    (b) 有一些潜在的分类 +load 仍未尝试。
</span><span class="cm">* Category +loads are only run once to ensure &#34;parent class first&#34;
</span><span class="cm">* ordering, even if a category +load triggers a new loadable class
</span><span class="cm">* and a new loadable category attached to that class.
</span><span class="cm">* 分类中的 +load 只会被执行一次，并保证「父类优先」排序，尽管一个分类的 +load 触发了一个新的可加载的类以及附加该类的一个新的可加载的分类。
</span><span class="cm">*
</span><span class="cm">* Locking: loadMethodLock must be held by the caller
</span><span class="cm">* 锁：loadMethodLock 必须由调用者持有
</span><span class="cm">*   All other locks must not be held.
</span><span class="cm">*   所有其它锁必须不持有。
</span><span class="cm">**********************************************************************/</span>
<span class="kt">void</span> <span class="n">call_load_methods</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">static</span> <span class="kt">bool</span> <span class="n">loading</span> <span class="o">=</span> <span class="nb">NO</span><span class="p">;</span>
    <span class="kt">bool</span> <span class="n">more_categories</span><span class="p">;</span>

    <span class="c1">// 断言 loadMethodLock 已锁
</span><span class="c1"></span>    <span class="n">loadMethodLock</span><span class="p">.</span><span class="n">assertLocked</span><span class="p">();</span>

    <span class="c1">// Re-entrant calls do nothing; the outermost call will finish the job.
</span><span class="c1"></span>    <span class="c1">// 重入的调用不做事情，最早的调用将完成任务
</span><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="n">loading</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span>
    <span class="n">loading</span> <span class="o">=</span> <span class="nb">YES</span><span class="p">;</span>

    <span class="kt">void</span> <span class="o">*</span><span class="n">pool</span> <span class="o">=</span> <span class="n">objc_autoreleasePoolPush</span><span class="p">();</span>

    <span class="k">do</span> <span class="p">{</span>
        <span class="c1">// 1. Repeatedly call class +loads until there aren&#39;t any more
</span><span class="c1"></span>        <span class="c1">// 1. 重复调用类 +load，直到全部调用到
</span><span class="c1"></span>        <span class="k">while</span> <span class="p">(</span><span class="n">loadable_classes_used</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
            <span class="c1">// ➡️ 调用类的 +load 方法
</span><span class="c1"></span>            <span class="n">call_class_loads</span><span class="p">();</span>
        <span class="p">}</span>

        <span class="c1">// 2. Call category +loads ONCE
</span><span class="c1"></span>        <span class="c1">// 2. ➡️ 调用分类 +load 一次
</span><span class="c1"></span>        <span class="n">more_categories</span> <span class="o">=</span> <span class="n">call_category_loads</span><span class="p">();</span>

        <span class="c1">// 3. Run more +loads if there are classes OR more untried categories
</span><span class="c1"></span>        <span class="c1">// 3.如果有类或者更多未尝试的分类则运行更多的 +load
</span><span class="c1"></span>    <span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">loadable_classes_used</span> <span class="o">&gt;</span> <span class="mi">0</span>  <span class="o">||</span>  <span class="n">more_categories</span><span class="p">);</span>

    <span class="n">objc_autoreleasePoolPop</span><span class="p">(</span><span class="n">pool</span><span class="p">);</span>

    <span class="n">loading</span> <span class="o">=</span> <span class="nb">NO</span><span class="p">;</span>
<span class="p">}</span>

<span class="c1">// objc-loadmethod.mm
</span><span class="c1"></span><span class="cm">/***********************************************************************
</span><span class="cm">* call_class_loads
</span><span class="cm">* Call all pending class +load methods.
</span><span class="cm">* 调用所有类的 +load 方法。
</span><span class="cm">* If new classes become loadable, +load is NOT called for them.
</span><span class="cm">* 如果有新的类变为可加载的，它们的 +load 不会被调用
</span><span class="cm">*
</span><span class="cm">* Called only by call_load_methods().
</span><span class="cm">* 只能由 call_load_methods() 调用。
</span><span class="cm">**********************************************************************/</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">call_class_loads</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
    <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

    <span class="c1">// Detach current loadable list.
</span><span class="c1"></span>    <span class="c1">// 分离当前可加载列表。
</span><span class="c1"></span>    <span class="k">struct</span> <span class="n">loadable_class</span> <span class="o">*</span><span class="n">classes</span> <span class="o">=</span> <span class="n">loadable_classes</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">used</span> <span class="o">=</span> <span class="n">loadable_classes_used</span><span class="p">;</span>
    <span class="n">loadable_classes</span> <span class="o">=</span> <span class="nb">nil</span><span class="p">;</span>
    <span class="n">loadable_classes_allocated</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">loadable_classes_used</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

    <span class="c1">// Call all +loads for the detached list.
</span><span class="c1"></span>    <span class="c1">// 在分离的表中调用所有 +load。
</span><span class="c1"></span>    <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">used</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
        <span class="kt">Class</span> <span class="n">cls</span> <span class="o">=</span> <span class="n">classes</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">cls</span><span class="p">;</span>
        <span class="n">load_method_t</span> <span class="n">load_method</span> <span class="o">=</span> <span class="p">(</span><span class="n">load_method_t</span><span class="p">)</span><span class="n">classes</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">method</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cls</span><span class="p">)</span> <span class="k">continue</span><span class="p">;</span>

        <span class="c1">// OPTION(PrintLoading, OBJC_PRINT_LOAD_METHODS, &#34;log calls to class and category +load methods&#34;)
</span><span class="c1"></span>        <span class="k">if</span> <span class="p">(</span><span class="n">PrintLoading</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">_objc_inform</span><span class="p">(</span><span class="s">&#34;LOAD: +[%s load]</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">cls</span><span class="o">-&gt;</span><span class="n">nameForLogging</span><span class="p">());</span>
        <span class="p">}</span>
        <span class="c1">// 💡 调用 +load
</span><span class="c1"></span>        <span class="p">(</span><span class="o">*</span><span class="n">load_method</span><span class="p">)(</span><span class="n">cls</span><span class="p">,</span> <span class="n">SEL_load</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="c1">// Destroy the detached list.
</span><span class="c1"></span>    <span class="c1">// 销毁分离列表
</span><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="n">classes</span><span class="p">)</span> <span class="n">free</span><span class="p">(</span><span class="n">classes</span><span class="p">);</span>
<span class="p">}</span>

<span class="c1">// objc-loadmethod.mm
</span><span class="c1"></span><span class="cm">/***********************************************************************
</span><span class="cm">* call_category_loads
</span><span class="cm">* Call some pending category +load methods.
</span><span class="cm">* 调用一些分类中未调用的 +load 方法。
</span><span class="cm">* The parent class of the +load-implementing categories has all of
</span><span class="cm">*   its categories attached, in case some are lazily waiting for +initalize.
</span><span class="cm">* 实现 +load 分类的父类拥有所有其附加的分类 ，来防止等待 +initialize 懒加载。
</span><span class="cm">*
</span><span class="cm">* Don&#39;t call +load unless the parent class is connected.
</span><span class="cm">* If new categories become loadable, +load is NOT called, and they
</span><span class="cm">*   are added to the end of the loadable list, and we return TRUE.
</span><span class="cm">* Return FALSE if no new categories became loadable.
</span><span class="cm">* 除非父类已经连接，否则不要调用 +load。
</span><span class="cm">* 如果新的分类变成可加载的，+load 未被调用，并且它们被添加到可加载列表的末尾，返回 TRUE。
</span><span class="cm">* 如果没有新的分类变为可加载的，返回 FALSE。
</span><span class="cm">*
</span><span class="cm">* Called only by call_load_methods().
</span><span class="cm">* 只能由 call_load_methods() 调用。
</span><span class="cm">**********************************************************************/</span>
<span class="k">static</span> <span class="kt">bool</span> <span class="n">call_category_loads</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
    <span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">shift</span><span class="p">;</span>
    <span class="kt">bool</span> <span class="n">new_categories_added</span> <span class="o">=</span> <span class="nb">NO</span><span class="p">;</span>

    <span class="c1">// Detach current loadable list.
</span><span class="c1"></span>    <span class="c1">// 分离当前可加载列表。
</span><span class="c1"></span>    <span class="k">struct</span> <span class="n">loadable_category</span> <span class="o">*</span><span class="n">cats</span> <span class="o">=</span> <span class="n">loadable_categories</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">used</span> <span class="o">=</span> <span class="n">loadable_categories_used</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">allocated</span> <span class="o">=</span> <span class="n">loadable_categories_allocated</span><span class="p">;</span>
    <span class="n">loadable_categories</span> <span class="o">=</span> <span class="nb">nil</span><span class="p">;</span>
    <span class="n">loadable_categories_allocated</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">loadable_categories_used</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

    <span class="c1">// Call all +loads for the detached list.
</span><span class="c1"></span>    <span class="c1">// 为分离的列表调用所有的 +load。
</span><span class="c1"></span>    <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">used</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">Category</span> <span class="n">cat</span> <span class="o">=</span> <span class="n">cats</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">cat</span><span class="p">;</span>
        <span class="n">load_method_t</span> <span class="n">load_method</span> <span class="o">=</span> <span class="p">(</span><span class="n">load_method_t</span><span class="p">)</span><span class="n">cats</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">method</span><span class="p">;</span>
        <span class="kt">Class</span> <span class="n">cls</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cat</span><span class="p">)</span> <span class="k">continue</span><span class="p">;</span>

        <span class="c1">// 获取主类
</span><span class="c1"></span>        <span class="n">cls</span> <span class="o">=</span> <span class="n">_category_getClass</span><span class="p">(</span><span class="n">cat</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">cls</span>  <span class="o">&amp;&amp;</span>  <span class="n">cls</span><span class="o">-&gt;</span><span class="n">isLoadable</span><span class="p">())</span> <span class="p">{</span>
            <span class="c1">// OPTION(PrintLoading, OBJC_PRINT_LOAD_METHODS, &#34;log calls to class and category +load methods&#34;)
</span><span class="c1"></span>            <span class="k">if</span> <span class="p">(</span><span class="n">PrintLoading</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">_objc_inform</span><span class="p">(</span><span class="s">&#34;LOAD: +[%s(%s) load]</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span>
                             <span class="n">cls</span><span class="o">-&gt;</span><span class="n">nameForLogging</span><span class="p">(),</span>
                             <span class="n">_category_getName</span><span class="p">(</span><span class="n">cat</span><span class="p">));</span>
            <span class="p">}</span>
            <span class="c1">// 💡 调用 +load
</span><span class="c1"></span>            <span class="p">(</span><span class="o">*</span><span class="n">load_method</span><span class="p">)(</span><span class="n">cls</span><span class="p">,</span> <span class="n">SEL_load</span><span class="p">);</span>
            <span class="c1">// 置为空
</span><span class="c1"></span>            <span class="n">cats</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">cat</span> <span class="o">=</span> <span class="nb">nil</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="c1">// Compact detached list (order-preserving)
</span><span class="c1"></span>    <span class="c1">// 压缩分离列表（保留顺序）
</span><span class="c1"></span>    <span class="n">shift</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">used</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">cats</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">cat</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">cats</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="n">shift</span><span class="p">]</span> <span class="o">=</span> <span class="n">cats</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="n">shift</span><span class="o">++</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="n">used</span> <span class="o">-=</span> <span class="n">shift</span><span class="p">;</span>

    <span class="c1">// Copy any new +load candidates from the new list to the detached list.
</span><span class="c1"></span>    <span class="c1">// 从新的列表中拷贝所有新的 +load 候选到分离列表。
</span><span class="c1"></span>    <span class="n">new_categories_added</span> <span class="o">=</span> <span class="p">(</span><span class="n">loadable_categories_used</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">);</span>
    <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">loadable_categories_used</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">used</span> <span class="o">==</span> <span class="n">allocated</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">allocated</span> <span class="o">=</span> <span class="n">allocated</span><span class="o">*</span><span class="mi">2</span> <span class="o">+</span> <span class="mi">16</span><span class="p">;</span>
            <span class="n">cats</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">loadable_category</span> <span class="o">*</span><span class="p">)</span>
                <span class="n">realloc</span><span class="p">(</span><span class="n">cats</span><span class="p">,</span> <span class="n">allocated</span> <span class="o">*</span>
                                  <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">loadable_category</span><span class="p">));</span>
        <span class="p">}</span>
        <span class="n">cats</span><span class="p">[</span><span class="n">used</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">loadable_categories</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
    <span class="p">}</span>

    <span class="c1">// Destroy the new list.
</span><span class="c1"></span>    <span class="c1">// 销毁新列表
</span><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="n">loadable_categories</span><span class="p">)</span> <span class="n">free</span><span class="p">(</span><span class="n">loadable_categories</span><span class="p">);</span>

    <span class="c1">// Reattach the (now augmented) detached list.
</span><span class="c1"></span>    <span class="c1">// 重新附加（现在已增加的）分离列表。
</span><span class="c1"></span>    <span class="c1">// But if there&#39;s nothing left to load, destroy the list.
</span><span class="c1"></span>    <span class="c1">// 但是如果没有什么要加载的，则销毁该列表。
</span><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="n">used</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">loadable_categories</span> <span class="o">=</span> <span class="n">cats</span><span class="p">;</span>
        <span class="n">loadable_categories_used</span> <span class="o">=</span> <span class="n">used</span><span class="p">;</span>
        <span class="n">loadable_categories_allocated</span> <span class="o">=</span> <span class="n">allocated</span><span class="p">;</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">cats</span><span class="p">)</span> <span class="n">free</span><span class="p">(</span><span class="n">cats</span><span class="p">);</span>
        <span class="n">loadable_categories</span> <span class="o">=</span> <span class="nb">nil</span><span class="p">;</span>
        <span class="n">loadable_categories_used</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="n">loadable_categories_allocated</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">PrintLoading</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">loadable_categories_used</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">_objc_inform</span><span class="p">(</span><span class="s">&#34;LOAD: %d categories still waiting for +load</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span>
                         <span class="n">loadable_categories_used</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="n">new_categories_added</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div><p>上面的源码过程比较复杂，其实主要顺序就是先在 <code>prepare_load_methods</code> 中调用 <code>schedule_class_load</code>，先计划类的 +load 方法调用顺序，在其中会递归找到基类，并 <code>add_class_to_loadable_list</code> 将类中 +load 的 <code>IMP</code> 存储在 <code>loadable_classes</code>；之后在 <code>prepare_load_methods</code> 中调用 <code>add_category_to_loadable_list</code>，再将分类中 +load 的 <code>IMP</code> 存储在 <code>loadable_categories</code>；当类和分类的可加载列表确定后，预备（Prepare）工作完成；之后开始 <code>call_load_methods</code>，调用 <code>call_class_loads</code> 将类中的 +load 全部调用完毕，再调用 <code>call_category_loads</code> 将分类中的 +load 全部调用完毕。这也就完全符合了我们上述的结论，至于毫无关系的类之间以及分类相互之间的调用顺序，由于 <code>loadable_classes</code> 和 <code>loadable_categories</code> 的增加都是按顺序追加，即按照编译顺序来决定，先编译先调用。具体的编译顺序可以在 Xcode -「TARGETS」 -「Build Phases」-「Compile Sources」中找到。</p>
<p><img src="/img/2019/+load_in_ios/2.png" alt="2"></p>
<h3 id="imp-与-load">IMP 与 +load</h3>
<p>按照我们之前在「iOS 中的 Category」一篇所提到的，当分类中定义了和主类中相同的方法，那么在调用时将选择最后被编译的分类中的实现。因为在运行时，分类中的方法最终将附加到主类或主类元类的方法列表中，最终将返回第一个找到的方法。那么为什么 +load 如此特殊呢？</p>
<div class="highlight"><pre class="chroma"><code class="language-objectivec" data-lang="objectivec"><span class="c1">// add_class_to_loadable_list
</span><span class="c1"></span><span class="n">loadable_classes</span><span class="p">[</span><span class="n">loadable_classes_used</span><span class="p">].</span><span class="n">cls</span> <span class="o">=</span> <span class="n">cls</span><span class="p">;</span>
<span class="n">loadable_classes</span><span class="p">[</span><span class="n">loadable_classes_used</span><span class="p">].</span><span class="n">method</span> <span class="o">=</span> <span class="n">method</span><span class="p">;</span>

<span class="c1">// objc-loadmethod.mm
</span><span class="c1"></span><span class="k">typedef</span> <span class="nf">void</span><span class="p">(</span><span class="o">*</span><span class="n">load_method_t</span><span class="p">)(</span><span class="kt">id</span><span class="p">,</span> <span class="kt">SEL</span><span class="p">);</span>

<span class="n">load_method_t</span> <span class="n">load_method</span> <span class="o">=</span> <span class="p">(</span><span class="n">load_method_t</span><span class="p">)</span><span class="n">classes</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">method</span><span class="p">;</span>
<span class="p">(</span><span class="o">*</span><span class="n">load_method</span><span class="p">)(</span><span class="n">cls</span><span class="p">,</span> <span class="n">SEL_load</span><span class="p">);</span>
</code></pre></div><p>我们知道，Obj-C 是一门消息机制语言，所谓方法调用是不严谨的，其本质是消息发送（Message Sending），即 <code>objc_msgSend</code>。当「调用」对象方法时，类对象接收到消息作出响应；当「调用」类方法时，元类对象接收到消息作出响应。而在 +load 最终的调用处只是 <code>(*load_method)(cls, SEL_load)</code>，并不存在消息的发送。我们在 <code>add_class_to_loadable_list</code> 中也可以看到，+load 方法本质是存储了方法指针（IMP）并直接调用，因此不会出现类似「覆盖」的情形，而且效率会更高。</p>
<div class="highlight"><pre class="chroma"><code class="language-objectivec" data-lang="objectivec"><span class="cp">#import &#34;Student.h&#34;
</span><span class="cp"></span>
<span class="k">@implementation</span> <span class="nc">Student</span>
<span class="p">+</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">load</span> <span class="p">{</span>
    <span class="p">[</span><span class="nb">super</span> <span class="n">load</span><span class="p">];</span>
    <span class="n">NSLog</span><span class="p">(</span><span class="s">@&#34;Student %s&#34;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
<span class="p">}</span>
<span class="k">@end</span>

<span class="c1">// OUTPUT:
</span><span class="c1">// Person +[Person load]
</span><span class="c1">// Person+Work +[Person(Work) load]
</span><span class="c1">// Student +[Student load]
</span><span class="c1">// Person+Life +[Person(Life) load]
</span><span class="c1">// Student+School +[Student(School) load]
</span><span class="c1">// Person+Work +[Person(Work) load]
</span><span class="c1">// Hello, World!
</span></code></pre></div><p>那么有了上述基础，当我们在一个类的子类的 +load 中 <code>[super load]</code> 又会调用到到底哪个类中呢（当然，在实际开发中这种情几乎不可能存在）？答案就是 <code>[super load]</code> 将调用到 <code>Person</code> 最后一个被编译的分类（<code>Person+Work</code>）中的 <code>+load</code> 方法，因为这里是消息发送，而不是通过方法指针。</p>
<h3 id="objc_print_load_methods">OBJC_PRINT_LOAD_METHODS</h3>
<p>在 objc4 的源码中提供了很多环境变量，方便我们 Debug 时输出一些内部源码的执行信息。<code>OBJC_PRINT_LOAD_METHODS</code> 即是 <code>+load</code> 相关的一个环境变量，将 <code>OBJC_PRINT_LOAD_METHODS</code> 在 Xcode 中设置为 <code>YES</code> 后，将会打印出很多 +load 方法执行时的信息。从下面的信息我们也可以得知，Obj-C 内也广泛使用了 +load，而因为我们自定义的类会在最晚被编译，因此也会在最晚去调用：</p>
<details>
<summary>-> 点击此处即可查看完整内容 <-</summary>
<div class="highlight"><pre class="chroma"><code class="language-objectivec" data-lang="objectivec"><span class="n">objc</span><span class="p">[</span><span class="mi">63382</span><span class="p">]</span><span class="o">:</span> <span class="nl">LOAD</span><span class="p">:</span> <span class="k">class</span> <span class="err">&#39;</span><span class="n">NSObject</span><span class="err">&#39;</span> <span class="n">scheduled</span> <span class="k">for</span> <span class="o">+</span><span class="n">load</span>
<span class="n">objc</span><span class="p">[</span><span class="mi">63382</span><span class="p">]</span><span class="o">:</span> <span class="nl">LOAD</span><span class="p">:</span> <span class="k">class</span> <span class="err">&#39;</span><span class="n">OS_dispatch_queue</span><span class="err">&#39;</span> <span class="n">scheduled</span> <span class="k">for</span> <span class="o">+</span><span class="n">load</span>
<span class="n">objc</span><span class="p">[</span><span class="mi">63382</span><span class="p">]</span><span class="o">:</span> <span class="nl">LOAD</span><span class="p">:</span> <span class="k">class</span> <span class="err">&#39;</span><span class="n">OS_dispatch_source</span><span class="err">&#39;</span> <span class="n">scheduled</span> <span class="k">for</span> <span class="o">+</span><span class="n">load</span>
<span class="n">objc</span><span class="p">[</span><span class="mi">63382</span><span class="p">]</span><span class="o">:</span> <span class="nl">LOAD</span><span class="p">:</span> <span class="k">class</span> <span class="err">&#39;</span><span class="n">OS_dispatch_mach</span><span class="err">&#39;</span> <span class="n">scheduled</span> <span class="k">for</span> <span class="o">+</span><span class="n">load</span>
<span class="n">objc</span><span class="p">[</span><span class="mi">63382</span><span class="p">]</span><span class="o">:</span> <span class="nl">LOAD</span><span class="p">:</span> <span class="k">class</span> <span class="err">&#39;</span><span class="n">OS_dispatch_queue_serial</span><span class="err">&#39;</span> <span class="n">scheduled</span> <span class="k">for</span> <span class="o">+</span><span class="n">load</span>
<span class="n">objc</span><span class="p">[</span><span class="mi">63382</span><span class="p">]</span><span class="o">:</span> <span class="nl">LOAD</span><span class="p">:</span> <span class="k">class</span> <span class="err">&#39;</span><span class="n">OS_dispatch_queue_runloop</span><span class="err">&#39;</span> <span class="n">scheduled</span> <span class="k">for</span> <span class="o">+</span><span class="n">load</span>
<span class="n">objc</span><span class="p">[</span><span class="mi">63382</span><span class="p">]</span><span class="o">:</span> <span class="nl">LOAD</span><span class="p">:</span> <span class="k">class</span> <span class="err">&#39;</span><span class="n">OS_dispatch_semaphore</span><span class="err">&#39;</span> <span class="n">scheduled</span> <span class="k">for</span> <span class="o">+</span><span class="n">load</span>
<span class="n">objc</span><span class="p">[</span><span class="mi">63382</span><span class="p">]</span><span class="o">:</span> <span class="nl">LOAD</span><span class="p">:</span> <span class="k">class</span> <span class="err">&#39;</span><span class="n">OS_dispatch_group</span><span class="err">&#39;</span> <span class="n">scheduled</span> <span class="k">for</span> <span class="o">+</span><span class="n">load</span>
<span class="n">objc</span><span class="p">[</span><span class="mi">63382</span><span class="p">]</span><span class="o">:</span> <span class="nl">LOAD</span><span class="p">:</span> <span class="k">class</span> <span class="err">&#39;</span><span class="n">OS_dispatch_workloop</span><span class="err">&#39;</span> <span class="n">scheduled</span> <span class="k">for</span> <span class="o">+</span><span class="n">load</span>
<span class="n">objc</span><span class="p">[</span><span class="mi">63382</span><span class="p">]</span><span class="o">:</span> <span class="nl">LOAD</span><span class="p">:</span> <span class="k">class</span> <span class="err">&#39;</span><span class="n">OS_dispatch_queue_concurrent</span><span class="err">&#39;</span> <span class="n">scheduled</span> <span class="k">for</span> <span class="o">+</span><span class="n">load</span>
<span class="n">objc</span><span class="p">[</span><span class="mi">63382</span><span class="p">]</span><span class="o">:</span> <span class="nl">LOAD</span><span class="p">:</span> <span class="k">class</span> <span class="err">&#39;</span><span class="n">OS_dispatch_queue_main</span><span class="err">&#39;</span> <span class="n">scheduled</span> <span class="k">for</span> <span class="o">+</span><span class="n">load</span>
<span class="n">objc</span><span class="p">[</span><span class="mi">63382</span><span class="p">]</span><span class="o">:</span> <span class="nl">LOAD</span><span class="p">:</span> <span class="k">class</span> <span class="err">&#39;</span><span class="n">OS_dispatch_queue_global</span><span class="err">&#39;</span> <span class="n">scheduled</span> <span class="k">for</span> <span class="o">+</span><span class="n">load</span>
<span class="n">objc</span><span class="p">[</span><span class="mi">63382</span><span class="p">]</span><span class="o">:</span> <span class="nl">LOAD</span><span class="p">:</span> <span class="k">class</span> <span class="err">&#39;</span><span class="n">OS_dispatch_queue_pthread_root</span><span class="err">&#39;</span> <span class="n">scheduled</span> <span class="k">for</span> <span class="o">+</span><span class="n">load</span>
<span class="n">objc</span><span class="p">[</span><span class="mi">63382</span><span class="p">]</span><span class="o">:</span> <span class="nl">LOAD</span><span class="p">:</span> <span class="k">class</span> <span class="err">&#39;</span><span class="n">OS_dispatch_queue_mgr</span><span class="err">&#39;</span> <span class="n">scheduled</span> <span class="k">for</span> <span class="o">+</span><span class="n">load</span>
<span class="n">objc</span><span class="p">[</span><span class="mi">63382</span><span class="p">]</span><span class="o">:</span> <span class="nl">LOAD</span><span class="p">:</span> <span class="k">class</span> <span class="err">&#39;</span><span class="n">OS_dispatch_queue_attr</span><span class="err">&#39;</span> <span class="n">scheduled</span> <span class="k">for</span> <span class="o">+</span><span class="n">load</span>
<span class="n">objc</span><span class="p">[</span><span class="mi">63382</span><span class="p">]</span><span class="o">:</span> <span class="nl">LOAD</span><span class="p">:</span> <span class="k">class</span> <span class="err">&#39;</span><span class="n">OS_dispatch_mach_msg</span><span class="err">&#39;</span> <span class="n">scheduled</span> <span class="k">for</span> <span class="o">+</span><span class="n">load</span>
<span class="n">objc</span><span class="p">[</span><span class="mi">63382</span><span class="p">]</span><span class="o">:</span> <span class="nl">LOAD</span><span class="p">:</span> <span class="k">class</span> <span class="err">&#39;</span><span class="n">OS_dispatch_io</span><span class="err">&#39;</span> <span class="n">scheduled</span> <span class="k">for</span> <span class="o">+</span><span class="n">load</span>
<span class="n">objc</span><span class="p">[</span><span class="mi">63382</span><span class="p">]</span><span class="o">:</span> <span class="nl">LOAD</span><span class="p">:</span> <span class="k">class</span> <span class="err">&#39;</span><span class="n">OS_dispatch_operation</span><span class="err">&#39;</span> <span class="n">scheduled</span> <span class="k">for</span> <span class="o">+</span><span class="n">load</span>
<span class="n">objc</span><span class="p">[</span><span class="mi">63382</span><span class="p">]</span><span class="o">:</span> <span class="nl">LOAD</span><span class="p">:</span> <span class="k">class</span> <span class="err">&#39;</span><span class="n">OS_dispatch_disk</span><span class="err">&#39;</span> <span class="n">scheduled</span> <span class="k">for</span> <span class="o">+</span><span class="n">load</span>
<span class="n">objc</span><span class="p">[</span><span class="mi">63382</span><span class="p">]</span><span class="o">:</span> <span class="nl">LOAD</span><span class="p">:</span> <span class="k">class</span> <span class="err">&#39;</span><span class="n">OS_voucher</span><span class="err">&#39;</span> <span class="n">scheduled</span> <span class="k">for</span> <span class="o">+</span><span class="n">load</span>
<span class="n">objc</span><span class="p">[</span><span class="mi">63382</span><span class="p">]</span><span class="o">:</span> <span class="nl">LOAD</span><span class="p">:</span> <span class="k">class</span> <span class="err">&#39;</span><span class="n">OS_dispatch_data_empty</span><span class="err">&#39;</span> <span class="n">scheduled</span> <span class="k">for</span> <span class="o">+</span><span class="n">load</span>
<span class="n">objc</span><span class="p">[</span><span class="mi">63382</span><span class="p">]</span><span class="o">:</span> <span class="nl">LOAD</span><span class="p">:</span> <span class="o">+</span><span class="p">[</span><span class="n">NSObject</span> <span class="n">load</span><span class="p">]</span>

<span class="n">objc</span><span class="p">[</span><span class="mi">63382</span><span class="p">]</span><span class="o">:</span> <span class="nl">LOAD</span><span class="p">:</span> <span class="o">+</span><span class="p">[</span><span class="n">OS_dispatch_queue</span> <span class="n">load</span><span class="p">]</span>

<span class="n">objc</span><span class="p">[</span><span class="mi">63382</span><span class="p">]</span><span class="o">:</span> <span class="nl">LOAD</span><span class="p">:</span> <span class="o">+</span><span class="p">[</span><span class="n">OS_dispatch_source</span> <span class="n">load</span><span class="p">]</span>

<span class="n">objc</span><span class="p">[</span><span class="mi">63382</span><span class="p">]</span><span class="o">:</span> <span class="nl">LOAD</span><span class="p">:</span> <span class="o">+</span><span class="p">[</span><span class="n">OS_dispatch_mach</span> <span class="n">load</span><span class="p">]</span>

<span class="n">objc</span><span class="p">[</span><span class="mi">63382</span><span class="p">]</span><span class="o">:</span> <span class="nl">LOAD</span><span class="p">:</span> <span class="o">+</span><span class="p">[</span><span class="n">OS_dispatch_queue_serial</span> <span class="n">load</span><span class="p">]</span>

<span class="n">objc</span><span class="p">[</span><span class="mi">63382</span><span class="p">]</span><span class="o">:</span> <span class="nl">LOAD</span><span class="p">:</span> <span class="o">+</span><span class="p">[</span><span class="n">OS_dispatch_queue_runloop</span> <span class="n">load</span><span class="p">]</span>

<span class="n">objc</span><span class="p">[</span><span class="mi">63382</span><span class="p">]</span><span class="o">:</span> <span class="nl">LOAD</span><span class="p">:</span> <span class="o">+</span><span class="p">[</span><span class="n">OS_dispatch_semaphore</span> <span class="n">load</span><span class="p">]</span>

<span class="n">objc</span><span class="p">[</span><span class="mi">63382</span><span class="p">]</span><span class="o">:</span> <span class="nl">LOAD</span><span class="p">:</span> <span class="o">+</span><span class="p">[</span><span class="n">OS_dispatch_group</span> <span class="n">load</span><span class="p">]</span>

<span class="n">objc</span><span class="p">[</span><span class="mi">63382</span><span class="p">]</span><span class="o">:</span> <span class="nl">LOAD</span><span class="p">:</span> <span class="o">+</span><span class="p">[</span><span class="n">OS_dispatch_workloop</span> <span class="n">load</span><span class="p">]</span>

<span class="n">objc</span><span class="p">[</span><span class="mi">63382</span><span class="p">]</span><span class="o">:</span> <span class="nl">LOAD</span><span class="p">:</span> <span class="o">+</span><span class="p">[</span><span class="n">OS_dispatch_queue_concurrent</span> <span class="n">load</span><span class="p">]</span>

<span class="n">objc</span><span class="p">[</span><span class="mi">63382</span><span class="p">]</span><span class="o">:</span> <span class="nl">LOAD</span><span class="p">:</span> <span class="o">+</span><span class="p">[</span><span class="n">OS_dispatch_queue_main</span> <span class="n">load</span><span class="p">]</span>

<span class="n">objc</span><span class="p">[</span><span class="mi">63382</span><span class="p">]</span><span class="o">:</span> <span class="nl">LOAD</span><span class="p">:</span> <span class="o">+</span><span class="p">[</span><span class="n">OS_dispatch_queue_global</span> <span class="n">load</span><span class="p">]</span>

<span class="n">objc</span><span class="p">[</span><span class="mi">63382</span><span class="p">]</span><span class="o">:</span> <span class="nl">LOAD</span><span class="p">:</span> <span class="o">+</span><span class="p">[</span><span class="n">OS_dispatch_queue_pthread_root</span> <span class="n">load</span><span class="p">]</span>

<span class="n">objc</span><span class="p">[</span><span class="mi">63382</span><span class="p">]</span><span class="o">:</span> <span class="nl">LOAD</span><span class="p">:</span> <span class="o">+</span><span class="p">[</span><span class="n">OS_dispatch_queue_mgr</span> <span class="n">load</span><span class="p">]</span>

<span class="n">objc</span><span class="p">[</span><span class="mi">63382</span><span class="p">]</span><span class="o">:</span> <span class="nl">LOAD</span><span class="p">:</span> <span class="o">+</span><span class="p">[</span><span class="n">OS_dispatch_queue_attr</span> <span class="n">load</span><span class="p">]</span>

<span class="n">objc</span><span class="p">[</span><span class="mi">63382</span><span class="p">]</span><span class="o">:</span> <span class="nl">LOAD</span><span class="p">:</span> <span class="o">+</span><span class="p">[</span><span class="n">OS_dispatch_mach_msg</span> <span class="n">load</span><span class="p">]</span>

<span class="n">objc</span><span class="p">[</span><span class="mi">63382</span><span class="p">]</span><span class="o">:</span> <span class="nl">LOAD</span><span class="p">:</span> <span class="o">+</span><span class="p">[</span><span class="n">OS_dispatch_io</span> <span class="n">load</span><span class="p">]</span>

<span class="n">objc</span><span class="p">[</span><span class="mi">63382</span><span class="p">]</span><span class="o">:</span> <span class="nl">LOAD</span><span class="p">:</span> <span class="o">+</span><span class="p">[</span><span class="n">OS_dispatch_operation</span> <span class="n">load</span><span class="p">]</span>

<span class="n">objc</span><span class="p">[</span><span class="mi">63382</span><span class="p">]</span><span class="o">:</span> <span class="nl">LOAD</span><span class="p">:</span> <span class="o">+</span><span class="p">[</span><span class="n">OS_dispatch_disk</span> <span class="n">load</span><span class="p">]</span>

<span class="n">objc</span><span class="p">[</span><span class="mi">63382</span><span class="p">]</span><span class="o">:</span> <span class="nl">LOAD</span><span class="p">:</span> <span class="o">+</span><span class="p">[</span><span class="n">OS_voucher</span> <span class="n">load</span><span class="p">]</span>

<span class="n">objc</span><span class="p">[</span><span class="mi">63382</span><span class="p">]</span><span class="o">:</span> <span class="nl">LOAD</span><span class="p">:</span> <span class="o">+</span><span class="p">[</span><span class="n">OS_dispatch_data_empty</span> <span class="n">load</span><span class="p">]</span>

<span class="n">objc</span><span class="p">[</span><span class="mi">63382</span><span class="p">]</span><span class="o">:</span> <span class="nl">LOAD</span><span class="p">:</span> <span class="k">class</span> <span class="err">&#39;</span><span class="n">OS_os_log</span><span class="err">&#39;</span> <span class="n">scheduled</span> <span class="k">for</span> <span class="o">+</span><span class="n">load</span>
<span class="n">objc</span><span class="p">[</span><span class="mi">63382</span><span class="p">]</span><span class="o">:</span> <span class="nl">LOAD</span><span class="p">:</span> <span class="k">class</span> <span class="err">&#39;</span><span class="n">OS_os_activity</span><span class="err">&#39;</span> <span class="n">scheduled</span> <span class="k">for</span> <span class="o">+</span><span class="n">load</span>
<span class="n">objc</span><span class="p">[</span><span class="mi">63382</span><span class="p">]</span><span class="o">:</span> <span class="nl">LOAD</span><span class="p">:</span> <span class="o">+</span><span class="p">[</span><span class="n">OS_os_log</span> <span class="n">load</span><span class="p">]</span>

<span class="n">objc</span><span class="p">[</span><span class="mi">63382</span><span class="p">]</span><span class="o">:</span> <span class="nl">LOAD</span><span class="p">:</span> <span class="o">+</span><span class="p">[</span><span class="n">OS_os_activity</span> <span class="n">load</span><span class="p">]</span>

<span class="n">objc</span><span class="p">[</span><span class="mi">63382</span><span class="p">]</span><span class="o">:</span> <span class="nl">LOAD</span><span class="p">:</span> <span class="k">class</span> <span class="err">&#39;</span><span class="n">OS_xpc_connection</span><span class="err">&#39;</span> <span class="n">scheduled</span> <span class="k">for</span> <span class="o">+</span><span class="n">load</span>
<span class="n">objc</span><span class="p">[</span><span class="mi">63382</span><span class="p">]</span><span class="o">:</span> <span class="nl">LOAD</span><span class="p">:</span> <span class="k">class</span> <span class="err">&#39;</span><span class="n">OS_xpc_service</span><span class="err">&#39;</span> <span class="n">scheduled</span> <span class="k">for</span> <span class="o">+</span><span class="n">load</span>
<span class="n">objc</span><span class="p">[</span><span class="mi">63382</span><span class="p">]</span><span class="o">:</span> <span class="nl">LOAD</span><span class="p">:</span> <span class="k">class</span> <span class="err">&#39;</span><span class="n">OS_xpc_null</span><span class="err">&#39;</span> <span class="n">scheduled</span> <span class="k">for</span> <span class="o">+</span><span class="n">load</span>
<span class="n">objc</span><span class="p">[</span><span class="mi">63382</span><span class="p">]</span><span class="o">:</span> <span class="nl">LOAD</span><span class="p">:</span> <span class="k">class</span> <span class="err">&#39;</span><span class="n">OS_xpc_bool</span><span class="err">&#39;</span> <span class="n">scheduled</span> <span class="k">for</span> <span class="o">+</span><span class="n">load</span>
<span class="n">objc</span><span class="p">[</span><span class="mi">63382</span><span class="p">]</span><span class="o">:</span> <span class="nl">LOAD</span><span class="p">:</span> <span class="k">class</span> <span class="err">&#39;</span><span class="n">OS_xpc_double</span><span class="err">&#39;</span> <span class="n">scheduled</span> <span class="k">for</span> <span class="o">+</span><span class="n">load</span>
<span class="n">objc</span><span class="p">[</span><span class="mi">63382</span><span class="p">]</span><span class="o">:</span> <span class="nl">LOAD</span><span class="p">:</span> <span class="k">class</span> <span class="err">&#39;</span><span class="n">OS_xpc_pointer</span><span class="err">&#39;</span> <span class="n">scheduled</span> <span class="k">for</span> <span class="o">+</span><span class="n">load</span>
<span class="n">objc</span><span class="p">[</span><span class="mi">63382</span><span class="p">]</span><span class="o">:</span> <span class="nl">LOAD</span><span class="p">:</span> <span class="k">class</span> <span class="err">&#39;</span><span class="n">OS_xpc_date</span><span class="err">&#39;</span> <span class="n">scheduled</span> <span class="k">for</span> <span class="o">+</span><span class="n">load</span>
<span class="n">objc</span><span class="p">[</span><span class="mi">63382</span><span class="p">]</span><span class="o">:</span> <span class="nl">LOAD</span><span class="p">:</span> <span class="k">class</span> <span class="err">&#39;</span><span class="n">OS_xpc_data</span><span class="err">&#39;</span> <span class="n">scheduled</span> <span class="k">for</span> <span class="o">+</span><span class="n">load</span>
<span class="n">objc</span><span class="p">[</span><span class="mi">63382</span><span class="p">]</span><span class="o">:</span> <span class="nl">LOAD</span><span class="p">:</span> <span class="k">class</span> <span class="err">&#39;</span><span class="n">OS_xpc_string</span><span class="err">&#39;</span> <span class="n">scheduled</span> <span class="k">for</span> <span class="o">+</span><span class="n">load</span>
<span class="n">objc</span><span class="p">[</span><span class="mi">63382</span><span class="p">]</span><span class="o">:</span> <span class="nl">LOAD</span><span class="p">:</span> <span class="k">class</span> <span class="err">&#39;</span><span class="n">OS_xpc_uuid</span><span class="err">&#39;</span> <span class="n">scheduled</span> <span class="k">for</span> <span class="o">+</span><span class="n">load</span>
<span class="n">objc</span><span class="p">[</span><span class="mi">63382</span><span class="p">]</span><span class="o">:</span> <span class="nl">LOAD</span><span class="p">:</span> <span class="k">class</span> <span class="err">&#39;</span><span class="n">OS_xpc_fd</span><span class="err">&#39;</span> <span class="n">scheduled</span> <span class="k">for</span> <span class="o">+</span><span class="n">load</span>
<span class="n">objc</span><span class="p">[</span><span class="mi">63382</span><span class="p">]</span><span class="o">:</span> <span class="nl">LOAD</span><span class="p">:</span> <span class="k">class</span> <span class="err">&#39;</span><span class="n">OS_xpc_shmem</span><span class="err">&#39;</span> <span class="n">scheduled</span> <span class="k">for</span> <span class="o">+</span><span class="n">load</span>
<span class="n">objc</span><span class="p">[</span><span class="mi">63382</span><span class="p">]</span><span class="o">:</span> <span class="nl">LOAD</span><span class="p">:</span> <span class="k">class</span> <span class="err">&#39;</span><span class="n">OS_xpc_mach_send</span><span class="err">&#39;</span> <span class="n">scheduled</span> <span class="k">for</span> <span class="o">+</span><span class="n">load</span>
<span class="n">objc</span><span class="p">[</span><span class="mi">63382</span><span class="p">]</span><span class="o">:</span> <span class="nl">LOAD</span><span class="p">:</span> <span class="k">class</span> <span class="err">&#39;</span><span class="n">OS_xpc_array</span><span class="err">&#39;</span> <span class="n">scheduled</span> <span class="k">for</span> <span class="o">+</span><span class="n">load</span>
<span class="n">objc</span><span class="p">[</span><span class="mi">63382</span><span class="p">]</span><span class="o">:</span> <span class="nl">LOAD</span><span class="p">:</span> <span class="k">class</span> <span class="err">&#39;</span><span class="n">OS_xpc_dictionary</span><span class="err">&#39;</span> <span class="n">scheduled</span> <span class="k">for</span> <span class="o">+</span><span class="n">load</span>
<span class="n">objc</span><span class="p">[</span><span class="mi">63382</span><span class="p">]</span><span class="o">:</span> <span class="nl">LOAD</span><span class="p">:</span> <span class="k">class</span> <span class="err">&#39;</span><span class="n">OS_xpc_error</span><span class="err">&#39;</span> <span class="n">scheduled</span> <span class="k">for</span> <span class="o">+</span><span class="n">load</span>
<span class="n">objc</span><span class="p">[</span><span class="mi">63382</span><span class="p">]</span><span class="o">:</span> <span class="nl">LOAD</span><span class="p">:</span> <span class="k">class</span> <span class="err">&#39;</span><span class="n">OS_xpc_endpoint</span><span class="err">&#39;</span> <span class="n">scheduled</span> <span class="k">for</span> <span class="o">+</span><span class="n">load</span>
<span class="n">objc</span><span class="p">[</span><span class="mi">63382</span><span class="p">]</span><span class="o">:</span> <span class="nl">LOAD</span><span class="p">:</span> <span class="k">class</span> <span class="err">&#39;</span><span class="n">OS_xpc_serializer</span><span class="err">&#39;</span> <span class="n">scheduled</span> <span class="k">for</span> <span class="o">+</span><span class="n">load</span>
<span class="n">objc</span><span class="p">[</span><span class="mi">63382</span><span class="p">]</span><span class="o">:</span> <span class="nl">LOAD</span><span class="p">:</span> <span class="k">class</span> <span class="err">&#39;</span><span class="n">OS_xpc_pipe</span><span class="err">&#39;</span> <span class="n">scheduled</span> <span class="k">for</span> <span class="o">+</span><span class="n">load</span>
<span class="n">objc</span><span class="p">[</span><span class="mi">63382</span><span class="p">]</span><span class="o">:</span> <span class="nl">LOAD</span><span class="p">:</span> <span class="k">class</span> <span class="err">&#39;</span><span class="n">OS_xpc_mach_recv</span><span class="err">&#39;</span> <span class="n">scheduled</span> <span class="k">for</span> <span class="o">+</span><span class="n">load</span>
<span class="n">objc</span><span class="p">[</span><span class="mi">63382</span><span class="p">]</span><span class="o">:</span> <span class="nl">LOAD</span><span class="p">:</span> <span class="k">class</span> <span class="err">&#39;</span><span class="n">OS_xpc_bundle</span><span class="err">&#39;</span> <span class="n">scheduled</span> <span class="k">for</span> <span class="o">+</span><span class="n">load</span>
<span class="n">objc</span><span class="p">[</span><span class="mi">63382</span><span class="p">]</span><span class="o">:</span> <span class="nl">LOAD</span><span class="p">:</span> <span class="k">class</span> <span class="err">&#39;</span><span class="n">OS_xpc_service_instance</span><span class="err">&#39;</span> <span class="n">scheduled</span> <span class="k">for</span> <span class="o">+</span><span class="n">load</span>
<span class="n">objc</span><span class="p">[</span><span class="mi">63382</span><span class="p">]</span><span class="o">:</span> <span class="nl">LOAD</span><span class="p">:</span> <span class="k">class</span> <span class="err">&#39;</span><span class="n">OS_xpc_activity</span><span class="err">&#39;</span> <span class="n">scheduled</span> <span class="k">for</span> <span class="o">+</span><span class="n">load</span>
<span class="n">objc</span><span class="p">[</span><span class="mi">63382</span><span class="p">]</span><span class="o">:</span> <span class="nl">LOAD</span><span class="p">:</span> <span class="k">class</span> <span class="err">&#39;</span><span class="n">OS_xpc_file_transfer</span><span class="err">&#39;</span> <span class="n">scheduled</span> <span class="k">for</span> <span class="o">+</span><span class="n">load</span>
<span class="n">objc</span><span class="p">[</span><span class="mi">63382</span><span class="p">]</span><span class="o">:</span> <span class="nl">LOAD</span><span class="p">:</span> <span class="k">class</span> <span class="err">&#39;</span><span class="n">OS_xpc_int64</span><span class="err">&#39;</span> <span class="n">scheduled</span> <span class="k">for</span> <span class="o">+</span><span class="n">load</span>
<span class="n">objc</span><span class="p">[</span><span class="mi">63382</span><span class="p">]</span><span class="o">:</span> <span class="nl">LOAD</span><span class="p">:</span> <span class="k">class</span> <span class="err">&#39;</span><span class="n">OS_xpc_uint64</span><span class="err">&#39;</span> <span class="n">scheduled</span> <span class="k">for</span> <span class="o">+</span><span class="n">load</span>
<span class="n">objc</span><span class="p">[</span><span class="mi">63382</span><span class="p">]</span><span class="o">:</span> <span class="nl">LOAD</span><span class="p">:</span> <span class="o">+</span><span class="p">[</span><span class="n">OS_xpc_connection</span> <span class="n">load</span><span class="p">]</span>

<span class="n">objc</span><span class="p">[</span><span class="mi">63382</span><span class="p">]</span><span class="o">:</span> <span class="nl">LOAD</span><span class="p">:</span> <span class="o">+</span><span class="p">[</span><span class="n">OS_xpc_service</span> <span class="n">load</span><span class="p">]</span>

<span class="n">objc</span><span class="p">[</span><span class="mi">63382</span><span class="p">]</span><span class="o">:</span> <span class="nl">LOAD</span><span class="p">:</span> <span class="o">+</span><span class="p">[</span><span class="n">OS_xpc_null</span> <span class="n">load</span><span class="p">]</span>

<span class="n">objc</span><span class="p">[</span><span class="mi">63382</span><span class="p">]</span><span class="o">:</span> <span class="nl">LOAD</span><span class="p">:</span> <span class="o">+</span><span class="p">[</span><span class="n">OS_xpc_bool</span> <span class="n">load</span><span class="p">]</span>

<span class="n">objc</span><span class="p">[</span><span class="mi">63382</span><span class="p">]</span><span class="o">:</span> <span class="nl">LOAD</span><span class="p">:</span> <span class="o">+</span><span class="p">[</span><span class="n">OS_xpc_double</span> <span class="n">load</span><span class="p">]</span>

<span class="n">objc</span><span class="p">[</span><span class="mi">63382</span><span class="p">]</span><span class="o">:</span> <span class="nl">LOAD</span><span class="p">:</span> <span class="o">+</span><span class="p">[</span><span class="n">OS_xpc_pointer</span> <span class="n">load</span><span class="p">]</span>

<span class="n">objc</span><span class="p">[</span><span class="mi">63382</span><span class="p">]</span><span class="o">:</span> <span class="nl">LOAD</span><span class="p">:</span> <span class="o">+</span><span class="p">[</span><span class="n">OS_xpc_date</span> <span class="n">load</span><span class="p">]</span>

<span class="n">objc</span><span class="p">[</span><span class="mi">63382</span><span class="p">]</span><span class="o">:</span> <span class="nl">LOAD</span><span class="p">:</span> <span class="o">+</span><span class="p">[</span><span class="n">OS_xpc_data</span> <span class="n">load</span><span class="p">]</span>

<span class="n">objc</span><span class="p">[</span><span class="mi">63382</span><span class="p">]</span><span class="o">:</span> <span class="nl">LOAD</span><span class="p">:</span> <span class="o">+</span><span class="p">[</span><span class="n">OS_xpc_string</span> <span class="n">load</span><span class="p">]</span>

<span class="n">objc</span><span class="p">[</span><span class="mi">63382</span><span class="p">]</span><span class="o">:</span> <span class="nl">LOAD</span><span class="p">:</span> <span class="o">+</span><span class="p">[</span><span class="n">OS_xpc_uuid</span> <span class="n">load</span><span class="p">]</span>

<span class="n">objc</span><span class="p">[</span><span class="mi">63382</span><span class="p">]</span><span class="o">:</span> <span class="nl">LOAD</span><span class="p">:</span> <span class="o">+</span><span class="p">[</span><span class="n">OS_xpc_fd</span> <span class="n">load</span><span class="p">]</span>

<span class="n">objc</span><span class="p">[</span><span class="mi">63382</span><span class="p">]</span><span class="o">:</span> <span class="nl">LOAD</span><span class="p">:</span> <span class="o">+</span><span class="p">[</span><span class="n">OS_xpc_shmem</span> <span class="n">load</span><span class="p">]</span>

<span class="n">objc</span><span class="p">[</span><span class="mi">63382</span><span class="p">]</span><span class="o">:</span> <span class="nl">LOAD</span><span class="p">:</span> <span class="o">+</span><span class="p">[</span><span class="n">OS_xpc_mach_send</span> <span class="n">load</span><span class="p">]</span>

<span class="n">objc</span><span class="p">[</span><span class="mi">63382</span><span class="p">]</span><span class="o">:</span> <span class="nl">LOAD</span><span class="p">:</span> <span class="o">+</span><span class="p">[</span><span class="n">OS_xpc_array</span> <span class="n">load</span><span class="p">]</span>

<span class="n">objc</span><span class="p">[</span><span class="mi">63382</span><span class="p">]</span><span class="o">:</span> <span class="nl">LOAD</span><span class="p">:</span> <span class="o">+</span><span class="p">[</span><span class="n">OS_xpc_dictionary</span> <span class="n">load</span><span class="p">]</span>

<span class="n">objc</span><span class="p">[</span><span class="mi">63382</span><span class="p">]</span><span class="o">:</span> <span class="nl">LOAD</span><span class="p">:</span> <span class="o">+</span><span class="p">[</span><span class="n">OS_xpc_error</span> <span class="n">load</span><span class="p">]</span>

<span class="n">objc</span><span class="p">[</span><span class="mi">63382</span><span class="p">]</span><span class="o">:</span> <span class="nl">LOAD</span><span class="p">:</span> <span class="o">+</span><span class="p">[</span><span class="n">OS_xpc_endpoint</span> <span class="n">load</span><span class="p">]</span>

<span class="n">objc</span><span class="p">[</span><span class="mi">63382</span><span class="p">]</span><span class="o">:</span> <span class="nl">LOAD</span><span class="p">:</span> <span class="o">+</span><span class="p">[</span><span class="n">OS_xpc_serializer</span> <span class="n">load</span><span class="p">]</span>

<span class="n">objc</span><span class="p">[</span><span class="mi">63382</span><span class="p">]</span><span class="o">:</span> <span class="nl">LOAD</span><span class="p">:</span> <span class="o">+</span><span class="p">[</span><span class="n">OS_xpc_pipe</span> <span class="n">load</span><span class="p">]</span>

<span class="n">objc</span><span class="p">[</span><span class="mi">63382</span><span class="p">]</span><span class="o">:</span> <span class="nl">LOAD</span><span class="p">:</span> <span class="o">+</span><span class="p">[</span><span class="n">OS_xpc_mach_recv</span> <span class="n">load</span><span class="p">]</span>

<span class="n">objc</span><span class="p">[</span><span class="mi">63382</span><span class="p">]</span><span class="o">:</span> <span class="nl">LOAD</span><span class="p">:</span> <span class="o">+</span><span class="p">[</span><span class="n">OS_xpc_bundle</span> <span class="n">load</span><span class="p">]</span>

<span class="n">objc</span><span class="p">[</span><span class="mi">63382</span><span class="p">]</span><span class="o">:</span> <span class="nl">LOAD</span><span class="p">:</span> <span class="o">+</span><span class="p">[</span><span class="n">OS_xpc_service_instance</span> <span class="n">load</span><span class="p">]</span>

<span class="n">objc</span><span class="p">[</span><span class="mi">63382</span><span class="p">]</span><span class="o">:</span> <span class="nl">LOAD</span><span class="p">:</span> <span class="o">+</span><span class="p">[</span><span class="n">OS_xpc_activity</span> <span class="n">load</span><span class="p">]</span>

<span class="n">objc</span><span class="p">[</span><span class="mi">63382</span><span class="p">]</span><span class="o">:</span> <span class="nl">LOAD</span><span class="p">:</span> <span class="o">+</span><span class="p">[</span><span class="n">OS_xpc_file_transfer</span> <span class="n">load</span><span class="p">]</span>

<span class="n">objc</span><span class="p">[</span><span class="mi">63382</span><span class="p">]</span><span class="o">:</span> <span class="nl">LOAD</span><span class="p">:</span> <span class="o">+</span><span class="p">[</span><span class="n">OS_xpc_int64</span> <span class="n">load</span><span class="p">]</span>

<span class="n">objc</span><span class="p">[</span><span class="mi">63382</span><span class="p">]</span><span class="o">:</span> <span class="nl">LOAD</span><span class="p">:</span> <span class="o">+</span><span class="p">[</span><span class="n">OS_xpc_uint64</span> <span class="n">load</span><span class="p">]</span>

<span class="n">objc</span><span class="p">[</span><span class="mi">63382</span><span class="p">]</span><span class="o">:</span> <span class="nl">LOAD</span><span class="p">:</span> <span class="k">class</span> <span class="err">&#39;</span><span class="n">__IncompleteProtocol</span><span class="err">&#39;</span> <span class="n">scheduled</span> <span class="k">for</span> <span class="o">+</span><span class="n">load</span>
<span class="n">objc</span><span class="p">[</span><span class="mi">63382</span><span class="p">]</span><span class="o">:</span> <span class="nl">LOAD</span><span class="p">:</span> <span class="k">class</span> <span class="err">&#39;</span><span class="n">Protocol</span><span class="err">&#39;</span> <span class="n">scheduled</span> <span class="k">for</span> <span class="o">+</span><span class="n">load</span>
<span class="n">objc</span><span class="p">[</span><span class="mi">63382</span><span class="p">]</span><span class="o">:</span> <span class="nl">LOAD</span><span class="p">:</span> <span class="k">class</span> <span class="err">&#39;</span><span class="n">__NSUnrecognizedTaggedPointer</span><span class="err">&#39;</span> <span class="n">scheduled</span> <span class="k">for</span> <span class="o">+</span><span class="n">load</span>
<span class="n">objc</span><span class="p">[</span><span class="mi">63382</span><span class="p">]</span><span class="o">:</span> <span class="nl">LOAD</span><span class="p">:</span> <span class="o">+</span><span class="p">[</span><span class="n">__IncompleteProtocol</span> <span class="n">load</span><span class="p">]</span>

<span class="n">objc</span><span class="p">[</span><span class="mi">63382</span><span class="p">]</span><span class="o">:</span> <span class="nl">LOAD</span><span class="p">:</span> <span class="o">+</span><span class="p">[</span><span class="n">Protocol</span> <span class="n">load</span><span class="p">]</span>

<span class="n">objc</span><span class="p">[</span><span class="mi">63382</span><span class="p">]</span><span class="o">:</span> <span class="nl">LOAD</span><span class="p">:</span> <span class="o">+</span><span class="p">[</span><span class="n">__NSUnrecognizedTaggedPointer</span> <span class="n">load</span><span class="p">]</span>

<span class="n">objc</span><span class="p">[</span><span class="mi">63382</span><span class="p">]</span><span class="o">:</span> <span class="nl">LOAD</span><span class="p">:</span> <span class="n">category</span> <span class="err">&#39;</span><span class="n">NSObject</span><span class="p">(</span><span class="n">NSObject</span><span class="p">)</span><span class="err">&#39;</span> <span class="n">scheduled</span> <span class="k">for</span> <span class="o">+</span><span class="n">load</span>
<span class="n">objc</span><span class="p">[</span><span class="mi">63382</span><span class="p">]</span><span class="o">:</span> <span class="nl">LOAD</span><span class="p">:</span> <span class="o">+</span><span class="p">[</span><span class="n">NSObject</span><span class="p">(</span><span class="n">NSObject</span><span class="p">)</span> <span class="n">load</span><span class="p">]</span>

<span class="n">objc</span><span class="p">[</span><span class="mi">63382</span><span class="p">]</span><span class="o">:</span> <span class="nl">LOAD</span><span class="p">:</span> <span class="n">category</span> <span class="err">&#39;</span><span class="n">NSObject</span><span class="p">(</span><span class="n">NSObject</span><span class="p">)</span><span class="err">&#39;</span> <span class="n">scheduled</span> <span class="k">for</span> <span class="o">+</span><span class="n">load</span>
<span class="n">objc</span><span class="p">[</span><span class="mi">63382</span><span class="p">]</span><span class="o">:</span> <span class="nl">LOAD</span><span class="p">:</span> <span class="o">+</span><span class="p">[</span><span class="n">NSObject</span><span class="p">(</span><span class="n">NSObject</span><span class="p">)</span> <span class="n">load</span><span class="p">]</span>

<span class="n">objc</span><span class="p">[</span><span class="mi">63382</span><span class="p">]</span><span class="o">:</span> <span class="nl">LOAD</span><span class="p">:</span> <span class="n">category</span> <span class="err">&#39;</span><span class="n">CIFilter</span><span class="p">(</span><span class="n">Interposer</span><span class="p">)</span><span class="err">&#39;</span> <span class="n">scheduled</span> <span class="k">for</span> <span class="o">+</span><span class="n">load</span>
<span class="n">objc</span><span class="p">[</span><span class="mi">63382</span><span class="p">]</span><span class="o">:</span> <span class="nl">LOAD</span><span class="p">:</span> <span class="o">+</span><span class="p">[</span><span class="n">CIFilter</span><span class="p">(</span><span class="n">Interposer</span><span class="p">)</span> <span class="n">load</span><span class="p">]</span>

<span class="n">objc</span><span class="p">[</span><span class="mi">63382</span><span class="p">]</span><span class="o">:</span> <span class="nl">LOAD</span><span class="p">:</span> <span class="k">class</span> <span class="err">&#39;</span><span class="n">NSApplication</span><span class="err">&#39;</span> <span class="n">scheduled</span> <span class="k">for</span> <span class="o">+</span><span class="n">load</span>
<span class="n">objc</span><span class="p">[</span><span class="mi">63382</span><span class="p">]</span><span class="o">:</span> <span class="nl">LOAD</span><span class="p">:</span> <span class="k">class</span> <span class="err">&#39;</span><span class="n">NSBinder</span><span class="err">&#39;</span> <span class="n">scheduled</span> <span class="k">for</span> <span class="o">+</span><span class="n">load</span>
<span class="n">objc</span><span class="p">[</span><span class="mi">63382</span><span class="p">]</span><span class="o">:</span> <span class="nl">LOAD</span><span class="p">:</span> <span class="k">class</span> <span class="err">&#39;</span><span class="n">NSColorSpaceColor</span><span class="err">&#39;</span> <span class="n">scheduled</span> <span class="k">for</span> <span class="o">+</span><span class="n">load</span>
<span class="n">objc</span><span class="p">[</span><span class="mi">63382</span><span class="p">]</span><span class="o">:</span> <span class="nl">LOAD</span><span class="p">:</span> <span class="k">class</span> <span class="err">&#39;</span><span class="n">NSNextStepFrame</span><span class="err">&#39;</span> <span class="n">scheduled</span> <span class="k">for</span> <span class="o">+</span><span class="n">load</span>
<span class="n">objc</span><span class="p">[</span><span class="mi">63382</span><span class="p">]</span><span class="o">:</span> <span class="nl">LOAD</span><span class="p">:</span> <span class="n">category</span> <span class="err">&#39;</span><span class="n">NSBundle</span><span class="p">(</span><span class="n">NSNibLoading</span><span class="p">)</span><span class="err">&#39;</span> <span class="n">scheduled</span> <span class="k">for</span> <span class="o">+</span><span class="n">load</span>
<span class="n">objc</span><span class="p">[</span><span class="mi">63382</span><span class="p">]</span><span class="o">:</span> <span class="nl">LOAD</span><span class="p">:</span> <span class="o">+</span><span class="p">[</span><span class="n">NSApplication</span> <span class="n">load</span><span class="p">]</span>

<span class="n">objc</span><span class="p">[</span><span class="mi">63382</span><span class="p">]</span><span class="o">:</span> <span class="nl">LOAD</span><span class="p">:</span> <span class="o">+</span><span class="p">[</span><span class="n">NSBinder</span> <span class="n">load</span><span class="p">]</span>

<span class="n">objc</span><span class="p">[</span><span class="mi">63382</span><span class="p">]</span><span class="o">:</span> <span class="nl">LOAD</span><span class="p">:</span> <span class="o">+</span><span class="p">[</span><span class="n">NSColorSpaceColor</span> <span class="n">load</span><span class="p">]</span>

<span class="n">objc</span><span class="p">[</span><span class="mi">63382</span><span class="p">]</span><span class="o">:</span> <span class="nl">LOAD</span><span class="p">:</span> <span class="o">+</span><span class="p">[</span><span class="n">NSNextStepFrame</span> <span class="n">load</span><span class="p">]</span>

<span class="n">objc</span><span class="p">[</span><span class="mi">63382</span><span class="p">]</span><span class="o">:</span> <span class="nl">LOAD</span><span class="p">:</span> <span class="o">+</span><span class="p">[</span><span class="n">NSBundle</span><span class="p">(</span><span class="n">NSNibLoading</span><span class="p">)</span> <span class="n">load</span><span class="p">]</span>

<span class="n">objc</span><span class="p">[</span><span class="mi">63382</span><span class="p">]</span><span class="o">:</span> <span class="nl">LOAD</span><span class="p">:</span> <span class="k">class</span> <span class="err">&#39;</span><span class="n">Person</span><span class="err">&#39;</span> <span class="n">scheduled</span> <span class="k">for</span> <span class="o">+</span><span class="n">load</span>
<span class="n">objc</span><span class="p">[</span><span class="mi">63382</span><span class="p">]</span><span class="o">:</span> <span class="nl">LOAD</span><span class="p">:</span> <span class="k">class</span> <span class="err">&#39;</span><span class="n">Student</span><span class="err">&#39;</span> <span class="n">scheduled</span> <span class="k">for</span> <span class="o">+</span><span class="n">load</span>
<span class="n">objc</span><span class="p">[</span><span class="mi">63382</span><span class="p">]</span><span class="o">:</span> <span class="nl">LOAD</span><span class="p">:</span> <span class="n">category</span> <span class="err">&#39;</span><span class="n">Person</span><span class="p">(</span><span class="n">Life</span><span class="p">)</span><span class="err">&#39;</span> <span class="n">scheduled</span> <span class="k">for</span> <span class="o">+</span><span class="n">load</span>
<span class="n">objc</span><span class="p">[</span><span class="mi">63382</span><span class="p">]</span><span class="o">:</span> <span class="nl">LOAD</span><span class="p">:</span> <span class="n">category</span> <span class="err">&#39;</span><span class="n">Student</span><span class="p">(</span><span class="n">School</span><span class="p">)</span><span class="err">&#39;</span> <span class="n">scheduled</span> <span class="k">for</span> <span class="o">+</span><span class="n">load</span>
<span class="n">objc</span><span class="p">[</span><span class="mi">63382</span><span class="p">]</span><span class="o">:</span> <span class="nl">LOAD</span><span class="p">:</span> <span class="n">category</span> <span class="err">&#39;</span><span class="n">Person</span><span class="p">(</span><span class="n">Work</span><span class="p">)</span><span class="err">&#39;</span> <span class="n">scheduled</span> <span class="k">for</span> <span class="o">+</span><span class="n">load</span>
<span class="n">objc</span><span class="p">[</span><span class="mi">63382</span><span class="p">]</span><span class="o">:</span> <span class="nl">LOAD</span><span class="p">:</span> <span class="o">+</span><span class="p">[</span><span class="n">Person</span> <span class="n">load</span><span class="p">]</span>

<span class="mi">2019</span><span class="o">-</span><span class="mo">04</span><span class="o">-</span><span class="mi">20</span> <span class="mi">19</span><span class="o">:</span><span class="mi">25</span><span class="o">:</span><span class="mf">30.541922</span><span class="o">+</span><span class="mi">0800</span> <span class="n">Load_Obj</span><span class="o">-</span><span class="n">C_Demo</span><span class="p">[</span><span class="mi">63382</span><span class="o">:</span><span class="mi">15374262</span><span class="p">]</span> <span class="n">Person</span> <span class="o">+</span><span class="p">[</span><span class="n">Person</span> <span class="n">load</span><span class="p">]</span>
<span class="n">objc</span><span class="p">[</span><span class="mi">63382</span><span class="p">]</span><span class="o">:</span> <span class="nl">LOAD</span><span class="p">:</span> <span class="o">+</span><span class="p">[</span><span class="n">Student</span> <span class="n">load</span><span class="p">]</span>

<span class="mi">2019</span><span class="o">-</span><span class="mo">04</span><span class="o">-</span><span class="mi">20</span> <span class="mi">19</span><span class="o">:</span><span class="mi">25</span><span class="o">:</span><span class="mf">30.542367</span><span class="o">+</span><span class="mi">0800</span> <span class="n">Load_Obj</span><span class="o">-</span><span class="n">C_Demo</span><span class="p">[</span><span class="mi">63382</span><span class="o">:</span><span class="mi">15374262</span><span class="p">]</span> <span class="n">Person</span><span class="o">+</span><span class="n">Work</span> <span class="o">+</span><span class="p">[</span><span class="n">Person</span><span class="p">(</span><span class="n">Work</span><span class="p">)</span> <span class="n">load</span><span class="p">]</span>
<span class="mi">2019</span><span class="o">-</span><span class="mo">04</span><span class="o">-</span><span class="mi">20</span> <span class="mi">19</span><span class="o">:</span><span class="mi">25</span><span class="o">:</span><span class="mf">30.542379</span><span class="o">+</span><span class="mi">0800</span> <span class="n">Load_Obj</span><span class="o">-</span><span class="n">C_Demo</span><span class="p">[</span><span class="mi">63382</span><span class="o">:</span><span class="mi">15374262</span><span class="p">]</span> <span class="n">Student</span> <span class="o">+</span><span class="p">[</span><span class="n">Student</span> <span class="n">load</span><span class="p">]</span>
<span class="n">objc</span><span class="p">[</span><span class="mi">63382</span><span class="p">]</span><span class="o">:</span> <span class="nl">LOAD</span><span class="p">:</span> <span class="o">+</span><span class="p">[</span><span class="n">Person</span><span class="p">(</span><span class="n">Life</span><span class="p">)</span> <span class="n">load</span><span class="p">]</span>

<span class="mi">2019</span><span class="o">-</span><span class="mo">04</span><span class="o">-</span><span class="mi">20</span> <span class="mi">19</span><span class="o">:</span><span class="mi">25</span><span class="o">:</span><span class="mf">30.542409</span><span class="o">+</span><span class="mi">0800</span> <span class="n">Load_Obj</span><span class="o">-</span><span class="n">C_Demo</span><span class="p">[</span><span class="mi">63382</span><span class="o">:</span><span class="mi">15374262</span><span class="p">]</span> <span class="n">Person</span><span class="o">+</span><span class="n">Life</span> <span class="o">+</span><span class="p">[</span><span class="n">Person</span><span class="p">(</span><span class="n">Life</span><span class="p">)</span> <span class="n">load</span><span class="p">]</span>
<span class="n">objc</span><span class="p">[</span><span class="mi">63382</span><span class="p">]</span><span class="o">:</span> <span class="nl">LOAD</span><span class="p">:</span> <span class="o">+</span><span class="p">[</span><span class="n">Student</span><span class="p">(</span><span class="n">School</span><span class="p">)</span> <span class="n">load</span><span class="p">]</span>

<span class="mi">2019</span><span class="o">-</span><span class="mo">04</span><span class="o">-</span><span class="mi">20</span> <span class="mi">19</span><span class="o">:</span><span class="mi">25</span><span class="o">:</span><span class="mf">30.542443</span><span class="o">+</span><span class="mi">0800</span> <span class="n">Load_Obj</span><span class="o">-</span><span class="n">C_Demo</span><span class="p">[</span><span class="mi">63382</span><span class="o">:</span><span class="mi">15374262</span><span class="p">]</span> <span class="n">Student</span><span class="o">+</span><span class="n">School</span> <span class="o">+</span><span class="p">[</span><span class="n">Student</span><span class="p">(</span><span class="n">School</span><span class="p">)</span> <span class="n">load</span><span class="p">]</span>
<span class="n">objc</span><span class="p">[</span><span class="mi">63382</span><span class="p">]</span><span class="o">:</span> <span class="nl">LOAD</span><span class="p">:</span> <span class="o">+</span><span class="p">[</span><span class="n">Person</span><span class="p">(</span><span class="n">Work</span><span class="p">)</span> <span class="n">load</span><span class="p">]</span>

<span class="mi">2019</span><span class="o">-</span><span class="mo">04</span><span class="o">-</span><span class="mi">20</span> <span class="mi">19</span><span class="o">:</span><span class="mi">25</span><span class="o">:</span><span class="mf">30.542473</span><span class="o">+</span><span class="mi">0800</span> <span class="n">Load_Obj</span><span class="o">-</span><span class="n">C_Demo</span><span class="p">[</span><span class="mi">63382</span><span class="o">:</span><span class="mi">15374262</span><span class="p">]</span> <span class="n">Person</span><span class="o">+</span><span class="n">Work</span> <span class="o">+</span><span class="p">[</span><span class="n">Person</span><span class="p">(</span><span class="n">Work</span><span class="p">)</span> <span class="n">load</span><span class="p">]</span>
<span class="mi">2019</span><span class="o">-</span><span class="mo">04</span><span class="o">-</span><span class="mi">20</span> <span class="mi">19</span><span class="o">:</span><span class="mi">25</span><span class="o">:</span><span class="mf">30.542535</span><span class="o">+</span><span class="mi">0800</span> <span class="n">Load_Obj</span><span class="o">-</span><span class="n">C_Demo</span><span class="p">[</span><span class="mi">63382</span><span class="o">:</span><span class="mi">15374262</span><span class="p">]</span> <span class="n">Hello</span><span class="p">,</span> <span class="n">World</span><span class="o">!</span>
</code></pre></div></details>
<h2 id="others">Others</h2>
<h3 id="开销">开销</h3>
<div class="highlight"><pre class="chroma"><code class="language-objectivec" data-lang="objectivec"><span class="k">@interface</span> <span class="nc">Fruit</span> : <span class="nc">NSObject</span>

<span class="k">@end</span>

<span class="k">@implementation</span> <span class="nc">Fruit</span>
<span class="p">+</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">load</span> <span class="p">{</span>
    <span class="n">NSLog</span><span class="p">(</span><span class="s">@&#34;------&#34;</span><span class="p">);</span>
    <span class="n">sleep</span><span class="p">(</span><span class="mi">3</span><span class="p">);</span>
    <span class="n">NSLog</span><span class="p">(</span><span class="s">@&#34;------&#34;</span><span class="p">);</span>
<span class="p">}</span>
<span class="k">@end</span>

<span class="c1">// OUTPUT:
</span><span class="c1">// 2019-04-20 19:23:38.433375+0800 Load_Obj-C_iOS_Demo[63358:15371945] ------
</span><span class="c1">// 2019-04-20 19:23:41.434564+0800 Load_Obj-C_iOS_Demo[63358:15371945] ------
</span></code></pre></div><p>通过上面的分析，我们了解了 +load 在运行时初始化加载镜像时就会被调用，使得可以有机会预先做很多事情。但正是因为其加载的时机非常靠前，如果在 +load 方法中做比较复杂且在主线程的操作，将会影响 app 启动时间，降低用户体验。我们可以尝试建立一个 iOS app，在 +load 中 <code>sleep(3)</code> 模拟做比较复杂的操作，此时每次 app 冷启动都将会有 3 秒以上的时间才能进入 app 主页的控制器，极大的影响了启动时间。</p>
<p>我们可以使用 <code>DYLD_PRINT_STATISTICS_DETAILS</code> 环境变量来控制输出启动统计的相关信息，就可以在 <code>total time in initializers and ObjC +load</code> 中发现 <code>Load_Obj-C_iOS_Demo : 3.0 seconds (74.4%)</code> 占用了大部分时间。</p>
<div class="highlight"><pre class="chroma"><code class="language-text" data-lang="text">  total time: 4.0 seconds (100.0%)
  total images loaded:  258 (0 from dyld shared cache)
  total segments mapped: 767, into 102430 pages with 7398 pages pre-fetched
  total images loading time: 397.50 milliseconds (9.8%)
  total load time in ObjC:  47.34 milliseconds (1.1%)
  total debugger pause time: 189.60 milliseconds (4.6%)
  total dtrace DOF registration time:   0.14 milliseconds (0.0%)
  total rebase fixups:  2,716,086
  total rebase fixups time: 552.17 milliseconds (13.6%)
  total binding fixups: 286,035
  total binding fixups time:  19.12 milliseconds (0.4%)
  total weak binding fixups time:   0.45 milliseconds (0.0%)
  total redo shared cached bindings time:  26.04 milliseconds (0.6%)
  total bindings lazily fixed up: 0 of 0
  total time in initializers and ObjC +load: 3.0 seconds (74.9%)
                         libSystem.B.dylib :   2.99 milliseconds (0.0%)
                libMainThreadChecker.dylib :  10.24 milliseconds (0.2%)
                       Load_Obj-C_iOS_Demo : 3.0 seconds (74.4%)
</code></pre></div><h3 id="swift">Swift</h3>
<p>与我们的老朋友 Obj-C 不同的是，Swift 是一门诞生即宣扬安全、快速、强壮的语言，因此其极大地削弱了 Runtime 这一概念，将大部分检查提前到编译时刻。因此 Swift 中普通的类无需继承自 <code>NSObject</code>，自然也不存在 +load。</p>
<p>而当我们尝试在 Swift 5.x 中继承自 <code>NSObject</code> 来实现 +load 和 +initialize 时，却发现编译器现在已经不允许了：</p>
<div class="highlight"><pre class="chroma"><code class="language-swift" data-lang="swift"><span class="kd">class</span> <span class="nc">Foo</span><span class="p">:</span> <span class="n">NSObject</span> <span class="p">{</span>
    <span class="c1">// Method &#39;load()&#39; defines Objective-C class method &#39;load&#39;, which is not permitted by Swift</span>
    <span class="kd">static</span> <span class="kd">func</span> <span class="nf">load</span><span class="p">()</span> <span class="p">{}</span>

    <span class="c1">// Method &#39;initialize()&#39; defines Objective-C class method &#39;initialize&#39;, which is not permitted by Swift</span>
    <span class="kd">static</span> <span class="kd">func</span> <span class="nf">initialize</span><span class="p">()</span> <span class="p">{}</span>
<span class="p">}</span>
</code></pre></div><p>与以往不同，这次官方连变通方法也没有提供，看来确实不鼓励在 app 启动的 main 函数调用前做太多开销的事情。</p>
<p>我们首先能想到的是使用 Obj-C 混编来定义分类并实现 +load 来达到类似的效果，然而官方已经料到了这一点：「Swift class extensions and categories on Swift classes are not allowed to have +load methods」，不过 +initialize 目前仍是允许的：</p>
<div class="highlight"><pre class="chroma"><code class="language-objectivec" data-lang="objectivec"><span class="k">@interface</span> <span class="nc">SwiftFoo</span> <span class="nl">(SwiftInitialize)</span>
<span class="k">@end</span>

<span class="k">@implementation</span> <span class="nc">SwiftFoo</span> <span class="nl">(SwiftInitialize)</span>
<span class="p">+</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">initialize</span> <span class="p">{</span>
    <span class="p">[</span><span class="n">SwiftFoo</span> <span class="n">swiftInitialize</span><span class="p">];</span>
    <span class="c1">// 或者直接做一些处理
</span><span class="c1"></span><span class="p">}</span>
<span class="k">@end</span>
</code></pre></div><div class="highlight"><pre class="chroma"><code class="language-swift" data-lang="swift"><span class="kd">class</span> <span class="nc">SwiftFoo</span><span class="p">:</span> <span class="n">NSObject</span> <span class="p">{</span>
    <span class="kr">@objc</span> <span class="kd">static</span> <span class="kd">func</span> <span class="nf">swiftInitialize</span><span class="p">()</span> <span class="p">{</span>
        <span class="c1">// Do sth like in +initialize...</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div><p>或者我们也可以根据「<a href="http://jordansmith.io/handling-the-deprecation-of-initialize/">Handling the Deprecation of initialize() - JORDAN SMITH</a>」一文中使用响应链并使用运行时兼容所有非 <code>NSObject</code> 类也可支持类似的效果：</p>
<div class="highlight"><pre class="chroma"><code class="language-swift" data-lang="swift"><span class="kd">protocol</span> <span class="nc">SelfAware</span><span class="p">:</span> <span class="kd">class</span> <span class="p">{</span>
    <span class="kd">static</span> <span class="kd">func</span> <span class="nf">awake</span><span class="p">()</span>
<span class="p">}</span>

<span class="kd">extension</span> <span class="nc">UIApplication</span> <span class="p">{</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">let</span> <span class="nv">runOnce</span><span class="p">:</span> <span class="nb">Void</span> <span class="p">=</span> <span class="p">{</span>
        <span class="kd">let</span> <span class="nv">typeCount</span> <span class="p">=</span> <span class="nb">Int</span><span class="p">(</span><span class="n">objc_getClassList</span><span class="p">(</span><span class="kc">nil</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
        <span class="kd">let</span> <span class="nv">types</span> <span class="p">=</span> <span class="nb">UnsafeMutablePointer</span><span class="p">&lt;</span><span class="nb">AnyClass</span><span class="p">&gt;.</span><span class="n">allocate</span><span class="p">(</span><span class="n">capacity</span><span class="p">:</span> <span class="n">typeCount</span><span class="p">)</span>
        <span class="kd">let</span> <span class="nv">safeTypes</span> <span class="p">=</span> <span class="nb">AutoreleasingUnsafeMutablePointer</span><span class="p">&lt;</span><span class="nb">AnyClass</span><span class="p">&gt;(</span><span class="n">types</span><span class="p">)</span>
        <span class="n">objc_getClassList</span><span class="p">(</span><span class="n">safeTypes</span><span class="p">,</span> <span class="nb">Int32</span><span class="p">(</span><span class="n">typeCount</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">index</span> <span class="k">in</span> <span class="mi">0</span> <span class="p">..</span><span class="o">&lt;</span> <span class="n">typeCount</span> <span class="p">{</span> <span class="p">(</span><span class="n">types</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="k">as</span><span class="p">?</span> <span class="n">SelfAware</span><span class="p">.</span><span class="kr">Type</span><span class="p">)?.</span><span class="n">awake</span><span class="p">()</span> <span class="p">}</span>
        <span class="n">types</span><span class="p">.</span><span class="n">deallocate</span><span class="p">()</span>
    <span class="p">}()</span>

    <span class="kr">override</span> <span class="n">open</span> <span class="kd">var</span> <span class="nv">next</span><span class="p">:</span> <span class="n">UIResponder</span><span class="p">?</span> <span class="p">{</span>
        <span class="c1">// Called before applicationDidFinishLaunching</span>
        <span class="n">UIApplication</span><span class="p">.</span><span class="n">runOnce</span>
        <span class="k">return</span> <span class="kc">super</span><span class="p">.</span><span class="n">next</span>
    <span class="p">}</span>

<span class="p">}</span>

<span class="kd">class</span> <span class="nc">FooAware</span><span class="p">:</span> <span class="n">SelfAware</span> <span class="p">{</span>
    <span class="kd">static</span> <span class="kd">func</span> <span class="nf">awake</span><span class="p">()</span> <span class="p">{</span>
        <span class="c1">// Do sth like in +load...</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div><h3 id="other-linker-flags">Other Linker Flags</h3>
<p>在编译型语言中，编译器负责将源代码编译为目标文件，而链接器负责将多个目标文件在 Xcode - Targets - Build Settings 中有一个「Other Linker Flags」的配置项：</p>
<p><img src="/img/2019/+load_in_ios/3.png" alt="3"></p>
<p>其使得开发者可以在 Xcode 构建项目时自由添加一些链接器参数，关于其完整的参数列表，可以在终端输入 <code>man ld</code> 来获得：</p>
<p><img src="/img/2019/+load_in_ios/4.png" alt="4"></p>
<p>我们这里主要简单介绍下 <code>-ObjC</code>，根据 <code>man ld</code>：</p>
<blockquote>
<p><strong>Options that control libraries</strong></p>
<p><strong>-ObjC</strong> Loads all members of static archive libraries that implement an Objective-C class or category.</p>
<p><strong>-ObjC</strong> 加载静态库中实现 Obj-C 类或分类的所有成员。</p>
</blockquote>
<p>由于 Obj-C 中的方法调用本质属于消息发送，因此链接的符号只有类，而没有方法。分类可以看作是方法的集合，因此使用分类的方法时并不会产生未定义符号，即链接器并不知晓要加载定义分类的目标文件。当我们使用 <code>-ObjC</code> 参数时，将会把<strong>静态库</strong>中所有的分类方法实现加载，但坏处是会使得可执行文件变大，并可能包含不必要的目标文件。</p>
<p>而对于在运行时加载的动态库，我们只要保证代码中引入了库，那么其中的 +load 方法就能够得以执行。</p>
<h2 id="reference">Reference</h2>
<ul>
<li><a href="https://developer.apple.com/documentation/objectivec/nsobject/1418815-load?language=objc">load - Apple Developer</a></li>
<li><a href="../category_in_ios/">iOS 中的 Category - kingcos</a></li>
<li><a href="../objc_msgsend/">浅尝 objc_msgSend - kingcos</a></li>
<li><a href="http://jordansmith.io/handling-the-deprecation-of-initialize/">Handling the Deprecation of initialize() - JORDAN SMITH</a></li>
<li><a href="https://developer.apple.com/library/archive/qa/qa1490/_index.html">Technical Q&amp;A QA1490 - Building Objective-C static libraries with categories</a></li>
</ul>
</div>
                    <div class="post_footer">
                        
                        <div class="meta">
                            <div class="info">
                                <span class="field tags">
                                    <i class="ri-stack-line"></i>
                                    
                                    <a href="https://kingcos.me/tags/focus/">Focus</a>
                                    
                                    <a href="https://kingcos.me/tags/ios/">iOS</a>
                                    
                                    <a href="https://kingcos.me/tags/obj-c/">Obj-C</a>
                                    
                                </span>
                            </div>
                        </div>
                        
                    </div>
                </div>
                <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<table style="border: 0;">
  <tr>
  <td style="border: 0; width: 30%;">
    <img width='100%' src='/img/about/1.jpg'>
  </td>
  <td style="border: 0; width: 50%;">
    <ins class="adsbygoogle"
     style="display:block;width:100%;"
     data-ad-client="ca-pub-9925978992661955"
     data-ad-slot="3213735320"
     data-ad-format="rectangle"
     data-full-width-responsive="false"></ins>
  </td>
  </tr>
</table>

<hr>

<script>
    (adsbygoogle = window.adsbygoogle || []).push({});
</script>
                
                
                



<script id="dsq-count-scr" src="//kingcos.disqus.com/count.js" async></script>

<div id="disqus_thread"></div>
<script>
    

    

    (function() { 
    var d = document, s = d.createElement('script');
    s.src = 'https://kingcos.disqus.com/embed.js';
    s.setAttribute('data-timestamp', +new Date());
    (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>



    
    
    <hr>
    <div>
        <div id="github-comment">
        </div>

        <script type="text/javascript">
        function getUtterances(isDark) {
            var utterances = document.createElement('script');
            utterances.type = 'text/javascript';
            utterances.async = true;
            utterances.setAttribute('issue-term', "pathname")
            utterances.setAttribute('repo', "kingcos\/kingcos.github.io")
            utterances.setAttribute('label', "comments")
            isDark ? utterances.setAttribute('theme', "github-dark") : utterances.setAttribute('theme', "github-light")
            utterances.crossorigin = 'anonymous';
            utterances.src = 'https://utteranc.es/client.js';

            return utterances
        }
        document.getElementById('github-comment').appendChild(getUtterances(false))
        </script>
    </div>
    




                
            </div>
        </div>
    </div>
    <a id="back_to_top" href="#" class="back_to_top"><i class="ri-arrow-up-s-line"></i></a>
    <footer class="footer">
    <div class="powered_by">
        <a href="https://kingcos.me">Powered by kingcos with love.</a>
    </div>

    <div class="footer_slogan">
        <span>❤️</span>
    </div>
</footer>
    <script src="https://kingcos.me/js/jquery-3.5.1.min.js"></script>
<link href="https://kingcos.me/css/fancybox.min.css" rel="stylesheet">
<script src="https://kingcos.me/js/fancybox.min.js"></script>
<script src="https://kingcos.me/js/zozo.js"></script>


<script type="text/javascript" async
    src="https://cdn.bootcss.com/mathjax/2.7.5/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
        MathJax.Hub.Config({
            tex2jax: {
                inlineMath: [['$', '$'], ['\\(', '\\)']],
                displayMath: [['$$', '$$'], ['\[\[', '\]\]']],
                processEscapes: true,
                processEnvironments: true,
                skipTags: ['script', 'noscript', 'style', 'textarea', 'pre'],
                TeX: {
                    equationNumbers: { autoNumber: "AMS" },
                    extensions: ["AMSmath.js", "AMSsymbols.js"]
                }
            }
        });

        MathJax.Hub.Queue(function () {
            
            
            
            var all = MathJax.Hub.getAllJax(), i;
            for (i = 0; i < all.length; i += 1) {
                all[i].SourceElement().parentNode.className += ' has-jax';
            }
        });
    </script>

<style>
    code.has-jax {
        font: inherit;
        font-size: 100%;
        background: inherit;
        border: inherit;
        color: #515151;
    }
</style>



<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-138311951-1', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>

</body>

</html>