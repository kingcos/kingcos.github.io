<!DOCTYPE html>
<html lang="en">
  <head>
    
      <title>iOS 中的 &#43;load 方法 :: iBlog</title>
    
    <meta http-equiv="content-type" content="text/html; charset=utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">
<meta name="description" content="Date Notes Source Code Demo     2019-04-20 首次提交 objc4-750 Load_Obj-C_Demo   2019-09-13 增加 Swift 等部分 - -    Preface 在 iOS 开发中，我们经常会使用 &#43;load 方法来做一些在 main 函数之前的操作，比如方法交换（Method Swizzle）等。那么本文就来简单了解下 iOS 中 &#43;load 方法。
What iOS 中的 &#43;load 方法指的是 NSObject 中的 &#43; (void)load 类方法：
// NSObject.h @interface NSObject &amp;lt;NSObject&amp;gt; { &#43; (void)load; } 官方文档中的 &#43;load 如下：
 Invoked whenever a class or category is added to the Objective-C runtime; implement this method to perform class-specific behavior upon loading."/>
<meta name="keywords" content="kingcos.me,maimieng.comios,swift,objective-c,obj-c,objc,oc,geek,python,ruby,golang,go,apple,mac"/>
<meta name="robots" content="noodp"/>
<link rel="canonical" href="/posts/2019/&#43;load_in_ios/" />





<link rel="stylesheet" href="/assets/style.css">


<link rel="stylesheet" href="/style.css">


<link rel="apple-touch-icon-precomposed" sizes="144x144" href="/img/apple-touch-icon-144-precomposed.png">
<link rel="shortcut icon" href="/img/favicon.png">


<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="iOS 中的 &#43;load 方法"/>
<meta name="twitter:description" content="在 iOS 开发中，我们经常会使用 &#43;load 方法来做一些在 `main` 函数之前的操作，比如方法交换（Method Swizzle）等。那么本文就来简单了解下 iOS 中 &#43;load 方法。"/>



<meta property="og:title" content="iOS 中的 &#43;load 方法" />
<meta property="og:description" content="在 iOS 开发中，我们经常会使用 &#43;load 方法来做一些在 `main` 函数之前的操作，比如方法交换（Method Swizzle）等。那么本文就来简单了解下 iOS 中 &#43;load 方法。" />
<meta property="og:type" content="article" />
<meta property="og:url" content="/posts/2019/&#43;load_in_ios/" />
<meta property="article:published_time" content="2019-09-13T00:00:00+00:00" />
<meta property="article:modified_time" content="2019-09-13T00:00:00+00:00" /><meta property="og:site_name" content="iBlog" />




<script data-ad-client="ca-pub-9925978992661955" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>

  </head>
  <body class="dark-theme">
    <div class="container">
      <header class="header">
  <span class="header__inner">
    <a href="/" class="logo" style="text-decoration: none;">
  
    <span class="logo__mark"><svg xmlns="http://www.w3.org/2000/svg" class="greater-icon" viewBox="0 0 44 44">
  <path fill="none" d="M15 8l14.729 14.382L15 35.367"/>
</svg>
</span>
    <span class="logo__text">kingcos.me</span>
    <span class="logo__cursor"></span>
  
</a>

    <span class="header__right">
      
        <nav class="menu">
  <ul class="menu__inner menu__inner--desktop">
    
      
        
          <li><a href="/about">About</a></li>
        
      
        
          <li><a href="/links">Links</a></li>
        
      
        
          <li><a href="/perspective">Perspective</a></li>
        
      
        
          <li><a href="/words">Words</a></li>
        
      
      
    
  </ul>

  <ul class="menu__inner menu__inner--mobile">
    
      
        <li><a href="/about">About</a></li>
      
    
      
        <li><a href="/links">Links</a></li>
      
    
      
        <li><a href="/perspective">Perspective</a></li>
      
    
      
        <li><a href="/words">Words</a></li>
      
    
  </ul>
</nav>

        <span class="menu-trigger">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
            <path d="M0 0h24v24H0z" fill="none"/>
            <path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"/>
          </svg>
        </span>
      
      <span class="theme-toggle">
        <svg class="theme-toggler" width="24" height="24" viewBox="0 0 48 48" fill="none" xmlns="http://www.w3.org/2000/svg">
  <path d="M22 41C32.4934 41 41 32.4934 41 22C41 11.5066 32.4934 3 22
  3C11.5066 3 3 11.5066 3 22C3 32.4934 11.5066 41 22 41ZM7 22C7
  13.7157 13.7157 7 22 7V37C13.7157 37 7 30.2843 7 22Z"/>
</svg>

      </span>
    </span>
  </span>
</header>


      <div class="content">
        
  <div class="post">
    <h2 class="post-title"><a href="/posts/2019/&#43;load_in_ios/">iOS 中的 +load 方法</a></h2>
    <div class="post-meta">
      
        <span class="post-date">
            2019-09-13
        </span>
      
      
      
        <span class="post-read-time">— 18 min read</span>
      
    </div>

    
      <span class="post-tags">
        
          #<a href="/tags/focus/">Focus</a>&nbsp;
        
          #<a href="/tags/ios/">iOS</a>&nbsp;
        
          #<a href="/tags/obj-c/">Obj-C</a>&nbsp;
        
      </span>
    

    

    <div class="post-content">
      <table>
<thead>
<tr>
<th align="center">Date</th>
<th align="center">Notes</th>
<th align="center">Source Code</th>
<th align="center">Demo</th>
</tr>
</thead>
<tbody>
<tr>
<td align="center">2019-04-20</td>
<td align="center">首次提交</td>
<td align="center"><a href="https://opensource.apple.com/tarballs/objc4/">objc4-750</a></td>
<td align="center"><a href="https://github.com/kingcos/Perspective/tree/writing/Posts/Practice/%2Bload_in_iOS">Load_Obj-C_Demo</a></td>
</tr>
<tr>
<td align="center">2019-09-13</td>
<td align="center">增加 Swift 等部分</td>
<td align="center">-</td>
<td align="center">-</td>
</tr>
</tbody>
</table>
<p><img src="/img/2019/+load_in_ios/0.png" alt="0"></p>
<h2 id="preface">Preface</h2>
<p>在 iOS 开发中，我们经常会使用 +load 方法来做一些在 <code>main</code> 函数之前的操作，比如方法交换（Method Swizzle）等。那么本文就来简单了解下 iOS 中 +load 方法。</p>
<h2 id="what">What</h2>
<p>iOS 中的 +load 方法指的是 <code>NSObject</code> 中的 <code>+ (void)load</code> 类方法：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-objectivec" data-lang="objectivec"><span style="color:#75715e">// NSObject.h
</span><span style="color:#75715e"></span><span style="color:#66d9ef">@interface</span> <span style="color:#a6e22e">NSObject</span> <span style="color:#f92672">&lt;</span>NSObject<span style="color:#f92672">&gt;</span> {
<span style="color:#f92672">+</span> (<span style="color:#66d9ef">void</span>)load;
}
</code></pre></div><p>官方文档中的 +load 如下：</p>
<blockquote>
<p>Invoked whenever a class or category is added to the Objective-C runtime; implement this method to perform class-specific behavior upon loading.</p>
<p>The <code>load</code> message is sent to classes and categories that are both dynamically loaded and statically linked, but only if the newly loaded class or category implements a method that can respond.</p>
<p>The order of initialization is as follows:</p>
<ol>
<li>All initializers in any framework you link to.</li>
<li>All <code>+load</code> methods in your image.</li>
<li>All C++ static initializers and C/C++ <code>__attribute__(constructor)</code> functions in your image.</li>
<li>All initializers in frameworks that link to you.</li>
</ol>
<p>In addition:</p>
<ul>
<li>A class’s <code>+load</code> method is called after all of its superclasses’ <code>+load</code> methods.</li>
<li>A category <code>+load</code> method is called after the class’s own <code>+load</code> method.</li>
</ul>
<p>In a custom implementation of <code>load</code> you can therefore safely message other unrelated classes from the same image, but any <code>load</code> methods implemented by those classes may not have run yet.</p>
<blockquote>
<p><strong>Important</strong></p>
<p>Custom implementations of the <code>load</code> method for Swift classes bridged to Objective-C are not called automatically.</p>
</blockquote>
<p>—— Documentation, Apple Developer</p>
<p>译：</p>
<p>当类或分类被添加到 Obj-C 运行时的时候被调用；可以实现该方法用来在加载时刻执行特定类的操作。</p>
<p>动态加载和静态链接都能将 <code>load</code> 消息发送到类和分类，但前提是新加载类或分类实现了要响应的方法。</p>
<p>初始化的顺序如下：</p>
<ol>
<li>链接的所有框架（Framework）中全部的构造器。</li>
<li>镜像（Image）中所有的 <code>+load</code> 方法。</li>
<li>镜像中所有的 C++ 静态构造器，以及 C/C++ 的 <code>__attribute__(constructor)</code> 函数。</li>
<li>框架中链接的所有构造器。</li>
</ol>
<p>另外：</p>
<ul>
<li>类的 <code>+load</code> 方法在其所有父类的 <code>+load</code> 方法调用之后调用。</li>
<li>分类的 <code>+load</code> 方法在其主类的 <code>+load</code> 方法调用之后调用。</li>
</ul>
<p>在 <code>load</code> 的自定义实现中，可以安全地从同一镜像中发送其他不相关的类，但这些类中实现的 <code>load</code> 方法可能还没有运行。</p>
<blockquote>
<p><strong>重点</strong></p>
<p>Swift 类中桥接到 Obj-C 的 <code>load</code> 方法自定义实现将不会自动调用。</p>
</blockquote>
<p>—— 文档，苹果开发者</p>
</blockquote>
<h2 id="how">How</h2>
<p>根据官方文档的描述，我们可以尝试定义一个继承自 <code>NSObject</code> 的 <code>Person</code> 类，并对其添加两个分类 <code>Life</code> 和 <code>Work</code>；再定义一个 <code>Student</code> 类继承自 <code>Person</code>，并对其添加 <code>School</code> 分类。在以上所有类和分类中，均实现 +load：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-objectivec" data-lang="objectivec"><span style="color:#75715e">// Person.m
</span><span style="color:#75715e"></span><span style="color:#75715e">#</span><span style="color:#75715e">import &#34;Person.h&#34;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span>
<span style="color:#66d9ef">@implementation</span> <span style="color:#a6e22e">Person</span>
+ (<span style="color:#66d9ef">void</span>)<span style="color:#a6e22e">load</span> {
    NSLog(<span style="color:#e6db74">@&#34;</span><span style="color:#e6db74">Person %s</span><span style="color:#e6db74">&#34;</span>, __func__);
}
<span style="color:#66d9ef">@end</span>

<span style="color:#75715e">// Person+Life.m
</span><span style="color:#75715e"></span><span style="color:#75715e">#</span><span style="color:#75715e">import &#34;Person+Life.h&#34;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span>
<span style="color:#66d9ef">@implementation</span> <span style="color:#a6e22e">Person</span> (Life)
+ (<span style="color:#66d9ef">void</span>)<span style="color:#a6e22e">load</span> {
    NSLog(<span style="color:#e6db74">@&#34;</span><span style="color:#e6db74">Person+Life %s</span><span style="color:#e6db74">&#34;</span>, __func__);
}
<span style="color:#66d9ef">@end</span>

<span style="color:#75715e">// Person+Work.m
</span><span style="color:#75715e"></span><span style="color:#75715e">#</span><span style="color:#75715e">import &#34;Person+Work.h&#34;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span>
<span style="color:#66d9ef">@implementation</span> <span style="color:#a6e22e">Person</span> (Work)
+ (<span style="color:#66d9ef">void</span>)<span style="color:#a6e22e">load</span> {
    NSLog(<span style="color:#e6db74">@&#34;</span><span style="color:#e6db74">Person+Work %s</span><span style="color:#e6db74">&#34;</span>, __func__);
}
<span style="color:#66d9ef">@end</span>

<span style="color:#75715e">// Student.m
</span><span style="color:#75715e"></span><span style="color:#75715e">#</span><span style="color:#75715e">import &#34;Student.h&#34;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span>
<span style="color:#66d9ef">@implementation</span> <span style="color:#a6e22e">Student</span>
+ (<span style="color:#66d9ef">void</span>)<span style="color:#a6e22e">load</span> {
    NSLog(<span style="color:#e6db74">@&#34;</span><span style="color:#e6db74">Student %s</span><span style="color:#e6db74">&#34;</span>, __func__);
}
<span style="color:#66d9ef">@end</span>

<span style="color:#75715e">// Student+School.m
</span><span style="color:#75715e"></span><span style="color:#75715e">#</span><span style="color:#75715e">import &#34;Student+School.h&#34;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span>
<span style="color:#66d9ef">@implementation</span> <span style="color:#a6e22e">Student</span> (School)
+ (<span style="color:#66d9ef">void</span>)<span style="color:#a6e22e">load</span> {
    NSLog(<span style="color:#e6db74">@&#34;</span><span style="color:#e6db74">Student+School %s</span><span style="color:#e6db74">&#34;</span>, __func__);
}
<span style="color:#66d9ef">@end</span>

<span style="color:#75715e">// OUTPUT:
</span><span style="color:#75715e"></span><span style="color:#75715e">// Person +[Person load]
</span><span style="color:#75715e"></span><span style="color:#75715e">// Student +[Student load]
</span><span style="color:#75715e"></span><span style="color:#75715e">// Person+Life +[Person(Life) load]
</span><span style="color:#75715e"></span><span style="color:#75715e">// Student+School +[Student(School) load]
</span><span style="color:#75715e"></span><span style="color:#75715e">// Person+Work +[Person(Work) load]
</span><span style="color:#75715e"></span><span style="color:#75715e">// Hello, World!
</span></code></pre></div><p>不需要更改 main.m，尝试运行程序，结果正如官方所述，即 <strong>+load 方法会在 <code>main</code> 函数之前被调用；且调用顺序总是先父类再子类再分类</strong>。</p>
<h2 id="why">Why</h2>
<h3 id="heading">实现原理</h3>
<blockquote>
<p><strong>Obj-C 运行时的入口是哪里呢？</strong></p>
<p>在 objc4 源码中有一个「libobjc.order」的文件，列举了该库方法符号的调用顺序，我们能看到第一个就是 <code>__objc_init</code>。编译时，C/C++ 方法前会被自动加上 <code>_</code> 前缀作为方法符号（这一点可以在分析 Link Map 或者 Mach-O 时证明），因此这里第一个本质就是 <code>_objc_init</code>。</p>
<p><img src="/img/2019/+load_in_ios/1.png" alt="1"></p>
</blockquote>
<p>为了证明上述结论，我们可以在 objc4 的源码中，从 Obj-C 运行时初始化的入口着手，即 <code>_objc_init</code>：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-objectivec" data-lang="objectivec"><span style="color:#75715e">// objc-os.mm
</span><span style="color:#75715e"></span><span style="color:#75715e">/***********************************************************************
</span><span style="color:#75715e">* _objc_init
</span><span style="color:#75715e">* Bootstrap initialization. Registers our image notifier with dyld.
</span><span style="color:#75715e">* 引导初始化。使用 dyld 注册镜像通知器。
</span><span style="color:#75715e">* Called by libSystem BEFORE library initialization time
</span><span style="color:#75715e">* 在库初始化时间之前由 libSystem 调用
</span><span style="color:#75715e">**********************************************************************/</span>

<span style="color:#66d9ef">void</span> <span style="color:#a6e22e">_objc_init</span>(<span style="color:#66d9ef">void</span>)
{
    <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">bool</span> initialized <span style="color:#f92672">=</span> false;
    <span style="color:#66d9ef">if</span> (initialized) <span style="color:#66d9ef">return</span>;
    initialized <span style="color:#f92672">=</span> true;

    <span style="color:#75715e">// fixme defer initialization until an objc-using image is found?
</span><span style="color:#75715e"></span>    environ_init();
    tls_init();
    static_init();
    lock_init();
    exception_init();

    <span style="color:#75715e">// ➡️ dyld 注册通知；map_images：映射镜像，load_images：加载镜像，unmap_image：反映射镜像
</span><span style="color:#75715e"></span>    _dyld_objc_notify_register(<span style="color:#f92672">&amp;</span>map_images, load_images, unmap_image);
}

<span style="color:#75715e">// objc-runtime-new.mm
</span><span style="color:#75715e"></span><span style="color:#75715e">/***********************************************************************
</span><span style="color:#75715e">* load_images
</span><span style="color:#75715e">* Process +load in the given images which are being mapped in by dyld.
</span><span style="color:#75715e">* 由 dyld 处理给定将要映射的镜像中的 +load。
</span><span style="color:#75715e">*
</span><span style="color:#75715e">* Locking: write-locks runtimeLock and loadMethodLock
</span><span style="color:#75715e">* 锁：写锁 runtimeLock 和 loadMethodLock
</span><span style="color:#75715e">**********************************************************************/</span>
<span style="color:#66d9ef">extern</span> <span style="color:#66d9ef">bool</span> <span style="color:#a6e22e">hasLoadMethods</span>(<span style="color:#66d9ef">const</span> headerType <span style="color:#f92672">*</span>mhdr);
<span style="color:#66d9ef">extern</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">prepare_load_methods</span>(<span style="color:#66d9ef">const</span> headerType <span style="color:#f92672">*</span>mhdr);

<span style="color:#66d9ef">void</span>
<span style="color:#a6e22e">load_images</span>(<span style="color:#66d9ef">const</span> <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>path __unused, <span style="color:#66d9ef">const</span> <span style="color:#66d9ef">struct</span> mach_header <span style="color:#f92672">*</span>mh)
{
    <span style="color:#75715e">// Return without taking locks if there are no +load methods here.
</span><span style="color:#75715e"></span>    <span style="color:#75715e">// ➡️ 如果没有 +load 方法则返回
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span>hasLoadMethods((<span style="color:#66d9ef">const</span> headerType <span style="color:#f92672">*</span>)mh)) <span style="color:#66d9ef">return</span>;

    <span style="color:#75715e">// 递归锁
</span><span style="color:#75715e"></span>    recursive_mutex_locker_t lock(loadMethodLock);

    <span style="color:#75715e">// Discover load methods
</span><span style="color:#75715e"></span>    <span style="color:#75715e">// 发现 load 方法
</span><span style="color:#75715e"></span>    {
        <span style="color:#75715e">// 互斥锁
</span><span style="color:#75715e"></span>        mutex_locker_t lock2(runtimeLock);
        <span style="color:#75715e">// ➡️ 准备加载 load 方法
</span><span style="color:#75715e"></span>        prepare_load_methods((<span style="color:#66d9ef">const</span> headerType <span style="color:#f92672">*</span>)mh);
    }

    <span style="color:#75715e">// Call +load methods (without runtimeLock - re-entrant)
</span><span style="color:#75715e"></span>    <span style="color:#75715e">// ➡️ 调用 +load 方法（不带 runtimeLock - 可重入的（线程安全的））
</span><span style="color:#75715e"></span>    call_load_methods();
}

<span style="color:#75715e">// objc-runtime-new.mm
</span><span style="color:#75715e"></span><span style="color:#75715e">// Quick scan for +load methods that doesn&#39;t take a lock.
</span><span style="color:#75715e"></span><span style="color:#75715e">// 不需要加锁地快速搜索 +load 方法
</span><span style="color:#75715e"></span><span style="color:#66d9ef">bool</span> <span style="color:#a6e22e">hasLoadMethods</span>(<span style="color:#66d9ef">const</span> headerType <span style="color:#f92672">*</span>mhdr)
{
    size_t count;
    <span style="color:#75715e">// 非懒加载类列表（取 Mach-O 中 __objc_nlclslist 节）
</span><span style="color:#75715e"></span>    <span style="color:#75715e">// GETSECT(_getObjc2NonlazyClassList,    classref_t,      &#34;__objc_nlclslist&#34;);
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">if</span> (_getObjc2NonlazyClassList(mhdr, <span style="color:#f92672">&amp;</span>count)  <span style="color:#f92672">&amp;</span><span style="color:#f92672">&amp;</span>  count <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">0</span>) <span style="color:#66d9ef">return</span> true;
    <span style="color:#75715e">// 非懒加载分类列表（取 Mach-O 中 __objc_nlcatlist 节）
</span><span style="color:#75715e"></span>    <span style="color:#75715e">// GETSECT(_getObjc2NonlazyCategoryList, category_t *,    &#34;__objc_nlcatlist&#34;);
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">if</span> (_getObjc2NonlazyCategoryList(mhdr, <span style="color:#f92672">&amp;</span>count)  <span style="color:#f92672">&amp;</span><span style="color:#f92672">&amp;</span>  count <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">0</span>) <span style="color:#66d9ef">return</span> true;
    <span style="color:#66d9ef">return</span> false;
}

<span style="color:#75715e">// objc-runtime-new.mm
</span><span style="color:#75715e"></span><span style="color:#66d9ef">void</span> <span style="color:#a6e22e">prepare_load_methods</span>(<span style="color:#66d9ef">const</span> headerType <span style="color:#f92672">*</span>mhdr)
{
    size_t count, i;

    <span style="color:#75715e">// 断言 runtimeLock 已锁
</span><span style="color:#75715e"></span>    runtimeLock.assertLocked();

    <span style="color:#75715e">// 1. 非懒加载类列表
</span><span style="color:#75715e"></span>    classref_t <span style="color:#f92672">*</span>classlist <span style="color:#f92672">=</span>
        _getObjc2NonlazyClassList(mhdr, <span style="color:#f92672">&amp;</span>count);
    <span style="color:#75715e">// 遍历所有类
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">for</span> (i <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>; i <span style="color:#f92672">&lt;</span> count; i<span style="color:#f92672">+</span><span style="color:#f92672">+</span>) {
        <span style="color:#75715e">// ➡️ 计划 +load 方法调用
</span><span style="color:#75715e"></span>        schedule_class_load(remapClass(classlist[i]));
    }

    <span style="color:#75715e">// 2. 非懒加载分类列表
</span><span style="color:#75715e"></span>    category_t <span style="color:#f92672">*</span><span style="color:#f92672">*</span>categorylist <span style="color:#f92672">=</span> _getObjc2NonlazyCategoryList(mhdr, <span style="color:#f92672">&amp;</span>count);
    <span style="color:#75715e">// 遍历所有分类
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">for</span> (i <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>; i <span style="color:#f92672">&lt;</span> count; i<span style="color:#f92672">+</span><span style="color:#f92672">+</span>) {
        category_t <span style="color:#f92672">*</span>cat <span style="color:#f92672">=</span> categorylist[i];
        <span style="color:#75715e">// 重映射分类的主类
</span><span style="color:#75715e"></span>        <span style="color:#66d9ef">Class</span> cls <span style="color:#f92672">=</span> remapClass(cat<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>cls);
        <span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span>cls) <span style="color:#66d9ef">continue</span>;  <span style="color:#75715e">// category for ignored weak-linked class 忽略弱链接主类的分类
</span><span style="color:#75715e"></span>        <span style="color:#75715e">// 实化类（为 cls 执行一次性初始化等操作）
</span><span style="color:#75715e"></span>        realizeClass(cls);
        <span style="color:#75715e">// 断言类的 isa（元类）已实化
</span><span style="color:#75715e"></span>        assert(cls<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>ISA()<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>isRealized());
        <span style="color:#75715e">// ➡️ 添加分类到可加载列表
</span><span style="color:#75715e"></span>        add_category_to_loadable_list(cat);
    }
}

<span style="color:#75715e">// objc-runtime-new.mm
</span><span style="color:#75715e"></span><span style="color:#66d9ef">static</span> <span style="color:#66d9ef">Class</span> <span style="color:#a6e22e">remapClass</span>(classref_t cls)
{
    <span style="color:#960050;background-color:#1e0010">➡</span><span style="color:#960050;background-color:#1e0010">️</span> <span style="color:#960050;background-color:#1e0010">重</span><span style="color:#960050;background-color:#1e0010">映</span><span style="color:#960050;background-color:#1e0010">射</span><span style="color:#960050;background-color:#1e0010">类</span>
    <span style="color:#66d9ef">return</span> remapClass((<span style="color:#66d9ef">Class</span>)cls);
}

<span style="color:#75715e">// objc-runtime-new.mm
</span><span style="color:#75715e"></span><span style="color:#75715e">/***********************************************************************
</span><span style="color:#75715e">* remapClass
</span><span style="color:#75715e">* Returns the live class pointer for cls, which may be pointing to
</span><span style="color:#75715e">* a class struct that has been reallocated.
</span><span style="color:#75715e">* 为参数 cls 返回可能指向已经重新分配类结构到活类指针。
</span><span style="color:#75715e">* Returns nil if cls is ignored because of weak linking.
</span><span style="color:#75715e">* 如果类是弱链接，将返回 nil。
</span><span style="color:#75715e">* Locking: runtimeLock must be read- or write-locked by the caller
</span><span style="color:#75715e">* 锁：runtimeLock 必须由调用者读取或写入锁定。
</span><span style="color:#75715e">**********************************************************************/</span>
<span style="color:#66d9ef">static</span> <span style="color:#66d9ef">Class</span> <span style="color:#a6e22e">remapClass</span>(<span style="color:#66d9ef">Class</span> cls)
{
    <span style="color:#75715e">// 断言 runtimeLock 已锁
</span><span style="color:#75715e"></span>    runtimeLock.assertLocked();

    <span style="color:#66d9ef">Class</span> c2;

    <span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span>cls) <span style="color:#66d9ef">return</span> nil;

    NXMapTable <span style="color:#f92672">*</span>map <span style="color:#f92672">=</span> remappedClasses(NO);
    <span style="color:#75715e">// 从 map 中取 cls 对应的值
</span><span style="color:#75715e"></span>    <span style="color:#75715e">// void *NXMapMember(NXMapTable *table, const void *key, void **value)
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span>map  <span style="color:#f92672">|</span><span style="color:#f92672">|</span>  NXMapMember(map, cls, (<span style="color:#66d9ef">void</span><span style="color:#f92672">*</span><span style="color:#f92672">*</span>)<span style="color:#f92672">&amp;</span>c2) <span style="color:#f92672">=</span><span style="color:#f92672">=</span> NX_MAPNOTAKEY) {
        <span style="color:#66d9ef">return</span> cls;
    } <span style="color:#66d9ef">else</span> {
        <span style="color:#66d9ef">return</span> c2;
    }
}

<span style="color:#75715e">// objc-runtime-new.mm
</span><span style="color:#75715e"></span><span style="color:#75715e">/***********************************************************************
</span><span style="color:#75715e">* prepare_load_methods
</span><span style="color:#75715e">* Schedule +load for classes in this image, any un-+load-ed
</span><span style="color:#75715e">* superclasses in other images, and any categories in this image.
</span><span style="color:#75715e">* 为当前镜像中的类、其它镜像中所有未调用过 +load 的父类、以及该镜像中的所有的分类计划调用 +load。
</span><span style="color:#75715e">**********************************************************************/</span>
<span style="color:#75715e">// Recursively schedule +load for cls and any un-+load-ed superclasses.
</span><span style="color:#75715e"></span><span style="color:#75715e">// 为 cls 以及所有未调用过 +load 的父类递归计划调用 +load。
</span><span style="color:#75715e"></span><span style="color:#75715e">// cls must already be connected.
</span><span style="color:#75715e"></span><span style="color:#75715e">// cls 必须已被连接。
</span><span style="color:#75715e"></span><span style="color:#66d9ef">static</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">schedule_class_load</span>(<span style="color:#66d9ef">Class</span> cls)
{
    <span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span>cls) <span style="color:#66d9ef">return</span>;
    <span style="color:#75715e">// 断言类是实化的
</span><span style="color:#75715e"></span>    assert(cls<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>isRealized());  <span style="color:#75715e">// _read_images should realize
</span><span style="color:#75715e"></span>
    <span style="color:#75715e">// 判断类的 +load 是否已经被调用
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">if</span> (cls<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>data()<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>flags <span style="color:#f92672">&amp;</span> RW_LOADED) <span style="color:#66d9ef">return</span>;

    <span style="color:#75715e">// Ensure superclass-first ordering
</span><span style="color:#75715e"></span>    <span style="color:#75715e">// （递归）确保父类优先调用 +load
</span><span style="color:#75715e"></span>    schedule_class_load(cls<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>superclass);

    <span style="color:#75715e">// ➡️ 添加类到可加载列表
</span><span style="color:#75715e"></span>    add_class_to_loadable_list(cls);
    <span style="color:#75715e">// 设置本类 +load 已调用过
</span><span style="color:#75715e"></span>    cls<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>setInfo(RW_LOADED);
}



<span style="color:#75715e">// objc-loadmethod.mm
</span><span style="color:#75715e"></span><span style="color:#75715e">/***********************************************************************
</span><span style="color:#75715e">* add_class_to_loadable_list
</span><span style="color:#75715e">* Class cls has just become connected. Schedule it for +load if
</span><span style="color:#75715e">* it implements a +load method.
</span><span style="color:#75715e">* cls 刚刚被连接。如果其实现了 +load 方法就将计划调用。
</span><span style="color:#75715e">**********************************************************************/</span>
<span style="color:#66d9ef">void</span> <span style="color:#a6e22e">add_class_to_loadable_list</span>(<span style="color:#66d9ef">Class</span> cls)
{
    <span style="color:#66d9ef">IMP</span> method;

    <span style="color:#75715e">// 断言 loadMethodLock 已锁
</span><span style="color:#75715e"></span>    loadMethodLock.assertLocked();

    <span style="color:#75715e">// ➡️ 获取类 load 方法
</span><span style="color:#75715e"></span>    method <span style="color:#f92672">=</span> cls<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>getLoadMethod();
    <span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span>method) <span style="color:#66d9ef">return</span>;  <span style="color:#75715e">// Don&#39;t bother if cls has no +load method 没有 +load 就返回
</span><span style="color:#75715e"></span>
    <span style="color:#75715e">// Xcode 中 OBJC_PRINT_LOAD_METHODS 环境变量值为 YES 时，将可在控制台打印该信息
</span><span style="color:#75715e"></span>    <span style="color:#75715e">// OPTION(PrintLoading, OBJC_PRINT_LOAD_METHODS, &#34;log calls to class and category +load methods&#34;)
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">if</span> (PrintLoading) {
        _objc_inform(<span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">LOAD: class &#39;%s&#39; scheduled for +load</span><span style="color:#e6db74">&#34;</span>,
                     cls<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>nameForLogging());
    }

    <span style="color:#75715e">// 如果使用的 == 分配的，需要扩容
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">if</span> (loadable_classes_used <span style="color:#f92672">=</span><span style="color:#f92672">=</span> loadable_classes_allocated) {
        loadable_classes_allocated <span style="color:#f92672">=</span> loadable_classes_allocated<span style="color:#f92672">*</span><span style="color:#ae81ff">2</span> <span style="color:#f92672">+</span> <span style="color:#ae81ff">16</span>;
        loadable_classes <span style="color:#f92672">=</span> (<span style="color:#66d9ef">struct</span> loadable_class <span style="color:#f92672">*</span>)
            realloc(loadable_classes,
                              loadable_classes_allocated <span style="color:#f92672">*</span>
                              <span style="color:#66d9ef">sizeof</span>(<span style="color:#66d9ef">struct</span> loadable_class));
    }

    <span style="color:#75715e">// 添加到 loadable_classes（将在 call_class_loads 中实际调用）
</span><span style="color:#75715e"></span>    loadable_classes[loadable_classes_used].cls <span style="color:#f92672">=</span> cls;
    loadable_classes[loadable_classes_used].method <span style="color:#f92672">=</span> method;
    loadable_classes_used<span style="color:#f92672">+</span><span style="color:#f92672">+</span>;
}

<span style="color:#75715e">// objc-runtime-new.mm
</span><span style="color:#75715e"></span><span style="color:#75715e">/***********************************************************************
</span><span style="color:#75715e">* objc_class::getLoadMethod
</span><span style="color:#75715e">* fixme
</span><span style="color:#75715e">* Called only from add_class_to_loadable_list.
</span><span style="color:#75715e">* 只在 add_class_to_loadable_list 中调用。
</span><span style="color:#75715e">* Locking: runtimeLock must be read- or write-locked by the caller.
</span><span style="color:#75715e">* 锁：runtimeLock 必须由调用者读取或写入锁定。
</span><span style="color:#75715e">**********************************************************************/</span>
<span style="color:#66d9ef">IMP</span>
objc_class<span style="color:#f92672">:</span><span style="color:#f92672">:</span>getLoadMethod()
{
    runtimeLock.assertLocked();

    <span style="color:#66d9ef">const</span> method_list_t <span style="color:#f92672">*</span>mlist;

    <span style="color:#75715e">// 断言
</span><span style="color:#75715e"></span>    assert(isRealized());
    assert(ISA()<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>isRealized());
    assert(<span style="color:#f92672">!</span>isMetaClass());
    assert(ISA()<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>isMetaClass());

    <span style="color:#75715e">// 从只读列表中读取 baseMethods（可参考「iOS 中的 NSObject」）
</span><span style="color:#75715e"></span>    mlist <span style="color:#f92672">=</span> ISA()<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>data()<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>ro<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>baseMethods();
    <span style="color:#66d9ef">if</span> (mlist) {
        <span style="color:#75715e">// 遍历
</span><span style="color:#75715e"></span>        <span style="color:#66d9ef">for</span> (<span style="color:#66d9ef">const</span> <span style="color:#66d9ef">auto</span><span style="color:#f92672">&amp;</span> meth : <span style="color:#f92672">*</span>mlist) {
            <span style="color:#75715e">// 获取 selector 名称
</span><span style="color:#75715e"></span>            <span style="color:#66d9ef">const</span> <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>name <span style="color:#f92672">=</span> sel_cname(meth.name);
            <span style="color:#66d9ef">if</span> (<span style="color:#ae81ff">0</span> <span style="color:#f92672">=</span><span style="color:#f92672">=</span> strcmp(name, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">load</span><span style="color:#e6db74">&#34;</span>)) {
                <span style="color:#75715e">// 若为 load 方法，则返回 IMP
</span><span style="color:#75715e"></span>                <span style="color:#66d9ef">return</span> meth.imp;
            }
        }
    }

    <span style="color:#66d9ef">return</span> nil;
}

<span style="color:#75715e">// objc-loadmethod.mm
</span><span style="color:#75715e"></span><span style="color:#75715e">/***********************************************************************
</span><span style="color:#75715e">* add_category_to_loadable_list
</span><span style="color:#75715e">* Category cat&#39;s parent class exists and the category has been attached
</span><span style="color:#75715e">* to its class. Schedule this category for +load after its parent class
</span><span style="color:#75715e">* becomes connected and has its own +load method called.
</span><span style="color:#75715e">* 分类 cat 的主类存在，且分类已经连接到主类的类上了。在父类连接且调用了 +load 后计划调用该分类的 +load。
</span><span style="color:#75715e">**********************************************************************/</span>
<span style="color:#66d9ef">void</span> add_category_to_loadable_list(Category cat)
{
    <span style="color:#66d9ef">IMP</span> method;

    <span style="color:#75715e">// 断言 loadMethodLock 已锁
</span><span style="color:#75715e"></span>    loadMethodLock.assertLocked();

    <span style="color:#75715e">// ➡️ 获取分类 load 方法
</span><span style="color:#75715e"></span>    method <span style="color:#f92672">=</span> _category_getLoadMethod(cat);

    <span style="color:#75715e">// Don&#39;t bother if cat has no +load method
</span><span style="color:#75715e"></span>    <span style="color:#75715e">// 没有 +load 就返回
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span>method) <span style="color:#66d9ef">return</span>;

    <span style="color:#75715e">// OPTION(PrintLoading, OBJC_PRINT_LOAD_METHODS, &#34;log calls to class and category +load methods&#34;)
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">if</span> (PrintLoading) {
        _objc_inform(<span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">LOAD: category &#39;%s(%s)&#39; scheduled for +load</span><span style="color:#e6db74">&#34;</span>,
                     _category_getClassName(cat), _category_getName(cat));
    }

    <span style="color:#75715e">// 如果使用的 == 分配的，需要扩容
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">if</span> (loadable_categories_used <span style="color:#f92672">=</span><span style="color:#f92672">=</span> loadable_categories_allocated) {
        loadable_categories_allocated <span style="color:#f92672">=</span> loadable_categories_allocated<span style="color:#f92672">*</span><span style="color:#ae81ff">2</span> <span style="color:#f92672">+</span> <span style="color:#ae81ff">16</span>;
        loadable_categories <span style="color:#f92672">=</span> (<span style="color:#66d9ef">struct</span> loadable_category <span style="color:#f92672">*</span>)
            realloc(loadable_categories,
                              loadable_categories_allocated <span style="color:#f92672">*</span>
                              <span style="color:#66d9ef">sizeof</span>(<span style="color:#66d9ef">struct</span> loadable_category));
    }

	 <span style="color:#75715e">// 存入 loadable_categories（将在 call_category_loads 中实际调用）
</span><span style="color:#75715e"></span>    loadable_categories[loadable_categories_used].cat <span style="color:#f92672">=</span> cat;
    loadable_categories[loadable_categories_used].method <span style="color:#f92672">=</span> method;
    loadable_categories_used<span style="color:#f92672">+</span><span style="color:#f92672">+</span>;
}

<span style="color:#75715e">// objc-runtime-new.mm
</span><span style="color:#75715e"></span><span style="color:#75715e">/***********************************************************************
</span><span style="color:#75715e">* _category_getLoadMethod
</span><span style="color:#75715e">* fixme
</span><span style="color:#75715e">* Called only from add_category_to_loadable_list
</span><span style="color:#75715e">* 只在 add_category_to_loadable_list 中调用
</span><span style="color:#75715e">* Locking: runtimeLock must be read- or write-locked by the caller
</span><span style="color:#75715e">* 锁：runtimeLock 必须由调用者读取或写入锁定。
</span><span style="color:#75715e">**********************************************************************/</span>
<span style="color:#66d9ef">IMP</span>
_category_getLoadMethod(Category cat)
{
    <span style="color:#75715e">// 断言 loadMethodLock 已锁
</span><span style="color:#75715e"></span>    runtimeLock.assertLocked();

    <span style="color:#66d9ef">const</span> method_list_t <span style="color:#f92672">*</span>mlist;

    <span style="color:#75715e">// 分类中类方法列表
</span><span style="color:#75715e"></span>    mlist <span style="color:#f92672">=</span> cat<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>classMethods;
    <span style="color:#66d9ef">if</span> (mlist) {
        <span style="color:#75715e">// 遍历
</span><span style="color:#75715e"></span>        <span style="color:#66d9ef">for</span> (<span style="color:#66d9ef">const</span> <span style="color:#66d9ef">auto</span><span style="color:#f92672">&amp;</span> meth : <span style="color:#f92672">*</span>mlist) {
            <span style="color:#75715e">// 获取 selector 名称
</span><span style="color:#75715e"></span>            <span style="color:#66d9ef">const</span> <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>name <span style="color:#f92672">=</span> sel_cname(meth.name);
            <span style="color:#66d9ef">if</span> (<span style="color:#ae81ff">0</span> <span style="color:#f92672">=</span><span style="color:#f92672">=</span> strcmp(name, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">load</span><span style="color:#e6db74">&#34;</span>)) {
                <span style="color:#75715e">// 若为 load 方法，则返回 IMP
</span><span style="color:#75715e"></span>                <span style="color:#66d9ef">return</span> meth.imp;
            }
        }
    }

    <span style="color:#66d9ef">return</span> nil;
}

<span style="color:#75715e">// objc-loadmethod.mm
</span><span style="color:#75715e"></span><span style="color:#75715e">/***********************************************************************
</span><span style="color:#75715e">* call_load_methods
</span><span style="color:#75715e">* Call all pending class and category +load methods.
</span><span style="color:#75715e">* 调用所有类和分类的 +load  方法。
</span><span style="color:#75715e">* Class +load methods are called superclass-first.
</span><span style="color:#75715e">* 类的 +load 方法将先调用父类的。
</span><span style="color:#75715e">* Category +load methods are not called until after the parent class&#39;s +load.
</span><span style="color:#75715e">* 分类的 +load 才需要等到其主类的 +load 调用后才调用。
</span><span style="color:#75715e">*
</span><span style="color:#75715e">* This method must be RE-ENTRANT, because a +load could trigger
</span><span style="color:#75715e">* more image mapping. In addition, the superclass-first ordering
</span><span style="color:#75715e">* must be preserved in the face of re-entrant calls. Therefore,
</span><span style="color:#75715e">* only the OUTERMOST call of this function will do anything, and
</span><span style="color:#75715e">* that call will handle all loadable classes, even those generated
</span><span style="color:#75715e">* while it was running.
</span><span style="color:#75715e">* 该方法必须是可重入的（线程安全的），因为 +load 可能触发更多镜像映射。
</span><span style="color:#75715e">* 另外，面对可重入调用时，必须保留父类优先排序。
</span><span style="color:#75715e">* 因此，只有当该函数在最后调用才会执行全部操作，且该调用将处理所有可加载的类，甚至是在运行时生成的类。
</span><span style="color:#75715e">*
</span><span style="color:#75715e">* The sequence below preserves +load ordering in the face of
</span><span style="color:#75715e">* image loading during a +load, and make sure that no
</span><span style="color:#75715e">* +load method is forgotten because it was added during
</span><span style="color:#75715e">* a +load call.
</span><span style="color:#75715e">* 下面的顺序保留了在面对 +load 中加载镜像的 +load 排序，并且因为它是在一个 +load 调用中被添加的，因此可以保证没有 +load 被遗忘，。
</span><span style="color:#75715e">* Sequence:
</span><span style="color:#75715e">* 顺序
</span><span style="color:#75715e">* 1. Repeatedly call class +loads until there aren&#39;t any more
</span><span style="color:#75715e">* 1. 重复调用类 +load 直到不再有未调用的 +load
</span><span style="color:#75715e">* 2. Call category +loads ONCE.
</span><span style="color:#75715e">* 2. 调用分类 +load 一次
</span><span style="color:#75715e">* 3. Run more +loads if:
</span><span style="color:#75715e">* 3. 执行多次 +load 的情况：
</span><span style="color:#75715e">*    (a) there are more classes to load, OR
</span><span style="color:#75715e">*    (a) 有多个类要加载，或者
</span><span style="color:#75715e">*    (b) there are some potential category +loads that have
</span><span style="color:#75715e">*        still never been attempted.
</span><span style="color:#75715e">*    (b) 有一些潜在的分类 +load 仍未尝试。
</span><span style="color:#75715e">* Category +loads are only run once to ensure &#34;parent class first&#34;
</span><span style="color:#75715e">* ordering, even if a category +load triggers a new loadable class
</span><span style="color:#75715e">* and a new loadable category attached to that class.
</span><span style="color:#75715e">* 分类中的 +load 只会被执行一次，并保证「父类优先」排序，尽管一个分类的 +load 触发了一个新的可加载的类以及附加该类的一个新的可加载的分类。
</span><span style="color:#75715e">*
</span><span style="color:#75715e">* Locking: loadMethodLock must be held by the caller
</span><span style="color:#75715e">* 锁：loadMethodLock 必须由调用者持有
</span><span style="color:#75715e">*   All other locks must not be held.
</span><span style="color:#75715e">*   所有其它锁必须不持有。
</span><span style="color:#75715e">**********************************************************************/</span>
<span style="color:#66d9ef">void</span> call_load_methods(<span style="color:#66d9ef">void</span>)
{
    <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">bool</span> loading <span style="color:#f92672">=</span> NO;
    <span style="color:#66d9ef">bool</span> more_categories;

    <span style="color:#75715e">// 断言 loadMethodLock 已锁
</span><span style="color:#75715e"></span>    loadMethodLock.assertLocked();

    <span style="color:#75715e">// Re-entrant calls do nothing; the outermost call will finish the job.
</span><span style="color:#75715e"></span>    <span style="color:#75715e">// 重入的调用不做事情，最早的调用将完成任务
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">if</span> (loading) <span style="color:#66d9ef">return</span>;
    loading <span style="color:#f92672">=</span> YES;

    <span style="color:#66d9ef">void</span> <span style="color:#f92672">*</span>pool <span style="color:#f92672">=</span> objc_autoreleasePoolPush();

    <span style="color:#66d9ef">do</span> {
        <span style="color:#75715e">// 1. Repeatedly call class +loads until there aren&#39;t any more
</span><span style="color:#75715e"></span>        <span style="color:#75715e">// 1. 重复调用类 +load，直到全部调用到
</span><span style="color:#75715e"></span>        <span style="color:#66d9ef">while</span> (loadable_classes_used <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">0</span>) {
            <span style="color:#75715e">// ➡️ 调用类的 +load 方法
</span><span style="color:#75715e"></span>            call_class_loads();
        }

        <span style="color:#75715e">// 2. Call category +loads ONCE
</span><span style="color:#75715e"></span>        <span style="color:#75715e">// 2. ➡️ 调用分类 +load 一次
</span><span style="color:#75715e"></span>        more_categories <span style="color:#f92672">=</span> call_category_loads();

        <span style="color:#75715e">// 3. Run more +loads if there are classes OR more untried categories
</span><span style="color:#75715e"></span>        <span style="color:#75715e">// 3.如果有类或者更多未尝试的分类则运行更多的 +load
</span><span style="color:#75715e"></span>    } <span style="color:#66d9ef">while</span> (loadable_classes_used <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">0</span>  <span style="color:#f92672">|</span><span style="color:#f92672">|</span>  more_categories);

    objc_autoreleasePoolPop(pool);

    loading <span style="color:#f92672">=</span> NO;
}

<span style="color:#75715e">// objc-loadmethod.mm
</span><span style="color:#75715e"></span><span style="color:#75715e">/***********************************************************************
</span><span style="color:#75715e">* call_class_loads
</span><span style="color:#75715e">* Call all pending class +load methods.
</span><span style="color:#75715e">* 调用所有类的 +load 方法。
</span><span style="color:#75715e">* If new classes become loadable, +load is NOT called for them.
</span><span style="color:#75715e">* 如果有新的类变为可加载的，它们的 +load 不会被调用
</span><span style="color:#75715e">*
</span><span style="color:#75715e">* Called only by call_load_methods().
</span><span style="color:#75715e">* 只能由 call_load_methods() 调用。
</span><span style="color:#75715e">**********************************************************************/</span>
<span style="color:#66d9ef">static</span> <span style="color:#66d9ef">void</span> call_class_loads(<span style="color:#66d9ef">void</span>)
{
    <span style="color:#66d9ef">int</span> i;

    <span style="color:#75715e">// Detach current loadable list.
</span><span style="color:#75715e"></span>    <span style="color:#75715e">// 分离当前可加载列表。
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">struct</span> loadable_class <span style="color:#f92672">*</span>classes <span style="color:#f92672">=</span> loadable_classes;
    <span style="color:#66d9ef">int</span> used <span style="color:#f92672">=</span> loadable_classes_used;
    loadable_classes <span style="color:#f92672">=</span> nil;
    loadable_classes_allocated <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
    loadable_classes_used <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;

    <span style="color:#75715e">// Call all +loads for the detached list.
</span><span style="color:#75715e"></span>    <span style="color:#75715e">// 在分离的表中调用所有 +load。
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">for</span> (i <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>; i <span style="color:#f92672">&lt;</span> used; i<span style="color:#f92672">+</span><span style="color:#f92672">+</span>) {
        <span style="color:#66d9ef">Class</span> cls <span style="color:#f92672">=</span> classes[i].cls;
        load_method_t load_method <span style="color:#f92672">=</span> (load_method_t)classes[i].method;
        <span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span>cls) <span style="color:#66d9ef">continue</span>;

        <span style="color:#75715e">// OPTION(PrintLoading, OBJC_PRINT_LOAD_METHODS, &#34;log calls to class and category +load methods&#34;)
</span><span style="color:#75715e"></span>        <span style="color:#66d9ef">if</span> (PrintLoading) {
            _objc_inform(<span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">LOAD: +[%s load]</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>, cls<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>nameForLogging());
        }
        <span style="color:#75715e">// 💡 调用 +load
</span><span style="color:#75715e"></span>        (<span style="color:#f92672">*</span>load_method)(cls, SEL_load);
    }

    <span style="color:#75715e">// Destroy the detached list.
</span><span style="color:#75715e"></span>    <span style="color:#75715e">// 销毁分离列表
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">if</span> (classes) free(classes);
}

<span style="color:#75715e">// objc-loadmethod.mm
</span><span style="color:#75715e"></span><span style="color:#75715e">/***********************************************************************
</span><span style="color:#75715e">* call_category_loads
</span><span style="color:#75715e">* Call some pending category +load methods.
</span><span style="color:#75715e">* 调用一些分类中未调用的 +load 方法。
</span><span style="color:#75715e">* The parent class of the +load-implementing categories has all of
</span><span style="color:#75715e">*   its categories attached, in case some are lazily waiting for +initalize.
</span><span style="color:#75715e">* 实现 +load 分类的父类拥有所有其附加的分类 ，来防止等待 +initialize 懒加载。
</span><span style="color:#75715e">*
</span><span style="color:#75715e">* Don&#39;t call +load unless the parent class is connected.
</span><span style="color:#75715e">* If new categories become loadable, +load is NOT called, and they
</span><span style="color:#75715e">*   are added to the end of the loadable list, and we return TRUE.
</span><span style="color:#75715e">* Return FALSE if no new categories became loadable.
</span><span style="color:#75715e">* 除非父类已经连接，否则不要调用 +load。
</span><span style="color:#75715e">* 如果新的分类变成可加载的，+load 未被调用，并且它们被添加到可加载列表的末尾，返回 TRUE。
</span><span style="color:#75715e">* 如果没有新的分类变为可加载的，返回 FALSE。
</span><span style="color:#75715e">*
</span><span style="color:#75715e">* Called only by call_load_methods().
</span><span style="color:#75715e">* 只能由 call_load_methods() 调用。
</span><span style="color:#75715e">**********************************************************************/</span>
<span style="color:#66d9ef">static</span> <span style="color:#66d9ef">bool</span> call_category_loads(<span style="color:#66d9ef">void</span>)
{
    <span style="color:#66d9ef">int</span> i, shift;
    <span style="color:#66d9ef">bool</span> new_categories_added <span style="color:#f92672">=</span> NO;

    <span style="color:#75715e">// Detach current loadable list.
</span><span style="color:#75715e"></span>    <span style="color:#75715e">// 分离当前可加载列表。
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">struct</span> loadable_category <span style="color:#f92672">*</span>cats <span style="color:#f92672">=</span> loadable_categories;
    <span style="color:#66d9ef">int</span> used <span style="color:#f92672">=</span> loadable_categories_used;
    <span style="color:#66d9ef">int</span> allocated <span style="color:#f92672">=</span> loadable_categories_allocated;
    loadable_categories <span style="color:#f92672">=</span> nil;
    loadable_categories_allocated <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
    loadable_categories_used <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;

    <span style="color:#75715e">// Call all +loads for the detached list.
</span><span style="color:#75715e"></span>    <span style="color:#75715e">// 为分离的列表调用所有的 +load。
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">for</span> (i <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>; i <span style="color:#f92672">&lt;</span> used; i<span style="color:#f92672">+</span><span style="color:#f92672">+</span>) {
        Category cat <span style="color:#f92672">=</span> cats[i].cat;
        load_method_t load_method <span style="color:#f92672">=</span> (load_method_t)cats[i].method;
        <span style="color:#66d9ef">Class</span> cls;
        <span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span>cat) <span style="color:#66d9ef">continue</span>;

        <span style="color:#75715e">// 获取主类
</span><span style="color:#75715e"></span>        cls <span style="color:#f92672">=</span> _category_getClass(cat);
        <span style="color:#66d9ef">if</span> (cls  <span style="color:#f92672">&amp;</span><span style="color:#f92672">&amp;</span>  cls<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>isLoadable()) {
            <span style="color:#75715e">// OPTION(PrintLoading, OBJC_PRINT_LOAD_METHODS, &#34;log calls to class and category +load methods&#34;)
</span><span style="color:#75715e"></span>            <span style="color:#66d9ef">if</span> (PrintLoading) {
                _objc_inform(<span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">LOAD: +[%s(%s) load]</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>,
                             cls<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>nameForLogging(),
                             _category_getName(cat));
            }
            <span style="color:#75715e">// 💡 调用 +load
</span><span style="color:#75715e"></span>            (<span style="color:#f92672">*</span>load_method)(cls, SEL_load);
            <span style="color:#75715e">// 置为空
</span><span style="color:#75715e"></span>            cats[i].cat <span style="color:#f92672">=</span> nil;
        }
    }

    <span style="color:#75715e">// Compact detached list (order-preserving)
</span><span style="color:#75715e"></span>    <span style="color:#75715e">// 压缩分离列表（保留顺序）
</span><span style="color:#75715e"></span>    shift <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
    <span style="color:#66d9ef">for</span> (i <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>; i <span style="color:#f92672">&lt;</span> used; i<span style="color:#f92672">+</span><span style="color:#f92672">+</span>) {
        <span style="color:#66d9ef">if</span> (cats[i].cat) {
            cats[i<span style="color:#f92672">-</span>shift] <span style="color:#f92672">=</span> cats[i];
        } <span style="color:#66d9ef">else</span> {
            shift<span style="color:#f92672">+</span><span style="color:#f92672">+</span>;
        }
    }
    used <span style="color:#f92672">-</span><span style="color:#f92672">=</span> shift;

    <span style="color:#75715e">// Copy any new +load candidates from the new list to the detached list.
</span><span style="color:#75715e"></span>    <span style="color:#75715e">// 从新的列表中拷贝所有新的 +load 候选到分离列表。
</span><span style="color:#75715e"></span>    new_categories_added <span style="color:#f92672">=</span> (loadable_categories_used <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">0</span>);
    <span style="color:#66d9ef">for</span> (i <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>; i <span style="color:#f92672">&lt;</span> loadable_categories_used; i<span style="color:#f92672">+</span><span style="color:#f92672">+</span>) {
        <span style="color:#66d9ef">if</span> (used <span style="color:#f92672">=</span><span style="color:#f92672">=</span> allocated) {
            allocated <span style="color:#f92672">=</span> allocated<span style="color:#f92672">*</span><span style="color:#ae81ff">2</span> <span style="color:#f92672">+</span> <span style="color:#ae81ff">16</span>;
            cats <span style="color:#f92672">=</span> (<span style="color:#66d9ef">struct</span> loadable_category <span style="color:#f92672">*</span>)
                realloc(cats, allocated <span style="color:#f92672">*</span>
                                  <span style="color:#66d9ef">sizeof</span>(<span style="color:#66d9ef">struct</span> loadable_category));
        }
        cats[used<span style="color:#f92672">+</span><span style="color:#f92672">+</span>] <span style="color:#f92672">=</span> loadable_categories[i];
    }

    <span style="color:#75715e">// Destroy the new list.
</span><span style="color:#75715e"></span>    <span style="color:#75715e">// 销毁新列表
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">if</span> (loadable_categories) free(loadable_categories);

    <span style="color:#75715e">// Reattach the (now augmented) detached list.
</span><span style="color:#75715e"></span>    <span style="color:#75715e">// 重新附加（现在已增加的）分离列表。
</span><span style="color:#75715e"></span>    <span style="color:#75715e">// But if there&#39;s nothing left to load, destroy the list.
</span><span style="color:#75715e"></span>    <span style="color:#75715e">// 但是如果没有什么要加载的，则销毁该列表。
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">if</span> (used) {
        loadable_categories <span style="color:#f92672">=</span> cats;
        loadable_categories_used <span style="color:#f92672">=</span> used;
        loadable_categories_allocated <span style="color:#f92672">=</span> allocated;
    } <span style="color:#66d9ef">else</span> {
        <span style="color:#66d9ef">if</span> (cats) free(cats);
        loadable_categories <span style="color:#f92672">=</span> nil;
        loadable_categories_used <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
        loadable_categories_allocated <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
    }

    <span style="color:#66d9ef">if</span> (PrintLoading) {
        <span style="color:#66d9ef">if</span> (loadable_categories_used <span style="color:#f92672">!</span><span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>) {
            _objc_inform(<span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">LOAD: %d categories still waiting for +load</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>,
                         loadable_categories_used);
        }
    }

    <span style="color:#66d9ef">return</span> new_categories_added;
}
</code></pre></div><p>上面的源码过程比较复杂，其实主要顺序就是先在 <code>prepare_load_methods</code> 中调用 <code>schedule_class_load</code>，先计划类的 +load 方法调用顺序，在其中会递归找到基类，并 <code>add_class_to_loadable_list</code> 将类中 +load 的 <code>IMP</code> 存储在 <code>loadable_classes</code>；之后在 <code>prepare_load_methods</code> 中调用 <code>add_category_to_loadable_list</code>，再将分类中 +load 的 <code>IMP</code> 存储在 <code>loadable_categories</code>；当类和分类的可加载列表确定后，预备（Prepare）工作完成；之后开始 <code>call_load_methods</code>，调用 <code>call_class_loads</code> 将类中的 +load 全部调用完毕，再调用 <code>call_category_loads</code> 将分类中的 +load 全部调用完毕。这也就完全符合了我们上述的结论，至于毫无关系的类之间以及分类相互之间的调用顺序，由于 <code>loadable_classes</code> 和 <code>loadable_categories</code> 的增加都是按顺序追加，即按照编译顺序来决定，先编译先调用。具体的编译顺序可以在 Xcode -「TARGETS」 -「Build Phases」-「Compile Sources」中找到。</p>
<p><img src="/img/2019/+load_in_ios/2.png" alt="2"></p>
<h3 id="imp--load">IMP 与 +load</h3>
<p>按照我们之前在「iOS 中的 Category」一篇所提到的，当分类中定义了和主类中相同的方法，那么在调用时将选择最后被编译的分类中的实现。因为在运行时，分类中的方法最终将附加到主类或主类元类的方法列表中，最终将返回第一个找到的方法。那么为什么 +load 如此特殊呢？</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-objectivec" data-lang="objectivec"><span style="color:#75715e">// add_class_to_loadable_list
</span><span style="color:#75715e"></span>loadable_classes[loadable_classes_used].cls <span style="color:#f92672">=</span> cls;
loadable_classes[loadable_classes_used].method <span style="color:#f92672">=</span> method;

<span style="color:#75715e">// objc-loadmethod.mm
</span><span style="color:#75715e"></span><span style="color:#66d9ef">typedef</span> <span style="color:#a6e22e">void</span>(<span style="color:#f92672">*</span>load_method_t)(<span style="color:#66d9ef">id</span>, <span style="color:#66d9ef">SEL</span>);

load_method_t load_method <span style="color:#f92672">=</span> (load_method_t)classes[i].method;
(<span style="color:#f92672">*</span>load_method)(cls, SEL_load);
</code></pre></div><p>我们知道，Obj-C 是一门消息机制语言，所谓方法调用是不严谨的，其本质是消息发送（Message Sending），即 <code>objc_msgSend</code>。当「调用」对象方法时，类对象接收到消息作出响应；当「调用」类方法时，元类对象接收到消息作出响应。而在 +load 最终的调用处只是 <code>(*load_method)(cls, SEL_load)</code>，并不存在消息的发送。我们在 <code>add_class_to_loadable_list</code> 中也可以看到，+load 方法本质是存储了方法指针（IMP）并直接调用，因此不会出现类似「覆盖」的情形，而且效率会更高。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-objectivec" data-lang="objectivec"><span style="color:#75715e">#</span><span style="color:#75715e">import &#34;Student.h&#34;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span>
<span style="color:#66d9ef">@implementation</span> <span style="color:#a6e22e">Student</span>
+ (<span style="color:#66d9ef">void</span>)<span style="color:#a6e22e">load</span> {
    [super load];
    NSLog(<span style="color:#e6db74">@&#34;</span><span style="color:#e6db74">Student %s</span><span style="color:#e6db74">&#34;</span>, __func__);
}
<span style="color:#66d9ef">@end</span>

<span style="color:#75715e">// OUTPUT:
</span><span style="color:#75715e"></span><span style="color:#75715e">// Person +[Person load]
</span><span style="color:#75715e"></span><span style="color:#75715e">// Person+Work +[Person(Work) load]
</span><span style="color:#75715e"></span><span style="color:#75715e">// Student +[Student load]
</span><span style="color:#75715e"></span><span style="color:#75715e">// Person+Life +[Person(Life) load]
</span><span style="color:#75715e"></span><span style="color:#75715e">// Student+School +[Student(School) load]
</span><span style="color:#75715e"></span><span style="color:#75715e">// Person+Work +[Person(Work) load]
</span><span style="color:#75715e"></span><span style="color:#75715e">// Hello, World!
</span></code></pre></div><p>那么有了上述基础，当我们在一个类的子类的 +load 中 <code>[super load]</code> 又会调用到到底哪个类中呢（当然，在实际开发中这种情几乎不可能存在）？答案就是 <code>[super load]</code> 将调用到 <code>Person</code> 最后一个被编译的分类（<code>Person+Work</code>）中的 <code>+load</code> 方法，因为这里是消息发送，而不是通过方法指针。</p>
<h3 id="objcprintloadmethods"><code>OBJC_PRINT_LOAD_METHODS</code></h3>
<p>在 objc4 的源码中提供了很多环境变量，方便我们 Debug 时输出一些内部源码的执行信息。<code>OBJC_PRINT_LOAD_METHODS</code> 即是 <code>+load</code> 相关的一个环境变量，将 <code>OBJC_PRINT_LOAD_METHODS</code> 在 Xcode 中设置为 <code>YES</code> 后，将会打印出很多 +load 方法执行时的信息。从下面的信息我们也可以得知，Obj-C 内也广泛使用了 +load，而因为我们自定义的类会在最晚被编译，因此也会在最晚去调用：</p>
<!-- raw HTML omitted -->
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-objectivec" data-lang="objectivec">objc[<span style="color:#ae81ff">63382</span>]<span style="color:#f92672">:</span> LOAD: <span style="color:#66d9ef">class</span> <span style="color:#960050;background-color:#1e0010">&#39;</span>NSObject<span style="color:#960050;background-color:#1e0010">&#39;</span> scheduled <span style="color:#66d9ef">for</span> <span style="color:#f92672">+</span>load
objc[<span style="color:#ae81ff">63382</span>]<span style="color:#f92672">:</span> LOAD: <span style="color:#66d9ef">class</span> <span style="color:#960050;background-color:#1e0010">&#39;</span>OS_dispatch_queue<span style="color:#960050;background-color:#1e0010">&#39;</span> scheduled <span style="color:#66d9ef">for</span> <span style="color:#f92672">+</span>load
objc[<span style="color:#ae81ff">63382</span>]<span style="color:#f92672">:</span> LOAD: <span style="color:#66d9ef">class</span> <span style="color:#960050;background-color:#1e0010">&#39;</span>OS_dispatch_source<span style="color:#960050;background-color:#1e0010">&#39;</span> scheduled <span style="color:#66d9ef">for</span> <span style="color:#f92672">+</span>load
objc[<span style="color:#ae81ff">63382</span>]<span style="color:#f92672">:</span> LOAD: <span style="color:#66d9ef">class</span> <span style="color:#960050;background-color:#1e0010">&#39;</span>OS_dispatch_mach<span style="color:#960050;background-color:#1e0010">&#39;</span> scheduled <span style="color:#66d9ef">for</span> <span style="color:#f92672">+</span>load
objc[<span style="color:#ae81ff">63382</span>]<span style="color:#f92672">:</span> LOAD: <span style="color:#66d9ef">class</span> <span style="color:#960050;background-color:#1e0010">&#39;</span>OS_dispatch_queue_serial<span style="color:#960050;background-color:#1e0010">&#39;</span> scheduled <span style="color:#66d9ef">for</span> <span style="color:#f92672">+</span>load
objc[<span style="color:#ae81ff">63382</span>]<span style="color:#f92672">:</span> LOAD: <span style="color:#66d9ef">class</span> <span style="color:#960050;background-color:#1e0010">&#39;</span>OS_dispatch_queue_runloop<span style="color:#960050;background-color:#1e0010">&#39;</span> scheduled <span style="color:#66d9ef">for</span> <span style="color:#f92672">+</span>load
objc[<span style="color:#ae81ff">63382</span>]<span style="color:#f92672">:</span> LOAD: <span style="color:#66d9ef">class</span> <span style="color:#960050;background-color:#1e0010">&#39;</span>OS_dispatch_semaphore<span style="color:#960050;background-color:#1e0010">&#39;</span> scheduled <span style="color:#66d9ef">for</span> <span style="color:#f92672">+</span>load
objc[<span style="color:#ae81ff">63382</span>]<span style="color:#f92672">:</span> LOAD: <span style="color:#66d9ef">class</span> <span style="color:#960050;background-color:#1e0010">&#39;</span>OS_dispatch_group<span style="color:#960050;background-color:#1e0010">&#39;</span> scheduled <span style="color:#66d9ef">for</span> <span style="color:#f92672">+</span>load
objc[<span style="color:#ae81ff">63382</span>]<span style="color:#f92672">:</span> LOAD: <span style="color:#66d9ef">class</span> <span style="color:#960050;background-color:#1e0010">&#39;</span>OS_dispatch_workloop<span style="color:#960050;background-color:#1e0010">&#39;</span> scheduled <span style="color:#66d9ef">for</span> <span style="color:#f92672">+</span>load
objc[<span style="color:#ae81ff">63382</span>]<span style="color:#f92672">:</span> LOAD: <span style="color:#66d9ef">class</span> <span style="color:#960050;background-color:#1e0010">&#39;</span>OS_dispatch_queue_concurrent<span style="color:#960050;background-color:#1e0010">&#39;</span> scheduled <span style="color:#66d9ef">for</span> <span style="color:#f92672">+</span>load
objc[<span style="color:#ae81ff">63382</span>]<span style="color:#f92672">:</span> LOAD: <span style="color:#66d9ef">class</span> <span style="color:#960050;background-color:#1e0010">&#39;</span>OS_dispatch_queue_main<span style="color:#960050;background-color:#1e0010">&#39;</span> scheduled <span style="color:#66d9ef">for</span> <span style="color:#f92672">+</span>load
objc[<span style="color:#ae81ff">63382</span>]<span style="color:#f92672">:</span> LOAD: <span style="color:#66d9ef">class</span> <span style="color:#960050;background-color:#1e0010">&#39;</span>OS_dispatch_queue_global<span style="color:#960050;background-color:#1e0010">&#39;</span> scheduled <span style="color:#66d9ef">for</span> <span style="color:#f92672">+</span>load
objc[<span style="color:#ae81ff">63382</span>]<span style="color:#f92672">:</span> LOAD: <span style="color:#66d9ef">class</span> <span style="color:#960050;background-color:#1e0010">&#39;</span>OS_dispatch_queue_pthread_root<span style="color:#960050;background-color:#1e0010">&#39;</span> scheduled <span style="color:#66d9ef">for</span> <span style="color:#f92672">+</span>load
objc[<span style="color:#ae81ff">63382</span>]<span style="color:#f92672">:</span> LOAD: <span style="color:#66d9ef">class</span> <span style="color:#960050;background-color:#1e0010">&#39;</span>OS_dispatch_queue_mgr<span style="color:#960050;background-color:#1e0010">&#39;</span> scheduled <span style="color:#66d9ef">for</span> <span style="color:#f92672">+</span>load
objc[<span style="color:#ae81ff">63382</span>]<span style="color:#f92672">:</span> LOAD: <span style="color:#66d9ef">class</span> <span style="color:#960050;background-color:#1e0010">&#39;</span>OS_dispatch_queue_attr<span style="color:#960050;background-color:#1e0010">&#39;</span> scheduled <span style="color:#66d9ef">for</span> <span style="color:#f92672">+</span>load
objc[<span style="color:#ae81ff">63382</span>]<span style="color:#f92672">:</span> LOAD: <span style="color:#66d9ef">class</span> <span style="color:#960050;background-color:#1e0010">&#39;</span>OS_dispatch_mach_msg<span style="color:#960050;background-color:#1e0010">&#39;</span> scheduled <span style="color:#66d9ef">for</span> <span style="color:#f92672">+</span>load
objc[<span style="color:#ae81ff">63382</span>]<span style="color:#f92672">:</span> LOAD: <span style="color:#66d9ef">class</span> <span style="color:#960050;background-color:#1e0010">&#39;</span>OS_dispatch_io<span style="color:#960050;background-color:#1e0010">&#39;</span> scheduled <span style="color:#66d9ef">for</span> <span style="color:#f92672">+</span>load
objc[<span style="color:#ae81ff">63382</span>]<span style="color:#f92672">:</span> LOAD: <span style="color:#66d9ef">class</span> <span style="color:#960050;background-color:#1e0010">&#39;</span>OS_dispatch_operation<span style="color:#960050;background-color:#1e0010">&#39;</span> scheduled <span style="color:#66d9ef">for</span> <span style="color:#f92672">+</span>load
objc[<span style="color:#ae81ff">63382</span>]<span style="color:#f92672">:</span> LOAD: <span style="color:#66d9ef">class</span> <span style="color:#960050;background-color:#1e0010">&#39;</span>OS_dispatch_disk<span style="color:#960050;background-color:#1e0010">&#39;</span> scheduled <span style="color:#66d9ef">for</span> <span style="color:#f92672">+</span>load
objc[<span style="color:#ae81ff">63382</span>]<span style="color:#f92672">:</span> LOAD: <span style="color:#66d9ef">class</span> <span style="color:#960050;background-color:#1e0010">&#39;</span>OS_voucher<span style="color:#960050;background-color:#1e0010">&#39;</span> scheduled <span style="color:#66d9ef">for</span> <span style="color:#f92672">+</span>load
objc[<span style="color:#ae81ff">63382</span>]<span style="color:#f92672">:</span> LOAD: <span style="color:#66d9ef">class</span> <span style="color:#960050;background-color:#1e0010">&#39;</span>OS_dispatch_data_empty<span style="color:#960050;background-color:#1e0010">&#39;</span> scheduled <span style="color:#66d9ef">for</span> <span style="color:#f92672">+</span>load
objc[<span style="color:#ae81ff">63382</span>]<span style="color:#f92672">:</span> LOAD: <span style="color:#f92672">+</span>[NSObject load]

objc[<span style="color:#ae81ff">63382</span>]<span style="color:#f92672">:</span> LOAD: <span style="color:#f92672">+</span>[OS_dispatch_queue load]

objc[<span style="color:#ae81ff">63382</span>]<span style="color:#f92672">:</span> LOAD: <span style="color:#f92672">+</span>[OS_dispatch_source load]

objc[<span style="color:#ae81ff">63382</span>]<span style="color:#f92672">:</span> LOAD: <span style="color:#f92672">+</span>[OS_dispatch_mach load]

objc[<span style="color:#ae81ff">63382</span>]<span style="color:#f92672">:</span> LOAD: <span style="color:#f92672">+</span>[OS_dispatch_queue_serial load]

objc[<span style="color:#ae81ff">63382</span>]<span style="color:#f92672">:</span> LOAD: <span style="color:#f92672">+</span>[OS_dispatch_queue_runloop load]

objc[<span style="color:#ae81ff">63382</span>]<span style="color:#f92672">:</span> LOAD: <span style="color:#f92672">+</span>[OS_dispatch_semaphore load]

objc[<span style="color:#ae81ff">63382</span>]<span style="color:#f92672">:</span> LOAD: <span style="color:#f92672">+</span>[OS_dispatch_group load]

objc[<span style="color:#ae81ff">63382</span>]<span style="color:#f92672">:</span> LOAD: <span style="color:#f92672">+</span>[OS_dispatch_workloop load]

objc[<span style="color:#ae81ff">63382</span>]<span style="color:#f92672">:</span> LOAD: <span style="color:#f92672">+</span>[OS_dispatch_queue_concurrent load]

objc[<span style="color:#ae81ff">63382</span>]<span style="color:#f92672">:</span> LOAD: <span style="color:#f92672">+</span>[OS_dispatch_queue_main load]

objc[<span style="color:#ae81ff">63382</span>]<span style="color:#f92672">:</span> LOAD: <span style="color:#f92672">+</span>[OS_dispatch_queue_global load]

objc[<span style="color:#ae81ff">63382</span>]<span style="color:#f92672">:</span> LOAD: <span style="color:#f92672">+</span>[OS_dispatch_queue_pthread_root load]

objc[<span style="color:#ae81ff">63382</span>]<span style="color:#f92672">:</span> LOAD: <span style="color:#f92672">+</span>[OS_dispatch_queue_mgr load]

objc[<span style="color:#ae81ff">63382</span>]<span style="color:#f92672">:</span> LOAD: <span style="color:#f92672">+</span>[OS_dispatch_queue_attr load]

objc[<span style="color:#ae81ff">63382</span>]<span style="color:#f92672">:</span> LOAD: <span style="color:#f92672">+</span>[OS_dispatch_mach_msg load]

objc[<span style="color:#ae81ff">63382</span>]<span style="color:#f92672">:</span> LOAD: <span style="color:#f92672">+</span>[OS_dispatch_io load]

objc[<span style="color:#ae81ff">63382</span>]<span style="color:#f92672">:</span> LOAD: <span style="color:#f92672">+</span>[OS_dispatch_operation load]

objc[<span style="color:#ae81ff">63382</span>]<span style="color:#f92672">:</span> LOAD: <span style="color:#f92672">+</span>[OS_dispatch_disk load]

objc[<span style="color:#ae81ff">63382</span>]<span style="color:#f92672">:</span> LOAD: <span style="color:#f92672">+</span>[OS_voucher load]

objc[<span style="color:#ae81ff">63382</span>]<span style="color:#f92672">:</span> LOAD: <span style="color:#f92672">+</span>[OS_dispatch_data_empty load]

objc[<span style="color:#ae81ff">63382</span>]<span style="color:#f92672">:</span> LOAD: <span style="color:#66d9ef">class</span> <span style="color:#960050;background-color:#1e0010">&#39;</span>OS_os_log<span style="color:#960050;background-color:#1e0010">&#39;</span> scheduled <span style="color:#66d9ef">for</span> <span style="color:#f92672">+</span>load
objc[<span style="color:#ae81ff">63382</span>]<span style="color:#f92672">:</span> LOAD: <span style="color:#66d9ef">class</span> <span style="color:#960050;background-color:#1e0010">&#39;</span>OS_os_activity<span style="color:#960050;background-color:#1e0010">&#39;</span> scheduled <span style="color:#66d9ef">for</span> <span style="color:#f92672">+</span>load
objc[<span style="color:#ae81ff">63382</span>]<span style="color:#f92672">:</span> LOAD: <span style="color:#f92672">+</span>[OS_os_log load]

objc[<span style="color:#ae81ff">63382</span>]<span style="color:#f92672">:</span> LOAD: <span style="color:#f92672">+</span>[OS_os_activity load]

objc[<span style="color:#ae81ff">63382</span>]<span style="color:#f92672">:</span> LOAD: <span style="color:#66d9ef">class</span> <span style="color:#960050;background-color:#1e0010">&#39;</span>OS_xpc_connection<span style="color:#960050;background-color:#1e0010">&#39;</span> scheduled <span style="color:#66d9ef">for</span> <span style="color:#f92672">+</span>load
objc[<span style="color:#ae81ff">63382</span>]<span style="color:#f92672">:</span> LOAD: <span style="color:#66d9ef">class</span> <span style="color:#960050;background-color:#1e0010">&#39;</span>OS_xpc_service<span style="color:#960050;background-color:#1e0010">&#39;</span> scheduled <span style="color:#66d9ef">for</span> <span style="color:#f92672">+</span>load
objc[<span style="color:#ae81ff">63382</span>]<span style="color:#f92672">:</span> LOAD: <span style="color:#66d9ef">class</span> <span style="color:#960050;background-color:#1e0010">&#39;</span>OS_xpc_null<span style="color:#960050;background-color:#1e0010">&#39;</span> scheduled <span style="color:#66d9ef">for</span> <span style="color:#f92672">+</span>load
objc[<span style="color:#ae81ff">63382</span>]<span style="color:#f92672">:</span> LOAD: <span style="color:#66d9ef">class</span> <span style="color:#960050;background-color:#1e0010">&#39;</span>OS_xpc_bool<span style="color:#960050;background-color:#1e0010">&#39;</span> scheduled <span style="color:#66d9ef">for</span> <span style="color:#f92672">+</span>load
objc[<span style="color:#ae81ff">63382</span>]<span style="color:#f92672">:</span> LOAD: <span style="color:#66d9ef">class</span> <span style="color:#960050;background-color:#1e0010">&#39;</span>OS_xpc_double<span style="color:#960050;background-color:#1e0010">&#39;</span> scheduled <span style="color:#66d9ef">for</span> <span style="color:#f92672">+</span>load
objc[<span style="color:#ae81ff">63382</span>]<span style="color:#f92672">:</span> LOAD: <span style="color:#66d9ef">class</span> <span style="color:#960050;background-color:#1e0010">&#39;</span>OS_xpc_pointer<span style="color:#960050;background-color:#1e0010">&#39;</span> scheduled <span style="color:#66d9ef">for</span> <span style="color:#f92672">+</span>load
objc[<span style="color:#ae81ff">63382</span>]<span style="color:#f92672">:</span> LOAD: <span style="color:#66d9ef">class</span> <span style="color:#960050;background-color:#1e0010">&#39;</span>OS_xpc_date<span style="color:#960050;background-color:#1e0010">&#39;</span> scheduled <span style="color:#66d9ef">for</span> <span style="color:#f92672">+</span>load
objc[<span style="color:#ae81ff">63382</span>]<span style="color:#f92672">:</span> LOAD: <span style="color:#66d9ef">class</span> <span style="color:#960050;background-color:#1e0010">&#39;</span>OS_xpc_data<span style="color:#960050;background-color:#1e0010">&#39;</span> scheduled <span style="color:#66d9ef">for</span> <span style="color:#f92672">+</span>load
objc[<span style="color:#ae81ff">63382</span>]<span style="color:#f92672">:</span> LOAD: <span style="color:#66d9ef">class</span> <span style="color:#960050;background-color:#1e0010">&#39;</span>OS_xpc_string<span style="color:#960050;background-color:#1e0010">&#39;</span> scheduled <span style="color:#66d9ef">for</span> <span style="color:#f92672">+</span>load
objc[<span style="color:#ae81ff">63382</span>]<span style="color:#f92672">:</span> LOAD: <span style="color:#66d9ef">class</span> <span style="color:#960050;background-color:#1e0010">&#39;</span>OS_xpc_uuid<span style="color:#960050;background-color:#1e0010">&#39;</span> scheduled <span style="color:#66d9ef">for</span> <span style="color:#f92672">+</span>load
objc[<span style="color:#ae81ff">63382</span>]<span style="color:#f92672">:</span> LOAD: <span style="color:#66d9ef">class</span> <span style="color:#960050;background-color:#1e0010">&#39;</span>OS_xpc_fd<span style="color:#960050;background-color:#1e0010">&#39;</span> scheduled <span style="color:#66d9ef">for</span> <span style="color:#f92672">+</span>load
objc[<span style="color:#ae81ff">63382</span>]<span style="color:#f92672">:</span> LOAD: <span style="color:#66d9ef">class</span> <span style="color:#960050;background-color:#1e0010">&#39;</span>OS_xpc_shmem<span style="color:#960050;background-color:#1e0010">&#39;</span> scheduled <span style="color:#66d9ef">for</span> <span style="color:#f92672">+</span>load
objc[<span style="color:#ae81ff">63382</span>]<span style="color:#f92672">:</span> LOAD: <span style="color:#66d9ef">class</span> <span style="color:#960050;background-color:#1e0010">&#39;</span>OS_xpc_mach_send<span style="color:#960050;background-color:#1e0010">&#39;</span> scheduled <span style="color:#66d9ef">for</span> <span style="color:#f92672">+</span>load
objc[<span style="color:#ae81ff">63382</span>]<span style="color:#f92672">:</span> LOAD: <span style="color:#66d9ef">class</span> <span style="color:#960050;background-color:#1e0010">&#39;</span>OS_xpc_array<span style="color:#960050;background-color:#1e0010">&#39;</span> scheduled <span style="color:#66d9ef">for</span> <span style="color:#f92672">+</span>load
objc[<span style="color:#ae81ff">63382</span>]<span style="color:#f92672">:</span> LOAD: <span style="color:#66d9ef">class</span> <span style="color:#960050;background-color:#1e0010">&#39;</span>OS_xpc_dictionary<span style="color:#960050;background-color:#1e0010">&#39;</span> scheduled <span style="color:#66d9ef">for</span> <span style="color:#f92672">+</span>load
objc[<span style="color:#ae81ff">63382</span>]<span style="color:#f92672">:</span> LOAD: <span style="color:#66d9ef">class</span> <span style="color:#960050;background-color:#1e0010">&#39;</span>OS_xpc_error<span style="color:#960050;background-color:#1e0010">&#39;</span> scheduled <span style="color:#66d9ef">for</span> <span style="color:#f92672">+</span>load
objc[<span style="color:#ae81ff">63382</span>]<span style="color:#f92672">:</span> LOAD: <span style="color:#66d9ef">class</span> <span style="color:#960050;background-color:#1e0010">&#39;</span>OS_xpc_endpoint<span style="color:#960050;background-color:#1e0010">&#39;</span> scheduled <span style="color:#66d9ef">for</span> <span style="color:#f92672">+</span>load
objc[<span style="color:#ae81ff">63382</span>]<span style="color:#f92672">:</span> LOAD: <span style="color:#66d9ef">class</span> <span style="color:#960050;background-color:#1e0010">&#39;</span>OS_xpc_serializer<span style="color:#960050;background-color:#1e0010">&#39;</span> scheduled <span style="color:#66d9ef">for</span> <span style="color:#f92672">+</span>load
objc[<span style="color:#ae81ff">63382</span>]<span style="color:#f92672">:</span> LOAD: <span style="color:#66d9ef">class</span> <span style="color:#960050;background-color:#1e0010">&#39;</span>OS_xpc_pipe<span style="color:#960050;background-color:#1e0010">&#39;</span> scheduled <span style="color:#66d9ef">for</span> <span style="color:#f92672">+</span>load
objc[<span style="color:#ae81ff">63382</span>]<span style="color:#f92672">:</span> LOAD: <span style="color:#66d9ef">class</span> <span style="color:#960050;background-color:#1e0010">&#39;</span>OS_xpc_mach_recv<span style="color:#960050;background-color:#1e0010">&#39;</span> scheduled <span style="color:#66d9ef">for</span> <span style="color:#f92672">+</span>load
objc[<span style="color:#ae81ff">63382</span>]<span style="color:#f92672">:</span> LOAD: <span style="color:#66d9ef">class</span> <span style="color:#960050;background-color:#1e0010">&#39;</span>OS_xpc_bundle<span style="color:#960050;background-color:#1e0010">&#39;</span> scheduled <span style="color:#66d9ef">for</span> <span style="color:#f92672">+</span>load
objc[<span style="color:#ae81ff">63382</span>]<span style="color:#f92672">:</span> LOAD: <span style="color:#66d9ef">class</span> <span style="color:#960050;background-color:#1e0010">&#39;</span>OS_xpc_service_instance<span style="color:#960050;background-color:#1e0010">&#39;</span> scheduled <span style="color:#66d9ef">for</span> <span style="color:#f92672">+</span>load
objc[<span style="color:#ae81ff">63382</span>]<span style="color:#f92672">:</span> LOAD: <span style="color:#66d9ef">class</span> <span style="color:#960050;background-color:#1e0010">&#39;</span>OS_xpc_activity<span style="color:#960050;background-color:#1e0010">&#39;</span> scheduled <span style="color:#66d9ef">for</span> <span style="color:#f92672">+</span>load
objc[<span style="color:#ae81ff">63382</span>]<span style="color:#f92672">:</span> LOAD: <span style="color:#66d9ef">class</span> <span style="color:#960050;background-color:#1e0010">&#39;</span>OS_xpc_file_transfer<span style="color:#960050;background-color:#1e0010">&#39;</span> scheduled <span style="color:#66d9ef">for</span> <span style="color:#f92672">+</span>load
objc[<span style="color:#ae81ff">63382</span>]<span style="color:#f92672">:</span> LOAD: <span style="color:#66d9ef">class</span> <span style="color:#960050;background-color:#1e0010">&#39;</span>OS_xpc_int64<span style="color:#960050;background-color:#1e0010">&#39;</span> scheduled <span style="color:#66d9ef">for</span> <span style="color:#f92672">+</span>load
objc[<span style="color:#ae81ff">63382</span>]<span style="color:#f92672">:</span> LOAD: <span style="color:#66d9ef">class</span> <span style="color:#960050;background-color:#1e0010">&#39;</span>OS_xpc_uint64<span style="color:#960050;background-color:#1e0010">&#39;</span> scheduled <span style="color:#66d9ef">for</span> <span style="color:#f92672">+</span>load
objc[<span style="color:#ae81ff">63382</span>]<span style="color:#f92672">:</span> LOAD: <span style="color:#f92672">+</span>[OS_xpc_connection load]

objc[<span style="color:#ae81ff">63382</span>]<span style="color:#f92672">:</span> LOAD: <span style="color:#f92672">+</span>[OS_xpc_service load]

objc[<span style="color:#ae81ff">63382</span>]<span style="color:#f92672">:</span> LOAD: <span style="color:#f92672">+</span>[OS_xpc_null load]

objc[<span style="color:#ae81ff">63382</span>]<span style="color:#f92672">:</span> LOAD: <span style="color:#f92672">+</span>[OS_xpc_bool load]

objc[<span style="color:#ae81ff">63382</span>]<span style="color:#f92672">:</span> LOAD: <span style="color:#f92672">+</span>[OS_xpc_double load]

objc[<span style="color:#ae81ff">63382</span>]<span style="color:#f92672">:</span> LOAD: <span style="color:#f92672">+</span>[OS_xpc_pointer load]

objc[<span style="color:#ae81ff">63382</span>]<span style="color:#f92672">:</span> LOAD: <span style="color:#f92672">+</span>[OS_xpc_date load]

objc[<span style="color:#ae81ff">63382</span>]<span style="color:#f92672">:</span> LOAD: <span style="color:#f92672">+</span>[OS_xpc_data load]

objc[<span style="color:#ae81ff">63382</span>]<span style="color:#f92672">:</span> LOAD: <span style="color:#f92672">+</span>[OS_xpc_string load]

objc[<span style="color:#ae81ff">63382</span>]<span style="color:#f92672">:</span> LOAD: <span style="color:#f92672">+</span>[OS_xpc_uuid load]

objc[<span style="color:#ae81ff">63382</span>]<span style="color:#f92672">:</span> LOAD: <span style="color:#f92672">+</span>[OS_xpc_fd load]

objc[<span style="color:#ae81ff">63382</span>]<span style="color:#f92672">:</span> LOAD: <span style="color:#f92672">+</span>[OS_xpc_shmem load]

objc[<span style="color:#ae81ff">63382</span>]<span style="color:#f92672">:</span> LOAD: <span style="color:#f92672">+</span>[OS_xpc_mach_send load]

objc[<span style="color:#ae81ff">63382</span>]<span style="color:#f92672">:</span> LOAD: <span style="color:#f92672">+</span>[OS_xpc_array load]

objc[<span style="color:#ae81ff">63382</span>]<span style="color:#f92672">:</span> LOAD: <span style="color:#f92672">+</span>[OS_xpc_dictionary load]

objc[<span style="color:#ae81ff">63382</span>]<span style="color:#f92672">:</span> LOAD: <span style="color:#f92672">+</span>[OS_xpc_error load]

objc[<span style="color:#ae81ff">63382</span>]<span style="color:#f92672">:</span> LOAD: <span style="color:#f92672">+</span>[OS_xpc_endpoint load]

objc[<span style="color:#ae81ff">63382</span>]<span style="color:#f92672">:</span> LOAD: <span style="color:#f92672">+</span>[OS_xpc_serializer load]

objc[<span style="color:#ae81ff">63382</span>]<span style="color:#f92672">:</span> LOAD: <span style="color:#f92672">+</span>[OS_xpc_pipe load]

objc[<span style="color:#ae81ff">63382</span>]<span style="color:#f92672">:</span> LOAD: <span style="color:#f92672">+</span>[OS_xpc_mach_recv load]

objc[<span style="color:#ae81ff">63382</span>]<span style="color:#f92672">:</span> LOAD: <span style="color:#f92672">+</span>[OS_xpc_bundle load]

objc[<span style="color:#ae81ff">63382</span>]<span style="color:#f92672">:</span> LOAD: <span style="color:#f92672">+</span>[OS_xpc_service_instance load]

objc[<span style="color:#ae81ff">63382</span>]<span style="color:#f92672">:</span> LOAD: <span style="color:#f92672">+</span>[OS_xpc_activity load]

objc[<span style="color:#ae81ff">63382</span>]<span style="color:#f92672">:</span> LOAD: <span style="color:#f92672">+</span>[OS_xpc_file_transfer load]

objc[<span style="color:#ae81ff">63382</span>]<span style="color:#f92672">:</span> LOAD: <span style="color:#f92672">+</span>[OS_xpc_int64 load]

objc[<span style="color:#ae81ff">63382</span>]<span style="color:#f92672">:</span> LOAD: <span style="color:#f92672">+</span>[OS_xpc_uint64 load]

objc[<span style="color:#ae81ff">63382</span>]<span style="color:#f92672">:</span> LOAD: <span style="color:#66d9ef">class</span> <span style="color:#960050;background-color:#1e0010">&#39;</span>__IncompleteProtocol<span style="color:#960050;background-color:#1e0010">&#39;</span> scheduled <span style="color:#66d9ef">for</span> <span style="color:#f92672">+</span>load
objc[<span style="color:#ae81ff">63382</span>]<span style="color:#f92672">:</span> LOAD: <span style="color:#66d9ef">class</span> <span style="color:#960050;background-color:#1e0010">&#39;</span>Protocol<span style="color:#960050;background-color:#1e0010">&#39;</span> scheduled <span style="color:#66d9ef">for</span> <span style="color:#f92672">+</span>load
objc[<span style="color:#ae81ff">63382</span>]<span style="color:#f92672">:</span> LOAD: <span style="color:#66d9ef">class</span> <span style="color:#960050;background-color:#1e0010">&#39;</span>__NSUnrecognizedTaggedPointer<span style="color:#960050;background-color:#1e0010">&#39;</span> scheduled <span style="color:#66d9ef">for</span> <span style="color:#f92672">+</span>load
objc[<span style="color:#ae81ff">63382</span>]<span style="color:#f92672">:</span> LOAD: <span style="color:#f92672">+</span>[__IncompleteProtocol load]

objc[<span style="color:#ae81ff">63382</span>]<span style="color:#f92672">:</span> LOAD: <span style="color:#f92672">+</span>[Protocol load]

objc[<span style="color:#ae81ff">63382</span>]<span style="color:#f92672">:</span> LOAD: <span style="color:#f92672">+</span>[__NSUnrecognizedTaggedPointer load]

objc[<span style="color:#ae81ff">63382</span>]<span style="color:#f92672">:</span> LOAD: category <span style="color:#960050;background-color:#1e0010">&#39;</span>NSObject(NSObject)<span style="color:#960050;background-color:#1e0010">&#39;</span> scheduled <span style="color:#66d9ef">for</span> <span style="color:#f92672">+</span>load
objc[<span style="color:#ae81ff">63382</span>]<span style="color:#f92672">:</span> LOAD: <span style="color:#f92672">+</span>[NSObject(NSObject) load]

objc[<span style="color:#ae81ff">63382</span>]<span style="color:#f92672">:</span> LOAD: category <span style="color:#960050;background-color:#1e0010">&#39;</span>NSObject(NSObject)<span style="color:#960050;background-color:#1e0010">&#39;</span> scheduled <span style="color:#66d9ef">for</span> <span style="color:#f92672">+</span>load
objc[<span style="color:#ae81ff">63382</span>]<span style="color:#f92672">:</span> LOAD: <span style="color:#f92672">+</span>[NSObject(NSObject) load]

objc[<span style="color:#ae81ff">63382</span>]<span style="color:#f92672">:</span> LOAD: category <span style="color:#960050;background-color:#1e0010">&#39;</span>CIFilter(Interposer)<span style="color:#960050;background-color:#1e0010">&#39;</span> scheduled <span style="color:#66d9ef">for</span> <span style="color:#f92672">+</span>load
objc[<span style="color:#ae81ff">63382</span>]<span style="color:#f92672">:</span> LOAD: <span style="color:#f92672">+</span>[CIFilter(Interposer) load]

objc[<span style="color:#ae81ff">63382</span>]<span style="color:#f92672">:</span> LOAD: <span style="color:#66d9ef">class</span> <span style="color:#960050;background-color:#1e0010">&#39;</span>NSApplication<span style="color:#960050;background-color:#1e0010">&#39;</span> scheduled <span style="color:#66d9ef">for</span> <span style="color:#f92672">+</span>load
objc[<span style="color:#ae81ff">63382</span>]<span style="color:#f92672">:</span> LOAD: <span style="color:#66d9ef">class</span> <span style="color:#960050;background-color:#1e0010">&#39;</span>NSBinder<span style="color:#960050;background-color:#1e0010">&#39;</span> scheduled <span style="color:#66d9ef">for</span> <span style="color:#f92672">+</span>load
objc[<span style="color:#ae81ff">63382</span>]<span style="color:#f92672">:</span> LOAD: <span style="color:#66d9ef">class</span> <span style="color:#960050;background-color:#1e0010">&#39;</span>NSColorSpaceColor<span style="color:#960050;background-color:#1e0010">&#39;</span> scheduled <span style="color:#66d9ef">for</span> <span style="color:#f92672">+</span>load
objc[<span style="color:#ae81ff">63382</span>]<span style="color:#f92672">:</span> LOAD: <span style="color:#66d9ef">class</span> <span style="color:#960050;background-color:#1e0010">&#39;</span>NSNextStepFrame<span style="color:#960050;background-color:#1e0010">&#39;</span> scheduled <span style="color:#66d9ef">for</span> <span style="color:#f92672">+</span>load
objc[<span style="color:#ae81ff">63382</span>]<span style="color:#f92672">:</span> LOAD: category <span style="color:#960050;background-color:#1e0010">&#39;</span>NSBundle(NSNibLoading)<span style="color:#960050;background-color:#1e0010">&#39;</span> scheduled <span style="color:#66d9ef">for</span> <span style="color:#f92672">+</span>load
objc[<span style="color:#ae81ff">63382</span>]<span style="color:#f92672">:</span> LOAD: <span style="color:#f92672">+</span>[NSApplication load]

objc[<span style="color:#ae81ff">63382</span>]<span style="color:#f92672">:</span> LOAD: <span style="color:#f92672">+</span>[NSBinder load]

objc[<span style="color:#ae81ff">63382</span>]<span style="color:#f92672">:</span> LOAD: <span style="color:#f92672">+</span>[NSColorSpaceColor load]

objc[<span style="color:#ae81ff">63382</span>]<span style="color:#f92672">:</span> LOAD: <span style="color:#f92672">+</span>[NSNextStepFrame load]

objc[<span style="color:#ae81ff">63382</span>]<span style="color:#f92672">:</span> LOAD: <span style="color:#f92672">+</span>[NSBundle(NSNibLoading) load]

objc[<span style="color:#ae81ff">63382</span>]<span style="color:#f92672">:</span> LOAD: <span style="color:#66d9ef">class</span> <span style="color:#960050;background-color:#1e0010">&#39;</span>Person<span style="color:#960050;background-color:#1e0010">&#39;</span> scheduled <span style="color:#66d9ef">for</span> <span style="color:#f92672">+</span>load
objc[<span style="color:#ae81ff">63382</span>]<span style="color:#f92672">:</span> LOAD: <span style="color:#66d9ef">class</span> <span style="color:#960050;background-color:#1e0010">&#39;</span>Student<span style="color:#960050;background-color:#1e0010">&#39;</span> scheduled <span style="color:#66d9ef">for</span> <span style="color:#f92672">+</span>load
objc[<span style="color:#ae81ff">63382</span>]<span style="color:#f92672">:</span> LOAD: category <span style="color:#960050;background-color:#1e0010">&#39;</span>Person(Life)<span style="color:#960050;background-color:#1e0010">&#39;</span> scheduled <span style="color:#66d9ef">for</span> <span style="color:#f92672">+</span>load
objc[<span style="color:#ae81ff">63382</span>]<span style="color:#f92672">:</span> LOAD: category <span style="color:#960050;background-color:#1e0010">&#39;</span>Student(School)<span style="color:#960050;background-color:#1e0010">&#39;</span> scheduled <span style="color:#66d9ef">for</span> <span style="color:#f92672">+</span>load
objc[<span style="color:#ae81ff">63382</span>]<span style="color:#f92672">:</span> LOAD: category <span style="color:#960050;background-color:#1e0010">&#39;</span>Person(Work)<span style="color:#960050;background-color:#1e0010">&#39;</span> scheduled <span style="color:#66d9ef">for</span> <span style="color:#f92672">+</span>load
objc[<span style="color:#ae81ff">63382</span>]<span style="color:#f92672">:</span> LOAD: <span style="color:#f92672">+</span>[Person load]

<span style="color:#ae81ff">2019</span><span style="color:#f92672">-</span><span style="color:#ae81ff">04</span><span style="color:#f92672">-</span><span style="color:#ae81ff">20</span> <span style="color:#ae81ff">19</span><span style="color:#f92672">:</span><span style="color:#ae81ff">25</span><span style="color:#f92672">:</span><span style="color:#ae81ff">30.541922</span><span style="color:#f92672">+</span><span style="color:#ae81ff">0800</span> Load_Obj<span style="color:#f92672">-</span>C_Demo[<span style="color:#ae81ff">63382</span><span style="color:#f92672">:</span><span style="color:#ae81ff">15374262</span>] Person <span style="color:#f92672">+</span>[Person load]
objc[<span style="color:#ae81ff">63382</span>]<span style="color:#f92672">:</span> LOAD: <span style="color:#f92672">+</span>[Student load]

<span style="color:#ae81ff">2019</span><span style="color:#f92672">-</span><span style="color:#ae81ff">04</span><span style="color:#f92672">-</span><span style="color:#ae81ff">20</span> <span style="color:#ae81ff">19</span><span style="color:#f92672">:</span><span style="color:#ae81ff">25</span><span style="color:#f92672">:</span><span style="color:#ae81ff">30.542367</span><span style="color:#f92672">+</span><span style="color:#ae81ff">0800</span> Load_Obj<span style="color:#f92672">-</span>C_Demo[<span style="color:#ae81ff">63382</span><span style="color:#f92672">:</span><span style="color:#ae81ff">15374262</span>] Person<span style="color:#f92672">+</span>Work <span style="color:#f92672">+</span>[Person(Work) load]
<span style="color:#ae81ff">2019</span><span style="color:#f92672">-</span><span style="color:#ae81ff">04</span><span style="color:#f92672">-</span><span style="color:#ae81ff">20</span> <span style="color:#ae81ff">19</span><span style="color:#f92672">:</span><span style="color:#ae81ff">25</span><span style="color:#f92672">:</span><span style="color:#ae81ff">30.542379</span><span style="color:#f92672">+</span><span style="color:#ae81ff">0800</span> Load_Obj<span style="color:#f92672">-</span>C_Demo[<span style="color:#ae81ff">63382</span><span style="color:#f92672">:</span><span style="color:#ae81ff">15374262</span>] Student <span style="color:#f92672">+</span>[Student load]
objc[<span style="color:#ae81ff">63382</span>]<span style="color:#f92672">:</span> LOAD: <span style="color:#f92672">+</span>[Person(Life) load]

<span style="color:#ae81ff">2019</span><span style="color:#f92672">-</span><span style="color:#ae81ff">04</span><span style="color:#f92672">-</span><span style="color:#ae81ff">20</span> <span style="color:#ae81ff">19</span><span style="color:#f92672">:</span><span style="color:#ae81ff">25</span><span style="color:#f92672">:</span><span style="color:#ae81ff">30.542409</span><span style="color:#f92672">+</span><span style="color:#ae81ff">0800</span> Load_Obj<span style="color:#f92672">-</span>C_Demo[<span style="color:#ae81ff">63382</span><span style="color:#f92672">:</span><span style="color:#ae81ff">15374262</span>] Person<span style="color:#f92672">+</span>Life <span style="color:#f92672">+</span>[Person(Life) load]
objc[<span style="color:#ae81ff">63382</span>]<span style="color:#f92672">:</span> LOAD: <span style="color:#f92672">+</span>[Student(School) load]

<span style="color:#ae81ff">2019</span><span style="color:#f92672">-</span><span style="color:#ae81ff">04</span><span style="color:#f92672">-</span><span style="color:#ae81ff">20</span> <span style="color:#ae81ff">19</span><span style="color:#f92672">:</span><span style="color:#ae81ff">25</span><span style="color:#f92672">:</span><span style="color:#ae81ff">30.542443</span><span style="color:#f92672">+</span><span style="color:#ae81ff">0800</span> Load_Obj<span style="color:#f92672">-</span>C_Demo[<span style="color:#ae81ff">63382</span><span style="color:#f92672">:</span><span style="color:#ae81ff">15374262</span>] Student<span style="color:#f92672">+</span>School <span style="color:#f92672">+</span>[Student(School) load]
objc[<span style="color:#ae81ff">63382</span>]<span style="color:#f92672">:</span> LOAD: <span style="color:#f92672">+</span>[Person(Work) load]

<span style="color:#ae81ff">2019</span><span style="color:#f92672">-</span><span style="color:#ae81ff">04</span><span style="color:#f92672">-</span><span style="color:#ae81ff">20</span> <span style="color:#ae81ff">19</span><span style="color:#f92672">:</span><span style="color:#ae81ff">25</span><span style="color:#f92672">:</span><span style="color:#ae81ff">30.542473</span><span style="color:#f92672">+</span><span style="color:#ae81ff">0800</span> Load_Obj<span style="color:#f92672">-</span>C_Demo[<span style="color:#ae81ff">63382</span><span style="color:#f92672">:</span><span style="color:#ae81ff">15374262</span>] Person<span style="color:#f92672">+</span>Work <span style="color:#f92672">+</span>[Person(Work) load]
<span style="color:#ae81ff">2019</span><span style="color:#f92672">-</span><span style="color:#ae81ff">04</span><span style="color:#f92672">-</span><span style="color:#ae81ff">20</span> <span style="color:#ae81ff">19</span><span style="color:#f92672">:</span><span style="color:#ae81ff">25</span><span style="color:#f92672">:</span><span style="color:#ae81ff">30.542535</span><span style="color:#f92672">+</span><span style="color:#ae81ff">0800</span> Load_Obj<span style="color:#f92672">-</span>C_Demo[<span style="color:#ae81ff">63382</span><span style="color:#f92672">:</span><span style="color:#ae81ff">15374262</span>] Hello, World<span style="color:#f92672">!</span>
</code></pre></div><!-- raw HTML omitted -->
<h2 id="others">Others</h2>
<h3 id="heading1">开销</h3>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-objectivec" data-lang="objectivec"><span style="color:#66d9ef">@interface</span> <span style="color:#a6e22e">Fruit</span> : <span style="color:#a6e22e">NSObject</span>

<span style="color:#66d9ef">@end</span>

<span style="color:#66d9ef">@implementation</span> <span style="color:#a6e22e">Fruit</span>
+ (<span style="color:#66d9ef">void</span>)<span style="color:#a6e22e">load</span> {
    NSLog(<span style="color:#e6db74">@&#34;</span><span style="color:#e6db74">------</span><span style="color:#e6db74">&#34;</span>);
    sleep(<span style="color:#ae81ff">3</span>);
    NSLog(<span style="color:#e6db74">@&#34;</span><span style="color:#e6db74">------</span><span style="color:#e6db74">&#34;</span>);
}
<span style="color:#66d9ef">@end</span>

<span style="color:#75715e">// OUTPUT:
</span><span style="color:#75715e"></span><span style="color:#75715e">// 2019-04-20 19:23:38.433375+0800 Load_Obj-C_iOS_Demo[63358:15371945] ------
</span><span style="color:#75715e"></span><span style="color:#75715e">// 2019-04-20 19:23:41.434564+0800 Load_Obj-C_iOS_Demo[63358:15371945] ------
</span></code></pre></div><p>通过上面的分析，我们了解了 +load 在运行时初始化加载镜像时就会被调用，使得可以有机会预先做很多事情。但正是因为其加载的时机非常靠前，如果在 +load 方法中做比较复杂且在主线程的操作，将会影响 app 启动时间，降低用户体验。我们可以尝试建立一个 iOS app，在 +load 中 <code>sleep(3)</code> 模拟做比较复杂的操作，此时每次 app 冷启动都将会有 3 秒以上的时间才能进入 app 主页的控制器，极大的影响了启动时间。</p>
<p>我们可以使用 <code>DYLD_PRINT_STATISTICS_DETAILS</code> 环境变量来控制输出启动统计的相关信息，就可以在 <code>total time in initializers and ObjC +load</code> 中发现 <code>Load_Obj-C_iOS_Demo : 3.0 seconds (74.4%)</code> 占用了大部分时间。</p>
<pre><code>  total time: 4.0 seconds (100.0%)
  total images loaded:  258 (0 from dyld shared cache)
  total segments mapped: 767, into 102430 pages with 7398 pages pre-fetched
  total images loading time: 397.50 milliseconds (9.8%)
  total load time in ObjC:  47.34 milliseconds (1.1%)
  total debugger pause time: 189.60 milliseconds (4.6%)
  total dtrace DOF registration time:   0.14 milliseconds (0.0%)
  total rebase fixups:  2,716,086
  total rebase fixups time: 552.17 milliseconds (13.6%)
  total binding fixups: 286,035
  total binding fixups time:  19.12 milliseconds (0.4%)
  total weak binding fixups time:   0.45 milliseconds (0.0%)
  total redo shared cached bindings time:  26.04 milliseconds (0.6%)
  total bindings lazily fixed up: 0 of 0
  total time in initializers and ObjC +load: 3.0 seconds (74.9%)
                         libSystem.B.dylib :   2.99 milliseconds (0.0%)
                libMainThreadChecker.dylib :  10.24 milliseconds (0.2%)
                       Load_Obj-C_iOS_Demo : 3.0 seconds (74.4%)
</code></pre><h3 id="swift">Swift</h3>
<p>与我们的老朋友 Obj-C 不同的是，Swift 是一门诞生即宣扬安全、快速、强壮的语言，因此其极大地削弱了 Runtime 这一概念，将大部分检查提前到编译时刻。因此 Swift 中普通的类无需继承自 <code>NSObject</code>，自然也不存在 +load。</p>
<p>而当我们尝试在 Swift 5.x 中继承自 <code>NSObject</code> 来实现 +load 和 +initialize 时，却发现编译器现在已经不允许了：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-swift" data-lang="swift"><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Foo</span>: NSObject {
    <span style="color:#75715e">//</span><span style="color:#75715e"> </span><span style="color:#75715e">M</span><span style="color:#75715e">e</span><span style="color:#75715e">t</span><span style="color:#75715e">h</span><span style="color:#75715e">o</span><span style="color:#75715e">d</span><span style="color:#75715e"> </span><span style="color:#75715e">&#39;</span><span style="color:#75715e">l</span><span style="color:#75715e">o</span><span style="color:#75715e">a</span><span style="color:#75715e">d</span><span style="color:#75715e">(</span><span style="color:#75715e">)</span><span style="color:#75715e">&#39;</span><span style="color:#75715e"> </span><span style="color:#75715e">d</span><span style="color:#75715e">e</span><span style="color:#75715e">f</span><span style="color:#75715e">i</span><span style="color:#75715e">n</span><span style="color:#75715e">e</span><span style="color:#75715e">s</span><span style="color:#75715e"> </span><span style="color:#75715e">O</span><span style="color:#75715e">b</span><span style="color:#75715e">j</span><span style="color:#75715e">e</span><span style="color:#75715e">c</span><span style="color:#75715e">t</span><span style="color:#75715e">i</span><span style="color:#75715e">v</span><span style="color:#75715e">e</span><span style="color:#75715e">-</span><span style="color:#75715e">C</span><span style="color:#75715e"> </span><span style="color:#75715e">c</span><span style="color:#75715e">l</span><span style="color:#75715e">a</span><span style="color:#75715e">s</span><span style="color:#75715e">s</span><span style="color:#75715e"> </span><span style="color:#75715e">m</span><span style="color:#75715e">e</span><span style="color:#75715e">t</span><span style="color:#75715e">h</span><span style="color:#75715e">o</span><span style="color:#75715e">d</span><span style="color:#75715e"> </span><span style="color:#75715e">&#39;</span><span style="color:#75715e">l</span><span style="color:#75715e">o</span><span style="color:#75715e">a</span><span style="color:#75715e">d</span><span style="color:#75715e">&#39;</span><span style="color:#75715e">,</span><span style="color:#75715e"> </span><span style="color:#75715e">w</span><span style="color:#75715e">h</span><span style="color:#75715e">i</span><span style="color:#75715e">c</span><span style="color:#75715e">h</span><span style="color:#75715e"> </span><span style="color:#75715e">i</span><span style="color:#75715e">s</span><span style="color:#75715e"> </span><span style="color:#75715e">n</span><span style="color:#75715e">o</span><span style="color:#75715e">t</span><span style="color:#75715e"> </span><span style="color:#75715e">p</span><span style="color:#75715e">e</span><span style="color:#75715e">r</span><span style="color:#75715e">m</span><span style="color:#75715e">i</span><span style="color:#75715e">t</span><span style="color:#75715e">t</span><span style="color:#75715e">e</span><span style="color:#75715e">d</span><span style="color:#75715e"> </span><span style="color:#75715e">b</span><span style="color:#75715e">y</span><span style="color:#75715e"> </span><span style="color:#75715e">S</span><span style="color:#75715e">w</span><span style="color:#75715e">i</span><span style="color:#75715e">f</span><span style="color:#75715e">t</span>
    <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">func</span> <span style="color:#a6e22e">load</span>() {}

    <span style="color:#75715e">//</span><span style="color:#75715e"> </span><span style="color:#75715e">M</span><span style="color:#75715e">e</span><span style="color:#75715e">t</span><span style="color:#75715e">h</span><span style="color:#75715e">o</span><span style="color:#75715e">d</span><span style="color:#75715e"> </span><span style="color:#75715e">&#39;</span><span style="color:#75715e">i</span><span style="color:#75715e">n</span><span style="color:#75715e">i</span><span style="color:#75715e">t</span><span style="color:#75715e">i</span><span style="color:#75715e">a</span><span style="color:#75715e">l</span><span style="color:#75715e">i</span><span style="color:#75715e">z</span><span style="color:#75715e">e</span><span style="color:#75715e">(</span><span style="color:#75715e">)</span><span style="color:#75715e">&#39;</span><span style="color:#75715e"> </span><span style="color:#75715e">d</span><span style="color:#75715e">e</span><span style="color:#75715e">f</span><span style="color:#75715e">i</span><span style="color:#75715e">n</span><span style="color:#75715e">e</span><span style="color:#75715e">s</span><span style="color:#75715e"> </span><span style="color:#75715e">O</span><span style="color:#75715e">b</span><span style="color:#75715e">j</span><span style="color:#75715e">e</span><span style="color:#75715e">c</span><span style="color:#75715e">t</span><span style="color:#75715e">i</span><span style="color:#75715e">v</span><span style="color:#75715e">e</span><span style="color:#75715e">-</span><span style="color:#75715e">C</span><span style="color:#75715e"> </span><span style="color:#75715e">c</span><span style="color:#75715e">l</span><span style="color:#75715e">a</span><span style="color:#75715e">s</span><span style="color:#75715e">s</span><span style="color:#75715e"> </span><span style="color:#75715e">m</span><span style="color:#75715e">e</span><span style="color:#75715e">t</span><span style="color:#75715e">h</span><span style="color:#75715e">o</span><span style="color:#75715e">d</span><span style="color:#75715e"> </span><span style="color:#75715e">&#39;</span><span style="color:#75715e">i</span><span style="color:#75715e">n</span><span style="color:#75715e">i</span><span style="color:#75715e">t</span><span style="color:#75715e">i</span><span style="color:#75715e">a</span><span style="color:#75715e">l</span><span style="color:#75715e">i</span><span style="color:#75715e">z</span><span style="color:#75715e">e</span><span style="color:#75715e">&#39;</span><span style="color:#75715e">,</span><span style="color:#75715e"> </span><span style="color:#75715e">w</span><span style="color:#75715e">h</span><span style="color:#75715e">i</span><span style="color:#75715e">c</span><span style="color:#75715e">h</span><span style="color:#75715e"> </span><span style="color:#75715e">i</span><span style="color:#75715e">s</span><span style="color:#75715e"> </span><span style="color:#75715e">n</span><span style="color:#75715e">o</span><span style="color:#75715e">t</span><span style="color:#75715e"> </span><span style="color:#75715e">p</span><span style="color:#75715e">e</span><span style="color:#75715e">r</span><span style="color:#75715e">m</span><span style="color:#75715e">i</span><span style="color:#75715e">t</span><span style="color:#75715e">t</span><span style="color:#75715e">e</span><span style="color:#75715e">d</span><span style="color:#75715e"> </span><span style="color:#75715e">b</span><span style="color:#75715e">y</span><span style="color:#75715e"> </span><span style="color:#75715e">S</span><span style="color:#75715e">w</span><span style="color:#75715e">i</span><span style="color:#75715e">f</span><span style="color:#75715e">t</span>
    <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">func</span> <span style="color:#a6e22e">initialize</span>() {}
}
</code></pre></div><p>与以往不同，这次官方连变通方法也没有提供，看来确实不鼓励在 app 启动的 main 函数调用前做太多开销的事情。</p>
<p>我们首先能想到的是使用 Obj-C 混编来定义分类并实现 +load 来达到类似的效果，然而官方已经料到了这一点：「Swift class extensions and categories on Swift classes are not allowed to have +load methods」，不过 +initialize 目前仍是允许的：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-objectivec" data-lang="objectivec"><span style="color:#66d9ef">@interface</span> <span style="color:#a6e22e">SwiftFoo</span> (SwiftInitialize)
<span style="color:#66d9ef">@end</span>

<span style="color:#66d9ef">@implementation</span> <span style="color:#a6e22e">SwiftFoo</span> (SwiftInitialize)
+ (<span style="color:#66d9ef">void</span>)<span style="color:#a6e22e">initialize</span> {
    [SwiftFoo swiftInitialize];
    <span style="color:#75715e">// 或者直接做一些处理
</span><span style="color:#75715e"></span>}
<span style="color:#66d9ef">@end</span>
</code></pre></div><div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-swift" data-lang="swift"><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">SwiftFoo</span>: NSObject {
    <span style="color:#66d9ef">@objc</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">func</span> <span style="color:#a6e22e">swiftInitialize</span>() {
        <span style="color:#75715e">//</span><span style="color:#75715e"> </span><span style="color:#75715e">D</span><span style="color:#75715e">o</span><span style="color:#75715e"> </span><span style="color:#75715e">s</span><span style="color:#75715e">t</span><span style="color:#75715e">h</span><span style="color:#75715e"> </span><span style="color:#75715e">l</span><span style="color:#75715e">i</span><span style="color:#75715e">k</span><span style="color:#75715e">e</span><span style="color:#75715e"> </span><span style="color:#75715e">i</span><span style="color:#75715e">n</span><span style="color:#75715e"> </span><span style="color:#75715e">+</span><span style="color:#75715e">i</span><span style="color:#75715e">n</span><span style="color:#75715e">i</span><span style="color:#75715e">t</span><span style="color:#75715e">i</span><span style="color:#75715e">a</span><span style="color:#75715e">l</span><span style="color:#75715e">i</span><span style="color:#75715e">z</span><span style="color:#75715e">e</span><span style="color:#75715e">.</span><span style="color:#75715e">.</span><span style="color:#75715e">.</span>
    }
}
</code></pre></div><p>或者我们也可以根据「<a href="http://jordansmith.io/handling-the-deprecation-of-initialize/">Handling the Deprecation of initialize() - JORDAN SMITH</a>」一文中使用响应链并使用运行时兼容所有非 <code>NSObject</code> 类也可支持类似的效果：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-swift" data-lang="swift"><span style="color:#66d9ef">protocol</span> <span style="color:#a6e22e">SelfAware</span>: <span style="color:#66d9ef">class</span> {
    <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">func</span> <span style="color:#a6e22e">awake</span>()
}

<span style="color:#66d9ef">extension</span> <span style="color:#a6e22e">UIApplication</span> {
    <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">let</span> runOnce: Void = {
        <span style="color:#66d9ef">let</span> typeCount = Int(objc_getClassList(<span style="color:#66d9ef">nil</span>, <span style="color:#ae81ff">0</span>))
        <span style="color:#66d9ef">let</span> types = UnsafeMutablePointer&lt;AnyClass&gt;.allocate(capacity: typeCount)
        <span style="color:#66d9ef">let</span> safeTypes = AutoreleasingUnsafeMutablePointer&lt;AnyClass&gt;(types)
        objc_getClassList(safeTypes, Int32(typeCount))
        <span style="color:#66d9ef">for</span> index <span style="color:#66d9ef">in</span> <span style="color:#ae81ff">0</span> ..<span style="color:#f92672">&lt;</span> typeCount { (types[index] <span style="color:#66d9ef">as</span>? SelfAware.<span style="color:#66d9ef">Type</span>)?.awake() }
        types.deallocate()
    }()

    <span style="color:#66d9ef">override</span> open <span style="color:#66d9ef">var</span> next: UIResponder? {
        <span style="color:#75715e">//</span><span style="color:#75715e"> </span><span style="color:#75715e">C</span><span style="color:#75715e">a</span><span style="color:#75715e">l</span><span style="color:#75715e">l</span><span style="color:#75715e">e</span><span style="color:#75715e">d</span><span style="color:#75715e"> </span><span style="color:#75715e">b</span><span style="color:#75715e">e</span><span style="color:#75715e">f</span><span style="color:#75715e">o</span><span style="color:#75715e">r</span><span style="color:#75715e">e</span><span style="color:#75715e"> </span><span style="color:#75715e">a</span><span style="color:#75715e">p</span><span style="color:#75715e">p</span><span style="color:#75715e">l</span><span style="color:#75715e">i</span><span style="color:#75715e">c</span><span style="color:#75715e">a</span><span style="color:#75715e">t</span><span style="color:#75715e">i</span><span style="color:#75715e">o</span><span style="color:#75715e">n</span><span style="color:#75715e">D</span><span style="color:#75715e">i</span><span style="color:#75715e">d</span><span style="color:#75715e">F</span><span style="color:#75715e">i</span><span style="color:#75715e">n</span><span style="color:#75715e">i</span><span style="color:#75715e">s</span><span style="color:#75715e">h</span><span style="color:#75715e">L</span><span style="color:#75715e">a</span><span style="color:#75715e">u</span><span style="color:#75715e">n</span><span style="color:#75715e">c</span><span style="color:#75715e">h</span><span style="color:#75715e">i</span><span style="color:#75715e">n</span><span style="color:#75715e">g</span>
        UIApplication.runOnce
        <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">super</span>.next
    }

}

<span style="color:#66d9ef">class</span> <span style="color:#a6e22e">FooAware</span>: SelfAware {
    <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">func</span> <span style="color:#a6e22e">awake</span>() {
        <span style="color:#75715e">//</span><span style="color:#75715e"> </span><span style="color:#75715e">D</span><span style="color:#75715e">o</span><span style="color:#75715e"> </span><span style="color:#75715e">s</span><span style="color:#75715e">t</span><span style="color:#75715e">h</span><span style="color:#75715e"> </span><span style="color:#75715e">l</span><span style="color:#75715e">i</span><span style="color:#75715e">k</span><span style="color:#75715e">e</span><span style="color:#75715e"> </span><span style="color:#75715e">i</span><span style="color:#75715e">n</span><span style="color:#75715e"> </span><span style="color:#75715e">+</span><span style="color:#75715e">l</span><span style="color:#75715e">o</span><span style="color:#75715e">a</span><span style="color:#75715e">d</span><span style="color:#75715e">.</span><span style="color:#75715e">.</span><span style="color:#75715e">.</span>
    }
}
</code></pre></div><h3 id="other-linker-flags">Other Linker Flags</h3>
<p>在编译型语言中，编译器负责将源代码编译为目标文件，而链接器负责将多个目标文件在 Xcode - Targets - Build Settings 中有一个「Other Linker Flags」的配置项：</p>
<p><img src="/img/2019/+load_in_ios/3.png" alt="3"></p>
<p>其使得开发者可以在 Xcode 构建项目时自由添加一些链接器参数，关于其完整的参数列表，可以在终端输入 <code>man ld</code> 来获得：</p>
<p><img src="/img/2019/+load_in_ios/4.png" alt="4"></p>
<p>我们这里主要简单介绍下 <code>-ObjC</code>，根据 <code>man ld</code>：</p>
<blockquote>
<p><strong>Options that control libraries</strong></p>
<p><strong>-ObjC</strong> Loads all members of static archive libraries that implement an Objective-C class or category.</p>
<p><strong>-ObjC</strong> 加载静态库中实现 Obj-C 类或分类的所有成员。</p>
</blockquote>
<p>由于 Obj-C 中的方法调用本质属于消息发送，因此链接的符号只有类，而没有方法。分类可以看作是方法的集合，因此使用分类的方法时并不会产生未定义符号，即链接器并不知晓要加载定义分类的目标文件。当我们使用 <code>-ObjC</code> 参数时，将会把<strong>静态库</strong>中所有的分类方法实现加载，但坏处是会使得可执行文件变大，并可能包含不必要的目标文件。</p>
<p>而对于在运行时加载的动态库，我们只要保证代码中引入了库，那么其中的 +load 方法就能够得以执行。</p>
<h2 id="reference">Reference</h2>
<ul>
<li><a href="https://developer.apple.com/documentation/objectivec/nsobject/1418815-load?language=objc">load - Apple Developer</a></li>
<li><a href="../category_in_ios/">iOS 中的 Category - kingcos</a></li>
<li><a href="../objc_msgsend/">浅尝 objc_msgSend - kingcos</a></li>
<li><a href="http://jordansmith.io/handling-the-deprecation-of-initialize/">Handling the Deprecation of initialize() - JORDAN SMITH</a></li>
<li><a href="https://developer.apple.com/library/archive/qa/qa1490/_index.html">Technical Q&amp;A QA1490 - Building Objective-C static libraries with categories</a></li>
</ul>

    </div>
    
      <div class="pagination">
        <div class="pagination__title">
          <span class="pagination__title-h">Read other posts</span>
          <hr />
        </div>
        <div class="pagination__buttons">
          
            <span class="button previous">
              <a href="/posts/2019/ios_test_automation/">
                <span class="button__icon">←</span>
                <span class="button__text">iOS 自动化测试之 WDA &amp; Appium</span>
              </a>
            </span>
          
          
            <span class="button next">
              <a href="/posts/2019/objects_in_obj-c/">
                <span class="button__text">Obj-C 中的对象</span>
                <span class="button__icon">→</span>
              </a>
            </span>
          
        </div>
      </div>
    

    

    
    
    <div>
      <div id="github-comment">
      </div>

      <script type="text/javascript">
        function getUtterances(isDark) {
          var utterances = document.createElement('script');
          utterances.type = 'text/javascript';
          utterances.async = true;
          utterances.setAttribute('issue-term', "pathname")
          utterances.setAttribute('repo', "kingcos\/kingcos.github.io")
          utterances.setAttribute('label', "comments")
          isDark ? utterances.setAttribute('theme', "github-dark") : utterances.setAttribute('theme', "github-light")
          utterances.crossorigin = 'anonymous';
          utterances.src = 'https://utteranc.es/client.js';

          return utterances
        }

        var themeToggle = document.querySelector(".theme-toggle")
        themeToggle.addEventListener("click", function () {
          var getTheme = window.localStorage && window.localStorage.getItem("theme")
          var divNode = document.getElementById('github-comment')
          while(divNode.hasChildNodes()) {
            divNode.removeChild(divNode.firstChild);
          }
          
          
          

          
          
          
          
          
          
          document.getElementById('github-comment').appendChild(getUtterances(getTheme !== "dark"))
        })

        var getTheme = window.localStorage && window.localStorage.getItem("theme")
        document.getElementById('github-comment').appendChild(getUtterances(getTheme === "dark"))
      </script>
    </div>
    

    </div>

      </div>

      
        <footer class="footer">
  <div class="footer__inner">
    
      <div class="copyright copyright--user">All rights reserved by kingcos.me</div>
    
  </div>
</footer>

<script src="/assets/main.js"></script>
<script src="/assets/prism.js"></script>


      
    </div>

    
      
<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
	(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
	m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
	})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
	ga('create', 'UA-138311951-1', 'auto');
	
	ga('send', 'pageview');
}
</script>

    
  </body>
</html>
