<!DOCTYPE html>
<html lang="en">
<head>
  
    <title>æµ…å° objc_msgSend :: iBlog</title>
  
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">
<meta name="description" content="Date Notes Refers.     2019-07-20 é¦–æ¬¡æäº¤ objc4-750.1   2019-08-20 æ•´ç†ç»“æ„ï¼Œæœªå®Œå¾…ç»­ -    Preface Obj-C ä¸­æ–¹æ³•è°ƒç”¨çš„æœ¬è´¨æ˜¯æ¶ˆæ¯å‘é€æœºåˆ¶ï¼Œå³ [foo bar] æ˜¯å‘ foo å¯¹è±¡å‘é€ä¸€æ¡ bar çš„æ¶ˆæ¯ï¼Œè€Œæ¶ˆæ¯å‘é€æœ¬è´¨å°±æ˜¯é€šè¿‡ objc_msgSend æ‰€è¿›è¡Œçš„ã€‚é‚£ä¹ˆè¿™æ¬¡æœ¬æ–‡å°±ç®€å•çª¥æ¢ä¸€ä¸‹ objc_msgSend å§ã€‚
Where ä¸ºä»€ä¹ˆ Obj-C ä¸­æ–¹æ³•è°ƒç”¨çš„æœ¬è´¨æ˜¯ objc_msgSend å‘¢ï¼Ÿæˆ‘ä»¬åˆ›å»ºä¸€ä¸ªä½¿ç”¨ Obj-C çš„ iOS é¡¹ç›®ï¼Œå¦‚ä¸‹åœ¨ã€ŒViewControllerã€ä¸­æ·»åŠ ä¸€ä¸ªæŒ‰é’®ï¼Œå¹¶åœ¨æŒ‰é’®çš„ç‚¹å‡»äº‹ä»¶ä¸­åˆ›å»ºä¸€ä¸ª Obj-C å¯¹è±¡ï¼Œå†è°ƒç”¨å…¶æ–¹æ³•ï¼š
#import &amp;quot;ViewController.h&amp;quot; @interface Foo : NSObject - (void)bar; @end @implementation Foo - (void)bar {} @end @interface ViewController () @end @implementation ViewController - (IBAction)clickOnButton:(UIButton *)sender { Foo *foo = [[Foo alloc] init]; [foo bar]; // ğŸ”´ Breakpoint } @end  æˆ‘ä»¬å°†æ–­ç‚¹æ‰“åœ¨ [foo bar]; ä¸€è¡Œï¼Œå¯åŠ¨ç¨‹åºå¹¶ç‚¹å‡»æŒ‰é’®ã€‚åœ¨ Xcode çš„æ§åˆ¶å°å¤šæ¬¡è¾“å…¥ siï¼ˆStep Intoï¼‰å³å¯æœ€ç»ˆè·³è½¬åˆ° objc_msgSendï¼š"/>
<meta name="keywords" content=""/>
<meta name="robots" content="noodp"/>
<link rel="canonical" href="/posts/2019/objc_msgsend/" />


<link rel="stylesheet" href="/assets/style.css">

  <link rel="stylesheet" href="/assets/green.css">



<link rel="stylesheet" href="/style.css">


<link rel="apple-touch-icon-precomposed" sizes="144x144" href="/img/apple-touch-icon-144-precomposed.png">

<link rel="shortcut icon" href="/img/favicon/favicon.ico">



<meta name="twitter:card" content="summary" />
<meta name="twitter:title" content="æµ…å° objc_msgSend :: iBlog â€” " />
<meta name="twitter:description" content="Date Notes Refers.     2019-07-20 é¦–æ¬¡æäº¤ objc4-750.1   2019-08-20 æ•´ç†ç»“æ„ï¼Œæœªå®Œå¾…ç»­ -    Preface Obj-C ä¸­æ–¹æ³•è°ƒç”¨çš„æœ¬è´¨æ˜¯æ¶ˆæ¯å‘é€æœºåˆ¶ï¼Œå³ [foo bar] æ˜¯å‘ foo å¯¹è±¡å‘é€ä¸€æ¡ bar çš„æ¶ˆæ¯ï¼Œè€Œæ¶ˆæ¯å‘é€æœ¬è´¨å°±æ˜¯é€šè¿‡ objc_msgSend æ‰€è¿›è¡Œçš„ã€‚é‚£ä¹ˆè¿™æ¬¡æœ¬æ–‡å°±ç®€å•çª¥æ¢ä¸€ä¸‹ objc_msgSend å§ã€‚
Where ä¸ºä»€ä¹ˆ Obj-C ä¸­æ–¹æ³•è°ƒç”¨çš„æœ¬è´¨æ˜¯ objc_msgSend å‘¢ï¼Ÿæˆ‘ä»¬åˆ›å»ºä¸€ä¸ªä½¿ç”¨ Obj-C çš„ iOS é¡¹ç›®ï¼Œå¦‚ä¸‹åœ¨ã€ŒViewControllerã€ä¸­æ·»åŠ ä¸€ä¸ªæŒ‰é’®ï¼Œå¹¶åœ¨æŒ‰é’®çš„ç‚¹å‡»äº‹ä»¶ä¸­åˆ›å»ºä¸€ä¸ª Obj-C å¯¹è±¡ï¼Œå†è°ƒç”¨å…¶æ–¹æ³•ï¼š
#import &amp;quot;ViewController.h&amp;quot; @interface Foo : NSObject - (void)bar; @end @implementation Foo - (void)bar {} @end @interface ViewController () @end @implementation ViewController - (IBAction)clickOnButton:(UIButton *)sender { Foo *foo = [[Foo alloc] init]; [foo bar]; // ğŸ”´ Breakpoint } @end  æˆ‘ä»¬å°†æ–­ç‚¹æ‰“åœ¨ [foo bar]; ä¸€è¡Œï¼Œå¯åŠ¨ç¨‹åºå¹¶ç‚¹å‡»æŒ‰é’®ã€‚åœ¨ Xcode çš„æ§åˆ¶å°å¤šæ¬¡è¾“å…¥ siï¼ˆStep Intoï¼‰å³å¯æœ€ç»ˆè·³è½¬åˆ° objc_msgSendï¼š" />
<meta name="twitter:site" content="/" />
<meta name="twitter:creator" content="" />
<meta name="twitter:image" content="">


<meta property="og:locale" content="en" />
<meta property="og:type" content="article" />
<meta property="og:title" content="æµ…å° objc_msgSend :: iBlog â€” ">
<meta property="og:description" content="Date Notes Refers.     2019-07-20 é¦–æ¬¡æäº¤ objc4-750.1   2019-08-20 æ•´ç†ç»“æ„ï¼Œæœªå®Œå¾…ç»­ -    Preface Obj-C ä¸­æ–¹æ³•è°ƒç”¨çš„æœ¬è´¨æ˜¯æ¶ˆæ¯å‘é€æœºåˆ¶ï¼Œå³ [foo bar] æ˜¯å‘ foo å¯¹è±¡å‘é€ä¸€æ¡ bar çš„æ¶ˆæ¯ï¼Œè€Œæ¶ˆæ¯å‘é€æœ¬è´¨å°±æ˜¯é€šè¿‡ objc_msgSend æ‰€è¿›è¡Œçš„ã€‚é‚£ä¹ˆè¿™æ¬¡æœ¬æ–‡å°±ç®€å•çª¥æ¢ä¸€ä¸‹ objc_msgSend å§ã€‚
Where ä¸ºä»€ä¹ˆ Obj-C ä¸­æ–¹æ³•è°ƒç”¨çš„æœ¬è´¨æ˜¯ objc_msgSend å‘¢ï¼Ÿæˆ‘ä»¬åˆ›å»ºä¸€ä¸ªä½¿ç”¨ Obj-C çš„ iOS é¡¹ç›®ï¼Œå¦‚ä¸‹åœ¨ã€ŒViewControllerã€ä¸­æ·»åŠ ä¸€ä¸ªæŒ‰é’®ï¼Œå¹¶åœ¨æŒ‰é’®çš„ç‚¹å‡»äº‹ä»¶ä¸­åˆ›å»ºä¸€ä¸ª Obj-C å¯¹è±¡ï¼Œå†è°ƒç”¨å…¶æ–¹æ³•ï¼š
#import &amp;quot;ViewController.h&amp;quot; @interface Foo : NSObject - (void)bar; @end @implementation Foo - (void)bar {} @end @interface ViewController () @end @implementation ViewController - (IBAction)clickOnButton:(UIButton *)sender { Foo *foo = [[Foo alloc] init]; [foo bar]; // ğŸ”´ Breakpoint } @end  æˆ‘ä»¬å°†æ–­ç‚¹æ‰“åœ¨ [foo bar]; ä¸€è¡Œï¼Œå¯åŠ¨ç¨‹åºå¹¶ç‚¹å‡»æŒ‰é’®ã€‚åœ¨ Xcode çš„æ§åˆ¶å°å¤šæ¬¡è¾“å…¥ siï¼ˆStep Intoï¼‰å³å¯æœ€ç»ˆè·³è½¬åˆ° objc_msgSendï¼š" />
<meta property="og:url" content="/posts/2019/objc_msgsend/" />
<meta property="og:site_name" content="æµ…å° objc_msgSend" />
<meta property="og:image" content="">
<meta property="og:image:width" content="2048">
<meta property="og:image:height" content="1024">

<meta property="article:published_time" content="2019-07-20 00:00:00 &#43;0000 UTC" />











</head>
<body class="">


<div class="container center">

  <header class="header">
  <div class="header__inner">
    <div class="header__logo">
      <a href="/">
  <div class="logo">
    iBlog
  </div>
</a>

    </div>
    <div class="menu-trigger">menu</div>
  </div>
  
  
    
<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-138311951-1', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>

  

  
    <nav class="menu">
  <ul class="menu__inner menu__inner--desktop">
    
      
        
          <li><a href="/about">About &amp; AMA</a></li>
        
      
        
          <li><a href="/links">Links</a></li>
        
      
        
          <li><a href="/perspective">Perspective</a></li>
        
      
        
          <li><a href="/words">Words</a></li>
        
      
      
    
  </ul>

  <ul class="menu__inner menu__inner--mobile">
    
      
        <li><a href="/about">About &amp; AMA</a></li>
      
    
      
        <li><a href="/links">Links</a></li>
      
    
      
        <li><a href="/perspective">Perspective</a></li>
      
    
      
        <li><a href="/words">Words</a></li>
      
    
  </ul>
</nav>

  
</header>


  <div class="content">
    
<div class="post">
  <h1 class="post-title">
    <a href="/posts/2019/objc_msgsend/">æµ…å° objc_msgSend</a></h1>
  <div class="post-meta">
    <span class="post-date">
      2019-07-20
    </span>
    
  </div>

  
  <span class="post-tags">
    
    #<a href="/tags/focus/">Focus</a>&nbsp;
    
    #<a href="/tags/ios/">iOS</a>&nbsp;
    
    #<a href="/tags/obj-c/">Obj-C</a>&nbsp;
    
    #<a href="/tags/">ğŸš§</a>&nbsp;
    
  </span>
  

  

  <div class="post-content">
    

<table>
<thead>
<tr>
<th align="center">Date</th>
<th align="center">Notes</th>
<th align="center">Refers.</th>
</tr>
</thead>

<tbody>
<tr>
<td align="center">2019-07-20</td>
<td align="center">é¦–æ¬¡æäº¤</td>
<td align="center"><a href="https://opensource.apple.com/tarballs/objc4/">objc4-750.1</a></td>
</tr>

<tr>
<td align="center">2019-08-20</td>
<td align="center">æ•´ç†ç»“æ„ï¼Œæœªå®Œå¾…ç»­</td>
<td align="center">-</td>
</tr>
</tbody>
</table>

<p><img src="/img/2019/objc_msgsend/0.png" alt="0" /></p>

<h2 id="preface">Preface</h2>

<p>Obj-C ä¸­æ–¹æ³•è°ƒç”¨çš„æœ¬è´¨æ˜¯æ¶ˆæ¯å‘é€æœºåˆ¶ï¼Œå³ <code>[foo bar]</code> æ˜¯å‘ <code>foo</code> å¯¹è±¡å‘é€ä¸€æ¡ <code>bar</code> çš„æ¶ˆæ¯ï¼Œè€Œæ¶ˆæ¯å‘é€æœ¬è´¨å°±æ˜¯é€šè¿‡ <code>objc_msgSend</code> æ‰€è¿›è¡Œçš„ã€‚é‚£ä¹ˆè¿™æ¬¡æœ¬æ–‡å°±ç®€å•çª¥æ¢ä¸€ä¸‹ <code>objc_msgSend</code> å§ã€‚</p>

<h2 id="where">Where</h2>

<p>ä¸ºä»€ä¹ˆ Obj-C ä¸­æ–¹æ³•è°ƒç”¨çš„æœ¬è´¨æ˜¯ <code>objc_msgSend</code> å‘¢ï¼Ÿæˆ‘ä»¬åˆ›å»ºä¸€ä¸ªä½¿ç”¨ Obj-C çš„ iOS é¡¹ç›®ï¼Œå¦‚ä¸‹åœ¨ã€ŒViewControllerã€ä¸­æ·»åŠ ä¸€ä¸ªæŒ‰é’®ï¼Œå¹¶åœ¨æŒ‰é’®çš„ç‚¹å‡»äº‹ä»¶ä¸­åˆ›å»ºä¸€ä¸ª Obj-C å¯¹è±¡ï¼Œå†è°ƒç”¨å…¶æ–¹æ³•ï¼š</p>

<pre><code class="language-objectivec">#import &quot;ViewController.h&quot;

@interface Foo : NSObject
- (void)bar;
@end

@implementation Foo
- (void)bar {}
@end

@interface ViewController ()
@end

@implementation ViewController

- (IBAction)clickOnButton:(UIButton *)sender {
    Foo *foo = [[Foo alloc] init];

    [foo bar]; // ğŸ”´ Breakpoint
}

@end
</code></pre>

<p>æˆ‘ä»¬å°†æ–­ç‚¹æ‰“åœ¨ <code>[foo bar];</code> ä¸€è¡Œï¼Œå¯åŠ¨ç¨‹åºå¹¶ç‚¹å‡»æŒ‰é’®ã€‚åœ¨ Xcode çš„æ§åˆ¶å°å¤šæ¬¡è¾“å…¥ <code>si</code>ï¼ˆStep Intoï¼‰å³å¯æœ€ç»ˆè·³è½¬åˆ° <code>objc_msgSend</code>ï¼š</p>

<p><img src="/img/2019/objc_msgsend/3.png" alt="3" /></p>

<p>å› æ­¤ Obj-C ä¸­æ–¹æ³•è°ƒç”¨çš„æœ¬è´¨å³ <code>objc_msgSend</code>ã€‚</p>

<h2 id="steps">Steps</h2>

<p><code>objc_msgSend</code> çš„æ‰§è¡Œæ€»å…±åˆ†ä¸ºæ¶ˆæ¯å‘é€ã€åŠ¨æ€æ–¹æ³•è§£æã€ä»¥åŠæ¶ˆæ¯è½¬å‘ä¸‰å¤§éƒ¨åˆ†ã€‚</p>

<h3 id="æ¶ˆæ¯å‘é€">æ¶ˆæ¯å‘é€</h3>

<p><code>objc_msgSend</code> ä¸­çš„ç¬¬ä¸€ä¸ªéƒ¨åˆ†æ˜¯æ¶ˆæ¯å‘é€éƒ¨åˆ†ï¼Œå³å¯¹æ¶ˆæ¯æ¥æ”¶è€…å‘é€ä¸€æ¡æ–¹æ³•æ¶ˆæ¯ï¼Œå½“æ¥æ”¶è€…å¯ä»¥å¤„ç†æ¶ˆæ¯æ—¶å°†æ‰§è¡Œç›¸åº”çš„æ–¹æ³•ï¼Œæ— æ³•å¤„ç†æ—¶åˆ™è¿›å…¥ä¸‹ä¸€æ­¥éª¤ã€‚</p>

<p>è€Œåœ¨ Apple å¼€æºçš„ objc4 æºç ä¸­ï¼Œæˆ‘ä»¬åªèƒ½åœ¨ã€Œmessage.hã€ä¸­æ‰¾åˆ° <code>objc_msgSend</code> çš„å£°æ˜ï¼š</p>

<pre><code class="language-c">// message.h

/**
 * Sends a message with a simple return value to an instance of a class.
 * å‘é€ä¸€ä¸ªå¸¦æœ‰ç®€æ˜“è¿”å›å€¼çš„æ¶ˆæ¯åˆ°ä¸€ä¸ªç±»çš„å®ä¾‹ã€‚
 *
 * @param self A pointer to the instance of the class that is to receive the message.
 *             æŒ‡å‘æ¥æ”¶æ¶ˆæ¯è€…å®ä¾‹çš„æŒ‡é’ˆã€‚
 * @param op The selector of the method that handles the message.
 *           å¤„ç†æ¶ˆæ¯çš„é€‰æ‹©å™¨ã€‚
 * @param ...
 *   A variable argument list containing the arguments to the method.
 *   åŒ…å«æ–¹æ³•å‚æ•°çš„å¯å˜å‚æ•°åˆ—è¡¨ã€‚
 *
 * @return The return value of the method.
 *         æ–¹æ³•çš„è¿”å›å€¼ã€‚
 *
 * @note When it encounters a method call, the compiler generates a call to one of the
 *  functions \c objc_msgSend, \c objc_msgSend_stret, \c objc_msgSendSuper, or \c objc_msgSendSuper_stret.
 *  Messages sent to an objectâ€™s superclass (using the \c super keyword) are sent using \c objc_msgSendSuper;
 *  other messages are sent using \c objc_msgSend. Methods that have data structures as return values
 *  are sent using \c objc_msgSendSuper_stret and \c objc_msgSend_stret.
 * æ³¨æ„ï¼šå½“é‡åˆ°æ–¹æ³•è°ƒç”¨æ—¶ï¼Œç¼–è¯‘å™¨ä¼šç”Ÿæˆå¯¹ objc_msgSendã€objc_msgSend_stretã€objc_msgSendSuperã€objc_msgSendSuper_stret å››ä¸ªå‡½æ•°ä¹‹ä¸€çš„è°ƒç”¨ã€‚
 * åˆ°è¾¾å¯¹è±¡çˆ¶ç±»ï¼ˆä½¿ç”¨ super å…³é”®å­—ï¼‰çš„æ¶ˆæ¯é€šè¿‡ objc_msgSendSuper å‘é€ï¼›å…¶å®ƒæ¶ˆæ¯åˆ™é€šè¿‡ objc_msgSend å‘é€ã€‚
 * è¿”å›å€¼ä¸ºç»“æ„ä½“çš„æ¶ˆæ¯é€šè¿‡ objc_msgSendSuper_stret æˆ– objc_msgSend_stret å‘é€ã€‚
 *
 */
OBJC_EXPORT id _Nullable
objc_msgSend(id _Nullable self, SEL _Nonnull op, ...)
    OBJC_AVAILABLE(10.0, 2.0, 9.0, 1.0, 2.0);
</code></pre>

<p>è¿™é‡Œçš„ <code>objc_msgSend</code> å°†æ¶ˆæ¯æ¥æ”¶è€…ï¼ˆå³å¯¹è±¡ï¼‰ä½œä¸ºç¬¬ä¸€ä¸ªå‚æ•°ï¼Œå°†æ–¹æ³•é€‰æ‹©å™¨ä½œä¸ºç¬¬äºŒä¸ªå‚æ•°ï¼Œå¹¶å°†æ–¹æ³•çš„å‚æ•°è¿½åŠ åœ¨å‚æ•°åˆ—è¡¨çš„æœ€åã€‚é‚£ä¹ˆæ–¹æ³•çš„å…·ä½“å®ç°åœ¨å“ªé‡Œå‘¢ï¼Ÿå…¶å® <code>objc_msgSend</code> æ˜¯ç”±æ±‡ç¼–è¯­è¨€ç¼–å†™çš„ï¼ŒåŸå› æœ‰ä¸¤ç‚¹ï¼Œ<strong>ä¸€æ˜¯åœ¨ C è¯­è¨€ä¸­ç¼–å†™ä¸€ä¸ªä¿å­˜æœªçŸ¥å‚æ•°ä¸”æ”¯æŒè·³è½¬åˆ°ä»»ä¸€å‡½æ•°æŒ‡é’ˆå¤„çš„å‡½æ•°æ˜¯æ— æ³•å®ç°çš„ï¼ˆå¼•è‡ª <a href="https://www.mikeash.com/pyblog/friday-qa-2017-06-30-dissecting-objc_msgsend-on-arm64.html">Dissecting objc_msgSend on ARM64 - Mike Ash</a>ï¼‰</strong>ï¼›<strong>äºŒæ˜¯å¯¹æ€§èƒ½çš„æè‡´è¿½æ±‚ï¼Œä½¿ç”¨æ±‡ç¼–ä¾¿äºä¼˜åŒ–æ¯ä¸€æ¡æŒ‡ä»¤çš„é€Ÿåº¦</strong>ã€‚</p>

<p><img src="/img/2019/objc_msgsend/1.png" alt="1" /></p>

<p>åœ¨åˆ†æ <code>objc_msgSend</code> å‰ï¼Œæˆ‘ä»¬é¦–å…ˆè¦çŸ¥é“ Obj-C çš„æ¶ˆæ¯å‘é€æœ¬è´¨å±äº<strong>åŠ¨æ€ç»‘å®šï¼ˆDynamic Bindingï¼‰</strong>ï¼Œè€Œé C è¯­è¨€å¸¸ç”¨çš„é™æ€ç»‘å®šã€‚åŠ¨æ€ç»‘å®šæ„å‘³ç€åªæœ‰åœ¨è¿è¡Œæ—¶æ‰èƒ½ç¡®å®šçœŸæ­£è¢«è°ƒç”¨çš„å‡½æ•°ï¼›è€Œé™æ€ç»‘å®šåœ¨ç¼–è¯‘æ—¶å³å¯ç¡®å®šï¼ˆä¸è€ƒè™‘å†…è”å‡½æ•°çš„å‰æä¸‹ï¼‰ï¼Œç¼–è¯‘å™¨ä¼šç›´æ¥ç”Ÿæˆè°ƒç”¨å‡½æ•°çš„æŒ‡ä»¤ï¼Œå‡½æ•°åœ°å€å°±è¢«ç¡¬ç¼–ç åœ¨æŒ‡ä»¤å½“ä¸­ã€‚</p>

<blockquote>
<p><strong>Tips - å†…è”ï¼ˆInlineï¼‰å‡½æ•°</strong></p>

<p>å»ºè®®ï¼ˆã€Œå»ºè®®ã€æŒ‡å…·ä½“æ˜¯å¦è¿›è¡Œå†…è”éœ€è¦çœ‹ç¼–è¯‘å™¨æœ¬èº«ï¼‰ç¼–è¯‘å™¨å¯¹å‡½æ•°è¿›è¡Œå†…è”æ‰©å±•ï¼Œå³å»ºè®®ç¼–è¯‘å™¨å°†æŒ‡å®šçš„å‡½æ•°ä½“ç›´æ¥æ’å…¥åˆ°æ¯ä¸€å¤„è°ƒç”¨è¯¥å‡½æ•°çš„åœ°æ–¹ã€‚</p>
</blockquote>

<p>å› æ­¤å¯¹äºåŠ¨æ€ç»‘å®šçš„è¯­è¨€æ¥è¯´ï¼Œå…¶æ–¹æ³•æŸ¥æ‰¾çš„é€Ÿåº¦ä¸€å®šæ˜¯æ…¢äºé™æ€ç»‘å®šçš„ã€‚Obj-C ä¼šå°†æ–¹æ³•æŸ¥æ‰¾çš„ç»“æœç¼“å­˜åœ¨ä¸€ä¸ªå¿«é€Ÿæ˜ å°„è¡¨ä¸­ï¼ˆFast Mapï¼‰ï¼Œå½“åç»­å‘é€åŒæ ·çš„æ¶ˆæ¯æ—¶å³å¯å¾—åˆ°æ›´å¿«å¾—æ‰§è¡Œã€‚æ ¹æ®è¿™ä¸ªå¿«æ…¢ï¼Œæ¶ˆæ¯å‘é€çš„ä»£ç è¢«åˆ†ä¸ºä¸¤ä¸ªéƒ¨åˆ†ï¼šå…¶ä¸€æ˜¯å¿«é€Ÿè·¯å¾„ï¼ˆFast Pathï¼‰ï¼Œè¿™ä¸€éƒ¨åˆ†ç”±æ±‡ç¼–è¯­è¨€å®ç°ï¼›å…¶äºŒæ˜¯æ…¢é€Ÿè·¯å¾„ï¼ˆSlow Pathï¼‰ï¼Œç”± C è¯­è¨€å®ç°ã€‚å½“æ²¡æœ‰ç¼“å­˜æ—¶ï¼Œå°†è°ƒç”¨ C è¯­è¨€ä»£ç æ¥å¤„ç†ã€‚</p>

<p>Talk is cheap, show me the code! è€Œç”±äºä»£ç çš„è·³è½¬å¾ˆéš¾ç›´æ¥åœ¨ä»£ç ä¸­æ ‡æ³¨ï¼Œæˆ‘å°†å…¶æ ¸å¿ƒæµç¨‹æŠ½è±¡ä¸ºä¸‹å›¾ï¼Œç”±äºåŸå›¾è¾ƒå¤§ï¼Œå¯æ ¹æ®éœ€è¦æ”¾å¤§æ¥çœ‹ï¼š</p>

<p><img src="/img/2019/objc_msgsend/2.png" alt="2" /></p>

<p><details>
<summary>-&gt; ç‚¹å‡»æ­¤å¤„å³å¯æŸ¥çœ‹ã€Œobjc-msg-arm64.sã€å®Œæ•´å†…å®¹ &lt;-</summary></p>

<pre><code class="language-asm">// objc-msg-arm64.s

/********************************************************************
 *
 *  objc-msg-arm64.s - ARM64 code to support objc messaging
 *
 ********************************************************************/

#ifdef __arm64__

#include &lt;arm/arch.h&gt;
#include &quot;isa.h&quot;
#include &quot;arm64-asm.h&quot;

.data

// _objc_entryPoints and _objc_exitPoints are used by method dispatch
// caching code to figure out whether any threads are actively
// in the cache for dispatching.  The labels surround the asm code
// that do cache lookups.  The tables are zero-terminated.

.align 4
.private_extern _objc_entryPoints
_objc_entryPoints:
	PTR   _cache_getImp
	PTR   _objc_msgSend
	PTR   _objc_msgSendSuper
	PTR   _objc_msgSendSuper2
	PTR   _objc_msgLookup
	PTR   _objc_msgLookupSuper2
	PTR   0

.private_extern _objc_exitPoints
_objc_exitPoints:
	PTR   LExit_cache_getImp
	PTR   LExit_objc_msgSend
	PTR   LExit_objc_msgSendSuper
	PTR   LExit_objc_msgSendSuper2
	PTR   LExit_objc_msgLookup
	PTR   LExit_objc_msgLookupSuper2
	PTR   0


/* objc_super parameter to sendSuper */
#define RECEIVER         0
#define CLASS            __SIZEOF_POINTER__

/* Selected field offsets in class structure */
#define SUPERCLASS       __SIZEOF_POINTER__
#define CACHE            (2 * __SIZEOF_POINTER__)

/* Selected field offsets in method structure */
#define METHOD_NAME      0
#define METHOD_TYPES     __SIZEOF_POINTER__
#define METHOD_IMP       (2 * __SIZEOF_POINTER__)

#define BUCKET_SIZE      (2 * __SIZEOF_POINTER__)


/********************************************************************
 * GetClassFromIsa_p16 src
 * src is a raw isa field. Sets p16 to the corresponding class pointer.
 * The raw isa might be an indexed isa to be decoded, or a
 * packed isa that needs to be masked.
 *
 * On exit:
 *   $0 is unchanged
 *   p16 is a class pointer
 *   x10 is clobbered
 ********************************************************************/

#if SUPPORT_INDEXED_ISA
	.align 3
	.globl _objc_indexed_classes
_objc_indexed_classes:
	.fill ISA_INDEX_COUNT, PTRSIZE, 0
#endif

.macro GetClassFromIsa_p16 /* src */

#if SUPPORT_INDEXED_ISA
	// Indexed isa
	mov	p16, $0			// optimistically set dst = src
	tbz	p16, #ISA_INDEX_IS_NPI_BIT, 1f	// done if not non-pointer isa
	// isa in p16 is indexed
	adrp	x10, _objc_indexed_classes@PAGE
	add	x10, x10, _objc_indexed_classes@PAGEOFF
	ubfx	p16, p16, #ISA_INDEX_SHIFT, #ISA_INDEX_BITS  // extract index
	ldr	p16, [x10, p16, UXTP #PTRSHIFT]	// load class from array
1:

#elif __LP64__
	// 64-bit packed isa
	and	p16, $0, #ISA_MASK

#else
	// 32-bit raw isa
	mov	p16, $0

#endif

.endmacro


/********************************************************************
 * ENTRY functionName
 * STATIC_ENTRY functionName
 * END_ENTRY functionName
 ********************************************************************/

.macro ENTRY /* name */
	.text
	.align 5
	.globl    $0
$0:
.endmacro

.macro STATIC_ENTRY /*name*/
	.text
	.align 5
	.private_extern $0
$0:
.endmacro

.macro END_ENTRY /* name */
LExit$0:
.endmacro


/********************************************************************
 * UNWIND name, flags
 * Unwind info generation
 ********************************************************************/
.macro UNWIND
	.section __LD,__compact_unwind,regular,debug
	PTR $0
	.set  LUnwind$0, LExit$0 - $0
	.long LUnwind$0
	.long $1
	PTR 0	 /* no personality */
	PTR 0  /* no LSDA */
	.text
.endmacro

#define NoFrame 0x02000000  // no frame, no SP adjustment
#define FrameWithNoSaves 0x04000000  // frame, no non-volatile saves


/********************************************************************
 *
 * CacheLookup NORMAL|GETIMP|LOOKUP
 *
 * Locate the implementation for a selector in a class method cache.
 *
 * Takes:
 *	 x1 = selector
 *	 x16 = class to be searched
 *
 * Kills:
 * 	 x9,x10,x11,x12, x17
 *
 * On exit: (found) calls or returns IMP
 *                  with x16 = class, x17 = IMP
 *          (not found) jumps to LCacheMiss
 *
 ********************************************************************/

#define NORMAL 0
#define GETIMP 1
#define LOOKUP 2

// CacheHit: x17 = cached IMP, x12 = address of cached IMP
.macro CacheHit
.if $0 == NORMAL
	TailCallCachedImp x17, x12	// authenticate and call imp
.elseif $0 == GETIMP
	mov	p0, p17
	AuthAndResignAsIMP x0, x12	// authenticate imp and re-sign as IMP
	ret				// return IMP
.elseif $0 == LOOKUP
	AuthAndResignAsIMP x17, x12	// authenticate imp and re-sign as IMP
	ret				// return imp via x17
.else
.abort oops
.endif
.endmacro

.macro CheckMiss
	// miss if bucket-&gt;sel == 0
.if $0 == GETIMP
	cbz	p9, LGetImpMiss
.elseif $0 == NORMAL
	cbz	p9, __objc_msgSend_uncached
.elseif $0 == LOOKUP
	cbz	p9, __objc_msgLookup_uncached
.else
.abort oops
.endif
.endmacro

.macro JumpMiss
.if $0 == GETIMP
	b	LGetImpMiss
.elseif $0 == NORMAL
	b	__objc_msgSend_uncached
.elseif $0 == LOOKUP
	b	__objc_msgLookup_uncached
.else
.abort oops
.endif
.endmacro

.macro CacheLookup
	// p1 = SEL, p16 = isa
	ldp	p10, p11, [x16, #CACHE]	// p10 = buckets, p11 = occupied|mask
#if !__LP64__
	and	w11, w11, 0xffff	// p11 = mask
#endif
	and	w12, w1, w11		// x12 = _cmd &amp; mask
	add	p12, p10, p12, LSL #(1+PTRSHIFT)
		             // p12 = buckets + ((_cmd &amp; mask) &lt;&lt; (1+PTRSHIFT))

	ldp	p17, p9, [x12]		// {imp, sel} = *bucket
1:	cmp	p9, p1			// if (bucket-&gt;sel != _cmd)
	b.ne	2f			//     scan more
	CacheHit $0			// call or return imp

2:	// not hit: p12 = not-hit bucket
	CheckMiss $0			// miss if bucket-&gt;sel == 0
	cmp	p12, p10		// wrap if bucket == buckets
	b.eq	3f
	ldp	p17, p9, [x12, #-BUCKET_SIZE]!	// {imp, sel} = *--bucket
	b	1b			// loop

3:	// wrap: p12 = first bucket, w11 = mask
	add	p12, p12, w11, UXTW #(1+PTRSHIFT)
		                        // p12 = buckets + (mask &lt;&lt; 1+PTRSHIFT)

	// Clone scanning loop to miss instead of hang when cache is corrupt.
	// The slow path may detect any corruption and halt later.

	ldp	p17, p9, [x12]		// {imp, sel} = *bucket
1:	cmp	p9, p1			// if (bucket-&gt;sel != _cmd)
	b.ne	2f			//     scan more
	CacheHit $0			// call or return imp

2:	// not hit: p12 = not-hit bucket
	CheckMiss $0			// miss if bucket-&gt;sel == 0
	cmp	p12, p10		// wrap if bucket == buckets
	b.eq	3f
	ldp	p17, p9, [x12, #-BUCKET_SIZE]!	// {imp, sel} = *--bucket
	b	1b			// loop

3:	// double wrap
	JumpMiss $0

.endmacro


/********************************************************************
 *
 * id objc_msgSend(id self, SEL _cmd, ...);
 * IMP objc_msgLookup(id self, SEL _cmd, ...);
 *
 * objc_msgLookup ABI:
 * IMP returned in x17
 * x16 reserved for our use but not used
 *
 ********************************************************************/

#if SUPPORT_TAGGED_POINTERS
	.data
	.align 3
	.globl _objc_debug_taggedpointer_classes
_objc_debug_taggedpointer_classes:
	.fill 16, 8, 0
	.globl _objc_debug_taggedpointer_ext_classes
_objc_debug_taggedpointer_ext_classes:
	.fill 256, 8, 0
#endif

	ENTRY _objc_msgSend
	UNWIND _objc_msgSend, NoFrame

	cmp	p0, #0			// nil check and tagged pointer check
#if SUPPORT_TAGGED_POINTERS
	b.le	LNilOrTagged		//  (MSB tagged pointer looks negative)
#else
	b.eq	LReturnZero
#endif
	ldr	p13, [x0]		// p13 = isa
	GetClassFromIsa_p16 p13		// p16 = class
LGetIsaDone:
	CacheLookup NORMAL		// calls imp or objc_msgSend_uncached

#if SUPPORT_TAGGED_POINTERS
LNilOrTagged:
	b.eq	LReturnZero		// nil check

	// tagged
	adrp	x10, _objc_debug_taggedpointer_classes@PAGE
	add	x10, x10, _objc_debug_taggedpointer_classes@PAGEOFF
	ubfx	x11, x0, #60, #4
	ldr	x16, [x10, x11, LSL #3]
	adrp	x10, _OBJC_CLASS_$___NSUnrecognizedTaggedPointer@PAGE
	add	x10, x10, _OBJC_CLASS_$___NSUnrecognizedTaggedPointer@PAGEOFF
	cmp	x10, x16
	b.ne	LGetIsaDone

	// ext tagged
	adrp	x10, _objc_debug_taggedpointer_ext_classes@PAGE
	add	x10, x10, _objc_debug_taggedpointer_ext_classes@PAGEOFF
	ubfx	x11, x0, #52, #8
	ldr	x16, [x10, x11, LSL #3]
	b	LGetIsaDone
// SUPPORT_TAGGED_POINTERS
#endif

LReturnZero:
	// x0 is already zero
	mov	x1, #0
	movi	d0, #0
	movi	d1, #0
	movi	d2, #0
	movi	d3, #0
	ret

	END_ENTRY _objc_msgSend


	ENTRY _objc_msgLookup
	UNWIND _objc_msgLookup, NoFrame
	cmp	p0, #0			// nil check and tagged pointer check
#if SUPPORT_TAGGED_POINTERS
	b.le	LLookup_NilOrTagged	//  (MSB tagged pointer looks negative)
#else
	b.eq	LLookup_Nil
#endif
	ldr	p13, [x0]		// p13 = isa
	GetClassFromIsa_p16 p13		// p16 = class
LLookup_GetIsaDone:
	CacheLookup LOOKUP		// returns imp

#if SUPPORT_TAGGED_POINTERS
LLookup_NilOrTagged:
	b.eq	LLookup_Nil	// nil check

	// tagged
	mov	x10, #0xf000000000000000
	cmp	x0, x10
	b.hs	LLookup_ExtTag
	adrp	x10, _objc_debug_taggedpointer_classes@PAGE
	add	x10, x10, _objc_debug_taggedpointer_classes@PAGEOFF
	ubfx	x11, x0, #60, #4
	ldr	x16, [x10, x11, LSL #3]
	b	LLookup_GetIsaDone

LLookup_ExtTag:
	adrp	x10, _objc_debug_taggedpointer_ext_classes@PAGE
	add	x10, x10, _objc_debug_taggedpointer_ext_classes@PAGEOFF
	ubfx	x11, x0, #52, #8
	ldr	x16, [x10, x11, LSL #3]
	b	LLookup_GetIsaDone
// SUPPORT_TAGGED_POINTERS
#endif

LLookup_Nil:
	adrp	x17, __objc_msgNil@PAGE
	add	x17, x17, __objc_msgNil@PAGEOFF
	ret

	END_ENTRY _objc_msgLookup


	STATIC_ENTRY __objc_msgNil

	// x0 is already zero
	mov	x1, #0
	movi	d0, #0
	movi	d1, #0
	movi	d2, #0
	movi	d3, #0
	ret

	END_ENTRY __objc_msgNil


	ENTRY _objc_msgSendSuper
	UNWIND _objc_msgSendSuper, NoFrame

	ldp	p0, p16, [x0]		// p0 = real receiver, p16 = class
	CacheLookup NORMAL		// calls imp or objc_msgSend_uncached

	END_ENTRY _objc_msgSendSuper

	// no _objc_msgLookupSuper

	ENTRY _objc_msgSendSuper2
	UNWIND _objc_msgSendSuper2, NoFrame

	ldp	p0, p16, [x0]		// p0 = real receiver, p16 = class
	ldr	p16, [x16, #SUPERCLASS]	// p16 = class-&gt;superclass
	CacheLookup NORMAL

	END_ENTRY _objc_msgSendSuper2


	ENTRY _objc_msgLookupSuper2
	UNWIND _objc_msgLookupSuper2, NoFrame

	ldp	p0, p16, [x0]		// p0 = real receiver, p16 = class
	ldr	p16, [x16, #SUPERCLASS]	// p16 = class-&gt;superclass
	CacheLookup LOOKUP

	END_ENTRY _objc_msgLookupSuper2


.macro MethodTableLookup

	// push frame
	SignLR
	stp	fp, lr, [sp, #-16]!
	mov	fp, sp

	// save parameter registers: x0..x8, q0..q7
	sub	sp, sp, #(10*8 + 8*16)
	stp	q0, q1, [sp, #(0*16)]
	stp	q2, q3, [sp, #(2*16)]
	stp	q4, q5, [sp, #(4*16)]
	stp	q6, q7, [sp, #(6*16)]
	stp	x0, x1, [sp, #(8*16+0*8)]
	stp	x2, x3, [sp, #(8*16+2*8)]
	stp	x4, x5, [sp, #(8*16+4*8)]
	stp	x6, x7, [sp, #(8*16+6*8)]
	str	x8,     [sp, #(8*16+8*8)]

	// receiver and selector already in x0 and x1
	mov	x2, x16
	bl	__class_lookupMethodAndLoadCache3

	// IMP in x0
	mov	x17, x0

	// restore registers and return
	ldp	q0, q1, [sp, #(0*16)]
	ldp	q2, q3, [sp, #(2*16)]
	ldp	q4, q5, [sp, #(4*16)]
	ldp	q6, q7, [sp, #(6*16)]
	ldp	x0, x1, [sp, #(8*16+0*8)]
	ldp	x2, x3, [sp, #(8*16+2*8)]
	ldp	x4, x5, [sp, #(8*16+4*8)]
	ldp	x6, x7, [sp, #(8*16+6*8)]
	ldr	x8,     [sp, #(8*16+8*8)]

	mov	sp, fp
	ldp	fp, lr, [sp], #16
	AuthenticateLR

.endmacro

	STATIC_ENTRY __objc_msgSend_uncached
	UNWIND __objc_msgSend_uncached, FrameWithNoSaves

	// THIS IS NOT A CALLABLE C FUNCTION
	// Out-of-band p16 is the class to search

	MethodTableLookup
	TailCallFunctionPointer x17

	END_ENTRY __objc_msgSend_uncached


	STATIC_ENTRY __objc_msgLookup_uncached
	UNWIND __objc_msgLookup_uncached, FrameWithNoSaves

	// THIS IS NOT A CALLABLE C FUNCTION
	// Out-of-band p16 is the class to search

	MethodTableLookup
	ret

	END_ENTRY __objc_msgLookup_uncached


	STATIC_ENTRY _cache_getImp

	GetClassFromIsa_p16 p0
	CacheLookup GETIMP

LGetImpMiss:
	mov	p0, #0
	ret

	END_ENTRY _cache_getImp


/********************************************************************
*
* id _objc_msgForward(id self, SEL _cmd,...);
*
* _objc_msgForward is the externally-callable
*   function returned by things like method_getImplementation().
* _objc_msgForward_impcache is the function pointer actually stored in
*   method caches.
*
********************************************************************/

	STATIC_ENTRY __objc_msgForward_impcache

	// No stret specialization.
	b	__objc_msgForward

	END_ENTRY __objc_msgForward_impcache


	ENTRY __objc_msgForward

	adrp	x17, __objc_forward_handler@PAGE
	ldr	p17, [x17, __objc_forward_handler@PAGEOFF]
	TailCallFunctionPointer x17

	END_ENTRY __objc_msgForward


	ENTRY _objc_msgSend_noarg
	b	_objc_msgSend
	END_ENTRY _objc_msgSend_noarg

	ENTRY _objc_msgSend_debug
	b	_objc_msgSend
	END_ENTRY _objc_msgSend_debug

	ENTRY _objc_msgSendSuper2_debug
	b	_objc_msgSendSuper2
	END_ENTRY _objc_msgSendSuper2_debug


	ENTRY _method_invoke
	// x1 is method triplet instead of SEL
	add	p16, p1, #METHOD_IMP
	ldr	p17, [x16]
	ldr	p1, [x1, #METHOD_NAME]
	TailCallMethodListImp x17, x16
	END_ENTRY _method_invoke

#endif
</code></pre>

<p></details></p>

<p>åœ¨ç†è§£ä¸Šé¢æ±‡ç¼–ä»£ç çš„åŒæ—¶ï¼Œéœ€è¦äº†è§£ Obj-C ä¸­å¯¹è±¡å†…éƒ¨çš„ <code>cache_t</code> å³ç¼“å­˜çš„å†…éƒ¨ç»“æ„ï¼š</p>

<pre><code class="language-cpp">// objc-runtime-new.h
#if __LP64__
typedef uint32_t mask_t;  // x86_64 &amp; arm64 asm are less efficient with 16-bits
#else
typedef uint16_t mask_t;
#endif

struct cache_t {
    struct bucket_t *_buckets;
    mask_t _mask;
    mask_t _occupied;

public:
    struct bucket_t *buckets();
    mask_t mask();
    mask_t occupied();
    void incrementOccupied();
    void setBucketsAndMask(struct bucket_t *newBuckets, mask_t newMask);
    void initializeToEmpty();

    mask_t capacity();
    bool isConstantEmptyCache();
    bool canBeFreed();

    static size_t bytesForCapacity(uint32_t cap);
    static struct bucket_t * endMarker(struct bucket_t *b, uint32_t cap);

    void expand();
    void reallocate(mask_t oldCapacity, mask_t newCapacity);
    struct bucket_t * find(cache_key_t key, id receiver);

    static void bad_cache(id receiver, SEL sel, Class isa) __attribute__((noreturn));
};

struct bucket_t {
private:
    // IMP-first is better for arm64e ptrauth and no worse for arm64.
    // SEL-first is better for armv7* and i386 and x86_64.
#if __arm64__
    MethodCacheIMP _imp;
    cache_key_t _key;
#else
    cache_key_t _key;
    MethodCacheIMP _imp;
#endif

public:
    inline cache_key_t key() const { return _key; }
    inline IMP imp() const { return (IMP)_imp; }
    inline void setKey(cache_key_t newKey) { _key = newKey; }
    inline void setImp(IMP newImp) { _imp = newImp; }

    void set(cache_key_t newKey, IMP newImp);
};
</code></pre>

<ul>
<li>C è¯­è¨€ä½¿ç”¨é™æ€ç»‘å®šï¼ˆStatic Bindingï¼‰æ¥è¿›è¡Œå‡½æ•°è°ƒç”¨ï¼Œåœ¨ç¼–è¯‘æ—¶åˆ»å°±èƒ½å†³å®šè¿è¡Œæ—¶æ‰€åº”è°ƒç”¨çš„å‡½æ•°ï¼Œå³åœ¨ä¸è€ƒè™‘å†…è”ä¸‹ï¼Œä¼šç›´æ¥ç”Ÿæˆè°ƒç”¨å‡½æ•°çš„æŒ‡ä»¤ï¼Œå‡½æ•°åœ°å€åˆ™è¢«ç¡¬ç¼–ç åœ¨æŒ‡ä»¤ä¸­ã€‚</li>

<li><p>C è¯­è¨€ä¸­ä½¿ç”¨å‡½æ•°æŒ‡é’ˆè¿›è¡Œè°ƒç”¨åˆ™å±äºåŠ¨æ€ç»‘å®šï¼ˆDynamic Bindingï¼‰ï¼Œæ‰€è¦è°ƒç”¨çš„å‡½æ•°åœ¨è¿è¡Œæ—¶æ‰èƒ½ç¡®å®šã€‚</p>

<pre><code class="language-c">// objc_msgSend çš„åŸå‹ï¼š
// id selfï¼šæ¥æ”¶è€…æœ¬èº«
// SEL cmdï¼šæ–¹æ³•é€‰æ‹©å™¨æœ¬èº«
// ...ï¼šcmd æ–¹æ³•çš„å‚æ•°ï¼ˆå¯å˜å‚æ•°å‡½æ•°ï¼‰
void objc_msgSend(id self, SEL cmd, ...)
</code></pre></li>

<li><p>Obj-C ä¸­çš„æ–¹æ³•ä½¿ç”¨åŠ¨æ€ç»‘å®šè°ƒç”¨ã€‚</p></li>

<li><p>Obj-C å¯¹è±¡æ–¹æ³•æŸ¥æ‰¾é¡ºåºï¼šæœ¬ç±»çš„ç±»å¯¹è±¡æ–¹æ³•åˆ—è¡¨ä¸­æŸ¥æ‰¾åŒåæ–¹æ³•ï¼ˆåˆ†ç±» Category ä¸­çš„æ–¹æ³•ä¼šåˆå¹¶åˆ°ç±»çš„æ–¹æ³•åˆ—è¡¨ä¸­ï¼Œæ ¹æ®åç¼–è¯‘æ›´é å‰ï¼Œä¼šè¢«å…ˆæ‰¾åˆ°ï¼‰ -&gt; è‹¥æ²¡æœ‰æ‰¾åˆ°ï¼Œåˆ™æ ¹æ® <code>superclass</code> æŒ‡é’ˆå‘çˆ¶ç±»çš„ç±»å¯¹è±¡æ–¹æ³•åˆ—è¡¨ä¸­æŸ¥æ‰¾ï¼Œç›´åˆ°æŸ¥æ‰¾åŸºç±» <code>NSObject</code> çš„ç±»å¯¹è±¡ä¸­ä¹Ÿæ²¡æœ‰åˆ™è¿›è¡Œæ¶ˆæ¯è½¬å‘ï¼ˆMessage Forwardingï¼‰ã€‚</p></li>

<li><p><code>objc_msgSend</code> ä¼šå°†æ–¹æ³•çš„åŒ¹é…çš„ç»“æœç¼“å­˜åœ¨ç±»å¯¹è±¡çš„ <code>cache_t cache;</code> ä¸­ï¼Œä¼˜åŒ–ä¹‹åæŸ¥æ‰¾ç›¸åŒæ–¹æ³•çš„é€Ÿåº¦ï¼Œä½†ä»æ…¢äºé™æ€ç»‘å®šï¼Œä¸è¿‡ä¹Ÿä¸è‡³äºæ˜¯ç“¶é¢ˆï¼›å¦‚æœå¯¹æŸ¥æ‰¾é€Ÿåº¦æè‡´è¿½æ±‚åˆ™å¯ä½¿ç”¨çº¯ C å‡½æ•°ã€‚</p></li>

<li><p>è¾¹ç•Œæƒ…å†µï¼š</p>

<ul>
<li><code>objc_msgSend_stret</code>ï¼šå¦‚æœå¾…å‘é€çš„æ¶ˆæ¯è¦è¿”å›ç»“æ„ä½“ï¼Œé‚£ä¹ˆå¯äº¤ç”±æ­¤å‡½æ•°å¤„ç†ã€‚åªæœ‰å½“ CPU çš„å¯„å­˜å™¨èƒ½å¤Ÿå®¹çº³å¾—ä¸‹æ¶ˆæ¯è¿”å›ç±»å‹æ—¶ï¼Œè¿™ä¸ªå‡½æ•°æ‰èƒ½å¤„ç†æ­¤æ¶ˆæ¯ã€‚è‹¥æ˜¯è¿”å›å€¼æ— æ³•å®¹çº³äº CPU å¯„å­˜å™¨ä¸­ï¼ˆæ¯”å¦‚è¿”å›çš„ç»“æ„ä½“å¤ªå¤§äº†ï¼‰ï¼Œé‚£ä¹ˆå°±äº¤ç”±å¦ä¸€ä¸ªå‡½æ•°æ‰§è¡Œæ´¾å‘ã€‚æ­¤æ—¶ï¼Œé‚£ä¸ªå‡½æ•°ä¼šé€šè¿‡åˆ†é…åœ¨æ ˆä¸Šçš„æŸä¸ªå˜é‡æ¥å¤„ç†æ¶ˆæ¯æ‰€è¿”å›çš„ç»“æ„ä½“ã€‚</li>
<li><code>objc_msgSend_fpret</code>ï¼šå¦‚æœæ¶ˆæ¯è¿”å›çš„æ˜¯æµ®ç‚¹æ•°ï¼Œé‚£ä¹ˆå¯äº¤ç”±æ­¤å‡½æ•°å¤„ç†ã€‚åœ¨æŸäº›ç»“æ„çš„ CPU ä¸­è°ƒç”¨å‡½æ•°æ—¶ï¼Œéœ€è¦å¯¹ã€Œæµ®ç‚¹æ•°å¯„å­˜å™¨ï¼ˆFloating-Point Registerï¼‰ã€åšç‰¹æ®Šå¤„ç†ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œé€šå¸¸æ‰€ç”¨çš„ <code>objc_msgSend</code> åœ¨è¿™ç§æƒ…å†µä¸‹å¹¶ä¸åˆé€‚ã€‚è¿™ä¸ªå‡½æ•°æ˜¯ä¸ºäº†å¤„ç† x86 ç­‰æ¶æ„ CPU ä¸­æŸäº›ä»¤äººç¨è§‰æƒŠè®¶çš„å¥‡æ€ªçŠ¶å†µã€‚ï¼ˆä¸ä¼šä½¿ç”¨åœ¨ ARM 64 æ¶æ„ä¸­ï¼‰</li>
<li><code>objc_msgSendSuper</code>ï¼šå¦‚æœè¦ç»™çˆ¶ç±»å‘é€æ¶ˆæ¯ï¼Œä¾‹å¦‚ <code>[super message:parameter]</code>ï¼Œé‚£ä¹ˆå°±äº¤ç”±æ­¤å‡½æ•°å¤„ç†ã€‚ä¹Ÿæœ‰å¦å¤–ä¸¤ä¸ªä¸ <code>objc_msgSend_stret</code> å’Œ <code>objc_msgSend_fpret</code> ç­‰æ•ˆçš„å‡½æ•°ï¼Œç”¨äºå¤„ç†å‘ç»™ <code>super</code> çš„ç›¸åº”çš„æ¶ˆæ¯ã€‚</li>
</ul></li>

<li><p>Obj-C å¯¹è±¡çš„æ¯ä¸ªæ–¹æ³•éƒ½å¯ä»¥è§†ä¸ºç®€å•çš„ C å‡½æ•°ï¼Œå…¶åŸå‹ä¸ºï¼š<code>&lt;return_type&gt; Class_selector(id self, SEL _cmd, ...)</code>ã€‚</p></li>

<li><p>Obj-C æ¯ä¸ªç±»ä¸­éƒ½æœ‰ä»¥ä¸ŠåŸå‹å‡½æ•°è¡¨ï¼Œ<code>objc_msgSend</code> ç­‰å‡½æ•°é€šè¿‡è¯¥è¡¨å¯»æ‰¾åº”è¯¥æ‰§è¡Œçš„æ–¹æ³•å¹¶è·³è‡³å…¶å®ç°ï¼ˆåŸå‹ä¸ <code>objc_msgSend</code> å‡½æ•°ç±»ä¼¼æ˜¯ä¸ºäº†åˆ©ç”¨å°¾è°ƒç”¨ä¼˜åŒ– Tail-Call Optimization æŠ€æœ¯ï¼Œç®€åŒ–è·³è‡³å®ç°çš„æ“ä½œï¼‰ã€‚</p></li>

<li><p>å¦‚æœæŸä¸ªå‡½æ•°çš„æœ€åä¸€é¡¹æ“ä½œæ˜¯è°ƒç”¨å¦å¤–ä¸€ä¸ªå‡½æ•°ï¼Œé‚£ä¹ˆå°±å¯ä»¥è¿ç”¨ã€Œå°¾è°ƒç”¨ä¼˜åŒ–ã€æŠ€æœ¯ã€‚ç¼–è¯‘å™¨ä¼šç”Ÿæˆè°ƒè½¬è‡³å¦ä¸€å‡½æ•°æ‰€éœ€çš„æŒ‡ä»¤ç ï¼Œè€Œä¸”ä¸ä¼šå‘è°ƒç”¨å †æ ˆä¸­æ¨å…¥æ–°çš„ã€Œæ ˆå¸§ Frame Stackã€ã€‚åªæœ‰å½“æŸå‡½æ•°çš„æœ€åä¸€ä¸ªæ“ä½œä»…ä»…æ˜¯è°ƒç”¨å…¶ä»–å‡½æ•°è€Œä¸ä¼šå°†å…¶è¿”å›å€¼å¦ä½œä»–ç”¨æ—¶ï¼Œæ‰èƒ½æ‰§è¡Œã€Œå°¾è°ƒç”¨ä¼˜åŒ–ã€ã€‚å¦‚æœä¸è¿™æ ·çš„è¯ï¼Œæ¯æ¬¡è°ƒç”¨ Obj-C æ–¹æ³•ä¹‹å‰éƒ½éœ€è¦éœ€è¦ä¸º <code>objc_msgSend</code> å‡†å¤‡æ ˆå¸§ï¼ˆå¯ä»¥åœ¨æ ˆè¿½è¸ª Stack Traceï¼‰ä¸­çœ‹åˆ°è¿™ç§æ ˆå¸§ï¼‰ã€‚æ­¤å¤–ï¼Œè‹¥æ˜¯ä¸ä¼˜åŒ–ï¼Œè¿˜ä¼šè¿‡æ—©åœ°å‘ç”Ÿã€Œæ ˆæº¢å‡ºï¼ˆStack Overflowï¼‰ã€ç°è±¡ã€‚</p></li>
</ul>

<h2 id="reference">Reference</h2>

<ul>
<li><a href="https://www.mikeash.com/pyblog/friday-qa-2017-06-30-dissecting-objc_msgsend-on-arm64.html">Dissecting objc_msgSend on ARM64 - Mike Ash</a></li>
<li><a href="http://infocenter.arm.com/help/index.jsp">ARM Software development tools - arm.com</a></li>

<li><p><a href="https://stackoverflow.com/questions/27353096/1b-and-1f-in-gnu-assembly">1b and 1f in GNU assembly - StackOverflow</a></p>

<pre><code class="language-lldb">(lldb) register read
General Purpose Registers:
    x0 = 0x0000000280ecc0e0
    x1 = 0x0000000102adcd50  &quot;bar&quot;
    x2 = 0x0000000000000000
    x3 = 0x0000000280ecc0f0
    x4 = 0x0000000283ec8000
    x5 = 0x0000000283ec8000
    x6 = 0x0000000000000000
    x7 = 0x0000000000000403
    x8 = 0x000001a102adcda9 (0x0000000102adcda9) (void *)0xd80000000102adcd
    x9 = 0x0000000000000000
   x10 = 0x0000000000000002
   x11 = 0x00000002819b8c28
   x12 = 0x0000000000000002
   x13 = 0x0000000000000000
   x14 = 0x00000000000000c6
   x15 = 0x0000000000000000
   x16 = 0x000000018efdd1e8  libsystem_malloc.dylib`calloc
   x17 = 0x000000018f00af84  libobjc.A.dylib`-[NSObject init]
   x18 = 0x0000000000000000
   x19 = 0x0000000283ec8000
   x20 = 0x00000001030092b0
   x21 = 0x0000000102adac97  &quot;clickOnButton:&quot;
   x22 = 0x0000000103105570
   x23 = 0x0000000102adac97  &quot;clickOnButton:&quot;
   x24 = 0x00000001d63996f0  UIKitCore`UIApp
   x25 = 0x0000000000000000
   x26 = 0x00000001c638e570
   x27 = 0x00000002802cb330
   x28 = 0x0000000103105570
    fp = 0x000000016d329420
    lr = 0x0000000102ada804  msgSend`-[ViewController clickOnButton:] + 96 at ViewController.m:33:16
    sp = 0x000000016d3293f0
    pc = 0x0000000102ada810  msgSend`-[ViewController clickOnButton:] + 108 at ViewController.m:35:6
  cpsr = 0x40000000
</code></pre></li>
</ul>

  </div>
  
  <div class="pagination">
    <div class="pagination__title">
      <span
        class="pagination__title-h">Read other posts</span>
      <hr />
    </div>
    <div class="pagination__buttons">
      
      <span class="button previous">
        <a href="/posts/2019/const_static_extern_in_cpp/">
          <span class="button__icon">â†</span>
          <span class="button__text">C/C&#43;&#43; ä¸­çš„ constã€static &amp; extern</span>
        </a>
      </span>
      
      
      <span class="button next">
        <a href="/posts/2019/0230-flatten-optional-try_zh/">
          <span class="button__text">[è¯‘]æ‘Šå¹³ç”±ã€Œtry?ã€é€ æˆçš„åµŒå¥—å¯é€‰</span>
          <span class="button__icon">â†’</span>
        </a>
      </span>
      
    </div>
  </div>
  

  

    
    
    <div class="post bg-white">
      <script src="https://utteranc.es/client.js"
            repo="kingcos/kingcos.github.io"
            issue-term="pathname"
            label="comments"
            theme="github-dark"
            crossorigin="anonymous"
            async>
      </script>
    </div>
    

</div>

  </div>

  
    <footer class="footer">
  <div class="footer__inner">
    
      <div class="copyright">
        <span>Â© 2019 Â· <a href="http://github.com/kingcos">kingcos</a></span>
      </div>
    
  </div>
</footer>

<script src="/assets/main.js"></script>
<script src="/assets/prism.js"></script>





  
</div>

</body>
</html>
