<!DOCTYPE html>
<html lang="en" >
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="author" content="kingcos" />
	
	
	
	<title>æµ…å° objc_msgSend ï½œ kingcos</title>
	
    
    
    <meta name="description" content="Obj-C ä¸­æ–¹æ³•è°ƒç”¨çš„æœ¬è´¨æ˜¯æ¶ˆæ¯å‘é€æœºåˆ¶ï¼Œå³ `[foo bar]` æ˜¯å‘ `foo` å¯¹è±¡å‘é€ä¸€æ¡ `bar` çš„æ¶ˆæ¯ï¼Œè€Œæ¶ˆæ¯å‘é€å°±æ˜¯é€šè¿‡ `objc_msgSend` æ‰€è¿›è¡Œçš„ã€‚é‚£ä¹ˆè¿™æ¬¡æœ¬æ–‡å°±ç®€å•çª¥æ¢ä¸€ä¸‹ `objc_msgSend` å§ã€‚" />
    

    
    
    <meta name="keywords" content="Hugo, theme, zozo" />
    

	
    
    <link rel="shortcut icon" href="https://kingcos.me/images/favicon.png" />

    <link rel="stylesheet" type="text/css" media="screen" href="https://kingcos.me/css/normalize.css" />
    <link rel="stylesheet" type="text/css" media="screen" href="https://cdn.jsdelivr.net/npm/animate.css@4.1.0/animate.min.css" />
    <link rel="stylesheet" type="text/css" media="screen" href="https://kingcos.me/css/zozo.css" />
	<link rel="stylesheet" type="text/css" media="screen" href="https://cdn.jsdelivr.net/npm/remixicon@2.5.0/fonts/remixicon.css" />
    <link rel="stylesheet" type="text/css" media="screen" href="https://kingcos.me/css/highlight.css" />

    
    
</head>




<body>
    <div class="main animate__animated animate__fadeInDown">
        <div class="nav_container animated fadeInDown">
    <div class="site_nav" id="site_nav">
        <ul>
            
            <li>
                <a href="/">Home</a>
            </li>
            
            <li>
                <a href="/posts/">Archive</a>
            </li>
            
            <li>
                <a href="/tags/">Tags</a>
            </li>
            
            <li>
                <a href="/about/">About</a>
            </li>
            
        </ul>
    </div>
    <div class="menu_icon">
        <a id="menu_icon"><i class="ri-menu-line"></i></a>
    </div>
</div>


<link rel="stylesheet" href="https://kingcos.me/scss/main.min.75b49085bfb07b1bf150a1d59b4773d857e0452a747e37243805218b528a4045.css" integrity="sha256-dbSQhb&#43;wexvxUKHVm0dz2FfgRSp0fjckOAUhi1KKQEU=" media="screen">

<style>
.nav_container {
  height: 1rem;
}
 
table {
    width: 100%;
    table-layout: fixed;
}

 
.markdown code {
    white-space: normal;
    word-wrap: break-word;
    word-break: break-word;
    line-height: 1.5em;
    font-size: 0.85em;
    font-weight: bold;
    display: inline-block;
     
}

 
.menu_icon a {
    font-size: 16px;
}

 
body {
    font-family: 'Hiragino Sans GB', 'SFMono', 'Lato', '-apple-system';
    -webkit-font-smoothing: 'antialiased';
}

 
.markdown strong, .markdown b, .markdown em {
    font-weight: bold;
}

.post .post_content p {
     

    line-height: 1.75em;
}

 
.markdown img {
    max-width: 100%;
    margin: 0 auto;
    display: block;
    border-radius: 0.25rem;
}

 
.ri-stack-line {
    vertical-align: middle;
}

 
.ri-map-pin-time-line {
    vertical-align: middle;
}

 
.chroma .lntd:nth-child(2) {
    width: 100%;
}

 

 
.markdown .book-hint::before {
    content: none;
}

.markdown .book-hint {
    margin: 1rem 0;
    padding: 0.5rem 1rem 0.5rem 0.75rem;

    border-inline-start: 0.25rem solid #e9ecef;
    border-radius: 0.25rem;

    font-style: normal;
     
}

.book-hint strong {
    background-color: transparent;
}

.markdown .book-hint.info {
    border-left-color:#6bf;
    background-color:rgba(102,187,255,.1);
}

.markdown .book-hint.warning {
    border-left-color:#fd6;
    background-color:rgba(255,221,102,.1);
}

.markdown .book-hint.danger {
    border-left-color:#f66;
    background-color:rgba(255,102,102,.1);
}

</style>

        <div class="header animated fadeInDown">
    <div class="site_title_container">
        <div class="site_title">
            
                <a href="https://kingcos.me/">
                    
                    <img class="kingcos" style="margin-top: -20px; margin-left: -10px;" src="/title.svg" width="150px">
                </a>
            
        </div>
        <div class="description">
            <p class="sub_title">ä¸“æ³¨ã€åšæŒ</p>
            <div class="my_socials">
                
                
                <a href="https://github.com/kingcos" title="github" target="_blank"><i class="ri-github-fill"></i></a>
                
                
                
                <a href="https://www.instagram.com/kingcos_v/" title="instagram" target="_blank"><i class="ri-instagram-fill"></i></a>
                
                
                
                <a href="https://twitter.com/kingcos_v" title="twitter" target="_blank"><i class="ri-twitter-fill"></i></a>
                
                
                
                <a href="https://weibo.com/u/1798410923" title="weibo" target="_blank"><i class="ri-weibo-fill"></i></a>
                
                
                
            </div>
        </div>
    </div>
</div>
        <div class="content">
            <div class="post_page">
                <div class="post animate__animated animate__fadeInDown">
                    <div class="post_title post_detail_title">
                        <h2><a href='/posts/2019/objc_msgsend/'>æµ…å° objc_msgSend</a></h2>
                        <span class="date">2019.10.21</span>
                        <span>by kingcos</span>
                        
                        
                        
                        
                    </div>
                    <div class="post_content markdown"><table>
<thead>
<tr>
<th style="text-align:center">Date</th>
<th style="text-align:center">Notes</th>
<th style="text-align:center">Refers.</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">2019-07-20</td>
<td style="text-align:center">é¦–æ¬¡æäº¤</td>
<td style="text-align:center"><a href="https://opensource.apple.com/tarballs/objc4/">objc4-750.1</a></td>
</tr>
<tr>
<td style="text-align:center">2019-09-07</td>
<td style="text-align:center">å®Œæˆã€Œç¼“å­˜ã€åŠ¨æ€æ–¹æ³•è§£æã€ç­‰éƒ¨åˆ†</td>
<td style="text-align:center"><a href="../objects_in_obj-c/">Obj-C ä¸­çš„å¯¹è±¡ - kingcos</a></td>
</tr>
<tr>
<td style="text-align:center">2019-10-21</td>
<td style="text-align:center">è¡¥å……ã€ŠEffective Objective-C 2.0ã€‹ç›¸å…³å†…å®¹</td>
<td style="text-align:center">ã€Š<a href="../effective_obj-c_2.0_notes/">ã€ˆç¼–å†™é«˜è´¨é‡ iOS ä¸ OS X ä»£ç çš„ 52 ä¸ªæœ‰æ•ˆæ–¹æ³•ã€‰é˜…è¯»ç¬”è®° - kingcos</a>ã€‹</td>
</tr>
</tbody>
</table>
<p><img src="/img/2019/objc_msgsend/0.png" alt="0"></p>
<h2 id="preface">Preface</h2>
<p>Obj-C ä¸­æ–¹æ³•è°ƒç”¨çš„æœ¬è´¨æ˜¯æ¶ˆæ¯å‘é€æœºåˆ¶ï¼Œå³ <code>[foo bar]</code> æ˜¯å‘ <code>foo</code> å¯¹è±¡å‘é€ä¸€æ¡ <code>bar</code> çš„æ¶ˆæ¯ï¼Œè€Œæ¶ˆæ¯å‘é€å°±æ˜¯é€šè¿‡ <code>objc_msgSend</code> æ‰€è¿›è¡Œçš„ã€‚é‚£ä¹ˆè¿™æ¬¡æœ¬æ–‡å°±ç®€å•çª¥æ¢ä¸€ä¸‹ <code>objc_msgSend</code> å§ã€‚</p>
<h2 id="why">Why</h2>
<p>åœ¨å¼€å§‹ä¹‹å‰ï¼Œå…ˆæ€è€ƒä»¥ä¸‹ä¸ºä»€ä¹ˆ Obj-C ä¸­æ–¹æ³•è°ƒç”¨çš„æœ¬è´¨æ˜¯ <code>objc_msgSend</code> å‘¢ï¼Ÿ</p>
<p>æˆ‘ä»¬åˆ›å»ºä¸€ä¸ªä½¿ç”¨ Obj-C çš„ iOS é¡¹ç›®ï¼Œå¦‚ä¸‹åœ¨ <code>ViewController</code> ä¸­æ·»åŠ ä¸€ä¸ªæŒ‰é’®ï¼Œå¹¶åœ¨æŒ‰é’®çš„ç‚¹å‡»äº‹ä»¶ä¸­åˆ›å»ºä¸€ä¸ª Obj-C å¯¹è±¡ï¼Œå†è°ƒç”¨å…¶æ–¹æ³•ï¼š</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-objectivec" data-lang="objectivec"><span class="line"><span class="cl"><span class="cp">#import &#34;ViewController.h&#34;
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="k">@interface</span> <span class="nc">Foo</span> : <span class="nc">NSObject</span>
</span></span><span class="line"><span class="cl"><span class="p">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">bar</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">@end</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">@implementation</span> <span class="nc">Foo</span>
</span></span><span class="line"><span class="cl"><span class="p">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">bar</span> <span class="p">{}</span>
</span></span><span class="line"><span class="cl"><span class="k">@end</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">@interface</span> <span class="nc">ViewController</span> <span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="k">@end</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">@implementation</span> <span class="nc">ViewController</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">-</span> <span class="p">(</span><span class="kt">IBAction</span><span class="p">)</span><span class="nf">clickOnButton:</span><span class="p">(</span><span class="n">UIButton</span> <span class="o">*</span><span class="p">)</span><span class="nv">sender</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">Foo</span> <span class="o">*</span><span class="n">foo</span> <span class="o">=</span> <span class="p">[[</span><span class="n">Foo</span> <span class="n">alloc</span><span class="p">]</span> <span class="n">init</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="p">[</span><span class="n">foo</span> <span class="n">bar</span><span class="p">];</span> <span class="c1">// Breakpoint ğŸ”´
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">@end</span>
</span></span></code></pre></div><p>æˆ‘ä»¬å°†æ–­ç‚¹æ‰“åœ¨ <code>[foo bar];</code> ä¸€è¡Œï¼Œå¯åŠ¨ç¨‹åºå¹¶ç‚¹å‡»æŒ‰é’®ã€‚åœ¨ Xcode çš„æ§åˆ¶å°å¤šæ¬¡è¾“å…¥ <code>si</code>ï¼ˆStep Intoï¼‰å³å¯æœ€ç»ˆè·³è½¬åˆ° <code>objc_msgSend</code>ï¼š</p>
<p><img src="/img/2019/objc_msgsend/3.png" alt="3"></p>
<p>æˆ–è€…æˆ‘ä»¬ä¹Ÿå¯ä»¥ä½¿ç”¨ <code>xcrun -sdk iphoneos clang -arch arm64 -rewrite-objc ViewController.m -o foo.cpp</code> å°† Obj-C ä»£ç ç¿»è¯‘ä¸º C/C++ï¼š</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-objectivec" data-lang="objectivec"><span class="line"><span class="cl"><span class="k">static</span> <span class="kt">void</span> <span class="nf">_I_ViewController_clickOnButton_</span><span class="p">(</span><span class="n">ViewController</span> <span class="o">*</span> <span class="nb">self</span><span class="p">,</span> <span class="kt">SEL</span> <span class="n">_cmd</span><span class="p">,</span> <span class="n">UIButton</span> <span class="o">*</span><span class="n">sender</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">Foo</span> <span class="o">*</span><span class="n">foo</span> <span class="o">=</span> <span class="p">((</span><span class="n">Foo</span> <span class="o">*</span><span class="p">(</span><span class="o">*</span><span class="p">)(</span><span class="kt">id</span><span class="p">,</span> <span class="kt">SEL</span><span class="p">))(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">objc_msgSend</span><span class="p">)((</span><span class="kt">id</span><span class="p">)((</span><span class="n">Foo</span> <span class="o">*</span><span class="p">(</span><span class="o">*</span><span class="p">)(</span><span class="kt">id</span><span class="p">,</span> <span class="kt">SEL</span><span class="p">))(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">objc_msgSend</span><span class="p">)((</span><span class="kt">id</span><span class="p">)</span><span class="n">objc_getClass</span><span class="p">(</span><span class="s">&#34;Foo&#34;</span><span class="p">),</span> <span class="n">sel_registerName</span><span class="p">(</span><span class="s">&#34;alloc&#34;</span><span class="p">)),</span> <span class="n">sel_registerName</span><span class="p">(</span><span class="s">&#34;init&#34;</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// objc_msgSend(foo, sel_registerName(&#34;bar&#34;))
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="p">((</span><span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="p">)(</span><span class="kt">id</span><span class="p">,</span> <span class="kt">SEL</span><span class="p">))(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">objc_msgSend</span><span class="p">)((</span><span class="kt">id</span><span class="p">)</span><span class="n">foo</span><span class="p">,</span> <span class="n">sel_registerName</span><span class="p">(</span><span class="s">&#34;bar&#34;</span><span class="p">));</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>ç»¼ä¸Šï¼Œæˆ‘ä»¬å¯ä»¥è¯´ Obj-C ä¸­æ–¹æ³•è°ƒç”¨çš„æœ¬è´¨å³æ˜¯ <code>objc_msgSend</code>ã€‚</p>
<h2 id="steps">Steps</h2>
<p><code>objc_msgSend</code> æ€»å…±åˆ†ä¸ºæ¶ˆæ¯å‘é€ã€åŠ¨æ€æ–¹æ³•è§£æã€ä»¥åŠæ¶ˆæ¯è½¬å‘ä¸‰å¤§éƒ¨åˆ†ï¼Œä¸‹é¢æˆ‘ä»¬å°±ä¾æ¬¡æ¥ç ”ç©¶ä¸€ä¸‹ã€‚</p>
<h3 id="æ¶ˆæ¯å‘é€">æ¶ˆæ¯å‘é€</h3>
<p><code>objc_msgSend</code> ä¸­çš„ç¬¬ä¸€ä¸ªéƒ¨åˆ†æ˜¯æ¶ˆæ¯å‘é€ï¼Œå³å¯¹æ¶ˆæ¯æ¥æ”¶è€…å‘é€ä¸€æ¡æ–¹æ³•æ¶ˆæ¯ï¼Œå½“æ¥æ”¶è€…å¯ä»¥å¤„ç†æ¶ˆæ¯æ—¶å°†æ‰§è¡Œç›¸åº”çš„æ–¹æ³•ï¼Œæ— æ³•å¤„ç†æ—¶åˆ™è¿›å…¥ä¸‹ä¸€æ­¥éª¤ã€‚</p>
<h4 id="where--why">Where &amp; Why</h4>
<p>åœ¨ Apple å¼€æºçš„ objc4 æºç ä¸­ï¼Œæˆ‘ä»¬ä¼¼ä¹åªèƒ½åœ¨ã€Œmessage.hã€ä¸­æ‰¾åˆ° <code>objc_msgSend</code> çš„å£°æ˜ï¼Œå…¶å°†æ¶ˆæ¯æ¥æ”¶è€…ï¼ˆå³å¯¹è±¡ï¼‰ä½œä¸ºç¬¬ä¸€ä¸ªå‚æ•°ï¼Œå°†æ¶ˆæ¯ï¼ˆå³æ–¹æ³•é€‰æ‹©å™¨ï¼‰ä½œä¸ºç¬¬äºŒä¸ªå‚æ•°ï¼Œå¹¶å°†æ–¹æ³•çš„å‚æ•°è¿½åŠ åœ¨å‚æ•°åˆ—è¡¨çš„æœ€åï¼š</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="c1">// message.h
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl"><span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm"> * Sends a message with a simple return value to an instance of a class.
</span></span></span><span class="line"><span class="cl"><span class="cm"> * å‘é€ä¸€ä¸ªå¸¦æœ‰ç®€æ˜“è¿”å›å€¼çš„æ¶ˆæ¯åˆ°ä¸€ä¸ªç±»çš„å®ä¾‹ã€‚
</span></span></span><span class="line"><span class="cl"><span class="cm"> *
</span></span></span><span class="line"><span class="cl"><span class="cm"> * @param self A pointer to the instance of the class that is to receive the message.
</span></span></span><span class="line"><span class="cl"><span class="cm"> *             æŒ‡å‘æ¥æ”¶æ¶ˆæ¯è€…å®ä¾‹çš„æŒ‡é’ˆã€‚
</span></span></span><span class="line"><span class="cl"><span class="cm"> * @param op The selector of the method that handles the message.
</span></span></span><span class="line"><span class="cl"><span class="cm"> *           å¤„ç†æ¶ˆæ¯çš„é€‰æ‹©å™¨ã€‚
</span></span></span><span class="line"><span class="cl"><span class="cm"> * @param ...
</span></span></span><span class="line"><span class="cl"><span class="cm"> *   A variable argument list containing the arguments to the method.
</span></span></span><span class="line"><span class="cl"><span class="cm"> *   åŒ…å«æ–¹æ³•å‚æ•°çš„å¯å˜å‚æ•°åˆ—è¡¨ã€‚
</span></span></span><span class="line"><span class="cl"><span class="cm"> *
</span></span></span><span class="line"><span class="cl"><span class="cm"> * @return The return value of the method.
</span></span></span><span class="line"><span class="cl"><span class="cm"> *         æ–¹æ³•çš„è¿”å›å€¼ã€‚
</span></span></span><span class="line"><span class="cl"><span class="cm"> *
</span></span></span><span class="line"><span class="cl"><span class="cm"> * @note When it encounters a method call, the compiler generates a call to one of the
</span></span></span><span class="line"><span class="cl"><span class="cm"> *  functions \c objc_msgSend, \c objc_msgSend_stret, \c objc_msgSendSuper, or \c objc_msgSendSuper_stret.
</span></span></span><span class="line"><span class="cl"><span class="cm"> *  Messages sent to an objectâ€™s superclass (using the \c super keyword) are sent using \c objc_msgSendSuper;
</span></span></span><span class="line"><span class="cl"><span class="cm"> *  other messages are sent using \c objc_msgSend. Methods that have data structures as return values
</span></span></span><span class="line"><span class="cl"><span class="cm"> *  are sent using \c objc_msgSendSuper_stret and \c objc_msgSend_stret.
</span></span></span><span class="line"><span class="cl"><span class="cm"> * æ³¨æ„ï¼šå½“é‡åˆ°æ–¹æ³•è°ƒç”¨æ—¶ï¼Œç¼–è¯‘å™¨ä¼šç”Ÿæˆå¯¹ objc_msgSendã€objc_msgSend_stretã€objc_msgSendSuperã€objc_msgSendSuper_stret å››ä¸ªå‡½æ•°ä¹‹ä¸€çš„è°ƒç”¨ã€‚
</span></span></span><span class="line"><span class="cl"><span class="cm"> * åˆ°è¾¾å¯¹è±¡çˆ¶ç±»ï¼ˆä½¿ç”¨ super å…³é”®å­—ï¼‰çš„æ¶ˆæ¯é€šè¿‡ objc_msgSendSuper å‘é€ï¼›å…¶å®ƒæ¶ˆæ¯åˆ™é€šè¿‡ objc_msgSend å‘é€ã€‚
</span></span></span><span class="line"><span class="cl"><span class="cm"> * è¿”å›å€¼ä¸ºç»“æ„ä½“çš„æ¶ˆæ¯é€šè¿‡ objc_msgSendSuper_stret æˆ– objc_msgSend_stret å‘é€ã€‚
</span></span></span><span class="line"><span class="cl"><span class="cm"> *
</span></span></span><span class="line"><span class="cl"><span class="cm"> */</span>
</span></span><span class="line"><span class="cl"><span class="n">OBJC_EXPORT</span> <span class="n">id</span> <span class="n">_Nullable</span>
</span></span><span class="line"><span class="cl"><span class="nf">objc_msgSend</span><span class="p">(</span><span class="n">id</span> <span class="n">_Nullable</span> <span class="n">self</span><span class="p">,</span> <span class="n">SEL</span> <span class="n">_Nonnull</span> <span class="n">op</span><span class="p">,</span> <span class="p">...)</span>
</span></span><span class="line"><span class="cl">    <span class="n">OBJC_AVAILABLE</span><span class="p">(</span><span class="mf">10.0</span><span class="p">,</span> <span class="mf">2.0</span><span class="p">,</span> <span class="mf">9.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mf">2.0</span><span class="p">);</span>
</span></span></code></pre></div><p><img src="/img/2019/objc_msgsend/1.png" alt="1"></p>
<p>è€Œ <code>objc_msgSend</code> çš„å…·ä½“å®ç°æ˜¯ç”±æ±‡ç¼–è¯­è¨€ç¼–å†™çš„ï¼ŒåŸå› æœ‰ä¸¤ç‚¹ï¼š</p>
<ol>
<li>å¯¹æ€§èƒ½çš„æè‡´è¿½æ±‚ï¼Œå› ä¸ºæ¯ä¸€æ¡æ±‡ç¼–æŒ‡ä»¤éƒ½å¯¹åº”ä¸€æ¡æœºå™¨æŒ‡ä»¤ï¼Œä½¿ç”¨æ±‡ç¼–å¯ä¾¿äºé’ˆå¯¹ä¸åŒæ¶æ„çš„ CPU ä¼˜åŒ–æ¯ä¸€æ¡æŒ‡ä»¤çš„é€Ÿåº¦ï¼›</li>
<li>C è¯­è¨€æ— æ³•å®ç°ä¸€ä¸ªä¿å­˜æœªçŸ¥å‚æ•°ä¸”æ”¯æŒè·³è½¬åˆ°ä»»ä¸€å‡½æ•°æŒ‡é’ˆå¤„çš„å‡½æ•°ï¼Œå¯¹äº C æ¥è¯´æ²¡æœ‰å¿…è¦çš„ç‰¹æ€§æ¥è¡¨ç¤ºï¼ˆå¼•è‡ª <a href="https://www.mikeash.com/pyblog/friday-qa-2017-06-30-dissecting-objc_msgsend-on-arm64.html">Dissecting objc_msgSend on ARM64 - Mike Ash</a>ï¼‰ã€‚</li>
</ol>
<p>ç”±äº <code>objc_msgSend</code> æ•´ä¸ªæµç¨‹æ¯”è¾ƒå¤æ‚ï¼Œä¸‹é¢æˆ‘å°†å°è¯•æŠŠæµç¨‹åˆ†è§£ä¸ºå¤šä¸ªç”¨ä¾‹ï¼Œé€ä¸ªåˆ†æã€‚</p>
<h4 id="å½“æ¥æ”¶è€…ä¸º-nil-æ—¶">å½“æ¥æ”¶è€…ä¸º <code>nil</code> æ—¶</h4>
<p>å½“æ¥æ”¶è€…ä¸º <code>nil</code> æ—¶ï¼Œå³ <code>[foo bar]</code> ä¸­çš„ <code>foo</code> ä¸º <code>nil</code>ï¼š</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-objectivec" data-lang="objectivec"><span class="line"><span class="cl"><span class="p">-</span> <span class="p">(</span><span class="kt">IBAction</span><span class="p">)</span><span class="nf">clickOnButton:</span><span class="p">(</span><span class="n">UIButton</span> <span class="o">*</span><span class="p">)</span><span class="nv">sender</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">Foo</span> <span class="o">*</span><span class="n">foo</span> <span class="o">=</span> <span class="p">[[</span><span class="n">Foo</span> <span class="n">alloc</span><span class="p">]</span> <span class="n">init</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// å°†æ¥æ”¶è€…ç½®ä¸º nil
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">foo</span> <span class="o">=</span> <span class="nb">nil</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">[</span><span class="n">foo</span> <span class="n">bar</span><span class="p">];</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// LLDB:
</span></span></span><span class="line"><span class="cl"><span class="c1">// è¿›å…¥ objc_msgSend åå¯ä»¥å°è¯•ä½¿ç”¨ LLDB å‘½ä»¤è¯»å– x0 å¯„å­˜å™¨ä¸­å­˜å‚¨çš„å€¼
</span></span></span><span class="line"><span class="cl"><span class="c1">// (lldb) register read x0
</span></span></span><span class="line"><span class="cl"><span class="c1">//       x0 = 0x0000000000000000
</span></span></span></code></pre></div><p>æˆ‘ä»¬ä» <code>ENTRY _objc_msgSend</code> çš„ç¬¬ä¸€æ¡è¯­å¥ <code>cmp p0, #0</code> å¼€å§‹ï¼š</p>
<p><img src="/img/2019/objc_msgsend/4.png" alt="4"></p>
<p>åœ¨ Xcode ä¸­ <code>si</code> æ‰§è¡Œå³å¯çœ‹åˆ°å…·ä½“çš„æ±‡ç¼–ä»£ç è·³è½¬ï¼Œä¹Ÿä¸ä¸Šå›¾çš„æºç åˆ†æä¸€è‡´ï¼š</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-asm" data-lang="asm"><span class="line"><span class="cl"><span class="nf">libobjc.A.dylib</span><span class="err">`</span><span class="no">objc_msgSend</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="err">0</span><span class="nf">x192bd8180</span> <span class="err">&lt;+</span><span class="mi">0</span><span class="err">&gt;</span><span class="p">:</span>   <span class="no">cmp</span>    <span class="no">x0</span><span class="p">,</span> <span class="c">#0x0                  ; =0x0
</span></span></span><span class="line"><span class="cl"><span class="c"></span>    <span class="mi">0x192bd8184</span> <span class="err">&lt;+</span><span class="mi">4</span><span class="err">&gt;</span><span class="p">:</span>   <span class="no">b.le</span>   <span class="mi">0x192bd81f8</span>               <span class="c">; &lt;+120&gt;
</span></span></span><span class="line"><span class="cl"><span class="c"></span>    <span class="c">; ...
</span></span></span><span class="line"><span class="cl"><span class="c"></span>    <span class="mi">0x192bd81f8</span> <span class="err">&lt;+</span><span class="mi">120</span><span class="err">&gt;</span><span class="p">:</span> <span class="no">b.eq</span>   <span class="mi">0x192bd8230</span>               <span class="c">; &lt;+176&gt;
</span></span></span><span class="line"><span class="cl"><span class="c"></span>    <span class="c">; ...
</span></span></span><span class="line"><span class="cl"><span class="c"></span>    <span class="mi">0x192bd8230</span> <span class="err">&lt;+</span><span class="mi">176</span><span class="err">&gt;</span><span class="p">:</span> <span class="no">mov</span>    <span class="no">x1</span><span class="p">,</span> <span class="c">#0x0
</span></span></span><span class="line"><span class="cl"><span class="c"></span>    <span class="mi">0x192bd8234</span> <span class="err">&lt;+</span><span class="mi">180</span><span class="err">&gt;</span><span class="p">:</span> <span class="no">movi</span>   <span class="no">d0</span><span class="p">,</span> <span class="c">#0000000000000000
</span></span></span><span class="line"><span class="cl"><span class="c"></span>    <span class="mi">0x192bd8238</span> <span class="err">&lt;+</span><span class="mi">184</span><span class="err">&gt;</span><span class="p">:</span> <span class="no">movi</span>   <span class="no">d1</span><span class="p">,</span> <span class="c">#0000000000000000
</span></span></span><span class="line"><span class="cl"><span class="c"></span>    <span class="mi">0x192bd823c</span> <span class="err">&lt;+</span><span class="mi">188</span><span class="err">&gt;</span><span class="p">:</span> <span class="no">movi</span>   <span class="no">d2</span><span class="p">,</span> <span class="c">#0000000000000000
</span></span></span><span class="line"><span class="cl"><span class="c"></span>    <span class="mi">0x192bd8240</span> <span class="err">&lt;+</span><span class="mi">192</span><span class="err">&gt;</span><span class="p">:</span> <span class="no">movi</span>   <span class="no">d3</span><span class="p">,</span> <span class="c">#0000000000000000
</span></span></span><span class="line"><span class="cl"><span class="c"></span>    <span class="mi">0x192bd8244</span> <span class="err">&lt;+</span><span class="mi">196</span><span class="err">&gt;</span><span class="p">:</span> <span class="no">ret</span>
</span></span></code></pre></div><h4 id="æ–¹æ³•ç¼“å­˜">æ–¹æ³•ç¼“å­˜</h4>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="k">struct</span> <span class="nc">objc_class</span> <span class="o">:</span> <span class="n">objc_object</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// Class ISA;
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">Class</span> <span class="n">superclass</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// â¬‡ï¸ æ–¹æ³•ç¼“å­˜
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">cache_t</span> <span class="n">cache</span><span class="p">;</span>             <span class="c1">// formerly cache pointer and vtable
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">class_data_bits_t</span> <span class="n">bits</span><span class="p">;</span>    <span class="c1">// class_rw_t * plus custom rr/alloc flags
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">};</span>
</span></span></code></pre></div><p>åœ¨ <a href="../objects_in_obj-c/">Obj-C ä¸­çš„å¯¹è±¡</a>ä¸€æ–‡ä¸­ï¼Œæˆ‘ä»¬ç®€å•äº†è§£äº† Obj-C ä¸­ç±»å’Œå…ƒç±»å¯¹è±¡çš„ç»“æ„ï¼Œå…¶ä¸­çš„ <code>cache_t cache;</code> æ˜¯æ–¹æ³•ç¼“å­˜ã€‚é‚£ä¹ˆä¸ºä»€ä¹ˆéœ€è¦ç¼“å­˜å‘¢ï¼Ÿ</p>
<p>Obj-C çš„æ¶ˆæ¯å‘é€æœ¬è´¨å±äº<strong>åŠ¨æ€ç»‘å®šï¼ˆDynamic Bindingï¼‰</strong>ï¼Œè€Œé C è¯­è¨€å¸¸ç”¨çš„é™æ€ç»‘å®šï¼ˆStatic Bindingï¼‰ã€‚åŠ¨æ€ç»‘å®šæ„å‘³ç€åªæœ‰åœ¨è¿è¡Œæ—¶æ‰èƒ½ç¡®å®šçœŸæ­£è¢«è°ƒç”¨çš„å‡½æ•°ï¼›è€Œé™æ€ç»‘å®šåœ¨ç¼–è¯‘æ—¶å³å¯ç¡®å®šï¼ˆä¸è€ƒè™‘å†…è”å‡½æ•°çš„å‰æä¸‹ï¼‰ï¼Œç¼–è¯‘å™¨ä¼šç›´æ¥ç”Ÿæˆè°ƒç”¨å‡½æ•°çš„æŒ‡ä»¤ï¼Œå‡½æ•°åœ°å€å°±è¢«ç¡¬ç¼–ç åœ¨æŒ‡ä»¤å½“ä¸­ã€‚</p>
<blockquote>
<p><strong>Tips - å†…è”ï¼ˆInlineï¼‰å‡½æ•°</strong></p>
<p>å»ºè®®ç¼–è¯‘å™¨å¯¹å‡½æ•°è¿›è¡Œå†…è”æ‰©å±•ï¼Œå³å»ºè®®ç¼–è¯‘å™¨å°†æŒ‡å®šçš„å‡½æ•°ä½“ç›´æ¥æ’å…¥åˆ°æ¯ä¸€å¤„è°ƒç”¨è¯¥å‡½æ•°çš„åœ°æ–¹ï¼ˆæ³¨ï¼šã€Œå»ºè®®ã€æŒ‡å…·ä½“æ˜¯å¦è¿›è¡Œå†…è”éœ€è¦çœ‹ç¼–è¯‘å™¨æœ¬èº«ï¼‰ã€‚</p>
</blockquote>
<p>å› æ­¤å¯¹äºåŠ¨æ€ç»‘å®šçš„è¯­è¨€æ¥è¯´ï¼Œå…¶æ–¹æ³•æŸ¥æ‰¾çš„é€Ÿåº¦ä¸€å®šæ˜¯æ…¢äºé™æ€ç»‘å®šçš„ã€‚ä¸ºäº†æé«˜æ•ˆç‡ï¼ŒObj-C ä¼šå°†æ–¹æ³•æŸ¥æ‰¾çš„ç»“æœç¼“å­˜åœ¨ <code>cache_t cache;</code> ä¸­ï¼Œå½“åç»­å‘é€åŒæ ·çš„æ¶ˆæ¯æ—¶å³å¯å¾—åˆ°æ›´å¿«å¾—æ‰§è¡Œã€‚</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="c1">// _uint32_t.h
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl"><span class="k">typedef</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="kt">uint32_t</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// _uintptr_t.h
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl"><span class="k">typedef</span> <span class="kt">unsigned</span> <span class="kt">long</span>           <span class="n">uintptr_t</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// objc-ptrauth.h
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl"><span class="k">using</span> <span class="n">MethodCacheIMP</span> <span class="o">=</span> <span class="n">IMP</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// objc-runtime-new.h
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl"><span class="cp">#if __LP64__
</span></span></span><span class="line"><span class="cl"><span class="cp"></span><span class="k">typedef</span> <span class="kt">uint32_t</span> <span class="n">mask_t</span><span class="p">;</span>  <span class="c1">// x86_64 &amp; arm64 asm are less efficient with 16-bits
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="cp">#else
</span></span></span><span class="line"><span class="cl"><span class="cp"></span><span class="k">typedef</span> <span class="kt">uint16_t</span> <span class="n">mask_t</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cp">#endif
</span></span></span><span class="line"><span class="cl"><span class="cp"></span><span class="k">typedef</span> <span class="n">uintptr_t</span> <span class="n">cache_key_t</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">struct</span> <span class="nc">bucket_t</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl"><span class="k">private</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// IMP-first is better for arm64e ptrauth and no worse for arm64.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// SEL-first is better for armv7* and i386 and x86_64.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="cp">#if __arm64__
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>    <span class="n">MethodCacheIMP</span> <span class="n">_imp</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">cache_key_t</span> <span class="n">_key</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cp">#else
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>    <span class="n">cache_key_t</span> <span class="n">_key</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">MethodCacheIMP</span> <span class="n">_imp</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cp">#endif
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl">    <span class="c1">// ...
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">};</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">struct</span> <span class="nc">cache_t</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">struct</span> <span class="nc">bucket_t</span> <span class="o">*</span><span class="n">_buckets</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">mask_t</span> <span class="n">_mask</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">mask_t</span> <span class="n">_occupied</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// ...
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">};</span>
</span></span></code></pre></div><p><code>cache_t</code> ç»“æ„ä½“ä¸­å­˜å‚¨äº†æŒ‡å‘ <code>bucket_t</code> ç»“æ„ä½“ï¼ˆæ•°ç»„ï¼‰çš„æŒ‡é’ˆã€<code>_mask</code>ï¼ˆè¡¨ç¤ºæ•£åˆ—è¡¨å®¹é‡ - 1ï¼Œè¯¦è§ä¸‹æ–‡æºç ï¼‰ã€ä»¥åŠ <code>_occupied</code>ï¼ˆè¡¨ç¤ºå·²ç¼“å­˜æ–¹æ³•çš„æ•°é‡ï¼‰ã€‚<code>bucket_t</code> å³ç¼“å­˜æ–¹æ³•çš„æ•£åˆ—è¡¨ï¼Œæ–¹æ³•åå°†ä½œä¸ºé”®ï¼Œ<code>IMP</code> å³æ–¹æ³•çš„å†…å­˜åœ°å€å°†ä½œä¸ºå€¼ã€‚</p>
<h4 id="å½“æœªå‘½ä¸­ç¼“å­˜æ—¶">å½“æœªå‘½ä¸­ç¼“å­˜æ—¶</h4>
<p>æ–¹æ³•çš„é¦–æ¬¡è°ƒç”¨æˆ–é‡åˆ°ç¼“å­˜æ‰©å®¹åæ— æ³•å‘½ä¸­ç¼“å­˜ï¼Œå°†è¿›å…¥ C å‡½æ•°ä¸­æœç´¢ï¼Œå¹¶åœ¨æ‰¾åˆ°æ–¹æ³•åç¼“å­˜åœ¨è°ƒç”¨è€…æœ¬èº«çš„ç¼“å­˜ä¸­ã€‚å› æ­¤æˆ‘ä»¬ä»ä» <code>cmp p0, #0</code> å¼€å§‹ï¼Œä½†è¿™æ¬¡æ¥æ”¶è€…å¹¶é <code>nil</code> æ‰€ä»¥ä¸ä¼šè·³å…¥åˆ¤ç©ºåˆ†æ”¯ï¼š</p>
<p><img src="/img/2019/objc_msgsend/5.png" alt="5"></p>
<p>åˆ°è¾¾ <code>bl __class_lookupMethodAndLoadCache3</code> åå°†è·³å…¥ C å‡½æ•° <code>_class_lookupMethodAndLoadCache3</code> ä¸­ï¼š</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="c1">// objc-runtime-new.mm
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl"><span class="cm">/***********************************************************************
</span></span></span><span class="line"><span class="cl"><span class="cm">* _class_lookupMethodAndLoadCache.
</span></span></span><span class="line"><span class="cl"><span class="cm">* Method lookup for dispatchers ONLY. OTHER CODE SHOULD USE lookUpImp().
</span></span></span><span class="line"><span class="cl"><span class="cm">* ä»…ä¾›è°ƒåº¦ç¨‹åºæ‰€ä½¿ç”¨çš„æ–¹æ³•æŸ¥æ‰¾ã€‚å…¶å®ƒä»£ç åº”å½“ä½¿ç”¨ lookUpImp()ã€‚
</span></span></span><span class="line"><span class="cl"><span class="cm">* This lookup avoids optimistic cache scan because the dispatcher
</span></span></span><span class="line"><span class="cl"><span class="cm">* already tried that.
</span></span></span><span class="line"><span class="cl"><span class="cm">* æ­¤æŸ¥æ‰¾å¯é¿å…ä¹è§‚ç¼“å­˜æ‰«æï¼Œå› ä¸ºè°ƒåº¦ç¨‹åºå·²ç»å°è¯•äº†æ­¤æ“ä½œã€‚
</span></span></span><span class="line"><span class="cl"><span class="cm">**********************************************************************/</span>
</span></span><span class="line"><span class="cl"><span class="n">IMP</span> <span class="nf">_class_lookupMethodAndLoadCache3</span><span class="p">(</span><span class="n">id</span> <span class="n">obj</span><span class="p">,</span> <span class="n">SEL</span> <span class="n">sel</span><span class="p">,</span> <span class="n">Class</span> <span class="n">cls</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// â¬‡ï¸ æŸ¥æ‰¾ IMP æˆ–è½¬å‘
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">return</span> <span class="n">lookUpImpOrForward</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">sel</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                              <span class="n">YES</span><span class="cm">/*initialize*/</span><span class="p">,</span> <span class="n">NO</span><span class="cm">/*cache*/</span><span class="p">,</span> <span class="n">YES</span><span class="cm">/*resolver*/</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cm">/***********************************************************************
</span></span></span><span class="line"><span class="cl"><span class="cm">* lookUpImpOrForward.
</span></span></span><span class="line"><span class="cl"><span class="cm">* The standard IMP lookup.
</span></span></span><span class="line"><span class="cl"><span class="cm">* æ ‡å‡† IMP æŸ¥æ‰¾ã€‚
</span></span></span><span class="line"><span class="cl"><span class="cm">* initialize==NO tries to avoid +initialize (but sometimes fails)
</span></span></span><span class="line"><span class="cl"><span class="cm">* initialize==NO å°è¯•é¿å…è°ƒç”¨ +initializeï¼ˆä½†æœ‰æ—¶ä¼šå¤±è´¥ï¼‰
</span></span></span><span class="line"><span class="cl"><span class="cm">* cache==NO skips optimistic unlocked lookup (but uses cache elsewhere)
</span></span></span><span class="line"><span class="cl"><span class="cm">* cache==NO è·³è¿‡ä¹è§‚è§£é”æŸ¥æ‰¾ï¼ˆä½†åœ¨å…¶å®ƒåœ°æ–¹ä½¿ç”¨ç¼“å­˜ï¼‰
</span></span></span><span class="line"><span class="cl"><span class="cm">* Most callers should use initialize==YES and cache==YES.
</span></span></span><span class="line"><span class="cl"><span class="cm">* å¤§å¤šæ•°è°ƒç”¨è€…åº”å½“ä½¿ç”¨ initialize==YES å’Œ cache==YESã€‚
</span></span></span><span class="line"><span class="cl"><span class="cm">* inst is an instance of cls or a subclass thereof, or nil if none is known.
</span></span></span><span class="line"><span class="cl"><span class="cm">* inst æ˜¯ cls æˆ–å…¶å­ç±»çš„å®ä¾‹ï¼Œè‹¥æœªçŸ¥åˆ™ä¸º nilã€‚
</span></span></span><span class="line"><span class="cl"><span class="cm">*   If cls is an un-initialized metaclass then a non-nil inst is faster.
</span></span></span><span class="line"><span class="cl"><span class="cm">*   å¦‚æœ cls æ˜¯æœªåˆå§‹åŒ–çš„å…ƒç±»ï¼Œé‚£ä¹ˆéç©º inst å°†æ›´å¿«ã€‚
</span></span></span><span class="line"><span class="cl"><span class="cm">* May return _objc_msgForward_impcache. IMPs destined for external use
</span></span></span><span class="line"><span class="cl"><span class="cm">*   must be converted to _objc_msgForward or _objc_msgForward_stret.
</span></span></span><span class="line"><span class="cl"><span class="cm">* å¯èƒ½ä¼šè¿”å› _objc_msgForward_impcacheã€‚è¢«æŒ‡å®šå¤–éƒ¨ä½¿ç”¨çš„ IMP å¿…é¡»è½¬æ¢ä¸º _objc_msgForward æˆ– _objc_msgForward_stretã€‚
</span></span></span><span class="line"><span class="cl"><span class="cm">*   If you don&#39;t want forwarding at all, use lookUpImpOrNil() instead.
</span></span></span><span class="line"><span class="cl"><span class="cm">*   å¦‚æœä¸ä½ éœ€è¦ä»»ä½•è½¬å‘ï¼Œä½¿ç”¨ lookUpImpOrNil() ä»£æ›¿ã€‚
</span></span></span><span class="line"><span class="cl"><span class="cm">**********************************************************************/</span>
</span></span><span class="line"><span class="cl"><span class="n">IMP</span> <span class="nf">lookUpImpOrForward</span><span class="p">(</span><span class="n">Class</span> <span class="n">cls</span><span class="p">,</span> <span class="n">SEL</span> <span class="n">sel</span><span class="p">,</span> <span class="n">id</span> <span class="n">inst</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                       <span class="kt">bool</span> <span class="n">initialize</span><span class="p">,</span> <span class="kt">bool</span> <span class="n">cache</span><span class="p">,</span> <span class="kt">bool</span> <span class="n">resolver</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">IMP</span> <span class="n">imp</span> <span class="o">=</span> <span class="n">nil</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kt">bool</span> <span class="n">triedResolver</span> <span class="o">=</span> <span class="n">NO</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">runtimeLock</span><span class="p">.</span><span class="n">assertUnlocked</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// Optimistic cache lookup
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// cache ä¸º NOï¼Œè·³è¿‡
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="n">cache</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">imp</span> <span class="o">=</span> <span class="n">cache_getImp</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">sel</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">imp</span><span class="p">)</span> <span class="k">return</span> <span class="n">imp</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// runtimeLock is held during isRealized and isInitialized checking
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// to prevent races against concurrent realization.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">    <span class="c1">// runtimeLock is held during method search to make
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// method-lookup + cache-fill atomic with respect to method addition.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// Otherwise, a category could be added but ignored indefinitely because
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// the cache was re-filled with the old value after the cache flush on
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// behalf of the category.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">    <span class="n">runtimeLock</span><span class="p">.</span><span class="n">lock</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="n">checkIsKnownClass</span><span class="p">(</span><span class="n">cls</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// è‹¥ç±»æœªå®åŒ–ï¼Œåˆ™è¿›è¡Œå®åŒ–
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cls</span><span class="o">-&gt;</span><span class="n">isRealized</span><span class="p">())</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">realizeClass</span><span class="p">(</span><span class="n">cls</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">initialize</span>  <span class="o">&amp;&amp;</span>  <span class="o">!</span><span class="n">cls</span><span class="o">-&gt;</span><span class="n">isInitialized</span><span class="p">())</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">runtimeLock</span><span class="p">.</span><span class="n">unlock</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">        <span class="n">_class_initialize</span> <span class="p">(</span><span class="n">_class_getNonMetaClass</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">inst</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">        <span class="n">runtimeLock</span><span class="p">.</span><span class="n">lock</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// If sel == initialize, _class_initialize will send +initialize and
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// then the messenger will send +initialize again after this
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// procedure finishes. Of course, if this is not being called
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// from the messenger then it won&#39;t happen. 2778172
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"> <span class="nl">retry</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="n">runtimeLock</span><span class="p">.</span><span class="n">assertLocked</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// Try this class&#39;s cache.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">    <span class="c1">// â¬‡ï¸ å†æ¬¡å°è¯•ä»ç¼“å­˜ä¸­å– IMPï¼ˆæ±‡ç¼–ï¼‰
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">imp</span> <span class="o">=</span> <span class="n">cache_getImp</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">sel</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// å–åˆ°äº†åˆ™ç»“æŸ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="n">imp</span><span class="p">)</span> <span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// Try this class&#39;s method lists.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// â¬‡ï¸ æ ¹æ® SEL è·å–æœ¬ç±»çš„æ–¹æ³•
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">Method</span> <span class="n">meth</span> <span class="o">=</span> <span class="n">getMethodNoSuper_nolock</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">sel</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">meth</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="c1">// â¬‡ï¸ å¦‚æœè·å–åˆ°æ–¹æ³•äº†ï¼Œåˆ™å¡«å……ç¼“å­˜ï¼Œå¹¶è¿”å› IMP
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="n">log_and_fill_cache</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">meth</span><span class="o">-&gt;</span><span class="n">imp</span><span class="p">,</span> <span class="n">sel</span><span class="p">,</span> <span class="n">inst</span><span class="p">,</span> <span class="n">cls</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="n">imp</span> <span class="o">=</span> <span class="n">meth</span><span class="o">-&gt;</span><span class="n">imp</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// Try superclass caches and method lists.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="kt">unsigned</span> <span class="n">attempts</span> <span class="o">=</span> <span class="n">unreasonableClassCount</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// å¦‚æœæœ¬ç±»æ‰¾ä¸åˆ°ï¼Œåˆ™å»çˆ¶ç±»ï¼ˆçˆ¶ç±»çš„çˆ¶ç±»ï¼‰ä¸­æŸ¥æ‰¾
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">for</span> <span class="p">(</span><span class="n">Class</span> <span class="n">curClass</span> <span class="o">=</span> <span class="n">cls</span><span class="o">-&gt;</span><span class="n">superclass</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">             <span class="n">curClass</span> <span class="o">!=</span> <span class="n">nil</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">             <span class="n">curClass</span> <span class="o">=</span> <span class="n">curClass</span><span class="o">-&gt;</span><span class="n">superclass</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="c1">// Halt if there is a cycle in the superclass chain.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="k">if</span> <span class="p">(</span><span class="o">--</span><span class="n">attempts</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">_objc_fatal</span><span class="p">(</span><span class="s">&#34;Memory corruption in class list.&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="c1">// Superclass cache.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="c1">// åœ¨çˆ¶ç±»ç¼“å­˜ä¸­æ‰¾
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="n">imp</span> <span class="o">=</span> <span class="n">cache_getImp</span><span class="p">(</span><span class="n">curClass</span><span class="p">,</span> <span class="n">sel</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="p">(</span><span class="n">imp</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="p">(</span><span class="n">imp</span> <span class="o">!=</span> <span class="p">(</span><span class="n">IMP</span><span class="p">)</span><span class="n">_objc_msgForward_impcache</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                    <span class="c1">// Found the method in a superclass. Cache it in this class.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                    <span class="c1">// çˆ¶ç±»ä¸­æ‰¾åˆ°äº†ï¼Œåˆ™åœ¨æœ¬ç±»ç¼“å­˜å¹¶è¿”å› IMP
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                    <span class="n">log_and_fill_cache</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">imp</span><span class="p">,</span> <span class="n">sel</span><span class="p">,</span> <span class="n">inst</span><span class="p">,</span> <span class="n">curClass</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                    <span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                <span class="p">}</span>
</span></span><span class="line"><span class="cl">                <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                    <span class="c1">// âš ï¸ çˆ¶ç±»çš„æ–¹æ³•è½¬å‘å…¥å£ï¼Œåœæ­¢å¾ªç¯
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                    <span class="c1">// Found a forward:: entry in a superclass.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                    <span class="c1">// Stop searching, but don&#39;t cache yet; call method
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                    <span class="c1">// resolver for this class first.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                    <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                <span class="p">}</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="c1">// Superclass method list.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="c1">// çˆ¶ç±»ç¼“å­˜æœªæ‰¾åˆ°ï¼Œåˆ™åœ¨çˆ¶ç±»çš„æ–¹æ³•åˆ—è¡¨ä¸­æŸ¥æ‰¾
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="n">Method</span> <span class="n">meth</span> <span class="o">=</span> <span class="n">getMethodNoSuper_nolock</span><span class="p">(</span><span class="n">curClass</span><span class="p">,</span> <span class="n">sel</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="p">(</span><span class="n">meth</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="c1">// æ‰¾åˆ°åˆ™åœ¨æœ¬ç±»ç¼“å­˜
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="n">log_and_fill_cache</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">meth</span><span class="o">-&gt;</span><span class="n">imp</span><span class="p">,</span> <span class="n">sel</span><span class="p">,</span> <span class="n">inst</span><span class="p">,</span> <span class="n">curClass</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                <span class="n">imp</span> <span class="o">=</span> <span class="n">meth</span><span class="o">-&gt;</span><span class="n">imp</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                <span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// No implementation found. Try method resolver once.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// IMP æ‰¾ä¸åˆ°ï¼Œåˆ™è¿›å…¥æ–¹æ³•åŠ¨æ€è§£æä¸€æ¬¡ã€‚è¯¦è§ä¸‹æ–‡ã€ŒåŠ¨æ€æ–¹æ³•è§£æã€ä¸€èŠ‚ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="n">resolver</span>  <span class="o">&amp;&amp;</span>  <span class="o">!</span><span class="n">triedResolver</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">runtimeLock</span><span class="p">.</span><span class="n">unlock</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">        <span class="n">_class_resolveMethod</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">sel</span><span class="p">,</span> <span class="n">inst</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">runtimeLock</span><span class="p">.</span><span class="n">lock</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// Don&#39;t cache the result; we don&#39;t hold the lock so it may have
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// changed already. Re-do the search from scratch instead.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// æ ‡è®°ä¸º YES
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">triedResolver</span> <span class="o">=</span> <span class="n">YES</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">goto</span> <span class="n">retry</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// No implementation found, and method resolver didn&#39;t help.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// Use forwarding.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// å®ç°æ— æ³•æ‰¾åˆ°ï¼Œæ–¹æ³•è§£ææ— æ•ˆï¼Œå°è¯•æ–¹æ³•è½¬å‘ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">    <span class="n">imp</span> <span class="o">=</span> <span class="p">(</span><span class="n">IMP</span><span class="p">)</span><span class="n">_objc_msgForward_impcache</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">cache_fill</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">sel</span><span class="p">,</span> <span class="n">imp</span><span class="p">,</span> <span class="n">inst</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"> <span class="nl">done</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="n">runtimeLock</span><span class="p">.</span><span class="n">unlock</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">imp</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">static</span> <span class="n">method_t</span> <span class="o">*</span>
</span></span><span class="line"><span class="cl"><span class="nf">getMethodNoSuper_nolock</span><span class="p">(</span><span class="n">Class</span> <span class="n">cls</span><span class="p">,</span> <span class="n">SEL</span> <span class="n">sel</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">runtimeLock</span><span class="p">.</span><span class="n">assertLocked</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">assert</span><span class="p">(</span><span class="n">cls</span><span class="o">-&gt;</span><span class="n">isRealized</span><span class="p">());</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// fixme nil cls?
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// fixme nil sel?
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="p">(</span><span class="k">auto</span> <span class="n">mlists</span> <span class="o">=</span> <span class="n">cls</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">methods</span><span class="p">.</span><span class="n">beginLists</span><span class="p">(),</span>
</span></span><span class="line"><span class="cl">              <span class="n">end</span> <span class="o">=</span> <span class="n">cls</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">methods</span><span class="p">.</span><span class="n">endLists</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">         <span class="n">mlists</span> <span class="o">!=</span> <span class="n">end</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">         <span class="o">++</span><span class="n">mlists</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// â¬‡ï¸ åœ¨æ–¹æ³•åˆ—è¡¨ä¸­æŸ¥æ‰¾æ–¹æ³•
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">method_t</span> <span class="o">*</span><span class="n">m</span> <span class="o">=</span> <span class="n">search_method_list</span><span class="p">(</span><span class="o">*</span><span class="n">mlists</span><span class="p">,</span> <span class="n">sel</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">m</span><span class="p">)</span> <span class="k">return</span> <span class="n">m</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">nil</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cm">/***********************************************************************
</span></span></span><span class="line"><span class="cl"><span class="cm">* getMethodNoSuper_nolock
</span></span></span><span class="line"><span class="cl"><span class="cm">* fixme
</span></span></span><span class="line"><span class="cl"><span class="cm">* Locking: runtimeLock must be read- or write-locked by the caller
</span></span></span><span class="line"><span class="cl"><span class="cm">**********************************************************************/</span>
</span></span><span class="line"><span class="cl"><span class="k">static</span> <span class="n">method_t</span> <span class="o">*</span><span class="nf">search_method_list</span><span class="p">(</span><span class="k">const</span> <span class="n">method_list_t</span> <span class="o">*</span><span class="n">mlist</span><span class="p">,</span> <span class="n">SEL</span> <span class="n">sel</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">methodListIsFixedUp</span> <span class="o">=</span> <span class="n">mlist</span><span class="o">-&gt;</span><span class="n">isFixedUp</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">methodListHasExpectedSize</span> <span class="o">=</span> <span class="n">mlist</span><span class="o">-&gt;</span><span class="n">entsize</span><span class="p">()</span> <span class="o">==</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">method_t</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">__builtin_expect</span><span class="p">(</span><span class="n">methodListIsFixedUp</span> <span class="o">&amp;&amp;</span> <span class="n">methodListHasExpectedSize</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// åœ¨å·²æ’åºçš„æ–¹æ³•åˆ—è¡¨ä¸­æŸ¥æ‰¾
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">return</span> <span class="n">findMethodInSortedMethodList</span><span class="p">(</span><span class="n">sel</span><span class="p">,</span> <span class="n">mlist</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// Linear search of unsorted method list
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// çº¿æ€§æŸ¥æ‰¾æœªæ’åºæ–¹æ³•åˆ—è¡¨
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">for</span> <span class="p">(</span><span class="k">auto</span><span class="o">&amp;</span> <span class="nl">meth</span> <span class="p">:</span> <span class="o">*</span><span class="n">mlist</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="p">(</span><span class="n">meth</span><span class="p">.</span><span class="n">name</span> <span class="o">==</span> <span class="n">sel</span><span class="p">)</span> <span class="k">return</span> <span class="o">&amp;</span><span class="n">meth</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cp">#if DEBUG
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>    <span class="c1">// sanity-check negative results
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="n">mlist</span><span class="o">-&gt;</span><span class="n">isFixedUp</span><span class="p">())</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="p">(</span><span class="k">auto</span><span class="o">&amp;</span> <span class="nl">meth</span> <span class="p">:</span> <span class="o">*</span><span class="n">mlist</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="p">(</span><span class="n">meth</span><span class="p">.</span><span class="n">name</span> <span class="o">==</span> <span class="n">sel</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">_objc_fatal</span><span class="p">(</span><span class="s">&#34;linear search worked when binary search did not&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="cp">#endif
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">nil</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cm">/***********************************************************************
</span></span></span><span class="line"><span class="cl"><span class="cm">* log_and_fill_cache
</span></span></span><span class="line"><span class="cl"><span class="cm">* Log this method call. If the logger permits it, fill the method cache.
</span></span></span><span class="line"><span class="cl"><span class="cm">* è®°å½•è¯¥æ–¹æ³•è°ƒç”¨ã€‚å¦‚æœè®°å½•å™¨å…è®¸ï¼Œå¡«å……æ–¹æ³•ç¼“å­˜ã€‚
</span></span></span><span class="line"><span class="cl"><span class="cm">* cls is the method whose cache should be filled.
</span></span></span><span class="line"><span class="cl"><span class="cm">* æ–¹æ³•åº”å½“å¡«å……åœ¨ cls çš„ç¼“å­˜ä¸­ã€‚
</span></span></span><span class="line"><span class="cl"><span class="cm">* implementer is the class that owns the implementation in question.
</span></span></span><span class="line"><span class="cl"><span class="cm">* implementer æŒ‡æ‹¥æœ‰ç›¸å…³å®ç°çš„ç±»ã€‚
</span></span></span><span class="line"><span class="cl"><span class="cm">**********************************************************************/</span>
</span></span><span class="line"><span class="cl"><span class="k">static</span> <span class="kt">void</span>
</span></span><span class="line"><span class="cl"><span class="nf">log_and_fill_cache</span><span class="p">(</span><span class="n">Class</span> <span class="n">cls</span><span class="p">,</span> <span class="n">IMP</span> <span class="n">imp</span><span class="p">,</span> <span class="n">SEL</span> <span class="n">sel</span><span class="p">,</span> <span class="n">id</span> <span class="n">receiver</span><span class="p">,</span> <span class="n">Class</span> <span class="n">implementer</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl"><span class="cp">#if SUPPORT_MESSAGE_LOGGING
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>    <span class="k">if</span> <span class="p">(</span><span class="n">objcMsgLogEnabled</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="kt">bool</span> <span class="n">cacheIt</span> <span class="o">=</span> <span class="n">logMessageSend</span><span class="p">(</span><span class="n">implementer</span><span class="o">-&gt;</span><span class="n">isMetaClass</span><span class="p">(),</span>
</span></span><span class="line"><span class="cl">                                      <span class="n">cls</span><span class="o">-&gt;</span><span class="n">nameForLogging</span><span class="p">(),</span>
</span></span><span class="line"><span class="cl">                                      <span class="n">implementer</span><span class="o">-&gt;</span><span class="n">nameForLogging</span><span class="p">(),</span>
</span></span><span class="line"><span class="cl">                                      <span class="n">sel</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cacheIt</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="cp">#endif
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>    <span class="c1">// â¬‡ï¸ å¡«å……ç¼“å­˜
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">cache_fill</span> <span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">sel</span><span class="p">,</span> <span class="n">imp</span><span class="p">,</span> <span class="n">receiver</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// objc-cache.mm
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">cache_fill</span><span class="p">(</span><span class="n">Class</span> <span class="n">cls</span><span class="p">,</span> <span class="n">SEL</span> <span class="n">sel</span><span class="p">,</span> <span class="n">IMP</span> <span class="n">imp</span><span class="p">,</span> <span class="n">id</span> <span class="n">receiver</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl"><span class="cp">#if !DEBUG_TASK_THREADS
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>    <span class="n">mutex_locker_t</span> <span class="n">lock</span><span class="p">(</span><span class="n">cacheUpdateLock</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// â¬‡ï¸ å¡«å……ç¼“å­˜
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">cache_fill_nolock</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">sel</span><span class="p">,</span> <span class="n">imp</span><span class="p">,</span> <span class="n">receiver</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="cp">#else
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>    <span class="n">_collecting_in_critical</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cp">#endif
</span></span></span><span class="line"><span class="cl"><span class="cp"></span><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">static</span> <span class="kt">void</span> <span class="nf">cache_fill_nolock</span><span class="p">(</span><span class="n">Class</span> <span class="n">cls</span><span class="p">,</span> <span class="n">SEL</span> <span class="n">sel</span><span class="p">,</span> <span class="n">IMP</span> <span class="n">imp</span><span class="p">,</span> <span class="n">id</span> <span class="n">receiver</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">cacheUpdateLock</span><span class="p">.</span><span class="n">assertLocked</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// Never cache before +initialize is done
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// è‹¥ç±»æœªåˆå§‹åŒ–ï¼Œåˆ™è¿”å›
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cls</span><span class="o">-&gt;</span><span class="n">isInitialized</span><span class="p">())</span> <span class="k">return</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// Make sure the entry wasn&#39;t added to the cache by some other thread
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// before we grabbed the cacheUpdateLock.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// è‹¥ç¼“å­˜ä¸­å·²å­˜åœ¨ï¼Œåˆ™è¿”å›
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="n">cache_getImp</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">sel</span><span class="p">))</span> <span class="k">return</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">cache_t</span> <span class="o">*</span><span class="n">cache</span> <span class="o">=</span> <span class="n">getCache</span><span class="p">(</span><span class="n">cls</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// â¬‡ï¸ è·å–ç¼“å­˜ keyï¼Œæœ¬è´¨å³ SEL
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">cache_key_t</span> <span class="n">key</span> <span class="o">=</span> <span class="n">getKey</span><span class="p">(</span><span class="n">sel</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// Use the cache as-is if it is less than 3/4 full
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// å¦‚æœå°äºç­‰äº 3/4 æ»¡ï¼Œåˆ™ä½¿ç”¨ç¼“å­˜
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// newOccupied ä¸ºå½“å‰å ç”¨æ•° + 1
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">mask_t</span> <span class="n">newOccupied</span> <span class="o">=</span> <span class="n">cache</span><span class="o">-&gt;</span><span class="n">occupied</span><span class="p">()</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// capacity ä¸ºå®¹é‡ï¼ˆmask + 1 æˆ– 0ï¼‰
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">mask_t</span> <span class="n">capacity</span> <span class="o">=</span> <span class="n">cache</span><span class="o">-&gt;</span><span class="n">capacity</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">cache</span><span class="o">-&gt;</span><span class="n">isConstantEmptyCache</span><span class="p">())</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// ç¼“å­˜ä¸ºç©º
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// Cache is read-only. Replace it.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// é‡æ–°åˆ†é…å†…å­˜
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">cache</span><span class="o">-&gt;</span><span class="n">reallocate</span><span class="p">(</span><span class="n">capacity</span><span class="p">,</span> <span class="n">capacity</span> <span class="o">?:</span> <span class="n">INIT_CACHE_SIZE</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">newOccupied</span> <span class="o">&lt;=</span> <span class="n">capacity</span> <span class="o">/</span> <span class="mi">4</span> <span class="o">*</span> <span class="mi">3</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// Cache is less than 3/4 full. Use it as-is.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// ç¼“å­˜å·²å ç”¨æ¯”ä¾‹å°äºç­‰äº 3/4ï¼Œåˆ™ä½¿ç”¨
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// Cache is too full. Expand it.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// â¬‡ï¸ å¤§äº 3/4 åˆ™å…ˆæ‰©å®¹ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">cache</span><span class="o">-&gt;</span><span class="n">expand</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// Scan for the first unused slot and insert there.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// æ‰«æé¦–ä¸ªæœªä½¿ç”¨çš„é—´éš™å¹¶æ’å…¥ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// There is guaranteed to be an empty slot because the
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// minimum size is 4 and we resized at 3/4 full.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// èƒ½å¤Ÿè¢«ç¡®ä¿æœ‰ç©ºé—´éš™æ˜¯å› ä¸ºæœ€å°å¤§å°ä¸º 4ï¼Œå¹¶é‡è°ƒä¸º 3/4 æ»¡ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// â¬‡ï¸ æŸ¥æ‰¾è¦å­˜å…¥çš„ bucket_t
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">bucket_t</span> <span class="o">*</span><span class="n">bucket</span> <span class="o">=</span> <span class="n">cache</span><span class="o">-&gt;</span><span class="n">find</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">receiver</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// key ä¸ºç©ºï¼Œåˆ™ä¸ºæ–°å ç”¨ç¼“å­˜ï¼Œå ç”¨æ•°éœ€è‡ªå¢
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="n">bucket</span><span class="o">-&gt;</span><span class="n">key</span><span class="p">()</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="n">cache</span><span class="o">-&gt;</span><span class="n">incrementOccupied</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// å­˜å…¥ bucket
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">bucket</span><span class="o">-&gt;</span><span class="n">set</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">imp</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">mask_t</span> <span class="n">cache_t</span><span class="o">::</span><span class="n">capacity</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nf">mask</span><span class="p">()</span> <span class="o">?</span> <span class="n">mask</span><span class="p">()</span><span class="o">+</span><span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">cache_key_t</span> <span class="nf">getKey</span><span class="p">(</span><span class="n">SEL</span> <span class="n">sel</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">assert</span><span class="p">(</span><span class="n">sel</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// å°† SEL å¼ºè½¬ä¸º cache_key_t ç±»å‹
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">return</span> <span class="p">(</span><span class="n">cache_key_t</span><span class="p">)</span><span class="n">sel</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// ğŸŒŸ æ ¹æ® key æŸ¥æ‰¾ bucket_t
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="n">bucket_t</span> <span class="o">*</span> <span class="n">cache_t</span><span class="o">::</span><span class="n">find</span><span class="p">(</span><span class="n">cache_key_t</span> <span class="n">k</span><span class="p">,</span> <span class="n">id</span> <span class="n">receiver</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">assert</span><span class="p">(</span><span class="n">k</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// b ä¸º buckets æ•°ç»„é¦–åœ°å€
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">bucket_t</span> <span class="o">*</span><span class="n">b</span> <span class="o">=</span> <span class="n">buckets</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="n">mask_t</span> <span class="n">m</span> <span class="o">=</span> <span class="n">mask</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// begin ä¸ºæ–¹æ³•åœ¨æ•£åˆ—è¡¨çš„ç´¢å¼•
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">mask_t</span> <span class="n">begin</span> <span class="o">=</span> <span class="n">cache_hash</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">m</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// ä»ç´¢å¼•å¼€å§‹éå†
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">mask_t</span> <span class="n">i</span> <span class="o">=</span> <span class="n">begin</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">do</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// å¦‚æœè¯¥ç´¢å¼•å¯¹åº”çš„ bucket_t ä¸­çš„ keyï¼ˆSELï¼‰å¯¹åº”äº†æˆ‘ä»¬æŸ¥æ‰¾çš„ keyï¼ˆå³å·²å­˜åœ¨ï¼‰æˆ–ä¸ºç©º
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// åˆ™ä»£è¡¨å½“å‰ bucket_t å¯æ’å…¥
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">if</span> <span class="p">(</span><span class="n">b</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">key</span><span class="p">()</span> <span class="o">==</span> <span class="mi">0</span>  <span class="o">||</span>  <span class="n">b</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">key</span><span class="p">()</span> <span class="o">==</span> <span class="n">k</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="o">&amp;</span><span class="n">b</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// ç´¢å¼•å†²çªï¼Œåˆ™è¿›å…¥å½“å‰ç´¢å¼•çš„ä¸‹ä¸€æ ¼
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="p">}</span> <span class="k">while</span> <span class="p">((</span><span class="n">i</span> <span class="o">=</span> <span class="n">cache_next</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">m</span><span class="p">))</span> <span class="o">!=</span> <span class="n">begin</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// hack
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">Class</span> <span class="n">cls</span> <span class="o">=</span> <span class="p">(</span><span class="n">Class</span><span class="p">)((</span><span class="n">uintptr_t</span><span class="p">)</span><span class="k">this</span> <span class="o">-</span> <span class="n">offsetof</span><span class="p">(</span><span class="n">objc_class</span><span class="p">,</span> <span class="n">cache</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">    <span class="n">cache_t</span><span class="o">::</span><span class="n">bad_cache</span><span class="p">(</span><span class="n">receiver</span><span class="p">,</span> <span class="p">(</span><span class="n">SEL</span><span class="p">)</span><span class="n">k</span><span class="p">,</span> <span class="n">cls</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// Class points to cache. SEL is key. Cache buckets store SEL+IMP.
</span></span></span><span class="line"><span class="cl"><span class="c1">// Caches are never built in the dyld shared cache.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl"><span class="k">static</span> <span class="kr">inline</span> <span class="n">mask_t</span> <span class="nf">cache_hash</span><span class="p">(</span><span class="n">cache_key_t</span> <span class="n">key</span><span class="p">,</span> <span class="n">mask_t</span> <span class="n">mask</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// key &amp; mask è·å¾—ç´¢å¼•
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">return</span> <span class="p">(</span><span class="n">mask_t</span><span class="p">)(</span><span class="n">key</span> <span class="o">&amp;</span> <span class="n">mask</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">static</span> <span class="kr">inline</span> <span class="n">mask_t</span> <span class="nf">cache_next</span><span class="p">(</span><span class="n">mask_t</span> <span class="n">i</span><span class="p">,</span> <span class="n">mask_t</span> <span class="n">mask</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">mask</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// ç¼“å­˜æ‰©å®¹
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kt">void</span> <span class="n">cache_t</span><span class="o">::</span><span class="n">expand</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">cacheUpdateLock</span><span class="p">.</span><span class="n">assertLocked</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kt">uint32_t</span> <span class="n">oldCapacity</span> <span class="o">=</span> <span class="n">capacity</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// æ‰©å®¹å¤§å°ä¸ºåŸç©ºé—´ 2 å€ï¼ˆè‹¥åŸä¸ºç©ºï¼Œåˆ™æ‰©å®¹ä¸ºåˆå§‹å¤§å°ï¼‰
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kt">uint32_t</span> <span class="n">newCapacity</span> <span class="o">=</span> <span class="n">oldCapacity</span> <span class="o">?</span> <span class="n">oldCapacity</span><span class="o">*</span><span class="mi">2</span> <span class="o">:</span> <span class="n">INIT_CACHE_SIZE</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">((</span><span class="kt">uint32_t</span><span class="p">)(</span><span class="n">mask_t</span><span class="p">)</span><span class="n">newCapacity</span> <span class="o">!=</span> <span class="n">newCapacity</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// mask overflow - can&#39;t grow further
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// fixme this wastes one bit of mask
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">newCapacity</span> <span class="o">=</span> <span class="n">oldCapacity</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">reallocate</span><span class="p">(</span><span class="n">oldCapacity</span><span class="p">,</span> <span class="n">newCapacity</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cm">/* Initial cache bucket count. INIT_CACHE_SIZE must be a power of two. */</span>
</span></span><span class="line"><span class="cl"><span class="k">enum</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">INIT_CACHE_SIZE_LOG2</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// å·¦ç§» 2 ä½ï¼Œä¸º 4
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">INIT_CACHE_SIZE</span>      <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">INIT_CACHE_SIZE_LOG2</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">};</span>
</span></span></code></pre></div><p>å¦‚ä¸Šï¼Œæ¶ˆæ¯å‘é€çš„ä»£ç è¢«åˆ†ä¸ºä¸¤ä¸ªéƒ¨åˆ†ï¼šå…¶ä¸€æ˜¯å¿«é€Ÿè·¯å¾„ï¼ˆFast Pathï¼‰ï¼Œè¿™ä¸€éƒ¨åˆ†ç”±æ±‡ç¼–è¯­è¨€å®ç°ï¼›å…¶äºŒæ˜¯æ…¢é€Ÿè·¯å¾„ï¼ˆSlow Pathï¼‰ï¼Œç”± C è¯­è¨€å®ç°ã€‚å½“æœªå‘½ä¸­ç¼“å­˜æ—¶ï¼Œå°†è°ƒç”¨ C è¯­è¨€ä»£ç æ¥æŸ¥æ‰¾æ–¹æ³•åˆ—è¡¨ï¼Œå¹¶ç¼“å­˜æ–¹æ³•ã€‚</p>
<h4 id="å½“å‘½ä¸­ç¼“å­˜æ—¶">å½“å‘½ä¸­ç¼“å­˜æ—¶</h4>
<p>å½“æ–¹æ³•è¢«å†æ¬¡è°ƒç”¨æ—¶ï¼Œå°†å¯ä»¥å‘½ä¸­ç¼“å­˜å¾—ä»¥å¿«é€Ÿæ‰§è¡Œï¼š</p>
<p><img src="/img/2019/objc_msgsend/6.png" alt="6"></p>
<h4 id="support_indexed_isa">SUPPORT_INDEXED_ISA</h4>
<p><code>SUPPORT_INDEXED_ISA</code>ï¼Œå³æ˜¯å¦æ”¯æŒç´¢å¼•åŒ– isa æˆ‘ä»¬å¯ä»¥åœ¨æºç ä¸­æ‰¾åˆ°è¿™æ®µå®šä¹‰çš„å®ï¼š</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-objectivec" data-lang="objectivec"><span class="line"><span class="cl"><span class="c1">// objc-config.h
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl"><span class="c1">// Define SUPPORT_INDEXED_ISA=1 on platforms that store the class in the isa
</span></span></span><span class="line"><span class="cl"><span class="c1">// field as an index into a class table.
</span></span></span><span class="line"><span class="cl"><span class="c1">// åœ¨å°†ç±»å­˜å‚¨åœ¨ isa åŸŸä¸­å¹¶ä½œä¸ºç±»è¡¨ç´¢å¼•çš„å¹³å°ä¸Šå®šä¹‰ SUPPORT_INDEXED_ISA=1ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1">// Note, keep this in sync with any .s files which also define it.
</span></span></span><span class="line"><span class="cl"><span class="c1">// Be sure to edit objc-abi.h as well.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="cp">#if __ARM_ARCH_7K__ &gt;= 2  ||  (__arm64__ &amp;&amp; !__LP64__)
</span></span></span><span class="line"><span class="cl"><span class="cp">#   define SUPPORT_INDEXED_ISA 1
</span></span></span><span class="line"><span class="cl"><span class="cp">#else
</span></span></span><span class="line"><span class="cl"><span class="cp">#   define SUPPORT_INDEXED_ISA 0
</span></span></span><span class="line"><span class="cl"><span class="cp">#endif
</span></span></span></code></pre></div><p>æ¯”è¾ƒç®€å•çš„éªŒè¯æ–¹å¼æ˜¯æˆ‘ä»¬å¯ä»¥ç›´æ¥åœ¨æŒ‡å®šçœŸæœºè¿è¡Œçš„ä»£ç ä¸­å°è¯•è·å–æœ€ç»ˆçš„å€¼ï¼š</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-objectivec" data-lang="objectivec"><span class="line"><span class="cl"><span class="cp">#if __ARM_ARCH_7K__ &gt;= 2  ||  (__arm64__ &amp;&amp; !__LP64__)
</span></span></span><span class="line"><span class="cl"><span class="cp">#   define SUPPORT_INDEXED_ISA 1
</span></span></span><span class="line"><span class="cl"><span class="cp">#else
</span></span></span><span class="line"><span class="cl"><span class="cp">#   define SUPPORT_INDEXED_ISA 0
</span></span></span><span class="line"><span class="cl"><span class="cp">#endif
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="c1">// Use of undeclared identifier &#39;__ARM_ARCH_7K__&#39;
</span></span></span><span class="line"><span class="cl"><span class="c1">// NSLog(@&#34;%d&#34;, __ARM_ARCH_7K__);
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="n">NSLog</span><span class="p">(</span><span class="s">@&#34;%d&#34;</span><span class="p">,</span> <span class="n">__arm64__</span><span class="p">);</span>           <span class="c1">// 1
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="n">NSLog</span><span class="p">(</span><span class="s">@&#34;%d&#34;</span><span class="p">,</span> <span class="n">__LP64__</span><span class="p">);</span>            <span class="c1">// 1
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="n">NSLog</span><span class="p">(</span><span class="s">@&#34;%d&#34;</span><span class="p">,</span> <span class="n">SUPPORT_INDEXED_ISA</span><span class="p">);</span> <span class="c1">// 0
</span></span></span></code></pre></div><p>å½“ç„¶ï¼Œæˆ‘è¿˜æ˜¯è¦ç»†ç©¶ä¸€ä¸‹ã€‚</p>
<p><code>__ARM_ARCH_7K__</code> æ ¹æ®åç§°å¯ä»¥å¾—å‡ºæ˜¯å®šä¹‰åœ¨ç›®æ ‡ä¸º ARM 7k æ¶æ„ CPU çš„ä»£ç ä¸­çš„æ ‡å¿—å®ã€‚æˆ‘ä»¬å¯ä»¥åœ¨ LLVM å¼€æºçš„ã€ŒARM.cppã€æ‰¾åˆ°å…¶å®šä¹‰ï¼š</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="c1">// ARM.cpp
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl"><span class="c1">// Unfortunately, __ARM_ARCH_7K__ is now more of an ABI descriptor. The CPU
</span></span></span><span class="line"><span class="cl"><span class="c1">// happens to be Cortex-A7 though, so it should still get __ARM_ARCH_7A__.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">if</span> <span class="p">(</span><span class="n">getTriple</span><span class="p">().</span><span class="n">isWatchABI</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">  <span class="n">Builder</span><span class="p">.</span><span class="n">defineMacro</span><span class="p">(</span><span class="s">&#34;__ARM_ARCH_7K__&#34;</span><span class="p">,</span> <span class="s">&#34;2&#34;</span><span class="p">);</span>
</span></span></code></pre></div><p><code>__arm64__</code> å³å½“ç›®æ ‡ä¸º ARM 64 æ¶æ„ CPU æ—¶ä¸º <code>1</code>ï¼›<code>__LP64__</code> å³ Long Pointerï¼Œè¯¥æ ‡å¿—å®ä¸º <code>1</code> çš„ä»£ç ä¸­ <code>long int</code> å’ŒæŒ‡é’ˆç±»å‹ï¼ˆæŒ‡é’ˆä¸­å­˜å‚¨çš„æ˜¯å†…å­˜åœ°å€ï¼Œä¹Ÿå³å†…å­˜åœ°å€ï¼‰çš„é•¿åº¦ä¸º 64 ä½ï¼ˆ8 å­—èŠ‚ï¼‰ï¼Œ<code>int</code> ä¸º 32 ä½ï¼ˆ4 å­—èŠ‚ï¼‰ã€‚</p>
<p>ç»¼ä¸Šï¼Œåœ¨ iOS çš„çœŸæœºè®¾å¤‡ä¸­ï¼Œ<code>SUPPORT_INDEXED_ISA</code> çš„å€¼æœ€ç»ˆä¸º <code>0</code>ã€‚</p>
<h4 id="å°¾é€’å½’è°ƒç”¨">å°¾é€’å½’è°ƒç”¨</h4>
<p>ğŸš§</p>
<h3 id="åŠ¨æ€æ–¹æ³•è§£æ">åŠ¨æ€æ–¹æ³•è§£æ</h3>
<h4 id="what">What</h4>
<p>å½“ä¸€ä¸ªç±»æˆ–å…ƒç±»è‡ªèº«åŠå…¶æ‰€æœ‰çˆ¶ç±»ä¸­éƒ½æ²¡æœ‰ç›¸åº”çš„æ–¹æ³•å®ç°æ—¶ï¼Œå°†å°è¯•åŠ¨æ€æ–¹æ³•è§£æã€‚å³è°ƒç”¨ <code>resolveInstanceMethod:</code> æˆ– <code>resolveClassMethod</code> ç±»æ–¹æ³•ï¼ˆä¸¤è€…ä¾æ¬¡å¯¹åº”è§£æå®ä¾‹æ–¹æ³•ã€ç±»æ–¹æ³•ï¼‰ï¼Œå¦‚æœæˆ‘ä»¬åœ¨å…¶ä¸­åŠ¨æ€å°†æ–¹æ³•æ·»åŠ ï¼Œé‚£ä¹ˆå°†å¯ä»¥æ‰§è¡Œåˆ°ç›¸åº”çš„æ–¹æ³•ä¸­ï¼š</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-objectivec" data-lang="objectivec"><span class="line"><span class="cl"><span class="k">@interface</span> <span class="nc">Foo</span> : <span class="nc">NSObject</span>
</span></span><span class="line"><span class="cl"><span class="p">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">foo</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">+</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">classFoo</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">tryC</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">@end</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">@implementation</span> <span class="nc">Foo</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">bar</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">NSLog</span><span class="p">(</span><span class="s">@&#34;%s&#34;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">+</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">classBar</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">NSLog</span><span class="p">(</span><span class="s">@&#34;%s&#34;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">c_func</span><span class="p">(</span><span class="kt">id</span> <span class="nb">self</span><span class="p">,</span> <span class="kt">SEL</span> <span class="n">_cmd</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">NSLog</span><span class="p">(</span><span class="s">@&#34;%p - %@&#34;</span><span class="p">,</span> <span class="nb">self</span><span class="p">,</span> <span class="n">NSStringFromSelector</span><span class="p">(</span><span class="n">_cmd</span><span class="p">));</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">+</span> <span class="p">(</span><span class="kt">BOOL</span><span class="p">)</span><span class="nf">resolveInstanceMethod:</span><span class="p">(</span><span class="kt">SEL</span><span class="p">)</span><span class="nv">sel</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">sel</span> <span class="o">==</span> <span class="k">@selector</span><span class="p">(</span><span class="n">foo</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// é€šè¿‡ Runtime API è·å¾—ç±»å¯¹è±¡ä¸­çš„å®ä¾‹æ–¹æ³•
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">Method</span> <span class="n">method</span> <span class="o">=</span> <span class="n">class_getInstanceMethod</span><span class="p">(</span><span class="nb">self</span><span class="p">,</span> <span class="k">@selector</span><span class="p">(</span><span class="n">bar</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// åŠ¨æ€æ·»åŠ æ–¹æ³•
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">class_addMethod</span><span class="p">(</span><span class="nb">self</span><span class="p">,</span> <span class="n">sel</span><span class="p">,</span> <span class="n">method_getImplementation</span><span class="p">(</span><span class="n">method</span><span class="p">),</span> <span class="n">method_getTypeEncoding</span><span class="p">(</span><span class="n">method</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="nb">YES</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">sel</span> <span class="o">==</span> <span class="k">@selector</span><span class="p">(</span><span class="n">tryC</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// ä¹Ÿå¯ä»¥å°† C å‡½æ•°è½¬æ¢ä¸º Method æ ¼å¼ä½œä¸ºåŠ¨æ€æ–¹æ³•ï¼›
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">class_addMethod</span><span class="p">(</span><span class="nb">self</span><span class="p">,</span> <span class="n">sel</span><span class="p">,</span> <span class="p">(</span><span class="kt">IMP</span><span class="p">)</span><span class="n">c_func</span><span class="p">,</span> <span class="s">&#34;v16@0:8&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// å½“å®ç°äº†åŠ¨æ€æ–¹æ³•è§£ææ—¶ï¼Œæœ€å¥½æŒ‰è¦æ±‚è¿”å› YESï¼Œä½†ç›®å‰çœ‹è¿”å›å€¼å¹¶ä¸å½±å“ç»“æœï¼ˆè¯¦è§ä¸‹æºç ï¼‰
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">return</span> <span class="p">[</span><span class="nb">super</span> <span class="nl">resolveInstanceMethod</span><span class="p">:</span><span class="n">sel</span><span class="p">];</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">+</span> <span class="p">(</span><span class="kt">BOOL</span><span class="p">)</span><span class="nf">resolveClassMethod:</span><span class="p">(</span><span class="kt">SEL</span><span class="p">)</span><span class="nv">sel</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">sel</span> <span class="o">==</span> <span class="k">@selector</span><span class="p">(</span><span class="n">classFoo</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// é€šè¿‡ Runtime API è·å¾—å…ƒç±»å¯¹è±¡ä¸­çš„ç±»æ–¹æ³•
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">Method</span> <span class="n">method</span> <span class="o">=</span> <span class="n">class_getClassMethod</span><span class="p">(</span><span class="n">object_getClass</span><span class="p">(</span><span class="nb">self</span><span class="p">),</span> <span class="k">@selector</span><span class="p">(</span><span class="n">classBar</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// åŠ¨æ€æ·»åŠ æ–¹æ³•ï¼ˆæ³¨æ„å°†kç±»æ–¹æ³•æ·»åŠ åˆ°å…ƒç±»å¯¹è±¡ä¸­ï¼‰
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">class_addMethod</span><span class="p">(</span><span class="n">object_getClass</span><span class="p">(</span><span class="nb">self</span><span class="p">),</span> <span class="n">sel</span><span class="p">,</span> <span class="n">method_getImplementation</span><span class="p">(</span><span class="n">method</span><span class="p">),</span> <span class="n">method_getTypeEncoding</span><span class="p">(</span><span class="n">method</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="nb">YES</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="p">[</span><span class="nb">super</span> <span class="nl">resolveClassMethod</span><span class="p">:</span><span class="n">sel</span><span class="p">];</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="k">@end</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">Foo</span> <span class="o">*</span><span class="n">foo</span> <span class="o">=</span> <span class="p">[[</span><span class="n">Foo</span> <span class="n">alloc</span><span class="p">]</span> <span class="n">init</span><span class="p">];</span>
</span></span><span class="line"><span class="cl"><span class="p">[</span><span class="n">foo</span> <span class="n">foo</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">[</span><span class="n">Foo</span> <span class="n">classFoo</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// OUTPUT:
</span></span></span><span class="line"><span class="cl"><span class="c1">// -[Foo bar]
</span></span></span><span class="line"><span class="cl"><span class="c1">// +[Foo classBar]
</span></span></span><span class="line"><span class="cl"><span class="c1">// 0x2802d0a50 - tryC
</span></span></span></code></pre></div><p>è¿™é‡Œçš„ <code>Method</code> æ˜¯ä¸€ä¸ªç±»ä¼¼ <code>Class</code> çš„ä¸é€æ˜ç±»å‹ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨ objc4 æºç ä¸­çœ‹åˆ°å®ƒçš„ç»“æ„ï¼Œæœ¬è´¨å³ <code>method_t</code>ï¼š</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-objectivec" data-lang="objectivec"><span class="line"><span class="cl"><span class="c1">// runtime.h
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl"><span class="c1">/// An opaque type that represents a method in a class definition.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">typedef</span> <span class="k">struct</span> <span class="n">objc_method</span> <span class="o">*</span><span class="n">Method</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">struct</span> <span class="n">objc_method</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kt">SEL</span> <span class="n">_Nonnull</span> <span class="n">method_name</span>                                 <span class="n">OBJC2_UNAVAILABLE</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kt">char</span> <span class="o">*</span> <span class="n">_Nullable</span> <span class="n">method_types</span>                            <span class="n">OBJC2_UNAVAILABLE</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kt">IMP</span> <span class="n">_Nonnull</span> <span class="n">method_imp</span>                                  <span class="n">OBJC2_UNAVAILABLE</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// objc-private.h
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl"><span class="cp">#if __OBJC2__
</span></span></span><span class="line"><span class="cl"><span class="cp"></span><span class="k">typedef</span> <span class="k">struct</span> <span class="n">method_t</span> <span class="o">*</span><span class="n">Method</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="c1">// ...
</span></span></span></code></pre></div><p>è€Œ <code>class_addMethod</code> å°†æŠŠæ–°æ–¹æ³•æ”¾ç½®åœ¨ä¸€ä¸ªä¸€ç»´æ–¹æ³•åˆ—è¡¨ä¸­ï¼Œå¹¶æœ€ç»ˆé™„åŠ åœ¨ Obj-C ç±»ä¸­ <code>class_rw_t</code> çš„äºŒç»´ <code>method_array_t methods;</code> ä¸­ï¼ˆå› æ­¤ <code>class_addMethod</code> å¯¹äºæ¯ä¸ªæ–¹æ³•åªä¼šè°ƒç”¨ä¸€æ¬¡ï¼‰ï¼š</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="c1">// objc-runtime-new.mm
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl"><span class="n">BOOL</span>
</span></span><span class="line"><span class="cl"><span class="nf">class_addMethod</span><span class="p">(</span><span class="n">Class</span> <span class="n">cls</span><span class="p">,</span> <span class="n">SEL</span> <span class="n">name</span><span class="p">,</span> <span class="n">IMP</span> <span class="n">imp</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">types</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cls</span><span class="p">)</span> <span class="k">return</span> <span class="n">NO</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">mutex_locker_t</span> <span class="n">lock</span><span class="p">(</span><span class="n">runtimeLock</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// â¬‡ï¸
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">return</span> <span class="o">!</span> <span class="n">addMethod</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">imp</span><span class="p">,</span> <span class="n">types</span> <span class="o">?:</span> <span class="s">&#34;&#34;</span><span class="p">,</span> <span class="n">NO</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cm">/**********************************************************************
</span></span></span><span class="line"><span class="cl"><span class="cm">* addMethod
</span></span></span><span class="line"><span class="cl"><span class="cm">* fixme
</span></span></span><span class="line"><span class="cl"><span class="cm">* Locking: runtimeLock must be held by the caller
</span></span></span><span class="line"><span class="cl"><span class="cm">**********************************************************************/</span>
</span></span><span class="line"><span class="cl"><span class="k">static</span> <span class="n">IMP</span>
</span></span><span class="line"><span class="cl"><span class="nf">addMethod</span><span class="p">(</span><span class="n">Class</span> <span class="n">cls</span><span class="p">,</span> <span class="n">SEL</span> <span class="n">name</span><span class="p">,</span> <span class="n">IMP</span> <span class="n">imp</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">types</span><span class="p">,</span> <span class="kt">bool</span> <span class="n">replace</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">IMP</span> <span class="n">result</span> <span class="o">=</span> <span class="n">nil</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">runtimeLock</span><span class="p">.</span><span class="n">assertLocked</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">checkIsKnownClass</span><span class="p">(</span><span class="n">cls</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">assert</span><span class="p">(</span><span class="n">types</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">assert</span><span class="p">(</span><span class="n">cls</span><span class="o">-&gt;</span><span class="n">isRealized</span><span class="p">());</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">method_t</span> <span class="o">*</span><span class="n">m</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">((</span><span class="n">m</span> <span class="o">=</span> <span class="n">getMethodNoSuper_nolock</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">name</span><span class="p">)))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// already exists
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">replace</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">result</span> <span class="o">=</span> <span class="n">m</span><span class="o">-&gt;</span><span class="n">imp</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">result</span> <span class="o">=</span> <span class="n">_method_setImplementation</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">m</span><span class="p">,</span> <span class="n">imp</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// fixme optimize
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// åˆå§‹åŒ–æ–°çš„ method_list_t
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">method_list_t</span> <span class="o">*</span><span class="n">newlist</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">newlist</span> <span class="o">=</span> <span class="p">(</span><span class="n">method_list_t</span> <span class="o">*</span><span class="p">)</span><span class="n">calloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">newlist</span><span class="p">),</span> <span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">newlist</span><span class="o">-&gt;</span><span class="n">entsizeAndFlags</span> <span class="o">=</span>
</span></span><span class="line"><span class="cl">            <span class="p">(</span><span class="kt">uint32_t</span><span class="p">)</span><span class="k">sizeof</span><span class="p">(</span><span class="n">method_t</span><span class="p">)</span> <span class="o">|</span> <span class="n">fixed_up_method_list</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">newlist</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// å°†æ–¹æ³•æ”¾ç½®åœ¨æ–°çš„æ–¹æ³•åˆ—è¡¨ä¸­
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">newlist</span><span class="o">-&gt;</span><span class="n">first</span><span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">newlist</span><span class="o">-&gt;</span><span class="n">first</span><span class="p">.</span><span class="n">types</span> <span class="o">=</span> <span class="n">strdupIfMutable</span><span class="p">(</span><span class="n">types</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">newlist</span><span class="o">-&gt;</span><span class="n">first</span><span class="p">.</span><span class="n">imp</span> <span class="o">=</span> <span class="n">imp</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">// æ–¹æ³•åˆ—è¡¨çš„å‡†å¤‡å·¥ä½œ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">prepareMethodLists</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">newlist</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">NO</span><span class="p">,</span> <span class="n">NO</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// â¬‡ï¸ é™„åŠ æ–¹æ³•åˆ—è¡¨
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">cls</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">methods</span><span class="p">.</span><span class="n">attachLists</span><span class="p">(</span><span class="o">&amp;</span><span class="n">newlist</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">flushCaches</span><span class="p">(</span><span class="n">cls</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">result</span> <span class="o">=</span> <span class="n">nil</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">result</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">static</span> <span class="kt">void</span>
</span></span><span class="line"><span class="cl"><span class="nf">prepareMethodLists</span><span class="p">(</span><span class="n">Class</span> <span class="n">cls</span><span class="p">,</span> <span class="n">method_list_t</span> <span class="o">**</span><span class="n">addedLists</span><span class="p">,</span> <span class="kt">int</span> <span class="n">addedCount</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                   <span class="kt">bool</span> <span class="n">baseMethods</span><span class="p">,</span> <span class="kt">bool</span> <span class="n">methodsFromBundle</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">runtimeLock</span><span class="p">.</span><span class="n">assertLocked</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">addedCount</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// Don&#39;t scan redundantly
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kt">bool</span> <span class="n">scanForCustomRR</span> <span class="o">=</span> <span class="o">!</span><span class="n">cls</span><span class="o">-&gt;</span><span class="n">hasCustomRR</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="kt">bool</span> <span class="n">scanForCustomAWZ</span> <span class="o">=</span> <span class="o">!</span><span class="n">cls</span><span class="o">-&gt;</span><span class="n">hasCustomAWZ</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// There exist RR/AWZ special cases for some class&#39;s base methods.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// But this code should never need to scan base methods for RR/AWZ:
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// default RR/AWZ cannot be set before setInitialized().
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// Therefore we need not handle any special cases here.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="n">baseMethods</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">assert</span><span class="p">(</span><span class="o">!</span><span class="n">scanForCustomRR</span>  <span class="o">&amp;&amp;</span>  <span class="o">!</span><span class="n">scanForCustomAWZ</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// Add method lists to array.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// Reallocate un-fixed method lists.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// The new methods are PREPENDED to the method list array.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">addedCount</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">method_list_t</span> <span class="o">*</span><span class="n">mlist</span> <span class="o">=</span> <span class="n">addedLists</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">        <span class="n">assert</span><span class="p">(</span><span class="n">mlist</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">// Fixup selectors if necessary
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mlist</span><span class="o">-&gt;</span><span class="n">isFixedUp</span><span class="p">())</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">fixupMethodList</span><span class="p">(</span><span class="n">mlist</span><span class="p">,</span> <span class="n">methodsFromBundle</span><span class="p">,</span> <span class="nb">true</span><span class="cm">/*sort*/</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">// Scan for method implementations tracked by the class&#39;s flags
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">if</span> <span class="p">(</span><span class="n">scanForCustomRR</span>  <span class="o">&amp;&amp;</span>  <span class="n">methodListImplementsRR</span><span class="p">(</span><span class="n">mlist</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">cls</span><span class="o">-&gt;</span><span class="n">setHasCustomRR</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">            <span class="n">scanForCustomRR</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">scanForCustomAWZ</span>  <span class="o">&amp;&amp;</span>  <span class="n">methodListImplementsAWZ</span><span class="p">(</span><span class="n">mlist</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">cls</span><span class="o">-&gt;</span><span class="n">setHasCustomAWZ</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">            <span class="n">scanForCustomAWZ</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// objc-runtime-new.h
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl"><span class="k">template</span> <span class="o">&lt;</span><span class="k">typename</span> <span class="n">Element</span><span class="p">,</span> <span class="k">typename</span> <span class="n">List</span><span class="o">&gt;</span>
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">list_array_tt</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// ...
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">    <span class="kt">void</span> <span class="nf">attachLists</span><span class="p">(</span><span class="n">List</span><span class="o">*</span> <span class="k">const</span> <span class="o">*</span> <span class="n">addedLists</span><span class="p">,</span> <span class="kt">uint32_t</span> <span class="n">addedCount</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">addedCount</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">hasArray</span><span class="p">())</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="c1">// many lists -&gt; many lists
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="c1">// å·²æˆäºŒç»´ï¼Œåˆ™å…ˆåˆ†é…ç©ºé—´ï¼ŒæŒªåŠ¨åŸè¡¨ï¼Œæ”¾ç½®æ–°è¡¨
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="c1">//ï¼ˆå…³äº memmove &amp; momcpy å¯å‚è€ƒæ–‡æœ« Reference ä¸­ã€ŒiOS ä¸­çš„ Categoryã€ä¸€æ–‡ï¼‰
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="kt">uint32_t</span> <span class="n">oldCount</span> <span class="o">=</span> <span class="n">array</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">count</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="kt">uint32_t</span> <span class="n">newCount</span> <span class="o">=</span> <span class="n">oldCount</span> <span class="o">+</span> <span class="n">addedCount</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="n">setArray</span><span class="p">((</span><span class="n">array_t</span> <span class="o">*</span><span class="p">)</span><span class="n">realloc</span><span class="p">(</span><span class="n">array</span><span class="p">(),</span> <span class="n">array_t</span><span class="o">::</span><span class="n">byteSize</span><span class="p">(</span><span class="n">newCount</span><span class="p">)));</span>
</span></span><span class="line"><span class="cl">            <span class="n">array</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">=</span> <span class="n">newCount</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="n">memmove</span><span class="p">(</span><span class="n">array</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">lists</span> <span class="o">+</span> <span class="n">addedCount</span><span class="p">,</span> <span class="n">array</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">lists</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                    <span class="n">oldCount</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">array</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">lists</span><span class="p">[</span><span class="mi">0</span><span class="p">]));</span>
</span></span><span class="line"><span class="cl">            <span class="n">memcpy</span><span class="p">(</span><span class="n">array</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">lists</span><span class="p">,</span> <span class="n">addedLists</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                   <span class="n">addedCount</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">array</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">lists</span><span class="p">[</span><span class="mi">0</span><span class="p">]));</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">list</span>  <span class="o">&amp;&amp;</span>  <span class="n">addedCount</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="c1">// 0 lists -&gt; 1 list
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="c1">// ç©ºè¡¨åˆ™ç›´æ¥é™„åŠ 
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="n">list</span> <span class="o">=</span> <span class="n">addedLists</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="c1">// 1 list -&gt; many lists
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="c1">// ä¸€ç»´å•è¡¨é™„åŠ è‡³äºŒç»´
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="n">List</span><span class="o">*</span> <span class="n">oldList</span> <span class="o">=</span> <span class="n">list</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="kt">uint32_t</span> <span class="n">oldCount</span> <span class="o">=</span> <span class="n">oldList</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="kt">uint32_t</span> <span class="n">newCount</span> <span class="o">=</span> <span class="n">oldCount</span> <span class="o">+</span> <span class="n">addedCount</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="n">setArray</span><span class="p">((</span><span class="n">array_t</span> <span class="o">*</span><span class="p">)</span><span class="n">malloc</span><span class="p">(</span><span class="n">array_t</span><span class="o">::</span><span class="n">byteSize</span><span class="p">(</span><span class="n">newCount</span><span class="p">)));</span>
</span></span><span class="line"><span class="cl">            <span class="n">array</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">=</span> <span class="n">newCount</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="p">(</span><span class="n">oldList</span><span class="p">)</span> <span class="n">array</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">lists</span><span class="p">[</span><span class="n">addedCount</span><span class="p">]</span> <span class="o">=</span> <span class="n">oldList</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="n">memcpy</span><span class="p">(</span><span class="n">array</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">lists</span><span class="p">,</span> <span class="n">addedLists</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                   <span class="n">addedCount</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">array</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">lists</span><span class="p">[</span><span class="mi">0</span><span class="p">]));</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// ...
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">};</span>
</span></span></code></pre></div><h4 id="how">How</h4>
<p>æ­£å¦‚ä¸Šæ‰€è¿°ï¼Œåœ¨ä¸Šé¢æœªå‘½ä¸­ç¼“å­˜ä¸”æœ¬ç±»åŠæ‰€æœ‰çˆ¶ç±»ä¸­éƒ½æ— æ³•æ‰¾åˆ°è¦è°ƒç”¨çš„æ–¹æ³•æ—¶ï¼Œå°†è¿›å…¥ <code>lookUpImpOrForward</code> ä¸­çš„ Method Resovle å³ã€ŒåŠ¨æ€æ–¹æ³•è§£æã€ï¼š</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="c1">// objc-runtime-new.mm
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl"><span class="n">IMP</span> <span class="nf">lookUpImpOrForward</span><span class="p">(</span><span class="n">Class</span> <span class="n">cls</span><span class="p">,</span> <span class="n">SEL</span> <span class="n">sel</span><span class="p">,</span> <span class="n">id</span> <span class="n">inst</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                       <span class="kt">bool</span> <span class="n">initialize</span><span class="p">,</span> <span class="kt">bool</span> <span class="n">cache</span><span class="p">,</span> <span class="kt">bool</span> <span class="n">resolver</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// ...
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">    <span class="c1">// No implementation found. Try method resolver once.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// IMP æ‰¾ä¸åˆ°ï¼Œåˆ™è¿›å…¥æ–¹æ³•åŠ¨æ€è§£æä¸€æ¬¡ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="n">resolver</span>  <span class="o">&amp;&amp;</span>  <span class="o">!</span><span class="n">triedResolver</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">runtimeLock</span><span class="p">.</span><span class="n">unlock</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// â¬‡ï¸ å°è¯•æ–¹æ³•è§£æ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">_class_resolveMethod</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">sel</span><span class="p">,</span> <span class="n">inst</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">runtimeLock</span><span class="p">.</span><span class="n">lock</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// Don&#39;t cache the result; we don&#39;t hold the lock so it may have
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// changed already. Re-do the search from scratch instead.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// æ ‡è®°ä¸º YES
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">triedResolver</span> <span class="o">=</span> <span class="n">YES</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// æ·»åŠ åˆ°æ–¹æ³•åˆ—è¡¨åï¼Œè¿›è€Œè¿›å…¥å†æ¬¡å°è¯•ä»æ–¹æ³•åˆ—è¡¨ä¸­è·å–å¹¶å­˜å…¥ç¼“å­˜
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">goto</span> <span class="n">retry</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// ...
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cm">/***********************************************************************
</span></span></span><span class="line"><span class="cl"><span class="cm">* _class_resolveMethod
</span></span></span><span class="line"><span class="cl"><span class="cm">* Call +resolveClassMethod or +resolveInstanceMethod.
</span></span></span><span class="line"><span class="cl"><span class="cm">* Returns nothing; any result would be potentially out-of-date already.
</span></span></span><span class="line"><span class="cl"><span class="cm">* Does not check if the method already exists.
</span></span></span><span class="line"><span class="cl"><span class="cm">**********************************************************************/</span>
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">_class_resolveMethod</span><span class="p">(</span><span class="n">Class</span> <span class="n">cls</span><span class="p">,</span> <span class="n">SEL</span> <span class="n">sel</span><span class="p">,</span> <span class="n">id</span> <span class="n">inst</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="o">!</span> <span class="n">cls</span><span class="o">-&gt;</span><span class="n">isMetaClass</span><span class="p">())</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// éå…ƒç±»å¯¹è±¡ï¼Œåˆ™è§£æç±»å¯¹è±¡
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// try [cls resolveInstanceMethod:sel]
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">_class_resolveInstanceMethod</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">sel</span><span class="p">,</span> <span class="n">inst</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// è§£æå…ƒç±»å¯¹è±¡
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// try [nonMetaClass resolveClassMethod:sel]
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// and [cls resolveInstanceMethod:sel]
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">_class_resolveClassMethod</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">sel</span><span class="p">,</span> <span class="n">inst</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">lookUpImpOrNil</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">sel</span><span class="p">,</span> <span class="n">inst</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                            <span class="n">NO</span><span class="cm">/*initialize*/</span><span class="p">,</span> <span class="n">YES</span><span class="cm">/*cache*/</span><span class="p">,</span> <span class="n">NO</span><span class="cm">/*resolver*/</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">_class_resolveInstanceMethod</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">sel</span><span class="p">,</span> <span class="n">inst</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cm">/***********************************************************************
</span></span></span><span class="line"><span class="cl"><span class="cm">* _class_resolveInstanceMethod
</span></span></span><span class="line"><span class="cl"><span class="cm">* Call +resolveInstanceMethod, looking for a method to be added to class cls.
</span></span></span><span class="line"><span class="cl"><span class="cm">* è°ƒç”¨ +resolveInstanceMethodï¼Œå¹¶æŸ¥æ‰¾è¦æ·»åŠ åˆ° cls ç±»çš„æ–¹æ³•ã€‚
</span></span></span><span class="line"><span class="cl"><span class="cm">* cls may be a metaclass or a non-meta class.
</span></span></span><span class="line"><span class="cl"><span class="cm">* cls å¯èƒ½æ˜¯å…ƒç±»æˆ–éå…ƒç±»ã€‚
</span></span></span><span class="line"><span class="cl"><span class="cm">* Does not check if the method already exists.
</span></span></span><span class="line"><span class="cl"><span class="cm">* å¦‚æœæ–¹æ³•å·²ç»å­˜åœ¨åˆ™ä¸æ£€æŸ¥ã€‚
</span></span></span><span class="line"><span class="cl"><span class="cm">**********************************************************************/</span>
</span></span><span class="line"><span class="cl"><span class="k">static</span> <span class="kt">void</span> <span class="nf">_class_resolveInstanceMethod</span><span class="p">(</span><span class="n">Class</span> <span class="n">cls</span><span class="p">,</span> <span class="n">SEL</span> <span class="n">sel</span><span class="p">,</span> <span class="n">id</span> <span class="n">inst</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// å¦‚æœæœªå®ç° resolveInstanceMethod åˆ™è¿”å›
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="o">!</span> <span class="n">lookUpImpOrNil</span><span class="p">(</span><span class="n">cls</span><span class="o">-&gt;</span><span class="n">ISA</span><span class="p">(),</span> <span class="n">SEL_resolveInstanceMethod</span><span class="p">,</span> <span class="n">cls</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                         <span class="n">NO</span><span class="cm">/*initialize*/</span><span class="p">,</span> <span class="n">YES</span><span class="cm">/*cache*/</span><span class="p">,</span> <span class="n">NO</span><span class="cm">/*resolver*/</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// Resolver not implemented.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">return</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">BOOL</span> <span class="p">(</span><span class="o">*</span><span class="n">msg</span><span class="p">)(</span><span class="n">Class</span><span class="p">,</span> <span class="n">SEL</span><span class="p">,</span> <span class="n">SEL</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="n">typeof</span><span class="p">(</span><span class="n">msg</span><span class="p">))</span><span class="n">objc_msgSend</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// ä½¿ç”¨ objc_msgSend æ‰§è¡Œ resolveInstanceMethodï¼Œå°†è¿”å›å€¼ä¿å­˜ä¸º resolved
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kt">bool</span> <span class="n">resolved</span> <span class="o">=</span> <span class="n">msg</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">SEL_resolveInstanceMethod</span><span class="p">,</span> <span class="n">sel</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// æ ¹æ® resolved åšä¸€äº›æ—¥å¿—ç­‰å¤„ç†
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// Cache the result (good or bad) so the resolver doesn&#39;t fire next time.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// +resolveInstanceMethod adds to self a.k.a. cls
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">IMP</span> <span class="n">imp</span> <span class="o">=</span> <span class="n">lookUpImpOrNil</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">sel</span><span class="p">,</span> <span class="n">inst</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                             <span class="n">NO</span><span class="cm">/*initialize*/</span><span class="p">,</span> <span class="n">YES</span><span class="cm">/*cache*/</span><span class="p">,</span> <span class="n">NO</span><span class="cm">/*resolver*/</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">resolved</span>  <span class="o">&amp;&amp;</span>  <span class="n">PrintResolving</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">imp</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">_objc_inform</span><span class="p">(</span><span class="s">&#34;RESOLVE: method %c[%s %s] &#34;</span>
</span></span><span class="line"><span class="cl">                         <span class="s">&#34;dynamically resolved to %p&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                         <span class="n">cls</span><span class="o">-&gt;</span><span class="n">isMetaClass</span><span class="p">()</span> <span class="o">?</span> <span class="sc">&#39;+&#39;</span> <span class="o">:</span> <span class="sc">&#39;-&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                         <span class="n">cls</span><span class="o">-&gt;</span><span class="n">nameForLogging</span><span class="p">(),</span> <span class="n">sel_getName</span><span class="p">(</span><span class="n">sel</span><span class="p">),</span> <span class="n">imp</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="c1">// Method resolver didn&#39;t add anything?
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="n">_objc_inform</span><span class="p">(</span><span class="s">&#34;RESOLVE: +[%s resolveInstanceMethod:%s] returned YES&#34;</span>
</span></span><span class="line"><span class="cl">                         <span class="s">&#34;, but no new implementation of %c[%s %s] was found&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                         <span class="n">cls</span><span class="o">-&gt;</span><span class="n">nameForLogging</span><span class="p">(),</span> <span class="n">sel_getName</span><span class="p">(</span><span class="n">sel</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">                         <span class="n">cls</span><span class="o">-&gt;</span><span class="n">isMetaClass</span><span class="p">()</span> <span class="o">?</span> <span class="sc">&#39;+&#39;</span> <span class="o">:</span> <span class="sc">&#39;-&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                         <span class="n">cls</span><span class="o">-&gt;</span><span class="n">nameForLogging</span><span class="p">(),</span> <span class="n">sel_getName</span><span class="p">(</span><span class="n">sel</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cm">/***********************************************************************
</span></span></span><span class="line"><span class="cl"><span class="cm">* _class_resolveClassMethod
</span></span></span><span class="line"><span class="cl"><span class="cm">* Call +resolveClassMethod, looking for a method to be added to class cls.
</span></span></span><span class="line"><span class="cl"><span class="cm">* è°ƒç”¨ +resolveClassMethodï¼Œå¹¶æŸ¥æ‰¾è¦æ·»åŠ åˆ° cls ç±»çš„æ–¹æ³•ã€‚
</span></span></span><span class="line"><span class="cl"><span class="cm">* cls should be a metaclass.
</span></span></span><span class="line"><span class="cl"><span class="cm">* cls åº”å½“æ˜¯å…ƒç±»ã€‚
</span></span></span><span class="line"><span class="cl"><span class="cm">* Does not check if the method already exists.
</span></span></span><span class="line"><span class="cl"><span class="cm">* å¦‚æœæ–¹æ³•å·²ç»å­˜åœ¨åˆ™ä¸æ£€æŸ¥ã€‚
</span></span></span><span class="line"><span class="cl"><span class="cm">**********************************************************************/</span>
</span></span><span class="line"><span class="cl"><span class="k">static</span> <span class="kt">void</span> <span class="nf">_class_resolveClassMethod</span><span class="p">(</span><span class="n">Class</span> <span class="n">cls</span><span class="p">,</span> <span class="n">SEL</span> <span class="n">sel</span><span class="p">,</span> <span class="n">id</span> <span class="n">inst</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">assert</span><span class="p">(</span><span class="n">cls</span><span class="o">-&gt;</span><span class="n">isMetaClass</span><span class="p">());</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="o">!</span> <span class="n">lookUpImpOrNil</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">SEL_resolveClassMethod</span><span class="p">,</span> <span class="n">inst</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                         <span class="n">NO</span><span class="cm">/*initialize*/</span><span class="p">,</span> <span class="n">YES</span><span class="cm">/*cache*/</span><span class="p">,</span> <span class="n">NO</span><span class="cm">/*resolver*/</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// Resolver not implemented.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">return</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">BOOL</span> <span class="p">(</span><span class="o">*</span><span class="n">msg</span><span class="p">)(</span><span class="n">Class</span><span class="p">,</span> <span class="n">SEL</span><span class="p">,</span> <span class="n">SEL</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="n">typeof</span><span class="p">(</span><span class="n">msg</span><span class="p">))</span><span class="n">objc_msgSend</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kt">bool</span> <span class="n">resolved</span> <span class="o">=</span> <span class="n">msg</span><span class="p">(</span><span class="n">_class_getNonMetaClass</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">inst</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">                        <span class="n">SEL_resolveClassMethod</span><span class="p">,</span> <span class="n">sel</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// Cache the result (good or bad) so the resolver doesn&#39;t fire next time.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// +resolveClassMethod adds to self-&gt;ISA() a.k.a. cls
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">IMP</span> <span class="n">imp</span> <span class="o">=</span> <span class="n">lookUpImpOrNil</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">sel</span><span class="p">,</span> <span class="n">inst</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                             <span class="n">NO</span><span class="cm">/*initialize*/</span><span class="p">,</span> <span class="n">YES</span><span class="cm">/*cache*/</span><span class="p">,</span> <span class="n">NO</span><span class="cm">/*resolver*/</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">resolved</span>  <span class="o">&amp;&amp;</span>  <span class="n">PrintResolving</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">imp</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">_objc_inform</span><span class="p">(</span><span class="s">&#34;RESOLVE: method %c[%s %s] &#34;</span>
</span></span><span class="line"><span class="cl">                         <span class="s">&#34;dynamically resolved to %p&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                         <span class="n">cls</span><span class="o">-&gt;</span><span class="n">isMetaClass</span><span class="p">()</span> <span class="o">?</span> <span class="sc">&#39;+&#39;</span> <span class="o">:</span> <span class="sc">&#39;-&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                         <span class="n">cls</span><span class="o">-&gt;</span><span class="n">nameForLogging</span><span class="p">(),</span> <span class="n">sel_getName</span><span class="p">(</span><span class="n">sel</span><span class="p">),</span> <span class="n">imp</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="c1">// Method resolver didn&#39;t add anything?
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="n">_objc_inform</span><span class="p">(</span><span class="s">&#34;RESOLVE: +[%s resolveClassMethod:%s] returned YES&#34;</span>
</span></span><span class="line"><span class="cl">                         <span class="s">&#34;, but no new implementation of %c[%s %s] was found&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                         <span class="n">cls</span><span class="o">-&gt;</span><span class="n">nameForLogging</span><span class="p">(),</span> <span class="n">sel_getName</span><span class="p">(</span><span class="n">sel</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">                         <span class="n">cls</span><span class="o">-&gt;</span><span class="n">isMetaClass</span><span class="p">()</span> <span class="o">?</span> <span class="sc">&#39;+&#39;</span> <span class="o">:</span> <span class="sc">&#39;-&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                         <span class="n">cls</span><span class="o">-&gt;</span><span class="n">nameForLogging</span><span class="p">(),</span> <span class="n">sel_getName</span><span class="p">(</span><span class="n">sel</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cm">/***********************************************************************
</span></span></span><span class="line"><span class="cl"><span class="cm">* lookUpImpOrNil.
</span></span></span><span class="line"><span class="cl"><span class="cm">* Like lookUpImpOrForward, but returns nil instead of _objc_msgForward_impcache
</span></span></span><span class="line"><span class="cl"><span class="cm">* ç±»ä¼¼ lookUpImpOrForwardï¼Œä½†è¿”å› nil è€Œé _objc_msgForward_impcache
</span></span></span><span class="line"><span class="cl"><span class="cm">**********************************************************************/</span>
</span></span><span class="line"><span class="cl"><span class="n">IMP</span> <span class="nf">lookUpImpOrNil</span><span class="p">(</span><span class="n">Class</span> <span class="n">cls</span><span class="p">,</span> <span class="n">SEL</span> <span class="n">sel</span><span class="p">,</span> <span class="n">id</span> <span class="n">inst</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                   <span class="kt">bool</span> <span class="n">initialize</span><span class="p">,</span> <span class="kt">bool</span> <span class="n">cache</span><span class="p">,</span> <span class="kt">bool</span> <span class="n">resolver</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">IMP</span> <span class="n">imp</span> <span class="o">=</span> <span class="n">lookUpImpOrForward</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">sel</span><span class="p">,</span> <span class="n">inst</span><span class="p">,</span> <span class="n">initialize</span><span class="p">,</span> <span class="n">cache</span><span class="p">,</span> <span class="n">resolver</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// è‹¥æ‰¾ä¸åˆ°è¯¥æ–¹æ³•ï¼ˆè¿”å›äº†æ¶ˆæ¯è½¬å‘ï¼‰ï¼Œåˆ™è¿”å› nil
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="n">imp</span> <span class="o">==</span> <span class="n">_objc_msgForward_impcache</span><span class="p">)</span> <span class="k">return</span> <span class="n">nil</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">else</span> <span class="k">return</span> <span class="n">imp</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><h3 id="æ¶ˆæ¯è½¬å‘">æ¶ˆæ¯è½¬å‘</h3>
<h4 id="what-1">What</h4>
<p>å½“åŠ¨æ€æ–¹æ³•è§£æä¹Ÿæ— èƒ½ä¸ºåŠ›æ—¶ï¼Œå°†æœ€ç»ˆå°è¯•æ¶ˆæ¯è½¬å‘ã€‚å³ <code>- (id)forwardingTargetForSelector:(SEL)aSelector</code> å®ä¾‹æ–¹æ³•æˆ– <code>+ (id)forwardingTargetForSelector:(SEL)aSelector</code> ç±»æ–¹æ³•ï¼Œå¦‚æœæˆ‘ä»¬å°†éœ€è¦è½¬å‘åˆ°çš„ç›®æ ‡è¿”å›ï¼Œé‚£ä¹ˆç›®æ ‡å°±å¯ä»¥æ‰§è¡Œåˆ°è½¬å‘çš„ç›¸åŒæ–¹æ³•ï¼š</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-objectivec" data-lang="objectivec"><span class="line"><span class="cl"><span class="k">@interface</span> <span class="nc">FooBackup</span> : <span class="nc">NSObject</span>
</span></span><span class="line"><span class="cl"><span class="k">@end</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">@implementation</span> <span class="nc">FooBackup</span>
</span></span><span class="line"><span class="cl"><span class="p">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">foo</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">NSLog</span><span class="p">(</span><span class="s">@&#34;%s&#34;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">+</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">foo</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">NSLog</span><span class="p">(</span><span class="s">@&#34;%s&#34;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">+</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">classFoo</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">NSLog</span><span class="p">(</span><span class="s">@&#34;%s&#34;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">classFoo</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">NSLog</span><span class="p">(</span><span class="s">@&#34;%s&#34;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="k">@end</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">@interface</span> <span class="nc">Foo</span> : <span class="nc">NSObject</span>
</span></span><span class="line"><span class="cl"><span class="p">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">foo</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">+</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">classFoo</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">@end</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">@implementation</span> <span class="nc">Foo</span>
</span></span><span class="line"><span class="cl"><span class="p">-</span> <span class="p">(</span><span class="kt">id</span><span class="p">)</span><span class="nf">forwardingTargetForSelector:</span><span class="p">(</span><span class="kt">SEL</span><span class="p">)</span><span class="nv">aSelector</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">aSelector</span> <span class="o">==</span> <span class="k">@selector</span><span class="p">(</span><span class="n">foo</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// å®ä¾‹æ–¹æ³•ä¹Ÿå¯ä»¥è½¬å‘ç»™ç±»å¯¹è±¡
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// return [FooBackup class];
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">return</span> <span class="p">[[</span><span class="n">FooBackup</span> <span class="n">alloc</span><span class="p">]</span> <span class="n">init</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="p">[</span><span class="nb">super</span> <span class="nl">forwardingTargetForSelector</span><span class="p">:</span><span class="n">aSelector</span><span class="p">];</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">+</span> <span class="p">(</span><span class="kt">id</span><span class="p">)</span><span class="nf">forwardingTargetForSelector:</span><span class="p">(</span><span class="kt">SEL</span><span class="p">)</span><span class="nv">aSelector</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">aSelector</span> <span class="o">==</span> <span class="k">@selector</span><span class="p">(</span><span class="n">classFoo</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// return [[FooBackup alloc] init];
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">return</span> <span class="p">[</span><span class="n">FooBackup</span> <span class="k">class</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="p">[</span><span class="nb">super</span> <span class="nl">forwardingTargetForSelector</span><span class="p">:</span><span class="n">aSelector</span><span class="p">];</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="k">@end</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">Foo</span> <span class="o">*</span><span class="n">foo</span> <span class="o">=</span> <span class="p">[[</span><span class="n">Foo</span> <span class="n">alloc</span><span class="p">]</span> <span class="n">init</span><span class="p">];</span>
</span></span><span class="line"><span class="cl"><span class="p">[</span><span class="n">foo</span> <span class="n">foo</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">[</span><span class="n">Foo</span> <span class="n">classFoo</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// OUTPUT:
</span></span></span><span class="line"><span class="cl"><span class="c1">// -[FooBackup foo]
</span></span></span><span class="line"><span class="cl"><span class="c1">// +[FooBackup classFoo]
</span></span></span></code></pre></div><p>æ­£å¦‚ã€ŠEffective Objective-C 2.0ã€‹ä¸€ä¹¦ä¸­æ‰€æåˆ°çš„ï¼Œé€šè¿‡è¿™ç§æ–¹å¼æˆ‘ä»¬å¯ä»¥æ¨¡æ‹Ÿå‡ºå¤šé‡ç»§æ‰¿ï¼ˆMultiple Inheritanceï¼‰ï¼Œå³åœ¨ä¸€ä¸ªå¯¹è±¡å†…éƒ¨ä½¿ç”¨ä¸€ç³»åˆ—å…¶å®ƒå¯¹è±¡æ¥å¤„ç†ç›¸åº”çš„æ¶ˆæ¯ã€‚å¦å¤–éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œåœ¨è¿™ä¸€æ­¥éª¤æˆ‘ä»¬æ— æ³•å¯¹æ¶ˆæ¯æœ¬èº«è¿›è¡Œæ›´æ”¹ï¼Œæˆ‘ä»¬åªèƒ½è¿”å›å¤„ç†æ¶ˆæ¯çš„å¯¹è±¡ã€‚</p>
<p>å¦‚æœ <code>forwardingTargetForSelector:</code> ä¹Ÿæ²¡æœ‰è½¬å‘åˆ°ç›®æ ‡ï¼Œæ¶ˆæ¯å°†å°è¯•ä» <code>- (NSMethodSignature *)methodSignatureForSelector:(SEL)aSelector</code>/<code>+ (NSMethodSignature *)methodSignatureForSelector:(SEL)aSelector</code> è·å–æ–¹æ³•ç­¾åï¼Œæ–¹æ³•ç­¾åå¯ä»¥æ ¹æ®æ–¹æ³•çš„ç±»å‹ç¼–ç è·å¾—ï¼›æ¥ä¸‹æ¥å°†å¯ä»¥é€šè¿‡ <code>- (void)forwardInvocation:(NSInvocation *)anInvocation</code>/<code>+ (void)forwardInvocation:(NSInvocation *)anInvocation</code> æ‰§è¡Œï¼ŒåŸæ¥çš„æ¶ˆæ¯å°†è¢«å°è£…åœ¨ <code>NSInvocation</code> ä¸­ï¼š</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-objectivec" data-lang="objectivec"><span class="line"><span class="cl"><span class="k">@interface</span> <span class="nc">FooBackup</span> : <span class="nc">NSObject</span>
</span></span><span class="line"><span class="cl"><span class="k">@end</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">@implementation</span> <span class="nc">FooBackup</span>
</span></span><span class="line"><span class="cl"><span class="p">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">foo</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">NSLog</span><span class="p">(</span><span class="s">@&#34;%s&#34;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">+</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">classFoo</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">NSLog</span><span class="p">(</span><span class="s">@&#34;%s&#34;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="k">@end</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">@interface</span> <span class="nc">Foo</span> : <span class="nc">NSObject</span>
</span></span><span class="line"><span class="cl"><span class="p">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">foo</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">+</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">classFoo</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">@end</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">@implementation</span> <span class="nc">Foo</span>
</span></span><span class="line"><span class="cl"><span class="p">-</span> <span class="p">(</span><span class="n">NSMethodSignature</span> <span class="o">*</span><span class="p">)</span><span class="nf">methodSignatureForSelector:</span><span class="p">(</span><span class="kt">SEL</span><span class="p">)</span><span class="nv">aSelector</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">aSelector</span> <span class="o">==</span> <span class="k">@selector</span><span class="p">(</span><span class="n">foo</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// return [NSMethodSignature signatureWithObjCTypes:&#34;v@:&#34;];
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">return</span> <span class="p">[</span><span class="n">NSMethodSignature</span> <span class="nl">signatureWithObjCTypes</span><span class="p">:</span><span class="s">&#34;v16@0:8&#34;</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="p">[</span><span class="nb">super</span> <span class="nl">methodSignatureForSelector</span><span class="p">:</span><span class="n">aSelector</span><span class="p">];</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">forwardInvocation:</span><span class="p">(</span><span class="n">NSInvocation</span> <span class="o">*</span><span class="p">)</span><span class="nv">anInvocation</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">anInvocation</span><span class="p">.</span><span class="n">selector</span> <span class="o">==</span> <span class="k">@selector</span><span class="p">(</span><span class="n">foo</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="p">[</span><span class="n">anInvocation</span> <span class="nl">invokeWithTarget</span><span class="p">:[[</span><span class="n">FooBackup</span> <span class="n">alloc</span><span class="p">]</span> <span class="n">init</span><span class="p">]];</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">+</span> <span class="p">(</span><span class="n">NSMethodSignature</span> <span class="o">*</span><span class="p">)</span><span class="nf">methodSignatureForSelector:</span><span class="p">(</span><span class="kt">SEL</span><span class="p">)</span><span class="nv">aSelector</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">aSelector</span> <span class="o">==</span> <span class="k">@selector</span><span class="p">(</span><span class="n">classFoo</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// return [NSMethodSignature signatureWithObjCTypes:&#34;v@:&#34;];
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">return</span> <span class="p">[</span><span class="n">NSMethodSignature</span> <span class="nl">signatureWithObjCTypes</span><span class="p">:</span><span class="s">&#34;v16@0:8&#34;</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="p">[</span><span class="nb">super</span> <span class="nl">methodSignatureForSelector</span><span class="p">:</span><span class="n">aSelector</span><span class="p">];</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">+</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">forwardInvocation:</span><span class="p">(</span><span class="n">NSInvocation</span> <span class="o">*</span><span class="p">)</span><span class="nv">anInvocation</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">anInvocation</span><span class="p">.</span><span class="n">selector</span> <span class="o">==</span> <span class="k">@selector</span><span class="p">(</span><span class="n">classFoo</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="p">[</span><span class="n">anInvocation</span> <span class="nl">invokeWithTarget</span><span class="p">:[</span><span class="n">FooBackup</span> <span class="k">class</span><span class="p">]];</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="k">@end</span>
</span></span></code></pre></div><h4 id="how-1">How</h4>
<p>æ­£å¦‚ä¸Šæ‰€è¿°ï¼Œå½“åŠ¨æ€æ–¹æ³•è§£æä¹Ÿæ— æ³•å¥æ•ˆæˆ–è€…æˆ‘ä»¬åœ¨åŠ¨æ€æ–¹æ³•è§£æä¸­å¹¶æ²¡æœ‰æ·»åŠ äº†æ­£ç¡®çš„æ–¹æ³•æ—¶ï¼Œå°†è¿›å…¥ <code>lookUpImpOrForward</code> ä¸­çš„ Method Forward å³ã€Œæ¶ˆæ¯è½¬å‘ã€ï¼š</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="n">IMP</span> <span class="nf">lookUpImpOrForward</span><span class="p">(</span><span class="n">Class</span> <span class="n">cls</span><span class="p">,</span> <span class="n">SEL</span> <span class="n">sel</span><span class="p">,</span> <span class="n">id</span> <span class="n">inst</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                       <span class="kt">bool</span> <span class="n">initialize</span><span class="p">,</span> <span class="kt">bool</span> <span class="n">cache</span><span class="p">,</span> <span class="kt">bool</span> <span class="n">resolver</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// ...
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">    <span class="c1">// No implementation found, and method resolver didn&#39;t help.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// Use forwarding.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// å®ç°æ— æ³•æ‰¾åˆ°ï¼Œæ–¹æ³•è§£ææ— æ•ˆï¼Œå°è¯•æ–¹æ³•è½¬å‘ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">    <span class="n">imp</span> <span class="o">=</span> <span class="p">(</span><span class="n">IMP</span><span class="p">)</span><span class="n">_objc_msgForward_impcache</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">cache_fill</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">sel</span><span class="p">,</span> <span class="n">imp</span><span class="p">,</span> <span class="n">inst</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// ...
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span>
</span></span></code></pre></div><p><code>_objc_msgForward_impcache</code> åˆ™åˆæ˜¯åœ¨æ±‡ç¼–ä¸­ï¼š</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-asm" data-lang="asm"><span class="line"><span class="cl"><span class="err">//</span> <span class="nf">objc-msg-arm.s</span>
</span></span><span class="line"><span class="cl"><span class="err">/********************************************************************</span>
</span></span><span class="line"><span class="cl"><span class="err">*</span>
</span></span><span class="line"><span class="cl"><span class="err">*</span> <span class="nf">id</span> <span class="no">_objc_msgForward</span><span class="p">(</span><span class="no">id</span> <span class="no">self</span><span class="p">,</span> <span class="no">SEL</span> <span class="no">_cmd</span><span class="p">,...)</span><span class="c">;
</span></span></span><span class="line"><span class="cl"><span class="c"></span><span class="p">*</span>
</span></span><span class="line"><span class="cl"><span class="err">*</span> <span class="nf">_objc_msgForward</span> <span class="no">is</span> <span class="no">the</span> <span class="no">externally-callable</span>
</span></span><span class="line"><span class="cl"><span class="err">*</span>   <span class="nf">function</span> <span class="no">returned</span> <span class="no">by</span> <span class="no">things</span> <span class="no">like</span> <span class="no">method_getImplementation</span><span class="p">().</span>
</span></span><span class="line"><span class="cl"><span class="err">*</span> <span class="nf">_objc_msgForward_impcache</span> <span class="no">is</span> <span class="no">the</span> <span class="no">function</span> <span class="no">pointer</span> <span class="no">actually</span> <span class="no">stored</span> <span class="no">in</span>
</span></span><span class="line"><span class="cl"><span class="err">*</span>   <span class="nf">method</span> <span class="no">caches.</span>
</span></span><span class="line"><span class="cl"><span class="err">*</span>
</span></span><span class="line"><span class="cl"><span class="err">********************************************************************/</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="nf">STATIC_ENTRY</span> <span class="no">__objc_msgForward_impcache</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="err">//</span> <span class="nf">No</span> <span class="no">stret</span> <span class="no">specialization.</span>
</span></span><span class="line"><span class="cl">	<span class="nf">b</span>	<span class="no">__objc_msgForward</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="nf">END_ENTRY</span> <span class="no">__objc_msgForward_impcache</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="nf">ENTRY</span> <span class="no">__objc_msgForward</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="nf">adrp</span>	<span class="no">x17</span><span class="p">,</span> <span class="no">__objc_forward_handler@PAGE</span>
</span></span><span class="line"><span class="cl">	<span class="nf">ldr</span>	<span class="no">p17</span><span class="p">,</span> <span class="p">[</span><span class="no">x17</span><span class="p">,</span> <span class="no">__objc_forward_handler@PAGEOFF</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">	<span class="nf">TailCallFunctionPointer</span> <span class="no">x17</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="nf">END_ENTRY</span> <span class="no">__objc_msgForward</span>
</span></span></code></pre></div><p>æœ€ç»ˆä¼šå‘ç° objc4 ä¸­å¹¶æ²¡æœ‰å¼€æºçš„ <code>objc_msgForward</code> å®ç°ï¼š</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="c1">// objc-runtime.mm
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl"><span class="c1">// Default forward handler halts the process.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="n">__attribute__</span><span class="p">((</span><span class="n">noreturn</span><span class="p">))</span> <span class="kt">void</span>
</span></span><span class="line"><span class="cl"><span class="n">objc_defaultForwardHandler</span><span class="p">(</span><span class="n">id</span> <span class="n">self</span><span class="p">,</span> <span class="n">SEL</span> <span class="n">sel</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">_objc_fatal</span><span class="p">(</span><span class="s">&#34;%c[%s %s]: unrecognized selector sent to instance %p &#34;</span>
</span></span><span class="line"><span class="cl">                <span class="s">&#34;(no message forward handler is installed)&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="n">class_isMetaClass</span><span class="p">(</span><span class="n">object_getClass</span><span class="p">(</span><span class="n">self</span><span class="p">))</span> <span class="o">?</span> <span class="sc">&#39;+&#39;</span> <span class="o">:</span> <span class="sc">&#39;-&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="n">object_getClassName</span><span class="p">(</span><span class="n">self</span><span class="p">),</span> <span class="n">sel_getName</span><span class="p">(</span><span class="n">sel</span><span class="p">),</span> <span class="n">self</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="o">*</span><span class="n">_objc_forward_handler</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span><span class="o">*</span><span class="p">)</span><span class="n">objc_defaultForwardHandler</span><span class="p">;</span>
</span></span></code></pre></div><hr>
<p>ç»¼ä¸Šï¼Œä¸€ä¸ª Obj-C æ–¹æ³•è°ƒç”¨çš„è¿‡ç¨‹å¯ä»¥æè¿°ä¸ºï¼š</p>
<ol>
<li><code>objc_msgSend</code> åˆ¤æ–­æ¶ˆæ¯æ¥æ”¶è€…æ˜¯å¦ä¸º <code>nil</code></li>
<li>å½“é <code>nil</code> æ—¶ï¼Œå°†æ ¹æ® <code>isa</code> æŒ‡é’ˆæ‰¾åˆ°ç¼“å­˜æ‰€åœ¨çš„ç±»æˆ–å…ƒç±»å¯¹è±¡çš„ç¼“å­˜ä¸­å¯»æ‰¾ï¼›</li>
<li>å½“æ— æ³•åœ¨ç¼“å­˜ä¸­æ‰¾åˆ°æ—¶ï¼Œå°†ä»æœ¬ç±»å¼€å§‹åˆ°çˆ¶ç±»ï¼ˆåˆ°çˆ¶ç±»çš„çˆ¶ï¼‰åœ¨å…¶æ–¹æ³•åˆ—è¡¨ä¸­æŸ¥æ‰¾ï¼Œå¦‚æœæ‰¾åˆ°ä¼šåŒæ—¶ç¼“å­˜åˆ°åŸæœ‰ç±»ä¸­ä¸€ä»½ï¼›</li>
<li>å¦‚æœæ–¹æ³•åˆ—è¡¨ä¹Ÿæ— æ³•æ‰¾åˆ°å°†å°è¯•åŠ¨æ€æ–¹æ³•è§£æï¼Œå³è¿›å…¥ <code>resolveInstanceMethod</code>/<code>resolveClassMethod</code>ï¼Œå¦‚æœå…¶ä¸­å°†æ–¹æ³•æ­£ç¡®åœ°åŠ¨æ€æ·»åŠ äº†ï¼Œåˆ™ä»æ–¹æ³•åˆ—è¡¨ä¸­è°ƒç”¨å¹¶ç¼“å­˜ï¼›</li>
<li>å¦‚æœä»æ— ï¼Œå°†å°è¯• <code>forwardingTargetForSelector</code>ï¼Œå…¶è¿”å›å°†ä½œä¸ºè¢«è½¬å‘åˆ°çš„ç›®æ ‡å°è¯•æ‰§è¡Œç›¸åº”æ–¹æ³•ï¼›</li>
<li>å¦‚æœè½¬å‘ç›®æ ‡ä¸º <code>nil</code>ï¼Œå°†æœ€ç»ˆå°è¯• <code>methodSignatureForSelector:</code> è¿”å›æ–¹æ³•ç­¾åå¹¶åœ¨ <code>forwardInvocation:</code> å†³å®šæ ¹æ®æ¶ˆæ¯çš„ä¿¡æ¯é€‰æ‹©å¦‚ä½•æ‰§è¡Œï¼›</li>
<li>å¦‚æœåœ¨ <code>methodSignatureForSelector:</code> è¿”å›äº†ç©ºæ–¹æ³•ç­¾åï¼Œå°†æœ€ç»ˆå¯¼è‡´ã€Œunrecognized selector sent to instanceã€ã€‚</li>
</ol>
<p>æ­£å¦‚ã€ŠEffective Objective-C 2.0ã€‹ä¸€ä¹¦ä¸­æåˆ°çš„ <code>CALayer</code> ä½¿ç”¨äº†æ¶ˆæ¯è½¬å‘æ¥å®ç°å…¼å®¹ KVC çš„å®¹å™¨ç±»ï¼š</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-objectivec" data-lang="objectivec"><span class="line"><span class="cl"><span class="k">@interface</span> <span class="nc">MyLayer</span> : <span class="nc">CALayer</span>
</span></span><span class="line"><span class="cl"><span class="k">@property</span> <span class="p">(</span><span class="k">nonatomic</span><span class="p">,</span> <span class="k">copy</span><span class="p">)</span> <span class="n">NSString</span> <span class="o">*</span><span class="n">foo</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">@end</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">@implementation</span> <span class="nc">MyLayer</span>
</span></span><span class="line"><span class="cl"><span class="k">@dynamic</span> <span class="n">foo</span><span class="p">;</span> <span class="c1">// ä¸è‡ªåŠ¨ç”Ÿæˆ getter &amp; setter
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">@end</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">MyLayer</span> <span class="o">*</span><span class="n">layer</span> <span class="o">=</span> <span class="p">[[</span><span class="n">MyLayer</span> <span class="n">alloc</span><span class="p">]</span> <span class="n">init</span><span class="p">];</span>
</span></span><span class="line"><span class="cl"><span class="p">[</span><span class="n">layer</span> <span class="nl">setFoo</span><span class="p">:</span><span class="s">@&#34;kingcos.me&#34;</span><span class="p">];</span>
</span></span><span class="line"><span class="cl"><span class="n">NSLog</span><span class="p">(</span><span class="s">@&#34;%@&#34;</span><span class="p">,</span> <span class="p">[</span><span class="n">layer</span> <span class="n">foo</span><span class="p">]);</span>
</span></span><span class="line"><span class="cl"><span class="n">NSLog</span><span class="p">(</span><span class="s">@&#34;%@&#34;</span><span class="p">,</span> <span class="p">[</span><span class="n">layer</span> <span class="nl">valueForKey</span><span class="p">:</span><span class="s">@&#34;foo&#34;</span><span class="p">]);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// OUTPUT:
</span></span></span><span class="line"><span class="cl"><span class="c1">// kingcos.me
</span></span></span><span class="line"><span class="cl"><span class="c1">// kingcos.me
</span></span></span></code></pre></div><!--

- Obj-C å¯¹è±¡æ–¹æ³•æŸ¥æ‰¾é¡ºåºï¼šæœ¬ç±»çš„ç±»å¯¹è±¡æ–¹æ³•åˆ—è¡¨ä¸­æŸ¥æ‰¾åŒåæ–¹æ³•ï¼ˆåˆ†ç±» Category ä¸­çš„æ–¹æ³•ä¼šåˆå¹¶åˆ°ç±»çš„æ–¹æ³•åˆ—è¡¨ä¸­ï¼Œæ ¹æ®åç¼–è¯‘æ›´é å‰ï¼Œä¼šè¢«å…ˆæ‰¾åˆ°ï¼‰ -> è‹¥æ²¡æœ‰æ‰¾åˆ°ï¼Œåˆ™æ ¹æ® `superclass` æŒ‡é’ˆå‘çˆ¶ç±»çš„ç±»å¯¹è±¡æ–¹æ³•åˆ—è¡¨ä¸­æŸ¥æ‰¾ï¼Œç›´åˆ°æŸ¥æ‰¾åŸºç±» `NSObject` çš„ç±»å¯¹è±¡ä¸­ä¹Ÿæ²¡æœ‰åˆ™è¿›è¡Œæ¶ˆæ¯è½¬å‘ï¼ˆMessage Forwardingï¼‰ã€‚
- `objc_msgSend` ä¼šå°†æ–¹æ³•çš„åŒ¹é…çš„ç»“æœç¼“å­˜åœ¨ç±»å¯¹è±¡çš„ `cache_t cache;` ä¸­ï¼Œä¼˜åŒ–ä¹‹åæŸ¥æ‰¾ç›¸åŒæ–¹æ³•çš„é€Ÿåº¦ï¼Œä½†ä»æ…¢äºé™æ€ç»‘å®šï¼Œä¸è¿‡ä¹Ÿä¸è‡³äºæ˜¯ç“¶é¢ˆï¼›å¦‚æœå¯¹æŸ¥æ‰¾é€Ÿåº¦æè‡´è¿½æ±‚åˆ™å¯ä½¿ç”¨çº¯ C å‡½æ•°ã€‚
- è¾¹ç•Œæƒ…å†µï¼š

  - `objc_msgSend_stret`ï¼šå¦‚æœå¾…å‘é€çš„æ¶ˆæ¯è¦è¿”å›ç»“æ„ä½“ï¼Œé‚£ä¹ˆå¯äº¤ç”±æ­¤å‡½æ•°å¤„ç†ã€‚åªæœ‰å½“ CPU çš„å¯„å­˜å™¨èƒ½å¤Ÿå®¹çº³å¾—ä¸‹æ¶ˆæ¯è¿”å›ç±»å‹æ—¶ï¼Œè¿™ä¸ªå‡½æ•°æ‰èƒ½å¤„ç†æ­¤æ¶ˆæ¯ã€‚è‹¥æ˜¯è¿”å›å€¼æ— æ³•å®¹çº³äº CPU å¯„å­˜å™¨ä¸­ï¼ˆæ¯”å¦‚è¿”å›çš„ç»“æ„ä½“å¤ªå¤§äº†ï¼‰ï¼Œé‚£ä¹ˆå°±äº¤ç”±å¦ä¸€ä¸ªå‡½æ•°æ‰§è¡Œæ´¾å‘ã€‚æ­¤æ—¶ï¼Œé‚£ä¸ªå‡½æ•°ä¼šé€šè¿‡åˆ†é…åœ¨æ ˆä¸Šçš„æŸä¸ªå˜é‡æ¥å¤„ç†æ¶ˆæ¯æ‰€è¿”å›çš„ç»“æ„ä½“ã€‚
  - `objc_msgSend_fpret`ï¼šå¦‚æœæ¶ˆæ¯è¿”å›çš„æ˜¯æµ®ç‚¹æ•°ï¼Œé‚£ä¹ˆå¯äº¤ç”±æ­¤å‡½æ•°å¤„ç†ã€‚åœ¨æŸäº›ç»“æ„çš„ CPU ä¸­è°ƒç”¨å‡½æ•°æ—¶ï¼Œéœ€è¦å¯¹ã€Œæµ®ç‚¹æ•°å¯„å­˜å™¨ï¼ˆFloating-Point Registerï¼‰ã€åšç‰¹æ®Šå¤„ç†ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œé€šå¸¸æ‰€ç”¨çš„ `objc_msgSend` åœ¨è¿™ç§æƒ…å†µä¸‹å¹¶ä¸åˆé€‚ã€‚è¿™ä¸ªå‡½æ•°æ˜¯ä¸ºäº†å¤„ç† x86 ç­‰æ¶æ„ CPU ä¸­æŸäº›ä»¤äººç¨è§‰æƒŠè®¶çš„å¥‡æ€ªçŠ¶å†µã€‚ï¼ˆä¸ä¼šä½¿ç”¨åœ¨ ARM 64 æ¶æ„ä¸­ï¼‰
  - `objc_msgSendSuper`ï¼šå¦‚æœè¦ç»™çˆ¶ç±»å‘é€æ¶ˆæ¯ï¼Œä¾‹å¦‚ `[super message:parameter]`ï¼Œé‚£ä¹ˆå°±äº¤ç”±æ­¤å‡½æ•°å¤„ç†ã€‚ä¹Ÿæœ‰å¦å¤–ä¸¤ä¸ªä¸ `objc_msgSend_stret` å’Œ `objc_msgSend_fpret` ç­‰æ•ˆçš„å‡½æ•°ï¼Œç”¨äºå¤„ç†å‘ç»™ `super` çš„ç›¸åº”çš„æ¶ˆæ¯ã€‚

- Obj-C æ¯ä¸ªç±»ä¸­éƒ½æœ‰ä»¥ä¸ŠåŸå‹å‡½æ•°è¡¨ï¼Œ`objc_msgSend` ç­‰å‡½æ•°é€šè¿‡è¯¥è¡¨å¯»æ‰¾åº”è¯¥æ‰§è¡Œçš„æ–¹æ³•å¹¶è·³è‡³å…¶å®ç°ï¼ˆåŸå‹ä¸ `objc_msgSend` å‡½æ•°ç±»ä¼¼æ˜¯ä¸ºäº†åˆ©ç”¨å°¾è°ƒç”¨ä¼˜åŒ– Tail-Call Optimization æŠ€æœ¯ï¼Œç®€åŒ–è·³è‡³å®ç°çš„æ“ä½œï¼‰ã€‚
- å¦‚æœæŸä¸ªå‡½æ•°çš„æœ€åä¸€é¡¹æ“ä½œæ˜¯è°ƒç”¨å¦å¤–ä¸€ä¸ªå‡½æ•°ï¼Œé‚£ä¹ˆå°±å¯ä»¥è¿ç”¨ã€Œå°¾è°ƒç”¨ä¼˜åŒ–ã€æŠ€æœ¯ã€‚ç¼–è¯‘å™¨ä¼šç”Ÿæˆè°ƒè½¬è‡³å¦ä¸€å‡½æ•°æ‰€éœ€çš„æŒ‡ä»¤ç ï¼Œè€Œä¸”ä¸ä¼šå‘è°ƒç”¨å †æ ˆä¸­æ¨å…¥æ–°çš„ã€Œæ ˆå¸§ Frame Stackã€ã€‚åªæœ‰å½“æŸå‡½æ•°çš„æœ€åä¸€ä¸ªæ“ä½œä»…ä»…æ˜¯è°ƒç”¨å…¶ä»–å‡½æ•°è€Œä¸ä¼šå°†å…¶è¿”å›å€¼å¦ä½œä»–ç”¨æ—¶ï¼Œæ‰èƒ½æ‰§è¡Œã€Œå°¾è°ƒç”¨ä¼˜åŒ–ã€ã€‚å¦‚æœä¸è¿™æ ·çš„è¯ï¼Œæ¯æ¬¡è°ƒç”¨ Obj-C æ–¹æ³•ä¹‹å‰éƒ½éœ€è¦éœ€è¦ä¸º `objc_msgSend` å‡†å¤‡æ ˆå¸§ï¼ˆå¯ä»¥åœ¨æ ˆè¿½è¸ª Stack Traceï¼‰ä¸­çœ‹åˆ°è¿™ç§æ ˆå¸§ï¼‰ã€‚æ­¤å¤–ï¼Œè‹¥æ˜¯ä¸ä¼˜åŒ–ï¼Œè¿˜ä¼šè¿‡æ—©åœ°å‘ç”Ÿã€Œæ ˆæº¢å‡ºï¼ˆStack Overflowï¼‰ã€ç°è±¡ã€‚ -->
<h2 id="reference">Reference</h2>
<ul>
<li><a href="https://www.mikeash.com/pyblog/friday-qa-2017-06-30-dissecting-objc_msgsend-on-arm64.html">Dissecting objc_msgSend on ARM64 - Mike Ash</a></li>
<li><a href="http://infocenter.arm.com/help/index.jsp">ARM Software development tools - arm.com</a></li>
<li><a href="https://stackoverflow.com/questions/27353096/1b-and-1f-in-gnu-assembly">1b and 1f in GNU assembly - StackOverflow</a></li>
<li><a href="https://clang.llvm.org/doxygen/Basic_2Targets_2ARM_8cpp_source.html">ARM.cpp - clang</a></li>
<li><a href="https://www.ibm.com/support/knowledgecenter/zh/SSXVZZ_13.1.0/com.ibm.xlcpp131.linux.doc/getstart/predef_macro_v10v12.html">é¢„å®šä¹‰å® - IBM</a></li>
<li><a href="../objects_in_obj-c/">Obj-C ä¸­çš„å¯¹è±¡ - kingcos</a></li>
<li><a href="../category_in_ios/">iOS ä¸­çš„ Category - kingcos</a></li>
<li><a href="http://yulingtianxia.com/blog/2016/06/15/Objective-C-Message-Sending-and-Forwarding/">Objective-C æ¶ˆæ¯å‘é€ä¸è½¬å‘æœºåˆ¶åŸç† - æ¨è§ç‰</a></li>
</ul>
<h2 id="todo">TODO</h2>
<ul>
<li><input disabled="" type="checkbox"> å°¾é€’å½’è°ƒç”¨</li>
<li><input disabled="" type="checkbox"> å°è¯•é€†å‘å¾—åˆ°æ¶ˆæ¯è½¬å‘éƒ¨åˆ†çš„æ­¥éª¤</li>
<li><input disabled="" type="checkbox"> æ¶ˆæ¯å‘é€æµç¨‹å›¾</li>
<li><input disabled="" type="checkbox"> å°è¯•ä½¿ç”¨ Swift å®ç°æ•´ä¸ªè¿‡ç¨‹</li>
</ul>
</div>
                    <div class="post_footer">
                        
                        <div class="meta">
                            <div class="info">
                                <span class="field tags">
                                    <i class="ri-stack-line"></i>
                                    
                                    <a href="https://kingcos.me/tags/focus/">Focus</a>
                                    
                                    <a href="https://kingcos.me/tags/ios/">iOS</a>
                                    
                                    <a href="https://kingcos.me/tags/obj-c/">Obj-C</a>
                                    
                                    <a href="https://kingcos.me/tags//">ğŸš§</a>
                                    
                                </span>
                            </div>
                        </div>
                        
                    </div>
                </div>
                <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<table style="border: 0;">
  <tr>
  <td style="border: 0; width: 30%;">
    <img width='100%' src='/img/about/1.jpg'>
  </td>
  <td style="border: 0; width: 50%;">
    
    <ins class="adsbygoogle"
     style="display:block;width:100%;"
     data-ad-client="ca-pub-9925978992661955"
     data-ad-slot="3213735320"
     data-ad-format="rectangle"
     data-full-width-responsive="false"></ins>
  </td>
  </tr>
</table>

<hr>

<script>
    (adsbygoogle = window.adsbygoogle || []).push({});
</script>
                
                
                







    
    
    
    <div>
        <div id="github-comment">
        </div>

        <script type="text/javascript">
        function getUtterances(isDark) {
            var utterances = document.createElement('script');
            utterances.type = 'text/javascript';
            utterances.async = true;
            utterances.setAttribute('issue-term', "pathname")
            utterances.setAttribute('repo', "kingcos\/kingcos.github.io")
            utterances.setAttribute('label', "comments")
            isDark ? utterances.setAttribute('theme', "github-dark") : utterances.setAttribute('theme', "github-light")
            utterances.crossorigin = 'anonymous';
            utterances.src = 'https://utteranc.es/client.js';

            return utterances
        }
        document.getElementById('github-comment').appendChild(getUtterances(false))
        </script>
    </div>
    




                
            </div>
        </div>
    </div>
    <a id="back_to_top" href="#" class="back_to_top"><i class="ri-arrow-up-s-line"></i></a>
    <footer class="footer">
    <div class="powered_by">
        <a href="https://kingcos.me">Powered by kingcos with love.</a>
    </div>

    <div class="footer_slogan">
        <span>â¤ï¸</span>
    </div>
</footer>
    <script src="https://kingcos.me/js/jquery-3.5.1.min.js"></script>
<link href="https://kingcos.me/css/fancybox.min.css" rel="stylesheet">
<script src="https://kingcos.me/js/fancybox.min.js"></script>
<script src="https://kingcos.me/js/zozo.js"></script>


<script type="text/javascript" async
    src="https://cdn.bootcss.com/mathjax/2.7.5/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
        MathJax.Hub.Config({
            tex2jax: {
                inlineMath: [['$', '$'], ['\\(', '\\)']],
                displayMath: [['$$', '$$'], ['\[\[', '\]\]']],
                processEscapes: true,
                processEnvironments: true,
                skipTags: ['script', 'noscript', 'style', 'textarea', 'pre'],
                TeX: {
                    equationNumbers: { autoNumber: "AMS" },
                    extensions: ["AMSmath.js", "AMSsymbols.js"]
                }
            }
        });

        MathJax.Hub.Queue(function () {
            
            
            
            var all = MathJax.Hub.getAllJax(), i;
            for (i = 0; i < all.length; i += 1) {
                all[i].SourceElement().parentNode.className += ' has-jax';
            }
        });
    </script>

<style>
    code.has-jax {
        font: inherit;
        font-size: 100%;
        background: inherit;
        border: inherit;
        color: #515151;
    }
</style>



<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-138311951-1', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>

</body>

</html>