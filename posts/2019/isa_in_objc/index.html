<!DOCTYPE html>
<html lang="en">
<head>
  
    <title>Obj-C ä¸­çš„ isa æŒ‡é’ˆ :: iBlog</title>
  
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">
<meta name="description" content="Date Notes Refer.     2019-08-18 é¦–æ¬¡æäº¤ objc4-750.1    Preface isa æŒ‡é’ˆæ˜¯æ‰€æœ‰ Obj-C å¯¹è±¡ä¸­éƒ½æ‹¥æœ‰çš„ä¸€ä¸ªæˆå‘˜ã€‚å› ä¸ºé™¤äº†ç»§æ‰¿é“¾ä¹‹å¤–ï¼ŒObj-C è¿˜ç‰¹æœ‰ä¸€æ¡ä»å®ä¾‹å¯¹è±¡åˆ°ç±»å¯¹è±¡ã€å…ƒç±»å¯¹è±¡çš„é“¾ã€‚è€Œåè€…æ­£æ˜¯ä¾é  isa è€Œä¸²è”èµ·æ¥çš„ï¼Œé‚£ä¹ˆæœ¬æ–‡å°±å°†ç»“åˆæºç è°ˆè°ˆ Obj-C ä¸­çš„ isaã€‚
å¯¹äºä¸å¤§ç†Ÿæ‚‰ Obj-C ä¸­å¯¹è±¡çš„åŒå­¦ï¼Œå¯ä»¥å…ˆè¡Œé˜…è¯» Obj-C ä¸­çš„å¯¹è±¡ä¸€æ–‡ã€‚
Where // NSObject.h @interface NSObject &amp;lt;NSObject&amp;gt; { #pragma clang diagnostic push #pragma clang diagnostic ignored &amp;quot;-Wobjc-interface-ivars&amp;quot; Class isa OBJC_ISA_AVAILABILITY; // â¬…ï¸ #pragma clang diagnostic pop } // objc-runtime-new.h struct objc_class : objc_object { // Class ISA; } // objc-private."/>
<meta name="keywords" content=""/>
<meta name="robots" content="noodp"/>
<link rel="canonical" href="/posts/2019/isa_in_objc/" />


<link rel="stylesheet" href="/assets/style.css">

  <link rel="stylesheet" href="/assets/green.css">



<link rel="stylesheet" href="/style.css">


<link rel="apple-touch-icon-precomposed" sizes="144x144" href="/img/apple-touch-icon-144-precomposed.png">

<link rel="shortcut icon" href="/img/favicon/favicon.ico">



<meta name="twitter:card" content="summary" />
<meta name="twitter:title" content="Obj-C ä¸­çš„ isa æŒ‡é’ˆ :: iBlog â€” " />
<meta name="twitter:description" content="Date Notes Refer.     2019-08-18 é¦–æ¬¡æäº¤ objc4-750.1    Preface isa æŒ‡é’ˆæ˜¯æ‰€æœ‰ Obj-C å¯¹è±¡ä¸­éƒ½æ‹¥æœ‰çš„ä¸€ä¸ªæˆå‘˜ã€‚å› ä¸ºé™¤äº†ç»§æ‰¿é“¾ä¹‹å¤–ï¼ŒObj-C è¿˜ç‰¹æœ‰ä¸€æ¡ä»å®ä¾‹å¯¹è±¡åˆ°ç±»å¯¹è±¡ã€å…ƒç±»å¯¹è±¡çš„é“¾ã€‚è€Œåè€…æ­£æ˜¯ä¾é  isa è€Œä¸²è”èµ·æ¥çš„ï¼Œé‚£ä¹ˆæœ¬æ–‡å°±å°†ç»“åˆæºç è°ˆè°ˆ Obj-C ä¸­çš„ isaã€‚
å¯¹äºä¸å¤§ç†Ÿæ‚‰ Obj-C ä¸­å¯¹è±¡çš„åŒå­¦ï¼Œå¯ä»¥å…ˆè¡Œé˜…è¯» Obj-C ä¸­çš„å¯¹è±¡ä¸€æ–‡ã€‚
Where // NSObject.h @interface NSObject &amp;lt;NSObject&amp;gt; { #pragma clang diagnostic push #pragma clang diagnostic ignored &amp;quot;-Wobjc-interface-ivars&amp;quot; Class isa OBJC_ISA_AVAILABILITY; // â¬…ï¸ #pragma clang diagnostic pop } // objc-runtime-new.h struct objc_class : objc_object { // Class ISA; } // objc-private." />
<meta name="twitter:site" content="/" />
<meta name="twitter:creator" content="" />
<meta name="twitter:image" content="">


<meta property="og:locale" content="en" />
<meta property="og:type" content="article" />
<meta property="og:title" content="Obj-C ä¸­çš„ isa æŒ‡é’ˆ :: iBlog â€” ">
<meta property="og:description" content="Date Notes Refer.     2019-08-18 é¦–æ¬¡æäº¤ objc4-750.1    Preface isa æŒ‡é’ˆæ˜¯æ‰€æœ‰ Obj-C å¯¹è±¡ä¸­éƒ½æ‹¥æœ‰çš„ä¸€ä¸ªæˆå‘˜ã€‚å› ä¸ºé™¤äº†ç»§æ‰¿é“¾ä¹‹å¤–ï¼ŒObj-C è¿˜ç‰¹æœ‰ä¸€æ¡ä»å®ä¾‹å¯¹è±¡åˆ°ç±»å¯¹è±¡ã€å…ƒç±»å¯¹è±¡çš„é“¾ã€‚è€Œåè€…æ­£æ˜¯ä¾é  isa è€Œä¸²è”èµ·æ¥çš„ï¼Œé‚£ä¹ˆæœ¬æ–‡å°±å°†ç»“åˆæºç è°ˆè°ˆ Obj-C ä¸­çš„ isaã€‚
å¯¹äºä¸å¤§ç†Ÿæ‚‰ Obj-C ä¸­å¯¹è±¡çš„åŒå­¦ï¼Œå¯ä»¥å…ˆè¡Œé˜…è¯» Obj-C ä¸­çš„å¯¹è±¡ä¸€æ–‡ã€‚
Where // NSObject.h @interface NSObject &amp;lt;NSObject&amp;gt; { #pragma clang diagnostic push #pragma clang diagnostic ignored &amp;quot;-Wobjc-interface-ivars&amp;quot; Class isa OBJC_ISA_AVAILABILITY; // â¬…ï¸ #pragma clang diagnostic pop } // objc-runtime-new.h struct objc_class : objc_object { // Class ISA; } // objc-private." />
<meta property="og:url" content="/posts/2019/isa_in_objc/" />
<meta property="og:site_name" content="Obj-C ä¸­çš„ isa æŒ‡é’ˆ" />
<meta property="og:image" content="">
<meta property="og:image:width" content="2048">
<meta property="og:image:height" content="1024">

<meta property="article:published_time" content="2019-08-18 00:00:00 &#43;0000 UTC" />











</head>
<body class="">


<div class="container center">

  <header class="header">
  <div class="header__inner">
    <div class="header__logo">
      <a href="/">
  <div class="logo">
    iBlog
  </div>
</a>

    </div>
    <div class="menu-trigger">menu</div>
  </div>
  
  
    
<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-138311951-1', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>

  

  
    <nav class="menu">
  <ul class="menu__inner menu__inner--desktop">
    
      
        
          <li><a href="/about">About &amp; AMA</a></li>
        
      
        
          <li><a href="/links">Links</a></li>
        
      
        
          <li><a href="/perspective">Perspective</a></li>
        
      
        
          <li><a href="/words">Words</a></li>
        
      
      
    
  </ul>

  <ul class="menu__inner menu__inner--mobile">
    
      
        <li><a href="/about">About &amp; AMA</a></li>
      
    
      
        <li><a href="/links">Links</a></li>
      
    
      
        <li><a href="/perspective">Perspective</a></li>
      
    
      
        <li><a href="/words">Words</a></li>
      
    
  </ul>
</nav>

  
</header>


  <div class="content">
    
<div class="post">
  <h1 class="post-title">
    <a href="/posts/2019/isa_in_objc/">Obj-C ä¸­çš„ isa æŒ‡é’ˆ</a></h1>
  <div class="post-meta">
    <span class="post-date">
      2019-08-18
    </span>
    
  </div>

  
  <span class="post-tags">
    
    #<a href="/tags/focus/">Focus</a>&nbsp;
    
    #<a href="/tags/ios/">iOS</a>&nbsp;
    
    #<a href="/tags/obj-c/">Obj-C</a>&nbsp;
    
    #<a href="/tags/">ğŸŒŸ</a>&nbsp;
    
  </span>
  

  

  <div class="post-content">
    

<table>
<thead>
<tr>
<th align="center">Date</th>
<th align="center">Notes</th>
<th align="center">Refer.</th>
</tr>
</thead>

<tbody>
<tr>
<td align="center">2019-08-18</td>
<td align="center">é¦–æ¬¡æäº¤</td>
<td align="center"><a href="https://opensource.apple.com/tarballs/objc4/">objc4-750.1</a></td>
</tr>
</tbody>
</table>

<p><img src="/img/2019/isa_in_objc/0.png" alt="0" /></p>

<h2 id="preface">Preface</h2>

<p><code>isa</code> æŒ‡é’ˆæ˜¯æ‰€æœ‰ Obj-C å¯¹è±¡ä¸­éƒ½æ‹¥æœ‰çš„ä¸€ä¸ªæˆå‘˜ã€‚å› ä¸ºé™¤äº†ç»§æ‰¿é“¾ä¹‹å¤–ï¼ŒObj-C è¿˜ç‰¹æœ‰ä¸€æ¡ä»å®ä¾‹å¯¹è±¡åˆ°ç±»å¯¹è±¡ã€å…ƒç±»å¯¹è±¡çš„é“¾ã€‚è€Œåè€…æ­£æ˜¯ä¾é  <code>isa</code> è€Œä¸²è”èµ·æ¥çš„ï¼Œé‚£ä¹ˆæœ¬æ–‡å°±å°†ç»“åˆæºç è°ˆè°ˆ Obj-C ä¸­çš„ <code>isa</code>ã€‚</p>

<p>å¯¹äºä¸å¤§ç†Ÿæ‚‰ Obj-C ä¸­å¯¹è±¡çš„åŒå­¦ï¼Œå¯ä»¥å…ˆè¡Œé˜…è¯» <a href="../objects_in_obj-c/">Obj-C ä¸­çš„å¯¹è±¡</a>ä¸€æ–‡ã€‚</p>

<h2 id="where">Where</h2>

<pre><code class="language-cpp">// NSObject.h
@interface NSObject &lt;NSObject&gt; {
#pragma clang diagnostic push
#pragma clang diagnostic ignored &quot;-Wobjc-interface-ivars&quot;
    Class isa  OBJC_ISA_AVAILABILITY; // â¬…ï¸
#pragma clang diagnostic pop
}

// objc-runtime-new.h
struct objc_class : objc_object {
    // Class ISA;
}

// objc-private.h
struct objc_object {
private:
    isa_t isa; // â¬…ï¸
}
</code></pre>

<p>å¦‚ä¸Šï¼Œå¯¹äºå®ä¾‹å¯¹è±¡ï¼Œ<code>isa</code> å®šä¹‰åœ¨åŸºç±» <code>NSObject</code> çš„å†…éƒ¨è¢«å…¶å®ƒç±»æ‰€ç»§æ‰¿ï¼›å¯¹äºç±»å¯¹è±¡å’Œå…ƒç±»å¯¹è±¡ï¼Œ<code>isa</code> åœ¨ <code>objc_object</code> ç»“æ„ä½“ä¸­è¢«ç»§æ‰¿ã€‚</p>

<p><img src="/img/2019/isa_in_objc/1.png" alt="1" /></p>

<p>å®ä¾‹å¯¹è±¡ä¸­çš„ <code>isa</code> æŒ‡å‘ç±»å¯¹è±¡ï¼Œç±»å¯¹è±¡ä¸­çš„ <code>isa</code> æŒ‡å‘å…ƒç±»å¯¹è±¡ï¼Œå…ƒç±»å¯¹è±¡ä¸­çš„ <code>isa</code> æŒ‡å‘æ ¹å…ƒç±»å¯¹è±¡ï¼ˆåŒ…æ‹¬æ ¹å…ƒç±»å¯¹è±¡ä¹ŸæŒ‡å‘è‡ªå·±ï¼‰ã€‚</p>

<h2 id="what">What</h2>

<p>é‚£ä¹ˆ <code>isa</code> åˆ°åº•æ˜¯ä»€ä¹ˆå‘¢ï¼Ÿå…¶å®åœ¨ ARM 64 ä¹‹å‰ï¼Œ<code>isa</code> ç›´æ¥ä¿å­˜äº†ç±»å¯¹è±¡æˆ–è€…å…ƒç±»å¯¹è±¡çš„åœ°å€ï¼Œè€Œä¹‹åä½¿ç”¨äº†ä½åŸŸç»“æ„å­˜å‚¨äº†æ›´å¤šä¿¡æ¯ã€‚</p>

<p>æˆ‘ä»¬å¯ä»¥åœ¨æºç ä¸­è¿½æ ¹æº¯æºæ‰¾åˆ° <code>isa_t</code> ç±»å‹çš„å…±ç”¨ä½“ï¼ˆå…³äºå…±ç”¨ä½“å’Œä½åŸŸï¼Œå¯å‚è€ƒ <a href="../bit_field_union_in_cpp/">C/C++ ä¸­çš„ä½åŸŸä¸å…±ç”¨ä½“</a>ä¸€æ–‡ï¼‰ï¼š</p>

<pre><code class="language-cpp">// objc-private.h
struct objc_object {
private:
    isa_t isa;

// ...
}

union isa_t {
    isa_t() { }
    isa_t(uintptr_t value) : bits(value) { }

    Class cls;
    uintptr_t bits;
#if defined(ISA_BITFIELD)
    struct {
        ISA_BITFIELD;  // defined in isa.h
    };
#endif
};

// isa.h
// ARM 64
# if __arm64__
#   define ISA_MASK        0x0000000ffffffff8ULL
#   define ISA_MAGIC_MASK  0x000003f000000001ULL
#   define ISA_MAGIC_VALUE 0x000001a000000001ULL
#   define ISA_BITFIELD                                                      \
      uintptr_t nonpointer        : 1;                                       \
      uintptr_t has_assoc         : 1;                                       \
      uintptr_t has_cxx_dtor      : 1;                                       \
      uintptr_t shiftcls          : 33; /*MACH_VM_MAX_ADDRESS 0x1000000000*/ \
      uintptr_t magic             : 6;                                       \
      uintptr_t weakly_referenced : 1;                                       \
      uintptr_t deallocating      : 1;                                       \
      uintptr_t has_sidetable_rc  : 1;                                       \
      uintptr_t extra_rc          : 19
#   define RC_ONE   (1ULL&lt;&lt;45)
#   define RC_HALF  (1ULL&lt;&lt;18)

// _uintptr_t.h
#ifndef _UINTPTR_T
#define _UINTPTR_T
typedef unsigned long           uintptr_t;
#endif /* _UINTPTR_T */
</code></pre>

<p>ä¸ºäº†æœ€å¤§ç¨‹åº¦åœ°ä¼˜åŒ–å†…å­˜å ç”¨ï¼Œ<code>isa</code> ä½¿ç”¨äº†ä½åŸŸä¸å…±ç”¨ä½“ç»“æ„ï¼Œå°† <code>unsigned long</code> çš„ 8 ä¸ªå­—èŠ‚åˆ†ä¸º 64 ä½æ¥ä½¿ç”¨ã€‚åœ¨ ARM 64 ç»“æ„ä¹‹ä¸‹ï¼Œ<code>isa</code> ä¸­çš„å†…å®¹å¦‚ä¸‹ï¼š</p>

<table>
<thead>
<tr>
<th align="center">ISA_BITFIELD</th>
<th align="center">Bits</th>
<th align="center">Notes</th>
</tr>
</thead>

<tbody>
<tr>
<td align="center">nonpointer</td>
<td align="center">1</td>
<td align="center"><code>0</code>ï¼šæ™®é€šæŒ‡é’ˆï¼Œç›´æ¥å­˜å‚¨ç±»æˆ–å…ƒç±»å¯¹è±¡çš„åœ°å€<br><code>1</code>ï¼šç»è¿‡ä¼˜åŒ–çš„æŒ‡é’ˆï¼Œä½¿ç”¨ä½åŸŸç»“æ„å­˜å‚¨äº†æ›´å¤šä¿¡æ¯</td>
</tr>

<tr>
<td align="center">has_assoc</td>
<td align="center">1</td>
<td align="center"><code>0</code>ï¼šæ ‡è®°æœªè®¾ç½®è¿‡å…³è”å¯¹è±¡<br><code>1</code>ï¼šæ ‡è®°è®¾ç½®è¿‡å…³è”å¯¹è±¡</td>
</tr>

<tr>
<td align="center">has_cxx_dtor</td>
<td align="center">1</td>
<td align="center"><code>0</code>ï¼šæ ‡è®°æ²¡æœ‰ C++ ææ„å‡½æ•°<br><code>1</code>ï¼šæ ‡è®°æœ‰ C++ ææ„å‡½æ•°</td>
</tr>

<tr>
<td align="center">shiftcls</td>
<td align="center">33</td>
<td align="center">å­˜å‚¨ç±»æˆ–å…ƒç±»å¯¹è±¡çš„åœ°å€</td>
</tr>

<tr>
<td align="center">magic</td>
<td align="center">6</td>
<td align="center">è°ƒè¯•æ—¶åˆ†è¾¨å¯¹è±¡æ˜¯å¦æœªå®Œæˆåˆå§‹åŒ–</td>
</tr>

<tr>
<td align="center">weakly_referenced</td>
<td align="center">1</td>
<td align="center"><code>0</code>ï¼šæ ‡è®°æœªå¼±å¼•ç”¨è¿‡<br><code>1</code>ï¼šæ ‡è®°å¼±å¼•ç”¨è¿‡</td>
</tr>

<tr>
<td align="center">deallocating</td>
<td align="center">1</td>
<td align="center"><code>0</code>ï¼šå¯¹è±¡æœªæ­£åœ¨é‡Šæ”¾<br><code>1</code>ï¼šå¯¹è±¡æ­£åœ¨é‡Šæ”¾</td>
</tr>

<tr>
<td align="center">has_sidetable_rc</td>
<td align="center">1</td>
<td align="center"><code>0</code>ï¼šå¼•ç”¨è®¡æ•°å­˜å‚¨åœ¨ extra_rc<br><code>1</code>ï¼šå¼•ç”¨è®¡æ•°è¿‡å¤§ï¼Œå­˜å‚¨åœ¨ side table ç±»çš„å±æ€§ä¸­</td>
</tr>

<tr>
<td align="center">extra_rc</td>
<td align="center">19</td>
<td align="center">å­˜å‚¨å¼•ç”¨è®¡æ•° - 1</td>
</tr>
</tbody>
</table>

<p>å¾—åˆ°äº† <code>isa</code> ä¸­å„ä¸ªæˆå‘˜çš„ä½æ•°ï¼Œè¿™æ ·æˆ‘ä»¬å°±å¯ä»¥é€šè¿‡æ©ç æ¥è¿ç®—å¾—å‡ºæˆ‘ä»¬æƒ³è¦çš„éƒ¨åˆ†ã€‚æ¯”å¦‚ <code>ISA_MASK</code>ï¼Œ<code>0x0000000ffffffff8</code> æ¢ç®—ä¸ºäºŒè¿›åˆ¶å³ <code>0b 0000 0000 0000 0000 0000 0000 0000 1111 1111 1111 1111 1111 1111 1111 1111 1000</code>ï¼Œå› æ­¤å¦‚æœä½¿ç”¨ <code>&amp;</code> é€»è¾‘ä¸å°†æŠŠ <code>shiftcls</code> å³ç±»æˆ–å…ƒç±»å¯¹è±¡çš„åœ°å€å¾—å‡ºï¼š</p>

<pre><code class="language-objectivec">#import &lt;Foundation/Foundation.h&gt;
#import &lt;objc/runtime.h&gt;

@interface Foo : NSObject
@end

@implementation Foo
@end

int main(int argc, const char * argv[]) {
    @autoreleasepool {
        Foo *foo = [[Foo alloc] init];

        NSLog(@&quot;%p&quot;, object_getClass(foo));
    }
}

// LLDB:
// (lldb) p/x foo-&gt;isa
// (Class) $0 = 0x001d800100002479 Foo
// (lldb) p/x 0x001d800100002479 &amp; 0x0000000ffffffff8ULL
// (unsigned long long) $1 = 0x0000000100002478
// 2019-08-19 01:36:16.856340+0800 Block_in_Obj-C[77178:84300219] 0x100002478
</code></pre>

<h2 id="reference">Reference</h2>

<ul>
<li><a href="../bit_field_union_in_cpp/">C/C++ ä¸­çš„ä½åŸŸä¸å…±ç”¨ä½“ - kingcos</a></li>
<li><a href="../objects_in_obj-c/">Obj-C ä¸­çš„å¯¹è±¡ - kingcos</a></li>
</ul>

  </div>
  
  <div class="pagination">
    <div class="pagination__title">
      <span
        class="pagination__title-h">Read other posts</span>
      <hr />
    </div>
    <div class="pagination__buttons">
      
      <span class="button previous">
        <a href="/posts/2019/swift_tips_in_reverse/">
          <span class="button__icon">â†</span>
          <span class="button__text">SwiftTips in Reverse</span>
        </a>
      </span>
      
      
      <span class="button next">
        <a href="/posts/2019/bit_field_union_in_cpp/">
          <span class="button__text">C/C&#43;&#43; ä¸­çš„ä½åŸŸä¸å…±ç”¨ä½“</span>
          <span class="button__icon">â†’</span>
        </a>
      </span>
      
    </div>
  </div>
  

  

    
    
    <div class="post bg-white">
      <script src="https://utteranc.es/client.js"
            repo="kingcos/kingcos.github.io"
            issue-term="pathname"
            label="comments"
            theme="github-dark"
            crossorigin="anonymous"
            async>
      </script>
    </div>
    

</div>

  </div>

  
    <footer class="footer">
  <div class="footer__inner">
    
      <div class="copyright">
        <span>Â© 2019 Â· <a href="http://github.com/kingcos">kingcos</a></span>
      </div>
    
  </div>
</footer>

<script src="/assets/main.js"></script>
<script src="/assets/prism.js"></script>





  
</div>

</body>
</html>
