<!DOCTYPE html>
<html lang="en">
  <head>
    
      <title>Obj-C ä¸­çš„å¯¹è±¡ :: iBlog â€” github.com/kingcos</title>
    
    <meta http-equiv="content-type" content="text/html; charset=utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">
<meta name="description" content="Date Notes Refer.     2019-03-18 é¦–æ¬¡æäº¤ objc4-750   2019-08-18 æŠ½ç¦» isa éƒ¨åˆ†ï¼›
é‡æ•´æ–‡ç« ç»“æ„ Obj-C ä¸­çš„ isa æŒ‡é’ˆ - kingcos   2019-08 å¢åŠ  class_rw_t ç­‰ -    Preface Obj-C ä¸­çš„å¯¹è±¡åˆ†ä¸ºå®ä¾‹å¯¹è±¡ï¼ˆInstance Objectï¼‰ã€ç±»å¯¹è±¡ï¼ˆClass Objectï¼‰ã€ä»¥åŠå…ƒç±»å¯¹è±¡ï¼ˆMeta-class Objectï¼‰ä¸‰ç§ï¼Œä¸€èµ·æ¥è®¤è¯†ä¸‹è¿™äº›ä¸åŒçš„ Obj-C å¯¹è±¡å§ï½
ä¸ºäº†æ–¹ä¾¿ä¸‹æ–‡ä¸¾ä¾‹ï¼Œè¿™é‡Œæˆ‘ä»¬å®šä¹‰ä¸€ä¸ª EDdeviceProtocol åè®®ï¼Œå¹¶è®©ç»§æ‰¿è‡ª NSObject çš„ Computer ç±»éµå®ˆè¯¥åè®®ï¼š
// EDdeviceProtocol åè®® @protocol EDdeviceProtocol - (void)powerOn; @end // Computer ç±»ï¼Œç»§æ‰¿è‡ª NSObjectï¼Œéµå®ˆ EDdeviceProtocol @interface Computer : NSObject &amp;lt;EDdeviceProtocol&amp;gt; { // æˆå‘˜å˜é‡ @public int _memorySize; int _diskSize; } // å±æ€§ @property (copy) NSString *model; // å®ä¾‹æ–¹æ³• - (void)print:(NSString *)content; // ç±»æ–¹æ³• &#43; (NSString *)arch; @end @implementation Computer - (void)print:(NSString *)content { NSLog(@&amp;quot;Print content: %@."/>
<meta name="keywords" content="ios,swift,objective-c,obj-c,objc,oc,geek,python,ruby,golang,go,apple,mac"/>
<meta name="robots" content="noodp"/>
<link rel="canonical" href="/posts/2019/objects_in_obj-c/" />





<link rel="stylesheet" href="/assets/style.css">


<link rel="stylesheet" href="/style.css">


<link rel="apple-touch-icon-precomposed" sizes="144x144" href="/img/apple-touch-icon-144-precomposed.png">
<link rel="shortcut icon" href="/img/favicon.png">


<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Obj-C ä¸­çš„å¯¹è±¡"/>
<meta name="twitter:description" content="Obj-C ä¸­çš„å¯¹è±¡åˆ†ä¸ºå®ä¾‹å¯¹è±¡ï¼ˆInstance Objectï¼‰ã€ç±»å¯¹è±¡ï¼ˆClass Objectï¼‰ã€ä»¥åŠå…ƒç±»å¯¹è±¡ï¼ˆMeta-class Objectï¼‰ä¸‰ç§ï¼Œä¸€èµ·æ¥è®¤è¯†ä¸‹è¿™äº›ä¸åŒçš„ Obj-C å¯¹è±¡å§ï½"/>



<meta property="og:title" content="Obj-C ä¸­çš„å¯¹è±¡" />
<meta property="og:description" content="Obj-C ä¸­çš„å¯¹è±¡åˆ†ä¸ºå®ä¾‹å¯¹è±¡ï¼ˆInstance Objectï¼‰ã€ç±»å¯¹è±¡ï¼ˆClass Objectï¼‰ã€ä»¥åŠå…ƒç±»å¯¹è±¡ï¼ˆMeta-class Objectï¼‰ä¸‰ç§ï¼Œä¸€èµ·æ¥è®¤è¯†ä¸‹è¿™äº›ä¸åŒçš„ Obj-C å¯¹è±¡å§ï½" />
<meta property="og:type" content="article" />
<meta property="og:url" content="/posts/2019/objects_in_obj-c/" />
<meta property="article:published_time" content="2019-08-18T00:00:00+00:00" />
<meta property="article:modified_time" content="2019-08-18T00:00:00+00:00" /><meta property="og:site_name" content="iBlog" />






  </head>
  <body class="dark-theme">
    <div class="container">
      <header class="header">
  <span class="header__inner">
    <a href="/" class="logo" style="text-decoration: none;">
  
    <span class="logo__mark"><svg xmlns="http://www.w3.org/2000/svg" class="greater-icon" viewBox="0 0 44 44">
  <path fill="none" d="M15 8l14.729 14.382L15 35.367"/>
</svg>
</span>
    <span class="logo__text">iBlog</span>
    <span class="logo__cursor"></span>
  
</a>

    <span class="header__right">
      
        <nav class="menu">
  <ul class="menu__inner menu__inner--desktop">
    
      
        
          <li><a href="/about">About &amp; AMA</a></li>
        
      
        
          <li><a href="/links">Links</a></li>
        
      
        
          <li><a href="/perspective">Perspective</a></li>
        
      
        
          <li><a href="/words">Words</a></li>
        
      
      
    
  </ul>

  <ul class="menu__inner menu__inner--mobile">
    
      
        <li><a href="/about">About &amp; AMA</a></li>
      
    
      
        <li><a href="/links">Links</a></li>
      
    
      
        <li><a href="/perspective">Perspective</a></li>
      
    
      
        <li><a href="/words">Words</a></li>
      
    
  </ul>
</nav>

        <span class="menu-trigger">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
            <path d="M0 0h24v24H0z" fill="none"/>
            <path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"/>
          </svg>
        </span>
      
      <span class="theme-toggle">
        <svg class="theme-toggler" width="24" height="24" viewBox="0 0 48 48" fill="none" xmlns="http://www.w3.org/2000/svg">
  <path d="M22 41C32.4934 41 41 32.4934 41 22C41 11.5066 32.4934 3 22
  3C11.5066 3 3 11.5066 3 22C3 32.4934 11.5066 41 22 41ZM7 22C7
  13.7157 13.7157 7 22 7V37C13.7157 37 7 30.2843 7 22Z"/>
</svg>

      </span>
    </span>
  </span>
</header>


      <div class="content">
        
  <div class="post">
    <h2 class="post-title"><a href="/posts/2019/objects_in_obj-c/">Obj-C ä¸­çš„å¯¹è±¡</a></h2>
    <div class="post-meta">
      
        <span class="post-date">
            2019-08-18
        </span>
      
      
      
        <span class="post-read-time">â€” 6 min read</span>
      
    </div>

    
      <span class="post-tags">
        
          #<a href="/tags/focus/">Focus</a>&nbsp;
        
          #<a href="/tags/ios/">iOS</a>&nbsp;
        
          #<a href="/tags/obj-c/">Obj-C</a>&nbsp;
        
          #<a href="/tags//">ğŸŒŸ</a>&nbsp;
        
      </span>
    

    

    <div class="post-content">
      

<table>
<thead>
<tr>
<th align="center">Date</th>
<th align="center">Notes</th>
<th align="center">Refer.</th>
</tr>
</thead>

<tbody>
<tr>
<td align="center">2019-03-18</td>
<td align="center">é¦–æ¬¡æäº¤</td>
<td align="center"><a href="https://opensource.apple.com/tarballs/objc4/">objc4-750</a></td>
</tr>

<tr>
<td align="center">2019-08-18</td>
<td align="center">æŠ½ç¦» <code>isa</code> éƒ¨åˆ†ï¼›<br>é‡æ•´æ–‡ç« ç»“æ„</td>
<td align="center"><a href="../isa_in_objc/">Obj-C ä¸­çš„ isa æŒ‡é’ˆ - kingcos</a></td>
</tr>

<tr>
<td align="center">2019-08</td>
<td align="center">å¢åŠ  <code>class_rw_t</code> ç­‰</td>
<td align="center">-</td>
</tr>
</tbody>
</table>

<p><img src="/img/2019/objects_in_obj-c/0.png" alt="0" /></p>

<h2 id="preface">Preface</h2>

<p>Obj-C ä¸­çš„å¯¹è±¡åˆ†ä¸ºå®ä¾‹å¯¹è±¡ï¼ˆInstance Objectï¼‰ã€ç±»å¯¹è±¡ï¼ˆClass Objectï¼‰ã€ä»¥åŠå…ƒç±»å¯¹è±¡ï¼ˆMeta-class Objectï¼‰ä¸‰ç§ï¼Œä¸€èµ·æ¥è®¤è¯†ä¸‹è¿™äº›ä¸åŒçš„ Obj-C å¯¹è±¡å§ï½</p>

<p><img src="/img/2019/objects_in_obj-c/1.png" alt="1" /></p>

<p>ä¸ºäº†æ–¹ä¾¿ä¸‹æ–‡ä¸¾ä¾‹ï¼Œè¿™é‡Œæˆ‘ä»¬å®šä¹‰ä¸€ä¸ª <code>EDdeviceProtocol</code> åè®®ï¼Œå¹¶è®©ç»§æ‰¿è‡ª <code>NSObject</code> çš„ <code>Computer</code> ç±»éµå®ˆè¯¥åè®®ï¼š</p>

<pre><code class="language-objectivec">// EDdeviceProtocol åè®®
@protocol EDdeviceProtocol
- (void)powerOn;
@end

// Computer ç±»ï¼Œç»§æ‰¿è‡ª NSObjectï¼Œéµå®ˆ EDdeviceProtocol
@interface Computer : NSObject &lt;EDdeviceProtocol&gt; {
// æˆå‘˜å˜é‡
@public
    int _memorySize;
    int _diskSize;
}

// å±æ€§
@property (copy) NSString *model;

// å®ä¾‹æ–¹æ³•
- (void)print:(NSString *)content;

// ç±»æ–¹æ³•
+ (NSString *)arch;
@end

@implementation Computer
- (void)print:(NSString *)content {
    NSLog(@&quot;Print content: %@.&quot;, content);
}

// åè®®æ–¹æ³•
- (void)powerOn {
    NSLog(@&quot;%s&quot;, __func__);
}

+ (NSString *)arch {
    return @&quot;ARM 64&quot;;
}
@end
</code></pre>

<h2 id="å®ä¾‹å¯¹è±¡">å®ä¾‹å¯¹è±¡</h2>

<pre><code class="language-objectivec">// cpt ä¸ºæŒ‡å‘ Computer ç±»å‹å®ä¾‹å¯¹è±¡çš„æŒ‡é’ˆ
Computer *cpt = [[Computer alloc] init];

// Direct access to Objective-C's isa is deprecated in favor of object_getClass()
// cpt-&gt;isa;

cpt-&gt;_memorySize = 16;
cpt-&gt;_diskSize = 512;

cpt.model = @&quot;MacBook Pro 13'&quot;;
</code></pre>

<p><code>cpt</code> æŒ‡å‘çš„å®ä¾‹å¯¹è±¡ä¸­å°†å­˜æ”¾ç»§æ‰¿è‡ª <code>NSObject</code> åŸºç±»çš„ <code>isa</code> æŒ‡é’ˆæˆå‘˜å˜é‡ï¼ˆä½†æ— æ³•ç›´æ¥è®¿é—®ï¼‰ï¼›å¦å¤–è¿˜å­˜æ”¾äº†å…¶å®ƒæˆå‘˜å˜é‡ä»¥åŠå±æ€§çš„å…·ä½“å€¼ã€‚</p>

<pre><code class="language-objectivec">// NSObject.h
@interface NSObject &lt;NSObject&gt; {
#pragma clang diagnostic push
#pragma clang diagnostic ignored &quot;-Wobjc-interface-ivars&quot;
    Class isa  OBJC_ISA_AVAILABILITY;
#pragma clang diagnostic pop
}
</code></pre>

<h2 id="ç±»å¯¹è±¡">ç±»å¯¹è±¡</h2>

<p>ä¸å®ä¾‹å¯¹è±¡ä¸åŒï¼Œç±»å¯¹è±¡å’Œå…ƒç±»å¯¹è±¡å¹¶ä¸éœ€è¦æˆ‘ä»¬æ‰‹åŠ¨åˆ›å»ºã€‚ç±»å¯¹è±¡å¯ä»¥é€šè¿‡ <code>[obj class]</code>ã€<code>[Computer class]</code> æˆ– Runtime API <code>object_getClass</code> è·å–ï¼š</p>

<pre><code class="language-objectivec">// è·å–ç±»å¯¹è±¡çš„æ–¹æ³•ï¼š
Class cptClass1 = [cpt class];
Class cptClass2 = [Computer class];
Class cptClass3 = object_getClass(cpt);

// LLDB:
// (lldb) p/x cptClass1
// (Class) $0 = 0x00000001000013d0 Computer
// (lldb) p/x cptClass2
// (Class) $1 = 0x00000001000013d0 Computer
// (lldb) p/x cptClass3
// (Class) $2 = 0x00000001000013d0 Computer
</code></pre>

<p>ç±»å¯¹è±¡çš„ç±»å‹æ˜¯ <code>Class</code>ï¼Œæœ¬è´¨æ˜¯æŒ‡å‘ <code>struct objc_class</code> ç»“æ„ä½“çš„æŒ‡é’ˆã€‚é€šè¿‡å…¶å®šä¹‰æˆ‘ä»¬å¯ä»¥å¾—çŸ¥ï¼Œç±»å¯¹è±¡ä¸­å­˜æ”¾äº† <code>isa</code> æŒ‡é’ˆã€<code>superclass</code> æŒ‡é’ˆã€æ–¹æ³•ç¼“å­˜ã€ä»¥åŠä¸ºè¯¥ç±»å®ä¾‹å¯¹è±¡æ‰€å…¬ç”¨çš„ä¿¡æ¯ï¼š</p>

<pre><code class="language-objectivec">// Object.mm
typedef struct objc_class *Class;

// objc-runtime-new.h
struct objc_class : objc_object {
    // Class ISA;
    // â¡ï¸ çˆ¶ç±»æŒ‡é’ˆ
    Class superclass;
    // â¡ï¸ æ–¹æ³•ç¼“å­˜
    cache_t cache;             // formerly cache pointer and vtable
    // â¡ï¸ å¯è¯»å¯å†™è¡¨ï¼ˆclass_rw_tï¼‰ç­‰
    class_data_bits_t bits;    // class_rw_t * plus custom rr/alloc flags

    // ...
};

// objc-private.h
struct objc_object {
private:
    // â¡ï¸ isa æŒ‡é’ˆ
    isa_t isa;

// ...
}
</code></pre>

<h3 id="class-rw-t">class_rw_t</h3>

<p><code>class_data_bits_t bits;</code> ä¸­å…¶å®å°±ä¸»è¦å­˜å‚¨ç€ <code>class_rw_t</code>ï¼š</p>

<pre><code class="language-objectivec">// objc-runtime-new.h

struct objc_class : objc_object {
    // ...

    class_rw_t *data() {
        return bits.data();
    }

    // ...
}

#if !__LP64__
// data pointer
#define FAST_DATA_MASK        0xfffffffcUL
#elif 1
#define FAST_DATA_MASK          0x00007ffffffffff8UL // âœ…
#else
#define FAST_DATA_MASK          0x00007ffffffffff8UL
#endif

struct class_data_bits_t {
    // Values are the FAST_ flags above.
    uintptr_t bits;

    // ...

    class_rw_t* data() {
        return (class_rw_t *)(bits &amp; FAST_DATA_MASK);
    }

    // ...
}
</code></pre>

<p>æŒ‡çš„æ˜¯å¯è¯»å¯å†™è¡¨ã€‚å…¶ä¸­å­˜å‚¨äº†æŒ‡å‘ <code>class_ro_t</code> åªè¯»è¡¨çš„æŒ‡é’ˆã€æ–¹æ³•ã€å±æ€§ã€åè®®ç­‰ä¿¡æ¯ã€‚</p>

<pre><code class="language-objectivec">// objc-runtime-new.h
// â¡ï¸ å¯è¯»å¯å†™è¡¨
struct class_rw_t {
    // Be warned that Symbolication knows the layout of this structure.
    uint32_t flags;
    uint32_t version;

    // â¡ï¸ åªè¯»è¡¨çš„æŒ‡é’ˆ
    const class_ro_t *ro;

    // â¡ï¸ æ–¹æ³•ã€å±æ€§ã€åè®®ä¿¡æ¯
    method_array_t methods;
    property_array_t properties;
    protocol_array_t protocols;

    // ...
};

// objc-runtime-new.h
// â¡ï¸ åªè¯»è¡¨
struct class_ro_t {
    uint32_t flags;
    uint32_t instanceStart;
    // â¡ï¸ å®ä¾‹å¤§å°
    uint32_t instanceSize;
#ifdef __LP64__
    uint32_t reserved;
#endif

    const uint8_t * ivarLayout;

    // â¡ï¸ ç±»å
    const char * name;
    method_list_t * baseMethodList;
    protocol_list_t * baseProtocols;
    // â¡ï¸ æˆå‘˜å˜é‡
    const ivar_list_t * ivars;

    const uint8_t * weakIvarLayout;
    property_list_t *baseProperties;

    method_list_t *baseMethods() const {
        return baseMethodList;
    }
};
</code></pre>

<hr />

<p>å¦‚ä¸Šï¼Œ<code>Class</code> çš„æœ¬è´¨æ˜¯ä¸€ä¸ªæŒ‡å‘ <code>objc_class</code> ç»“æ„ä½“çš„æŒ‡é’ˆã€‚<code>objc_class</code> ç»§æ‰¿çš„çˆ¶ç±» <code>objc_object</code> ä¸­åªæœ‰ä¸€ä¸ªæˆå‘˜å˜é‡ï¼Œå³ <code>isa</code>ã€‚<code>objc_class</code> è‡ªèº«è¿˜æ‹¥æœ‰ <code>superclass</code>ã€<code>bits</code> ç­‰æˆå‘˜å˜é‡ï¼Œ<code>bits</code> ä¸­çš„ <code>data()</code> å­˜æ”¾äº†æŒ‡å‘ <code>class_rw_t</code> çš„æŒ‡é’ˆï¼Œå³ä¸€äº›å¯è¯»å¯å†™çš„æ•°æ®ï¼ˆè¡¨ï¼‰ï¼›<code>class_rw_t</code>ï¼Œé‡Œé¢åˆåŒ…å«äº† <code>methods</code> æ–¹æ³•åˆ—è¡¨ã€<code>properties</code> å±æ€§åˆ—è¡¨ã€<code>protocols</code> åè®®åˆ—è¡¨ã€ä»¥åŠä¸€ä¸ªæŒ‡å‘ <code>class_ro_t</code> ç±»å‹çš„æŒ‡é’ˆï¼ˆè¯¥æŒ‡é’ˆä¸º <code>const</code> ä¸å¯å˜æ›´æŒ‡å‘åœ°å€ï¼‰ï¼Œå­˜æ”¾åªè¯»çš„æ•°æ®ï¼ˆè¡¨ï¼‰ï¼›<code>class_ro_t</code> ç»“æ„ä½“é‡Œå­˜æ”¾äº† <code>instanceSize</code> å®ä¾‹å¤§å°ã€<code>ivars</code> æˆå‘˜å˜é‡ç­‰æ•°æ®ã€‚</p>

<p>Obj-C ä¸­ï¼Œå°†ç±»å¯¹è±¡ä½œä¸ºäº†ä¸€ä¸ªé€æ˜ç±»å‹ï¼Œè®©æˆ‘ä»¬æ— éœ€å…³å¿ƒå…¶å†…éƒ¨å®ç°ç»†èŠ‚ï¼Œä½†å› ä¸ºä»£ç å·²ç»å¼€æºï¼Œæ‰€ä»¥æˆ‘ä»¬å°è¯•ä¸‹å°† <code>Computer</code> ç±»å¯¹è±¡çš„ç»“æ„å±•ç¤ºå‡ºæ¥ã€‚</p>

<pre><code class="language-objectivec">#ifndef objc_header_h
#define objc_header_h

typedef struct v_objc_class *VClass;

union isa_t {
    VClass cls;
    uintptr_t bits;
};

template &lt;typename Element&gt;
struct entsize_list_tt {
    uint32_t entsizeAndFlags;
    uint32_t count;
    Element first;
};

struct ivar_t {
#if __x86_64__
    // *offset was originally 64-bit on some x86_64 platforms.
    // We read and write only 32 bits of it.
    // Some metadata provides all 64 bits. This is harmless for unsigned
    // little-endian values.
    // Some code uses all 64 bits. class_addIvar() over-allocates the
    // offset for their benefit.
#endif
    int32_t *offset;
    const char *name;
    const char *type;
    // alignment is sometimes -1; use alignment() instead
    uint32_t alignment_raw;
    uint32_t size;
};

struct ivar_list_t : entsize_list_tt&lt;ivar_t&gt; {
};

struct method_t {
    SEL name;
    const char *types;
    IMP imp;
};

struct method_list_t : entsize_list_tt&lt;method_t&gt; {
};

struct protocol_list_t {
    // count is 64-bit by accident.
    uintptr_t count;
};

struct property_t {
    const char *name;
    const char *attributes;
};

struct property_list_t : entsize_list_tt&lt;property_t&gt; {
};

struct class_ro_t {
    uint32_t flags;
    uint32_t instanceStart;
    uint32_t instanceSize;
#ifdef __LP64__
    uint32_t reserved;
#endif

    const uint8_t * ivarLayout;

    const char * name;
    method_list_t * baseMethodList;
    protocol_list_t * baseProtocols;
    const ivar_list_t * ivars;

    const uint8_t * weakIvarLayout;
    property_list_t *baseProperties;
};

struct class_rw_t {
    // Be warned that Symbolication knows the layout of this structure.
    uint32_t flags;
    uint32_t version;

    const class_ro_t *ro;

    method_list_t *methods;
    property_list_t *properties;
    protocol_list_t *protocols;
};

#define FAST_DATA_MASK          0x00007ffffffffff8UL
struct class_data_bits_t {
    // Values are the FAST_ flags above.
    uintptr_t bits;
public:
    class_rw_t* data() {
        return (class_rw_t *)(bits &amp; FAST_DATA_MASK);
    }
};

typedef uintptr_t cache_key_t;
struct bucket_t {
    IMP _imp;
    cache_key_t _key;
};

typedef uint32_t mask_t;  // x86_64 &amp; arm64 asm are less efficient with 16-bits
struct cache_t {
    struct bucket_t *_buckets;
    mask_t _mask;
    mask_t _occupied;
};

struct v_objc_object {
    union isa_t isa;
};

struct v_objc_class : v_objc_object {
    // Class ISA;
    VClass superclass;
    cache_t cache;             // formerly cache pointer and vtable
    class_data_bits_t bits;    // class_rw_t * plus custom rr/alloc flags

    class_rw_t *data() {
        return bits.data();
    }
};

#endif /* objc_header_h */
</code></pre>

<p>å°†ä»¥ä¸Šå†…å®¹æ”¾è¿›ä¸€ä¸ªå¤´æ–‡ä»¶ä¸­ï¼Œå³å¯ä½¿ç”¨æˆ‘ä»¬å®šä¹‰å¥½ç»“æ„çš„æŒ‡é’ˆæŒ‡å‘ç±»å¯¹è±¡çš„å†…å­˜ç©ºé—´ã€‚éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œä»¥ä¸Šä»£ç å«æœ‰ C++ è¯­æ³•ï¼Œæ‰€ä»¥å¼•å…¥è¯¥å¤´æ–‡ä»¶çš„ <code>.m</code> æ–‡ä»¶éœ€è¦æ”¹åä¸º <code>.mm</code>ï¼Œå³ Objective-C++ æ–‡ä»¶ç±»å‹ã€‚</p>

<pre><code class="language-objectivec">VClass cptVClass = (__bridge VClass)[Computer class];
class_rw_t *rwt = cptVClass-&gt;data();

// LLDB:
// å¯¹è±¡æ–¹æ³•
// Printing description of rwt-&gt;methods-&gt;first:
// (method_t) first = {
//     name = &quot;coresCount&quot;
//     types = 0x0000000100000f94 &quot;i16@0:8&quot;
//     imp = 0x0000000100000d80 (DemoOC`::-[Computer coresCount]() at main.mm:36)
// }
// å±æ€§
// Printing description of rwt-&gt;properties-&gt;first:
// (property_t) first = (name = &quot;coresCount&quot;, attributes = &quot;Ti,N,V_coresCount&quot;)
// åè®®
// Printing description of rwt-&gt;protocols-&gt;count:
// (uintptr_t) count = 1
// æˆå‘˜å˜é‡
// (lldb) p rwt-&gt;ro-&gt;ivars-&gt;first
// (const ivar_t) $3 = {
//   offset = 0x00000001000012c0
//   name = 0x0000000100000f5c &quot;_memorySize&quot;
//   type = 0x0000000100000fa7 &quot;i&quot;
//   alignment_raw = 2
//   size = 4
// }
</code></pre>

<h2 id="å…ƒç±»å¯¹è±¡">å…ƒç±»å¯¹è±¡</h2>

<p>å…ƒç±»å¯¹è±¡å’Œç±»å¯¹è±¡ä¸€æ ·ï¼Œéƒ½æ˜¯ <code>Class</code> ç±»å‹ï¼Œä½†å…ƒç±»å¯¹è±¡åªå¯ä»¥é€šè¿‡ Runtime çš„ <code>object_getClass</code> API ä¼ å…¥ç±»å¯¹è±¡ï¼Œè·å–åˆ°å…ƒç±»å¯¹è±¡ã€‚éœ€è¦æ³¨æ„çš„æ˜¯ <code>[[Computer class] class]</code> æˆ– <code>[[cpt class] class]</code> éƒ½åªèƒ½è¿”å›ç±»å¯¹è±¡ã€‚</p>

<p>å¯¹äº <code>object_getClass</code>ï¼Œå¦‚æœå‚æ•°æ˜¯å®ä¾‹å¯¹è±¡ï¼Œè¿”å›ç±»å¯¹è±¡ï¼›å¦‚æœå‚æ•°æ˜¯ç±»å¯¹è±¡ï¼Œè¿”å›å…ƒç±»å¯¹è±¡ï¼›å¦‚æœå‚æ•°æ˜¯å…ƒç±»å¯¹è±¡ï¼Œè¿”å› NSObjectï¼ˆåŸºç±»ï¼‰çš„å…ƒç±»å¯¹è±¡ã€‚<code>class_isMetaClass</code> å¯ä»¥ç”¨æ¥æ£€æŸ¥ <code>Class</code> æ˜¯å¦ä¸ºå…ƒç±»å¯¹è±¡ã€‚</p>

<pre><code class="language-objectivec">VClass cptMetaVClass = (__bridge VClass)object_getClass([Computer class]);
class_rw_t *rwt = cptMetaVClass-&gt;data();

// LLDB:
// Printing description of rwt-&gt;methods-&gt;first:
// (method_t) first = {
//     name = &quot;arch&quot;
//     types = 0x0000000100000f86 &quot;@16@0:8&quot;
//     imp = 0x0000000100000d40 (DemoOC`::+[Computer arch]() at main.mm:52)
// }
</code></pre>

<p>å…ƒç±»å¯¹è±¡ä¸­é™¤äº†å­˜å‚¨ <code>isa</code> å’Œ <code>superclass</code> æŒ‡é’ˆï¼Œè¿˜å­˜å‚¨äº†ç±»æ–¹æ³•ã€‚å…¶å­˜æ”¾ä½ç½®å’Œç±»å¯¹è±¡å­˜æ”¾å®ä¾‹æ–¹æ³•çš„å­˜æ”¾ä½ç½®ï¼ˆæ–¹æ³•åˆ—è¡¨ï¼‰ä¸€è‡´ã€‚</p>

<h2 id="superclass">superclass</h2>

<p><img src="/img/2019/objects_in_obj-c/3.png" alt="3" /></p>

<h3 id="what">What</h3>

<p><code>superclass</code> æ˜¯ä»…å­˜åœ¨äºç±»å¯¹è±¡å’Œå…ƒç±»å¯¹è±¡çš„ä¸€ä¸ªæˆå‘˜ã€‚ç±»å¯¹è±¡ä¸­çš„ <code>superclass</code> æŒ‡å‘å½“å‰ç±»çš„çˆ¶ç±»ï¼Œå…ƒç±»å¯¹è±¡ä¸­çš„ <code>superclass</code> æŒ‡å‘è¯¥å…ƒç±»å¯¹è±¡çš„çˆ¶ç±»ã€‚åŸºç±» <code>NSObject</code> çš„ <code>superclass</code> æŒ‡å‘ <code>nil</code>ï¼Œæ ¹å…ƒç±»å¯¹è±¡çš„ <code>superclass</code> æŒ‡å‘åŸºç±» <code>NSObject</code> çš„ç±»å¯¹è±¡ã€‚</p>

<h3 id="isa-superclass">isa &amp; superclass</h3>

<p><code>isa</code> å°†å®ä¾‹å¯¹è±¡ä¸ç±»å¯¹è±¡ã€å…ƒç±»å¯¹è±¡è¿æ¥èµ·æ¥ï¼›<code>superclass</code> å°†å­ç±»ã€çˆ¶ç±»ã€åŸºç±»è¿æ¥èµ·æ¥ã€‚</p>

<p>å½“å‘ä¸€ä¸ªå®ä¾‹å‘é€å®ä¾‹æ–¹æ³•çš„æ¶ˆæ¯æ—¶ï¼ˆä¹Ÿå¯ç§°è°ƒç”¨å®ä¾‹æ–¹æ³•ï¼Œä½†å› ä¸º Obj-C æ˜¯æ¶ˆæ¯ç»“æ„çš„è¯­è¨€ï¼Œæ–¹æ³•è°ƒç”¨å¹¶ä¸ä¸¥è°¨ï¼‰ï¼Œè¯¥å®ä¾‹å¯¹è±¡ä¼šé€šè¿‡ <code>isa</code> æ‰¾åˆ°å…¶ç±»å¯¹è±¡ï¼Œå› ä¸ºå®ä¾‹æ–¹æ³•å­˜å‚¨åœ¨ç±»å¯¹è±¡ä¸­ï¼›å¦‚æœè¯¥ç±»çš„ç±»å¯¹è±¡ä¸­å¹¶æ²¡æœ‰å­˜å‚¨è¯¥å®ä¾‹æ–¹æ³•ï¼Œå…¶ç±»å¯¹è±¡å°†ä½¿ç”¨ <code>superclass</code> æ‰¾åˆ°å…¶çˆ¶ç±»çš„ç±»å¯¹è±¡ï¼Œå¹¶åœ¨å…¶ä¸­æŸ¥æ‰¾å®ä¾‹æ–¹æ³•ï¼›ç›´åˆ°åœ¨ <code>NSObject</code> åŸºç±»çš„ç±»å¯¹è±¡ä¹Ÿæ— æ³•æ‰¾åˆ°æ—¶ï¼Œ<code>superclass</code> å°†æŒ‡å‘ <code>nil</code> åœæ­¢æŸ¥æ‰¾ï¼ŒæŠ›å‡ºå¼‚å¸¸ï¼š<code>unrecognized selector sent to instance</code>ï¼ˆæ³¨æ„ï¼Œæˆ‘ä»¬è¿™é‡Œä»…è®¨è®ºæ¶ˆæ¯ä¼ é€’ï¼Œæš‚æ—¶å¿½ç•¥æ¶ˆæ¯è½¬å‘ï¼‰ã€‚</p>

<pre><code class="language-objectivec">@interface Computer : NSObject
- (void)run;
@end

@implementation Computer
@end

@interface Mac : Computer
@end

@implementation Mac
// - (void)run {
//     NSLog(@&quot;RUN&quot;);
// }
@end

// '-[Mac run]: unrecognized selector sent to instance 0x10330f6c0'
[[[Mac alloc] init] run];
</code></pre>

<p>å½“å‘ä¸€ä¸ªç±»ï¼ˆçš„ç±»å¯¹è±¡ï¼‰å‘é€ç±»æ–¹æ³•çš„æ¶ˆæ¯æ—¶ï¼Œä¸ä¼šç»è¿‡å®ä¾‹å¯¹è±¡ï¼›ç±»å¯¹è±¡ä¼šé€šè¿‡å…¶ <code>isa</code> æŒ‡é’ˆæ‰¾åˆ°å…¶å…ƒç±»å¯¹è±¡ï¼Œå› ä¸ºç±»æ–¹æ³•å­˜å‚¨åœ¨å…ƒç±»å¯¹è±¡ä¸­ï¼›å¦‚æœè¯¥ç±»çš„å…ƒç±»å¯¹è±¡ä¸­å¹¶æ²¡æœ‰å­˜å‚¨è¯¥ç±»æ–¹æ³•ï¼Œå…¶å…ƒç±»å¯¹è±¡å°†ä½¿ç”¨ <code>superclass</code> æ‰¾åˆ°å…¶çˆ¶ç±»çš„å…ƒç±»å¯¹è±¡ï¼Œå¹¶åœ¨å…¶ä¸­æŸ¥æ‰¾ç±»æ–¹æ³•ï¼›ç›´åˆ°æŸ¥æ‰¾åˆ° <code>NSObject</code> åŸºç±»çš„å…ƒç±»å¯¹è±¡è¿˜æ²¡æœ‰è¯¥ç±»æ–¹æ³•æ—¶ï¼Œ<code>NSObject</code> å…ƒç±»å¯¹è±¡çš„ <code>superclass</code> å°†æŒ‡å› <code>NSObject</code> ç±»å¯¹è±¡ä¸­ï¼Œåœ¨å…¶å­˜å‚¨çš„å®ä¾‹æ–¹æ³•åˆ—è¡¨ä¸­æŸ¥æ‰¾ï¼Œè‹¥æ­¤æ—¶è¿˜æ²¡æœ‰æ‰¾åˆ°å°†åœæ­¢æŸ¥æ‰¾ï¼Œå¹¶æŠ›å‡ºå¼‚å¸¸ï¼š<code>unrecognized selector sent to instance</code>ï¼Œå› ä¸º <code>NSObject</code> ç±»å¯¹è±¡çš„ <code>superclass</code> å°†æŒ‡å‘ <code>nil</code>ã€‚</p>

<pre><code class="language-objectivec">@interface NSObject (Extension)
@end

@implementation NSObject (Extension)
- (void)run {
    NSLog(@&quot;RUN&quot;);
}
@end

@interface Computer : NSObject
+ (void)run;
@end

@implementation Computer
@end

@interface Mac : Computer
@end

@implementation Mac
@end

// OUTPUT:
// RUN
</code></pre>

<p>é€šè¿‡ä¸Šä¸€ç‚¹ï¼Œå…¶å®æˆ‘ä»¬å¯ä»¥çŸ¥é“åœ¨ Obj-C ä¸­ï¼Œæ–¹æ³•æ˜¯é€šè¿‡æ¶ˆæ¯ä¼ é€’çš„ï¼Œè€Œä¼ é€’çš„å…¶å®å°±æ˜¯æ–¹æ³•åçš„å­—ç¬¦ä¸²ã€‚Obj-C çš„æ–¹æ³•åä¸­å¹¶ä¸åŒ…å«æ˜¯å¦ä¸ºå®ä¾‹æ–¹æ³•æˆ–ç±»æ–¹æ³•çš„æ ‡ç¤ºï¼Œç”šè‡³æ²¡æœ‰å‚æ•°å’Œè¿”å›å€¼çš„æ ‡ç¤ºï¼Œè¿™ä¹Ÿæ˜¯ä¸¥è°¨æ„ä¹‰ä¸Š Obj-C ä¸æ”¯æŒé‡è½½ï¼ˆOverloadï¼‰çš„åŸå› ï¼ˆä½†æ”¯æŒå‚æ•°ä¸ªæ•°ä¸åŒçš„é‡è½½ï¼‰ï¼Œå…·ä½“å¯å‚è€ƒ <a href="../override_and_overload_in_obj-c/">Obj-C ä¸­çš„é‡è½½ä¸é‡å†™</a>ä¸€æ–‡ã€‚</p>

<h2 id="reference">Reference</h2>

<ul>
<li><a href="../override_and_overload_in_obj-c/">Obj-C ä¸­çš„é‡è½½ä¸é‡å†™ - kingcos</a></li>
<li><a href="../isa_in_objc/">Obj-C ä¸­çš„ isa æŒ‡é’ˆ - kingcos</a></li>
</ul>

    </div>
    
      <div class="pagination">
        <div class="pagination__title">
          <span class="pagination__title-h">Read other posts</span>
          <hr />
        </div>
        <div class="pagination__buttons">
          
            <span class="button previous">
              <a href="/posts/2019/isa_in_objc/">
                <span class="button__icon">â†</span>
                <span class="button__text">Obj-C ä¸­çš„ isa æŒ‡é’ˆ</span>
              </a>
            </span>
          
          
            <span class="button next">
              <a href="/posts/2019/bit_field_union_in_cpp/">
                <span class="button__text">C/C&#43;&#43; ä¸­çš„ä½åŸŸä¸å…±ç”¨ä½“</span>
                <span class="button__icon">â†’</span>
              </a>
            </span>
          
        </div>
      </div>
    

    

    
    
    <div>
      <div id="github-comment">
      </div>

      <script type="text/javascript">
        function getUtterances(isDark) {
          var utterances = document.createElement('script');
          utterances.type = 'text/javascript';
          utterances.async = true;
          utterances.setAttribute('issue-term', "pathname")
          utterances.setAttribute('repo', "kingcos\/kingcos.github.io")
          utterances.setAttribute('label', "comments")
          isDark ? utterances.setAttribute('theme', "github-dark") : utterances.setAttribute('theme', "github-light")
          utterances.crossorigin = 'anonymous';
          utterances.src = 'https://utteranc.es/client.js';

          return utterances
        }

        var themeToggle = document.querySelector(".theme-toggle")
        themeToggle.addEventListener("click", function () {
          var getTheme = window.localStorage && window.localStorage.getItem("theme")
          var divNode = document.getElementById('github-comment')
          while(divNode.hasChildNodes()) {
            divNode.removeChild(divNode.firstChild);
          }
          
          
          

          
          
          
          
          
          
          document.getElementById('github-comment').appendChild(getUtterances(getTheme !== "dark"))
        })

        var getTheme = window.localStorage && window.localStorage.getItem("theme")
        document.getElementById('github-comment').appendChild(getUtterances(getTheme === "dark"))
      </script>
    </div>
    

    </div>

      </div>

      
        <footer class="footer">
  <div class="footer__inner">
    
      <div class="copyright copyright--user">Powered by github.com/kingcos</div>
    
  </div>
</footer>

<script src="/assets/main.js"></script>
<script src="/assets/prism.js"></script>


      
    </div>

    
      
<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
	(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
	m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
	})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
	ga('create', 'UA-138311951-1', 'auto');
	
	ga('send', 'pageview');
}
</script>

    
  </body>
</html>
