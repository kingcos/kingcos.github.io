<!DOCTYPE html>
<html lang="en">
  <head>
    
      <title>Obj-C ä¸­çš„å¯¹è±¡ :: iBlog</title>
    
    <meta http-equiv="content-type" content="text/html; charset=utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">
<meta name="description" content="Date Notes Refer.     2019-03-18 é¦–æ¬¡æäº¤ objc4-750   2019-08-18 æŠ½ç¦» isa éƒ¨åˆ†ï¼›
é‡æ•´æ–‡ç« ç»“æ„ Obj-C ä¸­çš„ isa æŒ‡é’ˆ - kingcos   2019-08-29 å¢åŠ  class_rw_t ç­‰ç»†èŠ‚ -   2019-12-23 ç»†èŠ‚å¾®è°ƒ objc4-756.2    Preface Obj-C ä¸­çš„å¯¹è±¡åˆ†ä¸ºå®ä¾‹å¯¹è±¡ï¼ˆInstance Objectï¼‰ã€ç±»å¯¹è±¡ï¼ˆClass Objectï¼‰ã€ä»¥åŠå…ƒç±»å¯¹è±¡ï¼ˆMeta-class Objectï¼‰ä¸‰ç§ï¼Œæœ¬æ–‡å°†å€ŸåŠ©æºç ç®€å•äº†è§£ä¸€ä¸‹ä¸åŒç±»å‹å¯¹è±¡çš„çœŸå®æ„é€ ã€‚
ä¸ºäº†æ–¹ä¾¿ä¸‹æ–‡ä¸¾ä¾‹ï¼Œè¿™é‡Œæˆ‘ä»¬å®šä¹‰ä¸€ä¸ª EDdeviceProtocol åè®®ï¼Œå¹¶è®©ç»§æ‰¿è‡ª NSObject çš„ Computer ç±»éµå®ˆè¯¥åè®®ï¼š
// EDdeviceProtocol åè®® @protocol EDdeviceProtocol - (void)powerOn; @end // Computer ç±»ï¼Œç»§æ‰¿è‡ª NSObjectï¼Œéµå®ˆ EDdeviceProtocol @interface Computer : NSObject &amp;lt;EDdeviceProtocol&amp;gt; { // æˆå‘˜å˜é‡ @public int _memorySize; int _diskSize; } // å±æ€§ @property (copy) NSString *model; // å®ä¾‹æ–¹æ³• - (void)print:(NSString *)content; // ç±»æ–¹æ³• &#43; (NSString *)arch; @end @implementation Computer - (void)print:(NSString *)content { NSLog(@&amp;#34;Print content: %@."/>
<meta name="keywords" content="kingcos.me,maimieng.comios,swift,objective-c,obj-c,objc,oc,geek,python,ruby,golang,go,apple,mac"/>
<meta name="robots" content="noodp"/>
<link rel="canonical" href="/posts/2019/objects_in_obj-c/" />





<link rel="stylesheet" href="/assets/style.css">


<link rel="stylesheet" href="/style.css">


<link rel="apple-touch-icon-precomposed" sizes="144x144" href="/img/apple-touch-icon-144-precomposed.png">
<link rel="shortcut icon" href="/img/favicon.png">


<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Obj-C ä¸­çš„å¯¹è±¡"/>
<meta name="twitter:description" content="Obj-C ä¸­çš„å¯¹è±¡åˆ†ä¸ºå®ä¾‹å¯¹è±¡ã€ç±»å¯¹è±¡ã€ä»¥åŠå…ƒç±»å¯¹è±¡ä¸‰ç§ï¼Œæœ¬æ–‡å°†å€ŸåŠ©æºç ç®€å•äº†è§£ä¸€ä¸‹ä¸åŒç±»å‹å¯¹è±¡çš„çœŸå®æ„é€ ã€‚"/>



<meta property="og:title" content="Obj-C ä¸­çš„å¯¹è±¡" />
<meta property="og:description" content="Obj-C ä¸­çš„å¯¹è±¡åˆ†ä¸ºå®ä¾‹å¯¹è±¡ã€ç±»å¯¹è±¡ã€ä»¥åŠå…ƒç±»å¯¹è±¡ä¸‰ç§ï¼Œæœ¬æ–‡å°†å€ŸåŠ©æºç ç®€å•äº†è§£ä¸€ä¸‹ä¸åŒç±»å‹å¯¹è±¡çš„çœŸå®æ„é€ ã€‚" />
<meta property="og:type" content="article" />
<meta property="og:url" content="/posts/2019/objects_in_obj-c/" />
<meta property="article:published_time" content="2019-12-23T00:00:00+00:00" />
<meta property="article:modified_time" content="2019-12-23T00:00:00+00:00" /><meta property="og:site_name" content="iBlog" />




<script data-ad-client="ca-pub-9925978992661955" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>

  </head>
  <body class="dark-theme">
    <div class="container">
      <header class="header">
  <span class="header__inner">
    <a href="/" class="logo" style="text-decoration: none;">
  
    <span class="logo__mark"><svg xmlns="http://www.w3.org/2000/svg" class="greater-icon" viewBox="0 0 44 44">
  <path fill="none" d="M15 8l14.729 14.382L15 35.367"/>
</svg>
</span>
    <span class="logo__text">kingcos.me</span>
    <span class="logo__cursor"></span>
  
</a>

    <span class="header__right">
      
        <nav class="menu">
  <ul class="menu__inner menu__inner--desktop">
    
      
        
          <li><a href="/about">About</a></li>
        
      
        
          <li><a href="/links">Links</a></li>
        
      
        
          <li><a href="/perspective">Perspective</a></li>
        
      
        
          <li><a href="/words">Words</a></li>
        
      
      
    
  </ul>

  <ul class="menu__inner menu__inner--mobile">
    
      
        <li><a href="/about">About</a></li>
      
    
      
        <li><a href="/links">Links</a></li>
      
    
      
        <li><a href="/perspective">Perspective</a></li>
      
    
      
        <li><a href="/words">Words</a></li>
      
    
  </ul>
</nav>

        <span class="menu-trigger">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
            <path d="M0 0h24v24H0z" fill="none"/>
            <path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"/>
          </svg>
        </span>
      
      <span class="theme-toggle">
        <svg class="theme-toggler" width="24" height="24" viewBox="0 0 48 48" fill="none" xmlns="http://www.w3.org/2000/svg">
  <path d="M22 41C32.4934 41 41 32.4934 41 22C41 11.5066 32.4934 3 22
  3C11.5066 3 3 11.5066 3 22C3 32.4934 11.5066 41 22 41ZM7 22C7
  13.7157 13.7157 7 22 7V37C13.7157 37 7 30.2843 7 22Z"/>
</svg>

      </span>
    </span>
  </span>
</header>


      <div class="content">
        
  <div class="post">
    <h2 class="post-title"><a href="/posts/2019/objects_in_obj-c/">Obj-C ä¸­çš„å¯¹è±¡</a></h2>
    <div class="post-meta">
      
        <span class="post-date">
            2019-12-23
        </span>
      
      
      
        <span class="post-read-time">â€” 10 min read</span>
      
    </div>

    
      <span class="post-tags">
        
          #<a href="/tags/focus/">Focus</a>&nbsp;
        
          #<a href="/tags/ios/">iOS</a>&nbsp;
        
          #<a href="/tags/obj-c/">Obj-C</a>&nbsp;
        
          #<a href="/tags//">ğŸŒŸ</a>&nbsp;
        
      </span>
    

    

    <div class="post-content">
      <table>
<thead>
<tr>
<th align="center">Date</th>
<th align="center">Notes</th>
<th align="center">Refer.</th>
</tr>
</thead>
<tbody>
<tr>
<td align="center">2019-03-18</td>
<td align="center">é¦–æ¬¡æäº¤</td>
<td align="center"><a href="https://opensource.apple.com/tarballs/objc4/">objc4-750</a></td>
</tr>
<tr>
<td align="center">2019-08-18</td>
<td align="center">æŠ½ç¦» <code>isa</code> éƒ¨åˆ†ï¼›<br>é‡æ•´æ–‡ç« ç»“æ„</td>
<td align="center"><a href="../isa_in_objc/">Obj-C ä¸­çš„ isa æŒ‡é’ˆ - kingcos</a></td>
</tr>
<tr>
<td align="center">2019-08-29</td>
<td align="center">å¢åŠ  <code>class_rw_t</code> ç­‰ç»†èŠ‚</td>
<td align="center">-</td>
</tr>
<tr>
<td align="center">2019-12-23</td>
<td align="center">ç»†èŠ‚å¾®è°ƒ</td>
<td align="center"><a href="https://opensource.apple.com/tarballs/objc4/">objc4-756.2</a></td>
</tr>
</tbody>
</table>
<p><img src="/img/2019/objects_in_obj-c/0.png" alt="0"></p>
<h2 id="preface">Preface</h2>
<p>Obj-C ä¸­çš„å¯¹è±¡åˆ†ä¸ºå®ä¾‹å¯¹è±¡ï¼ˆInstance Objectï¼‰ã€ç±»å¯¹è±¡ï¼ˆClass Objectï¼‰ã€ä»¥åŠå…ƒç±»å¯¹è±¡ï¼ˆMeta-class Objectï¼‰ä¸‰ç§ï¼Œæœ¬æ–‡å°†å€ŸåŠ©æºç ç®€å•äº†è§£ä¸€ä¸‹ä¸åŒç±»å‹å¯¹è±¡çš„çœŸå®æ„é€ ã€‚</p>
<p><img src="/img/2019/objects_in_obj-c/1.png" alt="1"></p>
<p>ä¸ºäº†æ–¹ä¾¿ä¸‹æ–‡ä¸¾ä¾‹ï¼Œè¿™é‡Œæˆ‘ä»¬å®šä¹‰ä¸€ä¸ª <code>EDdeviceProtocol</code> åè®®ï¼Œå¹¶è®©ç»§æ‰¿è‡ª <code>NSObject</code> çš„ <code>Computer</code> ç±»éµå®ˆè¯¥åè®®ï¼š</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-objectivec" data-lang="objectivec"><span style="color:#75715e">// EDdeviceProtocol åè®®
</span><span style="color:#75715e"></span><span style="color:#66d9ef">@protocol</span> <span style="color:#a6e22e">EDdeviceProtocol</span>
- (<span style="color:#66d9ef">void</span>)<span style="color:#a6e22e">powerOn</span>;
<span style="color:#66d9ef">@end</span>

<span style="color:#75715e">// Computer ç±»ï¼Œç»§æ‰¿è‡ª NSObjectï¼Œéµå®ˆ EDdeviceProtocol
</span><span style="color:#75715e"></span><span style="color:#66d9ef">@interface</span> <span style="color:#a6e22e">Computer</span> : <span style="color:#a6e22e">NSObject</span> <span style="color:#f92672">&lt;</span>EDdeviceProtocol<span style="color:#f92672">&gt;</span> {
<span style="color:#75715e">// æˆå‘˜å˜é‡
</span><span style="color:#75715e"></span><span style="color:#66d9ef">@public</span>
    <span style="color:#66d9ef">int</span> _memorySize;
    <span style="color:#66d9ef">int</span> _diskSize;
}

<span style="color:#75715e">// å±æ€§
</span><span style="color:#75715e"></span><span style="color:#66d9ef">@property</span> (<span style="color:#66d9ef">copy</span>) NSString <span style="color:#f92672">*</span>model;

<span style="color:#75715e">// å®ä¾‹æ–¹æ³•
</span><span style="color:#75715e"></span>- (<span style="color:#66d9ef">void</span>)<span style="color:#a6e22e">print:</span>(NSString <span style="color:#f92672">*</span>)content;

<span style="color:#75715e">// ç±»æ–¹æ³•
</span><span style="color:#75715e"></span>+ (NSString <span style="color:#f92672">*</span>)<span style="color:#a6e22e">arch</span>;
<span style="color:#66d9ef">@end</span>

<span style="color:#66d9ef">@implementation</span> <span style="color:#a6e22e">Computer</span>
- (<span style="color:#66d9ef">void</span>)<span style="color:#a6e22e">print:</span>(NSString <span style="color:#f92672">*</span>)content {
    NSLog(<span style="color:#e6db74">@&#34;</span><span style="color:#e6db74">Print content: %@.</span><span style="color:#e6db74">&#34;</span>, content);
}

<span style="color:#75715e">// åè®®æ–¹æ³•
</span><span style="color:#75715e"></span>- (<span style="color:#66d9ef">void</span>)<span style="color:#a6e22e">powerOn</span> {
    NSLog(<span style="color:#e6db74">@&#34;</span><span style="color:#e6db74">%s</span><span style="color:#e6db74">&#34;</span>, __func__);
}

+ (NSString <span style="color:#f92672">*</span>)<span style="color:#a6e22e">arch</span> {
    <span style="color:#66d9ef">return</span> <span style="color:#e6db74">@&#34;</span><span style="color:#e6db74">ARM 64</span><span style="color:#e6db74">&#34;</span>;
}
<span style="color:#66d9ef">@end</span>
</code></pre></div><h2 id="heading">å®ä¾‹å¯¹è±¡</h2>
<p>æˆ‘ä»¬åˆ›å»ºä¸€ä¸ª <code>Computer</code> ç±»å‹çš„å®ä¾‹å¯¹è±¡ï¼Œå¹¶å¯¹å…¶ä¸­çš„æˆå‘˜å˜é‡èµ‹å€¼ï¼š</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-objectivec" data-lang="objectivec"><span style="color:#75715e">// cpt ä¸ºæŒ‡å‘ Computer ç±»å‹å®ä¾‹å¯¹è±¡çš„æŒ‡é’ˆ
</span><span style="color:#75715e"></span>Computer <span style="color:#f92672">*</span>cpt <span style="color:#f92672">=</span> [[Computer alloc] init];

<span style="color:#75715e">// ERROR: Direct access to Objective-C&#39;s isa is deprecated in favor of object_getClass()
</span><span style="color:#75715e"></span><span style="color:#75715e">// cpt-&gt;isa;
</span><span style="color:#75715e"></span>
cpt<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>_memorySize <span style="color:#f92672">=</span> <span style="color:#ae81ff">16</span>;
cpt<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>_diskSize <span style="color:#f92672">=</span> <span style="color:#ae81ff">512</span>;

cpt.model <span style="color:#f92672">=</span> <span style="color:#e6db74">@&#34;</span><span style="color:#e6db74">MacBook Pro 13&#39;</span><span style="color:#e6db74">&#34;</span>;
</code></pre></div><p>æˆ‘ä»¬åœ¨ç¨‹åºç»“æŸå‰çš„ <code>return 0;</code> ä¸€è¡Œæ‰“ä¸ªæ–­ç‚¹ï¼Œå³å¯çœ‹åˆ° <code>cpt</code> æŒ‡å‘çš„å®ä¾‹å¯¹è±¡ä¸­å­˜å‚¨çš„æ•°æ®ï¼š</p>
<p><img src="/img/2019/objects_in_obj-c/5.png" alt="5"></p>
<p>å…¶ä¸­å­˜æ”¾äº† <code>isa</code> æŒ‡é’ˆæˆå‘˜å˜é‡ï¼ˆä½†æ— æ³•ç›´æ¥è®¿é—®ï¼‰ä»¥åŠå…¶å®ƒæˆå‘˜å˜é‡çš„å…·ä½“å€¼ã€‚<code>isa</code> å¹¶ä¸æ˜¯å¼€å‘è€…è‡ªå·±å®šä¹‰çš„ï¼Œè€Œæ˜¯ç»§æ‰¿è‡ª <code>NSObject</code> åŸºç±»ã€‚</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-objectivec" data-lang="objectivec"><span style="color:#75715e">// NSObject.h
</span><span style="color:#75715e"></span>
<span style="color:#66d9ef">@interface</span> <span style="color:#a6e22e">NSObject</span> <span style="color:#f92672">&lt;</span>NSObject<span style="color:#f92672">&gt;</span> {
<span style="color:#75715e">#</span><span style="color:#75715e">pragma clang diagnostic push</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">#</span><span style="color:#75715e">pragma clang diagnostic ignored &#34;-Wobjc-interface-ivars&#34;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">Class</span> isa  OBJC_ISA_AVAILABILITY;
<span style="color:#75715e">#</span><span style="color:#75715e">pragma clang diagnostic pop</span><span style="color:#75715e">
</span><span style="color:#75715e"></span>}
</code></pre></div><h2 id="heading-1">ç±»å¯¹è±¡</h2>
<p>æˆ‘ä»¬çŸ¥é“ï¼Œåªè¦åˆ›å»ºçš„å®ä¾‹å¯¹è±¡å±äºåŒä¸€ä¸ªç±»ï¼Œé‚£ä¹ˆå®ƒä»¬å°±éƒ½å¯ä»¥è°ƒç”¨è¯¥ç±»çš„å®ä¾‹æ–¹æ³•ï¼Œå› æ­¤è¿™äº›æ–¹æ³•å…¶å®å¹¶ä¸éœ€è¦æ¯ä¸ªå®ä¾‹å¯¹è±¡éƒ½å•ç‹¬ä¿å­˜ä¸€ä»½ã€‚åœ¨ Obj-C ä¸­ï¼Œå®ä¾‹æ–¹æ³•å­˜æ”¾åœ¨ç±»å¯¹è±¡ä¸­ï¼Œç±»æ–¹æ³•å­˜å‚¨åœ¨å…ƒç±»å¯¹è±¡ä¸­ã€‚ä¸å®ä¾‹å¯¹è±¡ä¸åŒï¼Œç±»å¯¹è±¡å’Œå…ƒç±»å¯¹è±¡å¹¶ä¸éœ€è¦å¼€å‘è€…æ‰‹åŠ¨åˆ›å»ºã€‚ç±»å¯¹è±¡å¯ä»¥é€šè¿‡ <code>[cpt class]</code>ã€<code>[Computer class]</code> æˆ– Runtime API <code>object_getClass</code> è·å–ï¼š</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-objectivec" data-lang="objectivec"><span style="color:#75715e">// è·å–ç±»å¯¹è±¡çš„æ–¹æ³•ï¼š
</span><span style="color:#75715e"></span><span style="color:#66d9ef">Class</span> cptClass1 <span style="color:#f92672">=</span> [cpt <span style="color:#66d9ef">class</span>];
<span style="color:#66d9ef">Class</span> cptClass2 <span style="color:#f92672">=</span> [Computer <span style="color:#66d9ef">class</span>];
<span style="color:#66d9ef">Class</span> cptClass3 <span style="color:#f92672">=</span> object_getClass(cpt);

<span style="color:#75715e">// LLDB:
</span><span style="color:#75715e"></span><span style="color:#75715e">// (lldb) p/x cptClass1
</span><span style="color:#75715e"></span><span style="color:#75715e">// (Class) $0 = 0x00000001000013d0 Computer
</span><span style="color:#75715e"></span><span style="color:#75715e">// (lldb) p/x cptClass2
</span><span style="color:#75715e"></span><span style="color:#75715e">// (Class) $1 = 0x00000001000013d0 Computer
</span><span style="color:#75715e"></span><span style="color:#75715e">// (lldb) p/x cptClass3
</span><span style="color:#75715e"></span><span style="color:#75715e">// (Class) $2 = 0x00000001000013d0 Computer
</span></code></pre></div><p>ç±»å¯¹è±¡çš„ç±»å‹æ˜¯ <code>Class</code>ï¼Œæœ¬è´¨æ˜¯æŒ‡å‘ <code>objc_class</code> ç»“æ„ä½“çš„æŒ‡é’ˆã€‚<code>objc_class</code> ç»“æ„ä½“ä¸­å­˜æ”¾äº† <code>isa</code>ã€<code>superclass</code>ã€æ–¹æ³•ç¼“å­˜ã€ä»¥åŠä¸ºè¯¥ç±»å®ä¾‹å¯¹è±¡æ‰€å…¬ç”¨çš„ä¸€äº›ä¿¡æ¯ï¼š</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-objectivec" data-lang="objectivec"><span style="color:#75715e">// Object.mm
</span><span style="color:#75715e"></span>
<span style="color:#66d9ef">typedef</span> <span style="color:#66d9ef">struct</span> objc_class <span style="color:#f92672">*</span><span style="color:#66d9ef">Class</span>;

<span style="color:#75715e">// objc-runtime-new.h
</span><span style="color:#75715e"></span><span style="color:#66d9ef">struct</span> objc_class : objc_object {
    <span style="color:#75715e">// Class ISA;
</span><span style="color:#75715e"></span>    <span style="color:#75715e">// çˆ¶ç±»æŒ‡é’ˆ
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">Class</span> superclass;
    <span style="color:#75715e">// æ–¹æ³•ç¼“å­˜ï¼Œè¯¦è§ Reference
</span><span style="color:#75715e"></span>    cache_t cache;             <span style="color:#75715e">// formerly cache pointer and vtable
</span><span style="color:#75715e"></span>    <span style="color:#75715e">// å¯è¯»å¯å†™è¡¨ï¼ˆclass_rw_tï¼‰ç­‰
</span><span style="color:#75715e"></span>    class_data_bits_t bits;    <span style="color:#75715e">// class_rw_t * plus custom rr/alloc flags
</span><span style="color:#75715e"></span>
    <span style="color:#75715e">// ...
</span><span style="color:#75715e"></span>};

<span style="color:#75715e">// objc-private.h
</span><span style="color:#75715e"></span><span style="color:#66d9ef">struct</span> objc_object {
private:
    <span style="color:#75715e">// isa æŒ‡é’ˆ
</span><span style="color:#75715e"></span>    isa_t isa;

<span style="color:#75715e">// ...
</span><span style="color:#75715e"></span>}
</code></pre></div><h3 id="class-data-bits-t">class_data_bits_t</h3>
<p>å…ˆæ¥çœ‹çœ‹ <code>objc_class</code> ä¸­çš„ <code>class_data_bits_t</code>ï¼š</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-objectivec" data-lang="objectivec"><span style="color:#75715e">// objc-runtime-new.h
</span><span style="color:#75715e"></span>
<span style="color:#66d9ef">struct</span> objc_class : objc_object {
    <span style="color:#75715e">// objc_class ä¸­çš„ data æ–¹æ³•ï¼Œè¿”å›æŒ‡å‘ class_rw_t çš„æŒ‡é’ˆ
</span><span style="color:#75715e"></span>    class_rw_t <span style="color:#f92672">*</span>data() {
        <span style="color:#75715e">// bits å³ objc_class ä¸­ class_data_bits_t ç»“æ„ä½“ç±»å‹çš„æˆå‘˜å˜é‡
</span><span style="color:#75715e"></span>        <span style="color:#66d9ef">return</span> bits.data();
    }

    <span style="color:#75715e">// ...
</span><span style="color:#75715e"></span>}

<span style="color:#75715e">#</span><span style="color:#75715e">if !__LP64__</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">// é 64 ä½ï¼Œè·³è¿‡
</span><span style="color:#75715e"></span><span style="color:#75715e">#</span><span style="color:#75715e">elif 1</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">// class is a Swift class from the pre-stable Swift ABI
</span><span style="color:#75715e"></span><span style="color:#75715e">#</span><span style="color:#75715e">define FAST_IS_SWIFT_LEGACY    (1UL&lt;&lt;0)</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">// class is a Swift class from the stable Swift ABI
</span><span style="color:#75715e"></span><span style="color:#75715e">#</span><span style="color:#75715e">define FAST_IS_SWIFT_STABLE    (1UL&lt;&lt;1)</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">// class or superclass has default retain/release/autorelease/retainCount/
</span><span style="color:#75715e"></span><span style="color:#75715e">//   _tryRetain/_isDeallocating/retainWeakReference/allowsWeakReference
</span><span style="color:#75715e"></span><span style="color:#75715e">#</span><span style="color:#75715e">define FAST_HAS_DEFAULT_RR     (1UL&lt;&lt;2)</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">// data pointer
</span><span style="color:#75715e"></span><span style="color:#75715e">#</span><span style="color:#75715e">define FAST_DATA_MASK          0x00007ffffffffff8UL</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">#</span><span style="color:#75715e">else</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">// ä¸ä¼šè½åˆ°è¯¥ case ä¸‹ï¼Œè·³è¿‡
</span><span style="color:#75715e"></span><span style="color:#75715e">#</span><span style="color:#75715e">endif</span><span style="color:#75715e">
</span><span style="color:#75715e"></span>
<span style="color:#66d9ef">struct</span> class_data_bits_t {
    <span style="color:#75715e">// Values are the FAST_ flags above.
</span><span style="color:#75715e"></span>    uintptr_t bits;

    class_rw_t<span style="color:#f92672">*</span> <span style="color:#a6e22e">data</span>() {
        <span style="color:#66d9ef">return</span> (class_rw_t <span style="color:#f92672">*</span>)(bits <span style="color:#f92672">&amp;</span> FAST_DATA_MASK);
    }

    <span style="color:#75715e">// ...
</span><span style="color:#75715e"></span>}

<span style="color:#75715e">// sys/_types/_uintptr_t.h
</span><span style="color:#75715e"></span><span style="color:#66d9ef">typedef</span> <span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">long</span>           uintptr_t;
</code></pre></div><p>å¦‚ä¸Šï¼Œ<code>class_data_bits_t</code> ç»“æ„ä½“ä¸­åªæœ‰ä¸€ä¸ª <code>uintptr_t bits</code> æˆå‘˜å˜é‡ï¼Œå…¶æœ¬è´¨æ˜¯ <code>unsigned long</code> ç±»å‹ï¼Œå ç”¨ 8 ä¸ªå­—èŠ‚ï¼Œå³ 64 ä½ã€‚ä½†å…¶å­˜å‚¨æ–¹å¼ç±»ä¼¼ä½åŸŸï¼Œå°†ä¸åŒçš„æ•°æ®å­˜å‚¨åœ¨ä¸åŒçš„ä½ä¸­ï¼ˆå…³äºä½åŸŸå¯è¯¦è§ã€Š<a href="../bit_field_union_in_cpp/">C/C++ ä¸­çš„ä½åŸŸä¸å…±ç”¨ä½“</a>ã€‹ä¸€æ–‡ï¼‰ï¼š</p>
<table>
<thead>
<tr>
<th align="center">Bits</th>
<th align="center">Explanation</th>
</tr>
</thead>
<tbody>
<tr>
<td align="center">0 ~ 1</td>
<td align="center"><code>FAST_IS_SWIFT_LEGACY</code>ï¼šæ ‡å¿—è¯¥ç±»æ˜¯å¦æ¥è‡ªäº ABI <strong>é¢„</strong>ç¨³å®šç‰ˆæœ¬çš„ Swift</td>
</tr>
<tr>
<td align="center">1 ~ 2</td>
<td align="center"><code>FAST_IS_SWIFT_STABLE</code>ï¼šæ ‡å¿—è¯¥ç±»æ˜¯å¦æ¥è‡ªäº ABI ç¨³å®šç‰ˆæœ¬çš„ Swift</td>
</tr>
<tr>
<td align="center">2 ~ 3</td>
<td align="center"><code>FAST_HAS_DEFAULT_RR</code>ï¼šç±»æˆ–çˆ¶ç±»å«æœ‰é»˜è®¤çš„æŒæœ‰æˆ–å¼•ç”¨ï¼ˆRetain / Referenceï¼‰<code>retain</code>/<code>release</code>/<code>autorelease</code>/<code>retainCount</code>/<code>_tryRetain</code>/<code>_isDeallocating</code>/<code>retainWeakReference</code>/<code>allowsWeakReference</code></td>
</tr>
<tr>
<td align="center">3 ~ 47</td>
<td align="center"><code>FAST_DATA_MASK</code>ï¼šæŒ‡å‘ <code>class_rw_t</code> ç»“æ„ä½“çš„æŒ‡é’ˆ</td>
</tr>
<tr>
<td align="center">47 ~ 63</td>
<td align="center">ä¸ºäº†å­—èŠ‚å¯¹é½ï¼Œæ©ç å¡«å…… 0</td>
</tr>
</tbody>
</table>
<h3 id="class-rw-t">class_rw_t</h3>
<p><code>class_rw_t</code> æŒ‡çš„æ˜¯å¯è¯»å¯å†™ï¼ˆRead-Writeï¼‰è¡¨ã€‚è¯¥ç»“æ„ä½“ä¸­å­˜å‚¨äº†æŒ‡å‘ <code>class_ro_t</code> åªè¯»è¡¨çš„æŒ‡é’ˆã€ä»¥åŠæ–¹æ³•ã€å±æ€§ã€åè®®ç­‰ä¿¡æ¯ï¼š</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-objectivec" data-lang="objectivec"><span style="color:#75715e">// objc-runtime-new.h
</span><span style="color:#75715e"></span>
<span style="color:#75715e">// å¯è¯»å¯å†™è¡¨
</span><span style="color:#75715e"></span><span style="color:#66d9ef">struct</span> class_rw_t {
    <span style="color:#75715e">// Be warned that Symbolication knows the layout of this structure.
</span><span style="color:#75715e"></span>    uint32_t flags;
    uint32_t version;

    <span style="color:#75715e">// åªè¯»è¡¨çš„æŒ‡é’ˆï¼ˆconstï¼šä¸å¯ä¿®æ”¹æŒ‡é’ˆæŒ‡å‘å†…å­˜ç©ºé—´ä¸­çš„æ•°æ®ï¼‰
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">const</span> class_ro_t <span style="color:#f92672">*</span>ro;

    <span style="color:#75715e">// æ–¹æ³•ã€å±æ€§ã€åè®®ä¿¡æ¯
</span><span style="color:#75715e"></span>    method_array_t methods;
    property_array_t properties;
    protocol_array_t protocols;

    <span style="color:#75715e">// ...
</span><span style="color:#75715e"></span>};
</code></pre></div><p>å…¶ä¸­ <code>method_array_t</code>ã€<code>property_array_t</code> ä¸ <code>protocol_array_t</code> ç±»å‹çš„ç»“æ„å‡ ä¹ä¸€è‡´ï¼Œè¿™é‡Œä»¥ <code>method_array_t</code> ä¸ºä¾‹ï¼š</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp"><span style="color:#75715e">// objc-runtime-new.h
</span><span style="color:#75715e"></span>
<span style="color:#75715e">// method_array_t ç»§æ‰¿è‡ª list_array_ttï¼Œå…¶ä¸­ List ç±»å‹ä¸º method_list_tï¼ŒElement ç±»å‹ä¸º method_t
</span><span style="color:#75715e"></span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">method_array_t</span> <span style="color:#f92672">:</span>
    <span style="color:#66d9ef">public</span> list_array_tt<span style="color:#f92672">&lt;</span>method_t, method_list_t<span style="color:#f92672">&gt;</span>
{
    <span style="color:#75715e">// ...
</span><span style="color:#75715e"></span>};

<span style="color:#75715e">// list_array_tt ä¸­å®šä¹‰äº†å…ƒç´ ç±»å‹ä¸º Elementï¼Œåˆ—è¡¨ä¸º List
</span><span style="color:#75715e"></span><span style="color:#66d9ef">template</span> <span style="color:#f92672">&lt;</span><span style="color:#66d9ef">typename</span> Element, <span style="color:#66d9ef">typename</span> List<span style="color:#f92672">&gt;</span>
<span style="color:#66d9ef">class</span> <span style="color:#a6e22e">list_array_tt</span> {
    <span style="color:#75715e">// ...
</span><span style="color:#75715e"></span>};

<span style="color:#75715e">// method_t å³æ˜¯ Obj-C ä¸­æ–¹æ³•çš„ç»“æ„ï¼ˆè¯¦è§ä¸‹æ–‡ï¼‰
</span><span style="color:#75715e"></span><span style="color:#66d9ef">struct</span> <span style="color:#a6e22e">method_t</span> {
    SEL name;
    <span style="color:#66d9ef">const</span> <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>types;
    MethodListIMP imp;

    <span style="color:#75715e">// ...
</span><span style="color:#75715e"></span>};

<span style="color:#75715e">// method_list_t ç»§æ‰¿è‡ª entsize_list_ttï¼Œå…¶ä¸­ List ç±»å‹ä¸º method_list_tï¼ŒElement ç±»å‹ä¸º method_t
</span><span style="color:#75715e"></span><span style="color:#66d9ef">struct</span> <span style="color:#a6e22e">method_list_t</span> <span style="color:#f92672">:</span> entsize_list_tt<span style="color:#f92672">&lt;</span>method_t, method_list_t, <span style="color:#ae81ff">0x3</span><span style="color:#f92672">&gt;</span> {
    <span style="color:#75715e">// ...
</span><span style="color:#75715e"></span>};

<span style="color:#75715e">// entsize_list_tt æ˜¯éè„†å¼±ï¼ˆNon-fragileï¼‰ç»“æ„ä½“æ•°ç»„çš„ä¸€èˆ¬å®ç°
</span><span style="color:#75715e"></span><span style="color:#66d9ef">template</span> <span style="color:#f92672">&lt;</span><span style="color:#66d9ef">typename</span> Element, <span style="color:#66d9ef">typename</span> List, <span style="color:#66d9ef">uint32_t</span> FlagMask<span style="color:#f92672">&gt;</span>
<span style="color:#66d9ef">struct</span> <span style="color:#a6e22e">entsize_list_tt</span> {
    <span style="color:#75715e">// ...
</span><span style="color:#75715e"></span>};
</code></pre></div><p>ç”±äº Obj-C ä¸­çš„ <code>Class</code> æ˜¯ä¸€ä¸ªä¸é€æ˜ç±»å‹ï¼Œä½†æˆ‘ä»¬å¯ä»¥å°è¯•ä¸€ä¸‹å°†ç±»å¯¹è±¡çš„åŸå§‹ç»“æ„æ¡¥æ¥åˆ°å…¶ä¸­ï¼Œé¦–å…ˆéœ€è¦å°†ä»¥ä¸‹æˆ‘æ•´ç†å¥½çš„å†…å®¹æ”¾åœ¨ <code>.h</code> å¼•å…¥ï¼Œéœ€è¦æ³¨æ„çš„æ˜¯å¼•å…¥çš„å®ç°æ–‡ä»¶éœ€è¦æ”¯æŒ C++ï¼Œå³ä»¥ <code>.mm</code> ç»“å°¾ï¼š</p>
<details>
<summary>-> ç‚¹å‡»æ­¤å¤„å³å¯æŸ¥çœ‹å®Œæ•´å†…å®¹ <-</summary>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp"><span style="color:#75715e">//
</span><span style="color:#75715e"></span><span style="color:#75715e">//  class_details.h
</span><span style="color:#75715e"></span><span style="color:#75715e">//  Powered by kingcos.me
</span><span style="color:#75715e"></span><span style="color:#75715e">//
</span><span style="color:#75715e"></span><span style="color:#75715e">//  Created by kingcos on 2019/8/31.
</span><span style="color:#75715e"></span><span style="color:#75715e">//  Copyright Â© 2019 kingcos. All rights reserved.
</span><span style="color:#75715e"></span><span style="color:#75715e">//
</span><span style="color:#75715e"></span>
<span style="color:#75715e">#</span><span style="color:#75715e">ifndef class_details_h</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">#</span><span style="color:#75715e">define class_details_h</span><span style="color:#75715e">
</span><span style="color:#75715e"></span>
<span style="color:#75715e">#</span><span style="color:#75715e">define FAST_DATA_MASK          0x00007ffffffffff8UL</span><span style="color:#75715e">
</span><span style="color:#75715e"></span>
<span style="color:#66d9ef">typedef</span> <span style="color:#66d9ef">struct</span> <span style="color:#a6e22e">v_objc_class</span> <span style="color:#f92672">*</span>V_Class;
<span style="color:#66d9ef">typedef</span> <span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">long</span> v_uintptr_t;
<span style="color:#66d9ef">typedef</span> v_uintptr_t v_cache_key_t;
<span style="color:#66d9ef">typedef</span> <span style="color:#66d9ef">uint32_t</span> v_mask_t;
<span style="color:#66d9ef">typedef</span> v_uintptr_t v_protocol_ref_t;

<span style="color:#66d9ef">struct</span> <span style="color:#a6e22e">v_bucket_t</span> {
    IMP _imp;
    v_cache_key_t _key;
};

<span style="color:#66d9ef">struct</span> <span style="color:#a6e22e">v_cache_t</span> {
    <span style="color:#66d9ef">struct</span> <span style="color:#a6e22e">v_bucket_t</span> <span style="color:#f92672">*</span>_buckets;
    v_mask_t _mask;
    v_mask_t _occupied;
};

<span style="color:#66d9ef">union</span> <span style="color:#a6e22e">v_isa_t</span> {
    V_Class cls;
    v_uintptr_t bits;
};

<span style="color:#66d9ef">struct</span> <span style="color:#a6e22e">v_objc_object</span> {
    v_isa_t isa;
};

<span style="color:#66d9ef">template</span> <span style="color:#f92672">&lt;</span><span style="color:#66d9ef">typename</span> Element, <span style="color:#66d9ef">typename</span> List, <span style="color:#66d9ef">uint32_t</span> FlagMask<span style="color:#f92672">&gt;</span>
<span style="color:#66d9ef">struct</span> <span style="color:#a6e22e">v_entsize_list_tt</span> {
    <span style="color:#66d9ef">uint32_t</span> entsizeAndFlags;
    <span style="color:#66d9ef">uint32_t</span> count;
    Element first;
};

<span style="color:#66d9ef">struct</span> <span style="color:#a6e22e">v_method_t</span> {
    SEL name;
    <span style="color:#66d9ef">const</span> <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>types;
    IMP imp;
};

<span style="color:#66d9ef">struct</span> <span style="color:#a6e22e">v_method_list_t</span> <span style="color:#f92672">:</span> v_entsize_list_tt<span style="color:#f92672">&lt;</span>v_method_t, v_method_list_t, <span style="color:#ae81ff">0x3</span><span style="color:#f92672">&gt;</span> {
};

<span style="color:#66d9ef">struct</span> <span style="color:#a6e22e">v_protocol_list_t</span> {
    uintptr_t count;
};

<span style="color:#66d9ef">struct</span> <span style="color:#a6e22e">v_ivar_t</span> {
    <span style="color:#66d9ef">int32_t</span> <span style="color:#f92672">*</span>offset;
    <span style="color:#66d9ef">const</span> <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>name;
    <span style="color:#66d9ef">const</span> <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>type;
    <span style="color:#75715e">// alignment is sometimes -1; use alignment() instead
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">uint32_t</span> alignment_raw;
    <span style="color:#66d9ef">uint32_t</span> size;
};

<span style="color:#66d9ef">struct</span> <span style="color:#a6e22e">v_ivar_list_t</span> <span style="color:#f92672">:</span> v_entsize_list_tt<span style="color:#f92672">&lt;</span>v_ivar_t, v_ivar_list_t, <span style="color:#ae81ff">0</span><span style="color:#f92672">&gt;</span> {
};

<span style="color:#66d9ef">struct</span> <span style="color:#a6e22e">v_property_t</span> {
    <span style="color:#66d9ef">const</span> <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>name;
    <span style="color:#66d9ef">const</span> <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>attributes;
};

<span style="color:#66d9ef">struct</span> <span style="color:#a6e22e">v_property_list_t</span> <span style="color:#f92672">:</span> v_entsize_list_tt<span style="color:#f92672">&lt;</span>v_property_t, v_property_list_t, <span style="color:#ae81ff">0</span><span style="color:#f92672">&gt;</span> {
};

<span style="color:#66d9ef">struct</span> <span style="color:#a6e22e">v_class_ro_t</span> {
    <span style="color:#66d9ef">uint32_t</span> flags;
    <span style="color:#66d9ef">uint32_t</span> instanceStart;
    <span style="color:#66d9ef">uint32_t</span> instanceSize;
    <span style="color:#66d9ef">uint32_t</span> reserved;

    <span style="color:#66d9ef">const</span> <span style="color:#66d9ef">uint8_t</span> <span style="color:#f92672">*</span> ivarLayout;

    <span style="color:#66d9ef">const</span> <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span> name;
    v_method_list_t <span style="color:#f92672">*</span> baseMethodList;
    v_protocol_list_t<span style="color:#f92672">*</span><span style="color:#f92672">*</span><span style="color:#f92672">*</span> <span style="color:#f92672">*</span> baseProtocols;
    <span style="color:#66d9ef">const</span> v_ivar_list_t <span style="color:#f92672">*</span> ivars;

    <span style="color:#66d9ef">const</span> <span style="color:#66d9ef">uint8_t</span> <span style="color:#f92672">*</span> weakIvarLayout;
    v_property_list_t <span style="color:#f92672">*</span>baseProperties;
};

<span style="color:#66d9ef">template</span> <span style="color:#f92672">&lt;</span><span style="color:#66d9ef">typename</span> Element, <span style="color:#66d9ef">typename</span> List<span style="color:#f92672">&gt;</span>
<span style="color:#66d9ef">class</span> <span style="color:#a6e22e">v_list_array_tt</span> {
    <span style="color:#66d9ef">union</span> {
        List<span style="color:#f92672">*</span> list;
        v_uintptr_t arrayAndFlag;
    };
};

<span style="color:#66d9ef">class</span> <span style="color:#a6e22e">v_method_array_t</span> <span style="color:#f92672">:</span>
<span style="color:#66d9ef">public</span> v_list_array_tt<span style="color:#f92672">&lt;</span>v_method_t, v_method_list_t<span style="color:#f92672">&gt;</span>
{
};

<span style="color:#66d9ef">class</span> <span style="color:#a6e22e">v_property_array_t</span> <span style="color:#f92672">:</span>
<span style="color:#66d9ef">public</span> v_list_array_tt<span style="color:#f92672">&lt;</span>v_property_t, v_property_list_t<span style="color:#f92672">&gt;</span>
{
};

<span style="color:#66d9ef">class</span> <span style="color:#a6e22e">v_protocol_array_t</span> <span style="color:#f92672">:</span>
<span style="color:#66d9ef">public</span> v_list_array_tt<span style="color:#f92672">&lt;</span>v_protocol_ref_t, v_protocol_list_t<span style="color:#f92672">&gt;</span>
{
};

<span style="color:#66d9ef">struct</span> <span style="color:#a6e22e">v_class_rw_t</span> {
    <span style="color:#66d9ef">uint32_t</span> flags;
    <span style="color:#66d9ef">uint32_t</span> version;

    <span style="color:#66d9ef">const</span> v_class_ro_t <span style="color:#f92672">*</span>ro;

    v_method_array_t methods;
    v_property_array_t properties;
    v_protocol_array_t protocols;
};

<span style="color:#66d9ef">struct</span> <span style="color:#a6e22e">v_class_data_bits_t</span> {
    v_uintptr_t bits;

    v_class_rw_t<span style="color:#f92672">*</span> <span style="color:#a6e22e">data</span>() {
        <span style="color:#66d9ef">return</span> (v_class_rw_t <span style="color:#f92672">*</span>)(bits <span style="color:#f92672">&amp;</span> FAST_DATA_MASK);
    }
};

<span style="color:#66d9ef">struct</span> <span style="color:#a6e22e">v_objc_class</span> <span style="color:#f92672">:</span> v_objc_object {
    V_Class superclass;
    v_cache_t cache;
    v_class_data_bits_t bits;

    v_class_rw_t <span style="color:#f92672">*</span><span style="color:#a6e22e">data</span>() {
        <span style="color:#66d9ef">return</span> bits.data();
    }
};

<span style="color:#75715e">#</span><span style="color:#75715e">endif </span><span style="color:#75715e">/* class_details_h */</span><span style="color:#75715e">
</span></code></pre></div></details>
<p>æˆ‘ä»¬ä»ä»¥ <code>Computer</code> ç±»ä¸ºä¾‹ï¼Œå°†ç±»æˆ–å…ƒç±»å¯¹è±¡è½¬æ¢ä¸ºå…¶çœŸå®ç»“æ„æ—¶ï¼Œæˆ‘ä»¬å°±èƒ½çœ‹åˆ°å…¶ä¸­çš„ç»†èŠ‚äº†ï¼š</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-objectivec" data-lang="objectivec"><span style="color:#75715e">// main.mm
</span><span style="color:#75715e"></span>
V_Class cptClassObject <span style="color:#f92672">=</span> (<span style="color:#66d9ef">__bridge</span> V_Class)[Computer <span style="color:#66d9ef">class</span>];
v_class_rw_t <span style="color:#f92672">*</span>cptRWTable <span style="color:#f92672">=</span> cptClassObject<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>data();
</code></pre></div><p><img src="/img/2019/objects_in_obj-c/4.png" alt="4"></p>
<blockquote>
<p>æœ‰å¿ƒçš„åŒå­¦å¯èƒ½ä¼šå‘ç°ï¼Œè¿™é‡Œçš„æ–¹æ³•åˆ—è¡¨ä¸ªæ•°æ˜¾ç¤ºä¸º 5ï¼Œæ ¹æ®ä¸Šé¢çš„ Obj-C æºç ï¼Œåº”å½“æ˜¯ <code>model</code> å±æ€§è‡ªåŠ¨ç”Ÿæˆçš„ getter &amp; setterï¼Œä»¥åŠ <code>print:</code> å’Œ <code>arch</code>ï¼Œé‚£ä¹ˆæ€ä¹ˆä¼šå¤šä¸€ä¸ªå‘¢ï¼Ÿå…¶å®è¿™æ˜¯ç”±äºå®šä¹‰å±æ€§ï¼Œå¢åŠ äº†ä¸€ä¸ªåä¸º <code>.cxx_destruct</code> çš„æ–¹æ³•ï¼Œå…³äºæ­¤æœ¬æ–‡ä¸å†æ¶‰åŠï¼Œè€ƒè™‘æ”¾ç½®åœ¨ <code>dealloc</code> ç›¸å…³çš„æ–‡ç« ä¸­ã€‚</p>
</blockquote>
<p>å› æ­¤ <code>class_rw_t</code> ä¸­å­˜å‚¨çš„æ–¹æ³•ã€å±æ€§å’Œåè®®åˆ—è¡¨éƒ½ç»§æ‰¿è‡ª <code>list_array_tt&lt;Element, List&gt;</code>ï¼Œå…¶ä¸­çš„å€¼å…±æœ‰ä¸‰ç§å¯èƒ½ï¼š</p>
<ol>
<li>ç©ºï¼Œå³æ²¡æœ‰å®šä¹‰ä»»ä½•å†…å®¹ï¼›</li>
<li>ä¸€ä¸ªæŒ‡å‘å•ä¸€åˆ—è¡¨çš„æŒ‡é’ˆï¼Œå³åªå­˜å‚¨äº†ç¼–è¯‘æ—¶ï¼ˆåŒ…æ‹¬ç±»æœ¬èº«å’Œåˆ†ç±»ä¸­ï¼‰ç¡®å®šçš„å†…å®¹ï¼›</li>
<li>ä¸€ä¸ªæŒ‡å‘åˆ—è¡¨çš„æŒ‡é’ˆæ•°ç»„ï¼ˆç±»ä¼¼äºŒç»´æ•°ç»„ï¼‰ï¼Œå³å­˜å‚¨äº†ç¼–è¯‘æ—¶ç¡®å®šä»¥åŠè¿è¡Œæ—¶é™„åŠ çš„å†…å®¹ã€‚</li>
</ol>
<h3 id="class-ro-t">class_ro_t</h3>
<p><code>class_ro_t</code> å­˜åœ¨äº <code>class_rw_t</code> ä¸­ï¼Œæ˜¯åªè¯»ï¼ˆRead-Onlyï¼‰è¡¨ï¼š</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp"><span style="color:#75715e">// objc-runtime-new.h
</span><span style="color:#75715e"></span>
<span style="color:#75715e">// åªè¯»è¡¨
</span><span style="color:#75715e"></span><span style="color:#66d9ef">struct</span> <span style="color:#a6e22e">class_ro_t</span> {
    <span style="color:#75715e">// æ ‡å¿—ä½
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">uint32_t</span> flags;
    <span style="color:#66d9ef">uint32_t</span> instanceStart;
    <span style="color:#75715e">// å®ä¾‹å¤§å°
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">uint32_t</span> instanceSize;
<span style="color:#75715e">#</span><span style="color:#75715e">ifdef __LP64__</span><span style="color:#75715e">
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">uint32_t</span> reserved;
<span style="color:#75715e">#</span><span style="color:#75715e">endif</span><span style="color:#75715e">
</span><span style="color:#75715e"></span>
    <span style="color:#66d9ef">const</span> <span style="color:#66d9ef">uint8_t</span> <span style="color:#f92672">*</span> ivarLayout;

    <span style="color:#75715e">// ç±»å
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">const</span> <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span> name;
    method_list_t <span style="color:#f92672">*</span> baseMethodList;
    protocol_list_t <span style="color:#f92672">*</span> baseProtocols;
    <span style="color:#75715e">// æˆå‘˜å˜é‡
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">const</span> ivar_list_t <span style="color:#f92672">*</span> ivars;

    <span style="color:#66d9ef">const</span> <span style="color:#66d9ef">uint8_t</span> <span style="color:#f92672">*</span> weakIvarLayout;
    property_list_t <span style="color:#f92672">*</span>baseProperties;

    method_list_t <span style="color:#f92672">*</span><span style="color:#a6e22e">baseMethods</span>() <span style="color:#66d9ef">const</span> {
        <span style="color:#66d9ef">return</span> baseMethodList;
    }
};
</code></pre></div><p>è€Œä¸ <code>class_rw_t</code> ä¸åŒçš„æ˜¯ï¼Œ<code>class_ro_t</code> ä¸­çš„æ–¹æ³•ã€å±æ€§ã€æˆå‘˜å˜é‡åˆ†åˆ«ç›´æ¥ç»§æ‰¿è‡ª <code>method_list_t</code>ã€<code>ivar_list_t</code> å’Œ <code>property_list_t</code>ï¼Œ å°‘äº†ä¸€ç»´ã€‚è¿™æ˜¯å› ä¸ºåªè¯»è¡¨åªå­˜å‚¨ç¼–è¯‘æ—¶ï¼ˆåŒ…æ‹¬ç±»æœ¬èº«å’Œåˆ†ç±»ä¸­ï¼‰ç¡®å®šçš„å†…å®¹ï¼Œåœ¨è¿è¡Œæ—¶å°†ä¸ä¼šå†æ¬¡é™„åŠ å…¶å®ƒçš„æ•°æ®ã€‚</p>
<p>ä¸ºäº†è¯æ˜ä¸Šè¿°ç»“è®ºï¼Œæˆ‘ä»¬å†ç®€å•äº†è§£ä¸€ä¸‹ç±»åœ¨é¦–æ¬¡åˆå§‹åŒ–ä¸­æ‰€æ‰§è¡Œçš„ <code>realizeClass</code> æ–¹æ³•ï¼ˆæ³¨æ„ï¼Œ<code>realizeClass</code> å­˜åœ¨äº obj4-750ï¼Œè€Œåœ¨ Xcode 11.1 å’Œ obj4-756.2 åŠä¹‹åè¯¥å‡½æ•°å·²è¢«æ›´åä¸º <code>realizeClassWithoutSwift</code> ä¸”æœ‰éƒ¨åˆ†å·®å¼‚ï¼Œä½†ç”±äºä¸»ä½“éƒ¨åˆ†æœªæ”¹å˜ä¸”å˜æ›´ä¸å½±å“å¦‚ä¸‹åˆ†ææš‚æ—¶ç•¥è¿‡ï¼‰ï¼š</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp"><span style="color:#75715e">// objc-runtime-new.h
</span><span style="color:#75715e"></span>
<span style="color:#75715e">// ç±»æ˜¯æœªå®ç°çš„ Future ç±»ï¼ˆå…³äº Future ç±»ç›®å‰ç½‘ä¸Šèµ„æ–™è¾ƒå°‘ï¼ŒRuntime ä¸­æœ‰ objc_getFutureClass APIï¼Œå®˜æ–¹æ–‡æ¡£æ„ä¸ºç”¨ä½œä¸ CoreFoundation ä¸­ç±»å‹æ— ç¼æ¡¥æ¥ï¼ˆToll-Free Bridgingï¼‰ï¼Œæ¯”å¦‚ __NSCFArray ç­‰ï¼Œä½†è¯¥æ–¹æ³•å¹¶æœªæš´éœ²åœ¨å¤–ç•Œï¼Œå³ä¸å…è®¸å¼€å‘è€…å»è°ƒç”¨ï¼‰
</span><span style="color:#75715e"></span><span style="color:#75715e">// class is unrealized future class - must never be set by compiler
</span><span style="color:#75715e"></span><span style="color:#75715e">#</span><span style="color:#75715e">define RO_FUTURE             (1&lt;&lt;30)</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">// ç±»å·²å®åŒ–
</span><span style="color:#75715e"></span><span style="color:#75715e">// class is realized - must never be set by compiler
</span><span style="color:#75715e"></span><span style="color:#75715e">#</span><span style="color:#75715e">define RO_REALIZED           (1&lt;&lt;31)</span><span style="color:#75715e">
</span><span style="color:#75715e"></span>
<span style="color:#75715e">// class_t-&gt;data is class_rw_t, not class_ro_t
</span><span style="color:#75715e"></span><span style="color:#75715e">#</span><span style="color:#75715e">define RW_REALIZED           (1&lt;&lt;31)</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">// class is unresolved future class
</span><span style="color:#75715e"></span><span style="color:#75715e">#</span><span style="color:#75715e">define RW_FUTURE             (1&lt;&lt;30)</span><span style="color:#75715e">
</span><span style="color:#75715e"></span>
<span style="color:#75715e">// objc-runtime-new.mm
</span><span style="color:#75715e"></span>
<span style="color:#75715e">/***********************************************************************
</span><span style="color:#75715e">* realizeClass
</span><span style="color:#75715e">* Performs first-time initialization on class cls,
</span><span style="color:#75715e">* åœ¨ç±»ä¸Šæ‰§è¡Œé¦–æ¬¡åˆå§‹åŒ–ï¼Œ
</span><span style="color:#75715e">* including allocating its read-write data.
</span><span style="color:#75715e">* åŒ…æ‹¬åˆ†é…è¯»å†™æ•°æ®ã€‚
</span><span style="color:#75715e">* Returns the real class structure for the class.
</span><span style="color:#75715e">* è¿”å›ç±»çš„çœŸå®ç±»ç»“æ„ã€‚
</span><span style="color:#75715e">* Locking: runtimeLock must be write-locked by the caller
</span><span style="color:#75715e">**********************************************************************/</span>
<span style="color:#66d9ef">static</span> Class <span style="color:#a6e22e">realizeClass</span>(Class cls)
{
    runtimeLock.assertLocked();

    <span style="color:#75715e">// åªè¯»è¡¨æŒ‡é’ˆ
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">const</span> class_ro_t <span style="color:#f92672">*</span>ro;
    <span style="color:#75715e">// å¯è¯»å¯å†™è¡¨æŒ‡é’ˆ
</span><span style="color:#75715e"></span>    class_rw_t <span style="color:#f92672">*</span>rw;
    Class supercls;
    Class metacls;
    <span style="color:#66d9ef">bool</span> isMeta;

    <span style="color:#75715e">// è‹¥ä¸ºç©ºï¼Œåˆ™è¿”å›
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span>cls) <span style="color:#66d9ef">return</span> nil;
    <span style="color:#75715e">// è‹¥å·²ç»å®åŒ–ï¼Œåˆ™è¿”å›
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">if</span> (cls<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>isRealized()) <span style="color:#66d9ef">return</span> cls;
    assert(cls <span style="color:#f92672">=</span><span style="color:#f92672">=</span> remapClass(cls));

    <span style="color:#75715e">// fixme verify class is not in an un-dlopened part of the shared cache?
</span><span style="color:#75715e"></span>
    <span style="color:#75715e">// å®åŒ–å‰ï¼Œcls-&gt;data() è¿”å›æŒ‡å‘åªè¯»è¡¨çš„æŒ‡é’ˆï¼Œå› æ­¤å¯ä»¥å¼ºè½¬
</span><span style="color:#75715e"></span>    ro <span style="color:#f92672">=</span> (<span style="color:#66d9ef">const</span> class_ro_t <span style="color:#f92672">*</span>)cls<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>data();
    <span style="color:#75715e">// åˆ¤æ–­æ˜¯å¦ä¸ºæœªæ¥çš„ç±»ï¼ˆå³ RO_FUTURE æ ‡å¿—ç€è¯»å†™æ•°æ®æ˜¯å¦å·²ç»è¢«åˆ†é…ï¼‰
</span><span style="color:#75715e"></span>    <span style="color:#75715e">// å¯è¯»å¯å†™è¡¨å’Œåªè¯»è¡¨çš„é¦–ä¸ªæˆå‘˜å‡ä¸º flags ä¸” RO_FUTURE ä¸ RW_FUTURE å®é™…å€¼ç›¸åŒ
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">if</span> (ro<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>flags <span style="color:#f92672">&amp;</span> RO_FUTURE) {
        <span style="color:#75715e">// This was a future class. rw data is already allocated.
</span><span style="color:#75715e"></span>        <span style="color:#75715e">// å°†æ•°æ®èµ‹å€¼ç»™å¯è¯»å¯å†™è¡¨
</span><span style="color:#75715e"></span>        rw <span style="color:#f92672">=</span> cls<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>data();
        <span style="color:#75715e">// å°†å¯è¯»å¯å†™è¡¨ä¸­çš„åªè¯»è¡¨èµ‹å€¼ç»™åªè¯»è¡¨
</span><span style="color:#75715e"></span>        ro <span style="color:#f92672">=</span> cls<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>data()<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>ro;
        <span style="color:#75715e">// æ›´æ–°æ ‡è®°ä½
</span><span style="color:#75715e"></span>        cls<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>changeInfo(RW_REALIZED<span style="color:#f92672">|</span>RW_REALIZING, RW_FUTURE);
    } <span style="color:#66d9ef">else</span> {
        <span style="color:#75715e">// é€šå¸¸ä¸ºè¯¥é€»è¾‘
</span><span style="color:#75715e"></span>
        <span style="color:#75715e">// Normal class. Allocate writeable class data.
</span><span style="color:#75715e"></span>        <span style="color:#75715e">// æ™®é€šç±»ï¼Œåˆ†é…å¯å†™å…¥ç±»æ•°æ®
</span><span style="color:#75715e"></span>        <span style="color:#75715e">// åˆ†é…ç©ºé—´
</span><span style="color:#75715e"></span>        rw <span style="color:#f92672">=</span> (class_rw_t <span style="color:#f92672">*</span>)calloc(<span style="color:#66d9ef">sizeof</span>(class_rw_t), <span style="color:#ae81ff">1</span>);
        <span style="color:#75715e">// å°†å¯è¯»å¯å†™è¡¨ä¸­çš„åªè¯»è¡¨æŒ‡é’ˆæŒ‡å‘åªè¯»è¡¨æŒ‡é’ˆ
</span><span style="color:#75715e"></span>        rw<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>ro <span style="color:#f92672">=</span> ro;
        <span style="color:#75715e">// æ›´æ–°æ ‡è®°ä½ï¼Œå®åŒ–ä¸”æ­£åœ¨å®åŒ–
</span><span style="color:#75715e"></span>        rw<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>flags <span style="color:#f92672">=</span> RW_REALIZED<span style="color:#f92672">|</span>RW_REALIZING;
        <span style="color:#75715e">// å°†å¯è¯»å¯å†™è¡¨å†™å›ç±»ä¸­
</span><span style="color:#75715e"></span>        cls<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>setData(rw);
    }

    <span style="color:#75715e">// ---
</span><span style="color:#75715e"></span>    <span style="color:#75715e">// ä»¥ä¸‹å†…å®¹ä¸ class_rw_t ç›¸å…³æ€§ä¸å¤§ï¼Œä»…ä¾›å‚è€ƒ
</span><span style="color:#75715e"></span>
    <span style="color:#75715e">// æ˜¯å¦ä¸ºå…ƒç±»
</span><span style="color:#75715e"></span>    isMeta <span style="color:#f92672">=</span> ro<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>flags <span style="color:#f92672">&amp;</span> RO_META;

    rw<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>version <span style="color:#f92672">=</span> isMeta <span style="color:#f92672">?</span> <span style="color:#ae81ff">7</span> <span style="color:#f92672">:</span> <span style="color:#ae81ff">0</span>;  <span style="color:#75715e">// old runtime went up to 6
</span><span style="color:#75715e"></span>
    <span style="color:#75715e">// Choose an index for this class.
</span><span style="color:#75715e"></span>    <span style="color:#75715e">// è®¾ç½®ç±»çš„ç´¢å¼•
</span><span style="color:#75715e"></span>    <span style="color:#75715e">// Sets cls-&gt;instancesRequireRawIsa if indexes no more indexes are available
</span><span style="color:#75715e"></span>    cls<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>chooseClassArrayIndex();

    <span style="color:#75715e">// æ‰“å° Debug ä¿¡æ¯
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">if</span> (PrintConnecting) {
        _objc_inform(<span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">CLASS: realizing class &#39;%s&#39;%s %p %p #%u</span><span style="color:#e6db74">&#34;</span>,
                     cls<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>nameForLogging(), isMeta <span style="color:#f92672">?</span> <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74"> (meta)</span><span style="color:#e6db74">&#34;</span> <span style="color:#f92672">:</span> <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">&#34;</span>,
                     (<span style="color:#66d9ef">void</span><span style="color:#f92672">*</span>)cls, ro, cls<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>classArrayIndex());
    }

    <span style="color:#75715e">// å…ˆå®åŒ–çˆ¶ç±»ï¼Œå†å®åŒ–ç±» / å…ƒç±»ï¼Œæœ€åå®åŒ–ç±»æœ¬èº«
</span><span style="color:#75715e"></span>    <span style="color:#75715e">// Realize superclass and metaclass, if they aren&#39;t already.
</span><span style="color:#75715e"></span>    <span style="color:#75715e">// This needs to be done after RW_REALIZED is set above, for root classes.
</span><span style="color:#75715e"></span>    <span style="color:#75715e">// This needs to be done after class index is chosen, for root metaclasses.
</span><span style="color:#75715e"></span>    supercls <span style="color:#f92672">=</span> realizeClass(remapClass(cls<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>superclass));
    metacls <span style="color:#f92672">=</span> realizeClass(remapClass(cls<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>ISA()));

<span style="color:#75715e">#</span><span style="color:#75715e">if SUPPORT_NONPOINTER_ISA</span><span style="color:#75715e">
</span><span style="color:#75715e"></span>    <span style="color:#75715e">// é€šå¸¸ä¸ºè¯¥é€»è¾‘
</span><span style="color:#75715e"></span>
    <span style="color:#75715e">// Disable non-pointer isa for some classes and/or platforms.
</span><span style="color:#75715e"></span>    <span style="color:#75715e">// Set instancesRequireRawIsa.
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">bool</span> instancesRequireRawIsa <span style="color:#f92672">=</span> cls<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>instancesRequireRawIsa();
    <span style="color:#66d9ef">bool</span> rawIsaIsInherited <span style="color:#f92672">=</span> false;
    <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">bool</span> hackedDispatch <span style="color:#f92672">=</span> false;

    <span style="color:#66d9ef">if</span> (DisableNonpointerIsa) {
        <span style="color:#75715e">// Non-pointer isa disabled by environment or app SDK version
</span><span style="color:#75715e"></span>        instancesRequireRawIsa <span style="color:#f92672">=</span> true;
    }
    <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span>hackedDispatch  <span style="color:#f92672">&amp;</span><span style="color:#f92672">&amp;</span>  <span style="color:#f92672">!</span>(ro<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>flags <span style="color:#f92672">&amp;</span> RO_META)  <span style="color:#f92672">&amp;</span><span style="color:#f92672">&amp;</span>
             <span style="color:#ae81ff">0</span> <span style="color:#f92672">=</span><span style="color:#f92672">=</span> strcmp(ro<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>name, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">OS_object</span><span style="color:#e6db74">&#34;</span>))
    {
        <span style="color:#75715e">// hack for libdispatch et al - isa also acts as vtable pointer
</span><span style="color:#75715e"></span>        hackedDispatch <span style="color:#f92672">=</span> true;
        instancesRequireRawIsa <span style="color:#f92672">=</span> true;
    }
    <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> (supercls  <span style="color:#f92672">&amp;</span><span style="color:#f92672">&amp;</span>  supercls<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>superclass  <span style="color:#f92672">&amp;</span><span style="color:#f92672">&amp;</span>
             supercls<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>instancesRequireRawIsa())
    {
        <span style="color:#75715e">// This is also propagated by addSubclass()
</span><span style="color:#75715e"></span>        <span style="color:#75715e">// but nonpointer isa setup needs it earlier.
</span><span style="color:#75715e"></span>        <span style="color:#75715e">// Special case: instancesRequireRawIsa does not propagate
</span><span style="color:#75715e"></span>        <span style="color:#75715e">// from root class to root metaclass
</span><span style="color:#75715e"></span>        instancesRequireRawIsa <span style="color:#f92672">=</span> true;
        rawIsaIsInherited <span style="color:#f92672">=</span> true;
    }

    <span style="color:#66d9ef">if</span> (instancesRequireRawIsa) {
        cls<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>setInstancesRequireRawIsa(rawIsaIsInherited);
    }
<span style="color:#75715e">// SUPPORT_NONPOINTER_ISA
</span><span style="color:#75715e"></span><span style="color:#75715e">#</span><span style="color:#75715e">endif</span><span style="color:#75715e">
</span><span style="color:#75715e"></span>
    <span style="color:#75715e">// Update superclass and metaclass in case of remapping
</span><span style="color:#75715e"></span>    <span style="color:#75715e">// åœ¨é‡æ–°æ˜ å°„çš„æƒ…å†µä¸‹æ›´æ–°è¶…ç±»å’Œå…ƒç±»
</span><span style="color:#75715e"></span>    cls<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>superclass <span style="color:#f92672">=</span> supercls;
    cls<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>initClassIsa(metacls);

    <span style="color:#75715e">// Reconcile instance variable offsets / layout.
</span><span style="color:#75715e"></span>    <span style="color:#75715e">// This may reallocate class_ro_t, updating our ro variable.
</span><span style="color:#75715e"></span>    <span style="color:#75715e">// å¦‚æœæ˜¯çˆ¶ç±»ï¼Œä¸”éå…ƒç±»ï¼Œè°ƒæ•´å®ä¾‹å˜é‡ï¼Œå¯èƒ½ä¼šé‡æ–°åˆ†é… class_ro_t å¹¶æ›´æ–° ro å˜é‡
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">if</span> (supercls  <span style="color:#f92672">&amp;</span><span style="color:#f92672">&amp;</span>  <span style="color:#f92672">!</span>isMeta) reconcileInstanceVariables(cls, supercls, ro);

    <span style="color:#75715e">// Set fastInstanceSize if it wasn&#39;t set already.
</span><span style="color:#75715e"></span>    <span style="color:#75715e">// è®¾ç½®å®ä¾‹å¤§å°
</span><span style="color:#75715e"></span>    cls<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>setInstanceSize(ro<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>instanceSize);

    <span style="color:#75715e">// Copy some flags from ro to rw
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">if</span> (ro<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>flags <span style="color:#f92672">&amp;</span> RO_HAS_CXX_STRUCTORS) {
        cls<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>setHasCxxDtor();
        <span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span> (ro<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>flags <span style="color:#f92672">&amp;</span> RO_HAS_CXX_DTOR_ONLY)) {
            cls<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>setHasCxxCtor();
        }
    }

    <span style="color:#75715e">// è®¾ç½®å­ç±» / åŸºç±»
</span><span style="color:#75715e"></span>    <span style="color:#75715e">// Connect this class to its superclass&#39;s subclass lists
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">if</span> (supercls) {
        addSubclass(supercls, cls);
    } <span style="color:#66d9ef">else</span> {
        addRootClass(cls);
    }

    <span style="color:#75715e">// Attach categories
</span><span style="color:#75715e"></span>    <span style="color:#75715e">// çœŸæ­£å»è¿æ¥åˆ†ç±»
</span><span style="color:#75715e"></span>    methodizeClass(cls);

    <span style="color:#66d9ef">return</span> cls;
}

<span style="color:#66d9ef">struct</span> <span style="color:#a6e22e">objc_class</span> <span style="color:#f92672">:</span> objc_object {
    <span style="color:#75715e">// åˆ¤æ–­ç±»æ˜¯å¦å®åŒ–
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">bool</span> <span style="color:#a6e22e">isRealized</span>() {
        <span style="color:#66d9ef">return</span> data()<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>flags <span style="color:#f92672">&amp;</span> RW_REALIZED;
    }
}
</code></pre></div><h3 id="method-t">method_t</h3>
<p><code>method_t</code> æ˜¯ Obj-C ä¸­æ–¹æ³•çš„æœ¬è´¨ç±»å‹ï¼š</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp"><span style="color:#75715e">// objc.h
</span><span style="color:#75715e"></span>
<span style="color:#75715e">/// An opaque type that represents a method selector.
</span><span style="color:#75715e"></span><span style="color:#66d9ef">typedef</span> <span style="color:#66d9ef">struct</span> <span style="color:#a6e22e">objc_selector</span> <span style="color:#f92672">*</span>SEL;

<span style="color:#75715e">// objc-ptrauth.h
</span><span style="color:#75715e"></span>
<span style="color:#75715e">#</span><span style="color:#75715e">if __has_feature(ptrauth_calls)</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">// Method lists use process-independent signature for compatibility.
</span><span style="color:#75715e"></span><span style="color:#66d9ef">using</span> MethodListIMP <span style="color:#f92672">=</span> IMP __ptrauth_objc_method_list_imp;
<span style="color:#75715e">#</span><span style="color:#75715e">else</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#66d9ef">using</span> MethodListIMP <span style="color:#f92672">=</span> IMP;
<span style="color:#75715e">#</span><span style="color:#75715e">endif</span><span style="color:#75715e">
</span><span style="color:#75715e"></span>
<span style="color:#66d9ef">struct</span> <span style="color:#a6e22e">method_t</span> {
    SEL name;
    <span style="color:#66d9ef">const</span> <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>types;
    MethodListIMP imp;

    <span style="color:#66d9ef">struct</span> <span style="color:#a6e22e">SortBySELAddress</span> <span style="color:#f92672">:</span>
        <span style="color:#66d9ef">public</span> std<span style="color:#f92672">:</span><span style="color:#f92672">:</span>binary_function<span style="color:#f92672">&lt;</span><span style="color:#66d9ef">const</span> method_t<span style="color:#f92672">&amp;</span>,
                                    <span style="color:#66d9ef">const</span> method_t<span style="color:#f92672">&amp;</span>, <span style="color:#66d9ef">bool</span><span style="color:#f92672">&gt;</span>
    {
        <span style="color:#66d9ef">bool</span> <span style="color:#a6e22e">operator</span>() (<span style="color:#66d9ef">const</span> method_t<span style="color:#f92672">&amp;</span> lhs,
                         <span style="color:#66d9ef">const</span> method_t<span style="color:#f92672">&amp;</span> rhs)
        { <span style="color:#66d9ef">return</span> lhs.name <span style="color:#f92672">&lt;</span> rhs.name; }
    };
};
</code></pre></div><p><code>method_t</code> ä¸­å­˜å‚¨äº†æ–¹æ³•çš„åç§°ã€ç±»å‹å’Œ <code>IMP</code>ï¼š</p>
<table>
<thead>
<tr>
<th align="center">Member</th>
<th align="center">Notes</th>
</tr>
</thead>
<tbody>
<tr>
<td align="center"><code>SEL name;</code></td>
<td align="center">æ–¹æ³•åï¼Œåˆç§°æ–¹æ³•é€‰æ‹©å™¨ï¼ˆSelectorï¼‰ï¼ŒåŒåæ–¹æ³•å³ä½¿ä¸åŒç±»ä¹Ÿæ‹¥æœ‰ç›¸åŒçš„ <code>SEL</code> ç±»å‹æ–¹æ³•åï¼›å…¶åº•å±‚æ•°æ®ç±»å‹ä¸º <code>struct objc_selector</code> ä½†æ²¡æœ‰æ‰¾åˆ°ç›¸å…³å¼€æºï¼Œå¯è¿‘ä¼¼è®¤ä¸ºæ˜¯ C ä¸­ <code>char *</code> å­—ç¬¦ä¸²ï¼›å¯ä»¥ä½¿ç”¨ <code>@selector()</code> æˆ– <code>sel_registerName()</code> æ–¹æ³•ä¼ å…¥æ–¹æ³•æ¥å¾—åˆ°æ–¹æ³•åï¼›ä¹Ÿå¯é€šè¿‡ <code>sel_getName()</code> æˆ– <code>NSStringFromSelector()</code> å°† <code>SEL</code> ç±»å‹è½¬æ¢ä¸º <code>char *</code> æˆ– <code>NSString</code></td>
</tr>
<tr>
<td align="center"><code>const char *types;</code></td>
<td align="center">æ–¹æ³•ç±»å‹ç¼–ç ï¼ˆType Encodingï¼‰ï¼Œå°†æ–¹æ³•çš„è¿”å›å€¼ã€å‚æ•°ç­‰ä¿¡æ¯ç¼–ç çš„å­—ç¬¦ä¸²ï¼›Obj-C æ–¹æ³•é»˜è®¤ä¼šæœ‰ä¸¤ä¸ªå‚æ•°ï¼Œå³ <code>id self</code> &amp; <code>SEL op</code>ï¼Œå› æ­¤é»˜è®¤å°±ä¼šæœ‰ <code>@:</code>ï¼Œé¦–ä¸ªæ•°å­—ä»£è¡¨æ‰€æœ‰å‚æ•°å ç”¨çš„æ€»å­—èŠ‚æ•°ï¼Œåç»­åˆ™ä»£è¡¨æ¯ä¸ªå‚æ•°çš„èµ·å§‹å­—èŠ‚æ•°ï¼›<code>@encode()</code>ï¼›è¯¦ç»†å¯è§ <a href="https://developer.apple.com/library/archive/documentation/Cocoa/Conceptual/ObjCRuntimeGuide/Articles/ocrtTypeEncodings.html">Type Encodings - Objective-C Runtime Programming Guide</a></td>
</tr>
<tr>
<td align="center"><code>MethodListIMP imp;</code></td>
<td align="center">æ–¹æ³•å®ç°ï¼Œå³æ–¹æ³•çš„å†…å­˜åœ°å€ï¼Œç±»ä¼¼ C ä¸­çš„å‡½æ•°æŒ‡é’ˆï¼Œå¯ä»¥é€šè¿‡è¯¥åœ°å€è®¿é—®åˆ°æ–¹æ³•çš„ä»£ç å—è¿›è€Œæ‰§è¡Œ</td>
</tr>
</tbody>
</table>
<h2 id="heading-2">å…ƒç±»å¯¹è±¡</h2>
<p>å…ƒç±»å¯¹è±¡å’Œç±»å¯¹è±¡ä¸€æ ·ï¼Œéƒ½æ˜¯ <code>Class</code> ç±»å‹ï¼Œä½†å…ƒç±»å¯¹è±¡åªå¯ä»¥é€šè¿‡ Runtime çš„ <code>object_getClass</code> API ä¼ å…¥ç±»å¯¹è±¡ï¼Œè·å–åˆ°å…ƒç±»å¯¹è±¡ã€‚éœ€è¦æ³¨æ„çš„æ˜¯ <code>[[Computer class] class]</code> æˆ– <code>[[cpt class] class]</code> éƒ½åªèƒ½è¿”å›ç±»å¯¹è±¡ã€‚</p>
<p>å¯¹äº <code>object_getClass</code>ï¼Œå¦‚æœå‚æ•°æ˜¯å®ä¾‹å¯¹è±¡ï¼Œè¿”å›ç±»å¯¹è±¡ï¼›å¦‚æœå‚æ•°æ˜¯ç±»å¯¹è±¡ï¼Œè¿”å›å…ƒç±»å¯¹è±¡ï¼›å¦‚æœå‚æ•°æ˜¯å…ƒç±»å¯¹è±¡ï¼Œè¿”å› NSObjectï¼ˆåŸºç±»ï¼‰çš„å…ƒç±»å¯¹è±¡ã€‚<code>class_isMetaClass</code> å¯ä»¥ç”¨æ¥æ£€æŸ¥ <code>Class</code> æ˜¯å¦ä¸ºå…ƒç±»å¯¹è±¡ã€‚</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-objectivec" data-lang="objectivec">VClass cptMetaVClass <span style="color:#f92672">=</span> (<span style="color:#66d9ef">__bridge</span> VClass)object_getClass([Computer <span style="color:#66d9ef">class</span>]);
class_rw_t <span style="color:#f92672">*</span>rwt <span style="color:#f92672">=</span> cptMetaVClass<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>data();

<span style="color:#75715e">// LLDB:
</span><span style="color:#75715e"></span><span style="color:#75715e">// Printing description of rwt-&gt;methods-&gt;first:
</span><span style="color:#75715e"></span><span style="color:#75715e">// (method_t) first = {
</span><span style="color:#75715e"></span><span style="color:#75715e">//     name = &#34;arch&#34;
</span><span style="color:#75715e"></span><span style="color:#75715e">//     types = 0x0000000100000f86 &#34;@16@0:8&#34;
</span><span style="color:#75715e"></span><span style="color:#75715e">//     imp = 0x0000000100000d40 (DemoOC`::+[Computer arch]() at main.mm:52)
</span><span style="color:#75715e"></span><span style="color:#75715e">// }
</span></code></pre></div><p>å…ƒç±»å¯¹è±¡ä¸­é™¤äº†å­˜å‚¨ <code>isa</code> å’Œ <code>superclass</code> æŒ‡é’ˆï¼Œè¿˜å­˜å‚¨äº†ç±»æ–¹æ³•ã€‚å…¶å­˜æ”¾ä½ç½®å’Œç±»å¯¹è±¡å­˜æ”¾å®ä¾‹æ–¹æ³•çš„å­˜æ”¾ä½ç½®ï¼ˆæ–¹æ³•åˆ—è¡¨ï¼‰ä¸€è‡´ã€‚</p>
<h2 id="superclass">superclass</h2>
<p><img src="/img/2019/objects_in_obj-c/3.png" alt="3"></p>
<h3 id="what">What</h3>
<p><code>superclass</code> æ˜¯ä»…å­˜åœ¨äºç±»å¯¹è±¡å’Œå…ƒç±»å¯¹è±¡çš„ä¸€ä¸ªæˆå‘˜ã€‚ç±»å¯¹è±¡ä¸­çš„ <code>superclass</code> æŒ‡å‘å½“å‰ç±»çš„çˆ¶ç±»ï¼Œå…ƒç±»å¯¹è±¡ä¸­çš„ <code>superclass</code> æŒ‡å‘è¯¥å…ƒç±»å¯¹è±¡çš„çˆ¶ç±»ã€‚åŸºç±» <code>NSObject</code> çš„ <code>superclass</code> æŒ‡å‘ <code>nil</code>ï¼Œæ ¹å…ƒç±»å¯¹è±¡çš„ <code>superclass</code> æŒ‡å‘åŸºç±» <code>NSObject</code> çš„ç±»å¯¹è±¡ã€‚</p>
<h3 id="isa--superclass">isa &amp; superclass</h3>
<p><code>isa</code> å°†å®ä¾‹å¯¹è±¡ä¸ç±»å¯¹è±¡ã€å…ƒç±»å¯¹è±¡è¿æ¥èµ·æ¥ï¼›<code>superclass</code> å°†å­ç±»ã€çˆ¶ç±»ã€åŸºç±»è¿æ¥èµ·æ¥ã€‚</p>
<p>å½“å‘ä¸€ä¸ªå®ä¾‹å‘é€å®ä¾‹æ–¹æ³•çš„æ¶ˆæ¯æ—¶ï¼ˆä¹Ÿå¯ç§°è°ƒç”¨å®ä¾‹æ–¹æ³•ï¼Œä½†å› ä¸º Obj-C æ˜¯æ¶ˆæ¯ç»“æ„çš„è¯­è¨€ï¼Œæ–¹æ³•è°ƒç”¨å¹¶ä¸ä¸¥è°¨ï¼‰ï¼Œè¯¥å®ä¾‹å¯¹è±¡ä¼šé€šè¿‡ <code>isa</code> æ‰¾åˆ°å…¶ç±»å¯¹è±¡ï¼Œå› ä¸ºå®ä¾‹æ–¹æ³•å­˜å‚¨åœ¨ç±»å¯¹è±¡ä¸­ï¼›å¦‚æœè¯¥ç±»çš„ç±»å¯¹è±¡ä¸­å¹¶æ²¡æœ‰å­˜å‚¨è¯¥å®ä¾‹æ–¹æ³•ï¼Œå…¶ç±»å¯¹è±¡å°†ä½¿ç”¨ <code>superclass</code> æ‰¾åˆ°å…¶çˆ¶ç±»çš„ç±»å¯¹è±¡ï¼Œå¹¶åœ¨å…¶ä¸­æŸ¥æ‰¾å®ä¾‹æ–¹æ³•ï¼›ç›´åˆ°åœ¨ <code>NSObject</code> åŸºç±»çš„ç±»å¯¹è±¡ä¹Ÿæ— æ³•æ‰¾åˆ°æ—¶ï¼Œ<code>superclass</code> å°†æŒ‡å‘ <code>nil</code> åœæ­¢æŸ¥æ‰¾ï¼ŒæŠ›å‡ºå¼‚å¸¸ï¼š<code>unrecognized selector sent to instance</code>ï¼ˆæ³¨æ„ï¼Œæˆ‘ä»¬è¿™é‡Œä»…è®¨è®ºæ¶ˆæ¯ä¼ é€’ï¼Œæš‚æ—¶å¿½ç•¥æ¶ˆæ¯è½¬å‘ï¼‰ã€‚</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-objectivec" data-lang="objectivec"><span style="color:#66d9ef">@interface</span> <span style="color:#a6e22e">Computer</span> : <span style="color:#a6e22e">NSObject</span>
- (<span style="color:#66d9ef">void</span>)<span style="color:#a6e22e">run</span>;
<span style="color:#66d9ef">@end</span>

<span style="color:#66d9ef">@implementation</span> <span style="color:#a6e22e">Computer</span>
<span style="color:#66d9ef">@end</span>

<span style="color:#66d9ef">@interface</span> <span style="color:#a6e22e">Mac</span> : <span style="color:#a6e22e">Computer</span>
<span style="color:#66d9ef">@end</span>

<span style="color:#66d9ef">@implementation</span> <span style="color:#a6e22e">Mac</span>
<span style="color:#75715e">// - (void)run {
</span><span style="color:#75715e"></span><span style="color:#75715e">//     NSLog(@&#34;RUN&#34;);
</span><span style="color:#75715e"></span><span style="color:#75715e">// }
</span><span style="color:#75715e"></span><span style="color:#66d9ef">@end</span>

<span style="color:#75715e">// &#39;-[Mac run]: unrecognized selector sent to instance 0x10330f6c0&#39;
</span><span style="color:#75715e"></span>[[[Mac alloc] init] run];
</code></pre></div><p>å½“å‘ä¸€ä¸ªç±»ï¼ˆçš„ç±»å¯¹è±¡ï¼‰å‘é€ç±»æ–¹æ³•çš„æ¶ˆæ¯æ—¶ï¼Œä¸ä¼šç»è¿‡å®ä¾‹å¯¹è±¡ï¼›ç±»å¯¹è±¡ä¼šé€šè¿‡å…¶ <code>isa</code> æŒ‡é’ˆæ‰¾åˆ°å…¶å…ƒç±»å¯¹è±¡ï¼Œå› ä¸ºç±»æ–¹æ³•å­˜å‚¨åœ¨å…ƒç±»å¯¹è±¡ä¸­ï¼›å¦‚æœè¯¥ç±»çš„å…ƒç±»å¯¹è±¡ä¸­å¹¶æ²¡æœ‰å­˜å‚¨è¯¥ç±»æ–¹æ³•ï¼Œå…¶å…ƒç±»å¯¹è±¡å°†ä½¿ç”¨ <code>superclass</code> æ‰¾åˆ°å…¶çˆ¶ç±»çš„å…ƒç±»å¯¹è±¡ï¼Œå¹¶åœ¨å…¶ä¸­æŸ¥æ‰¾ç±»æ–¹æ³•ï¼›ç›´åˆ°æŸ¥æ‰¾åˆ° <code>NSObject</code> åŸºç±»çš„å…ƒç±»å¯¹è±¡è¿˜æ²¡æœ‰è¯¥ç±»æ–¹æ³•æ—¶ï¼Œ<code>NSObject</code> å…ƒç±»å¯¹è±¡çš„ <code>superclass</code> å°†æŒ‡å› <code>NSObject</code> ç±»å¯¹è±¡ä¸­ï¼Œåœ¨å…¶å­˜å‚¨çš„å®ä¾‹æ–¹æ³•åˆ—è¡¨ä¸­æŸ¥æ‰¾ï¼Œè‹¥æ­¤æ—¶è¿˜æ²¡æœ‰æ‰¾åˆ°å°†åœæ­¢æŸ¥æ‰¾ï¼Œå¹¶æŠ›å‡ºå¼‚å¸¸ï¼š<code>unrecognized selector sent to instance</code>ï¼Œå› ä¸º <code>NSObject</code> ç±»å¯¹è±¡çš„ <code>superclass</code> å°†æŒ‡å‘ <code>nil</code>ã€‚</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-objectivec" data-lang="objectivec"><span style="color:#66d9ef">@interface</span> <span style="color:#a6e22e">NSObject</span> (Extension)
<span style="color:#66d9ef">@end</span>

<span style="color:#66d9ef">@implementation</span> <span style="color:#a6e22e">NSObject</span> (Extension)
- (<span style="color:#66d9ef">void</span>)<span style="color:#a6e22e">run</span> {
    NSLog(<span style="color:#e6db74">@&#34;</span><span style="color:#e6db74">RUN</span><span style="color:#e6db74">&#34;</span>);
}
<span style="color:#66d9ef">@end</span>

<span style="color:#66d9ef">@interface</span> <span style="color:#a6e22e">Computer</span> : <span style="color:#a6e22e">NSObject</span>
+ (<span style="color:#66d9ef">void</span>)<span style="color:#a6e22e">run</span>;
<span style="color:#66d9ef">@end</span>

<span style="color:#66d9ef">@implementation</span> <span style="color:#a6e22e">Computer</span>
<span style="color:#66d9ef">@end</span>

<span style="color:#66d9ef">@interface</span> <span style="color:#a6e22e">Mac</span> : <span style="color:#a6e22e">Computer</span>
<span style="color:#66d9ef">@end</span>

<span style="color:#66d9ef">@implementation</span> <span style="color:#a6e22e">Mac</span>
<span style="color:#66d9ef">@end</span>

<span style="color:#75715e">// OUTPUT:
</span><span style="color:#75715e"></span><span style="color:#75715e">// RUN
</span></code></pre></div><p>é€šè¿‡ä¸Šä¸€ç‚¹ï¼Œå…¶å®æˆ‘ä»¬å¯ä»¥çŸ¥é“åœ¨ Obj-C ä¸­ï¼Œæ–¹æ³•æ˜¯é€šè¿‡æ¶ˆæ¯ä¼ é€’çš„ï¼Œè€Œä¼ é€’çš„æ¶ˆæ¯å…¶å®å°±æ˜¯æ–¹æ³•åçš„ <code>SEL</code>ï¼Œå› æ­¤è¿™ä¹Ÿæ˜¯ä¸¥è°¨æ„ä¹‰ä¸Š Obj-C ä¸æ”¯æŒé‡è½½ï¼ˆOverloadï¼‰çš„åŸå› ï¼ˆä½†æ”¯æŒå‚æ•°ä¸ªæ•°ä¸åŒçš„é‡è½½ï¼‰ï¼Œå…·ä½“å¯è¯¦è§ã€Š<a href="../override_and_overload_in_obj-c/">Obj-C ä¸­çš„é‡è½½ä¸é‡å†™</a>ã€‹ä¸€æ–‡ã€‚</p>
<h2 id="reference">Reference</h2>
<ul>
<li><a href="../override_and_overload_in_obj-c/">Obj-C ä¸­çš„é‡è½½ä¸é‡å†™ - kingcos</a></li>
<li><a href="../isa_in_objc/">Obj-C ä¸­çš„ isa æŒ‡é’ˆ - kingcos</a></li>
<li><a href="../objc_msgsend/">æµ…å° objc_msgSend - kingcos</a></li>
<li><a href="https://developer.apple.com/library/archive/documentation/Cocoa/Conceptual/ObjCRuntimeGuide/Articles/ocrtTypeEncodings.html">Type Encodings - Objective-C Runtime Programming Guide</a></li>
</ul>

    </div>
    
      <div class="pagination">
        <div class="pagination__title">
          <span class="pagination__title-h">Read other posts</span>
          <hr />
        </div>
        <div class="pagination__buttons">
          
            <span class="button previous">
              <a href="/posts/2019/summary_of_2019/">
                <span class="button__icon">â†</span>
                <span class="button__text">ã€Œ2019 Â· ç»“ã€</span>
              </a>
            </span>
          
          
            <span class="button next">
              <a href="/posts/2019/multithreading_techs_in_ios-1/">
                <span class="button__text">iOS å¤šçº¿ç¨‹æŠ€æœ¯å®è·µä¹‹ pthreadsï¼ˆä¸€ï¼‰</span>
                <span class="button__icon">â†’</span>
              </a>
            </span>
          
        </div>
      </div>
    

    

    
    
    <div>
      <div id="github-comment">
      </div>

      <script type="text/javascript">
        function getUtterances(isDark) {
          var utterances = document.createElement('script');
          utterances.type = 'text/javascript';
          utterances.async = true;
          utterances.setAttribute('issue-term', "pathname")
          utterances.setAttribute('repo', "kingcos\/kingcos.github.io")
          utterances.setAttribute('label', "comments")
          isDark ? utterances.setAttribute('theme', "github-dark") : utterances.setAttribute('theme', "github-light")
          utterances.crossorigin = 'anonymous';
          utterances.src = 'https://utteranc.es/client.js';

          return utterances
        }

        var themeToggle = document.querySelector(".theme-toggle")
        themeToggle.addEventListener("click", function () {
          var getTheme = window.localStorage && window.localStorage.getItem("theme")
          var divNode = document.getElementById('github-comment')
          while(divNode.hasChildNodes()) {
            divNode.removeChild(divNode.firstChild);
          }
          
          
          

          
          
          
          
          
          
          document.getElementById('github-comment').appendChild(getUtterances(getTheme !== "dark"))
        })

        var getTheme = window.localStorage && window.localStorage.getItem("theme")
        document.getElementById('github-comment').appendChild(getUtterances(getTheme === "dark"))
      </script>
    </div>
    

    </div>

      </div>

      
        <footer class="footer">
  <div class="footer__inner">
    
      <div class="copyright copyright--user">All rights reserved by kingcos.me</div>
    
  </div>
</footer>

<script src="/assets/main.js"></script>
<script src="/assets/prism.js"></script>

<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>

<ins class="adsbygoogle"
     style="display:block"
     data-ad-client="ca-pub-9925978992661955"
     data-ad-slot="3213735320"
     data-ad-format="auto"
     data-full-width-responsive="true"></ins>

<script>
     (adsbygoogle = window.adsbygoogle || []).push({});
</script>


      
    </div>

    
      
<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
	(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
	m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
	})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
	ga('create', 'UA-138311951-1', 'auto');
	
	ga('send', 'pageview');
}
</script>

    
  </body>
</html>
