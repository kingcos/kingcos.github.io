<!DOCTYPE html>
<html lang="en">
  <head>
    
      <title>Obj-C ä¸­çš„å¯¹è±¡ :: iBlog â€” github.com/kingcos</title>
    
    <meta http-equiv="content-type" content="text/html; charset=utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">
<meta name="description" content="Date Notes Refer.     2019-03-18 é¦–æ¬¡æäº¤ objc4-750   2019-08-18 æŠ½ç¦» isa éƒ¨åˆ†ï¼›
é‡æ•´æ–‡ç« ç»“æ„ Obj-C ä¸­çš„ isa æŒ‡é’ˆ - kingcos   2019-08-29 å¢åŠ  class_rw_t ç­‰ç»†èŠ‚ -    Preface Obj-C ä¸­çš„å¯¹è±¡åˆ†ä¸ºå®ä¾‹å¯¹è±¡ï¼ˆInstance Objectï¼‰ã€ç±»å¯¹è±¡ï¼ˆClass Objectï¼‰ã€ä»¥åŠå…ƒç±»å¯¹è±¡ï¼ˆMeta-class Objectï¼‰ä¸‰ç§ï¼Œæœ¬æ–‡å°†å€ŸåŠ©æºç ç®€å•äº†è§£ä¸€ä¸‹ä¸åŒç±»å‹å¯¹è±¡çš„çœŸå®æ„é€ ã€‚
ä¸ºäº†æ–¹ä¾¿ä¸‹æ–‡ä¸¾ä¾‹ï¼Œè¿™é‡Œæˆ‘ä»¬å®šä¹‰ä¸€ä¸ª EDdeviceProtocol åè®®ï¼Œå¹¶è®©ç»§æ‰¿è‡ª NSObject çš„ Computer ç±»éµå®ˆè¯¥åè®®ï¼š
// EDdeviceProtocol åè®® @protocol EDdeviceProtocol - (void)powerOn; @end // Computer ç±»ï¼Œç»§æ‰¿è‡ª NSObjectï¼Œéµå®ˆ EDdeviceProtocol @interface Computer : NSObject &amp;lt;EDdeviceProtocol&amp;gt; { // æˆå‘˜å˜é‡ @public int _memorySize; int _diskSize; } // å±æ€§ @property (copy) NSString *model; // å®ä¾‹æ–¹æ³• - (void)print:(NSString *)content; // ç±»æ–¹æ³• &#43; (NSString *)arch; @end @implementation Computer - (void)print:(NSString *)content { NSLog(@&amp;quot;Print content: %@."/>
<meta name="keywords" content="ios,swift,objective-c,obj-c,objc,oc,geek,python,ruby,golang,go,apple,mac"/>
<meta name="robots" content="noodp"/>
<link rel="canonical" href="/posts/2019/objects_in_obj-c/" />





<link rel="stylesheet" href="/assets/style.css">


<link rel="stylesheet" href="/style.css">


<link rel="apple-touch-icon-precomposed" sizes="144x144" href="/img/apple-touch-icon-144-precomposed.png">
<link rel="shortcut icon" href="/img/favicon.png">


<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Obj-C ä¸­çš„å¯¹è±¡"/>
<meta name="twitter:description" content="Obj-C ä¸­çš„å¯¹è±¡åˆ†ä¸ºå®ä¾‹å¯¹è±¡ï¼ˆInstance Objectï¼‰ã€ç±»å¯¹è±¡ï¼ˆClass Objectï¼‰ã€ä»¥åŠå…ƒç±»å¯¹è±¡ï¼ˆMeta-class Objectï¼‰ä¸‰ç§ï¼Œæœ¬æ–‡å°†å€ŸåŠ©æºç ç®€å•äº†è§£ä¸€ä¸‹ä¸åŒç±»å‹å¯¹è±¡çš„çœŸå®æ„é€ ã€‚"/>



<meta property="og:title" content="Obj-C ä¸­çš„å¯¹è±¡" />
<meta property="og:description" content="Obj-C ä¸­çš„å¯¹è±¡åˆ†ä¸ºå®ä¾‹å¯¹è±¡ï¼ˆInstance Objectï¼‰ã€ç±»å¯¹è±¡ï¼ˆClass Objectï¼‰ã€ä»¥åŠå…ƒç±»å¯¹è±¡ï¼ˆMeta-class Objectï¼‰ä¸‰ç§ï¼Œæœ¬æ–‡å°†å€ŸåŠ©æºç ç®€å•äº†è§£ä¸€ä¸‹ä¸åŒç±»å‹å¯¹è±¡çš„çœŸå®æ„é€ ã€‚" />
<meta property="og:type" content="article" />
<meta property="og:url" content="/posts/2019/objects_in_obj-c/" />
<meta property="article:published_time" content="2019-08-29T00:00:00+00:00" />
<meta property="article:modified_time" content="2019-08-29T00:00:00+00:00" /><meta property="og:site_name" content="iBlog" />






  </head>
  <body class="dark-theme">
    <div class="container">
      <header class="header">
  <span class="header__inner">
    <a href="/" class="logo" style="text-decoration: none;">
  
    <span class="logo__mark"><svg xmlns="http://www.w3.org/2000/svg" class="greater-icon" viewBox="0 0 44 44">
  <path fill="none" d="M15 8l14.729 14.382L15 35.367"/>
</svg>
</span>
    <span class="logo__text">iBlog</span>
    <span class="logo__cursor"></span>
  
</a>

    <span class="header__right">
      
        <nav class="menu">
  <ul class="menu__inner menu__inner--desktop">
    
      
        
          <li><a href="/about">About</a></li>
        
      
        
          <li><a href="/links">Links</a></li>
        
      
        
          <li><a href="/perspective">Perspective</a></li>
        
      
        
          <li><a href="/words">Words</a></li>
        
      
      
    
  </ul>

  <ul class="menu__inner menu__inner--mobile">
    
      
        <li><a href="/about">About</a></li>
      
    
      
        <li><a href="/links">Links</a></li>
      
    
      
        <li><a href="/perspective">Perspective</a></li>
      
    
      
        <li><a href="/words">Words</a></li>
      
    
  </ul>
</nav>

        <span class="menu-trigger">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
            <path d="M0 0h24v24H0z" fill="none"/>
            <path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"/>
          </svg>
        </span>
      
      <span class="theme-toggle">
        <svg class="theme-toggler" width="24" height="24" viewBox="0 0 48 48" fill="none" xmlns="http://www.w3.org/2000/svg">
  <path d="M22 41C32.4934 41 41 32.4934 41 22C41 11.5066 32.4934 3 22
  3C11.5066 3 3 11.5066 3 22C3 32.4934 11.5066 41 22 41ZM7 22C7
  13.7157 13.7157 7 22 7V37C13.7157 37 7 30.2843 7 22Z"/>
</svg>

      </span>
    </span>
  </span>
</header>


      <div class="content">
        
  <div class="post">
    <h2 class="post-title"><a href="/posts/2019/objects_in_obj-c/">Obj-C ä¸­çš„å¯¹è±¡</a></h2>
    <div class="post-meta">
      
        <span class="post-date">
            2019-08-29
        </span>
      
      
      
        <span class="post-read-time">â€” 8 min read</span>
      
    </div>

    
      <span class="post-tags">
        
          #<a href="/tags/focus/">Focus</a>&nbsp;
        
          #<a href="/tags/ios/">iOS</a>&nbsp;
        
          #<a href="/tags/obj-c/">Obj-C</a>&nbsp;
        
          #<a href="/tags//">ğŸŒŸ</a>&nbsp;
        
      </span>
    

    

    <div class="post-content">
      

<table>
<thead>
<tr>
<th align="center">Date</th>
<th align="center">Notes</th>
<th align="center">Refer.</th>
</tr>
</thead>

<tbody>
<tr>
<td align="center">2019-03-18</td>
<td align="center">é¦–æ¬¡æäº¤</td>
<td align="center"><a href="https://opensource.apple.com/tarballs/objc4/">objc4-750</a></td>
</tr>

<tr>
<td align="center">2019-08-18</td>
<td align="center">æŠ½ç¦» <code>isa</code> éƒ¨åˆ†ï¼›<br>é‡æ•´æ–‡ç« ç»“æ„</td>
<td align="center"><a href="../isa_in_objc/">Obj-C ä¸­çš„ isa æŒ‡é’ˆ - kingcos</a></td>
</tr>

<tr>
<td align="center">2019-08-29</td>
<td align="center">å¢åŠ  <code>class_rw_t</code> ç­‰ç»†èŠ‚</td>
<td align="center">-</td>
</tr>
</tbody>
</table>

<p><img src="/img/2019/objects_in_obj-c/0.png" alt="0" /></p>

<h2 id="preface">Preface</h2>

<p>Obj-C ä¸­çš„å¯¹è±¡åˆ†ä¸ºå®ä¾‹å¯¹è±¡ï¼ˆInstance Objectï¼‰ã€ç±»å¯¹è±¡ï¼ˆClass Objectï¼‰ã€ä»¥åŠå…ƒç±»å¯¹è±¡ï¼ˆMeta-class Objectï¼‰ä¸‰ç§ï¼Œæœ¬æ–‡å°†å€ŸåŠ©æºç ç®€å•äº†è§£ä¸€ä¸‹ä¸åŒç±»å‹å¯¹è±¡çš„çœŸå®æ„é€ ã€‚</p>

<p><img src="/img/2019/objects_in_obj-c/1.png" alt="1" /></p>

<p>ä¸ºäº†æ–¹ä¾¿ä¸‹æ–‡ä¸¾ä¾‹ï¼Œè¿™é‡Œæˆ‘ä»¬å®šä¹‰ä¸€ä¸ª <code>EDdeviceProtocol</code> åè®®ï¼Œå¹¶è®©ç»§æ‰¿è‡ª <code>NSObject</code> çš„ <code>Computer</code> ç±»éµå®ˆè¯¥åè®®ï¼š</p>

<pre><code class="language-objectivec">// EDdeviceProtocol åè®®
@protocol EDdeviceProtocol
- (void)powerOn;
@end

// Computer ç±»ï¼Œç»§æ‰¿è‡ª NSObjectï¼Œéµå®ˆ EDdeviceProtocol
@interface Computer : NSObject &lt;EDdeviceProtocol&gt; {
// æˆå‘˜å˜é‡
@public
    int _memorySize;
    int _diskSize;
}

// å±æ€§
@property (copy) NSString *model;

// å®ä¾‹æ–¹æ³•
- (void)print:(NSString *)content;

// ç±»æ–¹æ³•
+ (NSString *)arch;
@end

@implementation Computer
- (void)print:(NSString *)content {
    NSLog(@&quot;Print content: %@.&quot;, content);
}

// åè®®æ–¹æ³•
- (void)powerOn {
    NSLog(@&quot;%s&quot;, __func__);
}

+ (NSString *)arch {
    return @&quot;ARM 64&quot;;
}
@end
</code></pre>

<h2 id="å®ä¾‹å¯¹è±¡">å®ä¾‹å¯¹è±¡</h2>

<pre><code class="language-objectivec">// cpt ä¸ºæŒ‡å‘ Computer ç±»å‹å®ä¾‹å¯¹è±¡çš„æŒ‡é’ˆ
Computer *cpt = [[Computer alloc] init];

// Direct access to Objective-C's isa is deprecated in favor of object_getClass()
// cpt-&gt;isa;

cpt-&gt;_memorySize = 16;
cpt-&gt;_diskSize = 512;

cpt.model = @&quot;MacBook Pro 13'&quot;;
</code></pre>

<p><code>cpt</code> æŒ‡å‘çš„å®ä¾‹å¯¹è±¡ä¸­å°†å­˜æ”¾ç»§æ‰¿è‡ª <code>NSObject</code> åŸºç±»çš„ <code>isa</code> æŒ‡é’ˆæˆå‘˜å˜é‡ï¼ˆä½†æ— æ³•ç›´æ¥è®¿é—®ï¼‰ä»¥åŠå…¶å®ƒæˆå‘˜å˜é‡çš„å…·ä½“å€¼ï¼š</p>

<pre><code class="language-objectivec">// NSObject.h

@interface NSObject &lt;NSObject&gt; {
#pragma clang diagnostic push
#pragma clang diagnostic ignored &quot;-Wobjc-interface-ivars&quot;
    Class isa  OBJC_ISA_AVAILABILITY;
#pragma clang diagnostic pop
}
</code></pre>

<p>ä½†æˆ‘ä»¬åœ¨ç±»ä¸­å®šä¹‰çš„æ–¹æ³•å“ªé‡Œå»äº†ï¼Ÿ</p>

<h2 id="ç±»å¯¹è±¡">ç±»å¯¹è±¡</h2>

<p>ç”±äºæ–¹æ³•å¹¶ä¸éœ€è¦æ¯ä¸ªç±»éƒ½å•ç‹¬ä¿å­˜ä¸€ä»½ï¼Œåœ¨ Obj-C ä¸­ï¼Œå®ä¾‹æ–¹æ³•å­˜æ”¾åœ¨ç±»å¯¹è±¡ä¸­ï¼Œç±»æ–¹æ³•å­˜å‚¨åœ¨å…ƒç±»å¯¹è±¡ä¸­ã€‚ä¸å®ä¾‹å¯¹è±¡ä¸åŒï¼Œç±»å¯¹è±¡å’Œå…ƒç±»å¯¹è±¡å¹¶ä¸éœ€è¦æˆ‘ä»¬æ‰‹åŠ¨åˆ›å»ºã€‚ç±»å¯¹è±¡å¯ä»¥é€šè¿‡ <code>[obj class]</code>ã€<code>[Computer class]</code> æˆ– Runtime API <code>object_getClass</code> è·å–ï¼š</p>

<pre><code class="language-objectivec">// è·å–ç±»å¯¹è±¡çš„æ–¹æ³•ï¼š
Class cptClass1 = [cpt class];
Class cptClass2 = [Computer class];
Class cptClass3 = object_getClass(cpt);

// LLDB:
// (lldb) p/x cptClass1
// (Class) $0 = 0x00000001000013d0 Computer
// (lldb) p/x cptClass2
// (Class) $1 = 0x00000001000013d0 Computer
// (lldb) p/x cptClass3
// (Class) $2 = 0x00000001000013d0 Computer
</code></pre>

<p>ç±»å¯¹è±¡çš„ç±»å‹æ˜¯ <code>Class</code>ï¼Œæœ¬è´¨æ˜¯æŒ‡å‘ <code>struct objc_class</code> ç»“æ„ä½“çš„æŒ‡é’ˆã€‚ç±»å¯¹è±¡ä¸­å­˜æ”¾äº† <code>isa</code>ã€<code>superclass</code>ã€æ–¹æ³•ç¼“å­˜ã€ä»¥åŠä¸ºè¯¥ç±»å®ä¾‹å¯¹è±¡æ‰€å…¬ç”¨çš„ä¸€äº›ä¿¡æ¯ï¼š</p>

<pre><code class="language-objectivec">// Object.mm

typedef struct objc_class *Class;

// objc-runtime-new.h
struct objc_class : objc_object {
    // Class ISA;
    // â¡ï¸ çˆ¶ç±»æŒ‡é’ˆ
    Class superclass;
    // â¡ï¸ æ–¹æ³•ç¼“å­˜ï¼Œè¯¦è§ Reference
    cache_t cache;             // formerly cache pointer and vtable
    // â¡ï¸ å¯è¯»å¯å†™è¡¨ï¼ˆclass_rw_tï¼‰ç­‰
    class_data_bits_t bits;    // class_rw_t * plus custom rr/alloc flags

    // ...
};

// objc-private.h
struct objc_object {
private:
    // â¡ï¸ isa æŒ‡é’ˆ
    isa_t isa;

// ...
}
</code></pre>

<h3 id="class-rw-t">class_rw_t</h3>

<p><code>class_data_bits_t bits;</code> ä¸­ä¸»è¦å­˜å‚¨ç€ <code>class_rw_t</code> å’Œè‡ªå®šä¹‰çš„æ ‡å¿—ä½ï¼š</p>

<pre><code class="language-objectivec">// objc-runtime-new.h

struct objc_class : objc_object {
    // ...

    class_rw_t *data() {
        return bits.data();
    }

    // ...
}

#if !__LP64__
// data pointer
#define FAST_DATA_MASK        0xfffffffcUL
#elif 1
#define FAST_DATA_MASK          0x00007ffffffffff8UL // âœ…
#else
#define FAST_DATA_MASK          0x00007ffffffffff8UL
#endif

struct class_data_bits_t {
    // Values are the FAST_ flags above.
    uintptr_t bits;

    // ...

    class_rw_t* data() {
        return (class_rw_t *)(bits &amp; FAST_DATA_MASK);
    }

    // ...
}
</code></pre>

<p><code>class_data_bits_t bits;</code> ä¸­åªæœ‰ä¸€ä¸ª <code>uintptr_t bits</code>ï¼Œæœ¬è´¨æ˜¯ <code>unsigned long</code> ç±»å‹ï¼Œå ç”¨ 8 ä¸ªå­—èŠ‚ã€‚ä½†å…¶å­˜å‚¨æ–¹å¼å¾ˆç±»ä¼¼ä½åŸŸï¼Œå³å°†ä¸åŒçš„æ•°æ®å­˜å‚¨åœ¨ä¸åŒçš„ä½ä¸­ï¼š</p>

<table>
<thead>
<tr>
<th align="center">Bits</th>
<th align="center">Expresstion</th>
</tr>
</thead>

<tbody>
<tr>
<td align="center">0</td>
<td align="center">-</td>
</tr>

<tr>
<td align="center">1</td>
<td align="center"><code>FAST_IS_SWIFT_LEGACY</code>ï¼šæ ‡å¿— Swift ç±»æ˜¯å¦æ¥è‡ªäºå°šä¸ç¨³å®šçš„ Swift ABI</td>
</tr>

<tr>
<td align="center">2</td>
<td align="center"><code>FAST_IS_SWIFT_STABLE</code>ï¼šæ ‡å¿— Swift ç±»æ˜¯å¦æ¥è‡ªäºç¨³å®šçš„ Swift ABI</td>
</tr>

<tr>
<td align="center">3</td>
<td align="center"><code>FAST_HAS_DEFAULT_RR</code>ï¼šç±»æˆ–çˆ¶ç±»å«æœ‰é»˜è®¤çš„æŒæœ‰æˆ–å¼•ç”¨ï¼ˆRetain/Referenceï¼‰<code>retain</code>/<code>release</code>/<code>autorelease</code>/<code>retainCount</code>/<code>_tryRetain</code>/<code>_isDeallocating</code>/<code>retainWeakReference</code>/<code>allowsWeakReference</code></td>
</tr>

<tr>
<td align="center">47</td>
<td align="center"><code>FAST_DATA_MASK</code>ï¼š<code>class_rw_t</code></td>
</tr>

<tr>
<td align="center">63</td>
<td align="center">-</td>
</tr>
</tbody>
</table>

<p><code>class_rw_t</code> æŒ‡çš„æ˜¯å¯è¯»å¯å†™ï¼ˆRead-Writeï¼‰è¡¨ã€‚å…¶ä¸­å­˜å‚¨äº†æŒ‡å‘ <code>class_ro_t</code> åªè¯»è¡¨çš„æŒ‡é’ˆã€æ–¹æ³•ã€å±æ€§ã€åè®®ç­‰ä¿¡æ¯ï¼š</p>

<pre><code class="language-objectivec">// objc-runtime-new.h

// â¡ï¸ å¯è¯»å¯å†™è¡¨
struct class_rw_t {
    // Be warned that Symbolication knows the layout of this structure.
    uint32_t flags;
    uint32_t version;

    // â¡ï¸ åªè¯»è¡¨çš„æŒ‡é’ˆï¼ˆconstï¼šä¸å¯ä¿®æ”¹æŒ‡é’ˆæŒ‡å‘å†…å­˜ç©ºé—´ä¸­çš„æ•°æ®ï¼‰
    const class_ro_t *ro;

    // â¡ï¸ æ–¹æ³•ã€å±æ€§ã€åè®®ä¿¡æ¯
    method_array_t methods;
    property_array_t properties;
    protocol_array_t protocols;

    // ...
};
</code></pre>

<p>æˆ‘ä»¬ä»¥ <code>method_array_t methods;</code> ä¸ºä¾‹çœ‹ä¸€ä¸‹å…¶ç±»å‹ï¼š</p>

<pre><code class="language-cpp">// objc-runtime-new.h

// method_array_t ç»§æ‰¿è‡ª list_array_ttï¼Œå…¶ä¸­ List ç±»å‹ä¸º method_list_tï¼ŒElement ç±»å‹ä¸º method_t
class method_array_t :
    public list_array_tt&lt;method_t, method_list_t&gt;
{
    // ...
};

// list_array_tt ä¸­å®šä¹‰äº†å…ƒç´ ç±»å‹ä¸º Elementï¼Œåˆ—è¡¨ä¸º List
template &lt;typename Element, typename List&gt;
class list_array_tt {
    // ...
};

// method_t å³æ˜¯ Obj-C ä¸­æ–¹æ³•çš„ç»“æ„ï¼ˆè¯¦è§ä¸‹æ–‡ï¼‰
struct method_t {
    SEL name;
    const char *types;
    MethodListIMP imp;

    // ...
};

// method_list_t ç»§æ‰¿è‡ª entsize_list_ttï¼Œå…¶ä¸­ List ç±»å‹ä¸º method_list_tï¼ŒElement ç±»å‹ä¸º method_t
struct method_list_t : entsize_list_tt&lt;method_t, method_list_t, 0x3&gt; {
    // ...
};

// entsize_list_tt æ˜¯éè„†å¼±ï¼ˆNon-fragileï¼‰ç»“æ„ä½“æ•°ç»„çš„ä¸€èˆ¬å®ç°
template &lt;typename Element, typename List, uint32_t FlagMask&gt;
struct entsize_list_tt {
    // ...
};
</code></pre>

<p>ç”±äº Obj-C ä¸­çš„ <code>Class</code> æ˜¯ä¸€ä¸ªä¸é€æ˜ç±»å‹ï¼Œä½†æˆ‘ä»¬å¯ä»¥å°è¯•ä¸€ä¸‹å°†ç±»å¯¹è±¡çš„åŸå§‹ç»“æ„æ¡¥æ¥åˆ°å…¶ä¸­ï¼Œé¦–å…ˆéœ€è¦å°†ä»¥ä¸‹æˆ‘æ•´ç†å¥½çš„å†…å®¹æ”¾åœ¨ <code>.h</code> å¼•å…¥ï¼Œéœ€è¦æ³¨æ„çš„æ˜¯å¼•å…¥çš„å®ç°æ–‡ä»¶éœ€è¦æ”¯æŒ C++ï¼Œå³ä»¥ <code>.mm</code> ç»“å°¾ï¼š</p>

<p><details>
<summary>-&gt; ç‚¹å‡»æ­¤å¤„å³å¯æŸ¥çœ‹å®Œæ•´å†…å®¹ &lt;-</summary></p>

<pre><code class="language-cpp">//
//  class_details.h
//  Powered by kingcos.me
//
//  Created by kingcos on 2019/8/31.
//  Copyright Â© 2019 kingcos. All rights reserved.
//

#ifndef class_details_h
#define class_details_h

#define FAST_DATA_MASK          0x00007ffffffffff8UL

typedef struct v_objc_class *V_Class;
typedef unsigned long v_uintptr_t;
typedef v_uintptr_t v_cache_key_t;
typedef uint32_t v_mask_t;
typedef v_uintptr_t v_protocol_ref_t;

struct v_bucket_t {
    IMP _imp;
    v_cache_key_t _key;
};

struct v_cache_t {
    struct v_bucket_t *_buckets;
    v_mask_t _mask;
    v_mask_t _occupied;
};

union v_isa_t {
    V_Class cls;
    v_uintptr_t bits;
};

struct v_objc_object {
    v_isa_t isa;
};

template &lt;typename Element, typename List, uint32_t FlagMask&gt;
struct v_entsize_list_tt {
    uint32_t entsizeAndFlags;
    uint32_t count;
    Element first;
};

struct v_method_t {
    SEL name;
    const char *types;
    IMP imp;
};

struct v_method_list_t : v_entsize_list_tt&lt;v_method_t, v_method_list_t, 0x3&gt; {
};

struct v_protocol_list_t {
    uintptr_t count;
};

struct v_ivar_t {
    int32_t *offset;
    const char *name;
    const char *type;
    // alignment is sometimes -1; use alignment() instead
    uint32_t alignment_raw;
    uint32_t size;
};

struct v_ivar_list_t : v_entsize_list_tt&lt;v_ivar_t, v_ivar_list_t, 0&gt; {
};

struct v_property_t {
    const char *name;
    const char *attributes;
};

struct v_property_list_t : v_entsize_list_tt&lt;v_property_t, v_property_list_t, 0&gt; {
};

struct v_class_ro_t {
    uint32_t flags;
    uint32_t instanceStart;
    uint32_t instanceSize;
    uint32_t reserved;

    const uint8_t * ivarLayout;

    const char * name;
    v_method_list_t * baseMethodList;
    v_protocol_list_t*** * baseProtocols;
    const v_ivar_list_t * ivars;

    const uint8_t * weakIvarLayout;
    v_property_list_t *baseProperties;
};

template &lt;typename Element, typename List&gt;
class v_list_array_tt {
    union {
        List* list;
        v_uintptr_t arrayAndFlag;
    };
};

class v_method_array_t :
public v_list_array_tt&lt;v_method_t, v_method_list_t&gt;
{
};

class v_property_array_t :
public v_list_array_tt&lt;v_property_t, v_property_list_t&gt;
{
};

class v_protocol_array_t :
public v_list_array_tt&lt;v_protocol_ref_t, v_protocol_list_t&gt;
{
};

struct v_class_rw_t {
    uint32_t flags;
    uint32_t version;

    const v_class_ro_t *ro;

    v_method_array_t methods;
    v_property_array_t properties;
    v_protocol_array_t protocols;
};

struct v_class_data_bits_t {
    v_uintptr_t bits;

    v_class_rw_t* data() {
        return (v_class_rw_t *)(bits &amp; FAST_DATA_MASK);
    }
};

struct v_objc_class : v_objc_object {
    V_Class superclass;
    v_cache_t cache;
    v_class_data_bits_t bits;

    v_class_rw_t *data() {
        return bits.data();
    }
};

#endif /* class_details_h */
</code></pre>

<p></details></p>

<pre><code class="language-objectivec">@protocol Bar &lt;NSObject&gt;
@optional
- (void)optional;
@end

@interface Foo : NSObject &lt;Bar&gt;
@property (nonatomic, copy) NSString *fooStr;
@end

@implementation Foo
- (void)foo {
    NSLog(@&quot;%s&quot;, __func__);
}
@end

@interface Foo (Baz)
@end

@implementation Foo (Bar)
- (void)bar {
    NSLog(@&quot;%s&quot;, __func__);
}
- (void)optional {
    NSLog(@&quot;%s&quot;, __func__);
}
@end
</code></pre>

<p>è¿™æ ·ï¼Œæˆ‘ä»¬å°†ç±»æˆ–å…ƒç±»å¯¹è±¡è½¬æ¢ä¸ºå…¶çœŸå®ç»“æ„æ—¶å°±èƒ½çœ‹åˆ°å…¶ä¸­çš„ç»†èŠ‚äº†ï¼š</p>

<pre><code class="language-objectivec">V_Class fooClassObject = (__bridge V_Class)[Foo class];
v_class_rw_t *fooRWTable = fooClassObject-&gt;data();
</code></pre>

<p><img src="/img/2019/objects_in_obj-c/4.png" alt="4" /></p>

<blockquote>
<p><em>æœ‰å¿ƒçš„åŒå­¦å¯èƒ½ä¼šå‘ç°ï¼Œè¿™é‡Œçš„æ–¹æ³•åˆ—è¡¨ä¸ªæ•°æ˜¾ç¤ºä¸º 6ï¼Œæ ¹æ®ä¸Šé¢çš„ Obj-C æºç ï¼Œåº”å½“æ˜¯ getter &amp; setter ä»¥åŠ <code>foo</code>ã€<code>bar</code> å’Œ <code>optional</code>ï¼Œé‚£ä¹ˆæ€ä¹ˆä¼šå¤šä¸€ä¸ªå‘¢ï¼Ÿå…¶å®è¿™æ˜¯ç”±äºå®šä¹‰å±æ€§ï¼Œå¢åŠ äº†ä¸€ä¸ªåä¸º <code>.cxx_destruct</code> çš„æ–¹æ³•ï¼Œå…³äºæ­¤æœ¬æ–‡ä¸å†æ¶‰åŠï¼Œè€ƒè™‘æ”¾ç½®åœ¨ <code>dealloc</code> ç›¸å…³çš„æ–‡ç« ä¸­ã€‚</em></p>
</blockquote>

<p><code>class_rw_t</code> ä¸­ç›´æ¥å­˜å‚¨çš„æ–¹æ³•ã€å±æ€§å’Œåè®®éƒ½ç»§æ‰¿è‡ª <code>list_array_tt&lt;Element, List&gt;</code>ï¼Œå…¶ä¸­çš„å€¼å…±æœ‰ä¸‰ç§å¯èƒ½ï¼š</p>

<ol>
<li>ç©ºï¼›å³æ²¡æœ‰å®šä¹‰ä»»ä½•å†…å®¹</li>
<li>ä¸€ä¸ªæŒ‡å‘å•ä¸€åˆ—è¡¨çš„æŒ‡é’ˆï¼›å³åªå­˜å‚¨äº†ç¼–è¯‘æ—¶ï¼ˆåŒ…æ‹¬ç±»æœ¬èº«å’Œåˆ†ç±»ä¸­ï¼‰ç¡®å®šçš„å†…å®¹</li>
<li>ä¸€ä¸ªæŒ‡å‘åˆ—è¡¨çš„æŒ‡é’ˆæ•°ç»„ï¼ˆç±»ä¼¼äºŒç»´æ•°ç»„ï¼‰ï¼›å³å­˜å‚¨äº†ç¼–è¯‘æ—¶ç¡®å®šä»¥åŠè¿è¡Œæ—¶é™„åŠ çš„å†…å®¹</li>
</ol>

<h3 id="class-ro-t">class_ro_t</h3>

<p><code>class_ro_t</code> å­˜åœ¨äº <code>class_rw_t</code> ä¸­ï¼Œæ˜¯åªè¯»ï¼ˆRead-Onlyï¼‰è¡¨ï¼š</p>

<pre><code class="language-cpp">// objc-runtime-new.h

// â¡ï¸ åªè¯»è¡¨
struct class_ro_t {
    // â¡ï¸ æ ‡å¿—ä½
    uint32_t flags;
    uint32_t instanceStart;
    // â¡ï¸ å®ä¾‹å¤§å°
    uint32_t instanceSize;
#ifdef __LP64__
    uint32_t reserved;
#endif

    const uint8_t * ivarLayout;

    // â¡ï¸ ç±»å
    const char * name;
    method_list_t * baseMethodList;
    protocol_list_t * baseProtocols;
    // â¡ï¸ æˆå‘˜å˜é‡
    const ivar_list_t * ivars;

    const uint8_t * weakIvarLayout;
    property_list_t *baseProperties;

    method_list_t *baseMethods() const {
        return baseMethodList;
    }
};
</code></pre>

<p>è€Œä¸ <code>class_rw_t</code> ä¸åŒçš„æ˜¯ï¼Œ<code>class_ro_t</code> ä¸­çš„æ–¹æ³•ã€å±æ€§ã€æˆå‘˜å˜é‡åˆ†åˆ«ç›´æ¥ç»§æ‰¿è‡ª <code>method_list_t</code>ã€<code>ivar_list_t</code> å’Œ <code>property_list_t</code>ï¼Œ å°‘äº†ä¸€ç»´ã€‚è¿™æ˜¯å› ä¸ºåªè¯»è¡¨åªå­˜å‚¨ç¼–è¯‘æ—¶ï¼ˆåŒ…æ‹¬ç±»æœ¬èº«å’Œåˆ†ç±»ä¸­ï¼‰ç¡®å®šçš„å†…å®¹ï¼Œåœ¨è¿è¡Œæ—¶å°†ä¸ä¼šå†æ¬¡é™„åŠ å…¶å®ƒçš„æ•°æ®ã€‚</p>

<p>ä¸ºäº†è¯æ˜ç»“è®ºï¼Œæˆ‘ä»¬å†ç®€å•äº†è§£ä¸€ä¸‹ç±»åœ¨é¦–æ¬¡åˆå§‹åŒ–ä¸­æ‰€æ‰§è¡Œçš„ <code>realizeClass</code> æ–¹æ³•ï¼š</p>

<pre><code class="language-cpp">// objc-runtime-new.h

// class is unrealized future class - must never be set by compiler
#define RO_FUTURE             (1&lt;&lt;30)
// class is realized - must never be set by compiler
#define RO_REALIZED           (1&lt;&lt;31)

// class_t-&gt;data is class_rw_t, not class_ro_t
#define RW_REALIZED           (1&lt;&lt;31)
// class is unresolved future class
#define RW_FUTURE             (1&lt;&lt;30)

// objc-runtime-new.mm

/***********************************************************************
* realizeClass
* Performs first-time initialization on class cls,
* åœ¨ç±»ä¸Šæ‰§è¡Œé¦–æ¬¡åˆå§‹åŒ–ï¼Œ
* including allocating its read-write data.
* åŒ…æ‹¬åˆ†é…è¯»å†™æ•°æ®ã€‚
* Returns the real class structure for the class.
* è¿”å›ç±»çš„çœŸå®ç±»ç»“æ„ã€‚
* Locking: runtimeLock must be write-locked by the caller
**********************************************************************/
static Class realizeClass(Class cls)
{
    runtimeLock.assertLocked();

    // åªè¯»è¡¨æŒ‡é’ˆ
    const class_ro_t *ro;
    // å¯è¯»å¯å†™è¡¨æŒ‡é’ˆ
    class_rw_t *rw;
    Class supercls;
    Class metacls;
    bool isMeta;

    // åˆ¤ç©º
    if (!cls) return nil;
    // åˆ¤æ–­æ˜¯å¦å·²ç»å®åŒ–
    if (cls-&gt;isRealized()) return cls;
    assert(cls == remapClass(cls));

    // fixme verify class is not in an un-dlopened part of the shared cache?

    // å®åŒ–å‰ï¼Œcls-&gt;data() è¿”å›æŒ‡å‘åªè¯»è¡¨çš„æŒ‡é’ˆï¼Œå› æ­¤å¯ä»¥å¼ºè½¬
    ro = (const class_ro_t *)cls-&gt;data();
    // åˆ¤æ–­æ˜¯å¦ä¸ºæœªæ¥çš„ç±»ï¼ˆå³ RO_FUTURE æ ‡å¿—ç€è¯»å†™æ•°æ®æ˜¯å¦å·²ç»è¢«åˆ†é…ï¼‰
    // å¯è¯»å¯å†™è¡¨å’Œåªè¯»è¡¨çš„é¦–ä¸ªæˆå‘˜å‡ä¸º flags ä¸” RO_FUTURE ä¸ RW_FUTURE å®é™…å€¼ç›¸åŒ
    if (ro-&gt;flags &amp; RO_FUTURE) {
        // 2âƒ£ï¸
        // This was a future class. rw data is already allocated.
        // å°†æ•°æ®èµ‹å€¼ç»™å¯è¯»å¯å†™è¡¨
        rw = cls-&gt;data();
        // å°†å¯è¯»å¯å†™è¡¨ä¸­çš„åªè¯»è¡¨èµ‹å€¼ç»™åªè¯»è¡¨
        ro = cls-&gt;data()-&gt;ro;
        // æ›´æ–°æ ‡è®°ä½
        cls-&gt;changeInfo(RW_REALIZED|RW_REALIZING, RW_FUTURE);
    } else {
        // 1âƒ£ï¸
        // Normal class. Allocate writeable class data.
        // æ™®é€šç±»ï¼Œåˆ†é…å¯å†™å…¥ç±»æ•°æ®ã€‚
        // åˆ†é…ç©ºé—´
        rw = (class_rw_t *)calloc(sizeof(class_rw_t), 1);
        // å°†å¯è¯»å¯å†™è¡¨çš„åªè¯»è¡¨æŒ‡é’ˆæŒ‡å‘åªè¯»è¡¨æŒ‡é’ˆ
        rw-&gt;ro = ro;
        // æ›´æ–°æ ‡è®°ä½
        rw-&gt;flags = RW_REALIZED|RW_REALIZING;
        // å°†å¯è¯»å¯å†™è¡¨å†™å›ç±»ä¸­
        cls-&gt;setData(rw);
    }

    // ...

    return cls;
}
</code></pre>

<h3 id="method-t">method_t</h3>

<p><code>method_t</code> æ˜¯ Obj-C ä¸­æ–¹æ³•çš„æœ¬è´¨ç±»å‹ï¼š</p>

<pre><code class="language-cpp">// objc.h

/// An opaque type that represents a method selector.
typedef struct objc_selector *SEL;

// objc-ptrauth.h

#if __has_feature(ptrauth_calls)
// Method lists use process-independent signature for compatibility.
using MethodListIMP = IMP __ptrauth_objc_method_list_imp;
#else
using MethodListIMP = IMP;
#endif

struct method_t {
    SEL name;
    const char *types;
    MethodListIMP imp;

    struct SortBySELAddress :
        public std::binary_function&lt;const method_t&amp;,
                                    const method_t&amp;, bool&gt;
    {
        bool operator() (const method_t&amp; lhs,
                         const method_t&amp; rhs)
        { return lhs.name &lt; rhs.name; }
    };
};
</code></pre>

<p><code>method_t</code> ä¸­å­˜å‚¨äº†æ–¹æ³•çš„åç§°ã€ç±»å‹å’Œ <code>IMP</code>ï¼š</p>

<table>
<thead>
<tr>
<th align="center">Member</th>
<th align="center">Notes</th>
</tr>
</thead>

<tbody>
<tr>
<td align="center"><code>SEL name;</code></td>
<td align="center">æ–¹æ³•åï¼Œåˆç§°æ–¹æ³•é€‰æ‹©å™¨ï¼ˆSelectorï¼‰ï¼ŒåŒåæ–¹æ³•å³ä½¿ä¸åŒç±»ä¹Ÿæ‹¥æœ‰ç›¸åŒçš„ <code>SEL</code> ç±»å‹æ–¹æ³•åï¼›å…¶åº•å±‚æ•°æ®ç±»å‹ä¸º <code>struct objc_selector</code> ä½†æ²¡æœ‰æ‰¾åˆ°ç›¸å…³å¼€æºï¼Œå¯è¿‘ä¼¼è®¤ä¸ºæ˜¯ C ä¸­ <code>char *</code> å­—ç¬¦ä¸²ï¼›å¯ä»¥ä½¿ç”¨ <code>@selector()</code> æˆ– <code>sel_registerName()</code> æ–¹æ³•ä¼ å…¥æ–¹æ³•æ¥å¾—åˆ°æ–¹æ³•åï¼›ä¹Ÿå¯é€šè¿‡ <code>sel_getName()</code> æˆ– <code>NSStringFromSelector()</code> å°† <code>SEL</code> ç±»å‹è½¬æ¢ä¸º <code>char *</code> æˆ– <code>NSString</code></td>
</tr>

<tr>
<td align="center"><code>const char *types;</code></td>
<td align="center">æ–¹æ³•ç±»å‹ç¼–ç ï¼ˆType Encodingï¼‰ï¼Œå°†æ–¹æ³•çš„è¿”å›å€¼ã€å‚æ•°ç­‰ä¿¡æ¯ç¼–ç çš„å­—ç¬¦ä¸²ï¼›Obj-C æ–¹æ³•é»˜è®¤ä¼šæœ‰ä¸¤ä¸ªå‚æ•°ï¼Œå³ <code>id self</code> &amp; <code>SEL op</code>ï¼Œå› æ­¤é»˜è®¤å°±ä¼šæœ‰ <code>@:</code>ï¼Œé¦–ä¸ªæ•°å­—ä»£è¡¨æ‰€æœ‰å‚æ•°å ç”¨çš„æ€»å­—èŠ‚æ•°ï¼Œåç»­åˆ™ä»£è¡¨æ¯ä¸ªå‚æ•°çš„èµ·å§‹å­—èŠ‚æ•°ï¼›<code>@encode()</code>ï¼›è¯¦ç»†å¯è§ <a href="https://developer.apple.com/library/archive/documentation/Cocoa/Conceptual/ObjCRuntimeGuide/Articles/ocrtTypeEncodings.html">Type Encodings - Objective-C Runtime Programming Guide</a></td>
</tr>

<tr>
<td align="center"><code>MethodListIMP imp;</code></td>
<td align="center">æ–¹æ³•å®ç°ï¼Œå³æ–¹æ³•çš„å†…å­˜åœ°å€ï¼Œç±»ä¼¼ C ä¸­çš„å‡½æ•°æŒ‡é’ˆï¼Œå¯ä»¥é€šè¿‡è¯¥åœ°å€è®¿é—®åˆ°æ–¹æ³•çš„ä»£ç å—è¿›è€Œæ‰§è¡Œ</td>
</tr>
</tbody>
</table>

<h2 id="å…ƒç±»å¯¹è±¡">å…ƒç±»å¯¹è±¡</h2>

<p>å…ƒç±»å¯¹è±¡å’Œç±»å¯¹è±¡ä¸€æ ·ï¼Œéƒ½æ˜¯ <code>Class</code> ç±»å‹ï¼Œä½†å…ƒç±»å¯¹è±¡åªå¯ä»¥é€šè¿‡ Runtime çš„ <code>object_getClass</code> API ä¼ å…¥ç±»å¯¹è±¡ï¼Œè·å–åˆ°å…ƒç±»å¯¹è±¡ã€‚éœ€è¦æ³¨æ„çš„æ˜¯ <code>[[Computer class] class]</code> æˆ– <code>[[cpt class] class]</code> éƒ½åªèƒ½è¿”å›ç±»å¯¹è±¡ã€‚</p>

<p>å¯¹äº <code>object_getClass</code>ï¼Œå¦‚æœå‚æ•°æ˜¯å®ä¾‹å¯¹è±¡ï¼Œè¿”å›ç±»å¯¹è±¡ï¼›å¦‚æœå‚æ•°æ˜¯ç±»å¯¹è±¡ï¼Œè¿”å›å…ƒç±»å¯¹è±¡ï¼›å¦‚æœå‚æ•°æ˜¯å…ƒç±»å¯¹è±¡ï¼Œè¿”å› NSObjectï¼ˆåŸºç±»ï¼‰çš„å…ƒç±»å¯¹è±¡ã€‚<code>class_isMetaClass</code> å¯ä»¥ç”¨æ¥æ£€æŸ¥ <code>Class</code> æ˜¯å¦ä¸ºå…ƒç±»å¯¹è±¡ã€‚</p>

<pre><code class="language-objectivec">VClass cptMetaVClass = (__bridge VClass)object_getClass([Computer class]);
class_rw_t *rwt = cptMetaVClass-&gt;data();

// LLDB:
// Printing description of rwt-&gt;methods-&gt;first:
// (method_t) first = {
//     name = &quot;arch&quot;
//     types = 0x0000000100000f86 &quot;@16@0:8&quot;
//     imp = 0x0000000100000d40 (DemoOC`::+[Computer arch]() at main.mm:52)
// }
</code></pre>

<p>å…ƒç±»å¯¹è±¡ä¸­é™¤äº†å­˜å‚¨ <code>isa</code> å’Œ <code>superclass</code> æŒ‡é’ˆï¼Œè¿˜å­˜å‚¨äº†ç±»æ–¹æ³•ã€‚å…¶å­˜æ”¾ä½ç½®å’Œç±»å¯¹è±¡å­˜æ”¾å®ä¾‹æ–¹æ³•çš„å­˜æ”¾ä½ç½®ï¼ˆæ–¹æ³•åˆ—è¡¨ï¼‰ä¸€è‡´ã€‚</p>

<h2 id="superclass">superclass</h2>

<p><img src="/img/2019/objects_in_obj-c/3.png" alt="3" /></p>

<h3 id="what">What</h3>

<p><code>superclass</code> æ˜¯ä»…å­˜åœ¨äºç±»å¯¹è±¡å’Œå…ƒç±»å¯¹è±¡çš„ä¸€ä¸ªæˆå‘˜ã€‚ç±»å¯¹è±¡ä¸­çš„ <code>superclass</code> æŒ‡å‘å½“å‰ç±»çš„çˆ¶ç±»ï¼Œå…ƒç±»å¯¹è±¡ä¸­çš„ <code>superclass</code> æŒ‡å‘è¯¥å…ƒç±»å¯¹è±¡çš„çˆ¶ç±»ã€‚åŸºç±» <code>NSObject</code> çš„ <code>superclass</code> æŒ‡å‘ <code>nil</code>ï¼Œæ ¹å…ƒç±»å¯¹è±¡çš„ <code>superclass</code> æŒ‡å‘åŸºç±» <code>NSObject</code> çš„ç±»å¯¹è±¡ã€‚</p>

<h3 id="isa-superclass">isa &amp; superclass</h3>

<p><code>isa</code> å°†å®ä¾‹å¯¹è±¡ä¸ç±»å¯¹è±¡ã€å…ƒç±»å¯¹è±¡è¿æ¥èµ·æ¥ï¼›<code>superclass</code> å°†å­ç±»ã€çˆ¶ç±»ã€åŸºç±»è¿æ¥èµ·æ¥ã€‚</p>

<p>å½“å‘ä¸€ä¸ªå®ä¾‹å‘é€å®ä¾‹æ–¹æ³•çš„æ¶ˆæ¯æ—¶ï¼ˆä¹Ÿå¯ç§°è°ƒç”¨å®ä¾‹æ–¹æ³•ï¼Œä½†å› ä¸º Obj-C æ˜¯æ¶ˆæ¯ç»“æ„çš„è¯­è¨€ï¼Œæ–¹æ³•è°ƒç”¨å¹¶ä¸ä¸¥è°¨ï¼‰ï¼Œè¯¥å®ä¾‹å¯¹è±¡ä¼šé€šè¿‡ <code>isa</code> æ‰¾åˆ°å…¶ç±»å¯¹è±¡ï¼Œå› ä¸ºå®ä¾‹æ–¹æ³•å­˜å‚¨åœ¨ç±»å¯¹è±¡ä¸­ï¼›å¦‚æœè¯¥ç±»çš„ç±»å¯¹è±¡ä¸­å¹¶æ²¡æœ‰å­˜å‚¨è¯¥å®ä¾‹æ–¹æ³•ï¼Œå…¶ç±»å¯¹è±¡å°†ä½¿ç”¨ <code>superclass</code> æ‰¾åˆ°å…¶çˆ¶ç±»çš„ç±»å¯¹è±¡ï¼Œå¹¶åœ¨å…¶ä¸­æŸ¥æ‰¾å®ä¾‹æ–¹æ³•ï¼›ç›´åˆ°åœ¨ <code>NSObject</code> åŸºç±»çš„ç±»å¯¹è±¡ä¹Ÿæ— æ³•æ‰¾åˆ°æ—¶ï¼Œ<code>superclass</code> å°†æŒ‡å‘ <code>nil</code> åœæ­¢æŸ¥æ‰¾ï¼ŒæŠ›å‡ºå¼‚å¸¸ï¼š<code>unrecognized selector sent to instance</code>ï¼ˆæ³¨æ„ï¼Œæˆ‘ä»¬è¿™é‡Œä»…è®¨è®ºæ¶ˆæ¯ä¼ é€’ï¼Œæš‚æ—¶å¿½ç•¥æ¶ˆæ¯è½¬å‘ï¼‰ã€‚</p>

<pre><code class="language-objectivec">@interface Computer : NSObject
- (void)run;
@end

@implementation Computer
@end

@interface Mac : Computer
@end

@implementation Mac
// - (void)run {
//     NSLog(@&quot;RUN&quot;);
// }
@end

// '-[Mac run]: unrecognized selector sent to instance 0x10330f6c0'
[[[Mac alloc] init] run];
</code></pre>

<p>å½“å‘ä¸€ä¸ªç±»ï¼ˆçš„ç±»å¯¹è±¡ï¼‰å‘é€ç±»æ–¹æ³•çš„æ¶ˆæ¯æ—¶ï¼Œä¸ä¼šç»è¿‡å®ä¾‹å¯¹è±¡ï¼›ç±»å¯¹è±¡ä¼šé€šè¿‡å…¶ <code>isa</code> æŒ‡é’ˆæ‰¾åˆ°å…¶å…ƒç±»å¯¹è±¡ï¼Œå› ä¸ºç±»æ–¹æ³•å­˜å‚¨åœ¨å…ƒç±»å¯¹è±¡ä¸­ï¼›å¦‚æœè¯¥ç±»çš„å…ƒç±»å¯¹è±¡ä¸­å¹¶æ²¡æœ‰å­˜å‚¨è¯¥ç±»æ–¹æ³•ï¼Œå…¶å…ƒç±»å¯¹è±¡å°†ä½¿ç”¨ <code>superclass</code> æ‰¾åˆ°å…¶çˆ¶ç±»çš„å…ƒç±»å¯¹è±¡ï¼Œå¹¶åœ¨å…¶ä¸­æŸ¥æ‰¾ç±»æ–¹æ³•ï¼›ç›´åˆ°æŸ¥æ‰¾åˆ° <code>NSObject</code> åŸºç±»çš„å…ƒç±»å¯¹è±¡è¿˜æ²¡æœ‰è¯¥ç±»æ–¹æ³•æ—¶ï¼Œ<code>NSObject</code> å…ƒç±»å¯¹è±¡çš„ <code>superclass</code> å°†æŒ‡å› <code>NSObject</code> ç±»å¯¹è±¡ä¸­ï¼Œåœ¨å…¶å­˜å‚¨çš„å®ä¾‹æ–¹æ³•åˆ—è¡¨ä¸­æŸ¥æ‰¾ï¼Œè‹¥æ­¤æ—¶è¿˜æ²¡æœ‰æ‰¾åˆ°å°†åœæ­¢æŸ¥æ‰¾ï¼Œå¹¶æŠ›å‡ºå¼‚å¸¸ï¼š<code>unrecognized selector sent to instance</code>ï¼Œå› ä¸º <code>NSObject</code> ç±»å¯¹è±¡çš„ <code>superclass</code> å°†æŒ‡å‘ <code>nil</code>ã€‚</p>

<pre><code class="language-objectivec">@interface NSObject (Extension)
@end

@implementation NSObject (Extension)
- (void)run {
    NSLog(@&quot;RUN&quot;);
}
@end

@interface Computer : NSObject
+ (void)run;
@end

@implementation Computer
@end

@interface Mac : Computer
@end

@implementation Mac
@end

// OUTPUT:
// RUN
</code></pre>

<p>é€šè¿‡ä¸Šä¸€ç‚¹ï¼Œå…¶å®æˆ‘ä»¬å¯ä»¥çŸ¥é“åœ¨ Obj-C ä¸­ï¼Œæ–¹æ³•æ˜¯é€šè¿‡æ¶ˆæ¯ä¼ é€’çš„ï¼Œè€Œä¼ é€’çš„æ¶ˆæ¯å…¶å®å°±æ˜¯æ–¹æ³•åçš„ <code>SEL</code>ï¼Œå› æ­¤è¿™ä¹Ÿæ˜¯ä¸¥è°¨æ„ä¹‰ä¸Š Obj-C ä¸æ”¯æŒé‡è½½ï¼ˆOverloadï¼‰çš„åŸå› ï¼ˆä½†æ”¯æŒå‚æ•°ä¸ªæ•°ä¸åŒçš„é‡è½½ï¼‰ï¼Œå…·ä½“å¯å‚è€ƒ <a href="../override_and_overload_in_obj-c/">Obj-C ä¸­çš„é‡è½½ä¸é‡å†™</a>ä¸€æ–‡ã€‚</p>

<h2 id="reference">Reference</h2>

<ul>
<li><a href="../override_and_overload_in_obj-c/">Obj-C ä¸­çš„é‡è½½ä¸é‡å†™ - kingcos</a></li>
<li><a href="../isa_in_objc/">Obj-C ä¸­çš„ isa æŒ‡é’ˆ - kingcos</a></li>
<li><a href="../objc_msgsend/">æµ…å° objc_msgSend - kingcos</a></li>
<li><a href="https://developer.apple.com/library/archive/documentation/Cocoa/Conceptual/ObjCRuntimeGuide/Articles/ocrtTypeEncodings.html">Type Encodings - Objective-C Runtime Programming Guide</a></li>
</ul>

    </div>
    
      <div class="pagination">
        <div class="pagination__title">
          <span class="pagination__title-h">Read other posts</span>
          <hr />
        </div>
        <div class="pagination__buttons">
          
            <span class="button previous">
              <a href="/posts/2019/objc_msgsend/">
                <span class="button__icon">â†</span>
                <span class="button__text">æµ…å° objc_msgSend</span>
              </a>
            </span>
          
          
            <span class="button next">
              <a href="/posts/2019/app_store/">
                <span class="button__text">App Store é¢é¢è§‚</span>
                <span class="button__icon">â†’</span>
              </a>
            </span>
          
        </div>
      </div>
    

    

    
    
    <div>
      <div id="github-comment">
      </div>

      <script type="text/javascript">
        function getUtterances(isDark) {
          var utterances = document.createElement('script');
          utterances.type = 'text/javascript';
          utterances.async = true;
          utterances.setAttribute('issue-term', "pathname")
          utterances.setAttribute('repo', "kingcos\/kingcos.github.io")
          utterances.setAttribute('label', "comments")
          isDark ? utterances.setAttribute('theme', "github-dark") : utterances.setAttribute('theme', "github-light")
          utterances.crossorigin = 'anonymous';
          utterances.src = 'https://utteranc.es/client.js';

          return utterances
        }

        var themeToggle = document.querySelector(".theme-toggle")
        themeToggle.addEventListener("click", function () {
          var getTheme = window.localStorage && window.localStorage.getItem("theme")
          var divNode = document.getElementById('github-comment')
          while(divNode.hasChildNodes()) {
            divNode.removeChild(divNode.firstChild);
          }
          
          
          

          
          
          
          
          
          
          document.getElementById('github-comment').appendChild(getUtterances(getTheme !== "dark"))
        })

        var getTheme = window.localStorage && window.localStorage.getItem("theme")
        document.getElementById('github-comment').appendChild(getUtterances(getTheme === "dark"))
      </script>
    </div>
    

    </div>

      </div>

      
        <footer class="footer">
  <div class="footer__inner">
    
      <div class="copyright copyright--user">Powered by github.com/kingcos</div>
    
  </div>
</footer>

<script src="/assets/main.js"></script>
<script src="/assets/prism.js"></script>


      
    </div>

    
      
<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
	(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
	m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
	})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
	ga('create', 'UA-138311951-1', 'auto');
	
	ga('send', 'pageview');
}
</script>

    
  </body>
</html>
