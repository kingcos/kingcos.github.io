<!DOCTYPE html>
<html lang="en">
  <head>
    
      <title>iOS ä¸­çš„ Category :: iBlog</title>
    
    <meta http-equiv="content-type" content="text/html; charset=utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">
<meta name="description" content="Date Notes Source Code Demo     2019-04-16 ä¼˜åŒ–ç»“æ„ - -   2019-04-13 é¦–æ¬¡æäº¤ objc4-750ã€xnu-4903.221.2 Category in iOS   2019-10-23 æ·»åŠ é¦–å›¾ï¼Œç»†èŠ‚å¾®è°ƒ - -    Preface iOS ä¸­çš„ Category ä¸­æ–‡å¸¸è¯‘ä½œåˆ†ç±»ã€ç±»åˆ«ï¼ˆä¸ºè¡¨è¿°ç»Ÿä¸€ï¼Œæœ¬æ–‡å°†ä½¿ç”¨ Category ç‰¹æŒ‡è¯¥æŠ€æœ¯ï¼‰ã€‚æˆ‘ä»¬ç»å¸¸ä¼šä½¿ç”¨ Category æ¥å¯¹ä¸€ä¸ªç±»è¿›è¡Œæ‰©å±•ï¼Œä½¿å¾—åœ¨ä¸ç ´åä¸»ç±»ç»“æ„çš„åŒæ—¶å¯ä»¥å…·å¤‡æ›´å¤šçš„åŠŸèƒ½ï¼›ä¹Ÿå¯ä»¥ä½¿ç”¨ Category å¯¹ä¸€ä¸ªç±»è¿›è¡Œæ‹†åˆ†ï¼Œä½¿å¾—å…¶ç»“æ„æ›´åŠ æ¸…æ™°æ¡ç†ã€‚æœ¬æ–‡å°†ä» What - How - Why è°ˆè°ˆ iOS ä¸­ Categoryã€‚
What ä»€ä¹ˆæ˜¯ Category å‘¢ï¼Ÿ
Category æ˜¯ Obj-C è¯­è¨€ä¸­æ‰€æä¾›çš„ä¸€é¡¹åŠŸèƒ½ï¼Œå®ƒå¯ä»¥ä¸º Obj-C ç±»æ·»åŠ é¢å¤–çš„å±æ€§ã€æ–¹æ³•ï¼Œä¹Ÿå¯ä»¥éµå®ˆå…¶ä»–åè®®ã€‚
Xcode ä¸­å·²ç»ä¸º Category å·²ç»æä¾›äº†æ¨¡ç‰ˆæ¥å»ºç«‹ï¼Œåªéœ€è¦æŒ‡å®š Category çš„åç§°ä»¥åŠè¢«æ·»åŠ  Category ç±»åå³å¯ã€‚å½“ç„¶ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥æ‰‹åŠ¨æ¥è‡ªå·±å»ºç«‹ï¼ŒCategory çš„è¯­æ³•ä¸ç±»çš„å£°æ˜ä¸å®ç°æ¯”è¾ƒç±»ä¼¼ï¼š"/>
<meta name="keywords" content="kingcos.me,maimieng.comios,swift,objective-c,obj-c,objc,oc,geek,python,ruby,golang,go,apple,mac"/>
<meta name="robots" content="noodp"/>
<link rel="canonical" href="/posts/2019/category_in_ios/" />





<link rel="stylesheet" href="/assets/style.css">


<link rel="stylesheet" href="/style.css">


<link rel="apple-touch-icon-precomposed" sizes="144x144" href="/img/apple-touch-icon-144-precomposed.png">
<link rel="shortcut icon" href="/img/favicon.png">


<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="iOS ä¸­çš„ Category"/>
<meta name="twitter:description" content="iOS ä¸­çš„ Category ä¸­æ–‡å¸¸è¯‘ä½œåˆ†ç±»ã€ç±»åˆ«ã€‚æˆ‘ä»¬ç»å¸¸ä¼šä½¿ç”¨ Category æ¥å¯¹ä¸€ä¸ªç±»è¿›è¡Œæ‰©å±•ï¼Œä½¿å¾—åœ¨ä¸ç ´åä¸»ç±»ç»“æ„çš„åŒæ—¶å¯ä»¥å…·å¤‡æ›´å¤šçš„åŠŸèƒ½ï¼›ä¹Ÿå¯ä»¥ä½¿ç”¨ Category å¯¹ä¸€ä¸ªç±»è¿›è¡Œæ‹†åˆ†ï¼Œä½¿å¾—å…¶ç»“æ„æ›´åŠ æ¸…æ™°æ¡ç†ã€‚æœ¬æ–‡å°†ä» What - How - Why è°ˆè°ˆ iOS ä¸­ Categoryã€‚"/>



<meta property="og:title" content="iOS ä¸­çš„ Category" />
<meta property="og:description" content="iOS ä¸­çš„ Category ä¸­æ–‡å¸¸è¯‘ä½œåˆ†ç±»ã€ç±»åˆ«ã€‚æˆ‘ä»¬ç»å¸¸ä¼šä½¿ç”¨ Category æ¥å¯¹ä¸€ä¸ªç±»è¿›è¡Œæ‰©å±•ï¼Œä½¿å¾—åœ¨ä¸ç ´åä¸»ç±»ç»“æ„çš„åŒæ—¶å¯ä»¥å…·å¤‡æ›´å¤šçš„åŠŸèƒ½ï¼›ä¹Ÿå¯ä»¥ä½¿ç”¨ Category å¯¹ä¸€ä¸ªç±»è¿›è¡Œæ‹†åˆ†ï¼Œä½¿å¾—å…¶ç»“æ„æ›´åŠ æ¸…æ™°æ¡ç†ã€‚æœ¬æ–‡å°†ä» What - How - Why è°ˆè°ˆ iOS ä¸­ Categoryã€‚" />
<meta property="og:type" content="article" />
<meta property="og:url" content="/posts/2019/category_in_ios/" />
<meta property="article:published_time" content="2019-10-23T00:00:00+00:00" />
<meta property="article:modified_time" content="2019-10-23T00:00:00+00:00" /><meta property="og:site_name" content="iBlog" />




<script data-ad-client="ca-pub-9925978992661955" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>

  </head>
  <body class="dark-theme">
    <div class="container">
      <header class="header">
  <span class="header__inner">
    <a href="/" class="logo" style="text-decoration: none;">
  
    <span class="logo__mark"><svg xmlns="http://www.w3.org/2000/svg" class="greater-icon" viewBox="0 0 44 44">
  <path fill="none" d="M15 8l14.729 14.382L15 35.367"/>
</svg>
</span>
    <span class="logo__text">kingcos.me</span>
    <span class="logo__cursor"></span>
  
</a>

    <span class="header__right">
      
        <nav class="menu">
  <ul class="menu__inner menu__inner--desktop">
    
      
        
          <li><a href="/about">About</a></li>
        
      
        
          <li><a href="/links">Links</a></li>
        
      
        
          <li><a href="/perspective">Perspective</a></li>
        
      
        
          <li><a href="/words">Words</a></li>
        
      
      
    
  </ul>

  <ul class="menu__inner menu__inner--mobile">
    
      
        <li><a href="/about">About</a></li>
      
    
      
        <li><a href="/links">Links</a></li>
      
    
      
        <li><a href="/perspective">Perspective</a></li>
      
    
      
        <li><a href="/words">Words</a></li>
      
    
  </ul>
</nav>

        <span class="menu-trigger">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
            <path d="M0 0h24v24H0z" fill="none"/>
            <path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"/>
          </svg>
        </span>
      
      <span class="theme-toggle">
        <svg class="theme-toggler" width="24" height="24" viewBox="0 0 48 48" fill="none" xmlns="http://www.w3.org/2000/svg">
  <path d="M22 41C32.4934 41 41 32.4934 41 22C41 11.5066 32.4934 3 22
  3C11.5066 3 3 11.5066 3 22C3 32.4934 11.5066 41 22 41ZM7 22C7
  13.7157 13.7157 7 22 7V37C13.7157 37 7 30.2843 7 22Z"/>
</svg>

      </span>
    </span>
  </span>
</header>


      <div class="content">
        
  <div class="post">
    <h2 class="post-title"><a href="/posts/2019/category_in_ios/">iOS ä¸­çš„ Category</a></h2>
    <div class="post-meta">
      
        <span class="post-date">
            2019-10-23
        </span>
      
      
      
        <span class="post-read-time">â€” 23 min read</span>
      
    </div>

    
      <span class="post-tags">
        
          #<a href="/tags/focus/">Focus</a>&nbsp;
        
          #<a href="/tags/ios/">iOS</a>&nbsp;
        
          #<a href="/tags/obj-c/">Obj-C</a>&nbsp;
        
          #<a href="/tags//">ğŸŒŸ</a>&nbsp;
        
      </span>
    

    

    <div class="post-content">
      <table>
<thead>
<tr>
<th align="center">Date</th>
<th align="center">Notes</th>
<th align="center">Source Code</th>
<th align="center">Demo</th>
</tr>
</thead>
<tbody>
<tr>
<td align="center">2019-04-16</td>
<td align="center">ä¼˜åŒ–ç»“æ„</td>
<td align="center">-</td>
<td align="center">-</td>
</tr>
<tr>
<td align="center">2019-04-13</td>
<td align="center">é¦–æ¬¡æäº¤</td>
<td align="center"><a href="https://opensource.apple.com/tarballs/objc4/">objc4-750</a>ã€<a href="https://opensource.apple.com/tarballs/xnu/">xnu-4903.221.2</a></td>
<td align="center"><a href="https://github.com/kingcos/Perspective/tree/writing/Posts/Focus/Category_in_Obj-C/">Category in iOS</a></td>
</tr>
<tr>
<td align="center">2019-10-23</td>
<td align="center">æ·»åŠ é¦–å›¾ï¼Œç»†èŠ‚å¾®è°ƒ</td>
<td align="center">-</td>
<td align="center">-</td>
</tr>
</tbody>
</table>
<p><img src="/img/2019/category_in_ios/0.png" alt="0"></p>
<h2 id="preface">Preface</h2>
<p>iOS ä¸­çš„ Category ä¸­æ–‡å¸¸è¯‘ä½œåˆ†ç±»ã€ç±»åˆ«ï¼ˆä¸ºè¡¨è¿°ç»Ÿä¸€ï¼Œæœ¬æ–‡å°†ä½¿ç”¨ Category ç‰¹æŒ‡è¯¥æŠ€æœ¯ï¼‰ã€‚æˆ‘ä»¬ç»å¸¸ä¼šä½¿ç”¨ Category æ¥å¯¹ä¸€ä¸ªç±»è¿›è¡Œæ‰©å±•ï¼Œä½¿å¾—åœ¨ä¸ç ´åä¸»ç±»ç»“æ„çš„åŒæ—¶å¯ä»¥å…·å¤‡æ›´å¤šçš„åŠŸèƒ½ï¼›ä¹Ÿå¯ä»¥ä½¿ç”¨ Category å¯¹ä¸€ä¸ªç±»è¿›è¡Œæ‹†åˆ†ï¼Œä½¿å¾—å…¶ç»“æ„æ›´åŠ æ¸…æ™°æ¡ç†ã€‚æœ¬æ–‡å°†ä» What - How - Why è°ˆè°ˆ iOS ä¸­ Categoryã€‚</p>
<h2 id="what">What</h2>
<p>ä»€ä¹ˆæ˜¯ Category å‘¢ï¼Ÿ</p>
<p>Category æ˜¯ Obj-C è¯­è¨€ä¸­æ‰€æä¾›çš„ä¸€é¡¹åŠŸèƒ½ï¼Œå®ƒå¯ä»¥ä¸º Obj-C ç±»æ·»åŠ é¢å¤–çš„å±æ€§ã€æ–¹æ³•ï¼Œä¹Ÿå¯ä»¥éµå®ˆå…¶ä»–åè®®ã€‚</p>
<p><img src="/img/2019/category_in_ios/1.png" alt="1"></p>
<p>Xcode ä¸­å·²ç»ä¸º Category å·²ç»æä¾›äº†æ¨¡ç‰ˆæ¥å»ºç«‹ï¼Œåªéœ€è¦æŒ‡å®š Category çš„åç§°ä»¥åŠè¢«æ·»åŠ  Category ç±»åå³å¯ã€‚å½“ç„¶ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥æ‰‹åŠ¨æ¥è‡ªå·±å»ºç«‹ï¼ŒCategory çš„è¯­æ³•ä¸ç±»çš„å£°æ˜ä¸å®ç°æ¯”è¾ƒç±»ä¼¼ï¼š</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-objectivec" data-lang="objectivec"><span style="color:#66d9ef">@interface</span> <span style="color:#a6e22e">Foo</span> (Bar) <span style="color:#f92672">&lt;</span>SomeProtocol<span style="color:#f92672">&gt;</span>
<span style="color:#f92672">-</span> (<span style="color:#66d9ef">void</span>)foo;
<span style="color:#66d9ef">@end</span>

<span style="color:#66d9ef">@implementation</span> <span style="color:#a6e22e">Foo</span> (Bar)
- (<span style="color:#66d9ef">void</span>)<span style="color:#a6e22e">foo</span> {}

- (<span style="color:#66d9ef">void</span>)<span style="color:#a6e22e">someMethodFromProtocol</span> {}
<span style="color:#66d9ef">@end</span>
</code></pre></div><h2 id="how">How</h2>
<p>Category é€šå¸¸éƒ½æœ‰å“ªäº›ç”¨å¤„å‘¢ï¼Ÿ</p>
<h3 id="heading">è§£è€¦</h3>
<p>å‡å¦‚æœ‰ä¸€ä¸ªäººï¼ˆPersonï¼‰ï¼Œä»–éœ€è¦å·¥ä½œï¼ˆWorkï¼‰å’Œç”Ÿæ´»ï¼ˆLifeï¼‰ï¼Œè€Œå·¥ä½œå’Œç”Ÿæ´»æ‰€åšçš„äº‹æƒ…æ˜¾ç„¶æ˜¯ä¸ä¸€æ ·çš„ï¼Œé‚£ä¹ˆæˆ‘ä»¬å°±å¯ä»¥ä½¿ç”¨ Category å°†äººçš„è¿™å®ƒä»¬è¿›è¡Œè§£è€¦ï¼š</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-objectivec" data-lang="objectivec"><span style="color:#66d9ef">@interface</span> <span style="color:#a6e22e">Person</span>
<span style="color:#66d9ef">@property</span> (<span style="color:#66d9ef">nonatomic</span>, <span style="color:#66d9ef">copy</span>) NSString <span style="color:#f92672">*</span>name;
<span style="color:#66d9ef">@end</span>

<span style="color:#66d9ef">@implementation</span> <span style="color:#a6e22e">Person</span>
<span style="color:#66d9ef">@end</span>

<span style="color:#75715e">// ---
</span><span style="color:#75715e"></span>
<span style="color:#66d9ef">@interface</span> <span style="color:#a6e22e">Person</span> (Life)
- (<span style="color:#66d9ef">void</span>)<span style="color:#a6e22e">playWithPet</span>;
<span style="color:#66d9ef">@end</span>

<span style="color:#66d9ef">@implementation</span> <span style="color:#a6e22e">Person</span> (Life)
- (<span style="color:#66d9ef">void</span>)<span style="color:#a6e22e">playWithPet</span> {}
<span style="color:#66d9ef">@end</span>

<span style="color:#75715e">// ---
</span><span style="color:#75715e"></span>
<span style="color:#66d9ef">@interface</span> <span style="color:#a6e22e">Person</span> (Work)
- (<span style="color:#66d9ef">void</span>)<span style="color:#a6e22e">codeForWork</span>;
<span style="color:#66d9ef">@end</span>

<span style="color:#66d9ef">@implementation</span> <span style="color:#a6e22e">Person</span> (Work)
- (<span style="color:#66d9ef">void</span>)<span style="color:#a6e22e">codeForWork</span> {}
<span style="color:#66d9ef">@end</span>
</code></pre></div><p>è¿™æ ·ï¼ŒPerson+Life ä¸­å¯ä»¥å®šä¹‰ä¸ç”Ÿæ´»ç›¸å…³çš„æ–¹æ³•ï¼Œè€Œ Person+Work ä¸­å°†ä¸“æ³¨äºå·¥ä½œã€‚å½“äººéœ€è¦è¿åŠ¨ï¼ˆSportsï¼‰æ—¶ï¼Œåªéœ€è¦å†ä¸º Person æ·»åŠ  Person+Sports çš„ Category å³å¯ï¼Œè¿™å¹¶ä¸éœ€è¦æ”¹åŠ¨ä¸»ç±»æœ¬èº«ä»è€Œå®ç°äº†è§£è€¦ã€‚</p>
<h3 id="heading1">ç§æœ‰åŒ–</h3>
<p>ä½¿ç”¨ Xcode æ¨¡ç‰ˆæ–°å»º Category åï¼Œå°†ä¼šè‡ªåŠ¨åˆ›å»ºä¸¤ä¸ªæ–‡ä»¶ï¼šClassName+CategoryName.h &amp; ClassName+CategoryName.mã€‚å½“æˆ‘ä»¬ä¸å¸Œæœ›æŸä¸ª Category å¯ä»¥åœ¨å¤–ç•Œè®¿é—®æ—¶ï¼Œåªéœ€è¦ä¸æŠŠå®ƒä½œä¸ºå…¬å…±å¤´æ–‡ä»¶ï¼ˆPublic Headerï¼‰æš´éœ²å‡ºå»å³å¯ï¼Œå³å®ç°äº†ç§æœ‰åŒ–ã€‚éœ€è¦æ³¨æ„çš„æ˜¯ï¼ŒåŒæ ·å¯ä»¥å®ç°ç§æœ‰åŒ–çš„æ–¹æ¡ˆæ˜¯ä½¿ç”¨ç±»æ‰©å±•ï¼ˆClass Extensionï¼‰ï¼Œå…¶å› è¯­æ³•ç›¸ä¼¼ä½†æ²¡æœ‰å®šä¹‰åç§°è¢«å¾ˆå¤šäººç§°ä¸ºã€ŒåŒ¿ååˆ†ç±»ï¼ˆCategoryï¼‰ã€ã€‚ä¸è¿‡æœ¬è´¨ä¸Šè¯´ï¼ŒCategory å’Œç±»æ‰©å±•æ˜¯å®Œå…¨ä¸åŒçš„ï¼š</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-objectivec" data-lang="objectivec"><span style="color:#75715e">// Class Extension
</span><span style="color:#75715e"></span><span style="color:#66d9ef">@interface</span> <span style="color:#a6e22e">Person</span> ()
<span style="color:#f92672">-</span> (<span style="color:#66d9ef">void</span>)secret;
<span style="color:#66d9ef">@end</span>
</code></pre></div><p>ç±»æ‰©å±•æ˜¯å¯ä»¥å®šä¹‰åœ¨å•ç‹¬çš„ .h æˆ–è€… .m ä¸­ï¼Œå…¶ä¸»è¦å¯ä»¥ä½¿å¾—å¤–ç•Œæ— æ³•ç›´æ¥è®¿é—®åˆ°å®šä¹‰çš„æˆå‘˜å˜é‡ã€å±æ€§æˆ–æ–¹æ³•ã€‚å…³äºç±»æ‰©å±•ä¸è®¿é—®æ§åˆ¶ï¼Œå¯è¯¦è§ã€Š<a href="/posts/2019/ivar_access_control_in_obj-c/">Obj-C ä¸­æˆå‘˜å˜é‡å’Œç±»çš„è®¿é—®æ§åˆ¶</a>ã€‹ä¸€æ–‡ã€‚</p>
<h3 id="heading2">ã€Œåç§æœ‰åŒ–ã€</h3>
<p>Category ä¸ä»…å¯ä»¥ç§æœ‰åŒ–ï¼Œå…¶å®ä¹Ÿå¯ä»¥ã€Œåç§æœ‰åŒ–ã€ã€‚å¦‚æœæˆ‘ä»¬å¸Œæœ›è°ƒç”¨ä¸€ä¸ªæ²¡æœ‰å£°æ˜çš„æ–¹æ³•ï¼Œæ­¤æ—¶å°±å¯ä»¥åœ¨å…¶ Category æˆ–è€…ç±»æ‰©å±•ä¸­å£°æ˜è¯¥æ–¹æ³•ï¼Œå†è¿›è¡Œè°ƒç”¨ã€‚å½“ç„¶ï¼ŒObj-C ä¸­æ–¹æ³•è°ƒç”¨æœ¬è´¨æ˜¯æ¶ˆæ¯å‘é€ï¼Œåªè¦æˆ‘ä»¬çŸ¥é“äº†æ¶ˆæ¯çš„å‘é€è€…å’Œæ¥æ”¶è€…ï¼Œå³ä½¿æ²¡æœ‰å£°æ˜ä¹Ÿæ€»æœ‰æ–¹æ³•æ¥å‘é€æ¶ˆæ¯ã€‚</p>
<h3 id="heading3">ã€Œå¤šç»§æ‰¿ã€</h3>
<p>å› ä¸º Category æ˜¯æ”¯æŒéµå®ˆåè®®ï¼ˆProtocolï¼‰çš„ï¼Œé‚£ä¹ˆä¸åŒçš„ Category å°±å¯ä»¥éµå®ˆä¸åŒçš„åè®®ï¼Œå®ç°ç±»ä¼¼ã€Œå¤šç»§æ‰¿ã€çš„ç‰¹æ€§ã€‚ä½†ä¸ºä»€ä¹ˆæ˜¯åŠ å¼•å·çš„ã€Œå¤šç»§æ‰¿ã€å‘¢ï¼Ÿå› ä¸ºè¿™æ ·çš„åè®®éµå®ˆåªèƒ½è·å¾—æ–¹æ³•çš„å£°æ˜ï¼Œå´æ— æ³•è·å¾—çˆ¶ç±»çš„å…·ä½“å®ç°ã€‚</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-objectivec" data-lang="objectivec"><span style="color:#66d9ef">@protocol</span> <span style="color:#a6e22e">LifeProtocol</span> <span style="color:#f92672">&lt;</span>NSObject<span style="color:#f92672">&gt;</span>
<span style="color:#f92672">-</span> (<span style="color:#66d9ef">void</span>)playWithPet;
<span style="color:#66d9ef">@end</span>

<span style="color:#66d9ef">@interface</span> <span style="color:#a6e22e">Person</span> (Life) <span style="color:#f92672">&lt;</span>LifeProtocol<span style="color:#f92672">&gt;</span>
<span style="color:#66d9ef">@end</span>

<span style="color:#66d9ef">@implementation</span> <span style="color:#a6e22e">Person</span> (Life)
- (<span style="color:#66d9ef">void</span>)<span style="color:#a6e22e">playWithPet</span> {}
<span style="color:#66d9ef">@end</span>

<span style="color:#75715e">// ---
</span><span style="color:#75715e"></span>
<span style="color:#66d9ef">@protocol</span> <span style="color:#a6e22e">WorkProtocol</span> <span style="color:#f92672">&lt;</span>NSObject<span style="color:#f92672">&gt;</span>
<span style="color:#f92672">-</span> (<span style="color:#66d9ef">void</span>) workHard;
<span style="color:#66d9ef">@end</span>

<span style="color:#66d9ef">@interface</span> <span style="color:#a6e22e">Person</span> (Work) <span style="color:#f92672">&lt;</span>WorkProtocol<span style="color:#f92672">&gt;</span>
<span style="color:#66d9ef">@end</span>

<span style="color:#66d9ef">@implementation</span> <span style="color:#a6e22e">Person</span> (Work)
- (<span style="color:#66d9ef">void</span>)<span style="color:#a6e22e">workHard</span> {}
<span style="color:#66d9ef">@end</span>
</code></pre></div><h2 id="why">Why</h2>
<p>Obj-C ä¸­çš„ Category åº•å±‚æ˜¯å¦‚ä½•å®ç°çš„å‘¢ï¼Ÿ</p>
<h3 id="heading4">ç»“æ„</h3>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-objectivec" data-lang="objectivec"><span style="color:#75715e">// Person+Life.h
</span><span style="color:#75715e"></span><span style="color:#75715e">/**
</span><span style="color:#75715e"> LifeProtocol
</span><span style="color:#75715e"> */</span>
<span style="color:#66d9ef">@protocol</span> <span style="color:#a6e22e">LifeProtocol</span> <span style="color:#f92672">&lt;</span>NSObject<span style="color:#f92672">&gt;</span>
<span style="color:#f92672">-</span> (<span style="color:#66d9ef">void</span>)eat;
<span style="color:#66d9ef">@end</span>

<span style="color:#75715e">/**
</span><span style="color:#75715e"> Person+Life
</span><span style="color:#75715e"> */</span>
<span style="color:#66d9ef">@interface</span> <span style="color:#a6e22e">Person</span> (Life) <span style="color:#f92672">&lt;</span>LifeProtocol<span style="color:#f92672">&gt;</span>

<span style="color:#66d9ef">@property</span> (<span style="color:#66d9ef">nonatomic</span>, <span style="color:#66d9ef">copy</span>) NSString <span style="color:#f92672">*</span>name;

<span style="color:#75715e">// Instance method
</span><span style="color:#75715e"></span>- (<span style="color:#66d9ef">void</span>)<span style="color:#a6e22e">run</span>;

<span style="color:#75715e">// Class method
</span><span style="color:#75715e"></span>+ (<span style="color:#66d9ef">void</span>)<span style="color:#a6e22e">foo</span>;

<span style="color:#75715e">// Protocol method
</span><span style="color:#75715e"></span>- (<span style="color:#66d9ef">void</span>)<span style="color:#a6e22e">eat</span>;

<span style="color:#66d9ef">@end</span>
</code></pre></div><p>å®šä¹‰ä¸€ä¸ªå®Œæ•´çš„ Person ç±»ï¼Œå®ƒéµå®ˆäº†åè®®ï¼Œå­˜å‚¨äº†å±æ€§ï¼Œå¹¶å®šä¹‰å®ç°äº†å¯¹è±¡æ–¹æ³•å’Œç±»æ–¹æ³•ã€‚ä¸ºäº†ä¾¿äºä¸‹é¢çš„åˆ†æï¼Œæˆ‘ä»¬ä½¿ç”¨ <code>xcrun -sdk iphoneos clang -arch arm64 -rewrite-objc Person+Life.m</code> å‘½ä»¤å°† Person+Life.m ç¿»è¯‘ä¸º C/C++ ä»£ç ï¼ˆPerson+Life.cppï¼‰ï¼Œå…³äºç¿»è¯‘ Obj-C ä»£ç çš„ç»†èŠ‚ï¼Œå¯è¯¦è§ã€Š<a href="../obj-c_to_c++/">å°† Obj-C ä»£ç ç¿»è¯‘ä¸º C++ ä»£ç </a>ã€‹ä¸€æ–‡ã€‚</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp"><span style="color:#75715e">// Person+Life.cpp
</span><span style="color:#75715e"></span><span style="color:#66d9ef">struct</span> <span style="color:#a6e22e">_category_t</span> {
	<span style="color:#66d9ef">const</span> <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>name;                               <span style="color:#75715e">// ç±»å
</span><span style="color:#75715e"></span>	<span style="color:#66d9ef">struct</span> <span style="color:#a6e22e">_class_t</span> <span style="color:#f92672">*</span>cls;                           <span style="color:#75715e">// ç±»æŒ‡é’ˆ
</span><span style="color:#75715e"></span>	<span style="color:#66d9ef">const</span> <span style="color:#66d9ef">struct</span> <span style="color:#a6e22e">_method_list_t</span> <span style="color:#f92672">*</span>instance_methods;  <span style="color:#75715e">// å¯¹è±¡æ–¹æ³•åˆ—è¡¨æŒ‡é’ˆ
</span><span style="color:#75715e"></span>	<span style="color:#66d9ef">const</span> <span style="color:#66d9ef">struct</span> <span style="color:#a6e22e">_method_list_t</span> <span style="color:#f92672">*</span>class_methods;     <span style="color:#75715e">// ç±»æ–¹æ³•åˆ—è¡¨æŒ‡é’ˆ
</span><span style="color:#75715e"></span>	<span style="color:#66d9ef">const</span> <span style="color:#66d9ef">struct</span> <span style="color:#a6e22e">_protocol_list_t</span> <span style="color:#f92672">*</span>protocols;       <span style="color:#75715e">// åè®®åˆ—è¡¨æŒ‡é’ˆ
</span><span style="color:#75715e"></span>	<span style="color:#66d9ef">const</span> <span style="color:#66d9ef">struct</span> <span style="color:#a6e22e">_prop_list_t</span> <span style="color:#f92672">*</span>properties;          <span style="color:#75715e">// å±æ€§åˆ—è¡¨æŒ‡é’ˆ
</span><span style="color:#75715e"></span>};

<span style="color:#66d9ef">static</span> <span style="color:#66d9ef">struct</span> <span style="color:#a6e22e">_category_t</span> _OBJC_<span style="color:#960050;background-color:#1e0010">$</span>_CATEGORY_Person_<span style="color:#960050;background-color:#1e0010">$</span>_Life __attribute__ ((used, section (<span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">__DATA,__objc_const</span><span style="color:#e6db74">&#34;</span>))) <span style="color:#f92672">=</span>
{
	<span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Person</span><span style="color:#e6db74">&#34;</span>,
	<span style="color:#ae81ff">0</span>, <span style="color:#75715e">// &amp;OBJC_CLASS_$_Person,
</span><span style="color:#75715e"></span>	(<span style="color:#66d9ef">const</span> <span style="color:#66d9ef">struct</span> <span style="color:#a6e22e">_method_list_t</span> <span style="color:#f92672">*</span>)<span style="color:#f92672">&amp;</span>_OBJC_<span style="color:#960050;background-color:#1e0010">$</span>_CATEGORY_INSTANCE_METHODS_Person_<span style="color:#960050;background-color:#1e0010">$</span>_Life,
	(<span style="color:#66d9ef">const</span> <span style="color:#66d9ef">struct</span> <span style="color:#a6e22e">_method_list_t</span> <span style="color:#f92672">*</span>)<span style="color:#f92672">&amp;</span>_OBJC_<span style="color:#960050;background-color:#1e0010">$</span>_CATEGORY_CLASS_METHODS_Person_<span style="color:#960050;background-color:#1e0010">$</span>_Life,
	(<span style="color:#66d9ef">const</span> <span style="color:#66d9ef">struct</span> <span style="color:#a6e22e">_protocol_list_t</span> <span style="color:#f92672">*</span>)<span style="color:#f92672">&amp;</span>_OBJC_CATEGORY_PROTOCOLS_<span style="color:#960050;background-color:#1e0010">$</span>_Person_<span style="color:#960050;background-color:#1e0010">$</span>_Life,
	(<span style="color:#66d9ef">const</span> <span style="color:#66d9ef">struct</span> <span style="color:#a6e22e">_prop_list_t</span> <span style="color:#f92672">*</span>)<span style="color:#f92672">&amp;</span>_OBJC_<span style="color:#960050;background-color:#1e0010">$</span>_PROP_LIST_Person_<span style="color:#960050;background-color:#1e0010">$</span>_Life,
};

<span style="color:#75715e">// å¯¹è±¡æ–¹æ³•åˆ—è¡¨
</span><span style="color:#75715e"></span><span style="color:#66d9ef">static</span> <span style="color:#66d9ef">struct</span> <span style="color:#960050;background-color:#1e0010">/</span><span style="color:#960050;background-color:#1e0010">*</span><span style="color:#a6e22e">_method_list_t</span><span style="color:#960050;background-color:#1e0010">*/</span> {
	<span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">int</span> entsize;  <span style="color:#75715e">// sizeof(struct _objc_method)
</span><span style="color:#75715e"></span>	<span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">int</span> method_count;
	<span style="color:#66d9ef">struct</span> <span style="color:#a6e22e">_objc_method</span> method_list[<span style="color:#ae81ff">2</span>];
} _OBJC_<span style="color:#960050;background-color:#1e0010">$</span>_CATEGORY_INSTANCE_METHODS_Person_<span style="color:#960050;background-color:#1e0010">$</span>_Life __attribute__ ((used, section (<span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">__DATA,__objc_const</span><span style="color:#e6db74">&#34;</span>))) <span style="color:#f92672">=</span> {
	<span style="color:#66d9ef">sizeof</span>(_objc_method),
	<span style="color:#ae81ff">2</span>,
	{{(<span style="color:#66d9ef">struct</span> <span style="color:#a6e22e">objc_selector</span> <span style="color:#f92672">*</span>)<span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">run</span><span style="color:#e6db74">&#34;</span>, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">v16@0:8</span><span style="color:#e6db74">&#34;</span>, (<span style="color:#66d9ef">void</span> <span style="color:#f92672">*</span>)_I_Person_Life_run},
	{(<span style="color:#66d9ef">struct</span> <span style="color:#a6e22e">objc_selector</span> <span style="color:#f92672">*</span>)<span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">eat</span><span style="color:#e6db74">&#34;</span>, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">v16@0:8</span><span style="color:#e6db74">&#34;</span>, (<span style="color:#66d9ef">void</span> <span style="color:#f92672">*</span>)_I_Person_Life_eat}}
};

<span style="color:#75715e">// ç±»æ–¹æ³•åˆ—è¡¨
</span><span style="color:#75715e"></span><span style="color:#66d9ef">static</span> <span style="color:#66d9ef">struct</span> <span style="color:#960050;background-color:#1e0010">/</span><span style="color:#960050;background-color:#1e0010">*</span><span style="color:#a6e22e">_method_list_t</span><span style="color:#960050;background-color:#1e0010">*/</span> {
	<span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">int</span> entsize;  <span style="color:#75715e">// sizeof(struct _objc_method)
</span><span style="color:#75715e"></span>	<span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">int</span> method_count;
	<span style="color:#66d9ef">struct</span> <span style="color:#a6e22e">_objc_method</span> method_list[<span style="color:#ae81ff">1</span>];
} _OBJC_<span style="color:#960050;background-color:#1e0010">$</span>_CATEGORY_CLASS_METHODS_Person_<span style="color:#960050;background-color:#1e0010">$</span>_Life __attribute__ ((used, section (<span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">__DATA,__objc_const</span><span style="color:#e6db74">&#34;</span>))) <span style="color:#f92672">=</span> {
	<span style="color:#66d9ef">sizeof</span>(_objc_method),
	<span style="color:#ae81ff">1</span>,
	{{(<span style="color:#66d9ef">struct</span> <span style="color:#a6e22e">objc_selector</span> <span style="color:#f92672">*</span>)<span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">foo</span><span style="color:#e6db74">&#34;</span>, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">v16@0:8</span><span style="color:#e6db74">&#34;</span>, (<span style="color:#66d9ef">void</span> <span style="color:#f92672">*</span>)_C_Person_Life_foo}}
};

<span style="color:#75715e">// åè®®åˆ—è¡¨
</span><span style="color:#75715e"></span><span style="color:#66d9ef">static</span> <span style="color:#66d9ef">struct</span> <span style="color:#960050;background-color:#1e0010">/</span><span style="color:#960050;background-color:#1e0010">*</span><span style="color:#a6e22e">_protocol_list_t</span><span style="color:#960050;background-color:#1e0010">*/</span> {
	<span style="color:#66d9ef">long</span> protocol_count;  <span style="color:#75715e">// Note, this is 32/64 bit
</span><span style="color:#75715e"></span>	<span style="color:#66d9ef">struct</span> <span style="color:#a6e22e">_protocol_t</span> <span style="color:#f92672">*</span>super_protocols[<span style="color:#ae81ff">1</span>];
} _OBJC_CATEGORY_PROTOCOLS_<span style="color:#960050;background-color:#1e0010">$</span>_Person_<span style="color:#960050;background-color:#1e0010">$</span>_Life __attribute__ ((used, section (<span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">__DATA,__objc_const</span><span style="color:#e6db74">&#34;</span>))) <span style="color:#f92672">=</span> {
	<span style="color:#ae81ff">1</span>,
	<span style="color:#f92672">&amp;</span>_OBJC_PROTOCOL_LifeProtocol
};

<span style="color:#75715e">// å±æ€§åˆ—è¡¨
</span><span style="color:#75715e"></span><span style="color:#66d9ef">static</span> <span style="color:#66d9ef">struct</span> <span style="color:#960050;background-color:#1e0010">/</span><span style="color:#960050;background-color:#1e0010">*</span><span style="color:#a6e22e">_prop_list_t</span><span style="color:#960050;background-color:#1e0010">*/</span> {
	<span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">int</span> entsize;  <span style="color:#75715e">// sizeof(struct _prop_t)
</span><span style="color:#75715e"></span>	<span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">int</span> count_of_properties;
	<span style="color:#66d9ef">struct</span> <span style="color:#a6e22e">_prop_t</span> prop_list[<span style="color:#ae81ff">1</span>];
} _OBJC_<span style="color:#960050;background-color:#1e0010">$</span>_PROP_LIST_Person_<span style="color:#960050;background-color:#1e0010">$</span>_Life __attribute__ ((used, section (<span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">__DATA,__objc_const</span><span style="color:#e6db74">&#34;</span>))) <span style="color:#f92672">=</span> {
	<span style="color:#66d9ef">sizeof</span>(_prop_t),
	<span style="color:#ae81ff">1</span>,
	{{<span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">name</span><span style="color:#e6db74">&#34;</span>,<span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">T@</span><span style="color:#ae81ff">\&#34;</span><span style="color:#e6db74">NSString</span><span style="color:#ae81ff">\&#34;</span><span style="color:#e6db74">,C,N</span><span style="color:#e6db74">&#34;</span>}}
};
</code></pre></div><p>åœ¨ç¿»è¯‘åçš„ C++ æºä»£ç ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥å‘ç°ä¸€ä¸ªåç§°å’Œ Category ç›¸å…³çš„ç»“æ„ä½“å®šä¹‰ï¼š<code>_category_t</code>ï¼Œè¯¥ç»“æ„ä½“è¡¨ç¤ºäº† Obj-C ä¸­ Category çš„å®é™…ç»“æ„ï¼›<code>_OBJC_$_CATEGORY_Person_$_Life</code> åˆ™å°±æ˜¯æˆ‘ä»¬å®šä¹‰çš„ Person+Life Categoryã€‚<code>_category_t</code> ç»“æ„ä½“ä¸­å­˜å‚¨äº†ç±»åã€ç±»æŒ‡é’ˆã€å¯¹è±¡æ–¹æ³•åˆ—è¡¨æŒ‡é’ˆã€ç±»æ–¹æ³•åˆ—è¡¨æŒ‡é’ˆã€åè®®åˆ—è¡¨æŒ‡é’ˆã€ä»¥åŠå±æ€§åˆ—è¡¨æŒ‡é’ˆï¼Œæ‰€ä»¥ Category ä¸­æ”¯æŒéµå®ˆåè®®ã€å£°æ˜å±æ€§ã€ä»¥åŠå®šä¹‰å®ç°å¯¹è±¡æ–¹æ³•å’Œç±»æ–¹æ³•ï¼ˆä¸æ”¯æŒå®šä¹‰æˆå‘˜å˜é‡ï¼‰ã€‚å½“ç„¶ï¼Œåœ¨ Apple å¼€æºçš„ objc4 ä¸­ï¼Œä¹Ÿå¯ä»¥æ‰¾åˆ° <code>category_t</code> ç»“æ„ä½“ï¼š</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp"><span style="color:#75715e">// objc-runtime-new.h
</span><span style="color:#75715e"></span><span style="color:#66d9ef">struct</span> <span style="color:#a6e22e">category_t</span> {
    <span style="color:#66d9ef">const</span> <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>name;
    classref_t cls;
    <span style="color:#66d9ef">struct</span> <span style="color:#a6e22e">method_list_t</span> <span style="color:#f92672">*</span>instanceMethods;
    <span style="color:#66d9ef">struct</span> <span style="color:#a6e22e">method_list_t</span> <span style="color:#f92672">*</span>classMethods;
    <span style="color:#66d9ef">struct</span> <span style="color:#a6e22e">protocol_list_t</span> <span style="color:#f92672">*</span>protocols;
    <span style="color:#66d9ef">struct</span> <span style="color:#a6e22e">property_list_t</span> <span style="color:#f92672">*</span>instanceProperties;
    <span style="color:#75715e">// Fields below this point are not always present on disk.
</span><span style="color:#75715e"></span>    <span style="color:#75715e">// ä»¥ä¸‹å†…å®¹å¹¶ä¸èƒ½ä¿è¯ä¼šåœ¨ç£ç›˜ä¸­å±•ç¤º
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">struct</span> <span style="color:#a6e22e">property_list_t</span> <span style="color:#f92672">*</span>_classProperties;

    method_list_t <span style="color:#f92672">*</span><span style="color:#a6e22e">methodsForMeta</span>(<span style="color:#66d9ef">bool</span> isMeta) {
        <span style="color:#66d9ef">if</span> (isMeta) <span style="color:#66d9ef">return</span> classMethods;
        <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">return</span> instanceMethods;
    }

    property_list_t <span style="color:#f92672">*</span><span style="color:#a6e22e">propertiesForMeta</span>(<span style="color:#66d9ef">bool</span> isMeta, <span style="color:#66d9ef">struct</span> <span style="color:#a6e22e">header_info</span> <span style="color:#f92672">*</span>hi);
};
</code></pre></div><h3 id="heading5">å®ç°åŸç†</h3>
<p>å½“æˆ‘ä»¬çš„ä»£ç ç¼–è¯‘å®Œï¼ŒCategory ä¸­çš„ä¿¡æ¯å°±å°†è¢«å­˜å‚¨åœ¨ <code>category_t</code> çš„ç»“æ„ä½“ä¸­ï¼Œé‚£ä¹ˆè¿è¡Œæ—¶çš„ Category åˆä¼šå˜æˆä»€ä¹ˆæ ·å‘¢ï¼Ÿ</p>
<h4 id="what1">What</h4>
<p>æˆ‘ä»¬å°è¯•åˆ†åˆ«åœ¨ <code>Person</code> ä¸»ç±»ã€Person+Life å’Œ Person+Work Category ä¸­å®šä¹‰å¹¶å®ç°å®Œå…¨ç›¸åŒçš„ <code>smile</code> æ–¹æ³•ã€‚æœ‰ä¸ªç»†èŠ‚æ˜¯ï¼Œæˆ‘ä»¬åœ¨ Category ä¸­å®ç°ä¸»ç±»ä¸­å·²ç»å®ç°çš„æ–¹æ³•æ—¶ï¼Œç¼–è¯‘å™¨ä¼šè­¦å‘Šã€ŒCategory is implementing a method which will also be implemented by its primary classã€ï¼Œè¿™åˆæ˜¯ä¸ºä»€ä¹ˆå‘¢ï¼Ÿ</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-objectivec" data-lang="objectivec"><span style="color:#75715e">// Person.h
</span><span style="color:#75715e"></span><span style="color:#66d9ef">@interface</span> <span style="color:#a6e22e">Person</span> : <span style="color:#a6e22e">NSObject</span>
- (<span style="color:#66d9ef">void</span>)<span style="color:#a6e22e">smile</span>;
<span style="color:#66d9ef">@end</span>

<span style="color:#75715e">// Person+Life.h
</span><span style="color:#75715e"></span><span style="color:#66d9ef">@interface</span> <span style="color:#a6e22e">Person</span> (Life) <span style="color:#f92672">&lt;</span>LifeProtocol<span style="color:#f92672">&gt;</span>
<span style="color:#75715e">// ...
</span><span style="color:#75715e"></span>
<span style="color:#f92672">-</span> (<span style="color:#66d9ef">void</span>)smile;
<span style="color:#66d9ef">@end</span>

<span style="color:#75715e">// Person+Work.h
</span><span style="color:#75715e"></span><span style="color:#66d9ef">@interface</span> <span style="color:#a6e22e">Person</span> (Work)
- (<span style="color:#66d9ef">void</span>)<span style="color:#a6e22e">smile</span>;
<span style="color:#66d9ef">@end</span>

<span style="color:#75715e">// main.m
</span><span style="color:#75715e"></span>Person <span style="color:#f92672">*</span>p <span style="color:#f92672">=</span> [[Person alloc] init];
[p smile];

<span style="color:#75715e">// OUTPUT:
</span><span style="color:#75715e"></span><span style="color:#75715e">// Person (Work) - -[Person(Work) smile]
</span></code></pre></div><p>å½“æˆ‘ä»¬è¿è¡Œç¨‹åºï¼Œå‘ç°æœ€ç»ˆåªè¾“å‡ºäº†ä¸€å¥ï¼Œå¹¶ä¸”æ˜¯è°ƒç”¨åˆ°äº† Person+Work Category ä¸­çš„æ–¹æ³•ã€‚é‚£ä¹ˆå…ˆè¯´ç»“è®ºï¼š<strong>å½“ Category ä¸­å®ç°äº†ä¸»ç±»ä¸­åŒä¸€ä¸ªæ–¹æ³•æ—¶ï¼Œå°†æ€»æ˜¯è°ƒç”¨ Category ä¸­çš„æ–¹æ³•ï¼ˆè¿™ä¹Ÿæ˜¯ä¸ºä½•ç¼–è¯‘å™¨è­¦å‘Šçš„åŸå› ï¼‰ï¼›å½“å­˜åœ¨å¤šä¸ª Category å®ç°åŒä¸€ä¸ªæ–¹æ³•æ—¶ï¼Œå°†æ€»æ˜¯è°ƒç”¨æœ€åè¢«ç¼–è¯‘çš„ Category ä¸­çš„æ–¹æ³•</strong>ã€‚å¦‚ä½•æŸ¥çœ‹æ–‡ä»¶çš„ç¼–è¯‘é¡ºåºå‘¢ï¼Ÿåœ¨ Xcode -ã€ŒBuild Phasesã€-ã€ŒCompile Sourcesã€ä¸­ï¼Œé å‰çš„å³æ˜¯æœ€å…ˆè¢«ç¼–è¯‘çš„ï¼š</p>
<p><img src="/img/2019/category_in_ios/2.png" alt="2"></p>
<h4 id="why1">Why</h4>
<p>ä¸ºäº†è¯æ˜ä¸Šè¿°ç»“è®ºï¼Œæˆ‘ä»¬éœ€è¦åœ¨ objc4 çš„æºç ä¸­ï¼Œä» Obj-C è¿è¡Œæ—¶åˆå§‹åŒ–çš„å…¥å£ç€æ‰‹ï¼Œå³ <code>_objc_init</code>ï¼š</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-objectivec" data-lang="objectivec"><span style="color:#75715e">// objc-os.mm
</span><span style="color:#75715e"></span><span style="color:#75715e">/***********************************************************************
</span><span style="color:#75715e">* _objc_init
</span><span style="color:#75715e">* Bootstrap initialization. Registers our image notifier with dyld.
</span><span style="color:#75715e">* å¼•å¯¼åˆå§‹åŒ–ã€‚ä½¿ç”¨ dyld æ³¨å†Œé•œåƒé€šçŸ¥å™¨ã€‚
</span><span style="color:#75715e">* Called by libSystem BEFORE library initialization time
</span><span style="color:#75715e">* åœ¨åº“åˆå§‹åŒ–æ—¶é—´ä¹‹å‰ç”± libSystem è°ƒç”¨
</span><span style="color:#75715e">**********************************************************************/</span>

<span style="color:#66d9ef">void</span> <span style="color:#a6e22e">_objc_init</span>(<span style="color:#66d9ef">void</span>)
{
    <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">bool</span> initialized <span style="color:#f92672">=</span> false;
    <span style="color:#66d9ef">if</span> (initialized) <span style="color:#66d9ef">return</span>;
    initialized <span style="color:#f92672">=</span> true;

    <span style="color:#75715e">// fixme defer initialization until an objc-using image is found?
</span><span style="color:#75715e"></span>    environ_init();
    tls_init();
    static_init();
    lock_init();
    exception_init();

    <span style="color:#75715e">// â¡ï¸ dyld æ³¨å†Œé€šçŸ¥ï¼›map_imagesï¼šæ˜ å°„é•œåƒï¼Œload_imagesï¼šåŠ è½½é•œåƒï¼Œunmap_imageï¼šåæ˜ å°„é•œåƒ
</span><span style="color:#75715e"></span>    _dyld_objc_notify_register(<span style="color:#f92672">&amp;</span>map_images, load_images, unmap_image);
}

<span style="color:#75715e">// objc-runtime-new.mm
</span><span style="color:#75715e"></span><span style="color:#75715e">/***********************************************************************
</span><span style="color:#75715e">* map_images
</span><span style="color:#75715e">* Process the given images which are being mapped in by dyld.
</span><span style="color:#75715e">* ç”± dyld å¤„ç†ç»™å®šå°†è¦æ˜ å°„çš„é•œåƒã€‚
</span><span style="color:#75715e">* Calls ABI-agnostic code after taking ABI-specific locks.
</span><span style="color:#75715e">* åŠ ä¸ŠæŒ‡å®š ABI é”åè°ƒç”¨ ABI æ— å…³ï¼ˆagnosticï¼‰çš„ä»£ç ã€‚
</span><span style="color:#75715e">*
</span><span style="color:#75715e">* Locking: write-locks runtimeLock
</span><span style="color:#75715e">* é”ï¼šå†™é” runtimeLock
</span><span style="color:#75715e">**********************************************************************/</span>
<span style="color:#66d9ef">void</span>
<span style="color:#a6e22e">map_images</span>(<span style="color:#66d9ef">unsigned</span> count, <span style="color:#66d9ef">const</span> <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span> <span style="color:#66d9ef">const</span> paths[],
           <span style="color:#66d9ef">const</span> <span style="color:#66d9ef">struct</span> mach_header <span style="color:#f92672">*</span> <span style="color:#66d9ef">const</span> mhdrs[])
{
    <span style="color:#75715e">// äº’æ–¥é”
</span><span style="color:#75715e"></span>    mutex_locker_t lock(runtimeLock);
    <span style="color:#75715e">// â¡ï¸ map_images_nolockï¼šæ˜ å°„é•œåƒï¼ˆæ— é”ï¼‰
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">return</span> map_images_nolock(count, paths, mhdrs);
}

<span style="color:#75715e">// objc-os.mm
</span><span style="color:#75715e"></span><span style="color:#66d9ef">void</span>
<span style="color:#a6e22e">map_images_nolock</span>(<span style="color:#66d9ef">unsigned</span> mhCount, <span style="color:#66d9ef">const</span> <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span> <span style="color:#66d9ef">const</span> mhPaths[],
                  <span style="color:#66d9ef">const</span> <span style="color:#66d9ef">struct</span> mach_header <span style="color:#f92672">*</span> <span style="color:#66d9ef">const</span> mhdrs[])
{
    <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">bool</span> firstTime <span style="color:#f92672">=</span> YES;
    header_info <span style="color:#f92672">*</span>hList[mhCount];
    uint32_t hCount;
    size_t selrefCount <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;

    <span style="color:#75715e">// Perform first-time initialization if necessary.
</span><span style="color:#75715e"></span>    <span style="color:#75715e">// å¿…è¦æ—¶æ‰§è¡Œé¦–æ¬¡åˆå§‹åŒ–ã€‚
</span><span style="color:#75715e"></span>    <span style="color:#75715e">// This function is called before ordinary library initializers.
</span><span style="color:#75715e"></span>    <span style="color:#75715e">// åœ¨æ™®é€šåº“æ„é€ æ–¹æ³•ä¹‹å‰è°ƒç”¨è¯¥å‡½æ•°ã€‚
</span><span style="color:#75715e"></span>    <span style="color:#75715e">// fixme defer initialization until an objc-using image is found?
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">if</span> (firstTime) {
        preopt_init();
    }

    <span style="color:#75715e">// Xcode ä¸­ OBJC_PRINT_IMAGES ç¯å¢ƒå˜é‡å€¼ä¸º YES æ—¶ï¼Œå°†å¯åœ¨æ§åˆ¶å°æ‰“å°è¯¥ä¿¡æ¯
</span><span style="color:#75715e"></span>    <span style="color:#75715e">// OPTION(PrintImages, OBJC_PRINT_IMAGES, &#34;log image and library names as they are loaded&#34;)
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">if</span> (PrintImages) {
        _objc_inform(<span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">IMAGES: processing %u newly-mapped images...</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>, mhCount);
    }


    <span style="color:#75715e">// Find all images with Objective-C metadata.
</span><span style="color:#75715e"></span>    <span style="color:#75715e">// ä½¿ç”¨ Obj-C å…ƒæ•°æ®æŸ¥æ‰¾æ‰€æœ‰é•œåƒã€‚
</span><span style="color:#75715e"></span>    hCount <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;

    <span style="color:#75715e">// Count classes. Size various table based on the total.
</span><span style="color:#75715e"></span>    <span style="color:#75715e">// è®¡ç®—ç±»ã€‚æ ¹æ®æ€»æ•°è®¡ç®—ä¸åŒçš„è¡¨ã€‚
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">int</span> totalClasses <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
    <span style="color:#66d9ef">int</span> unoptimizedTotalClasses <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
    {
        uint32_t i <span style="color:#f92672">=</span> mhCount;
        <span style="color:#75715e">// éå† mach-o header
</span><span style="color:#75715e"></span>        <span style="color:#66d9ef">while</span> (i<span style="color:#f92672">-</span><span style="color:#f92672">-</span>) {
            <span style="color:#66d9ef">const</span> headerType <span style="color:#f92672">*</span>mhdr <span style="color:#f92672">=</span> (<span style="color:#66d9ef">const</span> headerType <span style="color:#f92672">*</span>)mhdrs[i];

            <span style="color:#75715e">// â¡ï¸ addHeaderï¼šæ·»åŠ å¤´éƒ¨ä¿¡æ¯ï¼ˆè®¡ç®—ç±»çš„æ€»æ•°ã€æœªä¼˜åŒ–çš„ç±»æ€»æ•°ï¼‰
</span><span style="color:#75715e"></span>            <span style="color:#66d9ef">auto</span> hi <span style="color:#f92672">=</span> addHeader(mhdr, mhPaths[i], totalClasses, unoptimizedTotalClasses);
            <span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span>hi) {
                <span style="color:#75715e">// no objc data in this entry
</span><span style="color:#75715e"></span>                <span style="color:#75715e">// è‹¥ hi ä¸ºç©ºï¼Œåˆ™è¯¥æ¡ç›®æ²¡æœ‰ Obj-C æ•°æ®
</span><span style="color:#75715e"></span>                <span style="color:#66d9ef">continue</span>;
            }

            <span style="color:#75715e">// åˆ¤æ–­æ–‡ä»¶ç±»å‹æ˜¯å¦æ˜¯å¯æ‰§è¡Œæ–‡ä»¶
</span><span style="color:#75715e"></span>            <span style="color:#75715e">// #define	MH_EXECUTE	0x2		/* demand paged executable file */
</span><span style="color:#75715e"></span>            <span style="color:#66d9ef">if</span> (mhdr<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>filetype <span style="color:#f92672">=</span><span style="color:#f92672">=</span> MH_EXECUTE) {
                <span style="color:#75715e">// Size some data structures based on main executable&#39;s size
</span><span style="color:#75715e"></span>                <span style="color:#75715e">// æ ¹æ®ä¸»å¯æ‰§è¡Œæ–‡ä»¶çš„å¤§å°è°ƒæ•´ä¸€äº›æ•°æ®ç»“æ„çš„å¤§å°
</span><span style="color:#75715e"></span><span style="color:#75715e">#</span><span style="color:#75715e">if __OBJC2__</span><span style="color:#75715e">
</span><span style="color:#75715e"></span>                size_t count;

                <span style="color:#75715e">// åœ¨ __objc_selrefs èŠ‚è·å– SEL å¼•ç”¨ï¼ˆæ­¤å¤„å¯å‚è€ƒ Mach-O æˆ– Link Map æ–‡ä»¶ä¸­ Sections éƒ¨åˆ†ï¼‰
</span><span style="color:#75715e"></span>                <span style="color:#75715e">// GETSECT(_getObjc2SelectorRefs,        SEL,             &#34;__objc_selrefs&#34;);
</span><span style="color:#75715e"></span>                _getObjc2SelectorRefs(hi, <span style="color:#f92672">&amp;</span>count);
                selrefCount <span style="color:#f92672">+</span><span style="color:#f92672">=</span> count;
                <span style="color:#75715e">// åœ¨ __objc_msgrefs èŠ‚è·å–æ¶ˆæ¯å¼•ç”¨
</span><span style="color:#75715e"></span>                <span style="color:#75715e">// GETSECT(_getObjc2MessageRefs,         message_ref_t,   &#34;__objc_msgrefs&#34;);
</span><span style="color:#75715e"></span>                _getObjc2MessageRefs(hi, <span style="color:#f92672">&amp;</span>count);
                selrefCount <span style="color:#f92672">+</span><span style="color:#f92672">=</span> count;
<span style="color:#75715e">#</span><span style="color:#75715e">else</span><span style="color:#75715e">
</span><span style="color:#75715e"></span>                _getObjcSelectorRefs(hi, <span style="color:#f92672">&amp;</span>selrefCount);
<span style="color:#75715e">#</span><span style="color:#75715e">endif</span><span style="color:#75715e">
</span><span style="color:#75715e"></span>
<span style="color:#75715e">#</span><span style="color:#75715e">if SUPPORT_GC_COMPAT</span><span style="color:#75715e">
</span><span style="color:#75715e"></span>                <span style="color:#75715e">// Halt if this is a GC app.
</span><span style="color:#75715e"></span>                <span style="color:#66d9ef">if</span> (shouldRejectGCApp(hi)) {
                    _objc_fatal_with_reason
                        (OBJC_EXIT_REASON_GC_NOT_SUPPORTED,
                         OS_REASON_FLAG_CONSISTENT_FAILURE,
                         <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Objective-C garbage collection </span><span style="color:#e6db74">&#34;</span>
                         <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">is no longer supported.</span><span style="color:#e6db74">&#34;</span>);
                }
<span style="color:#75715e">#</span><span style="color:#75715e">endif</span><span style="color:#75715e">
</span><span style="color:#75715e"></span>            }

            <span style="color:#75715e">// hList ä¿å­˜ hi å¹¶ hCount è‡ªå¢
</span><span style="color:#75715e"></span>            hList[hCount<span style="color:#f92672">+</span><span style="color:#f92672">+</span>] <span style="color:#f92672">=</span> hi;

            <span style="color:#66d9ef">if</span> (PrintImages) {
                _objc_inform(<span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">IMAGES: loading image for %s%s%s%s%s</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>,
                             hi<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>fname(),
                             mhdr<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>filetype <span style="color:#f92672">=</span><span style="color:#f92672">=</span> MH_BUNDLE <span style="color:#f92672">?</span> <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74"> (bundle)</span><span style="color:#e6db74">&#34;</span> <span style="color:#f92672">:</span> <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">&#34;</span>,
                             hi<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>info()<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>isReplacement() <span style="color:#f92672">?</span> <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74"> (replacement)</span><span style="color:#e6db74">&#34;</span> <span style="color:#f92672">:</span> <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">&#34;</span>,
                             hi<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>info()<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>hasCategoryClassProperties() <span style="color:#f92672">?</span> <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74"> (has class properties)</span><span style="color:#e6db74">&#34;</span> <span style="color:#f92672">:</span> <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">&#34;</span>,
                             hi<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>info()<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>optimizedByDyld()<span style="color:#f92672">?</span><span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74"> (preoptimized)</span><span style="color:#e6db74">&#34;</span><span style="color:#f92672">:</span><span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">&#34;</span>);
            }
        }
    }

    <span style="color:#75715e">// Perform one-time runtime initialization that must be deferred until
</span><span style="color:#75715e"></span>    <span style="color:#75715e">// the executable itself is found. This needs to be done before
</span><span style="color:#75715e"></span>    <span style="color:#75715e">// further initialization.
</span><span style="color:#75715e"></span>    <span style="color:#75715e">// (The executable may not be present in this infoList if the
</span><span style="color:#75715e"></span>    <span style="color:#75715e">// executable does not contain Objective-C code but Objective-C
</span><span style="color:#75715e"></span>    <span style="color:#75715e">// is dynamically loaded later.
</span><span style="color:#75715e"></span>    <span style="color:#75715e">// åœ¨æ‰¾åˆ°å¯æ‰§è¡Œæ–‡ä»¶æœ¬èº«ä¹‹å‰å¿…é¡»å»¶è¿Ÿæ‰§è¡Œä¸€æ¬¡æ€§è¿è¡Œæ—¶åˆå§‹åŒ–ã€‚
</span><span style="color:#75715e"></span>    <span style="color:#75715e">// è¿™éœ€è¦åœ¨è¿›ä¸€æ­¥åˆå§‹åŒ–ä¹‹å‰å®Œæˆã€‚
</span><span style="color:#75715e"></span>    <span style="color:#75715e">// ï¼ˆå¦‚æœå¯æ‰§è¡Œæ–‡ä»¶ä¸åŒ…å« Obj-C ä»£ç ä½† Obj-C åœ¨ä¹‹ååŠ¨æ€åŠ è½½ï¼Œåˆ™ infoList ä¸­å¯èƒ½ä¸åŒ…å«è¯¥å¯æ‰§è¡Œæ–‡ä»¶ã€‚ï¼‰
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">if</span> (firstTime) {
        sel_init(selrefCount);
        arr_init();

<span style="color:#75715e">#</span><span style="color:#75715e">if SUPPORT_GC_COMPAT</span><span style="color:#75715e">
</span><span style="color:#75715e"></span>        <span style="color:#75715e">// Reject any GC images linked to the main executable.
</span><span style="color:#75715e"></span>        <span style="color:#75715e">// We already rejected the app itself above.
</span><span style="color:#75715e"></span>        <span style="color:#75715e">// Images loaded after launch will be rejected by dyld.
</span><span style="color:#75715e"></span>
        <span style="color:#66d9ef">for</span> (uint32_t i <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>; i <span style="color:#f92672">&lt;</span> hCount; i<span style="color:#f92672">+</span><span style="color:#f92672">+</span>) {
            <span style="color:#66d9ef">auto</span> hi <span style="color:#f92672">=</span> hList[i];
            <span style="color:#66d9ef">auto</span> mh <span style="color:#f92672">=</span> hi<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>mhdr();
            <span style="color:#66d9ef">if</span> (mh<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>filetype <span style="color:#f92672">!</span><span style="color:#f92672">=</span> MH_EXECUTE  <span style="color:#f92672">&amp;</span><span style="color:#f92672">&amp;</span>  shouldRejectGCImage(mh)) {
                _objc_fatal_with_reason
                    (OBJC_EXIT_REASON_GC_NOT_SUPPORTED,
                     OS_REASON_FLAG_CONSISTENT_FAILURE,
                     <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">%s requires Objective-C garbage collection </span><span style="color:#e6db74">&#34;</span>
                     <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">which is no longer supported.</span><span style="color:#e6db74">&#34;</span>, hi<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>fname());
            }
        }
<span style="color:#75715e">#</span><span style="color:#75715e">endif</span><span style="color:#75715e">
</span><span style="color:#75715e"></span>
<span style="color:#75715e">#</span><span style="color:#75715e">if TARGET_OS_OSX</span><span style="color:#75715e">
</span><span style="color:#75715e"></span>        <span style="color:#75715e">// Disable +initialize fork safety if the app is too old (&lt; 10.13).
</span><span style="color:#75715e"></span>        <span style="color:#75715e">// Disable +initialize fork safety if the app has a
</span><span style="color:#75715e"></span>        <span style="color:#75715e">//   __DATA,__objc_fork_ok section.
</span><span style="color:#75715e"></span>
        <span style="color:#66d9ef">if</span> (dyld_get_program_sdk_version() <span style="color:#f92672">&lt;</span> DYLD_MACOSX_VERSION_10_13) {
            DisableInitializeForkSafety <span style="color:#f92672">=</span> true;
            <span style="color:#66d9ef">if</span> (PrintInitializing) {
                _objc_inform(<span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">INITIALIZE: disabling +initialize fork </span><span style="color:#e6db74">&#34;</span>
                             <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">safety enforcement because the app is </span><span style="color:#e6db74">&#34;</span>
                             <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">too old (SDK version </span><span style="color:#e6db74">&#34;</span> SDK_FORMAT <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">)</span><span style="color:#e6db74">&#34;</span>,
                             FORMAT_SDK(dyld_get_program_sdk_version()));
            }
        }

        <span style="color:#66d9ef">for</span> (uint32_t i <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>; i <span style="color:#f92672">&lt;</span> hCount; i<span style="color:#f92672">+</span><span style="color:#f92672">+</span>) {
            <span style="color:#66d9ef">auto</span> hi <span style="color:#f92672">=</span> hList[i];
            <span style="color:#66d9ef">auto</span> mh <span style="color:#f92672">=</span> hi<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>mhdr();
            <span style="color:#66d9ef">if</span> (mh<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>filetype <span style="color:#f92672">!</span><span style="color:#f92672">=</span> MH_EXECUTE) <span style="color:#66d9ef">continue</span>;
            <span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">long</span> size;
            <span style="color:#66d9ef">if</span> (getsectiondata(hi<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>mhdr(), <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">__DATA</span><span style="color:#e6db74">&#34;</span>, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">__objc_fork_ok</span><span style="color:#e6db74">&#34;</span>, <span style="color:#f92672">&amp;</span>size)) {
                DisableInitializeForkSafety <span style="color:#f92672">=</span> true;
                <span style="color:#66d9ef">if</span> (PrintInitializing) {
                    _objc_inform(<span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">INITIALIZE: disabling +initialize fork </span><span style="color:#e6db74">&#34;</span>
                                 <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">safety enforcement because the app has </span><span style="color:#e6db74">&#34;</span>
                                 <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">a __DATA,__objc_fork_ok section</span><span style="color:#e6db74">&#34;</span>);
                }
            }
            <span style="color:#66d9ef">break</span>;  <span style="color:#75715e">// assume only one MH_EXECUTE image
</span><span style="color:#75715e"></span>        }
<span style="color:#75715e">#</span><span style="color:#75715e">endif</span><span style="color:#75715e">
</span><span style="color:#75715e"></span>
    }

    <span style="color:#66d9ef">if</span> (hCount <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">0</span>) {
        <span style="color:#75715e">// â¡ï¸ è¯»å–é•œåƒï¼ˆä¼ å…¥ header_info åˆ—è¡¨ï¼Œæ•°é‡ï¼Œç±»çš„æ€»æ•°ï¼Œæœªä¼˜åŒ–çš„ç±»çš„æ€»æ•°ï¼‰
</span><span style="color:#75715e"></span>        _read_images(hList, hCount, totalClasses, unoptimizedTotalClasses);
    }

    <span style="color:#75715e">// ç¬¬ä¸€æ¬¡æ‰§è¡Œå®Œæ¯•åï¼Œç½®ä¸º NO
</span><span style="color:#75715e"></span>    firstTime <span style="color:#f92672">=</span> NO;
}

<span style="color:#75715e">// objc-os.mm
</span><span style="color:#75715e"></span><span style="color:#66d9ef">static</span> header_info <span style="color:#f92672">*</span> <span style="color:#a6e22e">addHeader</span>(<span style="color:#66d9ef">const</span> headerType <span style="color:#f92672">*</span>mhdr, <span style="color:#66d9ef">const</span> <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>path, <span style="color:#66d9ef">int</span> <span style="color:#f92672">&amp;</span>totalClasses, <span style="color:#66d9ef">int</span> <span style="color:#f92672">&amp;</span>unoptimizedTotalClasses)
{
    header_info <span style="color:#f92672">*</span>hi;

    <span style="color:#66d9ef">if</span> (bad_magic(mhdr)) <span style="color:#66d9ef">return</span> NULL;

    <span style="color:#66d9ef">bool</span> inSharedCache <span style="color:#f92672">=</span> false;

    <span style="color:#75715e">// Look for hinfo from the dyld shared cache.
</span><span style="color:#75715e"></span>    <span style="color:#75715e">// åœ¨ dyld å…±äº«ç¼“å­˜ä¸­å¯»æ‰¾ hinfoï¼ˆå…³äº dyld å…±äº«ç¼“å­˜å¯å‚è€ƒæ–‡æœ«ã€Œè°ˆè°ˆ iOS ä¸­çš„ dyld_shared_cacheã€ä¸€æ–‡ï¼‰ã€‚
</span><span style="color:#75715e"></span>    <span style="color:#75715e">// ä¸ºå¤´éƒ¨é¢„ä¼˜åŒ– hinfo
</span><span style="color:#75715e"></span>    hi <span style="color:#f92672">=</span> preoptimizedHinfoForHeader(mhdr);
    <span style="color:#66d9ef">if</span> (hi) {
        <span style="color:#75715e">// Found an hinfo in the dyld shared cache.
</span><span style="color:#75715e"></span>        <span style="color:#75715e">// åœ¨ dyld å…±äº«ç¼“å­˜ä¸­æ‰¾åˆ° hinfo
</span><span style="color:#75715e"></span>
        <span style="color:#75715e">// Weed out duplicates.
</span><span style="color:#75715e"></span>        <span style="color:#75715e">// å»é™¤é‡å¤ï¼ˆè‹¥è¯¥ hi å·²è¢«åŠ è½½ï¼Œåˆ™è¿”å›ç©ºï¼‰ã€‚
</span><span style="color:#75715e"></span>        <span style="color:#66d9ef">if</span> (hi<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>isLoaded()) {
            <span style="color:#66d9ef">return</span> NULL;
        }

        inSharedCache <span style="color:#f92672">=</span> true;

        <span style="color:#75715e">// Initialize fields not set by the shared cache
</span><span style="color:#75715e"></span>        <span style="color:#75715e">// åˆå§‹åŒ–æœªç”±å…±äº«ç¼“å­˜è®¾ç½®çš„åŸŸ
</span><span style="color:#75715e"></span>        <span style="color:#75715e">// hi-&gt;next is set by appendHeader
</span><span style="color:#75715e"></span>        <span style="color:#75715e">// hi-&gt;next ç”± appendHeader è®¾ç½®
</span><span style="color:#75715e"></span>        <span style="color:#75715e">// è®¾ç½®å·²åŠ è½½ä¸º true
</span><span style="color:#75715e"></span>        hi<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>setLoaded(true);

        <span style="color:#75715e">// Xcode ä¸­ OBJC_PRINT_PREOPTIMIZATION ç¯å¢ƒå˜é‡å€¼ä¸º YES æ—¶ï¼Œå°†å¯åœ¨æ§åˆ¶å°æ‰“å°è¯¥ä¿¡æ¯
</span><span style="color:#75715e"></span>        <span style="color:#75715e">// OPTION(PrintPreopt, OBJC_PRINT_PREOPTIMIZATION, &#34;log preoptimization courtesy of dyld shared cache&#34;)
</span><span style="color:#75715e"></span>        <span style="color:#66d9ef">if</span> (PrintPreopt) {
            _objc_inform(<span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">PREOPTIMIZATION: honoring preoptimized header info at %p for %s</span><span style="color:#e6db74">&#34;</span>, hi, hi<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>fname());
        }

<span style="color:#75715e">#</span><span style="color:#75715e">if !__OBJC2__</span><span style="color:#75715e">
</span><span style="color:#75715e"></span>        _objc_fatal(<span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">shouldn&#39;t be here</span><span style="color:#e6db74">&#34;</span>);
<span style="color:#75715e">#</span><span style="color:#75715e">endif</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">#</span><span style="color:#75715e">if DEBUG</span><span style="color:#75715e">
</span><span style="color:#75715e"></span>        <span style="color:#75715e">// Verify image_info
</span><span style="color:#75715e"></span>        <span style="color:#75715e">// DEBUG æ¨¡å¼æ ¡éªŒ image_info
</span><span style="color:#75715e"></span>        size_t info_size <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
        <span style="color:#66d9ef">const</span> objc_image_info <span style="color:#f92672">*</span>image_info <span style="color:#f92672">=</span> _getObjcImageInfo(mhdr,<span style="color:#f92672">&amp;</span>info_size);
        assert(image_info <span style="color:#f92672">=</span><span style="color:#f92672">=</span> hi<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>info());
<span style="color:#75715e">#</span><span style="color:#75715e">endif</span><span style="color:#75715e">
</span><span style="color:#75715e"></span>    }
    <span style="color:#66d9ef">else</span>
    {
        <span style="color:#75715e">// Didn&#39;t find an hinfo in the dyld shared cache.
</span><span style="color:#75715e"></span>        <span style="color:#75715e">// åœ¨ dyld å…±äº«ç¼“å­˜ä¸­æœªæ‰¾åˆ° hinfoã€‚
</span><span style="color:#75715e"></span>
        <span style="color:#75715e">// Weed out duplicates
</span><span style="color:#75715e"></span>        <span style="color:#75715e">// å»é™¤é‡å¤
</span><span style="color:#75715e"></span>        <span style="color:#66d9ef">for</span> (hi <span style="color:#f92672">=</span> FirstHeader; hi; hi <span style="color:#f92672">=</span> hi<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>getNext()) {
            <span style="color:#66d9ef">if</span> (mhdr <span style="color:#f92672">=</span><span style="color:#f92672">=</span> hi<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>mhdr()) <span style="color:#66d9ef">return</span> NULL;
        }

        <span style="color:#75715e">// Locate the __OBJC segment
</span><span style="color:#75715e"></span>        <span style="color:#75715e">// å®šä½ __OBJC æ®µï¼ˆSegmentï¼‰
</span><span style="color:#75715e"></span>        size_t info_size <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
        <span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">long</span> seg_size;
        <span style="color:#75715e">// _getObjcImageInfoï¼šå†…éƒ¨å®é™…æ˜¯è·å– __objc_imageinfo æ•°æ®ï¼ˆ__DATA æˆ– __DATA_CONST æˆ– __DATA_DIRTYï¼‰èŠ‚ï¼ˆSectionï¼‰ä¿¡æ¯
</span><span style="color:#75715e"></span>        <span style="color:#66d9ef">const</span> objc_image_info <span style="color:#f92672">*</span>image_info <span style="color:#f92672">=</span> _getObjcImageInfo(mhdr,<span style="color:#f92672">&amp;</span>info_size);
        <span style="color:#75715e">// getsegmentdataï¼šè·å– __OBJC æ®µæ•°æ®
</span><span style="color:#75715e"></span>        <span style="color:#75715e">// #define	SEG_OBJC	&#34;__OBJC&#34;	/* objective-C runtime segment */
</span><span style="color:#75715e"></span>        <span style="color:#66d9ef">const</span> uint8_t <span style="color:#f92672">*</span>objc_segment <span style="color:#f92672">=</span> getsegmentdata(mhdr,SEG_OBJC,<span style="color:#f92672">&amp;</span>seg_size);
        <span style="color:#75715e">// è‹¥éƒ½æ²¡æœ‰è·å–åˆ°ï¼Œè¿”å›ç©º
</span><span style="color:#75715e"></span>        <span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span>objc_segment  <span style="color:#f92672">&amp;</span><span style="color:#f92672">&amp;</span>  <span style="color:#f92672">!</span>image_info) <span style="color:#66d9ef">return</span> NULL;

        <span style="color:#75715e">// Allocate a header_info entry.
</span><span style="color:#75715e"></span>        <span style="color:#75715e">// åˆ†é…ä¸€ä¸ª header_infoã€‚
</span><span style="color:#75715e"></span>        <span style="color:#75715e">// Note we also allocate space for a single header_info_rw in the
</span><span style="color:#75715e"></span>        <span style="color:#75715e">// rw_data[] inside header_info.
</span><span style="color:#75715e"></span>        <span style="color:#75715e">// æ³¨æ„æˆ‘ä»¬åœ¨ header_info å†…éƒ¨çš„ rw_data[] ä¹Ÿä¸ºå•ä¸ª header_info_rw åˆ†é…äº†ç©ºé—´ã€‚
</span><span style="color:#75715e"></span>        hi <span style="color:#f92672">=</span> (header_info <span style="color:#f92672">*</span>)calloc(<span style="color:#66d9ef">sizeof</span>(header_info) <span style="color:#f92672">+</span> <span style="color:#66d9ef">sizeof</span>(header_info_rw), <span style="color:#ae81ff">1</span>);

        <span style="color:#75715e">// Set up the new header_info entry.
</span><span style="color:#75715e"></span>        <span style="color:#75715e">// è®¾ç½®æ–°çš„ header_infoã€‚
</span><span style="color:#75715e"></span>        hi<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>setmhdr(mhdr);
<span style="color:#75715e">#</span><span style="color:#75715e">if !__OBJC2__</span><span style="color:#75715e">
</span><span style="color:#75715e"></span>        <span style="color:#75715e">// mhdr must already be set
</span><span style="color:#75715e"></span>        hi<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>mod_count <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
        hi<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>mod_ptr <span style="color:#f92672">=</span> _getObjcModules(hi, <span style="color:#f92672">&amp;</span>hi<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>mod_count);
<span style="color:#75715e">#</span><span style="color:#75715e">endif</span><span style="color:#75715e">
</span><span style="color:#75715e"></span>        <span style="color:#75715e">// Install a placeholder image_info if absent to simplify code elsewhere
</span><span style="color:#75715e"></span>        <span style="color:#75715e">// å¦‚æœæ²¡æœ‰åœ¨å…¶ä»–åœ°æ–¹ç®€åŒ–ä»£ç åˆ™å®‰è£…å ä½ç¬¦ image_info
</span><span style="color:#75715e"></span>        <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">const</span> objc_image_info emptyInfo <span style="color:#f92672">=</span> {<span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">0</span>};
        hi<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>setinfo(image_info <span style="color:#f92672">?</span><span style="color:#f92672">:</span> <span style="color:#f92672">&amp;</span>emptyInfo);

        <span style="color:#75715e">// è®¾ç½®å·²åŠ è½½ä¸º true
</span><span style="color:#75715e"></span>        hi<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>setLoaded(true);
        hi<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>setAllClassesRealized(NO);
    }

<span style="color:#75715e">#</span><span style="color:#75715e">if __OBJC2__</span><span style="color:#75715e">
</span><span style="color:#75715e"></span>    {
        size_t count <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
        <span style="color:#75715e">// åœ¨ __objc_classlist èŠ‚è·å–ç±»åˆ—è¡¨
</span><span style="color:#75715e"></span>        <span style="color:#75715e">// GETSECT(_getObjc2ClassList,           classref_t,      &#34;__objc_classlist&#34;);
</span><span style="color:#75715e"></span>        <span style="color:#66d9ef">if</span> (_getObjc2ClassList(hi, <span style="color:#f92672">&amp;</span>count)) {
            <span style="color:#75715e">// totalClasses è®¾ç½®ä¸ºè·å–åˆ°çš„ç±»æ•°é‡
</span><span style="color:#75715e"></span>            totalClasses <span style="color:#f92672">+</span><span style="color:#f92672">=</span> (<span style="color:#66d9ef">int</span>)count;
            <span style="color:#75715e">// è‹¥è·å–çš„ header_info ä¸åœ¨å…±äº«ç¼“å­˜ä¸­ï¼Œåˆ™è§†ä¸ºæœªä¼˜åŒ–ç±»ï¼Œæ›´æ–° unoptimizedTotalClasses
</span><span style="color:#75715e"></span>            <span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span>inSharedCache) unoptimizedTotalClasses <span style="color:#f92672">+</span><span style="color:#f92672">=</span> count;
        }
    }
<span style="color:#75715e">#</span><span style="color:#75715e">endif</span><span style="color:#75715e">
</span><span style="color:#75715e"></span>
    appendHeader(hi);

    <span style="color:#66d9ef">return</span> hi;
}

<span style="color:#75715e">// objc-runtime-new.mm
</span><span style="color:#75715e"></span><span style="color:#75715e">/***********************************************************************
</span><span style="color:#75715e">* _read_images
</span><span style="color:#75715e">* Perform initial processing of the headers in the linked
</span><span style="color:#75715e">* list beginning with headerList.
</span><span style="color:#75715e">* ä» headerList å¼€å§‹ä¸ºé“¾è¡¨ä¸­çš„å¤´éƒ¨æ‰§è¡Œåˆå§‹å¤„ç†ã€‚
</span><span style="color:#75715e">*
</span><span style="color:#75715e">* Called by: map_images_nolock
</span><span style="color:#75715e">* ç”± map_images_nolock è°ƒç”¨
</span><span style="color:#75715e">*
</span><span style="color:#75715e">* Locking: runtimeLock acquired by map_images
</span><span style="color:#75715e">* é”ï¼šç”± map_images è·å¾—çš„ runtimeLock
</span><span style="color:#75715e">**********************************************************************/</span>
<span style="color:#66d9ef">void</span> <span style="color:#a6e22e">_read_images</span>(header_info <span style="color:#f92672">*</span><span style="color:#f92672">*</span>hList, uint32_t hCount, <span style="color:#66d9ef">int</span> totalClasses, <span style="color:#66d9ef">int</span> unoptimizedTotalClasses)
{
    header_info <span style="color:#f92672">*</span>hi;
    uint32_t hIndex;
    size_t count;
    size_t i;
    <span style="color:#66d9ef">Class</span> <span style="color:#f92672">*</span>resolvedFutureClasses <span style="color:#f92672">=</span> nil;
    size_t resolvedFutureClassCount <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
    <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">bool</span> doneOnce;
    TimeLogger ts(PrintImageTimes);

    runtimeLock.assertLocked();

<span style="color:#75715e">#</span><span style="color:#75715e">define EACH_HEADER \</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">    hIndex = 0;         \</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">    hIndex &lt; hCount &amp;&amp; (hi = hList[hIndex]); \</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">    hIndex++</span><span style="color:#75715e">
</span><span style="color:#75715e"></span>
    <span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span>doneOnce) {
        doneOnce <span style="color:#f92672">=</span> YES;

<span style="color:#75715e">#</span><span style="color:#75715e">if SUPPORT_NONPOINTER_ISA</span><span style="color:#75715e">
</span><span style="color:#75715e"></span>        <span style="color:#75715e">// Disable non-pointer isa under some conditions.
</span><span style="color:#75715e"></span>
<span style="color:#75715e">#</span><span style="color:#75715e"> if SUPPORT_INDEXED_ISA</span><span style="color:#75715e">
</span><span style="color:#75715e"></span>        <span style="color:#75715e">// Disable nonpointer isa if any image contains old Swift code
</span><span style="color:#75715e"></span>        <span style="color:#66d9ef">for</span> (EACH_HEADER) {
            <span style="color:#66d9ef">if</span> (hi<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>info()<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>containsSwift()  <span style="color:#f92672">&amp;</span><span style="color:#f92672">&amp;</span>
                hi<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>info()<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>swiftVersion() <span style="color:#f92672">&lt;</span> objc_image_info<span style="color:#f92672">:</span><span style="color:#f92672">:</span>SwiftVersion3)
            {
                DisableNonpointerIsa <span style="color:#f92672">=</span> true;
                <span style="color:#66d9ef">if</span> (PrintRawIsa) {
                    _objc_inform(<span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">RAW ISA: disabling non-pointer isa because </span><span style="color:#e6db74">&#34;</span>
                                 <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">the app or a framework contains Swift code </span><span style="color:#e6db74">&#34;</span>
                                 <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">older than Swift 3.0</span><span style="color:#e6db74">&#34;</span>);
                }
                <span style="color:#66d9ef">break</span>;
            }
        }
<span style="color:#75715e">#</span><span style="color:#75715e"> endif</span><span style="color:#75715e">
</span><span style="color:#75715e"></span>
<span style="color:#75715e">#</span><span style="color:#75715e"> if TARGET_OS_OSX</span><span style="color:#75715e">
</span><span style="color:#75715e"></span>        <span style="color:#75715e">// Disable non-pointer isa if the app is too old
</span><span style="color:#75715e"></span>        <span style="color:#75715e">// (linked before OS X 10.11)
</span><span style="color:#75715e"></span>        <span style="color:#66d9ef">if</span> (dyld_get_program_sdk_version() <span style="color:#f92672">&lt;</span> DYLD_MACOSX_VERSION_10_11) {
            DisableNonpointerIsa <span style="color:#f92672">=</span> true;
            <span style="color:#66d9ef">if</span> (PrintRawIsa) {
                _objc_inform(<span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">RAW ISA: disabling non-pointer isa because </span><span style="color:#e6db74">&#34;</span>
                             <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">the app is too old (SDK version </span><span style="color:#e6db74">&#34;</span> SDK_FORMAT <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">)</span><span style="color:#e6db74">&#34;</span>,
                             FORMAT_SDK(dyld_get_program_sdk_version()));
            }
        }

        <span style="color:#75715e">// Disable non-pointer isa if the app has a __DATA,__objc_rawisa section
</span><span style="color:#75715e"></span>        <span style="color:#75715e">// New apps that load old extensions may need this.
</span><span style="color:#75715e"></span>        <span style="color:#66d9ef">for</span> (EACH_HEADER) {
            <span style="color:#66d9ef">if</span> (hi<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>mhdr()<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>filetype <span style="color:#f92672">!</span><span style="color:#f92672">=</span> MH_EXECUTE) <span style="color:#66d9ef">continue</span>;
            <span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">long</span> size;
            <span style="color:#66d9ef">if</span> (getsectiondata(hi<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>mhdr(), <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">__DATA</span><span style="color:#e6db74">&#34;</span>, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">__objc_rawisa</span><span style="color:#e6db74">&#34;</span>, <span style="color:#f92672">&amp;</span>size)) {
                DisableNonpointerIsa <span style="color:#f92672">=</span> true;
                <span style="color:#66d9ef">if</span> (PrintRawIsa) {
                    _objc_inform(<span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">RAW ISA: disabling non-pointer isa because </span><span style="color:#e6db74">&#34;</span>
                                 <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">the app has a __DATA,__objc_rawisa section</span><span style="color:#e6db74">&#34;</span>);
                }
            }
            <span style="color:#66d9ef">break</span>;  <span style="color:#75715e">// assume only one MH_EXECUTE image
</span><span style="color:#75715e"></span>        }
<span style="color:#75715e">#</span><span style="color:#75715e"> endif</span><span style="color:#75715e">
</span><span style="color:#75715e"></span>
<span style="color:#75715e">#</span><span style="color:#75715e">endif</span><span style="color:#75715e">
</span><span style="color:#75715e"></span>
        <span style="color:#66d9ef">if</span> (DisableTaggedPointers) {
            disableTaggedPointers();
        }

        initializeTaggedPointerObfuscator();

        <span style="color:#66d9ef">if</span> (PrintConnecting) {
            _objc_inform(<span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">CLASS: found %d classes during launch</span><span style="color:#e6db74">&#34;</span>, totalClasses);
        }

        <span style="color:#75715e">// namedClasses
</span><span style="color:#75715e"></span>        <span style="color:#75715e">// Preoptimized classes don&#39;t go in this table.
</span><span style="color:#75715e"></span>        <span style="color:#75715e">// 4/3 is NXMapTable&#39;s load factor
</span><span style="color:#75715e"></span>        <span style="color:#66d9ef">int</span> namedClassesSize <span style="color:#f92672">=</span>
            (isPreoptimized() <span style="color:#f92672">?</span> unoptimizedTotalClasses : totalClasses) <span style="color:#f92672">*</span> <span style="color:#ae81ff">4</span> <span style="color:#f92672">/</span> <span style="color:#ae81ff">3</span>;
        gdb_objc_realized_classes <span style="color:#f92672">=</span>
            NXCreateMapTable(NXStrValueMapPrototype, namedClassesSize);

        allocatedClasses <span style="color:#f92672">=</span> NXCreateHashTable(NXPtrPrototype, <span style="color:#ae81ff">0</span>, nil);

        ts.log(<span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">IMAGE TIMES: first time tasks</span><span style="color:#e6db74">&#34;</span>);
    }


    <span style="color:#75715e">// Discover classes. Fix up unresolved future classes. Mark bundle classes.
</span><span style="color:#75715e"></span>
    <span style="color:#66d9ef">for</span> (EACH_HEADER) {
        classref_t <span style="color:#f92672">*</span>classlist <span style="color:#f92672">=</span> _getObjc2ClassList(hi, <span style="color:#f92672">&amp;</span>count);

        <span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span> mustReadClasses(hi)) {
            <span style="color:#75715e">// Image is sufficiently optimized that we need not call readClass()
</span><span style="color:#75715e"></span>            <span style="color:#66d9ef">continue</span>;
        }

        <span style="color:#66d9ef">bool</span> headerIsBundle <span style="color:#f92672">=</span> hi<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>isBundle();
        <span style="color:#66d9ef">bool</span> headerIsPreoptimized <span style="color:#f92672">=</span> hi<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>isPreoptimized();

        <span style="color:#66d9ef">for</span> (i <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>; i <span style="color:#f92672">&lt;</span> count; i<span style="color:#f92672">+</span><span style="color:#f92672">+</span>) {
            <span style="color:#66d9ef">Class</span> cls <span style="color:#f92672">=</span> (<span style="color:#66d9ef">Class</span>)classlist[i];
            <span style="color:#66d9ef">Class</span> newCls <span style="color:#f92672">=</span> readClass(cls, headerIsBundle, headerIsPreoptimized);

            <span style="color:#66d9ef">if</span> (newCls <span style="color:#f92672">!</span><span style="color:#f92672">=</span> cls  <span style="color:#f92672">&amp;</span><span style="color:#f92672">&amp;</span>  newCls) {
                <span style="color:#75715e">// Class was moved but not deleted. Currently this occurs
</span><span style="color:#75715e"></span>                <span style="color:#75715e">// only when the new class resolved a future class.
</span><span style="color:#75715e"></span>                <span style="color:#75715e">// Non-lazily realize the class below.
</span><span style="color:#75715e"></span>                resolvedFutureClasses <span style="color:#f92672">=</span> (<span style="color:#66d9ef">Class</span> <span style="color:#f92672">*</span>)
                    realloc(resolvedFutureClasses,
                            (resolvedFutureClassCount<span style="color:#f92672">+</span><span style="color:#ae81ff">1</span>) <span style="color:#f92672">*</span> <span style="color:#66d9ef">sizeof</span>(<span style="color:#66d9ef">Class</span>));
                resolvedFutureClasses[resolvedFutureClassCount<span style="color:#f92672">+</span><span style="color:#f92672">+</span>] <span style="color:#f92672">=</span> newCls;
            }
        }
    }

    ts.log(<span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">IMAGE TIMES: discover classes</span><span style="color:#e6db74">&#34;</span>);

    <span style="color:#75715e">// Fix up remapped classes
</span><span style="color:#75715e"></span>    <span style="color:#75715e">// Class list and nonlazy class list remain unremapped.
</span><span style="color:#75715e"></span>    <span style="color:#75715e">// Class refs and super refs are remapped for message dispatching.
</span><span style="color:#75715e"></span>
    <span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span>noClassesRemapped()) {
        <span style="color:#66d9ef">for</span> (EACH_HEADER) {
            <span style="color:#66d9ef">Class</span> <span style="color:#f92672">*</span>classrefs <span style="color:#f92672">=</span> _getObjc2ClassRefs(hi, <span style="color:#f92672">&amp;</span>count);
            <span style="color:#66d9ef">for</span> (i <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>; i <span style="color:#f92672">&lt;</span> count; i<span style="color:#f92672">+</span><span style="color:#f92672">+</span>) {
                remapClassRef(<span style="color:#f92672">&amp;</span>classrefs[i]);
            }
            <span style="color:#75715e">// fixme why doesn&#39;t test future1 catch the absence of this?
</span><span style="color:#75715e"></span>            classrefs <span style="color:#f92672">=</span> _getObjc2SuperRefs(hi, <span style="color:#f92672">&amp;</span>count);
            <span style="color:#66d9ef">for</span> (i <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>; i <span style="color:#f92672">&lt;</span> count; i<span style="color:#f92672">+</span><span style="color:#f92672">+</span>) {
                remapClassRef(<span style="color:#f92672">&amp;</span>classrefs[i]);
            }
        }
    }

    ts.log(<span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">IMAGE TIMES: remap classes</span><span style="color:#e6db74">&#34;</span>);

    <span style="color:#75715e">// Fix up @selector references
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">static</span> size_t UnfixedSelectors;
    {
        mutex_locker_t lock(selLock);
        <span style="color:#66d9ef">for</span> (EACH_HEADER) {
            <span style="color:#66d9ef">if</span> (hi<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>isPreoptimized()) <span style="color:#66d9ef">continue</span>;

            <span style="color:#66d9ef">bool</span> isBundle <span style="color:#f92672">=</span> hi<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>isBundle();
            <span style="color:#66d9ef">SEL</span> <span style="color:#f92672">*</span>sels <span style="color:#f92672">=</span> _getObjc2SelectorRefs(hi, <span style="color:#f92672">&amp;</span>count);
            UnfixedSelectors <span style="color:#f92672">+</span><span style="color:#f92672">=</span> count;
            <span style="color:#66d9ef">for</span> (i <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>; i <span style="color:#f92672">&lt;</span> count; i<span style="color:#f92672">+</span><span style="color:#f92672">+</span>) {
                <span style="color:#66d9ef">const</span> <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>name <span style="color:#f92672">=</span> sel_cname(sels[i]);
                sels[i] <span style="color:#f92672">=</span> sel_registerNameNoLock(name, isBundle);
            }
        }
    }

    ts.log(<span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">IMAGE TIMES: fix up selector references</span><span style="color:#e6db74">&#34;</span>);

<span style="color:#75715e">#</span><span style="color:#75715e">if SUPPORT_FIXUP</span><span style="color:#75715e">
</span><span style="color:#75715e"></span>    <span style="color:#75715e">// Fix up old objc_msgSend_fixup call sites
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">for</span> (EACH_HEADER) {
        message_ref_t <span style="color:#f92672">*</span>refs <span style="color:#f92672">=</span> _getObjc2MessageRefs(hi, <span style="color:#f92672">&amp;</span>count);
        <span style="color:#66d9ef">if</span> (count <span style="color:#f92672">=</span><span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>) <span style="color:#66d9ef">continue</span>;

        <span style="color:#66d9ef">if</span> (PrintVtables) {
            _objc_inform(<span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">VTABLES: repairing %zu unsupported vtable dispatch </span><span style="color:#e6db74">&#34;</span>
                         <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">call sites in %s</span><span style="color:#e6db74">&#34;</span>, count, hi<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>fname());
        }
        <span style="color:#66d9ef">for</span> (i <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>; i <span style="color:#f92672">&lt;</span> count; i<span style="color:#f92672">+</span><span style="color:#f92672">+</span>) {
            fixupMessageRef(refs<span style="color:#f92672">+</span>i);
        }
    }

    ts.log(<span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">IMAGE TIMES: fix up objc_msgSend_fixup</span><span style="color:#e6db74">&#34;</span>);
<span style="color:#75715e">#</span><span style="color:#75715e">endif</span><span style="color:#75715e">
</span><span style="color:#75715e"></span>
    <span style="color:#75715e">// Discover protocols. Fix up protocol refs.
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">for</span> (EACH_HEADER) {
        <span style="color:#66d9ef">extern</span> objc_class OBJC_CLASS_<span style="color:#960050;background-color:#1e0010">$</span>_Protocol;
        <span style="color:#66d9ef">Class</span> cls <span style="color:#f92672">=</span> (<span style="color:#66d9ef">Class</span>)<span style="color:#f92672">&amp;</span>OBJC_CLASS_<span style="color:#960050;background-color:#1e0010">$</span>_Protocol;
        assert(cls);
        NXMapTable <span style="color:#f92672">*</span>protocol_map <span style="color:#f92672">=</span> protocols();
        <span style="color:#66d9ef">bool</span> isPreoptimized <span style="color:#f92672">=</span> hi<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>isPreoptimized();
        <span style="color:#66d9ef">bool</span> isBundle <span style="color:#f92672">=</span> hi<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>isBundle();

        protocol_t <span style="color:#f92672">*</span><span style="color:#f92672">*</span>protolist <span style="color:#f92672">=</span> _getObjc2ProtocolList(hi, <span style="color:#f92672">&amp;</span>count);
        <span style="color:#66d9ef">for</span> (i <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>; i <span style="color:#f92672">&lt;</span> count; i<span style="color:#f92672">+</span><span style="color:#f92672">+</span>) {
            readProtocol(protolist[i], cls, protocol_map,
                         isPreoptimized, isBundle);
        }
    }

    ts.log(<span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">IMAGE TIMES: discover protocols</span><span style="color:#e6db74">&#34;</span>);

    <span style="color:#75715e">// Fix up @protocol references
</span><span style="color:#75715e"></span>    <span style="color:#75715e">// Preoptimized images may have the right
</span><span style="color:#75715e"></span>    <span style="color:#75715e">// answer already but we don&#39;t know for sure.
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">for</span> (EACH_HEADER) {
        protocol_t <span style="color:#f92672">*</span><span style="color:#f92672">*</span>protolist <span style="color:#f92672">=</span> _getObjc2ProtocolRefs(hi, <span style="color:#f92672">&amp;</span>count);
        <span style="color:#66d9ef">for</span> (i <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>; i <span style="color:#f92672">&lt;</span> count; i<span style="color:#f92672">+</span><span style="color:#f92672">+</span>) {
            remapProtocolRef(<span style="color:#f92672">&amp;</span>protolist[i]);
        }
    }

    ts.log(<span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">IMAGE TIMES: fix up @protocol references</span><span style="color:#e6db74">&#34;</span>);

    <span style="color:#75715e">// Realize non-lazy classes (for +load methods and static instances)
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">for</span> (EACH_HEADER) {
        classref_t <span style="color:#f92672">*</span>classlist <span style="color:#f92672">=</span>
            _getObjc2NonlazyClassList(hi, <span style="color:#f92672">&amp;</span>count);
        <span style="color:#66d9ef">for</span> (i <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>; i <span style="color:#f92672">&lt;</span> count; i<span style="color:#f92672">+</span><span style="color:#f92672">+</span>) {
            <span style="color:#66d9ef">Class</span> cls <span style="color:#f92672">=</span> remapClass(classlist[i]);
            <span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span>cls) <span style="color:#66d9ef">continue</span>;

            <span style="color:#75715e">// hack for class __ARCLite__, which didn&#39;t get this above
</span><span style="color:#75715e"></span><span style="color:#75715e">#</span><span style="color:#75715e">if TARGET_OS_SIMULATOR</span><span style="color:#75715e">
</span><span style="color:#75715e"></span>            <span style="color:#66d9ef">if</span> (cls<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>cache._buckets <span style="color:#f92672">=</span><span style="color:#f92672">=</span> (<span style="color:#66d9ef">void</span><span style="color:#f92672">*</span>)<span style="color:#f92672">&amp;</span>_objc_empty_cache  <span style="color:#f92672">&amp;</span><span style="color:#f92672">&amp;</span>
                (cls<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>cache._mask  <span style="color:#f92672">|</span><span style="color:#f92672">|</span>  cls<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>cache._occupied))
            {
                cls<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>cache._mask <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
                cls<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>cache._occupied <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
            }
            <span style="color:#66d9ef">if</span> (cls<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>ISA()<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>cache._buckets <span style="color:#f92672">=</span><span style="color:#f92672">=</span> (<span style="color:#66d9ef">void</span><span style="color:#f92672">*</span>)<span style="color:#f92672">&amp;</span>_objc_empty_cache  <span style="color:#f92672">&amp;</span><span style="color:#f92672">&amp;</span>
                (cls<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>ISA()<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>cache._mask  <span style="color:#f92672">|</span><span style="color:#f92672">|</span>  cls<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>ISA()<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>cache._occupied))
            {
                cls<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>ISA()<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>cache._mask <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
                cls<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>ISA()<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>cache._occupied <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
            }
<span style="color:#75715e">#</span><span style="color:#75715e">endif</span><span style="color:#75715e">
</span><span style="color:#75715e"></span>
            addClassTableEntry(cls);
            realizeClass(cls);
        }
    }

    ts.log(<span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">IMAGE TIMES: realize non-lazy classes</span><span style="color:#e6db74">&#34;</span>);

    <span style="color:#75715e">// Realize newly-resolved future classes, in case CF manipulates them
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">if</span> (resolvedFutureClasses) {
        <span style="color:#66d9ef">for</span> (i <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>; i <span style="color:#f92672">&lt;</span> resolvedFutureClassCount; i<span style="color:#f92672">+</span><span style="color:#f92672">+</span>) {
            realizeClass(resolvedFutureClasses[i]);
            resolvedFutureClasses[i]<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>setInstancesRequireRawIsa(false<span style="color:#75715e">/*inherited*/</span>);
        }
        free(resolvedFutureClasses);
    }

    ts.log(<span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">IMAGE TIMES: realize future classes</span><span style="color:#e6db74">&#34;</span>);

    <span style="color:#75715e">// â¡ï¸ Category
</span><span style="color:#75715e"></span>    <span style="color:#75715e">// Discover categories.
</span><span style="color:#75715e"></span>    <span style="color:#75715e">// å‘ç° Categoryã€‚
</span><span style="color:#75715e"></span>    <span style="color:#75715e">// éå† hList ä¸­çš„ header_info
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">for</span> (EACH_HEADER) {
        <span style="color:#75715e">// åœ¨ __objc_catlist èŠ‚è·å– Category åˆ—è¡¨
</span><span style="color:#75715e"></span>        <span style="color:#75715e">// GETSECT(_getObjc2CategoryList,        category_t *,    &#34;__objc_catlist&#34;);
</span><span style="color:#75715e"></span>        category_t <span style="color:#f92672">*</span><span style="color:#f92672">*</span>catlist <span style="color:#f92672">=</span>
            _getObjc2CategoryList(hi, <span style="color:#f92672">&amp;</span>count);
        <span style="color:#66d9ef">bool</span> hasClassProperties <span style="color:#f92672">=</span> hi<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>info()<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>hasCategoryClassProperties();

        <span style="color:#75715e">// éå† Category
</span><span style="color:#75715e"></span>        <span style="color:#66d9ef">for</span> (i <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>; i <span style="color:#f92672">&lt;</span> count; i<span style="color:#f92672">+</span><span style="color:#f92672">+</span>) {
            <span style="color:#75715e">// è·å–ç¬¬ i ä¸ª Categoryï¼Œç±»å‹ä¸º category_t
</span><span style="color:#75715e"></span>            category_t <span style="color:#f92672">*</span>cat <span style="color:#f92672">=</span> catlist[i];
            <span style="color:#75715e">// æ ¹æ® Category çš„ cls é‡æ–°æ˜ å°„ç±»
</span><span style="color:#75715e"></span>            <span style="color:#66d9ef">Class</span> cls <span style="color:#f92672">=</span> remapClass(cat<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>cls);

            <span style="color:#75715e">// ç±»ä¸ºç©ºæ—¶
</span><span style="color:#75715e"></span>            <span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span>cls) {
                <span style="color:#75715e">// Category&#39;s target class is missing (probably weak-linked).
</span><span style="color:#75715e"></span>                <span style="color:#75715e">// Category çš„ç›®æ ‡ç±»ä¸¢å¤±ï¼ˆå¯èƒ½ä¸ºå¼±é“¾æ¥ï¼‰ã€‚
</span><span style="color:#75715e"></span>                <span style="color:#75715e">// Disavow any knowledge of this category.
</span><span style="color:#75715e"></span>                <span style="color:#75715e">// å¦è®¤å¯¹æ­¤ Category çš„ä»»ä½•äº†è§£ã€‚
</span><span style="color:#75715e"></span>                <span style="color:#75715e">// å°† Category ç½®ä¸º nil
</span><span style="color:#75715e"></span>                catlist[i] <span style="color:#f92672">=</span> nil;
                <span style="color:#66d9ef">if</span> (PrintConnecting) {
                    _objc_inform(<span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">CLASS: IGNORING category </span><span style="color:#e6db74">\</span><span style="color:#e6db74">?</span><span style="color:#e6db74">\</span><span style="color:#e6db74">?</span><span style="color:#e6db74">\</span><span style="color:#e6db74">?(%s) %p with </span><span style="color:#e6db74">&#34;</span>
                                 <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">missing weak-linked target class</span><span style="color:#e6db74">&#34;</span>,
                                 cat<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>name, cat);
                }
                <span style="color:#66d9ef">continue</span>;
            }

            <span style="color:#75715e">// ç±»éç©ºæ—¶
</span><span style="color:#75715e"></span>
            <span style="color:#75715e">// Process this category.
</span><span style="color:#75715e"></span>            <span style="color:#75715e">// First, register the category with its target class.
</span><span style="color:#75715e"></span>            <span style="color:#75715e">// Then, rebuild the class&#39;s method lists (etc) if
</span><span style="color:#75715e"></span>            <span style="color:#75715e">// the class is realized.
</span><span style="color:#75715e"></span>            <span style="color:#75715e">// å¤„ç†è¯¥ Categoryã€‚
</span><span style="color:#75715e"></span>            <span style="color:#75715e">// é¦–å…ˆï¼Œä½¿ç”¨ç›®æ ‡ç±»æ³¨å†Œ Categoryã€‚
</span><span style="color:#75715e"></span>            <span style="color:#75715e">// ç„¶åï¼Œå¦‚æœå®ç°äº†ç±»ï¼Œåˆ™é‡å»ºç±»çš„æ–¹æ³•åˆ—è¡¨ï¼ˆç­‰ï¼‰ã€‚
</span><span style="color:#75715e"></span>            <span style="color:#66d9ef">bool</span> classExists <span style="color:#f92672">=</span> NO;
            <span style="color:#75715e">// åˆ¤æ–­ Category ä¸­å­˜åœ¨å¯¹è±¡æ–¹æ³•ã€åè®®ã€æˆ–å±æ€§
</span><span style="color:#75715e"></span>            <span style="color:#66d9ef">if</span> (cat<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>instanceMethods <span style="color:#f92672">|</span><span style="color:#f92672">|</span>  cat<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>protocols
                <span style="color:#f92672">|</span><span style="color:#f92672">|</span>  cat<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>instanceProperties)
            {
                <span style="color:#75715e">// è®°å½•æœªé™„åŠ ä¸Šçš„ Category
</span><span style="color:#75715e"></span>                addUnattachedCategoryForClass(cat, cls, hi);
                <span style="color:#66d9ef">if</span> (cls<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>isRealized()) {
                    <span style="color:#75715e">// â¡ï¸ å¦‚æœå®ç°äº†ç±»ï¼Œé‡å»ºç±»
</span><span style="color:#75715e"></span>                    remethodizeClass(cls);
                    classExists <span style="color:#f92672">=</span> YES;
                }
                <span style="color:#66d9ef">if</span> (PrintConnecting) {
                    _objc_inform(<span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">CLASS: found category -%s(%s) %s</span><span style="color:#e6db74">&#34;</span>,
                                 cls<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>nameForLogging(), cat<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>name,
                                 classExists <span style="color:#f92672">?</span> <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">on existing class</span><span style="color:#e6db74">&#34;</span> <span style="color:#f92672">:</span> <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">&#34;</span>);
                }
            }

            <span style="color:#75715e">// åˆ¤æ–­ Category ä¸­å­˜åœ¨ç±»æ–¹æ³•ã€åè®®ã€æˆ–ç±»å±æ€§
</span><span style="color:#75715e"></span>            <span style="color:#66d9ef">if</span> (cat<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>classMethods  <span style="color:#f92672">|</span><span style="color:#f92672">|</span>  cat<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>protocols
                <span style="color:#f92672">|</span><span style="color:#f92672">|</span>  (hasClassProperties <span style="color:#f92672">&amp;</span><span style="color:#f92672">&amp;</span> cat<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>_classProperties))
            {
                <span style="color:#75715e">// è®°å½•æœªé™„åŠ ä¸Šçš„ Category
</span><span style="color:#75715e"></span>                addUnattachedCategoryForClass(cat, cls<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>ISA(), hi);
                <span style="color:#66d9ef">if</span> (cls<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>ISA()<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>isRealized()) {
                    <span style="color:#75715e">// â¡ï¸  å¦‚æœå®ç°äº†å…ƒç±»ï¼Œé‡å»ºå…ƒç±»
</span><span style="color:#75715e"></span>                    remethodizeClass(cls<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>ISA());
                }
                <span style="color:#66d9ef">if</span> (PrintConnecting) {
                    _objc_inform(<span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">CLASS: found category +%s(%s)</span><span style="color:#e6db74">&#34;</span>,
                                 cls<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>nameForLogging(), cat<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>name);
                }
            }
        }
    }

    ts.log(<span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">IMAGE TIMES: discover categories</span><span style="color:#e6db74">&#34;</span>);

    <span style="color:#75715e">// Category discovery MUST BE LAST to avoid potential races
</span><span style="color:#75715e"></span>    <span style="color:#75715e">// when other threads call the new category code before
</span><span style="color:#75715e"></span>    <span style="color:#75715e">// this thread finishes its fixups.
</span><span style="color:#75715e"></span>
    <span style="color:#75715e">// +load handled by prepare_load_methods()
</span><span style="color:#75715e"></span>
    <span style="color:#66d9ef">if</span> (DebugNonFragileIvars) {
        realizeAllClasses();
    }


    <span style="color:#75715e">// Print preoptimization statistics
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">if</span> (PrintPreopt) {
        <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">int</span> PreoptTotalMethodLists;
        <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">int</span> PreoptOptimizedMethodLists;
        <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">int</span> PreoptTotalClasses;
        <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">int</span> PreoptOptimizedClasses;

        <span style="color:#66d9ef">for</span> (EACH_HEADER) {
            <span style="color:#66d9ef">if</span> (hi<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>isPreoptimized()) {
                _objc_inform(<span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">PREOPTIMIZATION: honoring preoptimized selectors </span><span style="color:#e6db74">&#34;</span>
                             <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">in %s</span><span style="color:#e6db74">&#34;</span>, hi<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>fname());
            }
            <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> (hi<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>info()<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>optimizedByDyld()) {
                _objc_inform(<span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">PREOPTIMIZATION: IGNORING preoptimized selectors </span><span style="color:#e6db74">&#34;</span>
                             <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">in %s</span><span style="color:#e6db74">&#34;</span>, hi<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>fname());
            }

            classref_t <span style="color:#f92672">*</span>classlist <span style="color:#f92672">=</span> _getObjc2ClassList(hi, <span style="color:#f92672">&amp;</span>count);
            <span style="color:#66d9ef">for</span> (i <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>; i <span style="color:#f92672">&lt;</span> count; i<span style="color:#f92672">+</span><span style="color:#f92672">+</span>) {
                <span style="color:#66d9ef">Class</span> cls <span style="color:#f92672">=</span> remapClass(classlist[i]);
                <span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span>cls) <span style="color:#66d9ef">continue</span>;

                PreoptTotalClasses<span style="color:#f92672">+</span><span style="color:#f92672">+</span>;
                <span style="color:#66d9ef">if</span> (hi<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>isPreoptimized()) {
                    PreoptOptimizedClasses<span style="color:#f92672">+</span><span style="color:#f92672">+</span>;
                }

                <span style="color:#66d9ef">const</span> method_list_t <span style="color:#f92672">*</span>mlist;
                <span style="color:#66d9ef">if</span> ((mlist <span style="color:#f92672">=</span> ((class_ro_t <span style="color:#f92672">*</span>)cls<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>data())<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>baseMethods())) {
                    PreoptTotalMethodLists<span style="color:#f92672">+</span><span style="color:#f92672">+</span>;
                    <span style="color:#66d9ef">if</span> (mlist<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>isFixedUp()) {
                        PreoptOptimizedMethodLists<span style="color:#f92672">+</span><span style="color:#f92672">+</span>;
                    }
                }
                <span style="color:#66d9ef">if</span> ((mlist<span style="color:#f92672">=</span>((class_ro_t <span style="color:#f92672">*</span>)cls<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>ISA()<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>data())<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>baseMethods())) {
                    PreoptTotalMethodLists<span style="color:#f92672">+</span><span style="color:#f92672">+</span>;
                    <span style="color:#66d9ef">if</span> (mlist<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>isFixedUp()) {
                        PreoptOptimizedMethodLists<span style="color:#f92672">+</span><span style="color:#f92672">+</span>;
                    }
                }
            }
        }

        _objc_inform(<span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">PREOPTIMIZATION: %zu selector references not </span><span style="color:#e6db74">&#34;</span>
                     <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">pre-optimized</span><span style="color:#e6db74">&#34;</span>, UnfixedSelectors);
        _objc_inform(<span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">PREOPTIMIZATION: %u/%u (%.3g%%) method lists pre-sorted</span><span style="color:#e6db74">&#34;</span>,
                     PreoptOptimizedMethodLists, PreoptTotalMethodLists,
                     PreoptTotalMethodLists
                     <span style="color:#f92672">?</span> <span style="color:#ae81ff">100.0</span><span style="color:#f92672">*</span>PreoptOptimizedMethodLists<span style="color:#f92672">/</span>PreoptTotalMethodLists
                     : <span style="color:#ae81ff">0.0</span>);
        _objc_inform(<span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">PREOPTIMIZATION: %u/%u (%.3g%%) classes pre-registered</span><span style="color:#e6db74">&#34;</span>,
                     PreoptOptimizedClasses, PreoptTotalClasses,
                     PreoptTotalClasses
                     <span style="color:#f92672">?</span> <span style="color:#ae81ff">100.0</span><span style="color:#f92672">*</span>PreoptOptimizedClasses<span style="color:#f92672">/</span>PreoptTotalClasses
                     : <span style="color:#ae81ff">0.0</span>);
        _objc_inform(<span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">PREOPTIMIZATION: %zu protocol references not </span><span style="color:#e6db74">&#34;</span>
                     <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">pre-optimized</span><span style="color:#e6db74">&#34;</span>, UnfixedProtocolReferences);
    }

<span style="color:#75715e">#</span><span style="color:#75715e">undef EACH_HEADER</span><span style="color:#75715e">
</span><span style="color:#75715e"></span>}

<span style="color:#75715e">// objc-runtime-new.mm
</span><span style="color:#75715e"></span><span style="color:#75715e">/***********************************************************************
</span><span style="color:#75715e">* remethodizeClass
</span><span style="color:#75715e">* Attach outstanding categories to an existing class.
</span><span style="color:#75715e">* å°†æœªå®Œæˆçš„ Category é™„åŠ åˆ°ç°æœ‰ç±»ã€‚
</span><span style="color:#75715e">* Fixes up cls&#39;s method list, protocol list, and property list.
</span><span style="color:#75715e">* ä¿®å¤ cls çš„æ–¹æ³•åˆ—è¡¨ã€åè®®åˆ—è¡¨ã€ä»¥åŠå±æ€§åˆ—è¡¨ã€‚
</span><span style="color:#75715e">* Updates method caches for cls and its subclasses.
</span><span style="color:#75715e">* æ›´æ–° cls ä»¥åŠå…¶å­ç±»çš„æ–¹æ³•ç¼“å­˜ã€‚
</span><span style="color:#75715e">* Locking: runtimeLock must be held by the caller
</span><span style="color:#75715e">* é”ï¼šè°ƒç”¨è€…å¿…é¡»æŒæœ‰ runtimeLock
</span><span style="color:#75715e">**********************************************************************/</span>
<span style="color:#66d9ef">static</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">remethodizeClass</span>(<span style="color:#66d9ef">Class</span> cls)
{
    <span style="color:#75715e">// Category åˆ—è¡¨
</span><span style="color:#75715e"></span>    category_list <span style="color:#f92672">*</span>cats;
    <span style="color:#66d9ef">bool</span> isMeta;

    runtimeLock.assertLocked();

    <span style="color:#75715e">// æ˜¯å¦ä¸ºå…ƒç±»
</span><span style="color:#75715e"></span>    isMeta <span style="color:#f92672">=</span> cls<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>isMetaClass();

    <span style="color:#75715e">// Re-methodizing: check for more categories
</span><span style="color:#75715e"></span>    <span style="color:#75715e">// é‡æ–°æ–¹æ³•åŒ–ï¼šæ£€æŸ¥æ›´å¤šçš„ Category
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">if</span> ((cats <span style="color:#f92672">=</span> unattachedCategoriesForClass(cls, false<span style="color:#75715e">/*not realizing*/</span>))) {
        <span style="color:#66d9ef">if</span> (PrintConnecting) {
            _objc_inform(<span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">CLASS: attaching categories to class &#39;%s&#39; %s</span><span style="color:#e6db74">&#34;</span>,
                         cls<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>nameForLogging(), isMeta <span style="color:#f92672">?</span> <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">(meta)</span><span style="color:#e6db74">&#34;</span> <span style="color:#f92672">:</span> <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">&#34;</span>);
        }

        <span style="color:#75715e">// â¡ï¸ é™„åŠ  Categoryï¼ˆç±»/å…ƒç±»ï¼ŒCategoryï¼Œæ˜¯å¦åˆ·æ–°ç¼“å­˜ï¼‰
</span><span style="color:#75715e"></span>        attachCategories(cls, cats, true <span style="color:#75715e">/*flush caches*/</span>);
        free(cats);
    }
}

<span style="color:#75715e">// objc-runtime-new.mm
</span><span style="color:#75715e"></span><span style="color:#75715e">// Attach method lists and properties and protocols from categories to a class.
</span><span style="color:#75715e"></span><span style="color:#75715e">// å°†æ‰€æœ‰ Category çš„æ–¹æ³•åˆ—è¡¨ã€å±æ€§åˆ—è¡¨ã€åè®®åˆ—è¡¨é™„åŠ åˆ°ç±»ä¸Šã€‚
</span><span style="color:#75715e"></span><span style="color:#75715e">// Assumes the categories in cats are all loaded and sorted by load order,
</span><span style="color:#75715e"></span><span style="color:#75715e">// oldest categories first.
</span><span style="color:#75715e"></span><span style="color:#75715e">// å‡è®¾ cats ä¸­çš„ Category éƒ½å·²åŠ è½½å¹¶ç”±åŠ è½½é¡ºåºæ’åºï¼Œåˆ™æœ€åï¼ˆç¼–è¯‘ï¼‰çš„ Category æ’åœ¨æœ€å…ˆã€‚
</span><span style="color:#75715e"></span><span style="color:#66d9ef">static</span> <span style="color:#66d9ef">void</span>
<span style="color:#a6e22e">attachCategories</span>(<span style="color:#66d9ef">Class</span> cls, category_list <span style="color:#f92672">*</span>cats, <span style="color:#66d9ef">bool</span> flush_caches)
{
    <span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span>cats) <span style="color:#66d9ef">return</span>;
    <span style="color:#75715e">// â¡ï¸ Xcode ä¸­ OBJC_PRINT_REPLACED_METHODS ç¯å¢ƒå˜é‡å€¼ä¸º YES æ—¶ï¼Œå°†å¯åœ¨æ§åˆ¶å°æ‰“å°è¯¥ä¿¡æ¯
</span><span style="color:#75715e"></span>    <span style="color:#75715e">// OPTION(PrintReplacedMethods, OBJC_PRINT_REPLACED_METHODS, &#34;log methods replaced by category implementations&#34;)
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">if</span> (PrintReplacedMethods) printReplacements(cls, cats);

    <span style="color:#75715e">// æ˜¯å¦æ˜¯å…ƒç±»
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">bool</span> isMeta <span style="color:#f92672">=</span> cls<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>isMetaClass();

    <span style="color:#75715e">// fixme rearrange to remove these intermediate allocations
</span><span style="color:#75715e"></span>    <span style="color:#75715e">// æ–¹æ³•åˆ—è¡¨ï¼ˆæŒ‡å‘æŒ‡é’ˆçš„æŒ‡é’ˆï¼Œå­˜å‚¨äº†ä¸¤ç»´ï¼šeg. [[cat_1-&gt;method_a, cat_1-&gt;method_b], [cat_2-&gt;method_c, cat_2-&gt;method_d]]ï¼‰
</span><span style="color:#75715e"></span>    method_list_t <span style="color:#f92672">*</span><span style="color:#f92672">*</span>mlists <span style="color:#f92672">=</span> (method_list_t <span style="color:#f92672">*</span><span style="color:#f92672">*</span>)
        malloc(cats<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>count <span style="color:#f92672">*</span> <span style="color:#66d9ef">sizeof</span>(<span style="color:#f92672">*</span>mlists));
    <span style="color:#75715e">// å±æ€§åˆ—è¡¨
</span><span style="color:#75715e"></span>    property_list_t <span style="color:#f92672">*</span><span style="color:#f92672">*</span>proplists <span style="color:#f92672">=</span> (property_list_t <span style="color:#f92672">*</span><span style="color:#f92672">*</span>)
        malloc(cats<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>count <span style="color:#f92672">*</span> <span style="color:#66d9ef">sizeof</span>(<span style="color:#f92672">*</span>proplists));
    <span style="color:#75715e">// åè®®åˆ—è¡¨
</span><span style="color:#75715e"></span>    protocol_list_t <span style="color:#f92672">*</span><span style="color:#f92672">*</span>protolists <span style="color:#f92672">=</span> (protocol_list_t <span style="color:#f92672">*</span><span style="color:#f92672">*</span>)
        malloc(cats<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>count <span style="color:#f92672">*</span> <span style="color:#66d9ef">sizeof</span>(<span style="color:#f92672">*</span>protolists));

    <span style="color:#75715e">// Count backwards through cats to get newest categories first
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">int</span> mcount <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
    <span style="color:#66d9ef">int</span> propcount <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
    <span style="color:#66d9ef">int</span> protocount <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
    <span style="color:#75715e">// i = Category çš„ä¸ªæ•°
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">int</span> i <span style="color:#f92672">=</span> cats<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>count;
    <span style="color:#66d9ef">bool</span> fromBundle <span style="color:#f92672">=</span> NO;
    <span style="color:#75715e">// â¡ï¸ å°†æ‰€æœ‰ Category ä¸­çš„æ–¹æ³•ã€å±æ€§ã€åè®®æå–å‡º
</span><span style="color:#75715e"></span>    <span style="color:#75715e">// å€’æ•° i
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">while</span> (i<span style="color:#f92672">-</span><span style="color:#f92672">-</span>) {
        <span style="color:#75715e">// entry = ä¸€ä¸ª Category
</span><span style="color:#75715e"></span>        <span style="color:#66d9ef">auto</span><span style="color:#f92672">&amp;</span> entry <span style="color:#f92672">=</span> cats<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>list[i];

        <span style="color:#75715e">// mlist = Category ä¸­çš„æ–¹æ³•åˆ—è¡¨
</span><span style="color:#75715e"></span>        method_list_t <span style="color:#f92672">*</span>mlist <span style="color:#f92672">=</span> entry.cat<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>methodsForMeta(isMeta);
        <span style="color:#66d9ef">if</span> (mlist) {
            mlists[mcount<span style="color:#f92672">+</span><span style="color:#f92672">+</span>] <span style="color:#f92672">=</span> mlist;
            fromBundle <span style="color:#f92672">|</span><span style="color:#f92672">=</span> entry.hi<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>isBundle();
        }

        <span style="color:#75715e">// proplist = Category ä¸­çš„å±æ€§åˆ—è¡¨
</span><span style="color:#75715e"></span>        property_list_t <span style="color:#f92672">*</span>proplist <span style="color:#f92672">=</span>
            entry.cat<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>propertiesForMeta(isMeta, entry.hi);
        <span style="color:#66d9ef">if</span> (proplist) {
            proplists[propcount<span style="color:#f92672">+</span><span style="color:#f92672">+</span>] <span style="color:#f92672">=</span> proplist;
        }

        <span style="color:#75715e">// protolist = Category ä¸­çš„åè®®åˆ—è¡¨
</span><span style="color:#75715e"></span>        protocol_list_t <span style="color:#f92672">*</span>protolist <span style="color:#f92672">=</span> entry.cat<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>protocols;
        <span style="color:#66d9ef">if</span> (protolist) {
            protolists[protocount<span style="color:#f92672">+</span><span style="color:#f92672">+</span>] <span style="color:#f92672">=</span> protolist;
        }
    }

    <span style="color:#75715e">// rw = ç±»/å…ƒç±»å¯¹è±¡çš„ class_rw_t *data()
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">auto</span> rw <span style="color:#f92672">=</span> cls<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>data();

    prepareMethodLists(cls, mlists, mcount, NO, fromBundle);
    <span style="color:#75715e">// â¡ï¸ Category æ–¹æ³•åˆ—è¡¨ -&gt; ç±»/å…ƒç±»æ–¹æ³•åˆ—è¡¨ï¼Œæ–¹æ³•åˆ—è¡¨æ•°é‡ï¼ˆä¸Šè¿°äºŒç»´ä¸­ç¬¬ä¸€ç»´çš„å¤§å°ï¼‰
</span><span style="color:#75715e"></span>    rw<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>methods.attachLists(mlists, mcount);
    free(mlists);
    <span style="color:#66d9ef">if</span> (flush_caches  <span style="color:#f92672">&amp;</span><span style="color:#f92672">&amp;</span>  mcount <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">0</span>) flushCaches(cls);

    <span style="color:#75715e">// â¡ï¸ Category å±æ€§åˆ—è¡¨ -&gt; ç±»/å…ƒç±»å±æ€§åˆ—è¡¨ï¼Œå±æ€§åˆ—è¡¨æ•°é‡ï¼ˆä¸Šè¿°äºŒç»´ä¸­ç¬¬ä¸€ç»´çš„å¤§å°ï¼‰
</span><span style="color:#75715e"></span>    rw<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>properties.attachLists(proplists, propcount);
    free(proplists);

    <span style="color:#75715e">// â¡ï¸ Category åè®®åˆ—è¡¨ -&gt; ç±»/å…ƒç±»åè®®åˆ—è¡¨ï¼Œåè®®åˆ—è¡¨æ•°é‡ï¼ˆä¸Šè¿°äºŒç»´ä¸­ç¬¬ä¸€ç»´çš„å¤§å°ï¼‰
</span><span style="color:#75715e"></span>    rw<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>protocols.attachLists(protolists, protocount);
    free(protolists);
}

<span style="color:#75715e">// objc-runtime-new.h
</span><span style="color:#75715e"></span><span style="color:#66d9ef">class</span> list_array_tt {
 public:
    <span style="color:#66d9ef">void</span> attachLists(List<span style="color:#f92672">*</span> <span style="color:#66d9ef">const</span> <span style="color:#f92672">*</span> addedLists, uint32_t addedCount) {
        <span style="color:#66d9ef">if</span> (addedCount <span style="color:#f92672">=</span><span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>) <span style="color:#66d9ef">return</span>;

        <span style="color:#66d9ef">if</span> (hasArray()) {
            <span style="color:#75715e">// many lists -&gt; many lists
</span><span style="color:#75715e"></span>            <span style="color:#75715e">// oldCount = åŸæœ‰çš„å¤§å°
</span><span style="color:#75715e"></span>            uint32_t oldCount <span style="color:#f92672">=</span> array()<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>count;
            <span style="color:#75715e">// newCount = åŸæœ‰ + æ–°å¢
</span><span style="color:#75715e"></span>            uint32_t newCount <span style="color:#f92672">=</span> oldCount <span style="color:#f92672">+</span> addedCount;
            <span style="color:#75715e">// realloc é‡æ–°åˆ†é…å†…å­˜ç©ºé—´ï¼ˆæ‰©å®¹ï¼‰
</span><span style="color:#75715e"></span>            setArray((array_t <span style="color:#f92672">*</span>)realloc(array(), array_t<span style="color:#f92672">:</span><span style="color:#f92672">:</span>byteSize(newCount)));
            <span style="color:#75715e">// è®¾ç½®ä¸ºæ–°å¤§å°
</span><span style="color:#75715e"></span>            array()<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>count <span style="color:#f92672">=</span> newCount;
            <span style="color:#75715e">// array()-&gt;lists ä¸ºåŸæœ‰åˆ—è¡¨çš„æŒ‡é’ˆ
</span><span style="color:#75715e"></span>            <span style="color:#75715e">// å°†æŒ‡é’ˆæŒ‡å‘çš„å†…å­˜å†…å®¹å‘ååç§» addedCount
</span><span style="color:#75715e"></span>            <span style="color:#75715e">// void    *memmove(void *__dst, const void *__src, size_t __len);
</span><span style="color:#75715e"></span>            memmove(array()<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>lists <span style="color:#f92672">+</span> addedCount, array()<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>lists,
                    oldCount <span style="color:#f92672">*</span> <span style="color:#66d9ef">sizeof</span>(array()<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>lists[<span style="color:#ae81ff">0</span>]));
            <span style="color:#75715e">// addedLists ä¸ºæ‰€æœ‰ Category ä¸­ç›¸åº”åˆ—è¡¨ï¼ˆå¦‚æ–¹æ³•åˆ—è¡¨ç­‰ï¼‰çš„æŒ‡é’ˆ
</span><span style="color:#75715e"></span>            <span style="color:#75715e">// å°†æŒ‡é’ˆæŒ‡å‘çš„å†…å­˜å†…å®¹æ‹·è´åˆ°åŸæœ‰åˆ—è¡¨çš„æŒ‡é’ˆåœ°å€å¤„
</span><span style="color:#75715e"></span>            <span style="color:#75715e">// void    *memcpy(void *__dst, const void *__src, size_t __n);
</span><span style="color:#75715e"></span>            memcpy(array()<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>lists, addedLists,
                   addedCount <span style="color:#f92672">*</span> <span style="color:#66d9ef">sizeof</span>(array()<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>lists[<span style="color:#ae81ff">0</span>]));
        }
        <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span>list  <span style="color:#f92672">&amp;</span><span style="color:#f92672">&amp;</span>  addedCount <span style="color:#f92672">=</span><span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>) {
            <span style="color:#75715e">// 0 lists -&gt; 1 list
</span><span style="color:#75715e"></span>            list <span style="color:#f92672">=</span> addedLists[<span style="color:#ae81ff">0</span>];
        }
        <span style="color:#66d9ef">else</span> {
            <span style="color:#75715e">// 1 list -&gt; many lists
</span><span style="color:#75715e"></span>            List<span style="color:#f92672">*</span> oldList <span style="color:#f92672">=</span> list;
            uint32_t oldCount <span style="color:#f92672">=</span> oldList <span style="color:#f92672">?</span> <span style="color:#ae81ff">1</span> <span style="color:#f92672">:</span> <span style="color:#ae81ff">0</span>;
            uint32_t newCount <span style="color:#f92672">=</span> oldCount <span style="color:#f92672">+</span> addedCount;
            setArray((array_t <span style="color:#f92672">*</span>)malloc(array_t<span style="color:#f92672">:</span><span style="color:#f92672">:</span>byteSize(newCount)));
            array()<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>count <span style="color:#f92672">=</span> newCount;
            <span style="color:#66d9ef">if</span> (oldList) array()<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>lists[addedCount] <span style="color:#f92672">=</span> oldList;
            memcpy(array()<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>lists, addedLists,
                   addedCount <span style="color:#f92672">*</span> <span style="color:#66d9ef">sizeof</span>(array()<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>lists[<span style="color:#ae81ff">0</span>]));
        }
    }
};
</code></pre></div><p>ä» <code>realloc</code> åˆ° <code>memmove</code> å’Œ <code>memcpy</code> éƒ¨åˆ†å¯ä»¥å‚è€ƒä¸‹å›¾ï¼š</p>
<p><img src="/img/2019/category_in_ios/3.png" alt="3"></p>
<p>å› æ­¤ï¼Œå¯¹äº Category åœ¨è¿è¡Œæ—¶å°†å…¶ä¸­çš„æ–¹æ³•ã€å±æ€§ã€åè®®åŠ è½½åˆ°ä¸»ç±»çš„è¿‡ç¨‹ææ˜ç™½åï¼Œä¹‹å‰çš„ç»“è®ºå°±æ°´è½çŸ³å‡ºã€‚è¶Šé åç¼–è¯‘çš„ Categoryï¼Œå…¶æ–¹æ³•åˆ—è¡¨æœ€ç»ˆå°±è¶Šé å‰ã€‚å› æ­¤åœ¨è°ƒç”¨æ—¶ï¼Œè™½ç„¶ä¸»ç±»å’Œå…¶ä»– Category ä¸­çš„æ–¹æ³•å¹¶æ²¡æœ‰è¢«è¦†ç›–ï¼Œä½†ä¼šå› ä¸ºåœ¨å‰é¢å·²ç»è¢«æ‰¾åˆ°å¹¶è°ƒç”¨è€Œæ— æ³•è°ƒç”¨åˆ°ã€‚ä¹Ÿæ˜¯å› ä¸ºæ–¹æ³•å¹¶æ²¡æœ‰è¢«è¦†ç›–ï¼Œå¦‚æœæˆ‘ä»¬åœ¨ Category ä¸­ä»…å£°æ˜å´ä¸å®ç°ï¼Œè¿è¡Œæ—¶ä»å°†æ‰¾åˆ°ä¸»ç±»ä¸­çš„å®ç°ã€‚ä»ä¸Šé¢æºç åˆ†æä¸­æˆ‘ä»¬ä¹Ÿå¯ä»¥å‘ç°ï¼Œåœ¨ Xcode è®¾ç½® <code>OBJC_PRINT_REPLACED_METHODS</code> ç¯å¢ƒå˜é‡ä¸º <code>YES</code> åï¼Œå°±å¯ä»¥åœ¨è¿è¡Œæ—¶è¾“å‡ºæ‰€æœ‰è¢«æ›¿æ¢çš„æ–¹æ³•ï¼ˆè‹¥æ·»åŠ åä»æœªè¾“å‡ºæˆ‘ä»¬è‡ªå®šä¹‰ç±»çš„æ›¿æ¢ä¿¡æ¯ï¼Œå¯ä»¥åœ¨å°è¯•ä¸»ç±»å’Œæ‰€æœ‰ Category ä¸­æ·»åŠ  <code>+ (void)load</code> æ–¹æ³•å®ç°åé‡è¯•ï¼‰ï¼š</p>
<pre><code>objc[17895]: REPLACED: -[Person smile]  by category Life  (IMP was 0x100001b90 (/Users/kingcos/Library/Developer/Xcode/DerivedData/Category_in_Obj-C-cgesibqaizbvgnckrzeofmpfkmmy/Build/Products/Debug/Category_in_Obj-C), now 0x100001b00 (/Users/kingcos/Library/Developer/Xcode/DerivedData/Category_in_Obj-C-cgesibqaizbvgnckrzeofmpfkmmy/Build/Products/Debug/Category_in_Obj-C))
objc[17895]: REPLACED: -[Person smile]  by category Work  (IMP was 0x100001b00 (/Users/kingcos/Library/Developer/Xcode/DerivedData/Category_in_Obj-C-cgesibqaizbvgnckrzeofmpfkmmy/Build/Products/Debug/Category_in_Obj-C), now 0x100001b40 (/Users/kingcos/Library/Developer/Xcode/DerivedData/Category_in_Obj-C-cgesibqaizbvgnckrzeofmpfkmmy/Build/Products/Debug/Category_in_Obj-C))
</code></pre><p>ç¬¬ä¸€æ¡çš„æ›¿æ¢ï¼Œæ˜¯æŒ‡ Person+Life æ›¿æ¢äº† Person ä¸­çš„ <code>smile</code> æ–¹æ³•ï¼Œè€Œç¬¬äºŒæ¡æŒ‡ Person+Work å†æ¬¡æ›¿æ¢äº† Person+Life ä¸­çš„ <code>smile</code> æ–¹æ³•ï¼Œå› æ­¤æœ€ç»ˆä¹Ÿç”± Person+Work ä¸­çš„æ–¹æ³•è¢«è°ƒç”¨ï¼Œæœ€ç»ˆä¹Ÿä¸æˆ‘ä»¬çš„ç»“è®ºä¸€è‡´ã€‚</p>
<h3 id="memmove--memcpy"><code>memmove</code> &amp; <code>memcpy</code></h3>
<p>ä¸Šä¸€èŠ‚ä¸­ï¼ŒCategory ä¸­å†…å®¹åˆ—è¡¨ä¸ä¸»ç±»èåˆæ—¶ï¼Œè°ƒç”¨äº† <code>memmove</code> å’Œ <code>memcpy</code> å‡½æ•°ï¼Œå®ƒä»¬å…¶å®æ˜¯ C è¯­è¨€æ ‡å‡†åº“ä¸­çš„å‡½æ•°ï¼Œç›®çš„éƒ½æ˜¯å°†ä¸€å®šé•¿åº¦çš„æºå†…å­˜åœ°å€çš„å†…å®¹æ‹·è´åˆ°ç›®æ ‡å†…å­˜åœ°å€ä¸­ã€‚åœ¨ Apple å¼€æºçš„ XNU - libsyscall ä¸­ï¼Œ<code>memmove</code> å’Œ <code>memcpy</code> æœ¬è´¨å…¶å®æ˜¯ä¸€è‡´çš„ï¼š</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c"><span style="color:#75715e">// _libc_funcptr.c
</span><span style="color:#75715e"></span>__attribute__((visibility(<span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">hidden</span><span style="color:#e6db74">&#34;</span>)))
<span style="color:#66d9ef">void</span> <span style="color:#f92672">*</span>
memmove(<span style="color:#66d9ef">void</span> <span style="color:#f92672">*</span>dst, <span style="color:#66d9ef">const</span> <span style="color:#66d9ef">void</span> <span style="color:#f92672">*</span>src, size_t n)
{
	<span style="color:#66d9ef">return</span> _libkernel_string_functions<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>memmove(dst, src, n);
}

__attribute__((visibility(<span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">hidden</span><span style="color:#e6db74">&#34;</span>)))
<span style="color:#66d9ef">void</span> <span style="color:#f92672">*</span>
memcpy(<span style="color:#66d9ef">void</span> <span style="color:#f92672">*</span>dst, <span style="color:#66d9ef">const</span> <span style="color:#66d9ef">void</span> <span style="color:#f92672">*</span>src, size_t n)
{
	<span style="color:#66d9ef">return</span> _libkernel_string_functions<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>memmove(dst, src, n);
}

<span style="color:#75715e">// _libc_funcptr.c
</span><span style="color:#75715e"></span><span style="color:#75715e">/*
</span><span style="color:#75715e"> * Upcalls to optimized libplatform string functions
</span><span style="color:#75715e"> */</span>

<span style="color:#66d9ef">static</span> <span style="color:#66d9ef">const</span> <span style="color:#66d9ef">struct</span> _libkernel_string_functions
		_libkernel_generic_string_functions <span style="color:#f92672">=</span> {
	.bzero <span style="color:#f92672">=</span> _libkernel_bzero,
	.memmove <span style="color:#f92672">=</span> _libkernel_memmove,
	.memset <span style="color:#f92672">=</span> _libkernel_memset,
	.strchr <span style="color:#f92672">=</span> _libkernel_strchr,
	.strcmp <span style="color:#f92672">=</span> _libkernel_strcmp,
	.strcpy <span style="color:#f92672">=</span> _libkernel_strcpy,
	.strlcpy <span style="color:#f92672">=</span> _libkernel_strlcpy,
	.strlen <span style="color:#f92672">=</span> _libkernel_strlen,
};
<span style="color:#66d9ef">static</span> _libkernel_string_functions_t _libkernel_string_functions <span style="color:#f92672">=</span>
		<span style="color:#f92672">&amp;</span>_libkernel_generic_string_functions;

<span style="color:#75715e">// memcpy.c
</span><span style="color:#75715e"></span><span style="color:#75715e">/*
</span><span style="color:#75715e"> * sizeof(word) MUST BE A POWER OF TWO
</span><span style="color:#75715e"> * SO THAT wmask BELOW IS ALL ONES
</span><span style="color:#75715e"> */</span>
<span style="color:#66d9ef">typedef</span>    <span style="color:#66d9ef">int</span> word;        <span style="color:#75715e">/* &#34;word&#34; used for optimal copy speed &#34;å­—&#34;ç”¨ä½œä¼˜åŒ–æ‹·è´é€Ÿåº¦ */</span>

<span style="color:#75715e">#</span><span style="color:#75715e">define    wsize    sizeof(word)</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">#</span><span style="color:#75715e">define    wmask    (wsize - 1)</span><span style="color:#75715e">
</span><span style="color:#75715e"></span>
<span style="color:#75715e">/*
</span><span style="color:#75715e"> * Copy a block of memory, handling overlap.
</span><span style="color:#75715e"> * æ‹·è´ä¸€å—å†…å­˜ï¼Œå¹¶å¤„ç†é‡å éƒ¨åˆ†ã€‚
</span><span style="color:#75715e"> * This is the routine that actually implements
</span><span style="color:#75715e"> * (the portable versions of) bcopy, memcpy, and memmove.
</span><span style="color:#75715e"> * è¿™æ˜¯ä¸ªå®é™…å®ç°äº†ï¼ˆå¯ç§»æ¤ç‰ˆæœ¬çš„ï¼‰bcopyã€memcpyã€ä»¥åŠ memmove çš„ä¾‹è¡Œç¨‹åºã€‚
</span><span style="color:#75715e"> */</span>

<span style="color:#75715e">// visibility(&#34;hidden&#34;)ï¼šéšè—å‡½æ•°ç¬¦å·
</span><span style="color:#75715e"></span>__attribute__((visibility(<span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">hidden</span><span style="color:#e6db74">&#34;</span>)))
<span style="color:#66d9ef">void</span> <span style="color:#f92672">*</span> _libkernel_memmove(<span style="color:#66d9ef">void</span> <span style="color:#f92672">*</span>dst0, <span style="color:#66d9ef">const</span> <span style="color:#66d9ef">void</span> <span style="color:#f92672">*</span>src0, size_t length)
{
    <span style="color:#75715e">// ä¿å­˜ä¸€ä»½ç›®æ ‡ã€æºï¼Œä½†æºæ˜¯å¸¸é‡ï¼Œè€Œç›®æ ‡æ˜¯å¯å˜çš„
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>dst <span style="color:#f92672">=</span> dst0;
    <span style="color:#66d9ef">const</span> <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>src <span style="color:#f92672">=</span> src0;
    size_t t;

    <span style="color:#75715e">// é•¿åº¦ä¸º 0 æˆ–ç›®æ ‡ç­‰äºæºæ—¶ï¼Œæ— éœ€ç§»åŠ¨
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">if</span> (length <span style="color:#f92672">=</span><span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span> <span style="color:#f92672">|</span><span style="color:#f92672">|</span> dst <span style="color:#f92672">=</span><span style="color:#f92672">=</span> src)        <span style="color:#75715e">/* nothing to do */</span>
        <span style="color:#66d9ef">goto</span> done;

    <span style="color:#75715e">/*
</span><span style="color:#75715e">     * Macros: loop-t-times; and loop-t-times, t&gt;0
</span><span style="color:#75715e">     * å®šä¹‰å¾ªç¯å®ï¼Œt å¤§äº 0 æ—¶ï¼Œå¾ªç¯ t æ¬¡
</span><span style="color:#75715e">     */</span>
<span style="color:#75715e">#</span><span style="color:#75715e">define    TLOOP(s) if (t) TLOOP1(s)</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">#</span><span style="color:#75715e">define    TLOOP1(s) do { s; } while (--t)</span><span style="color:#75715e">
</span><span style="color:#75715e"></span>
    <span style="color:#75715e">// å¦‚æœæº &gt; ç›®æ ‡ï¼ˆé«˜åœ°å€ -&gt; ä½åœ°å€ï¼Œå°ç«¯å°±æ˜¯å‘å‰ï¼‰
</span><span style="color:#75715e"></span>    printf(<span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">(unsigned long)dst: %lu; (unsigned long)src: %lu</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>, (<span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">long</span>)dst, (<span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">long</span>)src);
    <span style="color:#66d9ef">if</span> ((<span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">long</span>)dst <span style="color:#f92672">&lt;</span> (<span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">long</span>)src) {
        <span style="color:#75715e">/*
</span><span style="color:#75715e">         * Copy forward.
</span><span style="color:#75715e">         * æ­£å‘æ‹·è´ã€‚
</span><span style="color:#75715e">         */</span>
        <span style="color:#75715e">// typedef unsigned long           uintptr_t;
</span><span style="color:#75715e"></span>        t <span style="color:#f92672">=</span> (uintptr_t)src;    <span style="color:#75715e">/* only need low bits åªéœ€è¦ä½ä½ */</span>
        printf(<span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">(t | (uintptr_t)dst) &amp; wmask: %lu</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>, (t <span style="color:#f92672">|</span> (uintptr_t)dst) <span style="color:#f92672">&amp;</span> wmask);
        <span style="color:#66d9ef">if</span> ((t <span style="color:#f92672">|</span> (uintptr_t)dst) <span style="color:#f92672">&amp;</span> wmask) {
            <span style="color:#75715e">/*
</span><span style="color:#75715e">             * Try to align operands.  This cannot be done
</span><span style="color:#75715e">             * unless the low bits match.
</span><span style="color:#75715e">             * å°è¯•å¯¹é½æ“ä½œæ•°ã€‚é™¤éä½ä½åŒ¹é…ï¼Œå¦åˆ™ä¸å¯è¿™æ ·åšã€‚
</span><span style="color:#75715e">             */</span>
            <span style="color:#66d9ef">if</span> ((t <span style="color:#f92672">^</span> (uintptr_t)dst) <span style="color:#f92672">&amp;</span> wmask <span style="color:#f92672">|</span><span style="color:#f92672">|</span> length <span style="color:#f92672">&lt;</span> wsize)
                t <span style="color:#f92672">=</span> length;
            <span style="color:#66d9ef">else</span>
                t <span style="color:#f92672">=</span> wsize <span style="color:#f92672">-</span> (t <span style="color:#f92672">&amp;</span> wmask);
            length <span style="color:#f92672">-</span><span style="color:#f92672">=</span> t;
            <span style="color:#75715e">//
</span><span style="color:#75715e"></span><span style="color:#75715e">//            TLOOP1(*dst++ = *src++);
</span><span style="color:#75715e"></span>            <span style="color:#66d9ef">do</span> {
                <span style="color:#f92672">*</span>dst<span style="color:#f92672">+</span><span style="color:#f92672">+</span> <span style="color:#f92672">=</span> <span style="color:#f92672">*</span>src<span style="color:#f92672">+</span><span style="color:#f92672">+</span>;
            } <span style="color:#66d9ef">while</span> (<span style="color:#f92672">-</span><span style="color:#f92672">-</span>t);
        }
        <span style="color:#75715e">/*
</span><span style="color:#75715e">         * Copy whole words, then mop up any trailing bytes.
</span><span style="color:#75715e">         * æ‹·è´æ•´ä¸ªå­—ï¼Œç„¶ååˆ é™¤æ‰€æœ‰å°¾å­—èŠ‚ã€‚
</span><span style="color:#75715e">         */</span>
        t <span style="color:#f92672">=</span> length <span style="color:#f92672">/</span> wsize;
        printf(<span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">t: %zu</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>, t);
<span style="color:#75715e">//        TLOOP(*(word *)dst = *(word *)src; src += wsize; dst += wsize);
</span><span style="color:#75715e"></span>        <span style="color:#66d9ef">if</span> (t) {
            <span style="color:#66d9ef">do</span> {
                <span style="color:#75715e">// æ›´æ”¹æŒ‡é’ˆæŒ‡å‘çš„ä¸€ä¸ªå­—é•¿çš„å†…å®¹ï¼ˆsrc -&gt; dstï¼‰
</span><span style="color:#75715e"></span>                <span style="color:#f92672">*</span>(word <span style="color:#f92672">*</span>)dst <span style="color:#f92672">=</span> <span style="color:#f92672">*</span>(word <span style="color:#f92672">*</span>)src;
                <span style="color:#75715e">// dst &amp; src å‘å‰ç§»åŠ¨ä¸€ä¸ªå­—é•¿
</span><span style="color:#75715e"></span>                src <span style="color:#f92672">+</span><span style="color:#f92672">=</span> wsize;
                dst <span style="color:#f92672">+</span><span style="color:#f92672">=</span> wsize;
            } <span style="color:#66d9ef">while</span> (<span style="color:#f92672">-</span><span style="color:#f92672">-</span>t);
        }
        printf(<span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">(unsigned long)dst: %lu; (unsigned long)src: %lu</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>, (<span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">long</span>)dst, (<span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">long</span>)src);

        t <span style="color:#f92672">=</span> length <span style="color:#f92672">&amp;</span> wmask;
        printf(<span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">t: %zu</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>, t);
<span style="color:#75715e">//        TLOOP(*dst++ = *src++);
</span><span style="color:#75715e"></span>        <span style="color:#66d9ef">if</span> (t) {
            <span style="color:#66d9ef">do</span> {
                <span style="color:#f92672">*</span>dst<span style="color:#f92672">+</span><span style="color:#f92672">+</span> <span style="color:#f92672">=</span> <span style="color:#f92672">*</span>src<span style="color:#f92672">+</span><span style="color:#f92672">+</span>;
            } <span style="color:#66d9ef">while</span> (<span style="color:#f92672">-</span><span style="color:#f92672">-</span>t);
        }
    } <span style="color:#66d9ef">else</span> {
        <span style="color:#75715e">/*
</span><span style="color:#75715e">         * Copy backwards.  Otherwise essentially the same.
</span><span style="color:#75715e">         * Alignment works as before, except that it takes
</span><span style="color:#75715e">         * (t&amp;wmask) bytes to align, not wsize-(t&amp;wmask).
</span><span style="color:#75715e">         * åå‘æ‹·è´ã€‚å¦åˆ™åŸºæœ¬ä¸€è‡´ã€‚
</span><span style="color:#75715e">         * ä¸ä¹‹å‰ä¸€æ ·å¯¹é½ï¼Œé™¤äº†å®ƒæ˜¯ä»¥ (t&amp;wmask) å­—èŠ‚å¯¹é½ï¼Œè€Œé wsize-(t&amp;wmask)ã€‚
</span><span style="color:#75715e">         */</span>
        src <span style="color:#f92672">+</span><span style="color:#f92672">=</span> length;
        dst <span style="color:#f92672">+</span><span style="color:#f92672">=</span> length;
        t <span style="color:#f92672">=</span> (uintptr_t)src;
        printf(<span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">(t | (uintptr_t)dst) &amp; wmask: %lu</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>, (t <span style="color:#f92672">|</span> (uintptr_t)dst) <span style="color:#f92672">&amp;</span> wmask);
        <span style="color:#66d9ef">if</span> ((t <span style="color:#f92672">|</span> (uintptr_t)dst) <span style="color:#f92672">&amp;</span> wmask) {
            <span style="color:#66d9ef">if</span> ((t <span style="color:#f92672">^</span> (uintptr_t)dst) <span style="color:#f92672">&amp;</span> wmask <span style="color:#f92672">|</span><span style="color:#f92672">|</span> length <span style="color:#f92672">&lt;</span><span style="color:#f92672">=</span> wsize)
                t <span style="color:#f92672">=</span> length;
            <span style="color:#66d9ef">else</span>
                t <span style="color:#f92672">&amp;</span><span style="color:#f92672">=</span> wmask;
            length <span style="color:#f92672">-</span><span style="color:#f92672">=</span> t;
<span style="color:#75715e">//            TLOOP1(*--dst = *--src);
</span><span style="color:#75715e"></span>            <span style="color:#66d9ef">do</span> {
                <span style="color:#f92672">*</span><span style="color:#f92672">-</span><span style="color:#f92672">-</span>dst <span style="color:#f92672">=</span> <span style="color:#f92672">*</span><span style="color:#f92672">-</span><span style="color:#f92672">-</span>src;
            } <span style="color:#66d9ef">while</span> (<span style="color:#f92672">-</span><span style="color:#f92672">-</span>t);
        }
        t <span style="color:#f92672">=</span> length <span style="color:#f92672">/</span> wsize;
<span style="color:#75715e">//        TLOOP(src -= wsize; dst -= wsize; *(word *)dst = *(word *)src);
</span><span style="color:#75715e"></span>        <span style="color:#66d9ef">if</span> (t) {
            <span style="color:#66d9ef">do</span> {
                src <span style="color:#f92672">-</span><span style="color:#f92672">=</span> wsize;
                dst <span style="color:#f92672">-</span><span style="color:#f92672">=</span> wsize;
                <span style="color:#f92672">*</span>(word <span style="color:#f92672">*</span>)dst <span style="color:#f92672">=</span> <span style="color:#f92672">*</span>(word <span style="color:#f92672">*</span>)src;
            } <span style="color:#66d9ef">while</span> (<span style="color:#f92672">-</span><span style="color:#f92672">-</span>t);
        }

        t <span style="color:#f92672">=</span> length <span style="color:#f92672">&amp;</span> wmask;
<span style="color:#75715e">//        TLOOP(*--dst = *--src);
</span><span style="color:#75715e"></span>        <span style="color:#66d9ef">if</span> (t) {
            <span style="color:#66d9ef">do</span> {
                <span style="color:#f92672">*</span><span style="color:#f92672">-</span><span style="color:#f92672">-</span>dst <span style="color:#f92672">=</span> <span style="color:#f92672">*</span><span style="color:#f92672">-</span><span style="color:#f92672">-</span>src;
            } <span style="color:#66d9ef">while</span> (<span style="color:#f92672">-</span><span style="color:#f92672">-</span>t);
        }
    }
done:
    printf(<span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">(unsigned long)dst: %lu; (unsigned long)src: %lu</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>, (<span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">long</span>)dst, (<span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">long</span>)src);
    <span style="color:#66d9ef">return</span> (dst0);
}
</code></pre></div><p>æˆ‘å·²ç»å°†è¯¥å‡½æ•°ç§»æ¤åˆ° Demo ä¸­ï¼Œå¯ä»¥å°è¯•ä½åœ°å€æ‹·è´åˆ°é«˜åœ°å€ï¼Œä¹Ÿå¯ä»¥å°†é«˜åœ°å€æ‹·è´åˆ°ä½åœ°å€ï¼š</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-objectivec" data-lang="objectivec"><span style="color:#75715e">// b -&gt; a
</span><span style="color:#75715e"></span><span style="color:#66d9ef">int</span> a <span style="color:#f92672">=</span> <span style="color:#ae81ff">10</span>;
<span style="color:#66d9ef">int</span> b <span style="color:#f92672">=</span> <span style="color:#ae81ff">20</span>;
NSLog(<span style="color:#e6db74">@&#34;</span><span style="color:#e6db74">Before: a: %d, b: %d</span><span style="color:#e6db74">&#34;</span>, a, b);
_libkernel_memmove(<span style="color:#f92672">&amp;</span>a, <span style="color:#f92672">&amp;</span>b, <span style="color:#66d9ef">sizeof</span>(<span style="color:#66d9ef">int</span>));
<span style="color:#75715e">// memmove(&amp;a, &amp;b, sizeof(int));
</span><span style="color:#75715e"></span><span style="color:#75715e">// memcpy(&amp;a, &amp;b, sizeof(int));
</span><span style="color:#75715e"></span>NSLog(<span style="color:#e6db74">@&#34;</span><span style="color:#e6db74">After: a: %d, b: %d</span><span style="color:#e6db74">&#34;</span>, a, b);

<span style="color:#75715e">// OUTPUT:
</span><span style="color:#75715e"></span><span style="color:#75715e">// Before: a: 10, b: 20
</span><span style="color:#75715e"></span><span style="color:#75715e">// After: a: 20, b: 20
</span><span style="color:#75715e"></span>
<span style="color:#75715e">// c -&gt; d
</span><span style="color:#75715e"></span><span style="color:#66d9ef">int</span> c <span style="color:#f92672">=</span> <span style="color:#ae81ff">30</span>;
<span style="color:#66d9ef">int</span> d <span style="color:#f92672">=</span> <span style="color:#ae81ff">40</span>;
NSLog(<span style="color:#e6db74">@&#34;</span><span style="color:#e6db74">Before: c: %d, d: %d</span><span style="color:#e6db74">&#34;</span>, c, d);
<span style="color:#75715e">// _libkernel_memmove2 æ˜¯ä¸ªç®€åŒ–ç‰ˆæœ¬çš„ _libkernel_memmove
</span><span style="color:#75715e"></span>_libkernel_memmove2(<span style="color:#f92672">&amp;</span>d, <span style="color:#f92672">&amp;</span>c, <span style="color:#66d9ef">sizeof</span>(<span style="color:#66d9ef">int</span>));
NSLog(<span style="color:#e6db74">@&#34;</span><span style="color:#e6db74">After: c: %d, d: %d</span><span style="color:#e6db74">&#34;</span>, c, d);

<span style="color:#75715e">// OUTPUT:
</span><span style="color:#75715e"></span><span style="color:#75715e">// Before: c: 30, d: 40
</span><span style="color:#75715e"></span><span style="color:#75715e">// After: c: 30, d: 30
</span></code></pre></div><p>ä½†åœ¨æœ‰äº›ç¼–è¯‘å™¨ä¸­ï¼Œç”±äºä¸åŒçš„æ ‡å‡†åº“å…·ä½“å®ç°å¯èƒ½ä¼šæœ‰æ‰€ä¸åŒã€‚å…¶ä¸­æœ€ä¸»è¦çš„å·®åˆ«ä¾¿æ˜¯ <code>memcpy</code> çš„å®ç°é€šå¸¸å¹¶éä¸€å®šæ˜¯å®‰å…¨çš„ï¼Œå½“æºå†…å­˜å’Œç›®æ ‡å†…å­˜å­˜åœ¨é‡å æ—¶ï¼Œ<code>memcpy</code> å°†å‘ç”Ÿé”™è¯¯ï¼š</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c"><span style="color:#75715e">#</span><span style="color:#75715e">include</span> <span style="color:#75715e">&lt;stddef.h&gt; /* size_t */</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#66d9ef">void</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">c_memcpy</span>(<span style="color:#66d9ef">void</span> <span style="color:#f92672">*</span>dest, <span style="color:#66d9ef">const</span> <span style="color:#66d9ef">void</span> <span style="color:#f92672">*</span>src, size_t n)
{
    <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>dp <span style="color:#f92672">=</span> dest;
    <span style="color:#66d9ef">const</span> <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>sp <span style="color:#f92672">=</span> src;
    <span style="color:#66d9ef">while</span> (n<span style="color:#f92672">-</span><span style="color:#f92672">-</span>)
        <span style="color:#f92672">*</span>dp<span style="color:#f92672">+</span><span style="color:#f92672">+</span> <span style="color:#f92672">=</span> <span style="color:#f92672">*</span>sp<span style="color:#f92672">+</span><span style="color:#f92672">+</span>;
    <span style="color:#66d9ef">return</span> dest;
}
</code></pre></div><p>ä¸Šé¢æ˜¯ C99 æ ‡å‡†åº“ä¸­çš„å®ç°ã€‚ä¸‹é¢å°è¯•ä¸‹ï¼Œå°†ä¸€ä¸ªæ•°ç»„çš„å‰åŠæˆªæ‹·è´åˆ°å…¶ä¸­é—´çš„åœ°å€ï¼Œè¿™æ ·æºåœ°å€ä¸ç›®æ ‡åœ°å€å°±å‡ºç°äº†é‡å éƒ¨åˆ†ã€‚éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œå¼€å‘è€…è¦ä¿è¯å†…å­˜æ˜¯å·²ç»åˆ†é…å¥½çš„ï¼Œå¦‚æœç›®æ ‡åœ°å€æ— æ³•å®¹çº³è¶³å¤Ÿé•¿çš„æºåœ°å€å†…å®¹é•¿åº¦ï¼Œåˆ™ä»å°†æº¢å‡ºï¼Œå‘ç”Ÿå´©æºƒã€‚</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-objectivec" data-lang="objectivec"><span style="color:#75715e">// e[0, 1] -&gt; e[1, 2]
</span><span style="color:#75715e"></span><span style="color:#66d9ef">int</span> e[<span style="color:#ae81ff">5</span>] <span style="color:#f92672">=</span> {<span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">2</span>, <span style="color:#ae81ff">3</span>};
NSLog(<span style="color:#e6db74">@&#34;</span><span style="color:#e6db74">Before: e[0]: %d, e[1]: %d, e[2]: %d, e[3]: %d, e[4]: %d</span><span style="color:#e6db74">&#34;</span>, e[<span style="color:#ae81ff">0</span>], e[<span style="color:#ae81ff">1</span>], e[<span style="color:#ae81ff">2</span>], e[<span style="color:#ae81ff">3</span>], e[<span style="color:#ae81ff">4</span>]);
_libkernel_memmove3(<span style="color:#f92672">&amp;</span>e[<span style="color:#ae81ff">2</span>], <span style="color:#f92672">&amp;</span>e[<span style="color:#ae81ff">0</span>], <span style="color:#66d9ef">sizeof</span>(<span style="color:#66d9ef">int</span>) <span style="color:#f92672">*</span> <span style="color:#ae81ff">3</span>);
NSLog(<span style="color:#e6db74">@&#34;</span><span style="color:#e6db74">After: e[0]: %d, e[1]: %d, e[2]: %d, e[3]: %d, e[4]: %d</span><span style="color:#e6db74">&#34;</span>, e[<span style="color:#ae81ff">0</span>], e[<span style="color:#ae81ff">1</span>], e[<span style="color:#ae81ff">2</span>], e[<span style="color:#ae81ff">3</span>], e[<span style="color:#ae81ff">4</span>]);

<span style="color:#f92672">/</span> OUTPUT:
<span style="color:#75715e">// Before: e[0]: 1, e[1]: 2, e[2]: 3, e[3]: 0, e[4]: 0
</span><span style="color:#75715e"></span><span style="color:#75715e">// After: e[0]: 1, e[1]: 2, e[2]: 1, e[3]: 2, e[4]: 3
</span><span style="color:#75715e"></span>
<span style="color:#75715e">// f[0, 1] -&gt; f[1, 2]
</span><span style="color:#75715e"></span><span style="color:#66d9ef">int</span> f[<span style="color:#ae81ff">5</span>] <span style="color:#f92672">=</span> {<span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">2</span>, <span style="color:#ae81ff">3</span>};
NSLog(<span style="color:#e6db74">@&#34;</span><span style="color:#e6db74">Before: f[0]: %d, f[1]: %d, f[2]: %d, f[3]: %d, f[4]: %d</span><span style="color:#e6db74">&#34;</span>, f[<span style="color:#ae81ff">0</span>], f[<span style="color:#ae81ff">1</span>], f[<span style="color:#ae81ff">2</span>], f[<span style="color:#ae81ff">3</span>], f[<span style="color:#ae81ff">4</span>]);
v_memcpy(<span style="color:#f92672">&amp;</span>f[<span style="color:#ae81ff">2</span>], <span style="color:#f92672">&amp;</span>f[<span style="color:#ae81ff">0</span>], <span style="color:#66d9ef">sizeof</span>(<span style="color:#66d9ef">int</span>) <span style="color:#f92672">*</span> <span style="color:#ae81ff">3</span>);
NSLog(<span style="color:#e6db74">@&#34;</span><span style="color:#e6db74">After: f[0]: %d, f[1]: %d, f[2]: %d, f[3]: %d, f[4]: %d</span><span style="color:#e6db74">&#34;</span>, f[<span style="color:#ae81ff">0</span>], f[<span style="color:#ae81ff">1</span>], f[<span style="color:#ae81ff">2</span>], f[<span style="color:#ae81ff">3</span>], f[<span style="color:#ae81ff">4</span>]);

<span style="color:#75715e">// OUTPUT:
</span><span style="color:#75715e"></span><span style="color:#75715e">// Before: f[0]: 1, f[1]: 2, f[2]: 3, f[3]: 0, f[4]: 0
</span><span style="color:#75715e"></span><span style="color:#75715e">// After: f[0]: 1, f[1]: 2, f[2]: 1, f[3]: 2, f[4]: 1
</span></code></pre></div><p>ç»“æœå¾ˆæ˜æ˜¾ï¼Œ<code>c_memcpy</code>ï¼ˆC99 æ ‡å‡†åº“å®ç°çš„ <code>memcpy</code>ï¼‰åœ¨é‡å éƒ¨åˆ†å‡ºç°äº†å·®é”™ï¼Œè€Œ <code>memmove</code> å´èƒ½å¤Ÿæ­£ç¡®çš„å¤„ç†ã€‚è¿™æ˜¯å› ä¸ºåœ¨ <code>memmove</code> å†…éƒ¨ä¼šåˆ¤æ–­æºåœ°å€å’Œç›®æ ‡åœ°å€çš„å¤§å°ï¼Œè¿›è€Œè¿›è¡Œæ­£å‘æˆ–åå‘æ‹·è´ï¼Œä»è€Œé¿å…äº†ä¸¢å¼ƒæ•°æ®ã€‚</p>
<h2 id="reference">Reference</h2>
<ul>
<li><a href="../obj-c_to_c++/">å°† Obj-C ä»£ç ç¿»è¯‘ä¸º C++ ä»£ç  - kingcos</a></li>
<li><a href="/posts/2018/dyld_shared_cache/">è°ˆè°ˆ iOS ä¸­çš„ dyld_shared_cache - kingcos</a></li>
<li><a href="/posts/2019/link_map_file_in_xcode/">Xcode ä¸­çš„ Link Map æ–‡ä»¶ - kingcos</a></li>
<li><a href="/posts/2019/ivar_access_control_in_obj-c/">Obj-C ä¸­æˆå‘˜å˜é‡å’Œç±»çš„è®¿é—®æ§åˆ¶ - kingcos</a></li>
<li><a href="https://stackoverflow.com/questions/1201319/what-is-the-difference-between-memmove-and-memcpy">What is the difference between memmove and memcpy? - StackOverflow</a></li>
<li><a href="https://clc-wiki.net/wiki/memcpy">memcpy - clc-wiki</a></li>
<li><a href="https://tech.meituan.com/2018/11/08/ios-category-module-communicate.html">Category ç‰¹æ€§åœ¨ iOS ç»„ä»¶åŒ–ä¸­çš„åº”ç”¨ä¸ç®¡æ§ - ç¾å›¢æŠ€æœ¯å›¢é˜Ÿ</a></li>
</ul>

    </div>
    
      <div class="pagination">
        <div class="pagination__title">
          <span class="pagination__title-h">Read other posts</span>
          <hr />
        </div>
        <div class="pagination__buttons">
          
            <span class="button previous">
              <a href="/posts/2019/libraries_in_ios/">
                <span class="button__icon">â†</span>
                <span class="button__text">iOS ä¸­çš„åº“ä¸æ¡†æ¶</span>
              </a>
            </span>
          
          
            <span class="button next">
              <a href="/posts/2019/objc_msgsend/">
                <span class="button__text">æµ…å° objc_msgSend</span>
                <span class="button__icon">â†’</span>
              </a>
            </span>
          
        </div>
      </div>
    

    

    
    
    <div>
      <div id="github-comment">
      </div>

      <script type="text/javascript">
        function getUtterances(isDark) {
          var utterances = document.createElement('script');
          utterances.type = 'text/javascript';
          utterances.async = true;
          utterances.setAttribute('issue-term', "pathname")
          utterances.setAttribute('repo', "kingcos\/kingcos.github.io")
          utterances.setAttribute('label', "comments")
          isDark ? utterances.setAttribute('theme', "github-dark") : utterances.setAttribute('theme', "github-light")
          utterances.crossorigin = 'anonymous';
          utterances.src = 'https://utteranc.es/client.js';

          return utterances
        }

        var themeToggle = document.querySelector(".theme-toggle")
        themeToggle.addEventListener("click", function () {
          var getTheme = window.localStorage && window.localStorage.getItem("theme")
          var divNode = document.getElementById('github-comment')
          while(divNode.hasChildNodes()) {
            divNode.removeChild(divNode.firstChild);
          }
          
          
          

          
          
          
          
          
          
          document.getElementById('github-comment').appendChild(getUtterances(getTheme !== "dark"))
        })

        var getTheme = window.localStorage && window.localStorage.getItem("theme")
        document.getElementById('github-comment').appendChild(getUtterances(getTheme === "dark"))
      </script>
    </div>
    

    </div>

      </div>

      
        <footer class="footer">
  <div class="footer__inner">
    
      <div class="copyright copyright--user">All rights reserved by kingcos.me</div>
    
  </div>
</footer>

<script src="/assets/main.js"></script>
<script src="/assets/prism.js"></script>


      
    </div>

    
      
<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
	(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
	m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
	})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
	ga('create', 'UA-138311951-1', 'auto');
	
	ga('send', 'pageview');
}
</script>

    
  </body>
</html>
