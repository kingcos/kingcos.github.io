<!DOCTYPE html>
<html lang="en" >
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="author" content="kingcos" />
	
	
	
	<title>Combine ｜ kingcos</title>
	
    
    
    <meta name="description" content="三言两语，话说 Swift。" />
    

    
    
    <meta name="keywords" content="Hugo, theme, zozo" />
    

	
    
    <link rel="shortcut icon" href="https://kingcos.me/images/favicon.png" />

    <link rel="stylesheet" type="text/css" media="screen" href="https://kingcos.me/css/normalize.css" />
    <link rel="stylesheet" type="text/css" media="screen" href="https://cdn.jsdelivr.net/npm/animate.css@4.1.0/animate.min.css" />
    <link rel="stylesheet" type="text/css" media="screen" href="https://kingcos.me/css/zozo.css" />
	<link rel="stylesheet" type="text/css" media="screen" href="https://cdn.jsdelivr.net/npm/remixicon@2.5.0/fonts/remixicon.css" />
    <link rel="stylesheet" type="text/css" media="screen" href="https://kingcos.me/css/highlight.css" />

    
    
</head>

<script data-ad-client="ca-pub-9925978992661955" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>


<body>
    <div class="main animate__animated animate__fadeInDown">
        <div class="nav_container animated fadeInDown">
    <div class="site_nav" id="site_nav">
        <ul>
            
            <li>
                <a href="/">Home</a>
            </li>
            
            <li>
                <a href="/posts/">Archive</a>
            </li>
            
            <li>
                <a href="/tags/">Tags</a>
            </li>
            
            <li>
                <a href="/about/">About</a>
            </li>
            
        </ul>
    </div>
    <div class="menu_icon">
        <a id="menu_icon"><i class="ri-menu-line"></i></a>
    </div>
</div>


<link rel="stylesheet" href="https://kingcos.me/scss/main.min.75b49085bfb07b1bf150a1d59b4773d857e0452a747e37243805218b528a4045.css" integrity="sha256-dbSQhb&#43;wexvxUKHVm0dz2FfgRSp0fjckOAUhi1KKQEU=" media="screen">

<style>
.nav_container {
  height: 1rem;
}
 
table {
    width: 100%;
    table-layout: fixed;
}

 
.markdown code {
    white-space: normal;
    word-wrap: break-word;
    word-break: break-word;
    line-height: 1.5em;
    font-size: 0.85em;
    font-weight: bold;
    display: inline-block;
     
}

 
.menu_icon a {
    font-size: 16px;
}

 
body {
    font-family: 'Hiragino Sans GB', 'SFMono', 'Lato', '-apple-system';
    -webkit-font-smoothing: 'antialiased';
}

 
.markdown strong, .markdown b, .markdown em {
    font-weight: bold;
}

.post .post_content p {
     

    line-height: 1.75em;
}

 
.markdown img {
    max-width: 100%;
    margin: 0 auto;
    display: block;
    border-radius: 0.25rem;
}

 
.ri-stack-line {
    vertical-align: middle;
}

 
.ri-map-pin-time-line {
    vertical-align: middle;
}

 
.chroma .lntd:nth-child(2) {
    width: 100%;
}

 

 
.markdown .book-hint::before {
    content: none;
}

.markdown .book-hint {
    margin: 1rem 0;
    padding: 0.5rem 1rem 0.5rem 0.75rem;

    border-inline-start: 0.25rem solid #e9ecef;
    border-radius: 0.25rem;

    font-style: normal;
     
}

.book-hint strong {
    background-color: transparent;
}

.markdown .book-hint.info {
    border-left-color:#6bf;
    background-color:rgba(102,187,255,.1);
}

.markdown .book-hint.warning {
    border-left-color:#fd6;
    background-color:rgba(255,221,102,.1);
}

.markdown .book-hint.danger {
    border-left-color:#f66;
    background-color:rgba(255,102,102,.1);
}

</style>

        <div class="header animated fadeInDown">
    <div class="site_title_container">
        <div class="site_title">
            
                <a href="https://kingcos.me/">
                    
                    <img class="kingcos" style="margin-top: -20px; margin-left: -10px;" src="/title.svg" width="150px">
                </a>
            
        </div>
        <div class="description">
            <p class="sub_title">专注、坚持</p>
            <div class="my_socials">
                
                
                <a href="https://github.com/kingcos" title="github" target="_blank"><i class="ri-github-fill"></i></a>
                
                
                
                <a href="https://www.instagram.com/kingcos_v/" title="instagram" target="_blank"><i class="ri-instagram-fill"></i></a>
                
                
                
                <a href="https://twitter.com/kingcos_v" title="twitter" target="_blank"><i class="ri-twitter-fill"></i></a>
                
                
                
                <a href="https://weibo.com/u/1798410923" title="weibo" target="_blank"><i class="ri-weibo-fill"></i></a>
                
                
                
            </div>
        </div>
    </div>
</div>
        <div class="content">
            <div class="post_page">
                <div class="post animate__animated animate__fadeInDown">
                    <div class="post_title post_detail_title">
                        <h2><a href='/posts/draft/combine_1/'>Combine</a></h2>
                        <span class="date">2019.03.11</span>
                        <span>by kingcos</span>
                        
                        
                        
                        
                    </div>
                    <div class="post_content markdown"><ul>
<li>Foundation and UIKit/AppKit 中的异步机制：</li>
</ul>
<ol>
<li>NotificationCenter：事件发生时执行一段代码（eg. 设备方向改变，软键盘显示或隐藏）</li>
<li>代理（Delegate）模式：定义代表另一个对象的代理对象（eg. AppDelegate 中定义当新的远程推送到达时的操作，但对代码执行时机和次数未知）</li>
<li>GCD &amp; NSOperation：安排在穿行队列中顺序执行的代码，或者在不同优先级的不同队列中同时运行多个任务</li>
<li>闭包：创建可分离的代码段，便于其他对象可以决定是否执行、执行次数、以及执行时机</li>
</ol>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback">Publisher&lt;Int, Never&gt;
    ┌────┐   ┌────┐      ┌────┐   ┌────┐
    │    │   │    │      │    │   │    │
 ───│ 13 │──▶│ 27 │─────▶│ 35 │──▶│ 56 │──│─▶
    │    │   │    │      │    │   │    │
    └────┘   └────┘      └────┘   └────┘
time 0:01     0:05        0:15     0:19  STOP
</code></pre></div><h3 id="publisher">Publisher</h3>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-swift" data-lang="swift"><span class="c1">/// Declares that a type can transmit a sequence of values over time.</span>
<span class="c1">/// 声明一种可随时间传递值序列的类型。</span>
<span class="c1">///</span>
<span class="c1">/// There are four kinds of messages:</span>
<span class="c1">/// 共有四种消息：</span>
<span class="c1">///     subscription - A connection between `Publisher` and `Subscriber`.</span>
<span class="c1">///     订阅 - 发布者与订阅者之前的连接</span>
<span class="c1">///     value - An element in the sequence.</span>
<span class="c1">///     值 - 序列中的一个元素</span>
<span class="c1">///     error - The sequence ended with an error (`.failure(e)`).</span>
<span class="c1">///     错误 - 序列以错误结束（.failure(e)`）</span>
<span class="c1">///     complete - The sequence ended successfully (`.finished`).</span>
<span class="c1">///     完成 - 序列以成功结束（`.finished`）</span>
<span class="c1">/// Both `.failure` and `.finished` are terminal messages.</span>
<span class="c1">/// .failure` 和 `.finished` 均为终止消息。</span>
<span class="c1">///</span>
<span class="c1">/// You can summarize these possibilities with a regular expression:</span>
<span class="c1">/// 可使用正则表达式归纳其可能性：</span>
<span class="c1">///   value*(error|finished)?</span>
<span class="c1">///</span>
<span class="c1">/// Every `Publisher` must adhere to this contract.</span>
<span class="c1">/// 每个发布者都必须遵守该协议</span>
<span class="p">@</span><span class="n">available</span><span class="p">(</span><span class="n">OSX</span> <span class="mf">10.15</span><span class="p">,</span> <span class="n">iOS</span> <span class="mf">13.0</span><span class="p">,</span> <span class="n">tvOS</span> <span class="mf">13.0</span><span class="p">,</span> <span class="n">watchOS</span> <span class="mf">6.0</span><span class="p">,</span> <span class="o">*</span><span class="p">)</span>
<span class="kd">public</span> <span class="kd">protocol</span> <span class="nc">Publisher</span> <span class="p">{</span>

    <span class="c1">/// The kind of values published by this publisher.</span>
    <span class="c1">// 该发布者发射值的类型。</span>
    <span class="n">associatedtype</span> <span class="n">Output</span>

    <span class="c1">/// The kind of errors this publisher might publish.</span>
    <span class="c1">/// 该发布者可能发射错误的类型。</span>
    <span class="c1">///</span>
    <span class="c1">/// Use `Never` if this `Publisher` does not publish errors.</span>
    <span class="c1">/// 若该发布者不会发射出错误可使用 `Never`</span>
    <span class="n">associatedtype</span> <span class="n">Failure</span> <span class="p">:</span> <span class="n">Error</span>

    <span class="c1">/// This function is called to attach the specified `Subscriber` to this `Publisher` by `subscribe(_:)`</span>
    <span class="c1">/// 该方法将在 `subscribe(_:)` 中被调用，把特定订阅者附加到该发布者上。</span>
    <span class="c1">///</span>
    <span class="c1">/// - SeeAlso: `subscribe(_:)`</span>
    <span class="c1">/// - Parameters:</span>
    <span class="c1">///     - subscriber: The subscriber to attach to this `Publisher`.</span>
    <span class="c1">///                   once attached it can begin to receive values.</span>
    <span class="c1">///                   附加到该发布者的订阅者，一旦附加上即开始接收值。</span>
    <span class="kd">func</span> <span class="nf">receive</span><span class="p">&lt;</span><span class="n">S</span><span class="p">&gt;(</span><span class="n">subscriber</span><span class="p">:</span> <span class="n">S</span><span class="p">)</span> <span class="k">where</span> <span class="n">S</span> <span class="p">:</span> <span class="n">Subscriber</span><span class="p">,</span> <span class="kc">Self</span><span class="p">.</span><span class="n">Failure</span> <span class="p">==</span> <span class="n">S</span><span class="p">.</span><span class="n">Failure</span><span class="p">,</span> <span class="kc">Self</span><span class="p">.</span><span class="n">Output</span> <span class="p">==</span> <span class="n">S</span><span class="p">.</span><span class="n">Input</span>
<span class="p">}</span>

<span class="c1">/// 协议扩展</span>
<span class="p">@</span><span class="n">available</span><span class="p">(</span><span class="n">OSX</span> <span class="mf">10.15</span><span class="p">,</span> <span class="n">iOS</span> <span class="mf">13.0</span><span class="p">,</span> <span class="n">tvOS</span> <span class="mf">13.0</span><span class="p">,</span> <span class="n">watchOS</span> <span class="mf">6.0</span><span class="p">,</span> <span class="o">*</span><span class="p">)</span>
<span class="kd">extension</span> <span class="nc">Publisher</span> <span class="p">{</span>

    <span class="c1">/// Attaches the specified subscriber to this publisher.</span>
    <span class="c1">/// 将特定订阅者附加到该发布者上。</span>
    <span class="c1">///</span>
    <span class="c1">/// Always call this function instead of `receive(subscriber:)`.</span>
    <span class="c1">/// 应总是调用该方法而非 `receive(subscriber:)`。</span>
    <span class="c1">/// Adopters of `Publisher` must implement `receive(subscriber:)`. The implementation of `subscribe(_:)` in this extension calls through to `receive(subscriber:)`.</span>
    <span class="c1">/// 遵守 `Publisher` 的类型必须实现 `receive(subscriber:)`。该扩展中的 `subscribe(_:)` 实现将调用 `receive(subscriber:)`。</span>
    <span class="c1">/// - SeeAlso: `receive(subscriber:)`</span>
    <span class="c1">/// - Parameters:</span>
    <span class="c1">///     - subscriber: The subscriber to attach to this `Publisher`. After attaching, the subscriber can start to receive values.</span>
    <span class="c1">///                   被附加到发布者的订阅者。附加后，订阅者可以开始接收值。</span>
    <span class="kd">public</span> <span class="kd">func</span> <span class="nf">subscribe</span><span class="p">&lt;</span><span class="n">S</span><span class="p">&gt;(</span><span class="kc">_</span> <span class="n">subscriber</span><span class="p">:</span> <span class="n">S</span><span class="p">)</span> <span class="k">where</span> <span class="n">S</span> <span class="p">:</span> <span class="n">Subscriber</span><span class="p">,</span> <span class="kc">Self</span><span class="p">.</span><span class="n">Failure</span> <span class="p">==</span> <span class="n">S</span><span class="p">.</span><span class="n">Failure</span><span class="p">,</span> <span class="kc">Self</span><span class="p">.</span><span class="n">Output</span> <span class="p">==</span> <span class="n">S</span><span class="p">.</span><span class="n">Input</span>
<span class="p">}</span>
</code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-swift" data-lang="swift"><span class="c1">/// A protocol that declares a type that can receive input from a publisher.</span>
<span class="c1">/// 可以接收发布者作为输入的协议。</span>
<span class="p">@</span><span class="n">available</span><span class="p">(</span><span class="n">OSX</span> <span class="mf">10.15</span><span class="p">,</span> <span class="n">iOS</span> <span class="mf">13.0</span><span class="p">,</span> <span class="n">tvOS</span> <span class="mf">13.0</span><span class="p">,</span> <span class="n">watchOS</span> <span class="mf">6.0</span><span class="p">,</span> <span class="o">*</span><span class="p">)</span>
<span class="kd">public</span> <span class="kd">protocol</span> <span class="nc">Subscriber</span> <span class="p">:</span> <span class="n">CustomCombineIdentifierConvertible</span> <span class="p">{</span>

    <span class="c1">/// The kind of values this subscriber receives.</span>
    <span class="c1">/// 该订阅者接收的值的类型。</span>
    <span class="n">associatedtype</span> <span class="n">Input</span>

    <span class="c1">/// The kind of errors this subscriber might receive.</span>
    <span class="c1">/// 该订阅者接收可能接收到错误的类型。</span>
    <span class="c1">///</span>
    <span class="c1">/// Use `Never` if this `Subscriber` cannot receive errors.</span>
    <span class="c1">/// 若该订阅者不会接收到错误可使用 `Never`</span>
    <span class="n">associatedtype</span> <span class="n">Failure</span> <span class="p">:</span> <span class="n">Error</span>

    <span class="c1">/// Tells the subscriber that it has successfully subscribed to the publisher and may request items.</span>
    <span class="c1">/// 告知订阅者已成功订阅发布者，且可以请求项目。</span>
    <span class="c1">///</span>
    <span class="c1">/// Use the received `Subscription` to request items from the publisher.</span>
    <span class="c1">/// 使用接收到的 `Subscription` 向发布者请求项目。</span>
    <span class="c1">/// - Parameter subscription: A subscription that represents the connection between publisher and subscriber.</span>
    <span class="c1">///                           代表发布者与订阅者联系的订阅。</span>
    <span class="kd">func</span> <span class="nf">receive</span><span class="p">(</span><span class="n">subscription</span><span class="p">:</span> <span class="n">Subscription</span><span class="p">)</span>

    <span class="c1">/// Tells the subscriber that the publisher has produced an element.</span>
    <span class="c1">/// 告知订阅者，发布者已经产生了一个元素。</span>
    <span class="c1">///</span>
    <span class="c1">/// - Parameter input: The published element.</span>
    <span class="c1">///                    发布的元素。</span>
    <span class="c1">/// - Returns: A `Demand` instance indicating how many more elements the subcriber expects to receive.</span>
    <span class="c1">///            一个 `Demand` 实例，指订阅者期望接收到的元素个数。</span>
    <span class="kd">func</span> <span class="nf">receive</span><span class="p">(</span><span class="kc">_</span> <span class="n">input</span><span class="p">:</span> <span class="kc">Self</span><span class="p">.</span><span class="n">Input</span><span class="p">)</span> <span class="p">-&gt;</span> <span class="n">Subscribers</span><span class="p">.</span><span class="n">Demand</span>

    <span class="c1">/// Tells the subscriber that the publisher has completed publishing, either normally or with an error.</span>
    <span class="c1">/// 告知订阅者，发布者已经完成发布，正常抑或发生错误。</span>
    <span class="c1">///</span>
    <span class="c1">/// - Parameter completion: A `Completion` case indicating whether publishing completed normally or with an error.</span>
    <span class="c1">///                         一个 `Completion` 情况，指发布正常完成，或者出错。</span>
    <span class="kd">func</span> <span class="nf">receive</span><span class="p">(</span><span class="n">completion</span><span class="p">:</span> <span class="n">Subscribers</span><span class="p">.</span><span class="n">Completion</span><span class="p">&lt;</span><span class="kc">Self</span><span class="p">.</span><span class="n">Failure</span><span class="p">&gt;)</span>
<span class="p">}</span>
</code></pre></div><h3 id="subscription">Subscription</h3>
<p>订阅者可以调用 <code>request（_ :)</code> 表示愿意接收更多的值，最大为极值或无限制：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-swift" data-lang="swift"><span class="c1">/// A protocol representing the connection of a subscriber to a publisher.</span>
<span class="c1">/// 代表订阅者与发布者连接的协议。</span>
<span class="c1">///</span>
<span class="c1">/// Subcriptions are class constrained because a `Subscription` has identity -</span>
<span class="c1">/// defined by the moment in time a particular subscriber attached to a publisher.</span>
<span class="c1">/// 订阅受类型限制，因为 `Subscription` 的标示由连接到发布者的特定订阅者的时间定义。</span>
<span class="c1">/// Canceling a `Subscription` must be thread-safe.</span>
<span class="c1">/// 取消 `Subscription` 必须要线程安全。</span>
<span class="c1">///</span>
<span class="c1">/// You can only cancel a `Subscription` once.</span>
<span class="c1">/// `Subscription` 只能被取消一次。</span>
<span class="c1">///</span>
<span class="c1">/// Canceling a subscription frees up any resources previously allocated by attaching the `Subscriber`.</span>
<span class="p">@</span><span class="n">available</span><span class="p">(</span><span class="n">OSX</span> <span class="mf">10.15</span><span class="p">,</span> <span class="n">iOS</span> <span class="mf">13.0</span><span class="p">,</span> <span class="n">tvOS</span> <span class="mf">13.0</span><span class="p">,</span> <span class="n">watchOS</span> <span class="mf">6.0</span><span class="p">,</span> <span class="o">*</span><span class="p">)</span>
<span class="kd">public</span> <span class="kd">protocol</span> <span class="nc">Subscription</span> <span class="p">:</span> <span class="n">Cancellable</span><span class="p">,</span> <span class="n">CustomCombineIdentifierConvertible</span> <span class="p">{</span>

    <span class="c1">/// Tells a publisher that it may send more values to the subscriber.</span>
    <span class="c1">/// 告知发布者可以发送更多值到订阅者。</span>
    <span class="kd">func</span> <span class="nf">request</span><span class="p">(</span><span class="kc">_</span> <span class="n">demand</span><span class="p">:</span> <span class="n">Subscribers</span><span class="p">.</span><span class="n">Demand</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></div><blockquote>
<p>订阅者能够接收值的个数的概念为背压管理（Backpressure Management）。当订阅者从发布者那里获得了超过其所能处理的值的个数时，可能会导致问题。</p>
</blockquote>
<p>在 <code>Subscription</code> 中的 <code>request(_ demand: Subscribers.Demand)</code> 里可以指定能够接收的值的个数，也可在 <code>Subscriber</code> 中的 <code>receive(_ input: Self.Input) -&gt; Subscribers.Demand</code> 里调整。注意 <code>Subscriber</code> 中的 <code>receive(_ input: Self.Input) -&gt; Subscribers.Demand</code> 里调整的值是累加的，且必须为正数，否则将出错。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-swift" data-lang="swift"><span class="c1">/// A publisher that eventually produces one value and then finishes or fails.</span>
<span class="p">@</span><span class="n">available</span><span class="p">(</span><span class="n">OSX</span> <span class="mf">10.15</span><span class="p">,</span> <span class="n">iOS</span> <span class="mf">13.0</span><span class="p">,</span> <span class="n">tvOS</span> <span class="mf">13.0</span><span class="p">,</span> <span class="n">watchOS</span> <span class="mf">6.0</span><span class="p">,</span> <span class="o">*</span><span class="p">)</span>
<span class="kr">final</span> <span class="kd">public</span> <span class="kd">class</span> <span class="nc">Future</span><span class="p">&lt;</span><span class="n">Output</span><span class="p">,</span> <span class="n">Failure</span><span class="p">&gt;</span> <span class="p">:</span> <span class="n">Publisher</span> <span class="k">where</span> <span class="n">Failure</span> <span class="p">:</span> <span class="n">Error</span> <span class="p">{</span>

    <span class="kd">public</span> <span class="kd">typealias</span> <span class="n">Promise</span> <span class="p">=</span> <span class="p">(</span><span class="n">Result</span><span class="p">&lt;</span><span class="n">Output</span><span class="p">,</span> <span class="n">Failure</span><span class="p">&gt;)</span> <span class="p">-&gt;</span> <span class="nb">Void</span>

    <span class="kd">public</span> <span class="kd">init</span><span class="p">(</span><span class="kc">_</span> <span class="n">attemptToFulfill</span><span class="p">:</span> <span class="p">@</span><span class="n">escaping</span> <span class="p">(@</span><span class="n">escaping</span> <span class="n">Future</span><span class="p">&lt;</span><span class="n">Output</span><span class="p">,</span> <span class="n">Failure</span><span class="p">&gt;.</span><span class="n">Promise</span><span class="p">)</span> <span class="p">-&gt;</span> <span class="nb">Void</span><span class="p">)</span>

    <span class="c1">/// This function is called to attach the specified `Subscriber` to this `Publisher` by `subscribe(_:)`</span>
    <span class="c1">///</span>
    <span class="c1">/// - SeeAlso: `subscribe(_:)`</span>
    <span class="c1">/// - Parameters:</span>
    <span class="c1">///     - subscriber: The subscriber to attach to this `Publisher`.</span>
    <span class="c1">///                   once attached it can begin to receive values.</span>
    <span class="kr">final</span> <span class="kd">public</span> <span class="kd">func</span> <span class="nf">receive</span><span class="p">&lt;</span><span class="n">S</span><span class="p">&gt;(</span><span class="n">subscriber</span><span class="p">:</span> <span class="n">S</span><span class="p">)</span> <span class="k">where</span> <span class="n">Output</span> <span class="p">==</span> <span class="n">S</span><span class="p">.</span><span class="n">Input</span><span class="p">,</span> <span class="n">Failure</span> <span class="p">==</span> <span class="n">S</span><span class="p">.</span><span class="n">Failure</span><span class="p">,</span> <span class="n">S</span> <span class="p">:</span> <span class="n">Subscriber</span>
<span class="p">}</span>
</code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-swift" data-lang="swift"><span class="kd">import</span> <span class="nc">Foundation</span>
<span class="kd">import</span> <span class="nc">Combine</span>

<span class="kd">public</span> <span class="kd">func</span> <span class="nf">example</span><span class="p">(</span><span class="n">of</span> <span class="n">description</span><span class="p">:</span> <span class="nb">String</span><span class="p">,</span> <span class="n">action</span><span class="p">:</span> <span class="p">()</span> <span class="p">-&gt;</span> <span class="nb">Void</span><span class="p">)</span> <span class="p">{</span>
    <span class="bp">print</span><span class="p">(</span><span class="s">&#34;</span><span class="se">\n</span><span class="s">——— Example of:&#34;</span><span class="p">,</span> <span class="n">description</span><span class="p">,</span> <span class="s">&#34;———&#34;</span><span class="p">)</span>
    <span class="n">action</span><span class="p">()</span>
<span class="p">}</span>


<span class="c1">//example(of: &#34;Notification&#34;) {</span>
<span class="c1">//    // 创建通知名称</span>
<span class="c1">//    let myNotification = Notification.Name(&#34;myNotification&#34;)</span>
<span class="c1">//    let center = NotificationCenter.default</span>
<span class="c1">//    let observer = center.addObserver(forName: myNotification,</span>
<span class="c1">//                                      object: nil,</span>
<span class="c1">//                                      queue: nil) { notification in</span>
<span class="c1">//                                        print(&#34;收到了通知&#34;)</span>
<span class="c1">//    }</span>
<span class="c1">//    center.post(name: myNotification, object: nil)</span>
<span class="c1">//    center.removeObserver(observer)</span>
<span class="c1">//}</span>

<span class="n">example</span><span class="p">(</span><span class="n">of</span><span class="p">:</span> <span class="s">&#34;Publisher&#34;</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// 创建通知名称</span>
    <span class="kd">let</span> <span class="nv">myNotification</span> <span class="p">=</span> <span class="n">Notification</span><span class="p">.</span><span class="n">Name</span><span class="p">(</span><span class="s">&#34;myNotification&#34;</span><span class="p">)</span>
    <span class="kd">let</span> <span class="nv">center</span> <span class="p">=</span> <span class="n">NotificationCenter</span><span class="p">.</span><span class="k">default</span>

    <span class="c1">// 定义发布者，通知中心</span>
    <span class="c1">// func publisher(for name: Notification.Name, object: AnyObject? = nil) -&gt; NotificationCenter.Publisher</span>
    <span class="kd">let</span> <span class="nv">publisher</span> <span class="p">=</span> <span class="n">NotificationCenter</span>
        <span class="p">.</span><span class="k">default</span>
        <span class="p">.</span><span class="n">publisher</span><span class="p">(</span><span class="k">for</span><span class="p">:</span> <span class="n">myNotification</span><span class="p">,</span>
                   <span class="n">object</span><span class="p">:</span> <span class="kc">nil</span><span class="p">)</span>
    <span class="c1">// 发布者 -&gt; 订阅者</span>
    <span class="c1">// func sink(receiveValue: @escaping ((Notification) -&gt; Void)) -&gt; AnyCancellable</span>
    <span class="kd">let</span> <span class="nv">subscription</span> <span class="p">=</span> <span class="n">publisher</span><span class="p">.</span><span class="n">sink</span> <span class="p">{</span> <span class="kc">_</span> <span class="k">in</span>
        <span class="bp">print</span><span class="p">(</span><span class="s">&#34;订阅者接收到了通知&#34;</span><span class="p">)</span>
    <span class="p">}</span>

    <span class="c1">// 发送通知</span>
    <span class="n">center</span><span class="p">.</span><span class="n">post</span><span class="p">(</span><span class="n">name</span><span class="p">:</span> <span class="n">myNotification</span><span class="p">,</span> <span class="n">object</span><span class="p">:</span> <span class="kc">nil</span><span class="p">)</span>

    <span class="c1">// 取消订阅，释放资源；若不手动调用，将直到发布者完成或存储订阅的对象销毁时才会取消订阅</span>
    <span class="c1">// _ = some_subscription：未存储的订阅将在创建时的程序流退出时被取消订阅</span>
    <span class="n">subscription</span><span class="p">.</span><span class="n">cancel</span><span class="p">()</span>

<span class="c1">//    ——— Example of: Publisher ———</span>
<span class="c1">//    订阅者接收到了通知</span>
<span class="p">}</span>

<span class="n">example</span><span class="p">(</span><span class="n">of</span><span class="p">:</span> <span class="s">&#34;Just&#34;</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// 发布者，只发射一个值，然后完成</span>
    <span class="kd">let</span> <span class="nv">just</span> <span class="p">=</span> <span class="n">Just</span><span class="p">(</span><span class="s">&#34;你好，世界！&#34;</span><span class="p">)</span>

    <span class="kc">_</span> <span class="p">=</span> <span class="n">just</span><span class="p">.</span><span class="n">sink</span><span class="p">(</span><span class="n">receiveCompletion</span><span class="p">:</span> <span class="p">{</span>
        <span class="c1">// finished</span>
        <span class="bp">print</span><span class="p">(</span><span class="s">&#34;订阅者 1 接收到「完成」：&#34;</span><span class="p">,</span> <span class="nv">$0</span><span class="p">)</span>
    <span class="p">},</span> <span class="n">receiveValue</span><span class="p">:</span> <span class="p">{</span>
        <span class="bp">print</span><span class="p">(</span><span class="s">&#34;订阅者 1 接收到「值」：&#34;</span><span class="p">,</span> <span class="nv">$0</span><span class="p">)</span>
    <span class="p">})</span>

    <span class="kc">_</span> <span class="p">=</span> <span class="n">just</span><span class="p">.</span><span class="n">sink</span><span class="p">(</span><span class="n">receiveCompletion</span><span class="p">:</span> <span class="p">{</span>
        <span class="bp">print</span><span class="p">(</span><span class="s">&#34;订阅者 2 接收到「完成」：&#34;</span><span class="p">,</span> <span class="nv">$0</span><span class="p">)</span>
    <span class="p">},</span> <span class="n">receiveValue</span><span class="p">:</span> <span class="p">{</span>
        <span class="bp">print</span><span class="p">(</span><span class="s">&#34;订阅者 2 接收到「值」：&#34;</span><span class="p">,</span> <span class="nv">$0</span><span class="p">)</span>
    <span class="p">})</span>

    <span class="c1">// 当 Just 发布者每被订阅一次，就会发射一个值，并完成</span>

<span class="c1">//    订阅者 1 接收到「值」： 你好，世界！</span>
<span class="c1">//    订阅者 1 接收到「完成」： finished</span>
<span class="c1">//    订阅者 2 接收到「值」： 你好，世界！</span>
<span class="c1">//    订阅者 2 接收到「完成」： finished</span>
<span class="p">}</span>

<span class="n">example</span><span class="p">(</span><span class="n">of</span><span class="p">:</span> <span class="s">&#34;assign(to🔛)&#34;</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">class</span> <span class="nc">SomeObject</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nv">value</span><span class="p">:</span> <span class="nb">String</span> <span class="p">=</span> <span class="s">&#34;&#34;</span> <span class="p">{</span>
            <span class="kr">didSet</span> <span class="p">{</span>
                <span class="c1">// 被设置时打印</span>
                <span class="bp">print</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="kd">let</span> <span class="nv">obj</span> <span class="p">=</span> <span class="n">SomeObject</span><span class="p">()</span>

    <span class="c1">// 发射 A -&gt; 发射 B</span>
    <span class="kd">let</span> <span class="nv">publisher</span> <span class="p">=</span> <span class="p">[</span><span class="s">&#34;A&#34;</span><span class="p">,</span> <span class="s">&#34;B&#34;</span><span class="p">].</span><span class="n">publisher</span>
    <span class="c1">// 分配到 obj 的 value（必须为 class 类型）</span>
    <span class="kc">_</span> <span class="p">=</span> <span class="n">publisher</span><span class="p">.</span><span class="n">assign</span><span class="p">(</span><span class="n">to</span><span class="p">:</span> <span class="err">\</span><span class="p">.</span><span class="n">value</span><span class="p">,</span> <span class="n">on</span><span class="p">:</span> <span class="n">obj</span><span class="p">)</span>

<span class="c1">//    ——— Example of: assign(to🔛) ———</span>
<span class="c1">//    A</span>
<span class="c1">//    B</span>
<span class="p">}</span>

<span class="n">example</span><span class="p">(</span><span class="n">of</span><span class="p">:</span> <span class="s">&#34;Custom Subscriber&#34;</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">let</span> <span class="nv">publisher</span> <span class="p">=</span> <span class="p">(</span><span class="mf">1.</span><span class="p">..</span><span class="mi">6</span><span class="p">).</span><span class="n">publisher</span>
<span class="c1">//    let publisher = [&#34;A&#34;, &#34;B&#34;, &#34;C&#34;, &#34;D&#34;, &#34;E&#34;, &#34;F&#34;].publisher // ERROR: Input 类型不匹配</span>

    <span class="c1">// 自定义订阅者</span>
    <span class="kr">final</span> <span class="kd">class</span> <span class="nc">IntSubscriber</span><span class="p">:</span> <span class="n">Subscriber</span> <span class="p">{</span>
        <span class="kd">typealias</span> <span class="n">Input</span> <span class="p">=</span> <span class="nb">Int</span>
        <span class="kd">typealias</span> <span class="n">Failure</span> <span class="p">=</span> <span class="n">Never</span>

        <span class="c1">// 由发布者调用</span>
        <span class="kd">func</span> <span class="nf">receive</span><span class="p">(</span><span class="n">subscription</span><span class="p">:</span> <span class="n">Subscription</span><span class="p">)</span> <span class="p">{</span>
            <span class="c1">// 指定最多可接收 3 个值</span>
            <span class="n">subscription</span><span class="p">.</span><span class="n">request</span><span class="p">(.</span><span class="bp">max</span><span class="p">(</span><span class="mi">3</span><span class="p">))</span>
        <span class="p">}</span>

        <span class="c1">// 值事件</span>
        <span class="kd">func</span> <span class="nf">receive</span><span class="p">(</span><span class="kc">_</span> <span class="n">input</span><span class="p">:</span> <span class="nb">Int</span><span class="p">)</span> <span class="p">-&gt;</span> <span class="n">Subscribers</span><span class="p">.</span><span class="n">Demand</span> <span class="p">{</span>
            <span class="bp">print</span><span class="p">(</span><span class="s">&#34;收到的值为：&#34;</span><span class="p">,</span> <span class="n">input</span><span class="p">)</span>
            <span class="k">return</span> <span class="p">.</span><span class="kr">none</span> <span class="c1">// 等同于 .max(0)，不再调整接收数量</span>
<span class="c1">//            return .unlimited // 升级为无限制</span>
        <span class="p">}</span>

        <span class="c1">// 完成事件</span>
        <span class="kd">func</span> <span class="nf">receive</span><span class="p">(</span><span class="n">completion</span><span class="p">:</span> <span class="n">Subscribers</span><span class="p">.</span><span class="n">Completion</span><span class="p">&lt;</span><span class="n">Never</span><span class="p">&gt;)</span> <span class="p">{</span>
            <span class="bp">print</span><span class="p">(</span><span class="s">&#34;收到完成&#34;</span><span class="p">)</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="kd">let</span> <span class="nv">subscriber</span> <span class="p">=</span> <span class="n">IntSubscriber</span><span class="p">()</span>
    <span class="n">publisher</span><span class="p">.</span><span class="n">subscribe</span><span class="p">(</span><span class="n">subscriber</span><span class="p">)</span>

<span class="c1">//    ——— Example of: Custom Subscriber ———</span>
<span class="c1">//    收到的值为： 1</span>
<span class="c1">//    收到的值为： 2</span>
<span class="c1">//    收到的值为： 3</span>
<span class="p">}</span>

<span class="kd">var</span> <span class="nv">subscriptions</span> <span class="p">=</span> <span class="n">Set</span><span class="p">&lt;</span><span class="n">AnyCancellable</span><span class="p">&gt;()</span>

<span class="c1">//example(of: &#34;Future&#34;) {</span>
<span class="c1">//    // 发出整数，并永不失败</span>
<span class="c1">//    func futureIncrement(</span>
<span class="c1">//        integer: Int,</span>
<span class="c1">//        afterDelay delay: TimeInterval</span>
<span class="c1">//    ) -&gt; Future&lt;Int, Never&gt; {</span>
<span class="c1">//        // public init(_ attemptToFulfill: @escaping (@escaping Future&lt;Output, Failure&gt;.Promise) -&gt; Void)</span>
<span class="c1">//        Future&lt;Int, Never&gt;.init { promise in</span>
<span class="c1">//            print(&#34;Original&#34;) // 立即打印说明，创建后会立即执行（无需订阅者）</span>
<span class="c1">//            DispatchQueue.global().asyncAfter(deadline: .now() + delay) {</span>
<span class="c1">//                promise(.success(integer + 1)) // 发射出一个值，之后完成事件（需要订阅者）</span>
<span class="c1">//            }</span>
<span class="c1">//        }</span>
<span class="c1">//    }</span>
<span class="c1">//</span>
<span class="c1">//    // Future 是一个发布者，本质上是制造一个单一值并结束，或者失败。当值或者错误可用时，将通过调用闭包实现，该闭包被称作 Promise。</span>
<span class="c1">//</span>
<span class="c1">//    let future = futureIncrement(integer: 1, afterDelay: 3)</span>
<span class="c1">//</span>
<span class="c1">////    sleep(3);</span>
<span class="c1">//    future.sink(receiveCompletion: { print($0) }, receiveValue: { print($0) }).store(in: &amp;subscriptions)</span>
<span class="c1">//</span>
<span class="c1">//    // ⚠️：Future 并没有重新执行 Promise，而是共享（或者说重播）了其输出</span>
<span class="c1">//    future.sink(receiveCompletion: { print(&#34;Second&#34;, $0) }, receiveValue: { print(&#34;Second&#34;, $0) }) .store(in: &amp;subscriptions)</span>
<span class="c1">//</span>
<span class="c1">////    ——— Example of: Future ———</span>
<span class="c1">////    Original</span>
<span class="c1">////    2</span>
<span class="c1">////    finished</span>
<span class="c1">////    Second 2</span>
<span class="c1">////    Second finished</span>
<span class="c1">//}</span>

<span class="n">example</span><span class="p">(</span><span class="n">of</span><span class="p">:</span> <span class="s">&#34;PassthoughSubject&#34;</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">enum</span> <span class="nc">MyError</span><span class="p">:</span> <span class="n">Error</span> <span class="p">{</span>
        <span class="k">case</span> <span class="n">test</span>
    <span class="p">}</span>

    <span class="kr">final</span> <span class="kd">class</span> <span class="nc">StringSubscriber</span><span class="p">:</span> <span class="n">Subscriber</span> <span class="p">{</span>
        <span class="kd">typealias</span> <span class="n">Input</span> <span class="p">=</span> <span class="nb">String</span>
        <span class="kd">typealias</span> <span class="n">Failure</span> <span class="p">=</span> <span class="n">MyError</span>

        <span class="kd">func</span> <span class="nf">receive</span><span class="p">(</span><span class="n">subscription</span><span class="p">:</span> <span class="n">Subscription</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">subscription</span><span class="p">.</span><span class="n">request</span><span class="p">(.</span><span class="bp">max</span><span class="p">(</span><span class="mi">2</span><span class="p">))</span>
        <span class="p">}</span>

        <span class="kd">func</span> <span class="nf">receive</span><span class="p">(</span><span class="kc">_</span> <span class="n">input</span><span class="p">:</span> <span class="nb">String</span><span class="p">)</span> <span class="p">-&gt;</span> <span class="n">Subscribers</span><span class="p">.</span><span class="n">Demand</span> <span class="p">{</span>
            <span class="bp">print</span><span class="p">(</span><span class="s">&#34;接收到值&#34;</span><span class="p">,</span> <span class="n">input</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">input</span> <span class="p">==</span> <span class="s">&#34;World&#34;</span> <span class="p">?</span> <span class="p">.</span><span class="bp">max</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">:</span> <span class="p">.</span><span class="kr">none</span>
        <span class="p">}</span>

        <span class="kd">func</span> <span class="nf">receive</span><span class="p">(</span><span class="n">completion</span><span class="p">:</span> <span class="n">Subscribers</span><span class="p">.</span><span class="n">Completion</span><span class="p">&lt;</span><span class="n">MyError</span><span class="p">&gt;)</span> <span class="p">{</span>
            <span class="bp">print</span><span class="p">(</span><span class="s">&#34;接收到完成&#34;</span><span class="p">,</span> <span class="n">completion</span><span class="p">)</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="kd">let</span> <span class="nv">subscriber</span> <span class="p">=</span> <span class="n">StringSubscriber</span><span class="p">()</span>

    <span class="c1">// PassthroughSubject：可以按需要发布新值（其乐于传递值和完成事件），但仍需声明其发出值和错误的类型，且订阅者需要与其匹配</span>
    <span class="kd">let</span> <span class="nv">subject</span> <span class="p">=</span> <span class="n">PassthroughSubject</span><span class="p">&lt;</span><span class="nb">String</span><span class="p">,</span> <span class="n">MyError</span><span class="p">&gt;()</span>
    <span class="c1">// 订阅者订阅 subject</span>
    <span class="n">subject</span><span class="p">.</span><span class="n">subscribe</span><span class="p">(</span><span class="n">subscriber</span><span class="p">)</span>

    <span class="c1">// 创建另外的订阅</span>
    <span class="kd">let</span> <span class="nv">subscription</span> <span class="p">=</span> <span class="n">subject</span><span class="p">.</span><span class="n">sink</span><span class="p">(</span><span class="n">receiveCompletion</span><span class="p">:</span> <span class="p">{</span> <span class="n">completion</span> <span class="k">in</span>
        <span class="bp">print</span><span class="p">(</span><span class="s">&#34;Received completion (sink)&#34;</span><span class="p">,</span> <span class="n">completion</span><span class="p">)</span>
    <span class="p">})</span> <span class="p">{</span> <span class="n">value</span> <span class="k">in</span>
        <span class="bp">print</span><span class="p">(</span><span class="s">&#34;Received value (sink)&#34;</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
    <span class="p">}</span>

    <span class="n">subject</span><span class="p">.</span><span class="n">send</span><span class="p">(</span><span class="s">&#34;Hello&#34;</span><span class="p">)</span>
    <span class="n">subject</span><span class="p">.</span><span class="n">send</span><span class="p">(</span><span class="s">&#34;World&#34;</span><span class="p">)</span>

    <span class="n">subscription</span><span class="p">.</span><span class="n">cancel</span><span class="p">()</span> <span class="c1">// 取消订阅</span>

    <span class="n">subject</span><span class="p">.</span><span class="n">send</span><span class="p">(</span><span class="s">&#34;Test&#34;</span><span class="p">)</span>

<span class="c1">//    subject.send(completion: .failure(MyError.test))</span>
    <span class="n">subject</span><span class="p">.</span><span class="n">send</span><span class="p">(</span><span class="n">completion</span><span class="p">:</span> <span class="p">.</span><span class="n">finished</span><span class="p">)</span> <span class="c1">// subscriber 的订阅取消</span>
    <span class="n">subject</span><span class="p">.</span><span class="n">send</span><span class="p">(</span><span class="s">&#34;Test again&#34;</span><span class="p">)</span>

<span class="c1">//     通过 PassthroughSubject 传递值是将命令式代码桥接到 Combine 的声明性世界的一种方法。</span>
<span class="p">}</span>

<span class="n">example</span><span class="p">(</span><span class="n">of</span><span class="p">:</span> <span class="s">&#34;CurrentValueSubject&#34;</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// 发射 Int 值，不会出现错误</span>
    <span class="kd">let</span> <span class="nv">subject</span> <span class="p">=</span> <span class="n">CurrentValueSubject</span><span class="p">&lt;</span><span class="nb">Int</span><span class="p">,</span> <span class="n">Never</span><span class="p">&gt;(</span><span class="mi">0</span><span class="p">)</span>

    <span class="n">subject</span>
        <span class="p">.</span><span class="bp">print</span><span class="p">()</span> <span class="c1">// 打印 log 信息</span>
        <span class="p">.</span><span class="n">sink</span><span class="p">(</span><span class="n">receiveValue</span><span class="p">:</span> <span class="p">{</span> <span class="bp">print</span><span class="p">(</span><span class="nv">$0</span><span class="p">)</span> <span class="p">})</span> <span class="c1">// 订阅，并处理</span>
        <span class="p">.</span><span class="n">store</span><span class="p">(</span><span class="k">in</span><span class="p">:</span> <span class="p">&amp;</span><span class="n">subscriptions</span><span class="p">)</span> <span class="c1">// inout：更新同一集合</span>

    <span class="n">subject</span><span class="p">.</span><span class="n">send</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="c1">// 访问其当前值</span>
    <span class="bp">print</span><span class="p">(</span><span class="s">&#34;print&#34;</span><span class="p">,</span> <span class="n">subject</span><span class="p">.</span><span class="n">value</span><span class="p">)</span>
    <span class="n">subject</span><span class="p">.</span><span class="n">send</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
    <span class="bp">print</span><span class="p">(</span><span class="s">&#34;print&#34;</span><span class="p">,</span> <span class="n">subject</span><span class="p">.</span><span class="n">value</span><span class="p">)</span>

    <span class="n">subject</span><span class="p">.</span><span class="n">value</span> <span class="p">=</span> <span class="mi">100</span>
    <span class="bp">print</span><span class="p">(</span><span class="s">&#34;print&#34;</span><span class="p">,</span> <span class="n">subject</span><span class="p">.</span><span class="n">value</span><span class="p">)</span>

    <span class="n">subject</span>
         <span class="p">.</span><span class="bp">print</span><span class="p">()</span>
        <span class="p">.</span><span class="n">sink</span><span class="p">(</span><span class="n">receiveValue</span><span class="p">:</span> <span class="p">{</span> <span class="bp">print</span><span class="p">(</span><span class="s">&#34;222:&#34;</span><span class="p">,</span> <span class="nv">$0</span><span class="p">)</span> <span class="p">})</span> <span class="c1">// 首个为当前值</span>
        <span class="p">.</span><span class="n">store</span><span class="p">(</span><span class="k">in</span><span class="p">:</span> <span class="p">&amp;</span><span class="n">subscriptions</span><span class="p">)</span>

    <span class="c1">// CurrentValueSubject 的值只能为值，不能为完成事件</span>
    <span class="c1">// ERROR: Type &#39;Int&#39; has no member &#39;finished&#39;</span>
    <span class="c1">// subject.value = .finished</span>

    <span class="c1">// 手动取消</span>
<span class="c1">//    subscriptions.forEach {</span>
<span class="c1">//        $0.cancel()</span>
<span class="c1">//    }</span>
    <span class="c1">// 发射完成事件(无需 cancel）</span>
    <span class="n">subject</span><span class="p">.</span><span class="n">send</span><span class="p">(</span><span class="n">completion</span><span class="p">:</span> <span class="p">.</span><span class="n">finished</span><span class="p">)</span>

    <span class="c1">// 可以将预订存储在AnyCancellable的实例或集合中，以在取消初始化时接收自动取消。</span>

<span class="p">}</span>

<span class="n">example</span><span class="p">(</span><span class="n">of</span><span class="p">:</span> <span class="s">&#34;动态调整 Demand&#34;</span><span class="p">)</span> <span class="p">{</span>
    <span class="kr">final</span> <span class="kd">class</span> <span class="nc">IntSubscriber</span><span class="p">:</span> <span class="n">Subscriber</span> <span class="p">{</span>
        <span class="kd">typealias</span> <span class="n">Input</span> <span class="p">=</span> <span class="nb">Int</span>
        <span class="kd">typealias</span> <span class="n">Failure</span> <span class="p">=</span> <span class="n">Never</span>
        <span class="kd">func</span> <span class="nf">receive</span><span class="p">(</span><span class="n">subscription</span><span class="p">:</span> <span class="n">Subscription</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">subscription</span><span class="p">.</span><span class="n">request</span><span class="p">(.</span><span class="bp">max</span><span class="p">(</span><span class="mi">2</span><span class="p">))</span>
        <span class="p">}</span>

        <span class="kd">func</span> <span class="nf">receive</span><span class="p">(</span><span class="kc">_</span> <span class="n">input</span><span class="p">:</span> <span class="nb">Int</span><span class="p">)</span> <span class="p">-&gt;</span> <span class="n">Subscribers</span><span class="p">.</span><span class="n">Demand</span> <span class="p">{</span>
            <span class="bp">print</span><span class="p">(</span><span class="s">&#34;Received value&#34;</span><span class="p">,</span> <span class="n">input</span><span class="p">)</span>

            <span class="k">switch</span> <span class="n">input</span> <span class="p">{</span>
            <span class="k">case</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">return</span> <span class="p">.</span><span class="bp">max</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="c1">// 1</span>
            <span class="k">case</span> <span class="mi">3</span><span class="p">:</span>
                <span class="k">return</span> <span class="p">.</span><span class="bp">max</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="c1">// 2</span>
            <span class="k">default</span><span class="p">:</span>
                <span class="k">return</span> <span class="p">.</span><span class="kr">none</span> <span class="c1">// 3</span>
            <span class="p">}</span>
        <span class="p">}</span>

        <span class="kd">func</span> <span class="nf">receive</span><span class="p">(</span><span class="n">completion</span><span class="p">:</span> <span class="n">Subscribers</span><span class="p">.</span><span class="n">Completion</span><span class="p">&lt;</span><span class="n">Never</span><span class="p">&gt;)</span> <span class="p">{</span>
          <span class="bp">print</span><span class="p">(</span><span class="s">&#34;Received completion&#34;</span><span class="p">,</span> <span class="n">completion</span><span class="p">)</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="kd">let</span> <span class="nv">subscriber</span> <span class="p">=</span> <span class="n">IntSubscriber</span><span class="p">()</span>  <span class="c1">// 2</span>
    <span class="kd">let</span> <span class="nv">subject</span> <span class="p">=</span> <span class="n">PassthroughSubject</span><span class="p">&lt;</span><span class="nb">Int</span><span class="p">,</span> <span class="n">Never</span><span class="p">&gt;()</span>
    <span class="n">subject</span><span class="p">.</span><span class="n">subscribe</span><span class="p">(</span><span class="n">subscriber</span><span class="p">)</span>
    <span class="n">subject</span><span class="p">.</span><span class="n">send</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="c1">// 4</span>
    <span class="n">subject</span><span class="p">.</span><span class="n">send</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="c1">// 5</span>
    <span class="n">subject</span><span class="p">.</span><span class="n">send</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
    <span class="n">subject</span><span class="p">.</span><span class="n">send</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>
    <span class="n">subject</span><span class="p">.</span><span class="n">send</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
    <span class="n">subject</span><span class="p">.</span><span class="n">send</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span>
<span class="p">}</span>

<span class="n">example</span><span class="p">(</span><span class="n">of</span><span class="p">:</span> <span class="s">&#34;类型擦除 Type erasure&#34;</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// 希望让订阅者订阅以接收来自发布者的事件，而又无法访问有关该发布者的其他详细信息。</span>
    <span class="kd">let</span> <span class="nv">subject</span> <span class="p">=</span> <span class="n">PassthroughSubject</span><span class="p">&lt;</span><span class="nb">Int</span><span class="p">,</span> <span class="n">Never</span><span class="p">&gt;()</span>

    <span class="c1">// 类型擦除的发布者：对订阅者隐藏发布者的详细信息</span>
    <span class="c1">// AnyPublisher&lt;Int, Never&gt;</span>
    <span class="kd">let</span> <span class="nv">publisher</span> <span class="p">=</span> <span class="n">subject</span><span class="p">.</span><span class="n">eraseToAnyPublisher</span><span class="p">()</span>

    <span class="n">publisher</span><span class="p">.</span><span class="n">sink</span><span class="p">(</span><span class="n">receiveValue</span><span class="p">:</span> <span class="p">{</span> <span class="bp">print</span><span class="p">(</span><span class="nv">$0</span><span class="p">)</span> <span class="p">})</span>
    <span class="p">.</span><span class="n">store</span><span class="p">(</span><span class="k">in</span><span class="p">:</span> <span class="p">&amp;</span><span class="n">subscriptions</span><span class="p">)</span>

    <span class="n">subject</span><span class="p">.</span><span class="n">send</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>


    <span class="c1">// AnyCancellable 是遵守 Cancellable 的类型擦除的类，调用者可以取消订阅，但不能访问订阅内部的信息</span>


    <span class="c1">// 另外一种情况是，当我们想使用一对公开和私有的属性，来允许这些属性的拥有者在私有的发布者上发送值，并让外界调用者访问公开的发布值来订阅，但不能发送值</span>

    <span class="c1">// AnyPublisher 没有 send(_:) 操作者，所以新值不能被再加到发布者上</span>
    <span class="c1">// publisher.send(1)</span>

    <span class="c1">// eraseToAnyPublisher() 将提供的发布者作为 AnyPublisher 的实例（不能指定为 Publish 是因为 Publish 是协议，无法作为实例的类型去约束），隐藏其是 PassthroughSubject 的事实</span>


<span class="p">}</span>
</code></pre></div><h2 id="3">3</h2>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-swift" data-lang="swift"><span class="kd">import</span> <span class="nc">Foundation</span>
<span class="kd">import</span> <span class="nc">Combine</span>


<span class="kd">public</span> <span class="kd">func</span> <span class="nf">example</span><span class="p">(</span><span class="n">of</span> <span class="n">description</span><span class="p">:</span> <span class="nb">String</span><span class="p">,</span> <span class="n">action</span><span class="p">:</span> <span class="p">()</span> <span class="p">-&gt;</span> <span class="nb">Void</span><span class="p">)</span> <span class="p">{</span>
    <span class="bp">print</span><span class="p">(</span><span class="s">&#34;</span><span class="se">\n</span><span class="s">——— Example of:&#34;</span><span class="p">,</span> <span class="n">description</span><span class="p">,</span> <span class="s">&#34;———&#34;</span><span class="p">)</span>
    <span class="n">action</span><span class="p">()</span>
<span class="p">}</span>


<span class="kd">var</span> <span class="nv">subscriptions</span> <span class="p">=</span> <span class="p">[</span><span class="n">AnyCancellable</span><span class="p">]()</span>

<span class="c1">// 操作者是发布者</span>
<span class="c1">// 处理来自发布者的值的方法被称作操作者，</span>
<span class="n">example</span><span class="p">(</span><span class="n">of</span><span class="p">:</span> <span class="s">&#34;收集&#34;</span><span class="p">)</span> <span class="p">{</span>
    <span class="p">[</span><span class="s">&#34;A&#34;</span><span class="p">,</span> <span class="s">&#34;B&#34;</span><span class="p">,</span> <span class="s">&#34;C&#34;</span><span class="p">,</span> <span class="s">&#34;D&#34;</span><span class="p">,</span> <span class="s">&#34;E&#34;</span><span class="p">].</span><span class="n">publisher</span>
    <span class="p">.</span><span class="n">sink</span><span class="p">(</span><span class="n">receiveCompletion</span><span class="p">:</span> <span class="p">{</span> <span class="bp">print</span><span class="p">(</span><span class="nv">$0</span><span class="p">)</span> <span class="p">},</span>
          <span class="n">receiveValue</span><span class="p">:</span> <span class="p">{</span> <span class="bp">print</span><span class="p">(</span><span class="nv">$0</span><span class="p">)</span> <span class="p">})</span>
    <span class="p">.</span><span class="n">store</span><span class="p">(</span><span class="k">in</span><span class="p">:</span> <span class="p">&amp;</span><span class="n">subscriptions</span><span class="p">)</span>

    <span class="c1">// 注意：</span>
    <span class="c1">// 使用 collect 和其它不限定数量或限制的缓冲操作符时要小心，其将使用无限制的内存来存储收到的值</span>
    <span class="p">[</span><span class="s">&#34;A&#34;</span><span class="p">,</span> <span class="s">&#34;B&#34;</span><span class="p">,</span> <span class="s">&#34;C&#34;</span><span class="p">,</span> <span class="s">&#34;D&#34;</span><span class="p">,</span> <span class="s">&#34;E&#34;</span><span class="p">].</span><span class="n">publisher</span>
<span class="c1">//    .collect() // [&#34;A&#34;, &#34;B&#34;, &#34;C&#34;, &#34;D&#34;, &#34;E&#34;]</span>
    <span class="p">.</span><span class="n">collect</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="c1">// [&#34;A&#34;, &#34;B&#34;], [&#34;C&#34;, &#34;D&#34;], [&#34;E&#34;] // 限定为 2</span>
    <span class="p">.</span><span class="n">sink</span><span class="p">(</span><span class="n">receiveCompletion</span><span class="p">:</span> <span class="p">{</span> <span class="bp">print</span><span class="p">(</span><span class="nv">$0</span><span class="p">)</span> <span class="p">},</span>
          <span class="n">receiveValue</span><span class="p">:</span> <span class="p">{</span> <span class="bp">print</span><span class="p">(</span><span class="nv">$0</span><span class="p">)</span> <span class="p">})</span>
    <span class="p">.</span><span class="n">store</span><span class="p">(</span><span class="k">in</span><span class="p">:</span> <span class="p">&amp;</span><span class="n">subscriptions</span><span class="p">)</span>
<span class="p">}</span>

<span class="n">example</span><span class="p">(</span><span class="n">of</span><span class="p">:</span> <span class="s">&#34;map&#34;</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">let</span> <span class="nv">formatter</span> <span class="p">=</span> <span class="n">NumberFormatter</span><span class="p">()</span>
    <span class="n">formatter</span><span class="p">.</span><span class="n">numberStyle</span> <span class="p">=</span> <span class="p">.</span><span class="n">spellOut</span>
    <span class="c1">// map 是 Swift 里的高阶函数</span>
    <span class="p">[</span><span class="mi">123</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">56</span><span class="p">].</span><span class="n">publisher</span><span class="p">.</span><span class="bp">map</span> <span class="p">{</span>
        <span class="n">formatter</span><span class="p">.</span><span class="n">string</span><span class="p">(</span><span class="n">from</span><span class="p">:</span> <span class="n">NSNumber</span><span class="p">(</span><span class="n">integerLiteral</span><span class="p">:</span> <span class="nv">$0</span><span class="p">))</span> <span class="p">??</span> <span class="s">&#34;&#34;</span>
    <span class="p">}</span>
    <span class="p">.</span><span class="n">sink</span><span class="p">(</span><span class="n">receiveValue</span><span class="p">:</span> <span class="p">{</span> <span class="bp">print</span><span class="p">(</span><span class="nv">$0</span><span class="p">)</span> <span class="p">})</span>
    <span class="p">.</span><span class="n">store</span><span class="p">(</span><span class="k">in</span><span class="p">:</span> <span class="p">&amp;</span><span class="n">subscriptions</span><span class="p">)</span>
<span class="p">}</span>

<span class="kd">struct</span> <span class="nc">Coordinate</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nv">x</span><span class="p">:</span> <span class="nb">Int</span>
    <span class="kd">var</span> <span class="nv">y</span><span class="p">:</span> <span class="nb">Int</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="nf">quadrantOf</span><span class="p">(</span><span class="n">x</span><span class="p">:</span> <span class="nb">Int</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="nb">Int</span><span class="p">)</span> <span class="p">-&gt;</span> <span class="nb">String</span> <span class="p">{</span>
    <span class="k">return</span> <span class="s">&#34;</span><span class="si">\(</span><span class="n">x</span> <span class="o">+</span> <span class="n">y</span><span class="si">)</span><span class="s">&#34;</span>
<span class="p">}</span>

<span class="n">example</span><span class="p">(</span><span class="n">of</span><span class="p">:</span> <span class="s">&#34;map key path&#34;</span><span class="p">)</span> <span class="p">{</span>
<span class="c1">//    • map&lt;T&gt;(_:)</span>
<span class="c1">//    • map&lt;T0, T1&gt;(_:_:)</span>
<span class="c1">//    • map&lt;T0, T1, T2&gt;(_:_:_:)</span>
    <span class="c1">// T 代表给定键路径中找到的值的类型</span>
    <span class="c1">// 象限（Quadrants）是坐标几何（coordinate geometry）的一部分。有关更多信息，请访问 mathworld.wolfram.com/Quadrant.html。</span>

    <span class="kd">let</span> <span class="nv">publisher</span> <span class="p">=</span> <span class="n">PassthroughSubject</span><span class="p">&lt;</span><span class="n">Coordinate</span><span class="p">,</span> <span class="n">Never</span><span class="p">&gt;()</span>

    <span class="n">publisher</span>
        <span class="p">.</span><span class="bp">map</span><span class="p">(</span><span class="err">\</span><span class="p">.</span><span class="n">x</span><span class="p">,</span> <span class="err">\</span><span class="p">.</span><span class="n">y</span><span class="p">)</span> <span class="c1">// 将 Coordinate keyPath map 出来(永远不会出错）</span>
        <span class="p">.</span><span class="n">sink</span><span class="p">(</span><span class="n">receiveValue</span><span class="p">:</span> <span class="p">{</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="k">in</span>
            <span class="bp">print</span><span class="p">(</span><span class="s">&#34;</span><span class="si">\(</span><span class="n">x</span><span class="si">)</span><span class="s"> + </span><span class="si">\(</span><span class="n">y</span><span class="si">)</span><span class="s"> =&#34;</span><span class="p">,</span> <span class="n">quadrantOf</span><span class="p">(</span><span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="n">y</span><span class="p">))</span>
        <span class="p">})</span>
    <span class="p">.</span><span class="n">store</span><span class="p">(</span><span class="k">in</span><span class="p">:</span> <span class="p">&amp;</span><span class="n">subscriptions</span><span class="p">)</span>

    <span class="n">publisher</span><span class="p">.</span><span class="n">send</span><span class="p">(</span><span class="n">Coordinate</span><span class="p">(</span><span class="n">x</span><span class="p">:</span> <span class="mi">10</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="o">-</span><span class="mi">8</span><span class="p">))</span>
    <span class="n">publisher</span><span class="p">.</span><span class="n">send</span><span class="p">(</span><span class="n">Coordinate</span><span class="p">(</span><span class="n">x</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="mi">5</span><span class="p">))</span>
<span class="p">}</span>

<span class="n">example</span><span class="p">(</span><span class="n">of</span><span class="p">:</span> <span class="s">&#34;tryMap(_:)&#34;</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// 尝试 map，出错时为 failure completion</span>
    <span class="n">Just</span><span class="p">(</span><span class="s">&#34;Directory name that does not exist&#34;</span><span class="p">)</span>
        <span class="p">.</span><span class="n">tryMap</span> <span class="p">{</span> <span class="k">try</span> <span class="n">FileManager</span><span class="p">.</span><span class="k">default</span><span class="p">.</span><span class="n">contentsOfDirectory</span><span class="p">(</span><span class="n">atPath</span><span class="p">:</span> <span class="nv">$0</span><span class="p">)</span> <span class="p">}</span>
        <span class="p">.</span><span class="n">sink</span><span class="p">(</span><span class="n">receiveCompletion</span><span class="p">:</span> <span class="p">{</span> <span class="bp">print</span><span class="p">(</span><span class="nv">$0</span><span class="p">)</span> <span class="p">},</span>
              <span class="n">receiveValue</span><span class="p">:</span> <span class="p">{</span> <span class="bp">print</span><span class="p">(</span><span class="nv">$0</span><span class="p">)</span> <span class="p">})</span>
        <span class="p">.</span><span class="n">store</span><span class="p">(</span><span class="k">in</span><span class="p">:</span> <span class="p">&amp;</span><span class="n">subscriptions</span><span class="p">)</span>
<span class="p">}</span>

<span class="kd">public</span> <span class="kd">struct</span> <span class="nc">Chatter</span> <span class="p">{</span>
  <span class="kd">public</span> <span class="kd">let</span> <span class="nv">name</span><span class="p">:</span> <span class="nb">String</span>
  <span class="kd">public</span> <span class="kd">let</span> <span class="nv">message</span><span class="p">:</span> <span class="n">CurrentValueSubject</span><span class="p">&lt;</span><span class="nb">String</span><span class="p">,</span> <span class="n">Never</span><span class="p">&gt;</span>

    <span class="kd">public</span> <span class="kd">init</span><span class="p">(</span><span class="n">name</span><span class="p">:</span> <span class="nb">String</span><span class="p">,</span> <span class="n">message</span><span class="p">:</span> <span class="nb">String</span><span class="p">)</span> <span class="p">{</span>
        <span class="kc">self</span><span class="p">.</span><span class="n">name</span> <span class="p">=</span> <span class="n">name</span>
        <span class="kc">self</span><span class="p">.</span><span class="n">message</span> <span class="p">=</span> <span class="n">CurrentValueSubject</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="n">example</span><span class="p">(</span><span class="n">of</span><span class="p">:</span> <span class="s">&#34;flattern&#34;</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// flattern 可用于将多个上游发布者摊平为一个下游发布者，或者特别的，将这些发布者的发射物摊平</span>

    <span class="c1">// 上游发布者接收到的类型与 flatMap 返回的发布者通常会不一致</span>
    <span class="c1">// 常用情况：当我们想订阅发布者发射的值，但这些值本身又是他们自己的发布者</span>

    <span class="kd">let</span> <span class="nv">charlotte</span> <span class="p">=</span> <span class="n">Chatter</span><span class="p">(</span><span class="n">name</span><span class="p">:</span> <span class="s">&#34;Charlotte&#34;</span><span class="p">,</span> <span class="n">message</span><span class="p">:</span> <span class="s">&#34;Hi I am Charlotte&#34;</span><span class="p">)</span>
    <span class="kd">let</span> <span class="nv">james</span> <span class="p">=</span> <span class="n">Chatter</span><span class="p">(</span><span class="n">name</span><span class="p">:</span> <span class="s">&#34;James&#34;</span><span class="p">,</span> <span class="n">message</span><span class="p">:</span> <span class="s">&#34;Hi I am James&#34;</span><span class="p">)</span>

    <span class="kd">let</span> <span class="nv">chat</span> <span class="p">=</span> <span class="n">CurrentValueSubject</span><span class="p">&lt;</span><span class="n">Chatter</span><span class="p">,</span> <span class="n">Never</span><span class="p">&gt;(</span><span class="n">charlotte</span><span class="p">)</span> <span class="c1">// 最初为 charlotte</span>

<span class="c1">//    chat</span>
<span class="c1">//        .sink(receiveValue: { print($0.message.value) })</span>
<span class="c1">//        .store(in: &amp;subscriptions)</span>

    <span class="n">chat</span>
        <span class="p">.</span><span class="n">flatMap</span> <span class="p">{</span> <span class="nv">$0</span><span class="p">.</span><span class="n">message</span> <span class="p">}</span> <span class="c1">// 转换为 message 的 发布者</span>
        <span class="p">.</span><span class="n">sink</span><span class="p">(</span><span class="n">receiveValue</span><span class="p">:</span> <span class="p">{</span> <span class="bp">print</span><span class="p">(</span><span class="nv">$0</span><span class="p">)</span> <span class="p">})</span>
        <span class="p">.</span><span class="n">store</span><span class="p">(</span><span class="k">in</span><span class="p">:</span> <span class="p">&amp;</span><span class="n">subscriptions</span><span class="p">)</span>

    <span class="c1">// messgae 变更也可触发（不做 flatMap 的时候是不可以的）</span>
    <span class="n">charlotte</span><span class="p">.</span><span class="n">message</span><span class="p">.</span><span class="n">value</span> <span class="p">=</span> <span class="s">&#34;Charlotte: How&#39;s it going?&#34;</span>

    <span class="c1">// 均可触发</span>
    <span class="n">chat</span><span class="p">.</span><span class="n">value</span> <span class="p">=</span> <span class="n">james</span>
<span class="p">}</span>

<span class="n">example</span><span class="p">(</span><span class="n">of</span><span class="p">:</span> <span class="s">&#34;flatMap(maxPublishers&#34;</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// flatMap 将所有接收到的发布者的输出压缩为一个发布者。</span>
    <span class="c1">// 这带来了内存问题，因为它将缓存与您发送的发布者一样多的发布者，以更新它在下游发出的单个发布者。</span>

    <span class="kd">let</span> <span class="nv">charlotte</span> <span class="p">=</span> <span class="n">Chatter</span><span class="p">(</span><span class="n">name</span><span class="p">:</span> <span class="s">&#34;Charlotte&#34;</span><span class="p">,</span> <span class="n">message</span><span class="p">:</span> <span class="s">&#34;Hi I am Charlotte&#34;</span><span class="p">)</span>
    <span class="kd">let</span> <span class="nv">james</span> <span class="p">=</span> <span class="n">Chatter</span><span class="p">(</span><span class="n">name</span><span class="p">:</span> <span class="s">&#34;James&#34;</span><span class="p">,</span> <span class="n">message</span><span class="p">:</span> <span class="s">&#34;Hi I am James&#34;</span><span class="p">)</span>

    <span class="kd">let</span> <span class="nv">chat</span> <span class="p">=</span> <span class="n">CurrentValueSubject</span><span class="p">&lt;</span><span class="n">Chatter</span><span class="p">,</span> <span class="n">Never</span><span class="p">&gt;(</span><span class="n">charlotte</span><span class="p">)</span> <span class="c1">// 最初发布者为 charlotte</span>

    <span class="n">chat</span>
        <span class="p">.</span><span class="n">flatMap</span><span class="p">(</span><span class="n">maxPublishers</span><span class="p">:</span> <span class="p">.</span><span class="bp">max</span><span class="p">(</span><span class="mi">2</span><span class="p">))</span> <span class="p">{</span> <span class="nv">$0</span><span class="p">.</span><span class="n">message</span> <span class="p">}</span> <span class="c1">// 最多接收上游 n 个发布者，其他将忽略，默认为无限</span>
        <span class="p">.</span><span class="n">sink</span><span class="p">(</span><span class="n">receiveValue</span><span class="p">:</span> <span class="p">{</span> <span class="bp">print</span><span class="p">(</span><span class="nv">$0</span><span class="p">)</span> <span class="p">})</span>
        <span class="p">.</span><span class="n">store</span><span class="p">(</span><span class="k">in</span><span class="p">:</span> <span class="p">&amp;</span><span class="n">subscriptions</span><span class="p">)</span>

    <span class="c1">// 更新第一个发布者</span>
    <span class="n">charlotte</span><span class="p">.</span><span class="n">message</span><span class="p">.</span><span class="n">value</span> <span class="p">=</span> <span class="s">&#34;Charlotte: How&#39;s it going?&#34;</span>

    <span class="c1">// 第二个发布者为 james</span>
    <span class="n">chat</span><span class="p">.</span><span class="n">value</span> <span class="p">=</span> <span class="n">james</span>

    <span class="c1">// 第三个发布者，但被忽略了</span>
    <span class="kd">let</span> <span class="nv">morgan</span> <span class="p">=</span> <span class="n">Chatter</span><span class="p">(</span><span class="n">name</span><span class="p">:</span> <span class="s">&#34;Morgan&#34;</span><span class="p">,</span>
                         <span class="n">message</span><span class="p">:</span> <span class="s">&#34;Hey guys, what are you up to?&#34;</span><span class="p">)</span>
    <span class="n">chat</span><span class="p">.</span><span class="n">value</span> <span class="p">=</span> <span class="n">morgan</span>

    <span class="c1">// 用的是 charlotte</span>
    <span class="n">charlotte</span><span class="p">.</span><span class="n">message</span><span class="p">.</span><span class="n">value</span> <span class="p">=</span> <span class="s">&#34;Did you hear something?&#34;</span>

<span class="c1">//Hi I am Charlotte</span>
<span class="c1">//Charlotte: How&#39;s it going?</span>
<span class="c1">//Hi I am James</span>
<span class="c1">//Did you hear something?</span>

<span class="p">}</span>

<span class="n">example</span><span class="p">(</span><span class="n">of</span><span class="p">:</span> <span class="s">&#34;replaceNil&#34;</span><span class="p">)</span> <span class="p">{</span>
    <span class="p">[</span><span class="s">&#34;A&#34;</span><span class="p">,</span> <span class="kc">nil</span><span class="p">,</span> <span class="s">&#34;B&#34;</span><span class="p">]</span>
        <span class="p">.</span><span class="n">publisher</span>
        <span class="p">.</span><span class="n">replaceNil</span><span class="p">(</span><span class="n">with</span><span class="p">:</span> <span class="s">&#34;-&#34;</span><span class="p">)</span> <span class="c1">// 只做替换，并不改变类型</span>
        <span class="p">.</span><span class="n">sink</span><span class="p">(</span><span class="n">receiveValue</span><span class="p">:</span> <span class="p">{</span> <span class="bp">print</span><span class="p">(</span><span class="nv">$0</span><span class="p">)</span> <span class="p">})</span>
        <span class="p">.</span><span class="n">store</span><span class="p">(</span><span class="k">in</span><span class="p">:</span> <span class="p">&amp;</span><span class="n">subscriptions</span><span class="p">)</span>

<span class="c1">//    Optional(&#34;A&#34;)</span>
<span class="c1">//    Optional(&#34;-&#34;)</span>
<span class="c1">//    Optional(&#34;B&#34;)</span>


    <span class="p">[</span><span class="s">&#34;A&#34;</span><span class="p">,</span> <span class="kc">nil</span><span class="p">,</span> <span class="s">&#34;B&#34;</span><span class="p">]</span>
        <span class="p">.</span><span class="n">publisher</span>
        <span class="p">.</span><span class="n">replaceNil</span><span class="p">(</span><span class="n">with</span><span class="p">:</span> <span class="s">&#34;-&#34;</span><span class="p">)</span>
        <span class="p">.</span><span class="bp">map</span> <span class="p">{</span> <span class="nv">$0</span><span class="p">!</span> <span class="p">}</span> <span class="c1">// 使用 map 转换类型（强制解包）</span>
        <span class="p">.</span><span class="n">sink</span><span class="p">(</span><span class="n">receiveValue</span><span class="p">:</span> <span class="p">{</span> <span class="bp">print</span><span class="p">(</span><span class="nv">$0</span><span class="p">)</span> <span class="p">})</span>
        <span class="p">.</span><span class="n">store</span><span class="p">(</span><span class="k">in</span><span class="p">:</span> <span class="p">&amp;</span><span class="n">subscriptions</span><span class="p">)</span>

<span class="c1">//    A</span>
<span class="c1">//    -</span>
<span class="c1">//    B</span>

    <span class="kd">let</span> <span class="nv">formatter</span> <span class="p">=</span> <span class="n">NumberFormatter</span><span class="p">()</span>
    <span class="n">formatter</span><span class="p">.</span><span class="n">numberStyle</span> <span class="p">=</span> <span class="p">.</span><span class="n">spellOut</span>

    <span class="p">[</span><span class="mi">123</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">56</span><span class="p">].</span><span class="n">publisher</span><span class="p">.</span><span class="bp">map</span> <span class="p">{</span>
        <span class="n">formatter</span><span class="p">.</span><span class="n">string</span><span class="p">(</span><span class="n">from</span><span class="p">:</span> <span class="n">NSNumber</span><span class="p">(</span><span class="n">integerLiteral</span><span class="p">:</span> <span class="nv">$0</span><span class="p">))</span> <span class="p">??</span> <span class="s">&#34;&#34;</span> <span class="c1">// ?? 可以返回另外一个可选类型，但 replaceNil 不可</span>
    <span class="p">}</span>
    <span class="p">.</span><span class="n">sink</span><span class="p">(</span><span class="n">receiveValue</span><span class="p">:</span> <span class="p">{</span> <span class="bp">print</span><span class="p">(</span><span class="nv">$0</span><span class="p">)</span> <span class="p">})</span>
    <span class="p">.</span><span class="n">store</span><span class="p">(</span><span class="k">in</span><span class="p">:</span> <span class="p">&amp;</span><span class="n">subscriptions</span><span class="p">)</span>

<span class="c1">//    [&#34;A&#34;, nil, &#34;B&#34;]</span>
<span class="c1">//    .publisher</span>
<span class="c1">//    .replaceNil(with: &#34;-&#34; as? String?)</span>
<span class="c1">//    .map { $0! } // 使用 map 转换类型（强制解包）</span>
<span class="c1">//    .sink(receiveValue: { print($0) })</span>
<span class="c1">//    .store(in: &amp;subscriptions)</span>
<span class="p">}</span>

<span class="n">example</span><span class="p">(</span><span class="n">of</span><span class="p">:</span> <span class="s">&#34;replaceEmpty(with:)&#34;</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// 空发布者，立即发出完成事件；也可通过传递 false 到 completeImmediately 中，从而不发射任何东西，默认为 true</span>
    <span class="c1">// 可用于测试或演示只有完成事件时</span>
<span class="c1">//    let empty = Empty&lt;Int, Never&gt;.init(completeImmediately: false)</span>
    <span class="kd">let</span> <span class="nv">empty</span> <span class="p">=</span> <span class="n">Empty</span><span class="p">&lt;</span><span class="nb">Int</span><span class="p">,</span> <span class="n">Never</span><span class="p">&gt;()</span>
    <span class="n">empty</span>
        <span class="p">.</span><span class="n">sink</span><span class="p">(</span><span class="n">receiveCompletion</span><span class="p">:</span> <span class="p">{</span> <span class="bp">print</span><span class="p">(</span><span class="nv">$0</span><span class="p">)</span> <span class="p">},</span>
              <span class="n">receiveValue</span><span class="p">:</span> <span class="p">{</span> <span class="bp">print</span><span class="p">(</span><span class="nv">$0</span><span class="p">)</span> <span class="p">})</span>
        <span class="p">.</span><span class="n">store</span><span class="p">(</span><span class="k">in</span><span class="p">:</span> <span class="p">&amp;</span><span class="n">subscriptions</span><span class="p">)</span>

<span class="c1">//    finished</span>


    <span class="n">empty</span>
        <span class="p">.</span><span class="n">replaceEmpty</span><span class="p">(</span><span class="n">with</span><span class="p">:</span> <span class="mi">1</span><span class="p">)</span> <span class="c1">// 替换空为发射 1</span>
        <span class="p">.</span><span class="n">sink</span><span class="p">(</span><span class="n">receiveCompletion</span><span class="p">:</span> <span class="p">{</span> <span class="bp">print</span><span class="p">(</span><span class="nv">$0</span><span class="p">)</span> <span class="p">},</span>
              <span class="n">receiveValue</span><span class="p">:</span> <span class="p">{</span> <span class="bp">print</span><span class="p">(</span><span class="nv">$0</span><span class="p">)</span> <span class="p">})</span>
        <span class="p">.</span><span class="n">store</span><span class="p">(</span><span class="k">in</span><span class="p">:</span> <span class="p">&amp;</span><span class="n">subscriptions</span><span class="p">)</span>

<span class="c1">//    1</span>
<span class="c1">//    finished</span>
<span class="p">}</span>

<span class="n">example</span><span class="p">(</span><span class="n">of</span><span class="p">:</span> <span class="s">&#34;scan&#34;</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// 计算属性，随机数</span>
    <span class="kd">var</span> <span class="nv">dailyGainLoss</span><span class="p">:</span> <span class="nb">Int</span> <span class="p">{</span>
        <span class="p">.</span><span class="n">random</span><span class="p">(</span><span class="k">in</span><span class="p">:</span> <span class="o">-</span><span class="mf">10.</span><span class="p">..</span><span class="mi">10</span><span class="p">)</span>
    <span class="p">}</span>

    <span class="kd">let</span> <span class="nv">august2019</span> <span class="p">=</span> <span class="p">(</span><span class="mf">0.</span><span class="p">.&lt;</span><span class="mi">22</span><span class="p">)</span>
        <span class="p">.</span><span class="bp">map</span> <span class="p">{</span> <span class="kc">_</span> <span class="k">in</span> <span class="n">dailyGainLoss</span> <span class="p">}</span> <span class="c1">// 数组</span>
        <span class="p">.</span><span class="n">publisher</span>

    <span class="n">august2019</span>
        <span class="c1">// 起始 50</span>
        <span class="p">.</span><span class="n">scan</span><span class="p">(</span><span class="mi">50</span><span class="p">)</span> <span class="p">{</span> <span class="n">latest</span><span class="p">,</span> <span class="n">current</span> <span class="k">in</span>
            <span class="bp">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">latest</span> <span class="o">+</span> <span class="n">current</span><span class="p">)</span> <span class="c1">// ➡️ 可预览</span>
        <span class="p">}</span>
    <span class="p">.</span><span class="n">sink</span><span class="p">(</span><span class="n">receiveValue</span><span class="p">:</span> <span class="p">{</span> <span class="kc">_</span> <span class="k">in</span> <span class="p">})</span> <span class="c1">// 不做操作</span>
<span class="c1">//    .sink(receiveCompletion: { print($0) },</span>
<span class="c1">//          receiveValue: { print($0) })</span>
    <span class="p">.</span><span class="n">store</span><span class="p">(</span><span class="k">in</span><span class="p">:</span> <span class="p">&amp;</span><span class="n">subscriptions</span><span class="p">)</span>


<span class="c1">//    •对发布者的输出执行操作的方法称为运算符。</span>
<span class="c1">//    •操作者也是发布者。</span>
<span class="c1">//使用任何缓冲值（例如collect或flatMap）的运算符时，请避免内存问题。</span>
<span class="c1">//    应用来自Swift标准库的现有功能知识时要谨记。 一些名称相似的Combine运算符的工作原理相同，而另一些则完全不同。</span>
    <span class="c1">// 操作符可以组合用于一个订阅</span>
<span class="p">}</span>

</code></pre></div><h2 id="4">4</h2>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-swift" data-lang="swift"><span class="kd">import</span> <span class="nc">Foundation</span>
<span class="kd">import</span> <span class="nc">Combine</span>

<span class="kd">var</span> <span class="nv">subscriptions</span> <span class="p">=</span> <span class="p">[</span><span class="n">AnyCancellable</span><span class="p">]()</span>

<span class="c1">// 带 try 的操作符，将提供 throw 的闭包，您在闭包内引发的任何错误都将以引发的错误终止发布者。</span>

<span class="kd">enum</span> <span class="nc">MyError</span><span class="p">:</span> <span class="n">Error</span> <span class="p">{</span>
    <span class="k">case</span> <span class="n">foo</span>
<span class="p">}</span>

<span class="n">example</span><span class="p">(</span><span class="n">of</span><span class="p">:</span> <span class="s">&#34;filter&#34;</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">let</span> <span class="nv">numbers</span> <span class="p">=</span> <span class="p">(</span><span class="mf">1.</span><span class="p">..</span><span class="mi">10</span><span class="p">).</span><span class="n">publisher</span>
        <span class="n">numbers</span><span class="p">.</span><span class="bp">filter</span> <span class="p">{</span>
            <span class="nv">$0</span><span class="p">.</span><span class="n">isMultiple</span><span class="p">(</span><span class="n">of</span><span class="p">:</span> <span class="mi">3</span><span class="p">)</span> <span class="c1">// 3 的倍数</span>
        <span class="p">}</span>
        <span class="p">.</span><span class="n">sink</span><span class="p">(</span><span class="n">receiveValue</span><span class="p">:</span> <span class="p">{</span>
            <span class="bp">print</span><span class="p">(</span><span class="nv">$0</span><span class="p">)</span>
        <span class="p">})</span>
        <span class="p">.</span><span class="n">store</span><span class="p">(</span><span class="k">in</span><span class="p">:</span> <span class="p">&amp;</span><span class="n">subscriptions</span><span class="p">)</span>

        <span class="c1">// ---</span>

        <span class="kd">func</span> <span class="nf">throwFunc</span><span class="p">(</span><span class="n">val</span><span class="p">:</span> <span class="nb">Int</span><span class="p">)</span> <span class="kr">throws</span> <span class="p">-&gt;</span> <span class="nb">Bool</span> <span class="p">{</span>
            <span class="k">if</span> <span class="n">val</span> <span class="o">%</span> <span class="mi">3</span> <span class="p">==</span> <span class="mi">0</span> <span class="p">{</span>
                <span class="k">return</span> <span class="kc">true</span>
            <span class="p">}</span>
            <span class="k">throw</span> <span class="n">MyError</span><span class="p">.</span><span class="n">foo</span>
        <span class="p">}</span>

        <span class="n">numbers</span>
            <span class="p">.</span><span class="n">tryFilter</span> <span class="p">{</span>
                <span class="k">try</span> <span class="n">throwFunc</span><span class="p">(</span><span class="n">val</span><span class="p">:</span> <span class="nv">$0</span><span class="p">)</span> <span class="c1">// 失败后，即结束</span>
        <span class="p">}</span>
            <span class="p">.</span><span class="n">sink</span><span class="p">(</span><span class="n">receiveCompletion</span><span class="p">:</span> <span class="p">{</span>
                <span class="bp">print</span><span class="p">(</span><span class="nv">$0</span><span class="p">)</span> <span class="c1">// failure(__lldb_expr_10.(unknown context at $1136214cc).(unknown context at $1136214d4).(unknown context at $1136214dc).MyError.foo)</span>
            <span class="p">},</span> <span class="n">receiveValue</span><span class="p">:</span> <span class="p">{</span>
                <span class="bp">print</span><span class="p">(</span><span class="nv">$0</span><span class="p">)</span>
            <span class="p">})</span>
            <span class="p">.</span><span class="n">store</span><span class="p">(</span><span class="k">in</span><span class="p">:</span> <span class="p">&amp;</span><span class="n">subscriptions</span><span class="p">)</span>
<span class="p">}</span>

<span class="n">example</span><span class="p">(</span><span class="n">of</span><span class="p">:</span> <span class="s">&#34;removeDuplicates&#34;</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">let</span> <span class="nv">words</span> <span class="p">=</span> <span class="s">&#34;a a a a b b b b&#34;</span> <span class="p">.</span><span class="n">components</span><span class="p">(</span><span class="n">separatedBy</span><span class="p">:</span> <span class="s">&#34; &#34;</span><span class="p">)</span>
        <span class="p">.</span><span class="n">publisher</span>

    <span class="n">words</span>
        <span class="p">.</span><span class="n">removeDuplicates</span><span class="p">()</span> <span class="c1">// 无需参数（遵守 Equable 协议）</span>
        <span class="p">.</span><span class="n">sink</span><span class="p">(</span><span class="n">receiveValue</span><span class="p">:</span> <span class="p">{</span> <span class="bp">print</span><span class="p">(</span><span class="nv">$0</span><span class="p">)</span> <span class="p">})</span>
        <span class="p">.</span><span class="n">store</span><span class="p">(</span><span class="k">in</span><span class="p">:</span> <span class="p">&amp;</span><span class="n">subscriptions</span><span class="p">)</span>

<span class="c1">//    a</span>
<span class="c1">//    b</span>

        <span class="n">words</span>
            <span class="p">.</span><span class="n">tryRemoveDuplicates</span><span class="p">(</span><span class="n">by</span><span class="p">:</span> <span class="p">{</span> <span class="bp">first</span><span class="p">,</span> <span class="n">second</span> <span class="p">-&gt;</span> <span class="nb">Bool</span> <span class="k">in</span>
                <span class="bp">print</span><span class="p">(</span><span class="bp">first</span><span class="p">,</span> <span class="n">second</span><span class="p">)</span>
<span class="c1">//                throw Error</span>
                <span class="k">return</span> <span class="kc">true</span>
            <span class="p">})</span>
            <span class="p">.</span><span class="n">sink</span><span class="p">(</span><span class="n">receiveCompletion</span><span class="p">:</span> <span class="p">{</span>
                <span class="bp">print</span><span class="p">(</span><span class="nv">$0</span><span class="p">)</span>
            <span class="p">},</span> <span class="n">receiveValue</span><span class="p">:</span> <span class="p">{</span>
                <span class="bp">print</span><span class="p">(</span><span class="nv">$0</span><span class="p">)</span>
            <span class="p">})</span>
            <span class="p">.</span><span class="n">store</span><span class="p">(</span><span class="k">in</span><span class="p">:</span> <span class="p">&amp;</span><span class="n">subscriptions</span><span class="p">)</span>
<span class="p">}</span>

<span class="n">example</span><span class="p">(</span><span class="n">of</span><span class="p">:</span> <span class="s">&#34;compactMap&#34;</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">let</span> <span class="nv">strings</span> <span class="p">=</span> <span class="p">[</span><span class="s">&#34;a&#34;</span><span class="p">,</span> <span class="s">&#34;1.24&#34;</span><span class="p">,</span> <span class="s">&#34;3&#34;</span><span class="p">,</span> <span class="s">&#34;def&#34;</span><span class="p">,</span> <span class="s">&#34;45&#34;</span><span class="p">,</span> <span class="s">&#34;0.23&#34;</span><span class="p">].</span><span class="n">publisher</span>

    <span class="n">strings</span>
        <span class="p">.</span><span class="n">compactMap</span> <span class="p">{</span>
            <span class="nb">Float</span><span class="p">(</span><span class="nv">$0</span><span class="p">)</span> <span class="c1">// 无法转换会返回 nil</span>
        <span class="p">}</span>
        <span class="p">.</span><span class="n">sink</span><span class="p">(</span><span class="n">receiveValue</span><span class="p">:</span> <span class="p">{</span>
            <span class="bp">print</span><span class="p">(</span><span class="nv">$0</span><span class="p">)</span>
        <span class="p">})</span>
        <span class="p">.</span><span class="n">store</span><span class="p">(</span><span class="k">in</span><span class="p">:</span> <span class="p">&amp;</span><span class="n">subscriptions</span><span class="p">)</span>
<span class="c1">//    1.24</span>
<span class="c1">//    3.0</span>
<span class="c1">//    45.0</span>
<span class="c1">//    0.23</span>

    <span class="kd">func</span> <span class="nf">throwFunc</span><span class="p">(</span><span class="n">val</span><span class="p">:</span> <span class="nb">String</span><span class="p">)</span> <span class="kr">throws</span> <span class="p">-&gt;</span> <span class="nb">Float</span><span class="p">?</span> <span class="p">{</span>
        <span class="k">if</span> <span class="kd">let</span> <span class="nv">fV</span> <span class="p">=</span> <span class="nb">Float</span><span class="p">(</span><span class="n">val</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">return</span> <span class="n">fV</span>
        <span class="p">}</span>

        <span class="k">throw</span> <span class="n">MyError</span><span class="p">.</span><span class="n">foo</span>
    <span class="p">}</span>

    <span class="n">strings</span>
        <span class="p">.</span><span class="n">tryCompactMap</span> <span class="p">{</span>
            <span class="k">try</span> <span class="n">throwFunc</span><span class="p">(</span><span class="n">val</span><span class="p">:</span> <span class="nv">$0</span><span class="p">)</span>
        <span class="p">}</span>
        <span class="p">.</span><span class="n">sink</span><span class="p">(</span><span class="n">receiveCompletion</span><span class="p">:</span> <span class="p">{</span>
            <span class="bp">print</span><span class="p">(</span><span class="nv">$0</span><span class="p">)</span>
        <span class="p">},</span> <span class="n">receiveValue</span><span class="p">:</span> <span class="p">{</span>
            <span class="bp">print</span><span class="p">(</span><span class="nv">$0</span><span class="p">)</span>
        <span class="p">})</span>
        <span class="p">.</span><span class="n">store</span><span class="p">(</span><span class="k">in</span><span class="p">:</span> <span class="p">&amp;</span><span class="n">subscriptions</span><span class="p">)</span>

    <span class="c1">// failure(__lldb_expr_1.MyError.foo)</span>
<span class="p">}</span>

<span class="n">example</span><span class="p">(</span><span class="n">of</span><span class="p">:</span> <span class="s">&#34;ignoreOutput&#34;</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">let</span> <span class="nv">numbers</span> <span class="p">=</span> <span class="p">(</span><span class="mf">1.</span><span class="p">..</span><span class="mi">10_000</span><span class="p">).</span><span class="n">publisher</span>

    <span class="n">numbers</span>
        <span class="p">.</span><span class="n">ignoreOutput</span><span class="p">()</span> <span class="c1">// 忽略值输出</span>
        <span class="p">.</span><span class="n">sink</span><span class="p">(</span><span class="n">receiveCompletion</span><span class="p">:</span> <span class="p">{</span> <span class="bp">print</span><span class="p">(</span><span class="nv">$0</span><span class="p">)</span> <span class="p">},</span>
              <span class="n">receiveValue</span><span class="p">:</span> <span class="p">{</span> <span class="bp">print</span><span class="p">(</span><span class="nv">$0</span><span class="p">)</span> <span class="p">})</span>
        <span class="p">.</span><span class="n">store</span><span class="p">(</span><span class="k">in</span><span class="p">:</span> <span class="p">&amp;</span><span class="n">subscriptions</span><span class="p">)</span>
<span class="c1">//    finished</span>
<span class="p">}</span>

<span class="n">example</span><span class="p">(</span><span class="n">of</span><span class="p">:</span> <span class="s">&#34;first(where:)&#34;</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">let</span> <span class="nv">numbers</span> <span class="p">=</span> <span class="p">(</span><span class="mf">1.</span><span class="p">..</span><span class="mi">9</span><span class="p">).</span><span class="n">publisher</span>

    <span class="n">numbers</span>
        <span class="p">.</span><span class="bp">print</span><span class="p">(</span><span class="s">&#34;numbers&#34;</span><span class="p">)</span>
        <span class="p">.</span><span class="bp">first</span><span class="p">(</span><span class="k">where</span><span class="p">:</span> <span class="p">{</span> <span class="nv">$0</span> <span class="o">%</span> <span class="mi">2</span> <span class="p">==</span> <span class="mi">0</span> <span class="p">})</span> <span class="c1">// 找到第一个即取消订阅并完成</span>
        <span class="p">.</span><span class="n">sink</span><span class="p">(</span><span class="n">receiveCompletion</span><span class="p">:</span> <span class="p">{</span> <span class="bp">print</span><span class="p">(</span><span class="nv">$0</span><span class="p">)</span> <span class="p">},</span>
              <span class="n">receiveValue</span><span class="p">:</span> <span class="p">{</span> <span class="bp">print</span><span class="p">(</span><span class="nv">$0</span><span class="p">)</span> <span class="p">})</span>
        <span class="p">.</span><span class="n">store</span><span class="p">(</span><span class="k">in</span><span class="p">:</span> <span class="p">&amp;</span><span class="n">subscriptions</span><span class="p">)</span>

<span class="c1">//    numbers: receive subscription: (1...9)</span>
<span class="c1">//    numbers: request unlimited</span>
<span class="c1">//    numbers: receive value: (1)</span>
<span class="c1">//    numbers: receive value: (2)</span>
<span class="c1">//    numbers: receive cancel</span>
<span class="c1">//    2</span>
<span class="p">}</span>


<span class="n">example</span><span class="p">(</span><span class="n">of</span><span class="p">:</span> <span class="s">&#34;last(where:)&#34;</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">let</span> <span class="nv">numbers</span> <span class="p">=</span> <span class="p">(</span><span class="mf">1.</span><span class="p">..</span><span class="mi">9</span><span class="p">).</span><span class="n">publisher</span>

    <span class="n">numbers</span>
        <span class="p">.</span><span class="bp">print</span><span class="p">(</span><span class="s">&#34;numbers&#34;</span><span class="p">)</span>
        <span class="p">.</span><span class="bp">last</span><span class="p">(</span><span class="k">where</span><span class="p">:</span> <span class="p">{</span> <span class="nv">$0</span> <span class="o">%</span> <span class="mi">2</span> <span class="p">==</span> <span class="mi">0</span> <span class="p">})</span> <span class="c1">// 需等待所有值发出完成后再执行</span>
        <span class="p">.</span><span class="n">sink</span><span class="p">(</span><span class="n">receiveCompletion</span><span class="p">:</span> <span class="p">{</span> <span class="bp">print</span><span class="p">(</span><span class="nv">$0</span><span class="p">)</span> <span class="p">},</span>
              <span class="n">receiveValue</span><span class="p">:</span> <span class="p">{</span> <span class="bp">print</span><span class="p">(</span><span class="nv">$0</span><span class="p">)</span> <span class="p">})</span>
        <span class="p">.</span><span class="n">store</span><span class="p">(</span><span class="k">in</span><span class="p">:</span> <span class="p">&amp;</span><span class="n">subscriptions</span><span class="p">)</span>

<span class="c1">//numbers: receive subscription: (1...9)</span>
<span class="c1">//numbers: request unlimited</span>
<span class="c1">//numbers: receive value: (1)</span>
<span class="c1">//numbers: receive value: (2)</span>
<span class="c1">//numbers: receive value: (3)</span>
<span class="c1">//numbers: receive value: (4)</span>
<span class="c1">//numbers: receive value: (5)</span>
<span class="c1">//numbers: receive value: (6)</span>
<span class="c1">//numbers: receive value: (7)</span>
<span class="c1">//numbers: receive value: (8)</span>
<span class="c1">//numbers: receive value: (9)</span>
<span class="c1">//numbers: receive finished</span>
<span class="c1">//8</span>
<span class="p">}</span>

<span class="n">example</span><span class="p">(</span><span class="n">of</span><span class="p">:</span> <span class="s">&#34;last(where:)&#34;</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">let</span> <span class="nv">numbers</span> <span class="p">=</span> <span class="n">PassthroughSubject</span><span class="p">&lt;</span><span class="nb">Int</span><span class="p">,</span> <span class="n">Never</span><span class="p">&gt;()</span>
    <span class="n">numbers</span>
        <span class="p">.</span><span class="bp">last</span><span class="p">(</span><span class="k">where</span><span class="p">:</span> <span class="p">{</span> <span class="nv">$0</span> <span class="o">%</span> <span class="mi">2</span> <span class="p">==</span> <span class="mi">0</span> <span class="p">})</span>
        <span class="p">.</span><span class="n">sink</span><span class="p">(</span><span class="n">receiveCompletion</span><span class="p">:</span> <span class="p">{</span> <span class="bp">print</span><span class="p">(</span><span class="nv">$0</span><span class="p">)</span> <span class="p">},</span>
              <span class="n">receiveValue</span><span class="p">:</span> <span class="p">{</span> <span class="bp">print</span><span class="p">(</span><span class="nv">$0</span><span class="p">)</span> <span class="p">})</span>
        <span class="p">.</span><span class="n">store</span><span class="p">(</span><span class="k">in</span><span class="p">:</span> <span class="p">&amp;</span><span class="n">subscriptions</span><span class="p">)</span>
    <span class="n">numbers</span><span class="p">.</span><span class="n">send</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">numbers</span><span class="p">.</span><span class="n">send</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">numbers</span><span class="p">.</span><span class="n">send</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
    <span class="n">numbers</span><span class="p">.</span><span class="n">send</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>
    <span class="n">numbers</span><span class="p">.</span><span class="n">send</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>

    <span class="c1">// 没有完成就不会执行</span>
<span class="c1">//    numbers.send(completion: .finished)</span>
<span class="p">}</span>


<span class="n">example</span><span class="p">(</span><span class="n">of</span><span class="p">:</span> <span class="s">&#34;drop&#34;</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">let</span> <span class="nv">numbers</span> <span class="p">=</span> <span class="p">(</span><span class="mf">1.</span><span class="p">..</span><span class="mi">5</span><span class="p">).</span><span class="n">publisher</span>

    <span class="n">numbers</span>
        <span class="p">.</span><span class="bp">dropFirst</span><span class="p">()</span> <span class="c1">// 抛弃第一个值</span>
        <span class="p">.</span><span class="n">sink</span><span class="p">(</span><span class="n">receiveCompletion</span><span class="p">:</span> <span class="p">{</span> <span class="bp">print</span><span class="p">(</span><span class="nv">$0</span><span class="p">)</span> <span class="p">},</span>
              <span class="n">receiveValue</span><span class="p">:</span> <span class="p">{</span> <span class="bp">print</span><span class="p">(</span><span class="nv">$0</span><span class="p">)</span> <span class="p">})</span>
        <span class="p">.</span><span class="n">store</span><span class="p">(</span><span class="k">in</span><span class="p">:</span> <span class="p">&amp;</span><span class="n">subscriptions</span><span class="p">)</span>

<span class="c1">//    ——— Example of: dropFirst ———</span>
<span class="c1">//    2</span>
<span class="c1">//    3</span>
<span class="c1">//    4</span>
<span class="c1">//    5</span>
<span class="c1">//    finished</span>
<span class="p">}</span>

<span class="n">example</span><span class="p">(</span><span class="n">of</span><span class="p">:</span> <span class="s">&#34;drop(while:)&#34;</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">let</span> <span class="nv">numbers</span> <span class="p">=</span> <span class="p">(</span><span class="mf">1.</span><span class="p">..</span><span class="mi">10</span><span class="p">).</span><span class="n">publisher</span>

    <span class="n">numbers</span>
    <span class="p">.</span><span class="n">drop</span><span class="p">(</span><span class="k">while</span><span class="p">:</span> <span class="p">{</span>
        <span class="bp">print</span><span class="p">(</span><span class="s">&#34;dropping&#34;</span><span class="p">)</span>
        <span class="k">return</span> <span class="nv">$0</span> <span class="o">%</span> <span class="mi">5</span> <span class="o">!=</span> <span class="mi">0</span>
    <span class="p">})</span> <span class="c1">// 条件成立时，丢弃，第一个不成立条件达成时，输出它以及后续的所有值（之后不再进入）</span>
        <span class="p">.</span><span class="n">sink</span><span class="p">(</span><span class="n">receiveValue</span><span class="p">:</span> <span class="p">{</span> <span class="bp">print</span><span class="p">(</span><span class="nv">$0</span><span class="p">)</span> <span class="p">})</span>
        <span class="p">.</span><span class="n">store</span><span class="p">(</span><span class="k">in</span><span class="p">:</span> <span class="p">&amp;</span><span class="n">subscriptions</span><span class="p">)</span>
<span class="c1">//    dropping</span>
<span class="c1">//    dropping</span>
<span class="c1">//    dropping</span>
<span class="c1">//    dropping</span>
<span class="c1">//    dropping</span>
<span class="c1">//    5</span>
<span class="c1">//    6</span>
<span class="c1">//    7</span>
<span class="c1">//    8</span>
<span class="c1">//    9</span>
<span class="c1">//    10</span>

    <span class="n">numbers</span>
        <span class="p">.</span><span class="bp">filter</span> <span class="p">{</span> <span class="nv">$0</span> <span class="o">%</span> <span class="mi">5</span> <span class="o">!=</span> <span class="mi">0</span> <span class="p">}</span>
        <span class="p">.</span><span class="n">sink</span><span class="p">(</span><span class="n">receiveValue</span><span class="p">:</span> <span class="p">{</span> <span class="bp">print</span><span class="p">(</span><span class="nv">$0</span><span class="p">)</span> <span class="p">})</span>
        <span class="p">.</span><span class="n">store</span><span class="p">(</span><span class="k">in</span><span class="p">:</span> <span class="p">&amp;</span><span class="n">subscriptions</span><span class="p">)</span>
<span class="c1">//    1</span>
<span class="c1">//    2</span>
<span class="c1">//    3</span>
<span class="c1">//    4</span>
<span class="c1">//    6</span>
<span class="c1">//    7</span>
<span class="c1">//    8</span>
<span class="c1">//    9</span>

    <span class="c1">// 与 filter 的区别：</span>
    <span class="c1">// 1. 闭包内返回 true 时，while 会跳过这些值，filter 则是允许通过</span>
    <span class="c1">// 2. filter 会在后续执行相同的过滤策略，而 while 则第一次满足后（返回 false）就不再过滤</span>
<span class="p">}</span>

<span class="n">example</span><span class="p">(</span><span class="n">of</span><span class="p">:</span> <span class="s">&#34;drop(untilOutputFrom:)&#34;</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// 如果我们想当一个发布者准备好的时候，再去接受另外一个发布者的值，就可以使用该操作者</span>
    <span class="kd">let</span> <span class="nv">isReady</span> <span class="p">=</span> <span class="n">PassthroughSubject</span><span class="p">&lt;</span><span class="nb">Void</span><span class="p">,</span> <span class="n">Never</span><span class="p">&gt;()</span>
    <span class="kd">let</span> <span class="nv">taps</span> <span class="p">=</span> <span class="n">PassthroughSubject</span><span class="p">&lt;</span><span class="nb">Int</span><span class="p">,</span> <span class="n">Never</span><span class="p">&gt;()</span>

    <span class="n">taps</span>
        <span class="p">.</span><span class="n">drop</span><span class="p">(</span><span class="n">untilOutputFrom</span><span class="p">:</span> <span class="n">isReady</span><span class="p">)</span> <span class="c1">// isReady 发射才开始接收</span>
        <span class="p">.</span><span class="n">sink</span><span class="p">(</span><span class="n">receiveValue</span><span class="p">:</span> <span class="p">{</span> <span class="bp">print</span><span class="p">(</span><span class="nv">$0</span><span class="p">)</span> <span class="p">})</span>
        <span class="p">.</span><span class="n">store</span><span class="p">(</span><span class="k">in</span><span class="p">:</span> <span class="p">&amp;</span><span class="n">subscriptions</span><span class="p">)</span>

    <span class="p">(</span><span class="mf">1.</span><span class="p">..</span><span class="mi">5</span><span class="p">).</span><span class="n">forEach</span> <span class="p">{</span> <span class="n">n</span> <span class="k">in</span>
        <span class="n">taps</span><span class="p">.</span><span class="n">send</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">n</span> <span class="p">==</span> <span class="mi">3</span> <span class="p">{</span>
<span class="c1">//            isReady.send(completion: .finished) 发射完成事件是不行的</span>
            <span class="n">isReady</span><span class="p">.</span><span class="n">send</span><span class="p">()</span> <span class="c1">// 发射</span>
        <span class="p">}</span>
    <span class="p">}</span>

<span class="c1">//    4</span>
<span class="c1">//    5</span>
<span class="p">}</span>

<span class="n">example</span><span class="p">(</span><span class="n">of</span><span class="p">:</span> <span class="s">&#34;prefix&#34;</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">let</span> <span class="nv">numbers</span> <span class="p">=</span> <span class="p">(</span><span class="mf">1.</span><span class="p">..</span><span class="mi">10</span><span class="p">).</span><span class="n">publisher</span>

    <span class="c1">// 类似 first 惰性，仅占用所需数量的值，即终止</span>
    <span class="n">numbers</span>
        <span class="p">.</span><span class="kr">prefix</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="c1">// 只接受前两个</span>
        <span class="p">.</span><span class="n">sink</span><span class="p">(</span><span class="n">receiveCompletion</span><span class="p">:</span> <span class="p">{</span> <span class="bp">print</span><span class="p">(</span><span class="nv">$0</span><span class="p">)</span> <span class="p">},</span>
              <span class="n">receiveValue</span><span class="p">:</span> <span class="p">{</span> <span class="bp">print</span><span class="p">(</span><span class="nv">$0</span><span class="p">)</span> <span class="p">})</span>
        <span class="p">.</span><span class="n">store</span><span class="p">(</span><span class="k">in</span><span class="p">:</span> <span class="p">&amp;</span><span class="n">subscriptions</span><span class="p">)</span>

<span class="c1">//    1</span>
<span class="c1">//    2</span>
<span class="c1">//    finished</span>

    <span class="n">numbers</span><span class="p">.</span><span class="kr">prefix</span><span class="p">(</span><span class="k">while</span><span class="p">:</span> <span class="p">{</span> <span class="nv">$0</span> <span class="o">&lt;</span> <span class="mi">3</span> <span class="p">})</span> <span class="c1">// 只接受小于 3 的前缀，当起始不满足，则直接 finished</span>
    <span class="p">.</span><span class="n">sink</span><span class="p">(</span><span class="n">receiveCompletion</span><span class="p">:</span> <span class="p">{</span> <span class="bp">print</span><span class="p">(</span><span class="nv">$0</span><span class="p">)</span> <span class="p">},</span>
          <span class="n">receiveValue</span><span class="p">:</span> <span class="p">{</span> <span class="bp">print</span><span class="p">(</span><span class="nv">$0</span><span class="p">)</span> <span class="p">})</span>
    <span class="p">.</span><span class="n">store</span><span class="p">(</span><span class="k">in</span><span class="p">:</span> <span class="p">&amp;</span><span class="n">subscriptions</span><span class="p">)</span>

<span class="c1">//    1</span>
<span class="c1">//    2</span>
<span class="c1">//    finished</span>
<span class="p">}</span>

<span class="n">example</span><span class="p">(</span><span class="n">of</span><span class="p">:</span> <span class="s">&#34;prefix(untilOutputFrom:)&#34;</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">let</span> <span class="nv">isReady</span> <span class="p">=</span> <span class="n">PassthroughSubject</span><span class="p">&lt;</span><span class="nb">Void</span><span class="p">,</span> <span class="n">Never</span><span class="p">&gt;()</span>
    <span class="kd">let</span> <span class="nv">taps</span> <span class="p">=</span> <span class="n">PassthroughSubject</span><span class="p">&lt;</span><span class="nb">Int</span><span class="p">,</span> <span class="n">Never</span><span class="p">&gt;()</span>

    <span class="n">taps</span>
        <span class="p">.</span><span class="kr">prefix</span><span class="p">(</span><span class="n">untilOutputFrom</span><span class="p">:</span> <span class="n">isReady</span><span class="p">)</span> <span class="c1">// 当 isReady 发出后不再可以发送</span>
        <span class="p">.</span><span class="n">sink</span><span class="p">(</span><span class="n">receiveCompletion</span><span class="p">:</span> <span class="p">{</span> <span class="bp">print</span><span class="p">(</span><span class="nv">$0</span><span class="p">)</span> <span class="p">},</span>
              <span class="n">receiveValue</span><span class="p">:</span> <span class="p">{</span> <span class="bp">print</span><span class="p">(</span><span class="nv">$0</span><span class="p">)</span> <span class="p">})</span>
        <span class="p">.</span><span class="n">store</span><span class="p">(</span><span class="k">in</span><span class="p">:</span> <span class="p">&amp;</span><span class="n">subscriptions</span><span class="p">)</span>

    <span class="p">(</span><span class="mf">1.</span><span class="p">..</span><span class="mi">5</span><span class="p">).</span><span class="n">forEach</span> <span class="p">{</span> <span class="n">n</span> <span class="k">in</span> <span class="n">taps</span><span class="p">.</span><span class="n">send</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">n</span> <span class="p">==</span> <span class="mi">2</span> <span class="p">{</span>
            <span class="n">isReady</span><span class="p">.</span><span class="n">send</span><span class="p">()</span> <span class="c1">// 发射</span>
        <span class="p">}</span>
    <span class="p">}</span>

<span class="c1">//    1</span>
<span class="c1">//    2</span>
<span class="c1">//    finished</span>


<span class="p">}</span>

<span class="n">example</span><span class="p">(</span><span class="n">of</span><span class="p">:</span> <span class="s">&#34;Challenge&#34;</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">let</span> <span class="nv">p</span> <span class="p">=</span> <span class="p">(</span><span class="mf">1.</span><span class="p">..</span><span class="mi">100</span><span class="p">).</span><span class="n">publisher</span>

    <span class="n">p</span>
        <span class="p">.</span><span class="n">drop</span><span class="p">(</span><span class="k">while</span><span class="p">:</span> <span class="p">{</span> <span class="nv">$0</span> <span class="o">&lt;</span> <span class="mi">50</span> <span class="p">})</span>
        <span class="p">.</span><span class="kr">prefix</span> <span class="p">{</span> <span class="nv">$0</span> <span class="o">&lt;=</span> <span class="mi">70</span> <span class="p">}</span>
        <span class="p">.</span><span class="bp">filter</span> <span class="p">{</span> <span class="nv">$0</span><span class="p">.</span><span class="n">isMultiple</span><span class="p">(</span><span class="n">of</span><span class="p">:</span> <span class="mi">2</span><span class="p">)</span> <span class="p">}</span>
        <span class="p">.</span><span class="n">sink</span><span class="p">(</span><span class="n">receiveCompletion</span><span class="p">:</span> <span class="p">{</span> <span class="bp">print</span><span class="p">(</span><span class="nv">$0</span><span class="p">)</span> <span class="p">},</span>
              <span class="n">receiveValue</span><span class="p">:</span> <span class="p">{</span> <span class="bp">print</span><span class="p">(</span><span class="nv">$0</span><span class="p">)</span> <span class="p">})</span>
        <span class="p">.</span><span class="n">store</span><span class="p">(</span><span class="k">in</span><span class="p">:</span> <span class="p">&amp;</span><span class="n">subscriptions</span><span class="p">)</span>

    <span class="c1">// 惰性：接收所需数量的值，然后完成</span>
    <span class="c1">// 贪婪：确定值的范围，再接收满足条件的值</span>
<span class="p">}</span>

</code></pre></div><h2 id="5">5</h2>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-swift" data-lang="swift"><span class="kd">import</span> <span class="nc">UIKit</span>
<span class="kd">import</span> <span class="nc">Combine</span>

<span class="kd">var</span> <span class="nv">subscriptions</span> <span class="p">=</span> <span class="p">[</span><span class="n">AnyCancellable</span><span class="p">]()</span>

<span class="kd">enum</span> <span class="nc">MyError</span><span class="p">:</span> <span class="n">Error</span> <span class="p">{</span>
    <span class="k">case</span> <span class="n">foo</span>
<span class="p">}</span>


<span class="n">example</span><span class="p">(</span><span class="n">of</span><span class="p">:</span> <span class="s">&#34;prepend(Output...)&#34;</span><span class="p">)</span> <span class="p">{</span>

    <span class="kd">let</span> <span class="nv">publisher</span> <span class="p">=</span> <span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">].</span><span class="n">publisher</span>

    <span class="n">publisher</span>
        <span class="p">.</span><span class="n">prepend</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="c1">// 可变参数，插入前置的值</span>
        <span class="p">.</span><span class="n">prepend</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="c1">// 插入上流的最前面</span>
        <span class="p">.</span><span class="n">sink</span><span class="p">(</span><span class="n">receiveValue</span><span class="p">:</span> <span class="p">{</span> <span class="bp">print</span><span class="p">(</span><span class="nv">$0</span><span class="p">)</span> <span class="p">})</span>
        <span class="p">.</span><span class="n">store</span><span class="p">(</span><span class="k">in</span><span class="p">:</span> <span class="p">&amp;</span><span class="n">subscriptions</span><span class="p">)</span>
<span class="c1">//-1</span>
<span class="c1">//0</span>
<span class="c1">//1</span>
<span class="c1">//2</span>
<span class="c1">//3</span>
<span class="c1">//4</span>
<span class="p">}</span>

<span class="n">example</span><span class="p">(</span><span class="n">of</span><span class="p">:</span> <span class="s">&#34;prepend(Sequence)&#34;</span><span class="p">)</span> <span class="p">{</span>

    <span class="kd">let</span> <span class="nv">publisher</span> <span class="p">=</span> <span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">].</span><span class="n">publisher</span>

    <span class="n">publisher</span>
        <span class="p">.</span><span class="n">prepend</span><span class="p">([</span><span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">])</span>
        <span class="p">.</span><span class="n">prepend</span><span class="p">(</span><span class="n">Set</span><span class="p">(</span><span class="mf">1.</span><span class="p">..</span><span class="mi">2</span><span class="p">))</span> <span class="c1">// 集合无序，可能 1，2 或 2，1</span>
        <span class="p">.</span><span class="n">prepend</span><span class="p">(</span><span class="bp">stride</span><span class="p">(</span><span class="n">from</span><span class="p">:</span> <span class="mi">6</span><span class="p">,</span> <span class="n">to</span><span class="p">:</span> <span class="mi">11</span><span class="p">,</span> <span class="n">by</span><span class="p">:</span> <span class="mi">2</span><span class="p">))</span>
        <span class="p">.</span><span class="n">sink</span><span class="p">(</span><span class="n">receiveValue</span><span class="p">:</span> <span class="p">{</span> <span class="bp">print</span><span class="p">(</span><span class="nv">$0</span><span class="p">)</span> <span class="p">})</span>
        <span class="p">.</span><span class="n">store</span><span class="p">(</span><span class="k">in</span><span class="p">:</span> <span class="p">&amp;</span><span class="n">subscriptions</span><span class="p">)</span>

<span class="p">}</span>

<span class="n">example</span><span class="p">(</span><span class="n">of</span><span class="p">:</span> <span class="s">&#34;prepend(Publisher)&#34;</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">let</span> <span class="nv">publisher1</span> <span class="p">=</span> <span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">].</span><span class="n">publisher</span>
    <span class="kd">let</span> <span class="nv">publisher2</span> <span class="p">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">].</span><span class="n">publisher</span>
<span class="c1">// 类型需相同</span>
    <span class="n">publisher1</span>
        <span class="p">.</span><span class="n">prepend</span><span class="p">(</span><span class="n">publisher2</span><span class="p">)</span> <span class="c1">// 插入发布者，当插入的发布者完成后才发出第二个</span>
        <span class="p">.</span><span class="n">sink</span><span class="p">(</span><span class="n">receiveCompletion</span><span class="p">:</span> <span class="p">{</span> <span class="bp">print</span><span class="p">(</span><span class="nv">$0</span><span class="p">)</span> <span class="p">},</span>
              <span class="n">receiveValue</span><span class="p">:</span> <span class="p">{</span> <span class="bp">print</span><span class="p">(</span><span class="nv">$0</span><span class="p">)</span> <span class="p">})</span>
        <span class="p">.</span><span class="n">store</span><span class="p">(</span><span class="k">in</span><span class="p">:</span> <span class="p">&amp;</span><span class="n">subscriptions</span><span class="p">)</span>

    <span class="kd">let</span> <span class="nv">publisher3</span> <span class="p">=</span> <span class="n">PassthroughSubject</span><span class="p">&lt;</span><span class="nb">Int</span><span class="p">,</span> <span class="n">MyError</span><span class="p">&gt;()</span>
    <span class="kd">let</span> <span class="nv">publisher4</span> <span class="p">=</span> <span class="n">PassthroughSubject</span><span class="p">&lt;</span><span class="nb">Int</span><span class="p">,</span> <span class="n">MyError</span><span class="p">&gt;()</span>

    <span class="n">publisher4</span>
    <span class="p">.</span><span class="n">prepend</span><span class="p">(</span><span class="n">publisher3</span><span class="p">)</span> <span class="c1">// publisher3 不结束，则 publisher4 不继续</span>
    <span class="p">.</span><span class="n">sink</span><span class="p">(</span><span class="n">receiveCompletion</span><span class="p">:</span> <span class="p">{</span> <span class="bp">print</span><span class="p">(</span><span class="nv">$0</span><span class="p">)</span> <span class="p">},</span>
          <span class="n">receiveValue</span><span class="p">:</span> <span class="p">{</span> <span class="bp">print</span><span class="p">(</span><span class="nv">$0</span><span class="p">)</span> <span class="p">})</span>
        <span class="p">.</span><span class="n">store</span><span class="p">(</span><span class="k">in</span><span class="p">:</span> <span class="p">&amp;</span><span class="n">subscriptions</span><span class="p">)</span>

    <span class="n">publisher4</span><span class="p">.</span><span class="n">send</span><span class="p">(</span><span class="mi">11</span><span class="p">)</span>
    <span class="n">publisher4</span><span class="p">.</span><span class="n">send</span><span class="p">(</span><span class="mi">22</span><span class="p">)</span>

    <span class="n">publisher3</span><span class="p">.</span><span class="n">send</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">publisher3</span><span class="p">.</span><span class="n">send</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">publisher3</span><span class="p">.</span><span class="n">send</span><span class="p">(</span><span class="n">completion</span><span class="p">:</span> <span class="p">.</span><span class="n">finished</span><span class="p">)</span> <span class="c1">// 完成后，4 开始</span>

    <span class="n">publisher4</span><span class="p">.</span><span class="n">send</span><span class="p">(</span><span class="mi">33</span><span class="p">)</span>
    <span class="n">publisher4</span><span class="p">.</span><span class="n">send</span><span class="p">(</span><span class="mi">44</span><span class="p">)</span>
<span class="c1">//    publisher3.send(completion: .failure(.foo)) // Error 则也停止</span>

<span class="c1">//    1</span>
<span class="c1">//    2</span>
<span class="c1">//    33</span>
<span class="c1">//    44</span>
<span class="p">}</span>

<span class="n">example</span><span class="p">(</span><span class="n">of</span><span class="p">:</span> <span class="s">&#34;append(Output...)&#34;</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">let</span> <span class="nv">publisher</span> <span class="p">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">publisher</span>

    <span class="n">publisher</span>
        <span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
        <span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>
        <span class="p">.</span><span class="n">sink</span><span class="p">(</span><span class="n">receiveValue</span><span class="p">:</span> <span class="p">{</span> <span class="bp">print</span><span class="p">(</span><span class="nv">$0</span><span class="p">)</span> <span class="p">})</span>
        <span class="p">.</span><span class="n">store</span><span class="p">(</span><span class="k">in</span><span class="p">:</span> <span class="p">&amp;</span><span class="n">subscriptions</span><span class="p">)</span>

<span class="c1">//    1</span>
<span class="c1">//    2</span>
<span class="c1">//    3</span>
<span class="c1">//    4</span>
<span class="p">}</span>

<span class="n">example</span><span class="p">(</span><span class="n">of</span><span class="p">:</span> <span class="s">&#34;append(Output...) #2&#34;</span><span class="p">)</span> <span class="p">{</span> <span class="c1">// 1</span>
    <span class="kd">let</span> <span class="nv">publisher</span> <span class="p">=</span> <span class="n">PassthroughSubject</span><span class="p">&lt;</span><span class="nb">Int</span><span class="p">,</span> <span class="n">Never</span><span class="p">&gt;()</span>
    <span class="n">publisher</span>
        <span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>
        <span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
        <span class="p">.</span><span class="n">sink</span><span class="p">(</span><span class="n">receiveValue</span><span class="p">:</span> <span class="p">{</span> <span class="bp">print</span><span class="p">(</span><span class="nv">$0</span><span class="p">)</span> <span class="p">})</span>
        <span class="p">.</span><span class="n">store</span><span class="p">(</span><span class="k">in</span><span class="p">:</span> <span class="p">&amp;</span><span class="n">subscriptions</span><span class="p">)</span>

    <span class="n">publisher</span><span class="p">.</span><span class="n">send</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">publisher</span><span class="p">.</span><span class="n">send</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
    <span class="c1">// 只有 publisher 完成，append 才会附加</span>
    <span class="n">publisher</span><span class="p">.</span><span class="n">send</span><span class="p">(</span><span class="n">completion</span><span class="p">:</span> <span class="p">.</span><span class="n">finished</span><span class="p">)</span>

<span class="c1">//    1</span>
<span class="c1">//    2</span>
<span class="c1">//    3</span>
<span class="c1">//    4</span>
<span class="c1">//    5</span>
<span class="p">}</span>

<span class="n">example</span><span class="p">(</span><span class="n">of</span><span class="p">:</span> <span class="s">&#34;append(Sequence)&#34;</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">let</span> <span class="nv">publisher</span> <span class="p">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">].</span><span class="n">publisher</span>
    <span class="n">publisher</span>
        <span class="p">.</span><span class="n">append</span><span class="p">([</span><span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">])</span>
        <span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">Set</span><span class="p">([</span><span class="mi">6</span><span class="p">,</span> <span class="mi">7</span><span class="p">]))</span> <span class="c1">// 注意集合无序</span>
        <span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="bp">stride</span><span class="p">(</span><span class="n">from</span><span class="p">:</span> <span class="mi">8</span><span class="p">,</span> <span class="n">to</span><span class="p">:</span> <span class="mi">11</span><span class="p">,</span> <span class="n">by</span><span class="p">:</span> <span class="mi">2</span><span class="p">))</span>
        <span class="p">.</span><span class="n">sink</span><span class="p">(</span><span class="n">receiveValue</span><span class="p">:</span> <span class="p">{</span> <span class="bp">print</span><span class="p">(</span><span class="nv">$0</span><span class="p">)</span> <span class="p">})</span>
        <span class="p">.</span><span class="n">store</span><span class="p">(</span><span class="k">in</span><span class="p">:</span> <span class="p">&amp;</span><span class="n">subscriptions</span><span class="p">)</span>

<span class="c1">//    1</span>
<span class="c1">//    2</span>
<span class="c1">//    3</span>
<span class="c1">//    4</span>
<span class="c1">//    5</span>
<span class="c1">//    7</span>
<span class="c1">//    6</span>
<span class="c1">//    8</span>
<span class="c1">//    10</span>
<span class="p">}</span>

<span class="n">example</span><span class="p">(</span><span class="n">of</span><span class="p">:</span> <span class="s">&#34;append(Publisher)&#34;</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">let</span> <span class="nv">publisher1</span> <span class="p">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">].</span><span class="n">publisher</span>
    <span class="kd">let</span> <span class="nv">publisher2</span> <span class="p">=</span> <span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">].</span><span class="n">publisher</span>

    <span class="n">publisher1</span>
        <span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">publisher2</span><span class="p">)</span>
        <span class="p">.</span><span class="n">sink</span><span class="p">(</span><span class="n">receiveValue</span><span class="p">:</span> <span class="p">{</span> <span class="bp">print</span><span class="p">(</span><span class="nv">$0</span><span class="p">)</span> <span class="p">})</span>
        <span class="p">.</span><span class="n">store</span><span class="p">(</span><span class="k">in</span><span class="p">:</span> <span class="p">&amp;</span><span class="n">subscriptions</span><span class="p">)</span>
<span class="p">}</span>

<span class="n">example</span><span class="p">(</span><span class="n">of</span><span class="p">:</span> <span class="s">&#34;switchToLatest&#34;</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">let</span> <span class="nv">publisher1</span> <span class="p">=</span> <span class="n">PassthroughSubject</span><span class="p">&lt;</span><span class="nb">Int</span><span class="p">,</span> <span class="n">Never</span><span class="p">&gt;()</span>
    <span class="kd">let</span> <span class="nv">publisher2</span> <span class="p">=</span> <span class="n">PassthroughSubject</span><span class="p">&lt;</span><span class="nb">Int</span><span class="p">,</span> <span class="n">Never</span><span class="p">&gt;()</span>
    <span class="kd">let</span> <span class="nv">publisher3</span> <span class="p">=</span> <span class="n">PassthroughSubject</span><span class="p">&lt;</span><span class="nb">Int</span><span class="p">,</span> <span class="n">Never</span><span class="p">&gt;()</span>

    <span class="kd">let</span> <span class="nv">publishers</span> <span class="p">=</span> <span class="n">PassthroughSubject</span><span class="p">&lt;</span><span class="n">PassthroughSubject</span><span class="p">&lt;</span><span class="nb">Int</span><span class="p">,</span> <span class="n">Never</span><span class="p">&gt;,</span> <span class="n">Never</span><span class="p">&gt;()</span>

    <span class="n">publishers</span>
        <span class="p">.</span><span class="n">switchToLatest</span><span class="p">()</span> <span class="c1">// 只能用于发布发布者的发布者上</span>
        <span class="p">.</span><span class="n">sink</span><span class="p">(</span><span class="n">receiveCompletion</span><span class="p">:</span> <span class="p">{</span> <span class="kc">_</span> <span class="k">in</span> <span class="bp">print</span><span class="p">(</span><span class="s">&#34;Completed!&#34;</span><span class="p">)</span> <span class="p">},</span>
              <span class="n">receiveValue</span><span class="p">:</span> <span class="p">{</span> <span class="bp">print</span><span class="p">(</span><span class="nv">$0</span><span class="p">)</span> <span class="p">})</span>
        <span class="p">.</span><span class="n">store</span><span class="p">(</span><span class="k">in</span><span class="p">:</span> <span class="p">&amp;</span><span class="n">subscriptions</span><span class="p">)</span>

    <span class="n">publishers</span><span class="p">.</span><span class="n">send</span><span class="p">(</span><span class="n">publisher1</span><span class="p">)</span>
    <span class="n">publisher1</span><span class="p">.</span><span class="n">send</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">publisher1</span><span class="p">.</span><span class="n">send</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>

    <span class="n">publishers</span><span class="p">.</span><span class="n">send</span><span class="p">(</span><span class="n">publisher2</span><span class="p">)</span>
    <span class="n">publisher1</span><span class="p">.</span><span class="n">send</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="c1">// 已经切换到 publisher2，忽略 publisher1</span>
    <span class="n">publisher2</span><span class="p">.</span><span class="n">send</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>
    <span class="n">publisher2</span><span class="p">.</span><span class="n">send</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>

    <span class="n">publishers</span><span class="p">.</span><span class="n">send</span><span class="p">(</span><span class="n">publisher3</span><span class="p">)</span>
    <span class="n">publisher2</span><span class="p">.</span><span class="n">send</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span>  <span class="c1">// 已经切换到 publisher3，忽略 publisher2</span>
    <span class="n">publisher3</span><span class="p">.</span><span class="n">send</span><span class="p">(</span><span class="mi">7</span><span class="p">)</span>
    <span class="n">publisher3</span><span class="p">.</span><span class="n">send</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span>
    <span class="n">publisher3</span><span class="p">.</span><span class="n">send</span><span class="p">(</span><span class="mi">9</span><span class="p">)</span>

    <span class="n">publisher3</span><span class="p">.</span><span class="n">send</span><span class="p">(</span><span class="n">completion</span><span class="p">:</span> <span class="p">.</span><span class="n">finished</span><span class="p">)</span>
    <span class="n">publishers</span><span class="p">.</span><span class="n">send</span><span class="p">(</span><span class="n">completion</span><span class="p">:</span> <span class="p">.</span><span class="n">finished</span><span class="p">)</span>

    <span class="c1">// 用途，用户点击按钮就会发送请求，再次点击触发新的请求，那么就可以用 switchToLatest 切换到只处理最新的请求</span>
<span class="p">}</span>

<span class="c1">//example(of: &#34;switchToLatest - Network Request&#34;) {</span>
<span class="c1">//    let url = URL(string: &#34;https://source.unsplash.com/random&#34;)!</span>
<span class="c1">//</span>
<span class="c1">//    func getImage() -&gt; AnyPublisher&lt;UIImage?, Never&gt; {</span>
<span class="c1">//        return URLSession.shared</span>
<span class="c1">//            .dataTaskPublisher(for: url) // URLSession 的 Combine 扩展</span>
<span class="c1">//            .map { data, _ in UIImage(data: data) }</span>
<span class="c1">//            .print(&#34;image&#34;)</span>
<span class="c1">//            .replaceError(with: nil) // 替代 error</span>
<span class="c1">//            .eraseToAnyPublisher() // 类型擦除</span>
<span class="c1">//    }</span>
<span class="c1">//</span>
<span class="c1">//    let taps = PassthroughSubject&lt;Void, Never&gt;()</span>
<span class="c1">//    taps</span>
<span class="c1">//        .map { _ in getImage() }</span>
<span class="c1">//        .switchToLatest()</span>
<span class="c1">//        .sink(receiveValue: { _ in })</span>
<span class="c1">//        .store(in: &amp;subscriptions)</span>
<span class="c1">//    taps.send()</span>
<span class="c1">//</span>
<span class="c1">//    DispatchQueue.main.asyncAfter(deadline: .now() + 3) {</span>
<span class="c1">//        taps.send()</span>
<span class="c1">//    }</span>
<span class="c1">//</span>
<span class="c1">//    DispatchQueue.main.asyncAfter(deadline: .now() + 3.1) {</span>
<span class="c1">//        taps.send()</span>
<span class="c1">//    }</span>
<span class="c1">//</span>
<span class="c1">////    ——— Example of: switchToLatest - Network Request ———</span>
<span class="c1">////    image: receive subscription: (DataTaskPublisher)</span>
<span class="c1">////    image: request unlimited</span>
<span class="c1">////    image: receive cancel // 被取消</span>
<span class="c1">////    image: receive subscription: (DataTaskPublisher)</span>
<span class="c1">////    image: request unlimited</span>
<span class="c1">////    image: receive cancel // 被取消</span>
<span class="c1">////    image: receive subscription: (DataTaskPublisher)</span>
<span class="c1">////    image: request unlimited</span>
<span class="c1">////    image: receive value: (Optional(&lt;UIImage:0x600001beca20 anonymous {1080, 1350}&gt;))</span>
<span class="c1">////    image: receive finished</span>
<span class="c1">//}</span>

<span class="n">example</span><span class="p">(</span><span class="n">of</span><span class="p">:</span> <span class="s">&#34;merge&#34;</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">let</span> <span class="nv">pub1</span> <span class="p">=</span> <span class="n">PassthroughSubject</span><span class="p">&lt;</span><span class="nb">Int</span><span class="p">,</span> <span class="n">Never</span><span class="p">&gt;()</span>
    <span class="kd">let</span> <span class="nv">pub2</span> <span class="p">=</span> <span class="n">PassthroughSubject</span><span class="p">&lt;</span><span class="nb">Int</span><span class="p">,</span> <span class="n">Never</span><span class="p">&gt;()</span>

    <span class="c1">// 最多合并 8 个</span>
<span class="c1">//    pub2.merge(with: &lt;#T##Publisher#&gt;, &lt;#T##c: Publisher##Publisher#&gt;, &lt;#T##d: Publisher##Publisher#&gt;, &lt;#T##e: Publisher##Publisher#&gt;, &lt;#T##f: Publisher##Publisher#&gt;, &lt;#T##g: Publisher##Publisher#&gt;, &lt;#T##h: Publisher##Publisher#&gt;)</span>
    <span class="n">pub2</span><span class="p">.</span><span class="n">merge</span><span class="p">(</span><span class="n">with</span><span class="p">:</span> <span class="n">pub1</span><span class="p">)</span>
        <span class="p">.</span><span class="n">sink</span><span class="p">(</span><span class="n">receiveCompletion</span><span class="p">:</span> <span class="p">{</span> <span class="kc">_</span> <span class="k">in</span>
        <span class="bp">print</span><span class="p">(</span><span class="s">&#34;completion&#34;</span><span class="p">)</span>
    <span class="p">},</span> <span class="n">receiveValue</span><span class="p">:</span> <span class="p">{</span> <span class="bp">print</span><span class="p">(</span><span class="nv">$0</span><span class="p">)</span> <span class="p">})</span>
        <span class="p">.</span><span class="n">store</span><span class="p">(</span><span class="k">in</span><span class="p">:</span> <span class="p">&amp;</span><span class="n">subscriptions</span><span class="p">)</span>

    <span class="n">pub1</span><span class="p">.</span><span class="n">send</span><span class="p">(</span><span class="mi">11</span><span class="p">)</span>
    <span class="n">pub2</span><span class="p">.</span><span class="n">send</span><span class="p">(</span><span class="mi">22</span><span class="p">)</span>
    <span class="n">pub1</span><span class="p">.</span><span class="n">send</span><span class="p">(</span><span class="mi">13</span><span class="p">)</span>
    <span class="n">pub2</span><span class="p">.</span><span class="n">send</span><span class="p">(</span><span class="mi">24</span><span class="p">)</span>

    <span class="n">pub1</span><span class="p">.</span><span class="n">send</span><span class="p">(</span><span class="n">completion</span><span class="p">:</span> <span class="p">.</span><span class="n">finished</span><span class="p">)</span>

    <span class="n">pub2</span><span class="p">.</span><span class="n">send</span><span class="p">(</span><span class="mi">25</span><span class="p">)</span>

    <span class="n">pub2</span><span class="p">.</span><span class="n">send</span><span class="p">(</span><span class="n">completion</span><span class="p">:</span> <span class="p">.</span><span class="n">finished</span><span class="p">)</span> <span class="c1">// 以最后一个结束为整个结束</span>

<span class="c1">//11</span>
<span class="c1">//22</span>
<span class="c1">//13</span>
<span class="c1">//24</span>
<span class="c1">//25</span>
<span class="c1">//completion</span>
<span class="p">}</span>

<span class="n">example</span><span class="p">(</span><span class="n">of</span><span class="p">:</span> <span class="s">&#34;combineLatest&#34;</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// combineLatest 可组合多个发布者，当其中任何一个发出值时，都会发布一个具有所有发布者最新值的元组</span>

    <span class="kd">let</span> <span class="nv">pub1</span> <span class="p">=</span> <span class="n">PassthroughSubject</span><span class="p">&lt;</span><span class="nb">Int</span><span class="p">,</span> <span class="n">Never</span><span class="p">&gt;()</span>
    <span class="kd">let</span> <span class="nv">pub2</span> <span class="p">=</span> <span class="n">PassthroughSubject</span><span class="p">&lt;</span><span class="nb">String</span><span class="p">,</span> <span class="n">Never</span><span class="p">&gt;()</span>

    <span class="n">pub1</span><span class="p">.</span><span class="n">combineLatest</span><span class="p">(</span><span class="n">pub2</span><span class="p">)</span>
        <span class="p">.</span><span class="n">sink</span><span class="p">(</span><span class="n">receiveCompletion</span><span class="p">:</span> <span class="p">{</span> <span class="bp">print</span><span class="p">(</span><span class="s">&#34;completion&#34;</span><span class="p">,</span> <span class="nv">$0</span><span class="p">)</span> <span class="p">},</span>
              <span class="n">receiveValue</span><span class="p">:</span> <span class="p">{</span> <span class="bp">print</span><span class="p">(</span><span class="nv">$0</span><span class="p">)</span> <span class="p">})</span>
        <span class="p">.</span><span class="n">store</span><span class="p">(</span><span class="k">in</span><span class="p">:</span> <span class="p">&amp;</span><span class="n">subscriptions</span><span class="p">)</span>

    <span class="n">pub1</span><span class="p">.</span><span class="n">send</span><span class="p">(</span><span class="mi">11</span><span class="p">)</span> <span class="c1">// combineLatest 首次需等待另一个发布者发布才会一同发布</span>
    <span class="n">pub1</span><span class="p">.</span><span class="n">send</span><span class="p">(</span><span class="mi">12</span><span class="p">)</span>
    <span class="n">pub2</span><span class="p">.</span><span class="n">send</span><span class="p">(</span><span class="s">&#34;23&#34;</span><span class="p">)</span>
    <span class="n">pub1</span><span class="p">.</span><span class="n">send</span><span class="p">(</span><span class="mi">14</span><span class="p">)</span>
    <span class="n">pub2</span><span class="p">.</span><span class="n">send</span><span class="p">(</span><span class="s">&#34;25&#34;</span><span class="p">)</span>

    <span class="n">pub1</span><span class="p">.</span><span class="n">send</span><span class="p">(</span><span class="n">completion</span><span class="p">:</span> <span class="p">.</span><span class="n">finished</span><span class="p">)</span>

    <span class="n">pub2</span><span class="p">.</span><span class="n">send</span><span class="p">(</span><span class="s">&#34;26&#34;</span><span class="p">)</span>

    <span class="n">pub2</span><span class="p">.</span><span class="n">send</span><span class="p">(</span><span class="n">completion</span><span class="p">:</span> <span class="p">.</span><span class="n">finished</span><span class="p">)</span> <span class="c1">// 以最后一个结束为整个结束</span>

<span class="c1">//    (12, &#34;23&#34;)</span>
<span class="c1">//    (14, &#34;23&#34;)</span>
<span class="c1">//    (14, &#34;25&#34;)</span>
<span class="c1">//    (14, &#34;26&#34;)</span>
<span class="c1">//    completion finished</span>
<span class="p">}</span>

<span class="n">example</span><span class="p">(</span><span class="n">of</span><span class="p">:</span> <span class="s">&#34;zip&#34;</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">let</span> <span class="nv">pub1</span> <span class="p">=</span> <span class="n">PassthroughSubject</span><span class="p">&lt;</span><span class="nb">Int</span><span class="p">,</span> <span class="n">Never</span><span class="p">&gt;()</span>
    <span class="kd">let</span> <span class="nv">pub2</span> <span class="p">=</span> <span class="n">PassthroughSubject</span><span class="p">&lt;</span><span class="nb">String</span><span class="p">,</span> <span class="n">Never</span><span class="p">&gt;()</span>

    <span class="n">pub1</span><span class="p">.</span><span class="n">zip</span><span class="p">(</span><span class="n">pub2</span><span class="p">)</span>
    <span class="p">.</span><span class="n">sink</span><span class="p">(</span><span class="n">receiveCompletion</span><span class="p">:</span> <span class="p">{</span> <span class="bp">print</span><span class="p">(</span><span class="s">&#34;completion&#34;</span><span class="p">,</span> <span class="nv">$0</span><span class="p">)</span> <span class="p">},</span>
          <span class="n">receiveValue</span><span class="p">:</span> <span class="p">{</span> <span class="bp">print</span><span class="p">(</span><span class="nv">$0</span><span class="p">)</span> <span class="p">})</span>
    <span class="p">.</span><span class="n">store</span><span class="p">(</span><span class="k">in</span><span class="p">:</span> <span class="p">&amp;</span><span class="n">subscriptions</span><span class="p">)</span>

    <span class="n">pub1</span><span class="p">.</span><span class="n">send</span><span class="p">(</span><span class="mi">11</span><span class="p">)</span>
    <span class="n">pub1</span><span class="p">.</span><span class="n">send</span><span class="p">(</span><span class="mi">12</span><span class="p">)</span>
    <span class="n">pub2</span><span class="p">.</span><span class="n">send</span><span class="p">(</span><span class="s">&#34;23&#34;</span><span class="p">)</span> <span class="c1">// 取和他同为第一个的 11</span>
    <span class="n">pub1</span><span class="p">.</span><span class="n">send</span><span class="p">(</span><span class="mi">14</span><span class="p">)</span>
    <span class="n">pub2</span><span class="p">.</span><span class="n">send</span><span class="p">(</span><span class="s">&#34;25&#34;</span><span class="p">)</span> <span class="c1">// 取和他同为第二个的 12</span>

    <span class="n">pub1</span><span class="p">.</span><span class="n">send</span><span class="p">(</span><span class="n">completion</span><span class="p">:</span> <span class="p">.</span><span class="n">finished</span><span class="p">)</span>

    <span class="n">pub2</span><span class="p">.</span><span class="n">send</span><span class="p">(</span><span class="s">&#34;26&#34;</span><span class="p">)</span> <span class="c1">// 取和他同为第三个的 14</span>
    <span class="n">pub2</span><span class="p">.</span><span class="n">send</span><span class="p">(</span><span class="s">&#34;27&#34;</span><span class="p">)</span> <span class="c1">// 没有和他同一个的 pub1 了，就不输出</span>

    <span class="n">pub2</span><span class="p">.</span><span class="n">send</span><span class="p">(</span><span class="n">completion</span><span class="p">:</span> <span class="p">.</span><span class="n">finished</span><span class="p">)</span> <span class="c1">// 以最后一个结束为整个结束</span>

<span class="c1">//    ——— Example of: zip ———</span>
<span class="c1">//    (11, &#34;23&#34;)</span>
<span class="c1">//    (12, &#34;25&#34;)</span>
<span class="c1">//    (14, &#34;26&#34;)</span>
<span class="c1">//    completion finished</span>

<span class="c1">//    merge（with :)使您可以交错多个发布者的值。</span>

<span class="p">}</span>

</code></pre></div><h2 id="6">6</h2>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-swift" data-lang="swift"><span class="kd">import</span> <span class="nc">UIKit</span>
<span class="kd">import</span> <span class="nc">SwiftUI</span>
<span class="kd">import</span> <span class="nc">Combine</span>
<span class="kd">import</span> <span class="nc">PlaygroundSupport</span>

<span class="c1">// ObservableObject 只能由 class 实现，对应了 assign 只接受分配到 class 类型</span>
<span class="kd">public</span> <span class="kr">final</span> <span class="kd">class</span> <span class="nc">DisplayTimer</span><span class="p">:</span> <span class="n">ObservableObject</span> <span class="p">{</span>
    <span class="p">@</span><span class="n">Published</span> <span class="kd">var</span> <span class="nv">current</span><span class="p">:</span> <span class="n">CGFloat</span> <span class="p">=</span> <span class="mi">0</span>
    <span class="kd">var</span> <span class="nv">cancellable</span><span class="p">:</span> <span class="n">Cancellable</span><span class="p">?</span> <span class="p">=</span> <span class="kc">nil</span>

    <span class="kd">init</span><span class="p">()</span> <span class="p">{</span>
        <span class="n">DispatchQueue</span><span class="p">.</span><span class="n">main</span><span class="p">.</span><span class="n">async</span> <span class="p">{</span>
            <span class="kc">self</span><span class="p">.</span><span class="n">cancellable</span> <span class="p">=</span> <span class="kc">self</span><span class="p">.</span><span class="n">start</span><span class="p">()</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="kd">func</span> <span class="nf">start</span><span class="p">()</span> <span class="p">-&gt;</span> <span class="n">Cancellable</span> <span class="p">{</span>
        <span class="k">return</span> <span class="n">Timer</span><span class="p">.</span><span class="n">publish</span><span class="p">(</span><span class="n">every</span><span class="p">:</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="mi">30</span><span class="p">,</span>
                             <span class="n">on</span><span class="p">:</span> <span class="p">.</span><span class="n">main</span><span class="p">,</span>
                             <span class="k">in</span><span class="p">:</span> <span class="p">.</span><span class="n">common</span><span class="p">)</span>
            <span class="p">.</span><span class="n">autoconnect</span><span class="p">()</span>
            <span class="p">.</span><span class="n">scan</span><span class="p">(</span><span class="n">CGFloat</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span> <span class="p">{</span> <span class="n">counter</span><span class="p">,</span> <span class="kc">_</span> <span class="k">in</span> <span class="n">counter</span> <span class="o">+</span> <span class="mi">1</span> <span class="p">}</span> <span class="c1">// 扫描每个值，做自增 + 1</span>
            <span class="p">.</span><span class="n">sink</span><span class="p">(</span><span class="n">receiveValue</span><span class="p">:</span> <span class="p">{</span> <span class="n">counter</span> <span class="k">in</span> <span class="kc">self</span><span class="p">.</span><span class="n">current</span> <span class="p">=</span> <span class="n">counter</span> <span class="p">})</span> <span class="c1">// 将 Timer 发射一次就更新到 current 上</span>
    <span class="p">}</span>

    <span class="kd">func</span> <span class="nf">stop</span><span class="p">(</span><span class="n">after</span><span class="p">:</span> <span class="n">TimeInterval</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">DispatchQueue</span><span class="p">.</span><span class="n">main</span><span class="p">.</span><span class="n">asyncAfter</span><span class="p">(</span><span class="n">deadline</span><span class="p">:</span> <span class="p">.</span><span class="n">now</span><span class="p">()</span> <span class="o">+</span> <span class="n">after</span><span class="p">)</span> <span class="p">{</span>
            <span class="kc">self</span><span class="p">.</span><span class="n">cancellable</span><span class="p">?.</span><span class="n">cancel</span><span class="p">()</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="c1">// 事件枚举，值、完成、失败</span>
<span class="kd">public</span> <span class="kd">enum</span> <span class="nc">Event</span><span class="p">:</span> <span class="nb">Equatable</span> <span class="p">{</span>
    <span class="k">case</span> <span class="n">value</span>
    <span class="k">case</span> <span class="n">completion</span>
    <span class="k">case</span> <span class="n">failure</span>
<span class="p">}</span>

<span class="kd">struct</span> <span class="nc">CombineEvent</span> <span class="p">{</span>
    <span class="kd">let</span> <span class="nv">index</span><span class="p">:</span> <span class="nb">Int</span>
    <span class="kd">let</span> <span class="nv">time</span><span class="p">:</span> <span class="n">TimeInterval</span>
    <span class="kd">let</span> <span class="nv">event</span><span class="p">:</span> <span class="n">Event</span>

    <span class="kd">var</span> <span class="nv">groupTime</span><span class="p">:</span> <span class="nb">Int</span> <span class="p">{</span> <span class="nb">Int</span><span class="p">(</span><span class="n">floor</span><span class="p">(</span><span class="n">time</span> <span class="o">*</span> <span class="mf">10.0</span><span class="p">))</span> <span class="p">}</span>
    <span class="kd">var</span> <span class="nv">isValue</span><span class="p">:</span> <span class="nb">Bool</span> <span class="p">{</span> <span class="kc">self</span><span class="p">.</span><span class="n">event</span> <span class="p">==</span> <span class="p">.</span><span class="n">value</span> <span class="p">}</span>
    <span class="kd">var</span> <span class="nv">isCompletion</span><span class="p">:</span> <span class="nb">Bool</span> <span class="p">{</span> <span class="kc">self</span><span class="p">.</span><span class="n">event</span> <span class="p">==</span> <span class="p">.</span><span class="n">completion</span> <span class="p">}</span>
<span class="p">}</span>

<span class="kd">struct</span> <span class="nc">CombineEvents</span><span class="p">:</span> <span class="n">Identifiable</span> <span class="p">{</span>
    <span class="kd">let</span> <span class="nv">events</span><span class="p">:</span> <span class="p">[</span><span class="n">CombineEvent</span><span class="p">]</span>

    <span class="kd">var</span> <span class="nv">time</span><span class="p">:</span> <span class="n">TimeInterval</span> <span class="p">{</span> <span class="n">events</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">time</span> <span class="p">}</span>
    <span class="kd">var</span> <span class="nv">id</span><span class="p">:</span> <span class="nb">Int</span> <span class="p">{</span> <span class="p">(</span><span class="n">events</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">groupTime</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span> <span class="n">events</span><span class="p">.</span><span class="bp">count</span> <span class="p">}</span> <span class="c1">// id，为每个事件创造一个 id</span>
<span class="p">}</span>

<span class="kd">class</span> <span class="nc">EventsHolder</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nv">events</span><span class="p">:</span> <span class="p">[</span><span class="n">CombineEvent</span><span class="p">]</span>
    <span class="kd">var</span> <span class="nv">startDate</span> <span class="p">=</span> <span class="n">Date</span><span class="p">()</span>
    <span class="kd">var</span> <span class="nv">nextIndex</span> <span class="p">=</span> <span class="mi">1</span>

    <span class="kd">init</span><span class="p">(</span><span class="n">events</span><span class="p">:</span> <span class="p">[</span><span class="n">CombineEvent</span><span class="p">]</span> <span class="p">=</span> <span class="p">[])</span> <span class="p">{</span>
        <span class="kc">self</span><span class="p">.</span><span class="n">events</span> <span class="p">=</span> <span class="n">events</span>
    <span class="p">}</span>

    <span class="kd">func</span> <span class="nf">capture</span><span class="p">(</span><span class="kc">_</span> <span class="n">event</span><span class="p">:</span> <span class="n">Event</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">let</span> <span class="nv">time</span> <span class="p">=</span> <span class="n">Date</span><span class="p">().</span><span class="n">timeIntervalSince</span><span class="p">(</span><span class="n">startDate</span><span class="p">)</span>
        <span class="c1">// if case 模式匹配</span>
        <span class="k">if</span> <span class="k">case</span> <span class="p">.</span><span class="n">completion</span> <span class="p">=</span> <span class="n">event</span><span class="p">,</span> <span class="c1">// 校验 event 是否符合 .completion 匹配</span>
            <span class="kd">let</span> <span class="nv">lastEvent</span> <span class="p">=</span> <span class="n">events</span><span class="p">.</span><span class="bp">last</span><span class="p">,</span>
            <span class="p">(</span><span class="n">time</span> <span class="o">-</span> <span class="n">lastEvent</span><span class="p">.</span><span class="n">time</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mf">1.0</span> <span class="p">{</span>
            <span class="n">events</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">CombineEvent</span><span class="p">(</span><span class="n">index</span><span class="p">:</span> <span class="n">nextIndex</span><span class="p">,</span> <span class="n">time</span><span class="p">:</span> <span class="n">lastEvent</span><span class="p">.</span><span class="n">time</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">event</span><span class="p">:</span> <span class="n">event</span><span class="p">))</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="n">events</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">CombineEvent</span><span class="p">(</span><span class="n">index</span><span class="p">:</span> <span class="n">nextIndex</span><span class="p">,</span> <span class="n">time</span><span class="p">:</span> <span class="n">time</span><span class="p">,</span> <span class="n">event</span><span class="p">:</span> <span class="n">event</span><span class="p">))</span>
        <span class="p">}</span>
        <span class="n">nextIndex</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="c1">// 超过 15 秒，则移除事件</span>
        <span class="k">while</span> <span class="kd">let</span> <span class="nv">e</span> <span class="p">=</span> <span class="n">events</span><span class="p">.</span><span class="bp">first</span> <span class="p">{</span>
            <span class="k">guard</span> <span class="p">(</span><span class="n">time</span> <span class="o">-</span> <span class="n">e</span><span class="p">.</span><span class="n">time</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mf">15.0</span> <span class="k">else</span> <span class="p">{</span> <span class="k">break</span> <span class="p">}</span>
            <span class="n">events</span><span class="p">.</span><span class="n">removeFirst</span><span class="p">()</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="c1">// 事件值的视图</span>
<span class="kd">struct</span> <span class="nc">EventValueView</span><span class="p">:</span> <span class="n">View</span> <span class="p">{</span>
    <span class="kd">let</span> <span class="nv">index</span><span class="p">:</span> <span class="nb">Int</span>

    <span class="kd">var</span> <span class="nv">body</span><span class="p">:</span> <span class="n">some</span> <span class="n">View</span> <span class="p">{</span>
        <span class="n">Text</span><span class="p">(</span><span class="s">&#34;</span><span class="si">\(</span><span class="kc">self</span><span class="p">.</span><span class="n">index</span><span class="si">)</span><span class="s">&#34;</span><span class="p">)</span>
        <span class="p">.</span><span class="n">padding</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
        <span class="p">.</span><span class="n">frame</span><span class="p">(</span><span class="n">width</span><span class="p">:</span> <span class="mi">28</span><span class="p">,</span> <span class="n">height</span><span class="p">:</span> <span class="mi">28</span><span class="p">)</span>
        <span class="c1">// Sets whether text can compress the space between characters when necessary to fit text in a line.</span>
        <span class="c1">// 允许一行中挤压文字间空隙</span>
<span class="c1">// .allowsTightening(true)</span>
        <span class="p">.</span><span class="n">minimumScaleFactor</span><span class="p">(</span><span class="mf">0.1</span><span class="p">)</span>
        <span class="p">.</span><span class="n">foregroundColor</span><span class="p">(.</span><span class="n">white</span><span class="p">)</span>
        <span class="p">.</span><span class="n">background</span><span class="p">(</span><span class="n">Circle</span><span class="p">().</span><span class="n">fill</span><span class="p">(</span><span class="n">Color</span><span class="p">.</span><span class="n">blue</span><span class="p">))</span>
        <span class="p">.</span><span class="n">fixedSize</span><span class="p">()</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="kd">struct</span> <span class="nc">EventCompletedView</span><span class="p">:</span> <span class="n">View</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nv">body</span><span class="p">:</span> <span class="n">some</span> <span class="n">View</span> <span class="p">{</span>
        <span class="n">Rectangle</span><span class="p">()</span>
            <span class="p">.</span><span class="n">frame</span><span class="p">(</span><span class="n">width</span><span class="p">:</span> <span class="mi">4</span><span class="p">,</span> <span class="n">height</span><span class="p">:</span> <span class="mi">38</span><span class="p">)</span>
            <span class="p">.</span><span class="n">offset</span><span class="p">(</span><span class="n">x</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="o">-</span><span class="mi">3</span><span class="p">)</span>
            <span class="p">.</span><span class="n">foregroundColor</span><span class="p">(.</span><span class="n">gray</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="kd">struct</span> <span class="nc">EventFailureView</span><span class="p">:</span> <span class="n">View</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nv">body</span><span class="p">:</span> <span class="n">some</span> <span class="n">View</span> <span class="p">{</span>
        <span class="n">Text</span><span class="p">(</span><span class="s">&#34;X&#34;</span><span class="p">)</span>
            <span class="p">.</span><span class="n">padding</span><span class="p">(</span><span class="mf">3.0</span><span class="p">)</span>
            <span class="p">.</span><span class="n">frame</span><span class="p">(</span><span class="n">width</span><span class="p">:</span> <span class="mi">28</span><span class="p">,</span> <span class="n">height</span><span class="p">:</span> <span class="mi">28</span><span class="p">)</span>
            <span class="p">.</span><span class="n">foregroundColor</span><span class="p">(.</span><span class="n">white</span><span class="p">)</span>
            <span class="p">.</span><span class="n">background</span><span class="p">(</span><span class="n">Circle</span><span class="p">().</span><span class="n">fill</span><span class="p">(</span><span class="n">Color</span><span class="p">.</span><span class="n">red</span><span class="p">))</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="kd">struct</span> <span class="nc">EventView</span><span class="p">:</span> <span class="n">View</span> <span class="p">{</span>
    <span class="kd">let</span> <span class="nv">event</span><span class="p">:</span> <span class="n">CombineEvent</span>
    <span class="c1">// An AnyView allows changing the type of view used in a given view hierarchy. Whenever the type of view used with an AnyView changes, the old hierarchy is destroyed and a new hierarchy is created for the new type.</span>
    <span class="kd">var</span> <span class="nv">body</span><span class="p">:</span> <span class="n">some</span> <span class="n">View</span> <span class="p">{</span>
        <span class="k">switch</span> <span class="kc">self</span><span class="p">.</span><span class="n">event</span><span class="p">.</span><span class="n">event</span> <span class="p">{</span>
        <span class="k">case</span> <span class="p">.</span><span class="n">value</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">AnyView</span><span class="p">(</span><span class="n">EventValueView</span><span class="p">(</span><span class="n">index</span><span class="p">:</span> <span class="kc">self</span><span class="p">.</span><span class="n">event</span><span class="p">.</span><span class="n">index</span><span class="p">))</span>
        <span class="k">case</span> <span class="p">.</span><span class="n">completion</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">AnyView</span><span class="p">(</span><span class="n">EventCompletedView</span><span class="p">())</span>
        <span class="k">case</span> <span class="p">.</span><span class="n">failure</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">AnyView</span><span class="p">(</span><span class="n">EventFailureView</span><span class="p">())</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="kd">struct</span> <span class="nc">SimultaneousEventsView</span><span class="p">:</span> <span class="n">View</span> <span class="p">{</span>
    <span class="kd">let</span> <span class="nv">events</span><span class="p">:</span> <span class="p">[</span><span class="n">CombineEvent</span><span class="p">]</span>

    <span class="kd">var</span> <span class="nv">body</span><span class="p">:</span> <span class="n">some</span> <span class="n">View</span> <span class="p">{</span>
        <span class="n">VStack</span><span class="p">(</span><span class="n">alignment</span><span class="p">:</span> <span class="p">.</span><span class="n">center</span><span class="p">,</span> <span class="n">spacing</span><span class="p">:</span> <span class="mf">0.0</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">ForEach</span><span class="p">(</span><span class="mf">0.</span><span class="p">.&lt;</span><span class="kc">self</span><span class="p">.</span><span class="n">events</span><span class="p">.</span><span class="bp">count</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">EventView</span><span class="p">(</span><span class="n">event</span><span class="p">:</span> <span class="kc">self</span><span class="p">.</span><span class="n">events</span><span class="p">[</span><span class="nv">$0</span><span class="p">])</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="kd">extension</span> <span class="nc">SimultaneousEventsView</span><span class="p">:</span> <span class="n">Identifiable</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nv">id</span><span class="p">:</span> <span class="nb">Int</span> <span class="p">{</span> <span class="k">return</span> <span class="n">events</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">groupTime</span> <span class="p">}</span>
<span class="p">}</span>

<span class="kd">struct</span> <span class="nc">ContentView</span><span class="p">:</span> <span class="n">View</span> <span class="p">{</span>
    <span class="p">@</span><span class="n">ObservedObject</span> <span class="kd">var</span> <span class="nv">time</span> <span class="p">=</span> <span class="n">DisplayTimer</span><span class="p">()</span>
    <span class="kd">let</span> <span class="nv">holder</span><span class="p">:</span> <span class="n">EventsHolder</span>
    <span class="kd">let</span> <span class="nv">title</span><span class="p">:</span> <span class="nb">String</span>
    <span class="kd">var</span> <span class="nv">groupEvents</span><span class="p">:</span> <span class="p">[</span><span class="n">CombineEvents</span><span class="p">]</span> <span class="p">{</span>
        <span class="kd">let</span> <span class="nv">d</span> <span class="p">=</span> <span class="nb">Dictionary</span><span class="p">&lt;</span><span class="nb">Int</span><span class="p">,</span> <span class="p">[</span><span class="n">CombineEvent</span><span class="p">]</span><span class="o">&gt;</span><span class="p">.</span><span class="kd">init</span><span class="p">(</span><span class="n">grouping</span><span class="p">:</span> <span class="kc">self</span><span class="p">.</span><span class="n">holder</span><span class="p">.</span><span class="n">events</span><span class="p">)</span> <span class="p">{</span>
            <span class="nv">$0</span><span class="p">.</span><span class="n">groupTime</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="n">d</span><span class="p">.</span><span class="n">keys</span><span class="p">.</span><span class="bp">sorted</span><span class="p">().</span><span class="bp">map</span> <span class="p">{</span>
            <span class="n">CombineEvents</span><span class="p">(</span><span class="n">events</span><span class="p">:</span> <span class="n">d</span><span class="p">[</span><span class="nv">$0</span><span class="p">]</span><span class="o">!</span><span class="p">.</span><span class="bp">sorted</span> <span class="p">{</span> <span class="nv">$0</span><span class="p">.</span><span class="n">index</span> <span class="o">&lt;</span> <span class="nv">$1</span><span class="p">.</span><span class="n">index</span> <span class="p">})</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="kd">init</span><span class="p">(</span><span class="n">title</span><span class="p">:</span> <span class="nb">String</span><span class="p">,</span> <span class="n">holder</span><span class="p">:</span> <span class="n">EventsHolder</span> <span class="p">=</span> <span class="n">EventsHolder</span><span class="p">())</span> <span class="p">{</span>
        <span class="kc">self</span><span class="p">.</span><span class="n">title</span> <span class="p">=</span> <span class="n">title</span>
        <span class="kc">self</span><span class="p">.</span><span class="n">holder</span> <span class="p">=</span> <span class="n">holder</span>
    <span class="p">}</span>

    <span class="kd">var</span> <span class="nv">body</span><span class="p">:</span> <span class="n">some</span> <span class="n">View</span> <span class="p">{</span>
        <span class="n">VStack</span><span class="p">(</span><span class="n">alignment</span><span class="p">:</span> <span class="p">.</span><span class="n">leading</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">Text</span><span class="p">(</span><span class="n">title</span><span class="p">)</span>
                <span class="p">.</span><span class="n">fixedSize</span><span class="p">(</span><span class="n">horizontal</span><span class="p">:</span> <span class="kc">false</span><span class="p">,</span> <span class="n">vertical</span><span class="p">:</span> <span class="kc">true</span><span class="p">)</span>
                <span class="p">.</span><span class="n">padding</span><span class="p">(.</span><span class="n">bottom</span><span class="p">,</span> <span class="mi">8</span><span class="p">)</span>
            <span class="n">ZStack</span> <span class="p">{</span>
                <span class="n">Rectangle</span><span class="p">()</span>
                    <span class="p">.</span><span class="n">frame</span><span class="p">(</span><span class="n">height</span><span class="p">:</span> <span class="mi">2</span><span class="p">)</span>
                    <span class="p">.</span><span class="n">foregroundColor</span><span class="p">(.</span><span class="n">gray</span><span class="p">)</span>
                    <span class="p">.</span><span class="n">offset</span><span class="p">(</span><span class="n">x</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="mi">14</span><span class="p">)</span>
                <span class="n">ForEach</span><span class="p">(</span><span class="n">groupEvents</span><span class="p">)</span> <span class="p">{</span> <span class="n">group</span> <span class="k">in</span>
                    <span class="n">SimultaneousEventsView</span><span class="p">(</span><span class="n">events</span><span class="p">:</span> <span class="n">group</span><span class="p">.</span><span class="n">events</span><span class="p">)</span>
                        <span class="p">.</span><span class="n">offset</span><span class="p">(</span><span class="n">x</span><span class="p">:</span> <span class="n">CGFloat</span><span class="p">(</span><span class="n">group</span><span class="p">.</span><span class="n">time</span><span class="p">)</span> <span class="o">*</span> <span class="mf">30.0</span> <span class="o">-</span> <span class="kc">self</span><span class="p">.</span><span class="n">time</span><span class="p">.</span><span class="n">current</span> <span class="o">-</span> <span class="mi">32</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="mi">0</span><span class="p">)</span>
                <span class="p">}</span>
            <span class="p">}</span>
            <span class="p">.</span><span class="n">frame</span><span class="p">(</span><span class="n">minHeight</span><span class="p">:</span> <span class="mi">32</span><span class="p">)</span>
            <span class="p">.</span><span class="n">onReceive</span><span class="p">(</span><span class="n">time</span><span class="p">.</span><span class="n">objectWillChange</span><span class="p">)</span> <span class="p">{</span> <span class="kc">_</span> <span class="k">in</span>
                <span class="k">if</span> <span class="kc">self</span><span class="p">.</span><span class="n">holder</span><span class="p">.</span><span class="n">events</span><span class="p">.</span><span class="bp">contains</span><span class="p">(</span><span class="k">where</span><span class="p">:</span> <span class="p">{</span> <span class="nv">$0</span><span class="p">.</span><span class="n">event</span> <span class="o">!=</span> <span class="p">.</span><span class="n">value</span> <span class="p">})</span> <span class="p">{</span>
                    <span class="kc">self</span><span class="p">.</span><span class="n">time</span><span class="p">.</span><span class="n">stop</span><span class="p">(</span><span class="n">after</span><span class="p">:</span> <span class="mf">0.5</span><span class="p">)</span>
                <span class="p">}</span>
            <span class="p">}</span>

        <span class="p">}</span>
    <span class="p">}</span>

    <span class="kd">func</span> <span class="nf">capture</span><span class="p">&lt;</span><span class="n">T</span><span class="p">,</span> <span class="n">F</span><span class="p">&gt;(</span><span class="n">publisher</span><span class="p">:</span> <span class="n">AnyPublisher</span><span class="p">&lt;</span><span class="n">T</span><span class="p">,</span> <span class="n">F</span><span class="p">&gt;)</span> <span class="p">{</span>
        <span class="c1">// 传入的 publisher 与其订阅者绑定，触发事件更新</span>
        <span class="c1">// 类型擦除的 订阅者</span>
        <span class="kd">let</span> <span class="nv">observer</span> <span class="p">=</span> <span class="n">AnySubscriber</span><span class="p">(</span><span class="n">receiveSubscription</span><span class="p">:</span> <span class="p">{</span> <span class="n">subscription</span> <span class="k">in</span>
            <span class="n">subscription</span><span class="p">.</span><span class="n">request</span><span class="p">(.</span><span class="n">unlimited</span><span class="p">)</span>
        <span class="p">},</span> <span class="n">receiveValue</span><span class="p">:</span> <span class="p">{</span> <span class="p">(</span><span class="n">value</span><span class="p">:</span> <span class="n">T</span><span class="p">)</span> <span class="p">-&gt;</span> <span class="n">Subscribers</span><span class="p">.</span><span class="n">Demand</span> <span class="k">in</span>
            <span class="kc">self</span><span class="p">.</span><span class="n">holder</span><span class="p">.</span><span class="n">capture</span><span class="p">(.</span><span class="n">value</span><span class="p">)</span>
            <span class="k">return</span> <span class="p">.</span><span class="n">unlimited</span>
        <span class="p">},</span> <span class="n">receiveCompletion</span><span class="p">:</span> <span class="p">{</span> <span class="p">(</span><span class="n">completion</span><span class="p">:</span> <span class="n">Subscribers</span><span class="p">.</span><span class="n">Completion</span><span class="p">&lt;</span><span class="n">F</span><span class="p">&gt;)</span> <span class="k">in</span>
            <span class="k">switch</span> <span class="n">completion</span> <span class="p">{</span>
            <span class="k">case</span> <span class="p">.</span><span class="n">finished</span><span class="p">:</span> <span class="kc">self</span><span class="p">.</span><span class="n">holder</span><span class="p">.</span><span class="n">capture</span><span class="p">(.</span><span class="n">completion</span><span class="p">)</span>
            <span class="k">case</span> <span class="p">.</span><span class="n">failure</span><span class="p">:</span> <span class="kc">self</span><span class="p">.</span><span class="n">holder</span><span class="p">.</span><span class="n">capture</span><span class="p">(.</span><span class="n">failure</span><span class="p">)</span>
            <span class="p">}</span>
        <span class="p">})</span>

        <span class="n">publisher</span><span class="p">.</span><span class="n">subscribe</span><span class="p">(</span><span class="n">on</span><span class="p">:</span> <span class="n">DispatchQueue</span><span class="p">.</span><span class="n">main</span><span class="p">)</span>
        <span class="p">.</span><span class="n">subscribe</span><span class="p">(</span><span class="n">observer</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="kd">extension</span> <span class="nc">Publisher</span> <span class="p">{</span>
    <span class="kd">func</span> <span class="nf">displayEvents</span><span class="p">(</span><span class="k">in</span> <span class="n">view</span><span class="p">:</span> <span class="n">ContentView</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">view</span><span class="p">.</span><span class="n">capture</span><span class="p">(</span><span class="n">publisher</span><span class="p">:</span> <span class="kc">self</span><span class="p">.</span><span class="n">eraseToAnyPublisher</span><span class="p">())</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="kd">var</span> <span class="nv">subscriptions</span> <span class="p">=</span> <span class="p">[</span><span class="n">AnyCancellable</span><span class="p">]()</span>

<span class="kd">enum</span> <span class="nc">MyError</span><span class="p">:</span> <span class="n">Error</span> <span class="p">{</span>
    <span class="k">case</span> <span class="n">foo</span>
<span class="p">}</span>

<span class="kd">let</span> <span class="nv">valuesPerSecond</span> <span class="p">=</span> <span class="mf">1.0</span>
<span class="kd">let</span> <span class="nv">delayInSeconds</span> <span class="p">=</span> <span class="mf">1.5</span>



<span class="c1">// 延迟</span>
<span class="kd">let</span> <span class="nv">pub</span> <span class="p">=</span> <span class="n">PassthroughSubject</span><span class="p">&lt;</span><span class="n">Date</span><span class="p">,</span> <span class="n">Never</span><span class="p">&gt;()</span> <span class="c1">// 发射 Date 值的发布者</span>
<span class="kd">let</span> <span class="nv">delayedPub</span> <span class="p">=</span> <span class="n">pub</span><span class="p">.</span><span class="n">delay</span><span class="p">(</span><span class="k">for</span><span class="p">:</span> <span class="p">.</span><span class="n">seconds</span><span class="p">(</span><span class="n">delayInSeconds</span><span class="p">),</span>
                           <span class="n">scheduler</span><span class="p">:</span> <span class="n">DispatchQueue</span><span class="p">.</span><span class="n">main</span><span class="p">)</span> <span class="c1">// 延迟发布者</span>

<span class="kd">let</span> <span class="nv">sub</span> <span class="p">=</span> <span class="n">Timer</span>
    <span class="p">.</span><span class="n">publish</span><span class="p">(</span><span class="n">every</span><span class="p">:</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="n">valuesPerSecond</span><span class="p">,</span> <span class="n">on</span><span class="p">:</span> <span class="p">.</span><span class="n">main</span><span class="p">,</span> <span class="k">in</span><span class="p">:</span> <span class="p">.</span><span class="n">common</span><span class="p">)</span>
    <span class="p">.</span><span class="n">autoconnect</span><span class="p">()</span> <span class="c1">// autoconnect，它将在第一个订阅时立即连接。</span>
    <span class="p">.</span><span class="n">subscribe</span><span class="p">(</span><span class="n">pub</span><span class="p">)</span> <span class="c1">// pub.send</span>

<span class="kd">let</span> <span class="nv">sourceTimeline</span> <span class="p">=</span> <span class="n">ContentView</span><span class="p">(</span><span class="n">title</span><span class="p">:</span> <span class="s">&#34;Emitted values (</span><span class="si">\(</span><span class="n">valuesPerSecond</span><span class="si">)</span><span class="s"> per sec.):&#34;</span><span class="p">)</span>
<span class="kd">let</span> <span class="nv">delayedTimeline</span> <span class="p">=</span> <span class="n">ContentView</span><span class="p">(</span><span class="n">title</span><span class="p">:</span> <span class="s">&#34;Delayed values (with a </span><span class="si">\(</span><span class="n">delayInSeconds</span><span class="si">)</span><span class="s">s delay):&#34;</span><span class="p">)</span>
<span class="kd">let</span> <span class="nv">view</span> <span class="p">=</span> <span class="n">VStack</span><span class="p">(</span><span class="n">spacing</span><span class="p">:</span> <span class="mi">50</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">sourceTimeline</span>
  <span class="n">delayedTimeline</span>
<span class="p">}</span>

<span class="n">PlaygroundPage</span><span class="p">.</span><span class="n">current</span><span class="p">.</span><span class="n">liveView</span> <span class="p">=</span> <span class="n">UIHostingController</span><span class="p">(</span><span class="n">rootView</span><span class="p">:</span> <span class="n">view</span><span class="p">)</span>

<span class="n">pub</span><span class="p">.</span><span class="n">displayEvents</span><span class="p">(</span><span class="k">in</span><span class="p">:</span> <span class="n">sourceTimeline</span><span class="p">)</span>
<span class="n">delayedPub</span><span class="p">.</span><span class="n">displayEvents</span><span class="p">(</span><span class="k">in</span><span class="p">:</span> <span class="n">delayedTimeline</span><span class="p">)</span>


<span class="c1">//pub.sink(receiveValue: { print($0) }).store(in: &amp;subscriptions)</span>
</code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-swift" data-lang="swift"><span class="kd">import</span> <span class="nc">UIKit</span>
<span class="kd">import</span> <span class="nc">SwiftUI</span>
<span class="kd">import</span> <span class="nc">Combine</span>

<span class="kd">var</span> <span class="nv">subs</span> <span class="p">=</span> <span class="p">[</span><span class="n">AnyCancellable</span><span class="p">]()</span>

<span class="kd">let</span> <span class="nv">pub1</span> <span class="p">=</span> <span class="n">PassthroughSubject</span><span class="p">&lt;</span><span class="n">Date</span><span class="p">,</span> <span class="n">Never</span><span class="p">&gt;()</span> <span class="c1">// 源</span>
<span class="c1">// collect 的另一种重载</span>
<span class="kd">let</span> <span class="nv">pub2</span> <span class="p">=</span> <span class="n">pub1</span>
    <span class="p">.</span><span class="n">collect</span><span class="p">(.</span><span class="n">byTime</span><span class="p">(</span><span class="n">DispatchQueue</span><span class="p">.</span><span class="n">main</span><span class="p">,</span> <span class="p">.</span><span class="n">seconds</span><span class="p">(</span><span class="mi">4</span><span class="p">)))</span> <span class="c1">// 按时间每四秒收集一次</span>
<span class="c1">//    .flatMap { $0.publisher } // 分解为同时单个输出的四个值</span>

<span class="kd">let</span> <span class="nv">sub</span> <span class="p">=</span> <span class="n">Timer</span><span class="p">.</span><span class="n">publish</span><span class="p">(</span><span class="n">every</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="n">on</span><span class="p">:</span> <span class="p">.</span><span class="n">main</span><span class="p">,</span> <span class="k">in</span><span class="p">:</span> <span class="p">.</span><span class="n">common</span><span class="p">)</span>
<span class="p">.</span><span class="n">autoconnect</span><span class="p">()</span>
<span class="p">.</span><span class="n">subscribe</span><span class="p">(</span><span class="n">pub1</span><span class="p">)</span>

<span class="n">pub1</span><span class="p">.</span><span class="n">sink</span><span class="p">(</span><span class="n">receiveValue</span><span class="p">:</span> <span class="p">{</span> <span class="bp">print</span><span class="p">(</span><span class="s">&#34;1 - &#34;</span><span class="p">,</span> <span class="nv">$0</span><span class="p">)</span> <span class="p">})</span>
    <span class="p">.</span><span class="n">store</span><span class="p">(</span><span class="k">in</span><span class="p">:</span> <span class="p">&amp;</span><span class="n">subs</span><span class="p">)</span>
<span class="n">pub2</span><span class="p">.</span><span class="n">sink</span><span class="p">(</span><span class="n">receiveValue</span><span class="p">:</span> <span class="p">{</span> <span class="bp">print</span><span class="p">(</span><span class="s">&#34;2 - &#34;</span><span class="p">,</span> <span class="nv">$0</span><span class="p">)</span> <span class="p">})</span>
    <span class="p">.</span><span class="n">store</span><span class="p">(</span><span class="k">in</span><span class="p">:</span> <span class="p">&amp;</span><span class="n">subs</span><span class="p">)</span>

<span class="c1">//1 -  2020-03-15 10:38:02 +0000</span>
<span class="c1">//1 -  2020-03-15 10:38:03 +0000</span>
<span class="c1">//1 -  2020-03-15 10:38:04 +0000</span>
<span class="c1">//1 -  2020-03-15 10:38:05 +0000</span>
<span class="c1">//2 -  [2020-03-15 10:38:02 +0000, 2020-03-15 10:38:03 +0000, 2020-03-15 10:38:04 +0000, 2020-03-15 10:38:05 +0000]</span>
<span class="c1">//1 -  2020-03-15 10:38:06 +0000</span>
<span class="c1">//1 -  2020-03-15 10:38:07 +0000</span>
<span class="c1">//1 -  2020-03-15 10:38:08 +0000</span>
<span class="c1">//1 -  2020-03-15 10:38:09 +0000</span>
<span class="c1">//2 -  [2020-03-15 10:38:06 +0000, 2020-03-15 10:38:07 +0000, 2020-03-15 10:38:08 +0000, 2020-03-15 10:38:09 +0000]</span>
<span class="c1">//1 -  2020-03-15 10:38:10 +0000</span>
<span class="c1">//...</span>

<span class="c1">//1 -  2020-03-15 10:44:55 +0000</span>
<span class="c1">//1 -  2020-03-15 10:44:56 +0000</span>
<span class="c1">//1 -  2020-03-15 10:44:57 +0000</span>
<span class="c1">//1 -  2020-03-15 10:44:58 +0000</span>
<span class="c1">//2 -  2020-03-15 10:44:55 +0000</span>
<span class="c1">//2 -  2020-03-15 10:44:56 +0000</span>
<span class="c1">//2 -  2020-03-15 10:44:57 +0000</span>
<span class="c1">//2 -  2020-03-15 10:44:58 +0000</span>
<span class="c1">//1 -  2020-03-15 10:44:59 +0000</span>
<span class="c1">//1 -  2020-03-15 10:45:00 +0000</span>
</code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-swift" data-lang="swift"><span class="kd">import</span> <span class="nc">UIKit</span>
<span class="kd">import</span> <span class="nc">SwiftUI</span>
<span class="kd">import</span> <span class="nc">Combine</span>

<span class="kd">var</span> <span class="nv">subs</span> <span class="p">=</span> <span class="p">[</span><span class="n">AnyCancellable</span><span class="p">]()</span>

<span class="kd">let</span> <span class="nv">pub1</span> <span class="p">=</span> <span class="n">PassthroughSubject</span><span class="p">&lt;</span><span class="n">Date</span><span class="p">,</span> <span class="n">Never</span><span class="p">&gt;()</span> <span class="c1">// 源</span>
<span class="c1">// collect 的另一种重载</span>
<span class="kd">let</span> <span class="nv">pub2</span> <span class="p">=</span> <span class="n">pub1</span>
    <span class="p">.</span><span class="n">collect</span><span class="p">(.</span><span class="n">byTimeOrCount</span><span class="p">(</span><span class="n">DispatchQueue</span><span class="p">.</span><span class="n">main</span><span class="p">,</span> <span class="p">.</span><span class="n">seconds</span><span class="p">(</span><span class="mi">4</span><span class="p">),</span> <span class="mi">2</span><span class="p">))</span> <span class="c1">// 按时间每四秒，但最多收集两个</span>
    <span class="p">.</span><span class="n">flatMap</span> <span class="p">{</span> <span class="nv">$0</span><span class="p">.</span><span class="n">publisher</span> <span class="p">}</span> <span class="c1">// 分解为同时单个输出的四个值</span>

<span class="kd">let</span> <span class="nv">sub</span> <span class="p">=</span> <span class="n">Timer</span><span class="p">.</span><span class="n">publish</span><span class="p">(</span><span class="n">every</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="n">on</span><span class="p">:</span> <span class="p">.</span><span class="n">main</span><span class="p">,</span> <span class="k">in</span><span class="p">:</span> <span class="p">.</span><span class="n">common</span><span class="p">)</span>
<span class="p">.</span><span class="n">autoconnect</span><span class="p">()</span>
<span class="p">.</span><span class="n">subscribe</span><span class="p">(</span><span class="n">pub1</span><span class="p">)</span>

<span class="n">pub1</span><span class="p">.</span><span class="n">sink</span><span class="p">(</span><span class="n">receiveValue</span><span class="p">:</span> <span class="p">{</span> <span class="bp">print</span><span class="p">(</span><span class="s">&#34;1 - &#34;</span><span class="p">,</span> <span class="nv">$0</span><span class="p">)</span> <span class="p">})</span>
    <span class="p">.</span><span class="n">store</span><span class="p">(</span><span class="k">in</span><span class="p">:</span> <span class="p">&amp;</span><span class="n">subs</span><span class="p">)</span>
<span class="n">pub2</span><span class="p">.</span><span class="n">sink</span><span class="p">(</span><span class="n">receiveValue</span><span class="p">:</span> <span class="p">{</span> <span class="bp">print</span><span class="p">(</span><span class="s">&#34;2 - &#34;</span><span class="p">,</span> <span class="nv">$0</span><span class="p">)</span> <span class="p">})</span>
    <span class="p">.</span><span class="n">store</span><span class="p">(</span><span class="k">in</span><span class="p">:</span> <span class="p">&amp;</span><span class="n">subs</span><span class="p">)</span>

<span class="c1">// 不带 flatMap</span>
<span class="c1">//1 -  2020-03-15 10:55:00 +0000</span>
<span class="c1">//1 -  2020-03-15 10:55:01 +0000</span>
<span class="c1">//2 -  [2020-03-15 10:55:00 +0000, 2020-03-15 10:55:01 +0000]</span>
<span class="c1">//1 -  2020-03-15 10:55:02 +0000</span>
<span class="c1">//1 -  2020-03-15 10:55:03 +0000</span>
<span class="c1">//2 -  [2020-03-15 10:55:02 +0000, 2020-03-15 10:55:03 +0000]</span>
<span class="c1">//1 -  2020-03-15 10:55:04 +0000</span>

<span class="c1">// 带 flatMap</span>
<span class="c1">//1 -  2020-03-15 10:55:34 +0000</span>
<span class="c1">//1 -  2020-03-15 10:55:35 +0000</span>
<span class="c1">//2 -  2020-03-15 10:55:34 +0000</span>
<span class="c1">//2 -  2020-03-15 10:55:35 +0000</span>
<span class="c1">//1 -  2020-03-15 10:55:36 +0000</span>
<span class="c1">//1 -  2020-03-15 10:55:37 +0000</span>
</code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-swift" data-lang="swift"><span class="kd">import</span> <span class="nc">UIKit</span>
<span class="kd">import</span> <span class="nc">SwiftUI</span>
<span class="kd">import</span> <span class="nc">Combine</span>

<span class="c1">// 去抖</span>
<span class="kd">var</span> <span class="nv">subs</span> <span class="p">=</span> <span class="p">[</span><span class="n">AnyCancellable</span><span class="p">]()</span>

<span class="kd">public</span> <span class="kd">let</span> <span class="nv">typingHelloWorld</span><span class="p">:</span> <span class="p">[(</span><span class="n">TimeInterval</span><span class="p">,</span> <span class="nb">String</span><span class="p">)]</span> <span class="p">=</span> <span class="p">[</span>
  <span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="s">&#34;H&#34;</span><span class="p">),</span>
  <span class="p">(</span><span class="mf">0.1</span><span class="p">,</span> <span class="s">&#34;He&#34;</span><span class="p">),</span>
  <span class="p">(</span><span class="mf">0.2</span><span class="p">,</span> <span class="s">&#34;Hel&#34;</span><span class="p">),</span>
  <span class="p">(</span><span class="mf">0.3</span><span class="p">,</span> <span class="s">&#34;Hell&#34;</span><span class="p">),</span>
  <span class="p">(</span><span class="mf">0.5</span><span class="p">,</span> <span class="s">&#34;Hello&#34;</span><span class="p">),</span>
  <span class="p">(</span><span class="mf">0.6</span><span class="p">,</span> <span class="s">&#34;Hello &#34;</span><span class="p">),</span>
  <span class="p">(</span><span class="mf">2.0</span><span class="p">,</span> <span class="s">&#34;Hello W&#34;</span><span class="p">),</span>
  <span class="p">(</span><span class="mf">2.1</span><span class="p">,</span> <span class="s">&#34;Hello Wo&#34;</span><span class="p">),</span>
  <span class="p">(</span><span class="mf">2.2</span><span class="p">,</span> <span class="s">&#34;Hello Wor&#34;</span><span class="p">),</span>
  <span class="p">(</span><span class="mf">2.4</span><span class="p">,</span> <span class="s">&#34;Hello Worl&#34;</span><span class="p">),</span>
  <span class="p">(</span><span class="mf">2.5</span><span class="p">,</span> <span class="s">&#34;Hello World&#34;</span><span class="p">)</span>
<span class="p">]</span>

<span class="kd">let</span> <span class="nv">subject</span> <span class="p">=</span> <span class="n">PassthroughSubject</span><span class="p">&lt;</span><span class="nb">String</span><span class="p">,</span> <span class="n">Never</span><span class="p">&gt;()</span>
<span class="kd">let</span> <span class="nv">debounced</span> <span class="p">=</span> <span class="n">subject</span>
    <span class="p">.</span><span class="n">debounce</span><span class="p">(</span><span class="k">for</span><span class="p">:</span> <span class="p">.</span><span class="n">seconds</span><span class="p">(</span><span class="mf">1.0</span><span class="p">),</span> <span class="n">scheduler</span><span class="p">:</span> <span class="n">DispatchQueue</span><span class="p">.</span><span class="n">main</span><span class="p">)</span>
    <span class="p">.</span><span class="n">share</span><span class="p">()</span> <span class="c1">// 当一个发布者的单个订阅需要向多个订阅者交付相同的结果时</span>

<span class="n">subject</span><span class="p">.</span><span class="n">feed</span><span class="p">(</span><span class="n">with</span><span class="p">:</span> <span class="n">typingHelloWorld</span><span class="p">)</span> <span class="c1">// A function that can feed delayed values to a subject for testing and simulation purposes</span>
<span class="n">DispatchQueue</span><span class="p">.</span><span class="n">main</span><span class="p">.</span><span class="n">asyncAfter</span><span class="p">(</span><span class="n">deadline</span><span class="p">:</span> <span class="p">.</span><span class="n">now</span><span class="p">()</span> <span class="o">+</span> <span class="mi">5</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">subject</span><span class="p">.</span><span class="n">send</span><span class="p">(</span><span class="s">&#34;kingcos.me&#34;</span><span class="p">)</span>
    <span class="n">subject</span><span class="p">.</span><span class="n">send</span><span class="p">(</span><span class="n">completion</span><span class="p">:</span> <span class="p">.</span><span class="n">finished</span><span class="p">)</span>
<span class="p">}</span>

<span class="n">subject</span><span class="p">.</span><span class="n">sink</span><span class="p">(</span><span class="n">receiveCompletion</span><span class="p">:</span> <span class="p">{</span> <span class="bp">print</span><span class="p">(</span><span class="nv">$0</span><span class="p">)</span> <span class="p">},</span> <span class="n">receiveValue</span><span class="p">:</span> <span class="p">{</span> <span class="bp">print</span><span class="p">(</span><span class="s">&#34;s&#34;</span><span class="p">,</span> <span class="nv">$0</span><span class="p">)</span> <span class="p">}).</span><span class="n">store</span><span class="p">(</span><span class="k">in</span><span class="p">:</span> <span class="p">&amp;</span><span class="n">subs</span><span class="p">)</span>
<span class="n">debounced</span><span class="p">.</span><span class="n">sink</span><span class="p">(</span><span class="n">receiveValue</span><span class="p">:</span> <span class="p">{</span> <span class="bp">print</span><span class="p">(</span><span class="s">&#34;d&#34;</span><span class="p">,</span> <span class="nv">$0</span><span class="p">)</span> <span class="p">}).</span><span class="n">store</span><span class="p">(</span><span class="k">in</span><span class="p">:</span> <span class="p">&amp;</span><span class="n">subs</span><span class="p">)</span>
<span class="c1">//s H</span>
<span class="c1">//s He</span>
<span class="c1">//s Hel</span>
<span class="c1">//s Hell</span>
<span class="c1">//s Hello</span>
<span class="c1">//s Hello</span>
<span class="c1">//d Hello // 上一个值发出 1 秒后，无新值才发射</span>
<span class="c1">//s Hello W</span>
<span class="c1">//s Hello Wo</span>
<span class="c1">//s Hello Wor</span>
<span class="c1">//s Hello Worl</span>
<span class="c1">//s Hello World</span>
<span class="c1">//d Hello World</span>
<span class="c1">//finished // 完成后，最后一个未间隔到 1s 不会再发出</span>
</code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-swift" data-lang="swift"><span class="kd">import</span> <span class="nc">UIKit</span>
<span class="kd">import</span> <span class="nc">SwiftUI</span>
<span class="kd">import</span> <span class="nc">Combine</span>

<span class="kd">var</span> <span class="nv">subs</span> <span class="p">=</span> <span class="p">[</span><span class="n">AnyCancellable</span><span class="p">]()</span>

<span class="kd">public</span> <span class="kd">let</span> <span class="nv">typingHelloWorld</span><span class="p">:</span> <span class="p">[(</span><span class="n">TimeInterval</span><span class="p">,</span> <span class="nb">String</span><span class="p">)]</span> <span class="p">=</span> <span class="p">[</span>
  <span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="s">&#34;H&#34;</span><span class="p">),</span>
  <span class="p">(</span><span class="mf">0.1</span><span class="p">,</span> <span class="s">&#34;He&#34;</span><span class="p">),</span>
  <span class="p">(</span><span class="mf">0.2</span><span class="p">,</span> <span class="s">&#34;Hel&#34;</span><span class="p">),</span>
  <span class="p">(</span><span class="mf">0.3</span><span class="p">,</span> <span class="s">&#34;Hell&#34;</span><span class="p">),</span>
  <span class="p">(</span><span class="mf">0.5</span><span class="p">,</span> <span class="s">&#34;Hello&#34;</span><span class="p">),</span>
  <span class="p">(</span><span class="mf">0.6</span><span class="p">,</span> <span class="s">&#34;Hello &#34;</span><span class="p">),</span>
  <span class="p">(</span><span class="mf">2.0</span><span class="p">,</span> <span class="s">&#34;Hello W&#34;</span><span class="p">),</span>
  <span class="p">(</span><span class="mf">2.1</span><span class="p">,</span> <span class="s">&#34;Hello Wo&#34;</span><span class="p">),</span>
  <span class="p">(</span><span class="mf">2.2</span><span class="p">,</span> <span class="s">&#34;Hello Wor&#34;</span><span class="p">),</span>
  <span class="p">(</span><span class="mf">2.4</span><span class="p">,</span> <span class="s">&#34;Hello Worl&#34;</span><span class="p">),</span>
  <span class="p">(</span><span class="mf">2.5</span><span class="p">,</span> <span class="s">&#34;Hello World&#34;</span><span class="p">)</span>
<span class="p">]</span>

<span class="c1">// 节流</span>
<span class="c1">// A Boolean value that indicates whether to publish the most recent element. If false, the publisher emits the first element received during the interval.</span>
<span class="c1">// bool 控制是否发布最近的元素，false 时发射一段时间内最初的元素</span>
<span class="kd">let</span> <span class="nv">subject</span> <span class="p">=</span> <span class="n">PassthroughSubject</span><span class="p">&lt;</span><span class="nb">String</span><span class="p">,</span> <span class="n">Never</span><span class="p">&gt;()</span>
<span class="kd">let</span> <span class="nv">throttled</span> <span class="p">=</span> <span class="n">subject</span>
    <span class="p">.</span><span class="n">throttle</span><span class="p">(</span><span class="k">for</span><span class="p">:</span> <span class="p">.</span><span class="n">seconds</span><span class="p">(</span><span class="mf">1.0</span><span class="p">),</span> <span class="n">scheduler</span><span class="p">:</span> <span class="n">DispatchQueue</span><span class="p">.</span><span class="n">main</span><span class="p">,</span> <span class="n">latest</span><span class="p">:</span> <span class="kc">true</span><span class="p">)</span>
    <span class="p">.</span><span class="n">share</span><span class="p">()</span>

<span class="n">subject</span><span class="p">.</span><span class="n">sink</span><span class="p">(</span><span class="n">receiveCompletion</span><span class="p">:</span> <span class="p">{</span> <span class="bp">print</span><span class="p">(</span><span class="nv">$0</span><span class="p">)</span> <span class="p">},</span> <span class="n">receiveValue</span><span class="p">:</span> <span class="p">{</span> <span class="bp">print</span><span class="p">(</span><span class="s">&#34;s&#34;</span><span class="p">,</span> <span class="nv">$0</span><span class="p">)</span> <span class="p">}).</span><span class="n">store</span><span class="p">(</span><span class="k">in</span><span class="p">:</span> <span class="p">&amp;</span><span class="n">subs</span><span class="p">)</span>
<span class="n">throttled</span><span class="p">.</span><span class="n">sink</span><span class="p">(</span><span class="n">receiveValue</span><span class="p">:</span> <span class="p">{</span> <span class="bp">print</span><span class="p">(</span><span class="s">&#34;t&#34;</span><span class="p">,</span> <span class="nv">$0</span><span class="p">)</span> <span class="p">}).</span><span class="n">store</span><span class="p">(</span><span class="k">in</span><span class="p">:</span> <span class="p">&amp;</span><span class="n">subs</span><span class="p">)</span>

<span class="n">subject</span><span class="p">.</span><span class="n">feed</span><span class="p">(</span><span class="n">with</span><span class="p">:</span> <span class="n">typingHelloWorld</span><span class="p">)</span>

<span class="c1">//区别:</span>
<span class="c1">//去抖在小于等待的时间内暂停接收（去除抖动时的操作）</span>
<span class="c1">//节流按时发车，取该时间段内首个或最后一个值</span>

<span class="c1">// latest: false</span>
<span class="c1">//s H</span>
<span class="c1">//t H // 0-1s 内的第一个元素</span>
<span class="c1">//s He</span>
<span class="c1">//s Hel</span>
<span class="c1">//s Hell</span>
<span class="c1">//s Hello</span>
<span class="c1">//s Hello</span>
<span class="c1">//t He // 1-2s 内的第一个元素</span>
<span class="c1">//s Hello W</span>
<span class="c1">//s Hello Wo</span>
<span class="c1">//t Hello W // 2-3s 内的第一个元素</span>
<span class="c1">//s Hello Wor</span>
<span class="c1">//s Hello Worl</span>
<span class="c1">//s Hello World</span>
<span class="c1">//t Hello Wor // 3-4s 内的第一个元素</span>
<span class="c1">//finished</span>

<span class="c1">//s H</span>
<span class="c1">//t H // 0-1s 内的最后一个元素</span>
<span class="c1">//s He</span>
<span class="c1">//s Hel</span>
<span class="c1">//s Hell</span>
<span class="c1">//s Hello</span>
<span class="c1">//s Hello</span>
<span class="c1">//t Hello // 1-2s 内的最后一个元素</span>
<span class="c1">//s Hello W</span>
<span class="c1">//s Hello Wo</span>
<span class="c1">//s Hello Wor</span>
<span class="c1">//s Hello Worl</span>
<span class="c1">//s Hello World</span>
<span class="c1">//t Hello World // 2-3s 内的最后一个元素</span>
<span class="c1">//finished</span>
</code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-swift" data-lang="swift"><span class="kd">import</span> <span class="nc">UIKit</span>
<span class="kd">import</span> <span class="nc">SwiftUI</span>
<span class="kd">import</span> <span class="nc">Combine</span>

<span class="kd">var</span> <span class="nv">subs</span> <span class="p">=</span> <span class="p">[</span><span class="n">AnyCancellable</span><span class="p">]()</span>

<span class="kd">enum</span> <span class="nc">TimeoutError</span><span class="p">:</span> <span class="n">Error</span> <span class="p">{</span>
  <span class="k">case</span> <span class="n">timedOut</span>
<span class="p">}</span>

<span class="kd">let</span> <span class="nv">sub</span> <span class="p">=</span> <span class="n">PassthroughSubject</span><span class="p">&lt;</span><span class="nb">Void</span><span class="p">,</span> <span class="n">Never</span><span class="p">&gt;()</span>
<span class="c1">//let sub = PassthroughSubject&lt;Void, TimeoutError&gt;()</span>
<span class="kd">let</span> <span class="nv">timedOutSubject</span> <span class="p">=</span> <span class="n">sub</span><span class="p">.</span><span class="n">timeout</span><span class="p">(.</span><span class="n">seconds</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span>
                                  <span class="n">scheduler</span><span class="p">:</span> <span class="n">DispatchQueue</span><span class="p">.</span><span class="n">main</span> <span class="cm">/*,
</span><span class="cm">                                  customError: { .timedOut }*/</span><span class="p">)</span>

<span class="n">DispatchQueue</span><span class="p">.</span><span class="n">main</span><span class="p">.</span><span class="n">asyncAfter</span><span class="p">(</span><span class="n">deadline</span><span class="p">:</span> <span class="p">.</span><span class="n">now</span><span class="p">()</span> <span class="o">+</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">sub</span><span class="p">.</span><span class="n">send</span><span class="p">()</span>
<span class="p">}</span>

<span class="n">sub</span><span class="p">.</span><span class="n">sink</span><span class="p">(</span><span class="n">receiveCompletion</span><span class="p">:</span> <span class="p">{</span> <span class="bp">print</span><span class="p">(</span><span class="nv">$0</span><span class="p">)</span> <span class="p">},</span> <span class="n">receiveValue</span><span class="p">:</span> <span class="p">{</span> <span class="bp">print</span><span class="p">(</span><span class="s">&#34;sub&#34;</span><span class="p">,</span> <span class="nv">$0</span><span class="p">)</span> <span class="p">}).</span><span class="n">store</span><span class="p">(</span><span class="k">in</span><span class="p">:</span> <span class="p">&amp;</span><span class="n">subs</span><span class="p">)</span>
<span class="n">timedOutSubject</span><span class="p">.</span><span class="n">sink</span><span class="p">(</span><span class="n">receiveCompletion</span><span class="p">:</span> <span class="p">{</span> <span class="bp">print</span><span class="p">(</span><span class="nv">$0</span><span class="p">)</span> <span class="p">},</span> <span class="n">receiveValue</span><span class="p">:</span> <span class="p">{</span> <span class="bp">print</span><span class="p">(</span><span class="s">&#34;timeout&#34;</span><span class="p">,</span> <span class="nv">$0</span><span class="p">)</span> <span class="p">}).</span><span class="n">store</span><span class="p">(</span><span class="k">in</span><span class="p">:</span> <span class="p">&amp;</span><span class="n">subs</span><span class="p">)</span>

<span class="c1">//finished // 超时即完成</span>
<span class="c1">//sub ()</span>

<span class="c1">// 定义 customError</span>
<span class="c1">//failure(__lldb_expr_19.TimeoutError.timedOut)</span>
<span class="c1">//sub ()</span>
</code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-swift" data-lang="swift"><span class="kd">import</span> <span class="nc">UIKit</span>
<span class="kd">import</span> <span class="nc">SwiftUI</span>
<span class="kd">import</span> <span class="nc">Combine</span>

<span class="kd">var</span> <span class="nv">subs</span> <span class="p">=</span> <span class="p">[</span><span class="n">AnyCancellable</span><span class="p">]()</span>

<span class="kd">public</span> <span class="kd">let</span> <span class="nv">typingHelloWorld</span><span class="p">:</span> <span class="p">[(</span><span class="n">TimeInterval</span><span class="p">,</span> <span class="nb">String</span><span class="p">)]</span> <span class="p">=</span> <span class="p">[</span>
  <span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="s">&#34;H&#34;</span><span class="p">),</span>
  <span class="p">(</span><span class="mf">0.1</span><span class="p">,</span> <span class="s">&#34;He&#34;</span><span class="p">),</span>
  <span class="p">(</span><span class="mf">0.2</span><span class="p">,</span> <span class="s">&#34;Hel&#34;</span><span class="p">),</span>
  <span class="p">(</span><span class="mf">0.3</span><span class="p">,</span> <span class="s">&#34;Hell&#34;</span><span class="p">),</span>
  <span class="p">(</span><span class="mf">0.5</span><span class="p">,</span> <span class="s">&#34;Hello&#34;</span><span class="p">),</span>
  <span class="p">(</span><span class="mf">0.6</span><span class="p">,</span> <span class="s">&#34;Hello &#34;</span><span class="p">),</span>
  <span class="p">(</span><span class="mf">2.0</span><span class="p">,</span> <span class="s">&#34;Hello W&#34;</span><span class="p">),</span>
  <span class="p">(</span><span class="mf">2.1</span><span class="p">,</span> <span class="s">&#34;Hello Wo&#34;</span><span class="p">),</span>
  <span class="p">(</span><span class="mf">2.2</span><span class="p">,</span> <span class="s">&#34;Hello Wor&#34;</span><span class="p">),</span>
  <span class="p">(</span><span class="mf">2.4</span><span class="p">,</span> <span class="s">&#34;Hello Worl&#34;</span><span class="p">),</span>
  <span class="p">(</span><span class="mf">2.5</span><span class="p">,</span> <span class="s">&#34;Hello World&#34;</span><span class="p">)</span>
<span class="p">]</span>

<span class="kd">let</span> <span class="nv">sub</span> <span class="p">=</span> <span class="n">PassthroughSubject</span><span class="p">&lt;</span><span class="nb">String</span><span class="p">,</span> <span class="n">Never</span><span class="p">&gt;()</span>
<span class="kd">let</span> <span class="nv">measure</span> <span class="p">=</span> <span class="n">sub</span><span class="p">.</span><span class="n">measureInterval</span><span class="p">(</span><span class="n">using</span><span class="p">:</span> <span class="n">DispatchQueue</span><span class="p">.</span><span class="n">main</span><span class="p">)</span>

<span class="n">sub</span><span class="p">.</span><span class="n">sink</span><span class="p">(</span><span class="n">receiveCompletion</span><span class="p">:</span> <span class="p">{</span> <span class="bp">print</span><span class="p">(</span><span class="nv">$0</span><span class="p">)</span> <span class="p">},</span> <span class="n">receiveValue</span><span class="p">:</span> <span class="p">{</span> <span class="bp">print</span><span class="p">(</span><span class="s">&#34;sub&#34;</span><span class="p">,</span> <span class="nv">$0</span><span class="p">)</span> <span class="p">}).</span><span class="n">store</span><span class="p">(</span><span class="k">in</span><span class="p">:</span> <span class="p">&amp;</span><span class="n">subs</span><span class="p">)</span>
<span class="c1">//measure.sink(receiveCompletion: { print($0) }, receiveValue: { print(&#34;measure \(Double($0.magnitude) / 1_000_000_000.0)&#34;) }).store(in: &amp;subs)</span>

<span class="c1">// 默认单位纳秒，转换为秒：</span>
<span class="c1">//sub H</span>
<span class="c1">//measure 0.010279283</span>
<span class="c1">//sub He</span>
<span class="c1">//measure 0.097314792</span>
<span class="c1">//sub Hel</span>
<span class="c1">//measure 0.106212119</span>
<span class="c1">//sub Hell</span>
<span class="c1">//measure 0.113224792</span>
<span class="c1">//sub Hello</span>
<span class="c1">//measure 0.197550122</span>
<span class="c1">//sub Hello</span>
<span class="c1">//measure 0.129873388</span>
<span class="c1">//sub Hello W</span>
<span class="c1">//measure 1.346181832</span>
<span class="c1">//sub Hello Wo</span>
<span class="c1">//measure 0.103605421</span>
<span class="c1">//sub Hello Wor</span>
<span class="c1">//measure 0.096385811</span>
<span class="c1">//sub Hello Worl</span>
<span class="c1">//measure 0.19998862</span>
<span class="c1">//sub Hello World</span>
<span class="c1">//measure 0.10001298</span>
<span class="c1">//finished</span>
<span class="c1">//finished</span>

<span class="c1">// RunLoop</span>
<span class="c1">// 通常，对所有内容都坚持使用DispatchQueue是一个好主意</span>
<span class="kd">let</span> <span class="nv">measureSubject2</span> <span class="p">=</span> <span class="n">sub</span><span class="p">.</span><span class="n">measureInterval</span><span class="p">(</span><span class="n">using</span><span class="p">:</span> <span class="n">RunLoop</span><span class="p">.</span><span class="n">main</span><span class="p">)</span>
<span class="n">measureSubject2</span><span class="p">.</span><span class="n">sink</span><span class="p">(</span><span class="n">receiveCompletion</span><span class="p">:</span> <span class="p">{</span> <span class="bp">print</span><span class="p">(</span><span class="nv">$0</span><span class="p">)</span> <span class="p">},</span> <span class="n">receiveValue</span><span class="p">:</span> <span class="p">{</span> <span class="bp">print</span><span class="p">(</span><span class="s">&#34;measure </span><span class="si">\(</span><span class="nv">$0</span><span class="si">)</span><span class="s">&#34;</span><span class="p">)</span> <span class="p">}).</span><span class="n">store</span><span class="p">(</span><span class="k">in</span><span class="p">:</span> <span class="p">&amp;</span><span class="n">subs</span><span class="p">)</span>

<span class="n">sub</span><span class="p">.</span><span class="n">feed</span><span class="p">(</span><span class="n">with</span><span class="p">:</span> <span class="n">typingHelloWorld</span><span class="p">)</span>
<span class="c1">//sub H</span>
<span class="c1">//measure Stride(magnitude: 0.008931994438171387)</span>
<span class="c1">//sub He</span>
<span class="c1">//measure Stride(magnitude: 0.10000407695770264)</span>
<span class="c1">//sub Hel</span>
<span class="c1">//measure Stride(magnitude: 0.1105649471282959)</span>
<span class="c1">//sub Hell</span>
<span class="c1">//measure Stride(magnitude: 0.10970902442932129)</span>
<span class="c1">//sub Hello</span>
<span class="c1">//measure Stride(magnitude: 0.21341097354888916)</span>
<span class="c1">//sub Hello</span>
<span class="c1">//measure Stride(magnitude: 0.11738002300262451)</span>
<span class="c1">//sub Hello W</span>
<span class="c1">//measure Stride(magnitude: 1.3406749963760376)</span>
<span class="c1">//sub Hello Wo</span>
<span class="c1">//measure Stride(magnitude: 0.10406196117401123)</span>
<span class="c1">//sub Hello Wor</span>
<span class="c1">//measure Stride(magnitude: 0.09577000141143799)</span>
<span class="c1">//sub Hello Worl</span>
<span class="c1">//measure Stride(magnitude: 0.20008206367492676)</span>
<span class="c1">//sub Hello World</span>
<span class="c1">//measure Stride(magnitude: 0.10001897811889648)</span>
<span class="c1">//finished</span>
<span class="c1">//finished</span>
</code></pre></div><h2 id="7">7</h2>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-swift" data-lang="swift"><span class="kd">import</span> <span class="nc">UIKit</span>
<span class="kd">import</span> <span class="nc">SwiftUI</span>
<span class="kd">import</span> <span class="nc">Combine</span>

<span class="kd">var</span> <span class="nv">subs</span> <span class="p">=</span> <span class="p">[</span><span class="n">AnyCancellable</span><span class="p">]()</span>

<span class="n">example</span><span class="p">(</span><span class="n">of</span><span class="p">:</span> <span class="s">&#34;min &amp; max&#34;</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">let</span> <span class="nv">pub1</span> <span class="p">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">50</span><span class="p">,</span> <span class="mi">246</span><span class="p">,</span> <span class="mi">0</span><span class="p">].</span><span class="n">publisher</span>

    <span class="n">pub1</span>
        <span class="p">.</span><span class="bp">print</span><span class="p">(</span><span class="s">&#34;pub1&#34;</span><span class="p">)</span>
        <span class="p">.</span><span class="bp">min</span><span class="p">()</span> <span class="c1">// Int 遵守 Comparable，找到序列中的最小值，min 是贪婪的，需序列发射完毕才会</span>
        <span class="p">.</span><span class="n">sink</span><span class="p">(</span><span class="n">receiveCompletion</span><span class="p">:</span> <span class="p">{</span> <span class="bp">print</span><span class="p">(</span><span class="nv">$0</span><span class="p">)</span> <span class="p">},</span>
              <span class="n">receiveValue</span><span class="p">:</span> <span class="p">{</span> <span class="bp">print</span><span class="p">(</span><span class="nv">$0</span><span class="p">)</span> <span class="p">})</span>
        <span class="p">.</span><span class="n">store</span><span class="p">(</span><span class="k">in</span><span class="p">:</span> <span class="p">&amp;</span><span class="n">subs</span><span class="p">)</span>

    <span class="bp">print</span><span class="p">(</span><span class="s">&#34;---&#34;</span><span class="p">)</span>

    <span class="kd">let</span> <span class="nv">pub2</span> <span class="p">=</span> <span class="p">[</span><span class="s">&#34;12345&#34;</span><span class="p">,</span> <span class="s">&#34;ab&#34;</span><span class="p">,</span> <span class="s">&#34;hello world&#34;</span><span class="p">]</span>
        <span class="p">.</span><span class="n">compactMap</span> <span class="p">{</span> <span class="nv">$0</span><span class="p">.</span><span class="n">data</span><span class="p">(</span><span class="n">using</span><span class="p">:</span> <span class="p">.</span><span class="n">utf8</span><span class="p">)</span> <span class="p">}</span>
        <span class="p">.</span><span class="n">publisher</span>
    <span class="n">pub2</span>
        <span class="p">.</span><span class="bp">print</span><span class="p">(</span><span class="s">&#34;pub2&#34;</span><span class="p">)</span>
        <span class="p">.</span><span class="bp">min</span><span class="p">(</span><span class="n">by</span><span class="p">:</span> <span class="p">{</span> <span class="nv">$0</span><span class="p">.</span><span class="bp">count</span> <span class="o">&lt;</span> <span class="nv">$1</span><span class="p">.</span><span class="bp">count</span> <span class="p">})</span> <span class="c1">// 未遵守 Comparable 可自己实现，以找到序列中的最小值</span>
        <span class="p">.</span><span class="n">sink</span><span class="p">(</span><span class="n">receiveCompletion</span><span class="p">:</span> <span class="p">{</span> <span class="bp">print</span><span class="p">(</span><span class="nv">$0</span><span class="p">)</span> <span class="p">},</span>
              <span class="n">receiveValue</span><span class="p">:</span> <span class="p">{</span> <span class="bp">print</span><span class="p">(</span><span class="nv">$0</span><span class="p">)</span> <span class="p">})</span>
        <span class="p">.</span><span class="n">store</span><span class="p">(</span><span class="k">in</span><span class="p">:</span> <span class="p">&amp;</span><span class="n">subs</span><span class="p">)</span>

    <span class="bp">print</span><span class="p">(</span><span class="s">&#34;---&#34;</span><span class="p">)</span>

    <span class="kd">let</span> <span class="nv">pub3</span> <span class="p">=</span> <span class="p">[</span><span class="s">&#34;A&#34;</span><span class="p">,</span> <span class="s">&#34;F&#34;</span><span class="p">,</span> <span class="s">&#34;Z&#34;</span><span class="p">,</span> <span class="s">&#34;E&#34;</span><span class="p">].</span><span class="n">publisher</span>
    <span class="n">pub3</span>
        <span class="p">.</span><span class="bp">print</span><span class="p">(</span><span class="s">&#34;pub3&#34;</span><span class="p">)</span>
        <span class="p">.</span><span class="bp">max</span><span class="p">()</span>
        <span class="p">.</span><span class="n">sink</span><span class="p">(</span><span class="n">receiveCompletion</span><span class="p">:</span> <span class="p">{</span> <span class="bp">print</span><span class="p">(</span><span class="nv">$0</span><span class="p">)</span> <span class="p">},</span>
              <span class="n">receiveValue</span><span class="p">:</span> <span class="p">{</span> <span class="bp">print</span><span class="p">(</span><span class="nv">$0</span><span class="p">)</span> <span class="p">})</span>
        <span class="p">.</span><span class="n">store</span><span class="p">(</span><span class="k">in</span><span class="p">:</span> <span class="p">&amp;</span><span class="n">subs</span><span class="p">)</span>

    <span class="c1">// max(by:) 同理</span>

<span class="p">}</span>

<span class="c1">//——— Example of: min ———</span>
<span class="c1">//pub: receive subscription: ([1, -50, 246, 0])</span>
<span class="c1">//pub: request unlimited</span>
<span class="c1">//pub: receive value: (1)</span>
<span class="c1">//pub: receive value: (-50)</span>
<span class="c1">//pub: receive value: (246)</span>
<span class="c1">//pub: receive value: (0)</span>
<span class="c1">//pub: receive finished</span>
<span class="c1">//-50</span>
<span class="c1">//finished</span>
<span class="c1">//---</span>
<span class="c1">//pub2: receive subscription: ([5 bytes, 2 bytes, 11 bytes])</span>
<span class="c1">//pub2: request unlimited</span>
<span class="c1">//pub2: receive value: (5 bytes)</span>
<span class="c1">//pub2: receive value: (2 bytes)</span>
<span class="c1">//pub2: receive value: (11 bytes)</span>
<span class="c1">//pub2: receive finished</span>
<span class="c1">//2 bytes</span>
<span class="c1">//finished</span>
<span class="c1">//---</span>
<span class="c1">//pub3: receive subscription: ([&#34;A&#34;, &#34;F&#34;, &#34;Z&#34;, &#34;E&#34;])</span>
<span class="c1">//pub3: request unlimited</span>
<span class="c1">//pub3: receive value: (A)</span>
<span class="c1">//pub3: receive value: (F)</span>
<span class="c1">//pub3: receive value: (Z)</span>
<span class="c1">//pub3: receive value: (E)</span>
<span class="c1">//pub3: receive finished</span>
<span class="c1">//Z</span>
<span class="c1">//finished</span>
</code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-swift" data-lang="swift"><span class="kd">import</span> <span class="nc">UIKit</span>
<span class="kd">import</span> <span class="nc">SwiftUI</span>
<span class="kd">import</span> <span class="nc">Combine</span>

<span class="kd">var</span> <span class="nv">subs</span> <span class="p">=</span> <span class="p">[</span><span class="n">AnyCancellable</span><span class="p">]()</span>

<span class="n">example</span><span class="p">(</span><span class="n">of</span><span class="p">:</span> <span class="s">&#34;first &amp; last&#34;</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">let</span> <span class="nv">pub1</span> <span class="p">=</span> <span class="p">[</span><span class="s">&#34;A&#34;</span><span class="p">,</span> <span class="s">&#34;B&#34;</span><span class="p">,</span> <span class="s">&#34;C&#34;</span><span class="p">].</span><span class="n">publisher</span>

    <span class="n">pub1</span>
        <span class="p">.</span><span class="bp">print</span><span class="p">(</span><span class="s">&#34;pub1&#34;</span><span class="p">)</span>
        <span class="p">.</span><span class="bp">first</span><span class="p">()</span> <span class="c1">// 收到第一个发射的值即取消订阅</span>
        <span class="p">.</span><span class="n">sink</span><span class="p">(</span><span class="n">receiveCompletion</span><span class="p">:</span> <span class="p">{</span> <span class="bp">print</span><span class="p">(</span><span class="nv">$0</span><span class="p">)</span> <span class="p">},</span>
              <span class="n">receiveValue</span><span class="p">:</span> <span class="p">{</span> <span class="bp">print</span><span class="p">(</span><span class="nv">$0</span><span class="p">)</span> <span class="p">})</span>
        <span class="p">.</span><span class="n">store</span><span class="p">(</span><span class="k">in</span><span class="p">:</span> <span class="p">&amp;</span><span class="n">subs</span><span class="p">)</span>

    <span class="bp">print</span><span class="p">(</span><span class="s">&#34;---&#34;</span><span class="p">)</span>

    <span class="kd">let</span> <span class="nv">pub2</span> <span class="p">=</span> <span class="p">[</span><span class="s">&#34;A&#34;</span><span class="p">,</span> <span class="s">&#34;B&#34;</span><span class="p">,</span> <span class="s">&#34;C&#34;</span><span class="p">,</span> <span class="s">&#34;B&#34;</span><span class="p">].</span><span class="n">publisher</span>

    <span class="n">pub2</span>
        <span class="p">.</span><span class="bp">print</span><span class="p">(</span><span class="s">&#34;pub2&#34;</span><span class="p">)</span>
        <span class="p">.</span><span class="bp">first</span><span class="p">(</span><span class="k">where</span><span class="p">:</span> <span class="p">{</span> <span class="nv">$0</span> <span class="p">==</span> <span class="s">&#34;B&#34;</span> <span class="p">})</span> <span class="c1">// 找到第一个满足条件</span>
        <span class="p">.</span><span class="n">sink</span><span class="p">(</span><span class="n">receiveCompletion</span><span class="p">:</span> <span class="p">{</span> <span class="bp">print</span><span class="p">(</span><span class="nv">$0</span><span class="p">)</span> <span class="p">},</span>
              <span class="n">receiveValue</span><span class="p">:</span> <span class="p">{</span> <span class="bp">print</span><span class="p">(</span><span class="nv">$0</span><span class="p">)</span> <span class="p">})</span>
        <span class="p">.</span><span class="n">store</span><span class="p">(</span><span class="k">in</span><span class="p">:</span> <span class="p">&amp;</span><span class="n">subs</span><span class="p">)</span>

    <span class="bp">print</span><span class="p">(</span><span class="s">&#34;---&#34;</span><span class="p">)</span>

    <span class="kd">let</span> <span class="nv">pub3</span> <span class="p">=</span> <span class="p">[</span><span class="s">&#34;A&#34;</span><span class="p">,</span> <span class="s">&#34;B&#34;</span><span class="p">,</span> <span class="s">&#34;C&#34;</span><span class="p">].</span><span class="n">publisher</span>

    <span class="n">pub3</span>
        <span class="p">.</span><span class="bp">print</span><span class="p">(</span><span class="s">&#34;pub3&#34;</span><span class="p">)</span>
        <span class="p">.</span><span class="bp">last</span><span class="p">()</span> <span class="c1">// 贪婪，需等待发射完成</span>
        <span class="p">.</span><span class="n">sink</span><span class="p">(</span><span class="n">receiveCompletion</span><span class="p">:</span> <span class="p">{</span> <span class="bp">print</span><span class="p">(</span><span class="nv">$0</span><span class="p">)</span> <span class="p">},</span>
              <span class="n">receiveValue</span><span class="p">:</span> <span class="p">{</span> <span class="bp">print</span><span class="p">(</span><span class="nv">$0</span><span class="p">)</span> <span class="p">})</span>
        <span class="p">.</span><span class="n">store</span><span class="p">(</span><span class="k">in</span><span class="p">:</span> <span class="p">&amp;</span><span class="n">subs</span><span class="p">)</span>

    <span class="c1">// last(where:) 同理</span>
<span class="p">}</span>
<span class="c1">//——— Example of: first ———</span>
<span class="c1">//pub1: receive subscription: ([&#34;A&#34;, &#34;B&#34;, &#34;C&#34;])</span>
<span class="c1">//pub1: request unlimited</span>
<span class="c1">//pub1: receive value: (A)</span>
<span class="c1">//pub1: receive cancel</span>
<span class="c1">//A</span>
<span class="c1">//finished</span>
<span class="c1">//---</span>
<span class="c1">//pub2: receive subscription: ([&#34;A&#34;, &#34;B&#34;, &#34;C&#34;])</span>
<span class="c1">//pub2: request unlimited</span>
<span class="c1">//pub2: receive value: (A)</span>
<span class="c1">//pub2: receive value: (B)</span>
<span class="c1">//pub2: receive cancel</span>
<span class="c1">//B</span>
<span class="c1">//finished</span>
<span class="c1">//---</span>
<span class="c1">//pub3: receive subscription: ([&#34;A&#34;, &#34;B&#34;, &#34;C&#34;])</span>
<span class="c1">//pub3: request unlimited</span>
<span class="c1">//pub3: receive value: (A)</span>
<span class="c1">//pub3: receive value: (B)</span>
<span class="c1">//pub3: receive value: (C)</span>
<span class="c1">//pub3: receive finished</span>
<span class="c1">//C</span>
<span class="c1">//finished</span>
</code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-swift" data-lang="swift"><span class="kd">import</span> <span class="nc">UIKit</span>
<span class="kd">import</span> <span class="nc">SwiftUI</span>
<span class="kd">import</span> <span class="nc">Combine</span>

<span class="kd">var</span> <span class="nv">subs</span> <span class="p">=</span> <span class="p">[</span><span class="n">AnyCancellable</span><span class="p">]()</span>

<span class="n">example</span><span class="p">(</span><span class="n">of</span><span class="p">:</span> <span class="s">&#34;output&#34;</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">let</span> <span class="nv">pub1</span> <span class="p">=</span> <span class="p">[</span><span class="s">&#34;A&#34;</span><span class="p">,</span> <span class="s">&#34;B&#34;</span><span class="p">,</span> <span class="s">&#34;C&#34;</span><span class="p">].</span><span class="n">publisher</span>

    <span class="n">pub1</span>
        <span class="p">.</span><span class="bp">print</span><span class="p">(</span><span class="s">&#34;pub1&#34;</span><span class="p">)</span>
        <span class="p">.</span><span class="n">output</span><span class="p">(</span><span class="n">at</span><span class="p">:</span> <span class="mi">1</span><span class="p">)</span> <span class="c1">// 索引为 1 的值，传入超过的索引值则不发射</span>
        <span class="p">.</span><span class="n">sink</span><span class="p">(</span><span class="n">receiveCompletion</span><span class="p">:</span> <span class="p">{</span> <span class="bp">print</span><span class="p">(</span><span class="nv">$0</span><span class="p">)</span> <span class="p">},</span>
              <span class="n">receiveValue</span><span class="p">:</span> <span class="p">{</span> <span class="bp">print</span><span class="p">(</span><span class="nv">$0</span><span class="p">)</span> <span class="p">})</span>
        <span class="p">.</span><span class="n">store</span><span class="p">(</span><span class="k">in</span><span class="p">:</span> <span class="p">&amp;</span><span class="n">subs</span><span class="p">)</span>

    <span class="bp">print</span><span class="p">(</span><span class="s">&#34;---&#34;</span><span class="p">)</span>

    <span class="kd">let</span> <span class="nv">pub2</span> <span class="p">=</span> <span class="p">[</span><span class="s">&#34;A&#34;</span><span class="p">,</span> <span class="s">&#34;B&#34;</span><span class="p">,</span> <span class="s">&#34;C&#34;</span><span class="p">].</span><span class="n">publisher</span>

    <span class="n">pub2</span>
        <span class="p">.</span><span class="bp">print</span><span class="p">(</span><span class="s">&#34;pub2&#34;</span><span class="p">)</span>
        <span class="p">.</span><span class="n">output</span><span class="p">(</span><span class="k">in</span><span class="p">:</span> <span class="mf">1.</span><span class="p">..</span><span class="mi">2</span><span class="p">)</span> <span class="c1">// Range</span>
        <span class="p">.</span><span class="n">sink</span><span class="p">(</span><span class="n">receiveCompletion</span><span class="p">:</span> <span class="p">{</span> <span class="bp">print</span><span class="p">(</span><span class="nv">$0</span><span class="p">)</span> <span class="p">},</span>
              <span class="n">receiveValue</span><span class="p">:</span> <span class="p">{</span> <span class="bp">print</span><span class="p">(</span><span class="nv">$0</span><span class="p">)</span> <span class="p">})</span>
        <span class="p">.</span><span class="n">store</span><span class="p">(</span><span class="k">in</span><span class="p">:</span> <span class="p">&amp;</span><span class="n">subs</span><span class="p">)</span>

    <span class="bp">print</span><span class="p">(</span><span class="s">&#34;---&#34;</span><span class="p">)</span>



<span class="p">}</span>
<span class="c1">//pub1: receive subscription: ([&#34;A&#34;, &#34;B&#34;, &#34;C&#34;])</span>
<span class="c1">//pub1: request unlimited</span>
<span class="c1">//pub1: receive value: (A)</span>
<span class="c1">//pub1: request max: (1) (synchronous) // 注意这里，每发射一个值后，demands 会自增，因为其知道是在特定索引下查找</span>
<span class="c1">//pub1: receive value: (B)</span>
<span class="c1">//B // 索引为 1 的值，传入超过的索引值则不发射</span>
<span class="c1">//pub1: receive cancel</span>
<span class="c1">//finished</span>
<span class="c1">//---</span>
<span class="c1">//pub2: receive subscription: ([&#34;A&#34;, &#34;B&#34;, &#34;C&#34;])</span>
<span class="c1">//pub2: request unlimited</span>
<span class="c1">//pub2: receive value: (A)</span>
<span class="c1">//pub2: request max: (1) (synchronous)</span>
<span class="c1">//pub2: receive value: (B)</span>
<span class="c1">//B // 注意：发射的是范围内的单个值</span>
<span class="c1">//pub2: receive value: (C)</span>
<span class="c1">//C</span>
<span class="c1">//pub2: receive cancel // 足够后立即取消订阅</span>
<span class="c1">//finished</span>
<span class="c1">//pub2: receive finished</span>
</code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-swift" data-lang="swift"><span class="kd">import</span> <span class="nc">UIKit</span>
<span class="kd">import</span> <span class="nc">SwiftUI</span>
<span class="kd">import</span> <span class="nc">Combine</span>

<span class="kd">var</span> <span class="nv">subs</span> <span class="p">=</span> <span class="p">[</span><span class="n">AnyCancellable</span><span class="p">]()</span>

<span class="n">example</span><span class="p">(</span><span class="n">of</span><span class="p">:</span> <span class="s">&#34;query&#34;</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">let</span> <span class="nv">pub1</span> <span class="p">=</span> <span class="p">[</span><span class="s">&#34;A&#34;</span><span class="p">,</span> <span class="s">&#34;B&#34;</span><span class="p">,</span> <span class="s">&#34;C&#34;</span><span class="p">].</span><span class="n">publisher</span>

    <span class="n">pub1</span>
        <span class="p">.</span><span class="bp">print</span><span class="p">(</span><span class="s">&#34;pub1&#34;</span><span class="p">)</span>
        <span class="p">.</span><span class="bp">count</span><span class="p">()</span> <span class="c1">// 计数，贪婪，需完成才发出</span>
        <span class="p">.</span><span class="n">sink</span><span class="p">(</span><span class="n">receiveCompletion</span><span class="p">:</span> <span class="p">{</span> <span class="bp">print</span><span class="p">(</span><span class="nv">$0</span><span class="p">)</span> <span class="p">},</span>
              <span class="n">receiveValue</span><span class="p">:</span> <span class="p">{</span> <span class="bp">print</span><span class="p">(</span><span class="nv">$0</span><span class="p">)</span> <span class="p">})</span>
        <span class="p">.</span><span class="n">store</span><span class="p">(</span><span class="k">in</span><span class="p">:</span> <span class="p">&amp;</span><span class="n">subs</span><span class="p">)</span>

    <span class="bp">print</span><span class="p">(</span><span class="s">&#34;---&#34;</span><span class="p">)</span>

    <span class="kd">let</span> <span class="nv">pub2</span> <span class="p">=</span> <span class="p">[</span><span class="s">&#34;A&#34;</span><span class="p">,</span> <span class="s">&#34;B&#34;</span><span class="p">,</span> <span class="s">&#34;C&#34;</span><span class="p">].</span><span class="n">publisher</span>

    <span class="n">pub2</span>
        <span class="p">.</span><span class="bp">print</span><span class="p">(</span><span class="s">&#34;pub2 - 1&#34;</span><span class="p">)</span>
        <span class="p">.</span><span class="bp">contains</span><span class="p">(</span><span class="s">&#34;B&#34;</span><span class="p">)</span> <span class="c1">// 惰性，包含则发射 true，并取消订阅</span>
        <span class="p">.</span><span class="n">sink</span><span class="p">(</span><span class="n">receiveCompletion</span><span class="p">:</span> <span class="p">{</span> <span class="bp">print</span><span class="p">(</span><span class="nv">$0</span><span class="p">)</span> <span class="p">},</span>
              <span class="n">receiveValue</span><span class="p">:</span> <span class="p">{</span> <span class="bp">print</span><span class="p">(</span><span class="nv">$0</span><span class="p">)</span> <span class="p">})</span>
        <span class="p">.</span><span class="n">store</span><span class="p">(</span><span class="k">in</span><span class="p">:</span> <span class="p">&amp;</span><span class="n">subs</span><span class="p">)</span>

    <span class="bp">print</span><span class="p">(</span><span class="s">&#34;---&#34;</span><span class="p">)</span>

    <span class="n">pub2</span>
        <span class="p">.</span><span class="bp">print</span><span class="p">(</span><span class="s">&#34;pub2 - 2&#34;</span><span class="p">)</span>
        <span class="p">.</span><span class="bp">contains</span><span class="p">(</span><span class="s">&#34;D&#34;</span><span class="p">)</span> <span class="c1">// 等到完成都找不到则发射 fakse</span>
        <span class="p">.</span><span class="n">sink</span><span class="p">(</span><span class="n">receiveCompletion</span><span class="p">:</span> <span class="p">{</span> <span class="bp">print</span><span class="p">(</span><span class="nv">$0</span><span class="p">)</span> <span class="p">},</span>
              <span class="n">receiveValue</span><span class="p">:</span> <span class="p">{</span> <span class="bp">print</span><span class="p">(</span><span class="nv">$0</span><span class="p">)</span> <span class="p">})</span>
        <span class="p">.</span><span class="n">store</span><span class="p">(</span><span class="k">in</span><span class="p">:</span> <span class="p">&amp;</span><span class="n">subs</span><span class="p">)</span>

<span class="c1">//    contains（where :) 同理</span>

    <span class="bp">print</span><span class="p">(</span><span class="s">&#34;---&#34;</span><span class="p">)</span>

    <span class="n">pub2</span>
        <span class="p">.</span><span class="bp">print</span><span class="p">(</span><span class="s">&#34;pub2 - 3&#34;</span><span class="p">)</span>
        <span class="p">.</span><span class="bp">contains</span><span class="p">(</span><span class="k">where</span><span class="p">:</span> <span class="p">{</span> <span class="nv">$0</span> <span class="p">==</span> <span class="s">&#34;B&#34;</span> <span class="p">})</span> <span class="c1">// 包含条件</span>
        <span class="p">.</span><span class="n">sink</span><span class="p">(</span><span class="n">receiveCompletion</span><span class="p">:</span> <span class="p">{</span> <span class="bp">print</span><span class="p">(</span><span class="nv">$0</span><span class="p">)</span> <span class="p">},</span>
              <span class="n">receiveValue</span><span class="p">:</span> <span class="p">{</span> <span class="bp">print</span><span class="p">(</span><span class="nv">$0</span><span class="p">)</span> <span class="p">})</span>
        <span class="p">.</span><span class="n">store</span><span class="p">(</span><span class="k">in</span><span class="p">:</span> <span class="p">&amp;</span><span class="n">subs</span><span class="p">)</span>

    <span class="bp">print</span><span class="p">(</span><span class="s">&#34;---&#34;</span><span class="p">)</span>

    <span class="kd">let</span> <span class="nv">pub3</span> <span class="p">=</span> <span class="bp">stride</span><span class="p">(</span><span class="n">from</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="n">to</span><span class="p">:</span> <span class="mi">5</span><span class="p">,</span> <span class="n">by</span><span class="p">:</span> <span class="mi">2</span><span class="p">).</span><span class="n">publisher</span>

    <span class="n">pub3</span>
        <span class="p">.</span><span class="bp">print</span><span class="p">(</span><span class="s">&#34;pub3&#34;</span><span class="p">)</span>
        <span class="p">.</span><span class="n">allSatisfy</span> <span class="p">{</span> <span class="nv">$0</span> <span class="o">%</span> <span class="mi">2</span> <span class="p">==</span> <span class="mi">0</span> <span class="p">}</span> <span class="c1">// 是否所有都满足 xxx 条件（一个个匹配）？是则发射 true，否则只要一个不满足就取消订阅并发射 false</span>
        <span class="p">.</span><span class="n">sink</span><span class="p">(</span><span class="n">receiveCompletion</span><span class="p">:</span> <span class="p">{</span> <span class="bp">print</span><span class="p">(</span><span class="nv">$0</span><span class="p">)</span> <span class="p">},</span>
              <span class="n">receiveValue</span><span class="p">:</span> <span class="p">{</span> <span class="bp">print</span><span class="p">(</span><span class="nv">$0</span><span class="p">)</span> <span class="p">})</span>
        <span class="p">.</span><span class="n">store</span><span class="p">(</span><span class="k">in</span><span class="p">:</span> <span class="p">&amp;</span><span class="n">subs</span><span class="p">)</span>
<span class="p">}</span>
<span class="c1">//pub1: receive subscription: ([&#34;A&#34;, &#34;B&#34;, &#34;C&#34;])</span>
<span class="c1">//pub1: request unlimited</span>
<span class="c1">//pub1: receive value: (A)</span>
<span class="c1">//pub1: receive value: (B)</span>
<span class="c1">//pub1: receive value: (C)</span>
<span class="c1">//pub1: receive finished</span>
<span class="c1">//3</span>
<span class="c1">//finished</span>
<span class="c1">//---</span>
<span class="c1">//pub2 - 1: receive subscription: ([&#34;A&#34;, &#34;B&#34;, &#34;C&#34;])</span>
<span class="c1">//pub2 - 1: request unlimited</span>
<span class="c1">//pub2 - 1: receive value: (A)</span>
<span class="c1">//pub2 - 1: receive value: (B)</span>
<span class="c1">//pub2 - 1: receive cancel</span>
<span class="c1">//true</span>
<span class="c1">//finished</span>
<span class="c1">//---</span>
<span class="c1">//pub2 - 2: receive subscription: ([&#34;A&#34;, &#34;B&#34;, &#34;C&#34;])</span>
<span class="c1">//pub2 - 2: request unlimited</span>
<span class="c1">//pub2 - 2: receive value: (A)</span>
<span class="c1">//pub2 - 2: receive value: (B)</span>
<span class="c1">//pub2 - 2: receive value: (C)</span>
<span class="c1">//pub2 - 2: receive finished</span>
<span class="c1">//false</span>
<span class="c1">//finished</span>
<span class="c1">//---</span>
<span class="c1">//pub2 - 3: receive subscription: ([&#34;A&#34;, &#34;B&#34;, &#34;C&#34;])</span>
<span class="c1">//pub2 - 3: request unlimited</span>
<span class="c1">//pub2 - 3: receive value: (A)</span>
<span class="c1">//pub2 - 3: receive value: (B)</span>
<span class="c1">//pub2 - 3: receive cancel</span>
<span class="c1">//true</span>
<span class="c1">//finished</span>
<span class="c1">//---</span>
<span class="c1">//pub3: receive subscription: (Sequence)</span>
<span class="c1">//pub3: request unlimited</span>
<span class="c1">//pub3: receive value: (0)</span>
<span class="c1">//pub3: receive value: (2)</span>
<span class="c1">//pub3: receive value: (4)</span>
<span class="c1">//pub3: receive finished</span>
<span class="c1">//true</span>
<span class="c1">//finished</span>
</code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-swift" data-lang="swift"><span class="kd">import</span> <span class="nc">UIKit</span>
<span class="kd">import</span> <span class="nc">SwiftUI</span>
<span class="kd">import</span> <span class="nc">Combine</span>

<span class="kd">var</span> <span class="nv">subs</span> <span class="p">=</span> <span class="p">[</span><span class="n">AnyCancellable</span><span class="p">]()</span>

<span class="n">example</span><span class="p">(</span><span class="n">of</span><span class="p">:</span> <span class="s">&#34;reduce&#34;</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">let</span> <span class="nv">pub1</span> <span class="p">=</span> <span class="p">[</span><span class="s">&#34;A&#34;</span><span class="p">,</span> <span class="s">&#34;B&#34;</span><span class="p">,</span> <span class="s">&#34;C&#34;</span><span class="p">].</span><span class="n">publisher</span>

    <span class="n">pub1</span>
        <span class="p">.</span><span class="bp">print</span><span class="p">(</span><span class="s">&#34;pub1&#34;</span><span class="p">)</span>
        <span class="p">.</span><span class="bp">reduce</span><span class="p">(</span><span class="s">&#34;&#34;</span><span class="p">,</span> <span class="o">+</span><span class="p">)</span> <span class="c1">// 累加，类似标准库 reduce，当 finish 发射完整结果</span>
<span class="c1">//        .reduce(&#34;&#34;) { accumulator, value in // 完整版</span>
<span class="c1">//          return accumulator + value</span>
<span class="c1">//        }</span>
        <span class="p">.</span><span class="n">sink</span><span class="p">(</span><span class="n">receiveCompletion</span><span class="p">:</span> <span class="p">{</span> <span class="bp">print</span><span class="p">(</span><span class="nv">$0</span><span class="p">)</span> <span class="p">},</span>
              <span class="n">receiveValue</span><span class="p">:</span> <span class="p">{</span> <span class="bp">print</span><span class="p">(</span><span class="nv">$0</span><span class="p">)</span> <span class="p">})</span>
        <span class="p">.</span><span class="n">store</span><span class="p">(</span><span class="k">in</span><span class="p">:</span> <span class="p">&amp;</span><span class="n">subs</span><span class="p">)</span>

    <span class="bp">print</span><span class="p">(</span><span class="s">&#34;---&#34;</span><span class="p">)</span>
<span class="p">}</span>
<span class="c1">//pub1: receive subscription: ([&#34;A&#34;, &#34;B&#34;, &#34;C&#34;])</span>
<span class="c1">//pub1: request unlimited</span>
<span class="c1">//pub1: receive value: (A)</span>
<span class="c1">//pub1: receive value: (B)</span>
<span class="c1">//pub1: receive value: (C)</span>
<span class="c1">//pub1: receive finished</span>
<span class="c1">//ABC</span>
<span class="c1">//finished</span>
</code></pre></div><hr>
<ul>
<li>Encoding and Decoding in Swift at raywenderlich.com:</li>
<li>https:// <a href="http://www.raywenderlich.com/3418439-encoding-and-decoding-in-swift">www.raywenderlich.com/3418439-encoding-and-decoding-in-swift</a></li>
<li>Encoding and Decoding Custom Types on Apple‘s official documentation:</li>
<li>https:// developer.apple.com/documentation/foundation/archives_and_serialization/ encoding_and_decoding_custom_types</li>
</ul>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-swift" data-lang="swift"><span class="kd">import</span> <span class="nc">UIKit</span>
<span class="kd">import</span> <span class="nc">Combine</span>

<span class="c1">//let subscription = (1...3).publisher</span>
<span class="c1">//    .print(&#34;publisher&#34;)</span>
<span class="c1">//    .sink { _ in }</span>

<span class="c1">//publisher: receive subscription: (1...3)</span>
<span class="c1">//publisher: request unlimited</span>
<span class="c1">//publisher: receive value: (1)</span>
<span class="c1">//publisher: receive value: (2)</span>
<span class="c1">//publisher: receive value: (3)</span>
<span class="c1">//publisher: receive finished</span>

<span class="kd">class</span> <span class="nc">TimeLogger</span><span class="p">:</span> <span class="n">TextOutputStream</span> <span class="p">{</span>
    <span class="kd">private</span> <span class="kd">var</span> <span class="nv">previous</span> <span class="p">=</span> <span class="n">Date</span><span class="p">()</span>
    <span class="kd">private</span> <span class="kd">let</span> <span class="nv">formatter</span> <span class="p">=</span> <span class="n">NumberFormatter</span><span class="p">()</span>

    <span class="kd">init</span><span class="p">()</span> <span class="p">{</span>
        <span class="n">formatter</span><span class="p">.</span><span class="n">maximumFractionDigits</span> <span class="p">=</span> <span class="mi">5</span>
        <span class="n">formatter</span><span class="p">.</span><span class="n">minimumFractionDigits</span> <span class="p">=</span> <span class="mi">5</span>
    <span class="p">}</span>

    <span class="kd">func</span> <span class="nf">write</span><span class="p">(</span><span class="kc">_</span> <span class="n">string</span><span class="p">:</span> <span class="nb">String</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">let</span> <span class="nv">trimmed</span> <span class="p">=</span> <span class="n">string</span><span class="p">.</span><span class="n">trimmingCharacters</span><span class="p">(</span><span class="k">in</span><span class="p">:</span> <span class="p">.</span><span class="n">whitespacesAndNewlines</span><span class="p">)</span>
        <span class="k">guard</span> <span class="o">!</span><span class="n">trimmed</span><span class="p">.</span><span class="bp">isEmpty</span> <span class="k">else</span> <span class="p">{</span> <span class="k">return</span> <span class="p">}</span>
        <span class="kd">let</span> <span class="nv">now</span> <span class="p">=</span> <span class="n">Date</span><span class="p">()</span>
        <span class="bp">print</span><span class="p">(</span><span class="s">&#34;+</span><span class="si">\(</span><span class="n">formatter</span><span class="p">.</span><span class="n">string</span><span class="si">(</span><span class="k">for</span><span class="p">:</span> <span class="n">now</span><span class="p">.</span><span class="n">timeIntervalSince</span><span class="si">(</span><span class="n">previous</span><span class="si">))</span><span class="o">!</span><span class="si">)</span><span class="s">s: </span><span class="si">\(</span><span class="n">string</span><span class="si">)</span><span class="s">&#34;</span><span class="p">)</span>
        <span class="n">previous</span> <span class="p">=</span> <span class="n">now</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="kd">let</span> <span class="nv">subscription</span> <span class="p">=</span> <span class="p">(</span><span class="mf">1.</span><span class="p">..</span><span class="mi">3</span><span class="p">).</span><span class="n">publisher</span>
    <span class="p">.</span><span class="bp">print</span><span class="p">(</span><span class="s">&#34;publisher&#34;</span><span class="p">,</span> <span class="n">to</span><span class="p">:</span> <span class="n">TimeLogger</span><span class="p">())</span>
    <span class="p">.</span><span class="n">sink</span> <span class="p">{</span> <span class="kc">_</span> <span class="k">in</span> <span class="p">}</span>

<span class="c1">//+0.00589s: publisher: receive subscription: (1...3)</span>
<span class="c1">//+0.03223s: publisher: request unlimited</span>
<span class="c1">//+0.00031s: publisher: receive value: (1)</span>
<span class="c1">//+0.00025s: publisher: receive value: (2)</span>
<span class="c1">//+0.00024s: publisher: receive value: (3)</span>
<span class="c1">//+0.00023s: publisher: receive finished</span>
</code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-swift" data-lang="swift"><span class="c1">// iOS Project</span>
<span class="kd">import</span> <span class="nc">UIKit</span>
<span class="kd">import</span> <span class="nc">Combine</span>

<span class="kd">class</span> <span class="nc">MyType</span><span class="p">:</span> <span class="n">Codable</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nv">id</span><span class="p">:</span> <span class="nb">Int</span>
    <span class="kd">var</span> <span class="nv">title</span><span class="p">:</span> <span class="nb">String</span>
<span class="p">}</span>

<span class="cm">/*
</span><span class="cm"> [
</span><span class="cm">   {
</span><span class="cm">     &#34;id&#34;: 1,
</span><span class="cm">     &#34;title&#34;: &#34;Post 1&#34;
</span><span class="cm">   },
</span><span class="cm">   {
</span><span class="cm">     &#34;id&#34;: 2,
</span><span class="cm">     &#34;title&#34;: &#34;Post 2&#34;
</span><span class="cm">   },
</span><span class="cm">   {
</span><span class="cm">     &#34;id&#34;: 3,
</span><span class="cm">     &#34;title&#34;: &#34;Post 3&#34;
</span><span class="cm">   }
</span><span class="cm"> ]
</span><span class="cm"> */</span>

<span class="kd">class</span> <span class="nc">ViewController</span><span class="p">:</span> <span class="n">UIViewController</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nv">subs</span> <span class="p">=</span> <span class="n">Set</span><span class="p">&lt;</span><span class="n">AnyCancellable</span><span class="p">&gt;()</span>

    <span class="kr">override</span> <span class="kd">func</span> <span class="nf">viewDidLoad</span><span class="p">()</span> <span class="p">{</span>
        <span class="kc">super</span><span class="p">.</span><span class="n">viewDidLoad</span><span class="p">()</span>

<span class="c1">//        guard let url = URL(string: &#34;https://my-json-server.typicode.com/typicode/demo/posts&#34;) else { return }</span>

<span class="c1">//        let sub = URLSession.shared</span>
<span class="c1">//            .dataTaskPublisher(for: url)</span>
<span class="c1">//            .tryMap { data, _ in</span>
<span class="c1">//                try JSONDecoder().decode([MyType].self, from: data)</span>
<span class="c1">//            }</span>
<span class="c1">//            .sink(receiveCompletion: { completion in</span>
<span class="c1">//                if case .failure(let err) = completion {</span>
<span class="c1">//                    print(err)</span>
<span class="c1">//                }</span>
<span class="c1">//            }, receiveValue: { data in</span>
<span class="c1">//                for m in data {</span>
<span class="c1">//                    print(m.id, m.title)</span>
<span class="c1">//                }</span>
<span class="c1">//            })</span>

<span class="c1">//        let sub = URLSession.shared</span>
<span class="c1">//            .dataTaskPublisher(for: url)</span>
<span class="c1">//            .map(\.data)</span>
<span class="c1">//            .decode(type: [MyType].self, decoder: JSONDecoder())</span>
<span class="c1">//            .sink(receiveCompletion: { completion in</span>
<span class="c1">//                if case .failure(let err) = completion {</span>
<span class="c1">//                    print(err)</span>
<span class="c1">//                }</span>
<span class="c1">//            }, receiveValue: { data in</span>
<span class="c1">//                for m in data {</span>
<span class="c1">//                    print(m.id, m.title)</span>
<span class="c1">//                }</span>
<span class="c1">//            })</span>
<span class="c1">//</span>
<span class="c1">//        sub.store(in: &amp;subs)</span>

<span class="c1">//        let pub = URLSession</span>
<span class="c1">//            .shared</span>
<span class="c1">//            .dataTaskPublisher(for: url)</span>
<span class="c1">//            .map(\.data) // 映射到 data</span>
<span class="c1">//            .multicast {</span>
<span class="c1">//                // 多播，闭包中必须返回适当类型的 publisher</span>
<span class="c1">//                PassthroughSubject&lt;Data, URLError&gt;()</span>
<span class="c1">//        }</span>
<span class="c1">//</span>
<span class="c1">//        // 首次订阅，ConnectablePublisher，但不会立即开始工作</span>
<span class="c1">//        let sub1 = pub</span>
<span class="c1">//            .decode(type: [MyType].self, decoder: JSONDecoder())</span>
<span class="c1">//            .sink(receiveCompletion: { completion in</span>
<span class="c1">//                if case .failure(let err) = completion {</span>
<span class="c1">//                    print(err)</span>
<span class="c1">//                }</span>
<span class="c1">//            }, receiveValue: { data in</span>
<span class="c1">//                for m in data {</span>
<span class="c1">//                    print(m.id, m.title)</span>
<span class="c1">//                }</span>
<span class="c1">//            })</span>
<span class="c1">//</span>
<span class="c1">//        sub1.store(in: &amp;subs)</span>
<span class="c1">//</span>
<span class="c1">//        let sub2 = pub</span>
<span class="c1">//            .decode(type: [MyType].self, decoder: JSONDecoder())</span>
<span class="c1">//            .sink(receiveCompletion: { completion in</span>
<span class="c1">//                if case .failure(let err) = completion {</span>
<span class="c1">//                    print(err)</span>
<span class="c1">//                }</span>
<span class="c1">//            }, receiveValue: { data in</span>
<span class="c1">//                for m in data {</span>
<span class="c1">//                    print(m.id, m.title)</span>
<span class="c1">//                }</span>
<span class="c1">//            })</span>
<span class="c1">//</span>
<span class="c1">//        sub2.store(in: &amp;subs)</span>
<span class="c1">//</span>
<span class="c1">//        // 准备就绪，开始工作</span>
<span class="c1">//        let subscription = pub.connect()</span>
<span class="c1">//</span>
<span class="c1">//        subscription.store(in: &amp;subs)</span>

        <span class="c1">// ---</span>

        <span class="kd">let</span> <span class="nv">request</span> <span class="p">=</span> <span class="n">URLSession</span><span class="p">.</span><span class="n">shared</span>
            <span class="p">.</span><span class="n">dataTaskPublisher</span><span class="p">(</span><span class="k">for</span><span class="p">:</span> <span class="n">URL</span><span class="p">(</span><span class="n">string</span><span class="p">:</span> <span class="s">&#34;https://my-json-server.typicode.com/typicode/demo/posts&#34;</span><span class="p">)</span><span class="o">!</span><span class="p">)</span>

<span class="c1">//        request.sink(receiveCompletion: { completion in</span>
<span class="c1">//            print(&#34;Sink received completion: \(completion)&#34;)</span>
<span class="c1">//        }) { (data, _) in</span>
<span class="c1">//            print(&#34;Sink received data: \(data)&#34;)</span>
<span class="c1">//        }.store(in: &amp;subs)</span>

<span class="c1">//        Sink received data: 134 bytes</span>
<span class="c1">//        Sink received completion: finished</span>

<span class="c1">//        request</span>
<span class="c1">//            .handleEvents(receiveSubscription: { _ in</span>
<span class="c1">//                print(&#34;Network request will start&#34;)</span>
<span class="c1">//            }, receiveOutput: { _ in</span>
<span class="c1">//                print(&#34;Network request data received&#34;)</span>
<span class="c1">//            }, receiveCancel: {</span>
<span class="c1">//                print(&#34;Network request cancelled&#34;)</span>
<span class="c1">//            })</span>
<span class="c1">//            .sink(receiveCompletion: { completion in</span>
<span class="c1">//                print(&#34;Sink received completion: \(completion)&#34;)</span>
<span class="c1">//            }) { (data, _) in</span>
<span class="c1">//                print(&#34;Sink received data: \(data)&#34;)</span>
<span class="c1">//            }</span>
<span class="c1">//            .store(in: &amp;subs)</span>

        <span class="c1">// 注释 .store(in: &amp;subs) 一行</span>
<span class="c1">//        Network request will start</span>
<span class="c1">//        Network request cancelled</span>

<span class="c1">//        Network request will start</span>
<span class="c1">//        Network request data received</span>
<span class="c1">//        Sink received data: 134 bytes</span>
<span class="c1">//        Sink received completion: finished</span>

        <span class="c1">// ---</span>

       <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">]</span>
           <span class="p">.</span><span class="n">publisher</span>
           <span class="p">.</span><span class="n">breakpoint</span><span class="p">(</span><span class="n">receiveOutput</span><span class="p">:</span> <span class="p">{</span> <span class="n">value</span> <span class="k">in</span>
            <span class="c1">// 在某个时机打断点，中断某个事件（但不可在取消订阅时断点）</span>
               <span class="k">return</span> <span class="n">value</span> <span class="o">&gt;</span> <span class="mi">2</span> <span class="o">&amp;&amp;</span> <span class="n">value</span> <span class="o">&lt;</span> <span class="mi">5</span>
           <span class="p">})</span>
           <span class="p">.</span><span class="n">sink</span><span class="p">(</span><span class="n">receiveValue</span><span class="p">:</span> <span class="p">{</span>
               <span class="bp">print</span><span class="p">(</span><span class="nv">$0</span><span class="p">)</span>
           <span class="p">})</span>
           <span class="p">.</span><span class="n">store</span><span class="p">(</span><span class="k">in</span><span class="p">:</span> <span class="p">&amp;</span><span class="n">subs</span><span class="p">)</span>

<span class="c1">//        0</span>
<span class="c1">//        1</span>
<span class="c1">//        2</span>
<span class="c1">//        (lldb) // 断点，可以继续</span>
<span class="c1">//        3</span>
<span class="c1">//        4</span>
<span class="c1">//        5</span>

    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div><hr>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-swift" data-lang="swift"><span class="c1">// Swift-Project</span>

<span class="kd">import</span> <span class="nc">UIKit</span>
<span class="kd">import</span> <span class="nc">Combine</span>

<span class="kd">class</span> <span class="nc">ViewController</span><span class="p">:</span> <span class="n">UIViewController</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nv">subs</span> <span class="p">=</span> <span class="n">Set</span><span class="p">&lt;</span><span class="n">AnyCancellable</span><span class="p">&gt;()</span>

    <span class="kr">override</span> <span class="kd">func</span> <span class="nf">viewDidLoad</span><span class="p">()</span> <span class="p">{</span>
        <span class="kc">super</span><span class="p">.</span><span class="n">viewDidLoad</span><span class="p">()</span>

        <span class="c1">// RunLoop 非线程安全</span>

<span class="c1">//        let rl = RunLoop.main</span>
<span class="c1">//        // 不会创建发布者</span>
<span class="c1">//        // Cancellable</span>
<span class="c1">//        let sub = rl.schedule(after: rl.now,</span>
<span class="c1">//                              // 间隔</span>
<span class="c1">//                              interval: .seconds(1),</span>
<span class="c1">//                              // 可允许的误差（如果使用小于 minimumTolerance 的值可能并不会如你所愿）</span>
<span class="c1">//                              tolerance: .milliseconds(100)) {</span>
<span class="c1">//            print(&#34;定时器1&#34;)</span>
<span class="c1">//        }</span>
<span class="c1">//</span>
<span class="c1">//        rl.schedule(after: .init(Date(timeIntervalSinceNow: 3.0))) {</span>
<span class="c1">//            sub.cancel()</span>
<span class="c1">//        }</span>

<span class="c1">//        定时器1</span>
<span class="c1">//        定时器1</span>
<span class="c1">//        定时器1</span>
<span class="c1">//        定时器1</span>

        <span class="kd">let</span> <span class="nv">pub</span> <span class="p">=</span> <span class="n">Timer</span><span class="p">.</span><span class="n">publish</span><span class="p">(</span><span class="n">every</span><span class="p">:</span> <span class="mf">1.0</span><span class="p">,</span>
                                <span class="n">on</span><span class="p">:</span> <span class="p">.</span><span class="n">main</span><span class="p">,</span> <span class="c1">// 附加的 RunLoop</span>
                                <span class="k">in</span><span class="p">:</span> <span class="p">.</span><span class="n">common</span><span class="p">)</span> <span class="c1">// RunLoop 运行模式</span>


        <span class="c1">// 注意在非主队列使用可能会导致不可预期的结果；Dispatch 库没有使用 RunLoop 来管理线程</span>
        <span class="c1">// 由于 RunLoop 需要调用 run 方法来处理事件，其它 RunLoop 将不会触发定时器，安全起见使用 .main</span>
<span class="c1">//        let pub = Timer.publish(every: 1.0,</span>
<span class="c1">//                                on: .current, // 自己开辟线程的 RunLoop 通过 current 获得</span>
<span class="c1">//                                in: .common)</span>

        <span class="c1">// Timer 返回的发布者为 ConnectablePublisher 类型，明确调用 connect() 才会在订阅时触发，或者 autoconnect()</span>
<span class="c1">//        let pub1 = Timer.publish(every: 1.0,</span>
<span class="c1">//                                 on: .main,</span>
<span class="c1">//                                 in: .common)</span>
<span class="c1">//                        .autoconnect()</span>
<span class="c1">//                        .scan(0) { counter, _ in</span>
<span class="c1">//                            counter + 1</span>
<span class="c1">//                        }.sink(receiveValue: { print($0) })</span>
<span class="c1">//        pub1.store(in: &amp;subs)</span>
<span class="c1">//        1</span>
<span class="c1">//        2</span>
<span class="c1">//        3</span>
<span class="c1">//        4</span>
<span class="c1">//        ... // 无限</span>



        <span class="c1">// --- Dispatch Queue</span>
        <span class="kd">let</span> <span class="nv">queue</span> <span class="p">=</span> <span class="n">DispatchQueue</span><span class="p">.</span><span class="n">main</span>
        <span class="kd">let</span> <span class="nv">source</span> <span class="p">=</span> <span class="n">PassthroughSubject</span><span class="p">&lt;</span><span class="nb">Int</span><span class="p">,</span> <span class="n">Never</span><span class="p">&gt;()</span>
        <span class="kd">var</span> <span class="nv">counter</span> <span class="p">=</span> <span class="mi">0</span>

        <span class="kd">let</span> <span class="nv">cancellable</span> <span class="p">=</span> <span class="n">queue</span><span class="p">.</span><span class="n">schedule</span><span class="p">(</span><span class="n">after</span><span class="p">:</span> <span class="n">queue</span><span class="p">.</span><span class="n">now</span><span class="p">,</span>
                                         <span class="n">interval</span><span class="p">:</span> <span class="p">.</span><span class="n">seconds</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span> <span class="p">{</span>
            <span class="n">source</span><span class="p">.</span><span class="n">send</span><span class="p">(</span><span class="n">counter</span><span class="p">)</span>
            <span class="n">counter</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="p">}</span>

        <span class="kd">let</span> <span class="nv">sub</span> <span class="p">=</span> <span class="n">source</span><span class="p">.</span><span class="n">sink</span><span class="p">(</span><span class="n">receiveValue</span><span class="p">:</span> <span class="p">{</span> <span class="bp">print</span><span class="p">(</span><span class="nv">$0</span><span class="p">)</span> <span class="p">})</span>
        <span class="n">sub</span><span class="p">.</span><span class="n">store</span><span class="p">(</span><span class="k">in</span><span class="p">:</span> <span class="p">&amp;</span><span class="n">subs</span><span class="p">)</span>

        <span class="n">cancellable</span><span class="p">.</span><span class="n">store</span><span class="p">(</span><span class="k">in</span><span class="p">:</span> <span class="p">&amp;</span><span class="n">subs</span><span class="p">)</span>

<span class="c1">//        0</span>
<span class="c1">//        1</span>
<span class="c1">//        2</span>
<span class="c1">//        3</span>
<span class="c1">//        ... // 无限</span>

        <span class="c1">// 1. 如果有 Obj-C 怀旧之情，用 RunLoop 实现定时器</span>
        <span class="c1">// 2. 现代计时器用 DispatchQueue.schedule</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div><hr>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-swift" data-lang="swift">
<span class="kd">import</span> <span class="nc">UIKit</span>
<span class="kd">import</span> <span class="nc">Combine</span>

<span class="kd">class</span> <span class="nc">TestObject</span><span class="p">:</span> <span class="n">NSObject</span> <span class="p">{</span>
    <span class="kr">@objc</span> <span class="kr">dynamic</span> <span class="kd">var</span> <span class="nv">intProp</span><span class="p">:</span> <span class="nb">Int</span> <span class="p">=</span> <span class="mi">0</span>
    <span class="kr">@objc</span> <span class="kr">dynamic</span> <span class="kd">var</span> <span class="nv">strProp</span><span class="p">:</span> <span class="nb">String</span> <span class="p">=</span> <span class="s">&#34;&#34;</span>
    <span class="kr">@objc</span> <span class="kr">dynamic</span> <span class="kd">var</span> <span class="nv">arrProp</span><span class="p">:</span> <span class="p">[</span><span class="nb">Float</span><span class="p">]</span> <span class="p">=</span> <span class="p">[]</span>

    <span class="c1">// KVO 不支持</span>
    <span class="c1">// ERROR: Property cannot be marked @objc because its type cannot be represented in Objective-C</span>
<span class="c1">//    @objc dynamic var structProperty: PureSwift = .init(a: (0,false))</span>
<span class="p">}</span>

<span class="kd">struct</span> <span class="nc">PureSwift</span> <span class="p">{</span>
    <span class="kd">let</span> <span class="nv">a</span><span class="p">:</span> <span class="p">(</span><span class="nb">Int</span><span class="p">,</span> <span class="nb">Bool</span><span class="p">)</span>
<span class="p">}</span>

<span class="kd">class</span> <span class="nc">MonitorObject</span><span class="p">:</span> <span class="n">ObservableObject</span> <span class="p">{</span>
    <span class="p">@</span><span class="n">Published</span> <span class="kd">var</span> <span class="nv">someProp1</span> <span class="p">=</span> <span class="kc">false</span>
    <span class="p">@</span><span class="n">Published</span> <span class="kd">var</span> <span class="nv">someProp2</span> <span class="p">=</span> <span class="s">&#34;&#34;</span>
<span class="p">}</span>

<span class="kd">class</span> <span class="nc">ViewController</span><span class="p">:</span> <span class="n">UIViewController</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nv">subs</span> <span class="p">=</span> <span class="n">Set</span><span class="p">&lt;</span><span class="n">AnyCancellable</span><span class="p">&gt;()</span>

    <span class="kr">override</span> <span class="kd">func</span> <span class="nf">viewDidLoad</span><span class="p">()</span> <span class="p">{</span>
        <span class="kc">super</span><span class="p">.</span><span class="n">viewDidLoad</span><span class="p">()</span>

        <span class="c1">// KVO 继承自 NSObject 的类；标记为 @objc dynamic；兼容 Obj-C 的数组和字典</span>

<span class="c1">//        let queue = OperationQueue()</span>
<span class="c1">//        let sub = queue.publisher(for: \.operationCount) // 监听次数</span>
<span class="c1">//            .sink { print($0) }</span>
<span class="c1">//</span>
<span class="c1">//        sub.store(in: &amp;subs)</span>
<span class="c1">//</span>
<span class="c1">//        queue.addOperation(Operation())</span>

<span class="c1">//        0</span>
<span class="c1">//        1</span>
<span class="c1">//        0</span>

<span class="c1">//        let obj = TestObject()</span>
<span class="c1">//        let sub = obj</span>
<span class="c1">//            .publisher(for: \.intProp)</span>
<span class="c1">//            .sink { print($0) }</span>
<span class="c1">//        sub.store(in: &amp;subs)</span>
<span class="c1">//</span>
<span class="c1">//        obj.intProp = 100</span>
<span class="c1">//        obj.intProp = 200</span>
<span class="c1">//        obj.intProp = 200</span>

<span class="c1">//        0   // 初始值</span>
<span class="c1">//        100</span>
<span class="c1">//        200</span>
<span class="c1">//        200</span>

<span class="c1">//        let sub2 = obj</span>
<span class="c1">//            .publisher(for: \.strProp)</span>
<span class="c1">//            .sink { print($0) }</span>
<span class="c1">//</span>
<span class="c1">//        let sub3 = obj</span>
<span class="c1">//            .publisher(for: \.arrProp)</span>
<span class="c1">//            .sink { print($0) }</span>
<span class="c1">//</span>
<span class="c1">//        obj.strProp = &#34;A&#34;</span>
<span class="c1">//        obj.arrProp.append(1)</span>
<span class="c1">//        obj.strProp = &#34;B&#34;</span>
<span class="c1">//        obj.arrProp.append(2)</span>

<span class="c1">//           // 空字符串</span>
<span class="c1">//        []</span>
<span class="c1">//        A</span>
<span class="c1">//        [1.0]</span>
<span class="c1">//        B</span>
<span class="c1">//        [1.0, 2.0]</span>


<span class="c1">//        let obj = TestObject()</span>
<span class="c1">//        let sub = obj</span>
<span class="c1">//        .publisher(for: \.intProp, options: [.initial])</span>
<span class="c1">////        .publisher(for: \.intProp, options: [.prior])</span>
<span class="c1">////        .publisher(for: \.intProp, options: [.new])</span>
<span class="c1">//            .sink { print($0) }</span>
<span class="c1">//        sub.store(in: &amp;subs)</span>
<span class="c1">//</span>
<span class="c1">//        obj.intProp = 100</span>
<span class="c1">//        obj.intProp = 200</span>
<span class="c1">//        obj.intProp = 200</span>

        <span class="c1">// options 默认 .initial</span>
<span class="c1">//        0</span>
<span class="c1">//        100</span>
<span class="c1">//        200</span>
<span class="c1">//        200</span>

        <span class="c1">// options []</span>
<span class="c1">//        100</span>
<span class="c1">//        200</span>
<span class="c1">//        200</span>

        <span class="c1">// options [.prior] 每次同时发出前一个与新值</span>
<span class="c1">//        0</span>
<span class="c1">//        100</span>
<span class="c1">//        100</span>
<span class="c1">//        200</span>
<span class="c1">//        200</span>
<span class="c1">//        200</span>

        <span class="c1">// new old 在该发布者处没有作用，仅仅让新值通过（new old）</span>
<span class="c1">//        100</span>
<span class="c1">//        200</span>
<span class="c1">//        200</span>

        <span class="c1">// --- ObservableObject</span>

        <span class="kd">let</span> <span class="nv">object</span> <span class="p">=</span> <span class="n">MonitorObject</span><span class="p">()</span>
        <span class="kd">let</span> <span class="nv">sub</span> <span class="p">=</span> <span class="n">object</span><span class="p">.</span><span class="n">objectWillChange</span><span class="p">.</span><span class="n">sink</span> <span class="p">{</span>
            <span class="bp">print</span><span class="p">(</span><span class="nv">$0</span><span class="p">)</span>
        <span class="p">}</span>

        <span class="n">object</span><span class="p">.</span><span class="n">someProp1</span> <span class="p">=</span> <span class="kc">true</span>
        <span class="n">object</span><span class="p">.</span><span class="n">someProp2</span> <span class="p">=</span> <span class="s">&#34;Hello&#34;</span>

        <span class="c1">// 我们只知道改变，但不知道具体改变了哪个、改变了什么，常用于 SwiftUI 和 @Published 结合</span>
<span class="c1">//        ()</span>
<span class="c1">//        ()</span>

    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div><hr>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-swift" data-lang="swift">

<span class="kd">import</span> <span class="nc">UIKit</span>
<span class="kd">import</span> <span class="nc">Combine</span>

<span class="kd">class</span> <span class="nc">ViewController</span><span class="p">:</span> <span class="n">UIViewController</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nv">subs</span> <span class="p">=</span> <span class="n">Set</span><span class="p">&lt;</span><span class="n">AnyCancellable</span><span class="p">&gt;()</span>

    <span class="kr">override</span> <span class="kd">func</span> <span class="nf">viewDidLoad</span><span class="p">()</span> <span class="p">{</span>
        <span class="kc">super</span><span class="p">.</span><span class="n">viewDidLoad</span><span class="p">()</span>

        <span class="c1">// 多个订阅者共享发布者的内容</span>
        <span class="c1">// share &amp; multicast</span>
        <span class="c1">// share 返回 Publish.Share 类型，新的发布者共享上流的发布者（只会订阅上流发布者一次，并共享给所有后续订阅该发布者的订阅者）</span>
        <span class="c1">// 新订阅者只能收到上游发布者订阅后出的值，是没有缓冲和重播的，如果上游已经完成，那么订阅者只能收到完成</span>

<span class="c1">//        let shared = URLSession.shared</span>
<span class="c1">//            .dataTaskPublisher(for: URL(string: &#34;https://my-json-server.typicode.com/typicode/demo/posts&#34;)!)</span>
<span class="c1">//            .map(\.data)</span>
<span class="c1">//            .print(&#34;shared&#34;)</span>
<span class="c1">//            .share()</span>
<span class="c1">//</span>
<span class="c1">//        print(&#34;sub 1&#34;)</span>
<span class="c1">//</span>
<span class="c1">//        let sub1 = shared.sink(receiveCompletion: { _ in</span>
<span class="c1">//            print(&#34;Completion&#34;)</span>
<span class="c1">//        }, receiveValue: { print(&#34;sub1&#34;, $0) })</span>
<span class="c1">//        sub1.store(in: &amp;subs)</span>
<span class="c1">//</span>
<span class="c1">//        print(&#34;sub 2&#34;)</span>
<span class="c1">//</span>
<span class="c1">//        let sub2 = shared.sink(receiveCompletion: { _ in</span>
<span class="c1">//            print(&#34;Completion&#34;)</span>
<span class="c1">//        }, receiveValue: { print(&#34;sub2&#34;, $0) })</span>
<span class="c1">//        sub2.store(in: &amp;subs)</span>

<span class="c1">//        sub 1</span>
<span class="c1">//        shared: receive subscription: (DataTaskPublisher) // 第一个订阅触发对 DataTaskPublisher 订阅</span>
<span class="c1">//        shared: request unlimited</span>
<span class="c1">//        sub 2</span>
<span class="c1">//        shared: receive value: (134 bytes)</span>
<span class="c1">//        sub1 134 bytes</span>
<span class="c1">//        sub2 134 bytes</span>
<span class="c1">//        shared: receive finished</span>
<span class="c1">//        Completion</span>
<span class="c1">//        Completion</span>

        <span class="c1">// 去掉 share</span>
<span class="c1">//        sub 1</span>
<span class="c1">//        shared: receive subscription: (DataTaskPublisher)</span>
<span class="c1">//        shared: request unlimited</span>
<span class="c1">//        sub 2</span>
<span class="c1">//        shared: receive subscription: (DataTaskPublisher) // 两次订阅</span>
<span class="c1">//        shared: request unlimited</span>
<span class="c1">//        shared: receive value: (134 bytes)</span>
<span class="c1">//        sub2 134 bytes</span>
<span class="c1">//        shared: receive finished</span>
<span class="c1">//        Completion</span>
<span class="c1">//        shared: receive value: (134 bytes)</span>
<span class="c1">//        sub1 134 bytes</span>
<span class="c1">//        shared: receive finished</span>
<span class="c1">//        Completion</span>

<span class="c1">//        var sub3: AnyCancellable? = nil</span>
<span class="c1">//</span>
<span class="c1">//        DispatchQueue.main.asyncAfter(deadline: .now() + 5) {</span>
<span class="c1">//            print(&#34;sub3&#34;)</span>
<span class="c1">//</span>
<span class="c1">//            sub3 = shared.sink(receiveCompletion: {</span>
<span class="c1">//                print(&#34;sub3&#34;, $0)</span>
<span class="c1">//            }, receiveValue: {</span>
<span class="c1">//                print(&#34;sub3&#34;, $0)</span>
<span class="c1">//            })</span>
<span class="c1">//        }</span>

        <span class="c1">// sub3 订阅的时候，请求已经回来过了，因此没有接收到任何值</span>
<span class="c1">//        sub 1</span>
<span class="c1">//        shared: receive subscription: (DataTaskPublisher)</span>
<span class="c1">//        shared: request unlimited</span>
<span class="c1">//        sub 2</span>
<span class="c1">//        shared: receive value: (134 bytes)</span>
<span class="c1">//        sub1 134 bytes</span>
<span class="c1">//        sub2 134 bytes</span>
<span class="c1">//        shared: receive finished</span>
<span class="c1">//        Completion</span>
<span class="c1">//        Completion</span>
<span class="c1">//        sub3</span>
<span class="c1">//        sub3 finished</span>

        <span class="c1">// ---</span>
        <span class="c1">// multicast 的发布者为 ConnectablePublisher，只有调用 connect 才会真正订阅</span>

<span class="c1">//        let sub = PassthroughSubject&lt;Data, URLError&gt;()</span>
<span class="c1">//        let multi = URLSession.shared.dataTaskPublisher(for: URL(string: &#34;https://my-json-server.typicode.com/typicode/demo/posts&#34;)!)</span>
<span class="c1">//            .map(\.data)</span>
<span class="c1">//            .print(&#34;shared&#34;)</span>
<span class="c1">//            .multicast(subject: sub)</span>
<span class="c1">////            .autoconnect()</span>
<span class="c1">//</span>
<span class="c1">//        let sub1 = multi.sink(receiveCompletion: { print(&#34;sub1&#34;, $0) },</span>
<span class="c1">//                              receiveValue: { print(&#34;sub1&#34;, $0) })</span>
<span class="c1">//</span>
<span class="c1">//        let sub2 = multi.sink(receiveCompletion: { print(&#34;sub2&#34;, $0) },</span>
<span class="c1">//                              receiveValue: { print(&#34;sub2&#34;, $0) })</span>
<span class="c1">//</span>
<span class="c1">//        multi.connect()</span>
<span class="c1">//        // autoconnect 也支持，使用时首次订阅后，连接到上游发布者并立即开始工作</span>
<span class="c1">//        // 用于上游发布者发射单一值，并使用 CurrentValueSubject 共享订阅者</span>
<span class="c1">//        sub.send(Data())</span>

        <span class="c1">// connect 后，发送数据，两个均可收到</span>
<span class="c1">//        shared: receive subscription: (DataTaskPublisher)</span>
<span class="c1">//        shared: request unlimited</span>
<span class="c1">//        shared: receive cancel</span>
<span class="c1">//        sub1 0 bytes</span>
<span class="c1">//        sub2 0 bytes</span>

        <span class="c1">// autoconnect</span>
<span class="c1">//        shared: receive subscription: (DataTaskPublisher)</span>
<span class="c1">//        shared: request unlimited</span>
<span class="c1">//        sub1 0 bytes</span>
<span class="c1">//        sub2 0 bytes</span>
<span class="c1">//        shared: receive cancel</span>

        <span class="c1">// Future</span>

        <span class="kd">let</span> <span class="nv">future</span> <span class="p">=</span> <span class="n">Future</span><span class="p">&lt;</span><span class="nb">Int</span><span class="p">,</span> <span class="n">Error</span><span class="p">&gt;</span> <span class="p">{</span> <span class="n">fulfill</span> <span class="k">in</span>
            <span class="k">do</span> <span class="p">{</span>
                <span class="c1">// 创建后立即执行（无关是否订阅）</span>
                <span class="kd">let</span> <span class="nv">result</span> <span class="p">=</span> <span class="k">try</span> <span class="kc">self</span><span class="p">.</span><span class="n">performSomeWork</span><span class="p">()</span>
                <span class="c1">// 将结果保存在 fulfill，并分发给 Future 的订阅者</span>
                <span class="n">fulfill</span><span class="p">(.</span><span class="n">success</span><span class="p">(</span><span class="n">result</span><span class="p">))</span>
            <span class="p">}</span> <span class="k">catch</span> <span class="p">{</span>
                <span class="n">fulfill</span><span class="p">(.</span><span class="n">failure</span><span class="p">(</span><span class="n">error</span><span class="p">))</span>
            <span class="p">}</span>
        <span class="p">}</span>
        <span class="c1">// 仅执行一次但可以分发结果到多个订阅者</span>
        <span class="c1">// 不能依靠 Deferred 推迟闭包执行直到订阅者订阅，因为 Deferred 是个结构体，每次都会导致新的 Future 创建</span>

<span class="c1">//        在处理网络等资源密集型流程时，共享订阅工作至关重要。</span>
<span class="c1">//        当您只需要与多个订阅者共享一个发布者时，请使用share（）。</span>
<span class="c1">//        当您需要精细控制上游发布者何时开始工作以及值如何传播到订阅者时，请使用multicast（_ :)。</span>
<span class="c1">//        使用Future将计算的单个结果共享给多个订户。</span>
    <span class="p">}</span>

    <span class="kd">func</span> <span class="nf">performSomeWork</span><span class="p">()</span> <span class="kr">throws</span> <span class="p">-&gt;</span> <span class="nb">Int</span> <span class="p">{</span>
        <span class="k">return</span> <span class="mi">0</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div><hr>
<p>@ObservedObject 包装器执行以下操作： 1.从视图中删除属性存储，并使用对原始属性的绑定
模型。 换句话说，它不会重复数据。 2.将属性标记为外部存储。 换句话说，它表示一块
的数据不属于视图。 3.与@Published 和@State 一样，它会将发布者添加到属性中，因此您可以
订阅它和/或在视图层次结构中进一步绑定到它。</p>
</div>
                    <div class="post_footer">
                        
                        <div class="meta">
                            <div class="info">
                                <span class="field tags">
                                    <i class="ri-stack-line"></i>
                                    
                                    <a href="https://kingcos.me/tags/swift/">Swift</a>
                                    
                                </span>
                            </div>
                        </div>
                        
                    </div>
                </div>
                <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<table style="border: 0;">
  <tr>
  <td style="border: 0; width: 30%;">
    <img width='100%' src='/img/about/1.jpg'>
  </td>
  <td style="border: 0; width: 50%;">
    <center>← 写得如何？考虑<strong>赞赏</strong>一下？🌚</center>
    
  </td>
  </tr>
</table>

<hr>

<script>
    (adsbygoogle = window.adsbygoogle || []).push({});
</script>
                
                
                







    
    
    
    <div>
        <div id="github-comment">
        </div>

        <script type="text/javascript">
        function getUtterances(isDark) {
            var utterances = document.createElement('script');
            utterances.type = 'text/javascript';
            utterances.async = true;
            utterances.setAttribute('issue-term', "pathname")
            utterances.setAttribute('repo', "kingcos\/kingcos.github.io")
            utterances.setAttribute('label', "comments")
            isDark ? utterances.setAttribute('theme', "github-dark") : utterances.setAttribute('theme', "github-light")
            utterances.crossorigin = 'anonymous';
            utterances.src = 'https://utteranc.es/client.js';

            return utterances
        }
        document.getElementById('github-comment').appendChild(getUtterances(false))
        </script>
    </div>
    




                
            </div>
        </div>
    </div>
    <a id="back_to_top" href="#" class="back_to_top"><i class="ri-arrow-up-s-line"></i></a>
    <footer class="footer">
    <div class="powered_by">
        <a href="https://kingcos.me">Powered by kingcos with love.</a>
    </div>

    <div class="footer_slogan">
        <span>❤️</span>
    </div>
</footer>
    <script src="https://kingcos.me/js/jquery-3.5.1.min.js"></script>
<link href="https://kingcos.me/css/fancybox.min.css" rel="stylesheet">
<script src="https://kingcos.me/js/fancybox.min.js"></script>
<script src="https://kingcos.me/js/zozo.js"></script>


<script type="text/javascript" async
    src="https://cdn.bootcss.com/mathjax/2.7.5/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
        MathJax.Hub.Config({
            tex2jax: {
                inlineMath: [['$', '$'], ['\\(', '\\)']],
                displayMath: [['$$', '$$'], ['\[\[', '\]\]']],
                processEscapes: true,
                processEnvironments: true,
                skipTags: ['script', 'noscript', 'style', 'textarea', 'pre'],
                TeX: {
                    equationNumbers: { autoNumber: "AMS" },
                    extensions: ["AMSmath.js", "AMSsymbols.js"]
                }
            }
        });

        MathJax.Hub.Queue(function () {
            
            
            
            var all = MathJax.Hub.getAllJax(), i;
            for (i = 0; i < all.length; i += 1) {
                all[i].SourceElement().parentNode.className += ' has-jax';
            }
        });
    </script>

<style>
    code.has-jax {
        font: inherit;
        font-size: 100%;
        background: inherit;
        border: inherit;
        color: #515151;
    }
</style>



<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-138311951-1', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>

</body>

</html>