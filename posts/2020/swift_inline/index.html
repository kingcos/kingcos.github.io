<!DOCTYPE html>
<html lang="en">
  <head>
    
      <title>Swift 拾遗 - 内联函数 :: iBlog</title>
    
    <meta http-equiv="content-type" content="text/html; charset=utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">
<meta name="description" content="Date Notes     2020-07-26 首次提交    Preface 内联函数（Inline Functions）是指编译时刻将函数调用展开为函数体的一种编程语言结构，编译器将适时采取这一技术可以节省调用函数所带来的额外开销，本文将简单讲讲 Swift 中的内联函数。
编译器优化等级 由于内联函数会将函数调用展开为函数体，因此当编译器内联某一函数时，该函数本身将不再会被调用。而在 Debug 模式下，由于我们经常会使用打断点等调试手段，如果此时内联将不利于我们排查问题。因此在 Debug 模式下，编译器默认将不进行内联。
控制编译器优化等级的设置位于：Xcode - TARGETS - Build Settings - Swift Compiler - Optimization Level，其中便会影响 Swift 函数是否内联：
Swift 编译器所支持的优化等级具体如下：
   Level Part     [-Onone] 无优化（Debug 模式默认）   [-O] 速度优先（Release 模式默认）   [-Osize] 体积优先    经过实际测试，如下 foo 函数在 [-O] 与 [-Osize] 等级下均被优化："/>
<meta name="keywords" content="kingcos.me,maimieng.comios,swift,objective-c,obj-c,objc,oc,geek,python,ruby,golang,go,apple,mac"/>
<meta name="robots" content="noodp"/>
<link rel="canonical" href="/posts/2020/swift_inline/" />





<link rel="stylesheet" href="/assets/style.css">


<link rel="stylesheet" href="/style.css">


<link rel="apple-touch-icon-precomposed" sizes="144x144" href="/img/apple-touch-icon-144-precomposed.png">
<link rel="shortcut icon" href="/img/favicon.png">


<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Swift 拾遗 - 内联函数"/>
<meta name="twitter:description" content="内联函数（Inline Functions）是指编译时刻将函数调用展开为函数体的一种编程语言结构，编译器将适时采取这一技术可以节省调用函数所带来的额外开销，本文将简单讲讲 Swift 中的内联函数。"/>



<meta property="og:title" content="Swift 拾遗 - 内联函数" />
<meta property="og:description" content="内联函数（Inline Functions）是指编译时刻将函数调用展开为函数体的一种编程语言结构，编译器将适时采取这一技术可以节省调用函数所带来的额外开销，本文将简单讲讲 Swift 中的内联函数。" />
<meta property="og:type" content="article" />
<meta property="og:url" content="/posts/2020/swift_inline/" />
<meta property="article:published_time" content="2020-07-26T00:00:00+00:00" />
<meta property="article:modified_time" content="2020-07-26T00:00:00+00:00" /><meta property="og:site_name" content="iBlog" />




<script data-ad-client="ca-pub-9925978992661955" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>

  </head>
  <body class="">
    <div class="container">
      <header class="header">
  <span class="header__inner">
    <a href="/" class="logo" style="text-decoration: none;">
  
    <span class="logo__mark"><svg xmlns="http://www.w3.org/2000/svg" class="greater-icon" viewBox="0 0 44 44">
  <path fill="none" d="M15 8l14.729 14.382L15 35.367"/>
</svg>
</span>
    <span class="logo__text">kingcos.me</span>
    <span class="logo__cursor"></span>
  
</a>

    <span class="header__right">
      
        <nav class="menu">
  <ul class="menu__inner menu__inner--desktop">
    
      
        
          <li><a href="/about">About</a></li>
        
      
        
          <li><a href="/links">Links</a></li>
        
      
        
          <li><a href="/perspective">Perspective</a></li>
        
      
        
          <li><a href="/words">Words</a></li>
        
      
      
    
  </ul>

  <ul class="menu__inner menu__inner--mobile">
    
      
        <li><a href="/about">About</a></li>
      
    
      
        <li><a href="/links">Links</a></li>
      
    
      
        <li><a href="/perspective">Perspective</a></li>
      
    
      
        <li><a href="/words">Words</a></li>
      
    
  </ul>
</nav>

        <span class="menu-trigger">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
            <path d="M0 0h24v24H0z" fill="none"/>
            <path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"/>
          </svg>
        </span>
      
      <span class="theme-toggle">
        <svg class="theme-toggler" width="24" height="24" viewBox="0 0 48 48" fill="none" xmlns="http://www.w3.org/2000/svg">
  <path d="M22 41C32.4934 41 41 32.4934 41 22C41 11.5066 32.4934 3 22
  3C11.5066 3 3 11.5066 3 22C3 32.4934 11.5066 41 22 41ZM7 22C7
  13.7157 13.7157 7 22 7V37C13.7157 37 7 30.2843 7 22Z"/>
</svg>

      </span>
    </span>
  </span>
</header>


      <div class="content">
        
  <div class="post">
    <h2 class="post-title"><a href="/posts/2020/swift_inline/">Swift 拾遗 - 内联函数</a></h2>
    <div class="post-meta">
      
        <span class="post-date">
            2020-07-26
        </span>
      
      
      
        <span class="post-read-time">— 3 min read</span>
      
    </div>

    
      <span class="post-tags">
        
          #<a href="/tags/focus/">Focus</a>&nbsp;
        
          #<a href="/tags/swift/">Swift</a>&nbsp;
        
      </span>
    

    

    <div class="post-content">
      <table>
<thead>
<tr>
<th align="center">Date</th>
<th align="center">Notes</th>
</tr>
</thead>
<tbody>
<tr>
<td align="center">2020-07-26</td>
<td align="center">首次提交</td>
</tr>
</tbody>
</table>
<h2 id="preface">Preface</h2>
<p>内联函数（Inline Functions）是指编译时刻将函数调用展开为函数体的一种编程语言结构，编译器将适时采取这一技术可以节省调用函数所带来的额外开销，本文将简单讲讲 Swift 中的内联函数。</p>
<h2 id="编译器优化等级">编译器优化等级</h2>
<p>由于内联函数会将函数调用展开为函数体，因此当编译器内联某一函数时，该函数本身将不再会被调用。而在 Debug 模式下，由于我们经常会使用打断点等调试手段，如果此时内联将不利于我们排查问题。因此在 Debug 模式下，编译器默认将不进行内联。</p>
<p>控制编译器优化等级的设置位于：Xcode - TARGETS - Build Settings - Swift Compiler - Optimization Level，其中便会影响 Swift 函数是否内联：</p>
<p><img src="/img/2020/swift_inline/1.png" alt="1"></p>
<p>Swift 编译器所支持的优化等级具体如下：</p>
<table>
<thead>
<tr>
<th align="center">Level</th>
<th align="center">Part</th>
</tr>
</thead>
<tbody>
<tr>
<td align="center">[-Onone]</td>
<td align="center">无优化（Debug 模式默认）</td>
</tr>
<tr>
<td align="center">[-O]</td>
<td align="center">速度优先（Release 模式默认）</td>
</tr>
<tr>
<td align="center">[-Osize]</td>
<td align="center">体积优先</td>
</tr>
</tbody>
</table>
<p>经过实际测试，如下 <code>foo</code> 函数在 <code>[-O]</code> 与 <code>[-Osize]</code> 等级下均被优化：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-swift" data-lang="swift"><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">foo</span>() {
    print(<span style="color:#e6db74">&#34;foo&#34;</span>) <span style="color:#75715e">// BREAKPOINT 2 🔴</span>

foo() <span style="color:#75715e">// BREAKPOINT 1 🔴</span>
</code></pre></div><p>在 <code>[-Onone]</code> 等级的汇编如下（Xcode Menu - Debug - Debug Workflow - Always Show Disassembly）：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-asm" data-lang="asm"><span style="color:#75715e">; [-Onone]
</span><span style="color:#75715e"></span>
<span style="color:#a6e22e">demo</span><span style="color:#960050;background-color:#1e0010">`</span><span style="color:#66d9ef">main</span>:
    <span style="color:#960050;background-color:#1e0010">0</span><span style="color:#a6e22e">x100000e50</span> <span style="color:#960050;background-color:#1e0010">&lt;+</span><span style="color:#ae81ff">0</span><span style="color:#960050;background-color:#1e0010">&gt;</span>:  <span style="color:#66d9ef">pushq</span>  %rbp
    <span style="color:#960050;background-color:#1e0010">0</span><span style="color:#a6e22e">x100000e51</span> <span style="color:#960050;background-color:#1e0010">&lt;+</span><span style="color:#ae81ff">1</span><span style="color:#960050;background-color:#1e0010">&gt;</span>:  <span style="color:#66d9ef">movq</span>   %rsp, %rbp
    <span style="color:#960050;background-color:#1e0010">0</span><span style="color:#a6e22e">x100000e54</span> <span style="color:#960050;background-color:#1e0010">&lt;+</span><span style="color:#ae81ff">4</span><span style="color:#960050;background-color:#1e0010">&gt;</span>:  <span style="color:#66d9ef">subq</span>   <span style="color:#66d9ef">$0x10</span>, %rsp
    <span style="color:#960050;background-color:#1e0010">0</span><span style="color:#a6e22e">x100000e58</span> <span style="color:#960050;background-color:#1e0010">&lt;+</span><span style="color:#ae81ff">8</span><span style="color:#960050;background-color:#1e0010">&gt;</span>:  <span style="color:#66d9ef">movl</span>   %edi, -<span style="color:#ae81ff">0x4</span>(%rbp)
    <span style="color:#960050;background-color:#1e0010">0</span><span style="color:#a6e22e">x100000e5b</span> <span style="color:#960050;background-color:#1e0010">&lt;+</span><span style="color:#ae81ff">11</span><span style="color:#960050;background-color:#1e0010">&gt;</span>: <span style="color:#66d9ef">movq</span>   %rsi, -<span style="color:#ae81ff">0x10</span>(%rbp)
    <span style="color:#75715e">; 断点 1 ⬇：函数调用（内联后则不存在该行汇编指令）
</span><span style="color:#75715e"></span><span style="color:#960050;background-color:#1e0010">-&gt;</span>  <span style="color:#960050;background-color:#1e0010">0</span><span style="color:#a6e22e">x100000e5f</span> <span style="color:#960050;background-color:#1e0010">&lt;+</span><span style="color:#ae81ff">15</span><span style="color:#960050;background-color:#1e0010">&gt;</span>: <span style="color:#66d9ef">callq</span>  <span style="color:#ae81ff">0x100000e70</span>               <span style="color:#75715e">; demo.foo() -&gt; () at main.swift:11
</span><span style="color:#75715e"></span>    <span style="color:#ae81ff">0x100000e64</span> <span style="color:#960050;background-color:#1e0010">&lt;+</span><span style="color:#ae81ff">20</span><span style="color:#960050;background-color:#1e0010">&gt;</span>: <span style="color:#66d9ef">xorl</span>   %eax, %eax
    <span style="color:#960050;background-color:#1e0010">0</span><span style="color:#a6e22e">x100000e66</span> <span style="color:#960050;background-color:#1e0010">&lt;+</span><span style="color:#ae81ff">22</span><span style="color:#960050;background-color:#1e0010">&gt;</span>: <span style="color:#66d9ef">addq</span>   <span style="color:#66d9ef">$0x10</span>, %rsp
    <span style="color:#960050;background-color:#1e0010">0</span><span style="color:#a6e22e">x100000e6a</span> <span style="color:#960050;background-color:#1e0010">&lt;+</span><span style="color:#ae81ff">26</span><span style="color:#960050;background-color:#1e0010">&gt;</span>: <span style="color:#66d9ef">popq</span>   %rbp
    <span style="color:#960050;background-color:#1e0010">0</span><span style="color:#a6e22e">x100000e6b</span> <span style="color:#960050;background-color:#1e0010">&lt;+</span><span style="color:#ae81ff">27</span><span style="color:#960050;background-color:#1e0010">&gt;</span>: <span style="color:#66d9ef">retq</span>

<span style="color:#a6e22e">demo</span><span style="color:#960050;background-color:#1e0010">`</span><span style="color:#66d9ef">foo</span>():
    <span style="color:#960050;background-color:#1e0010">0</span><span style="color:#a6e22e">x100000e70</span> <span style="color:#960050;background-color:#1e0010">&lt;+</span><span style="color:#ae81ff">0</span><span style="color:#960050;background-color:#1e0010">&gt;</span>:   <span style="color:#66d9ef">pushq</span>  %rbp
    <span style="color:#960050;background-color:#1e0010">0</span><span style="color:#a6e22e">x100000e71</span> <span style="color:#960050;background-color:#1e0010">&lt;+</span><span style="color:#ae81ff">1</span><span style="color:#960050;background-color:#1e0010">&gt;</span>:   <span style="color:#66d9ef">movq</span>   %rsp, %rbp
    <span style="color:#960050;background-color:#1e0010">0</span><span style="color:#a6e22e">x100000e74</span> <span style="color:#960050;background-color:#1e0010">&lt;+</span><span style="color:#ae81ff">4</span><span style="color:#960050;background-color:#1e0010">&gt;</span>:   <span style="color:#66d9ef">subq</span>   <span style="color:#66d9ef">$0x30</span>, %rsp
    <span style="color:#75715e">; 断点 2 ⬇：作用域在 foo() 内
</span><span style="color:#75715e"></span><span style="color:#960050;background-color:#1e0010">-&gt;</span>  <span style="color:#960050;background-color:#1e0010">0</span><span style="color:#a6e22e">x100000e78</span> <span style="color:#960050;background-color:#1e0010">&lt;+</span><span style="color:#ae81ff">8</span><span style="color:#960050;background-color:#1e0010">&gt;</span>:   <span style="color:#66d9ef">movq</span>   <span style="color:#ae81ff">0x189</span>(%rip), %rax         <span style="color:#75715e">; (void *)0x00007fff8b1517e0: type metadata for Any
</span><span style="color:#75715e"></span>    <span style="color:#75715e">; ...
</span><span style="color:#75715e"></span>    <span style="color:#ae81ff">0x100000f17</span> <span style="color:#960050;background-color:#1e0010">&lt;+</span><span style="color:#ae81ff">167</span><span style="color:#960050;background-color:#1e0010">&gt;</span>: <span style="color:#66d9ef">retq</span>
</code></pre></div><p>在 <code>[-O]</code> 等级的汇编如下：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-asm" data-lang="asm"><span style="color:#75715e">; [-O]
</span><span style="color:#75715e"></span>
<span style="color:#a6e22e">demo</span><span style="color:#960050;background-color:#1e0010">`</span><span style="color:#66d9ef">main</span>:
    <span style="color:#75715e">; ...
</span><span style="color:#75715e"></span>    <span style="color:#75715e">; 断点 2 ⬇：作用域在 main 内
</span><span style="color:#75715e"></span><span style="color:#960050;background-color:#1e0010">-&gt;</span>  <span style="color:#960050;background-color:#1e0010">0</span><span style="color:#a6e22e">x100000e32</span> <span style="color:#960050;background-color:#1e0010">&lt;+</span><span style="color:#ae81ff">50</span><span style="color:#960050;background-color:#1e0010">&gt;</span>:  <span style="color:#66d9ef">movq</span>   <span style="color:#ae81ff">0x1c7</span>(%rip), %rax         <span style="color:#75715e">; (void *)0x00007fff8b149910: type metadata for Swift.String
</span><span style="color:#75715e"></span>    <span style="color:#75715e">; ...
</span><span style="color:#75715e"></span>    <span style="color:#ae81ff">0x100000e82</span> <span style="color:#960050;background-color:#1e0010">&lt;+</span><span style="color:#ae81ff">130</span><span style="color:#960050;background-color:#1e0010">&gt;</span>: <span style="color:#66d9ef">retq</span>
</code></pre></div><p>在 <code>[-Osize]</code> 等级的汇编如下：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-asm" data-lang="asm"><span style="color:#75715e">; [-Osize]
</span><span style="color:#75715e"></span>
<span style="color:#a6e22e">demo</span><span style="color:#960050;background-color:#1e0010">`</span><span style="color:#66d9ef">main</span>:
    <span style="color:#75715e">; ...
</span><span style="color:#75715e"></span>    <span style="color:#75715e">; 断点 2 ⬇：作用域在 main 内
</span><span style="color:#75715e"></span><span style="color:#960050;background-color:#1e0010">-&gt;</span>  <span style="color:#960050;background-color:#1e0010">0</span><span style="color:#a6e22e">x100000e3e</span> <span style="color:#960050;background-color:#1e0010">&lt;+</span><span style="color:#ae81ff">46</span><span style="color:#960050;background-color:#1e0010">&gt;</span>:  <span style="color:#66d9ef">movq</span>   <span style="color:#ae81ff">0x1bb</span>(%rip), %rax         <span style="color:#75715e">; (void *)0x00007fff8b149910: type metadata for Swift.String
</span><span style="color:#75715e"></span>    <span style="color:#75715e">; ...
</span><span style="color:#75715e"></span>    <span style="color:#ae81ff">0x100000e8a</span> <span style="color:#960050;background-color:#1e0010">&lt;+</span><span style="color:#ae81ff">122</span><span style="color:#960050;background-color:#1e0010">&gt;</span>: <span style="color:#66d9ef">retq</span>
</code></pre></div><p><code>[-O]</code> 与 <code>[-Osize]</code> 的结果类似，即通过内联使得断点 1 不再执行；而断点 2 虽然得到执行，但通过查看汇编可以看出，断点 2 处的代码作用域已变为 <code>main</code>，且无 <code>call</code> 调用相关函数的指令，证明函数已经内联。</p>
<h2 id="内联条件">内联条件</h2>
<p>在开启编译器优化后，Swift 编译器便会针对函数进行内联优化，但并非所有函数都支持内联。</p>
<ul>
<li>函数体过长的函数将不支持内联；</li>
</ul>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-swift" data-lang="swift"><span style="color:#75715e">// [-O]</span>

<span style="color:#66d9ef">func</span> <span style="color:#a6e22e">foo</span>() {
    print(<span style="color:#66d9ef">#function</span>)
    print(<span style="color:#66d9ef">#function</span>)
    print(<span style="color:#66d9ef">#function</span>)
}

foo() <span style="color:#75715e">// BREAKPOINT 🔴</span>
</code></pre></div><p>由于过长的函数体内联反而会导致实际代码行数增多，可能会影响性能，因此如上，当函数体内的 <code>print</code> 语句超过两句时，内联就会失效。我们可以从函数调用处的断点或者汇编来得出结论：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-asm" data-lang="asm"><span style="color:#a6e22e">demo</span><span style="color:#960050;background-color:#1e0010">`</span><span style="color:#66d9ef">main</span>:
    <span style="color:#960050;background-color:#1e0010">0</span><span style="color:#a6e22e">x100000da0</span> <span style="color:#960050;background-color:#1e0010">&lt;+</span><span style="color:#ae81ff">0</span><span style="color:#960050;background-color:#1e0010">&gt;</span>:  <span style="color:#66d9ef">pushq</span>  %rbp
    <span style="color:#960050;background-color:#1e0010">0</span><span style="color:#a6e22e">x100000da1</span> <span style="color:#960050;background-color:#1e0010">&lt;+</span><span style="color:#ae81ff">1</span><span style="color:#960050;background-color:#1e0010">&gt;</span>:  <span style="color:#66d9ef">movq</span>   %rsp, %rbp
<span style="color:#960050;background-color:#1e0010">-&gt;</span>  <span style="color:#960050;background-color:#1e0010">0</span><span style="color:#a6e22e">x100000da4</span> <span style="color:#960050;background-color:#1e0010">&lt;+</span><span style="color:#ae81ff">4</span><span style="color:#960050;background-color:#1e0010">&gt;</span>:  <span style="color:#66d9ef">callq</span>  <span style="color:#ae81ff">0x100000db0</span>               <span style="color:#75715e">; demo.foo() -&gt; () at main.swift:11
</span><span style="color:#75715e"></span>    <span style="color:#ae81ff">0x100000da9</span> <span style="color:#960050;background-color:#1e0010">&lt;+</span><span style="color:#ae81ff">9</span><span style="color:#960050;background-color:#1e0010">&gt;</span>:  <span style="color:#66d9ef">xorl</span>   %eax, %eax
    <span style="color:#960050;background-color:#1e0010">0</span><span style="color:#a6e22e">x100000dab</span> <span style="color:#960050;background-color:#1e0010">&lt;+</span><span style="color:#ae81ff">11</span><span style="color:#960050;background-color:#1e0010">&gt;</span>: <span style="color:#66d9ef">popq</span>   %rbp
    <span style="color:#960050;background-color:#1e0010">0</span><span style="color:#a6e22e">x100000dac</span> <span style="color:#960050;background-color:#1e0010">&lt;+</span><span style="color:#ae81ff">12</span><span style="color:#960050;background-color:#1e0010">&gt;</span>: <span style="color:#66d9ef">retq</span>
</code></pre></div><ul>
<li>包含递归调用的函数将不支持内联；</li>
</ul>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-swift" data-lang="swift"><span style="color:#75715e">// [-O]</span>

<span style="color:#66d9ef">func</span> <span style="color:#a6e22e">foo</span>(<span style="color:#66d9ef">_</span> i: Int) -&gt; Int {
    <span style="color:#66d9ef">if</span> i <span style="color:#f92672">&lt;=</span> <span style="color:#ae81ff">1</span> {
        <span style="color:#66d9ef">return</span> i
    }

    <span style="color:#66d9ef">var</span> result = foo(i <span style="color:#f92672">-</span> <span style="color:#ae81ff">1</span>)
    result <span style="color:#f92672">+=</span> <span style="color:#ae81ff">1</span>

    <span style="color:#66d9ef">return</span> result
}

<span style="color:#66d9ef">_</span> = foo(<span style="color:#ae81ff">5</span>)
</code></pre></div><p>由于包含递归的函数体需要在函数内部调用自身，此时若使用内联便会造成无限展开。因此如上，当函数体内的存在自身的递归时，内联就会失效。我们可以从函数调用处的断点或者汇编来得出结论：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-asm" data-lang="asm"><span style="color:#a6e22e">demo</span><span style="color:#960050;background-color:#1e0010">`</span><span style="color:#66d9ef">main</span>:
    <span style="color:#960050;background-color:#1e0010">0</span><span style="color:#a6e22e">x100000f70</span> <span style="color:#960050;background-color:#1e0010">&lt;+</span><span style="color:#ae81ff">0</span><span style="color:#960050;background-color:#1e0010">&gt;</span>:  <span style="color:#66d9ef">pushq</span>  %rbp
    <span style="color:#960050;background-color:#1e0010">0</span><span style="color:#a6e22e">x100000f71</span> <span style="color:#960050;background-color:#1e0010">&lt;+</span><span style="color:#ae81ff">1</span><span style="color:#960050;background-color:#1e0010">&gt;</span>:  <span style="color:#66d9ef">movq</span>   %rsp, %rbp
<span style="color:#960050;background-color:#1e0010">-&gt;</span>  <span style="color:#960050;background-color:#1e0010">0</span><span style="color:#a6e22e">x100000f74</span> <span style="color:#960050;background-color:#1e0010">&lt;+</span><span style="color:#ae81ff">4</span><span style="color:#960050;background-color:#1e0010">&gt;</span>:  <span style="color:#66d9ef">movl</span>   <span style="color:#66d9ef">$0x5</span>, %edi
    <span style="color:#960050;background-color:#1e0010">0</span><span style="color:#a6e22e">x100000f79</span> <span style="color:#960050;background-color:#1e0010">&lt;+</span><span style="color:#ae81ff">9</span><span style="color:#960050;background-color:#1e0010">&gt;</span>:  <span style="color:#66d9ef">callq</span>  <span style="color:#ae81ff">0x100000f90</span>               <span style="color:#75715e">; demo.foo(Swift.Int) -&gt; Swift.Int at main.swift:41
</span><span style="color:#75715e"></span>    <span style="color:#ae81ff">0x100000f7e</span> <span style="color:#960050;background-color:#1e0010">&lt;+</span><span style="color:#ae81ff">14</span><span style="color:#960050;background-color:#1e0010">&gt;</span>: <span style="color:#66d9ef">xorl</span>   %eax, %eax
    <span style="color:#960050;background-color:#1e0010">0</span><span style="color:#a6e22e">x100000f80</span> <span style="color:#960050;background-color:#1e0010">&lt;+</span><span style="color:#ae81ff">16</span><span style="color:#960050;background-color:#1e0010">&gt;</span>: <span style="color:#66d9ef">popq</span>   %rbp
    <span style="color:#960050;background-color:#1e0010">0</span><span style="color:#a6e22e">x100000f81</span> <span style="color:#960050;background-color:#1e0010">&lt;+</span><span style="color:#ae81ff">17</span><span style="color:#960050;background-color:#1e0010">&gt;</span>: <span style="color:#66d9ef">retq</span>
</code></pre></div><blockquote>
<p>对于递归函数需要注意的是，编译器会对尾递归（Tail Recursion，即递归位于函数末尾）进行额外优化，即尾递归优化（Tail Call Optimization）。如下一段求阶乘的代码：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-swift" data-lang="swift"><span style="color:#75715e">// [-O]</span>

<span style="color:#66d9ef">func</span> <span style="color:#a6e22e">foo</span>(<span style="color:#66d9ef">_</span> i: Int) -&gt; Int {
    <span style="color:#66d9ef">if</span> i <span style="color:#f92672">&lt;=</span> <span style="color:#ae81ff">1</span> {
        <span style="color:#66d9ef">return</span> i
    }
    <span style="color:#66d9ef">return</span> foo(i <span style="color:#f92672">-</span> <span style="color:#ae81ff">1</span>)
}

<span style="color:#66d9ef">_</span> = foo(<span style="color:#ae81ff">5</span>)
</code></pre></div><p>将其转换为汇编如下：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-asm" data-lang="asm"><span style="color:#a6e22e">demo</span><span style="color:#960050;background-color:#1e0010">`</span><span style="color:#66d9ef">main</span>:
    <span style="color:#960050;background-color:#1e0010">0</span><span style="color:#a6e22e">x100000f90</span> <span style="color:#960050;background-color:#1e0010">&lt;+</span><span style="color:#ae81ff">0</span><span style="color:#960050;background-color:#1e0010">&gt;</span>: <span style="color:#66d9ef">pushq</span>  %rbp
    <span style="color:#960050;background-color:#1e0010">0</span><span style="color:#a6e22e">x100000f91</span> <span style="color:#960050;background-color:#1e0010">&lt;+</span><span style="color:#ae81ff">1</span><span style="color:#960050;background-color:#1e0010">&gt;</span>: <span style="color:#66d9ef">movq</span>   %rsp, %rbp
<span style="color:#960050;background-color:#1e0010">-&gt;</span>  <span style="color:#960050;background-color:#1e0010">0</span><span style="color:#a6e22e">x100000f94</span> <span style="color:#960050;background-color:#1e0010">&lt;+</span><span style="color:#ae81ff">4</span><span style="color:#960050;background-color:#1e0010">&gt;</span>: <span style="color:#66d9ef">xorl</span>   %eax, %eax
    <span style="color:#960050;background-color:#1e0010">0</span><span style="color:#a6e22e">x100000f96</span> <span style="color:#960050;background-color:#1e0010">&lt;+</span><span style="color:#ae81ff">6</span><span style="color:#960050;background-color:#1e0010">&gt;</span>: <span style="color:#66d9ef">popq</span>   %rbp
    <span style="color:#960050;background-color:#1e0010">0</span><span style="color:#a6e22e">x100000f97</span> <span style="color:#960050;background-color:#1e0010">&lt;+</span><span style="color:#ae81ff">7</span><span style="color:#960050;background-color:#1e0010">&gt;</span>: <span style="color:#66d9ef">retq</span>
</code></pre></div><p>本文暂时不会涉及过多关于尾递归的内容。</p>
</blockquote>
<ul>
<li>包含动态派发的代码将不支持内联；</li>
</ul>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-swift" data-lang="swift"><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">People</span> {
    <span style="color:#66d9ef">var</span> name: String = <span style="color:#e6db74">&#34;Name&#34;</span>

    <span style="color:#66d9ef">func</span> <span style="color:#a6e22e">bar</span>() {}

    <span style="color:#66d9ef">func</span> <span style="color:#a6e22e">foo</span>() {
        <span style="color:#75715e">// NOT Inline</span>
        <span style="color:#66d9ef">var</span> p: People = Student()
        p = Teacher()

        p.bar()

        <span style="color:#75715e">// Inline</span>
        <span style="color:#66d9ef">let</span> q = Student()

        q.baz() <span style="color:#75715e">// b -r Student.baz 🔴</span>
    }
}

<span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Teacher</span>: People {
    <span style="color:#66d9ef">override</span> <span style="color:#66d9ef">func</span> <span style="color:#a6e22e">bar</span>() {
        print(<span style="color:#e6db74">&#34;Teacher - </span><span style="color:#e6db74">\(</span>name<span style="color:#e6db74">)</span><span style="color:#e6db74">&#34;</span>)
    }
}

<span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Student</span>: People {
    <span style="color:#66d9ef">override</span> <span style="color:#66d9ef">func</span> <span style="color:#a6e22e">bar</span>() {
        print(<span style="color:#e6db74">&#34;Student - </span><span style="color:#e6db74">\(</span>name<span style="color:#e6db74">)</span><span style="color:#e6db74">&#34;</span>)
    }

    <span style="color:#66d9ef">func</span> <span style="color:#a6e22e">baz</span>() {}
}

People().foo()
</code></pre></div><p>由于包含动态派发的函数只有在运行时才是确定的。因此如上，当使用多态时，内联就会失效。我们可以从函数调用处的断点或者汇编来得出结论：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-asm" data-lang="asm"><span style="color:#a6e22e">demo</span><span style="color:#960050;background-color:#1e0010">`</span><span style="color:#66d9ef">main</span>:
    <span style="color:#75715e">; ...
</span><span style="color:#75715e"></span>    <span style="color:#960050;background-color:#1e0010">0</span><span style="color:#a6e22e">x100001524</span> <span style="color:#960050;background-color:#1e0010">&lt;+</span><span style="color:#ae81ff">212</span><span style="color:#960050;background-color:#1e0010">&gt;</span>: <span style="color:#66d9ef">movq</span>   <span style="color:#ae81ff">0x18</span>(%rbx), %rdi
    <span style="color:#960050;background-color:#1e0010">0</span><span style="color:#a6e22e">x100001528</span> <span style="color:#960050;background-color:#1e0010">&lt;+</span><span style="color:#ae81ff">216</span><span style="color:#960050;background-color:#1e0010">&gt;</span>: <span style="color:#66d9ef">callq</span>  <span style="color:#ae81ff">0x100001be2</span>               <span style="color:#75715e">; symbol stub for: swift_bridgeObjectRelease
</span><span style="color:#75715e"></span>-<span style="color:#960050;background-color:#1e0010">&gt;</span>  <span style="color:#ae81ff">0x10000152d</span> <span style="color:#960050;background-color:#1e0010">&lt;+</span><span style="color:#ae81ff">221</span><span style="color:#960050;background-color:#1e0010">&gt;</span>: <span style="color:#66d9ef">callq</span>  <span style="color:#ae81ff">0x100001960</span>               <span style="color:#75715e">; demo.Teacher.bar() -&gt; ()
</span><span style="color:#75715e"></span>    <span style="color:#ae81ff">0x100001532</span> <span style="color:#960050;background-color:#1e0010">&lt;+</span><span style="color:#ae81ff">226</span><span style="color:#960050;background-color:#1e0010">&gt;</span>: <span style="color:#66d9ef">movq</span>   %r13, %rdi
    <span style="color:#960050;background-color:#1e0010">0</span><span style="color:#a6e22e">x100001535</span> <span style="color:#960050;background-color:#1e0010">&lt;+</span><span style="color:#ae81ff">229</span><span style="color:#960050;background-color:#1e0010">&gt;</span>: <span style="color:#66d9ef">callq</span>  <span style="color:#ae81ff">0x100001c0c</span>               <span style="color:#75715e">; symbol stub for: swift_release
</span><span style="color:#75715e"></span>    <span style="color:#75715e">; ...
</span><span style="color:#75715e"></span>
</code></pre></div><h2 id="inline">@inline</h2>
<!--

---

内联函数（Inline Functions）指编译时刻将函数调用展开成函数体。在 Xcode 中的 Swift 项目中，如果开启了编译器优化（Release 模式默认会开启优化），编译器会自动将某些函数变成内联函数。但若函数存在以下特点将不会被自动内联：

1. 函数体较长时（因内联会导致可执行代码体积增大）
2. 包含递归调用时（因内联会导致死循环）
3. 包含动态派发时（因编译时刻无法确认要执行的代码）

## @inline

- 官方源码中使用 `@inline` 来建议（注意「建议」而非强制）编译器去禁止（`never`）或在条件允许的情况下（除递归、动态派发等）总是（`__always`）内联，优先级高于编译设置；
- 注意 `__always` 只在开启编译器优化选项时（无论是优化速度还是体积）几乎总是内联（未开启时将不会被内联）。

```swift
// [-O] / [-Osize]

@inline(never) func bar() {
    print("bar")
}

@inline(__always) func baz() {
    print("baz")
}

bar()
baz()
``` -->
<!-- ### API & ABI

- API（Application Programming Interface，应用程序编程接口）：源代码和库之间的接口。
- ABI（Application Binary Interface，应用程序二进制接口）：
  - 应用程序与操作系统之间的底层接口
  - 涉及的内容有：
    - 目标文件格式（eg. Mach-O）
    - 数据类型的大小 / 布局 / 对齐（eg. 基本类型占用的内存大小）
    - 函数调用约定（eg. 函数调用时使用栈空间还是寄存器、函数参数的入栈顺序）等 -->

    </div>
    
      <div class="pagination">
        <div class="pagination__title">
          <span class="pagination__title-h">Read other posts</span>
          <hr />
        </div>
        <div class="pagination__buttons">
          
            <span class="button previous">
              <a href="/posts/2020/assertion_in_ios/">
                <span class="button__icon">←</span>
                <span class="button__text">iOS 中的断言</span>
              </a>
            </span>
          
          
            <span class="button next">
              <a href="/posts/2020/swift_inout/">
                <span class="button__text">Swift 拾遗 - inout</span>
                <span class="button__icon">→</span>
              </a>
            </span>
          
        </div>
      </div>
    

    

<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<table style="border: 0;">
  <tr>
  <td style="border: 0; width: 30%;">
    <img src='/img/about/1.jpg'>
  </td>
  <td style="border: 0;">
    <ins class="adsbygoogle"
     style="display:block"
     data-ad-client="ca-pub-9925978992661955"
     data-ad-slot="3213735320"
     data-ad-format="auto"
     data-full-width-responsive="true"></ins>
  </td>
  </tr>
</table>



<script>
     (adsbygoogle = window.adsbygoogle || []).push({});
</script>


    
    
    <div>
      <div id="github-comment">
      </div>

      <script type="text/javascript">
        function getUtterances(isDark) {
          var utterances = document.createElement('script');
          utterances.type = 'text/javascript';
          utterances.async = true;
          utterances.setAttribute('issue-term', "pathname")
          utterances.setAttribute('repo', "kingcos\/kingcos.github.io")
          utterances.setAttribute('label', "comments")
          isDark ? utterances.setAttribute('theme', "github-dark") : utterances.setAttribute('theme', "github-light")
          utterances.crossorigin = 'anonymous';
          utterances.src = 'https://utteranc.es/client.js';

          return utterances
        }

        var themeToggle = document.querySelector(".theme-toggle")
        themeToggle.addEventListener("click", function () {
          var getTheme = window.localStorage && window.localStorage.getItem("theme")
          var divNode = document.getElementById('github-comment')
          while(divNode.hasChildNodes()) {
            divNode.removeChild(divNode.firstChild);
          }
          
          
          

          
          
          
          
          
          
          document.getElementById('github-comment').appendChild(getUtterances(getTheme !== "dark"))
        })

        var getTheme = window.localStorage && window.localStorage.getItem("theme")
        document.getElementById('github-comment').appendChild(getUtterances(getTheme === "dark"))
      </script>
    </div>
    

    </div>

      </div>

      
        <footer class="footer">
  <div class="footer__inner">
    
      <div class="copyright copyright--user">All rights reserved by kingcos.me</div>
    
  </div>
</footer>

<script src="/assets/main.js"></script>
<script src="/assets/prism.js"></script>



      
    </div>

    
      
<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
	(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
	m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
	})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
	ga('create', 'UA-138311951-1', 'auto');
	
	ga('send', 'pageview');
}
</script>

    
  </body>
</html>
