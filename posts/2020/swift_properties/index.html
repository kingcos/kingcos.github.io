<!DOCTYPE html>
<html lang="en">
  <head>
    
      <title>Swift 拾遗 - 属性 :: iBlog</title>
    
    <meta http-equiv="content-type" content="text/html; charset=utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">
<meta name="description" content="Date Notes Info     2020-08-01 纳入 Swift 拾遗系列，并重新整理完善 Swift 5.3, Xcode 12.0   2017-04-27 扩充「延迟存储属性」部分并新增「devxoul/Then」一节 Swift 3.1, Xcode 8.3.2   2016-10-26 首次提交 Swift 3.0, Xcode 8.1 Beta 3    Preface 《Swift 拾遗》是一个关于 Swift 的新文章专辑，这个系列的文章将不会涉及基本语法的层面，而是尝试从底层「拾」起之前所忽视的内容。今天我们将一起简单探究 Swift 中的属性。
存储属性与计算属性 struct Foo { var bar: Int var baz: Int { get { bar * 2 } set { bar = newValue / 2 } } var customSetParamBaz: Int { get { bar * 2 } set(customNewValue) { bar = customNewValue / 2 } } } var foo = Foo(bar: 10) _ = foo."/>
<meta name="keywords" content="kingcos.me,maimieng.comios,swift,objective-c,obj-c,objc,oc,geek,python,ruby,golang,go,apple,mac"/>
<meta name="robots" content="noodp"/>
<link rel="canonical" href="/posts/2020/swift_properties/" />





<link rel="stylesheet" href="/assets/style.css">


<link rel="stylesheet" href="/style.css">


<link rel="apple-touch-icon-precomposed" sizes="144x144" href="/img/apple-touch-icon-144-precomposed.png">
<link rel="shortcut icon" href="/img/favicon.png">


<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Swift 拾遗 - 属性"/>
<meta name="twitter:description" content="《Swift 拾遗》是一个关于 Swift 的新文章专辑，这个系列的文章将不会涉及基本语法的层面，而是尝试从底层「拾」起之前所忽视的内容。今天我们将一起简单探究 Swift 中的属性。"/>



<meta property="og:title" content="Swift 拾遗 - 属性" />
<meta property="og:description" content="《Swift 拾遗》是一个关于 Swift 的新文章专辑，这个系列的文章将不会涉及基本语法的层面，而是尝试从底层「拾」起之前所忽视的内容。今天我们将一起简单探究 Swift 中的属性。" />
<meta property="og:type" content="article" />
<meta property="og:url" content="/posts/2020/swift_properties/" />
<meta property="article:published_time" content="2020-09-18T00:00:00+00:00" />
<meta property="article:modified_time" content="2020-09-18T00:00:00+00:00" /><meta property="og:site_name" content="iBlog" />




<script data-ad-client="ca-pub-9925978992661955" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>

  </head>
  <body class="">
    <div class="container">
      <header class="header">
  <span class="header__inner">
    <a href="/" class="logo" style="text-decoration: none;">
  
    <span class="logo__mark"><svg xmlns="http://www.w3.org/2000/svg" class="greater-icon" viewBox="0 0 44 44">
  <path fill="none" d="M15 8l14.729 14.382L15 35.367"/>
</svg>
</span>
    <span class="logo__text">kingcos.me</span>
    <span class="logo__cursor"></span>
  
</a>

    <span class="header__right">
      
        <nav class="menu">
  <ul class="menu__inner menu__inner--desktop">
    
      
        
          <li><a href="/about">About</a></li>
        
      
        
          <li><a href="/links">Links</a></li>
        
      
        
          <li><a href="/perspective">Perspective</a></li>
        
      
        
          <li><a href="/words">Words</a></li>
        
      
      
    
  </ul>

  <ul class="menu__inner menu__inner--mobile">
    
      
        <li><a href="/about">About</a></li>
      
    
      
        <li><a href="/links">Links</a></li>
      
    
      
        <li><a href="/perspective">Perspective</a></li>
      
    
      
        <li><a href="/words">Words</a></li>
      
    
  </ul>
</nav>

        <span class="menu-trigger">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
            <path d="M0 0h24v24H0z" fill="none"/>
            <path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"/>
          </svg>
        </span>
      
      <span class="theme-toggle">
        <svg class="theme-toggler" width="24" height="24" viewBox="0 0 48 48" fill="none" xmlns="http://www.w3.org/2000/svg">
  <path d="M22 41C32.4934 41 41 32.4934 41 22C41 11.5066 32.4934 3 22
  3C11.5066 3 3 11.5066 3 22C3 32.4934 11.5066 41 22 41ZM7 22C7
  13.7157 13.7157 7 22 7V37C13.7157 37 7 30.2843 7 22Z"/>
</svg>

      </span>
    </span>
  </span>
</header>


      <div class="content">
        
  <div class="post">
    <h2 class="post-title"><a href="/posts/2020/swift_properties/">Swift 拾遗 - 属性</a></h2>
    <div class="post-meta">
      
        <span class="post-date">
            2020-09-18
        </span>
      
      
      
        <span class="post-read-time">— 10 min read</span>
      
    </div>

    
      <span class="post-tags">
        
          #<a href="/tags/swift/">Swift</a>&nbsp;
        
          #<a href="/tags/swift-%E6%8B%BE%E9%81%97/">Swift 拾遗</a>&nbsp;
        
      </span>
    

    

    <div class="post-content">
      <table>
<thead>
<tr>
<th style="text-align:center">Date</th>
<th style="text-align:center">Notes</th>
<th style="text-align:center">Info</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">2020-08-01</td>
<td style="text-align:center">纳入 Swift 拾遗系列，并重新整理完善</td>
<td style="text-align:center">Swift 5.3, Xcode 12.0</td>
</tr>
<tr>
<td style="text-align:center">2017-04-27</td>
<td style="text-align:center">扩充「延迟存储属性」部分并新增「devxoul/Then」一节</td>
<td style="text-align:center">Swift 3.1, Xcode 8.3.2</td>
</tr>
<tr>
<td style="text-align:center">2016-10-26</td>
<td style="text-align:center">首次提交</td>
<td style="text-align:center">Swift 3.0, Xcode 8.1 Beta 3</td>
</tr>
</tbody>
</table>
<h2 id="preface">Preface</h2>
<p>《Swift 拾遗》是一个关于 Swift 的新文章专辑，这个系列的文章将不会涉及基本语法的层面，而是尝试从底层「拾」起之前所忽视的内容。今天我们将一起简单探究 Swift 中的属性。</p>
<h2 id="存储属性与计算属性">存储属性与计算属性</h2>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-swift" data-lang="swift"><span style="color:#66d9ef">struct</span> <span style="color:#a6e22e">Foo</span> {
    <span style="color:#66d9ef">var</span> bar: Int
    <span style="color:#66d9ef">var</span> baz: Int {
        <span style="color:#66d9ef">get</span> {
            bar <span style="color:#f92672">*</span> <span style="color:#ae81ff">2</span>
        }

        <span style="color:#66d9ef">set</span> {
            bar = newValue <span style="color:#f92672">/</span> <span style="color:#ae81ff">2</span>
        }
    }

    <span style="color:#66d9ef">var</span> customSetParamBaz: Int {
        <span style="color:#66d9ef">get</span> {
            bar <span style="color:#f92672">*</span> <span style="color:#ae81ff">2</span>
        }

        <span style="color:#66d9ef">set</span>(customNewValue) {
            bar = customNewValue <span style="color:#f92672">/</span> <span style="color:#ae81ff">2</span>
        }
    }
}

<span style="color:#66d9ef">var</span> foo = Foo(bar: <span style="color:#ae81ff">10</span>)

<span style="color:#66d9ef">_</span> = foo.bar <span style="color:#75715e">// 10</span>
<span style="color:#66d9ef">_</span> = foo.baz <span style="color:#75715e">// 20  // BREAKPOINT 🔴</span>

foo.baz = <span style="color:#ae81ff">100</span>

<span style="color:#66d9ef">_</span> = foo.baz <span style="color:#75715e">// 100</span>
<span style="color:#66d9ef">_</span> = foo.bar <span style="color:#75715e">// 50</span>
</code></pre></div><p>如上，<code>bar</code> 为存储属性，即将占用实例对象的内存空间；而 <code>baz</code> 为计算属性，将通过其它变量得出，当外界取值时将得到调用 <code>get</code> 中的返回，设置时将通过 <code>set</code> 中 <code>newValue</code> 将外界的值传递进入并进行一定的计算。那么计算属性是否会占用实例对象的内存空间呢？</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-swift" data-lang="swift">print(MemoryLayout&lt;Foo&gt;.size)   <span style="color:#75715e">// 8</span>
print(MemoryLayout&lt;Foo&gt;.stride) <span style="color:#75715e">// 8</span>
</code></pre></div><p>我们也可以代码运行，并在断点处以汇编代码分析：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-asm" data-lang="asm"><span style="color:#960050;background-color:#1e0010">-&gt;</span>  <span style="color:#960050;background-color:#1e0010">0</span><span style="color:#a6e22e">x1000027a1</span> <span style="color:#960050;background-color:#1e0010">&lt;+</span><span style="color:#ae81ff">113</span><span style="color:#960050;background-color:#1e0010">&gt;</span>: <span style="color:#66d9ef">movq</span>   %rax, %rdi
    <span style="color:#960050;background-color:#1e0010">0</span><span style="color:#a6e22e">x1000027a4</span> <span style="color:#960050;background-color:#1e0010">&lt;+</span><span style="color:#ae81ff">116</span><span style="color:#960050;background-color:#1e0010">&gt;</span>: <span style="color:#66d9ef">leaq</span>   -<span style="color:#ae81ff">0x38</span>(%rbp), %rsi
    <span style="color:#960050;background-color:#1e0010">0</span><span style="color:#a6e22e">x1000027a8</span> <span style="color:#960050;background-color:#1e0010">&lt;+</span><span style="color:#ae81ff">120</span><span style="color:#960050;background-color:#1e0010">&gt;</span>: <span style="color:#66d9ef">movl</span>   <span style="color:#66d9ef">$0x20</span>, %edx
    <span style="color:#960050;background-color:#1e0010">0</span><span style="color:#a6e22e">x1000027ad</span> <span style="color:#960050;background-color:#1e0010">&lt;+</span><span style="color:#ae81ff">125</span><span style="color:#960050;background-color:#1e0010">&gt;</span>: <span style="color:#66d9ef">callq</span>  <span style="color:#ae81ff">0x100003b92</span>               <span style="color:#75715e">; symbol stub for: swift_beginAccess
</span><span style="color:#75715e"></span>    <span style="color:#ae81ff">0x1000027b2</span> <span style="color:#960050;background-color:#1e0010">&lt;+</span><span style="color:#ae81ff">130</span><span style="color:#960050;background-color:#1e0010">&gt;</span>: <span style="color:#66d9ef">movq</span>   <span style="color:#ae81ff">0x59bf</span>(%rip), %rdi        <span style="color:#75715e">; demo.foo : demo.Foo
</span><span style="color:#75715e"></span>    <span style="color:#75715e">; 将调用计算属性的 getter
</span><span style="color:#75715e"></span>    <span style="color:#ae81ff">0x1000027b9</span> <span style="color:#960050;background-color:#1e0010">&lt;+</span><span style="color:#ae81ff">137</span><span style="color:#960050;background-color:#1e0010">&gt;</span>: <span style="color:#66d9ef">callq</span>  <span style="color:#ae81ff">0x1000028c0</span>               <span style="color:#75715e">; demo.Foo.baz.getter : Swift.Int at main.swift:6
</span><span style="color:#75715e"></span>    <span style="color:#ae81ff">0x1000027be</span> <span style="color:#960050;background-color:#1e0010">&lt;+</span><span style="color:#ae81ff">142</span><span style="color:#960050;background-color:#1e0010">&gt;</span>: <span style="color:#66d9ef">leaq</span>   -<span style="color:#ae81ff">0x38</span>(%rbp), %rdi
    <span style="color:#960050;background-color:#1e0010">0</span><span style="color:#a6e22e">x1000027c2</span> <span style="color:#960050;background-color:#1e0010">&lt;+</span><span style="color:#ae81ff">146</span><span style="color:#960050;background-color:#1e0010">&gt;</span>: <span style="color:#66d9ef">movq</span>   %rax, -<span style="color:#ae81ff">0xa0</span>(%rbp)
    <span style="color:#960050;background-color:#1e0010">0</span><span style="color:#a6e22e">x1000027c9</span> <span style="color:#960050;background-color:#1e0010">&lt;+</span><span style="color:#ae81ff">153</span><span style="color:#960050;background-color:#1e0010">&gt;</span>: <span style="color:#66d9ef">callq</span>  <span style="color:#ae81ff">0x100003b98</span>               <span style="color:#75715e">; symbol stub for: swift_endAccess
</span><span style="color:#75715e"></span>    <span style="color:#ae81ff">0x1000027ce</span> <span style="color:#960050;background-color:#1e0010">&lt;+</span><span style="color:#ae81ff">158</span><span style="color:#960050;background-color:#1e0010">&gt;</span>: <span style="color:#66d9ef">leaq</span>   <span style="color:#ae81ff">0x59a3</span>(%rip), %rax        <span style="color:#75715e">; demo.foo : demo.Foo
</span><span style="color:#75715e"></span>    <span style="color:#ae81ff">0x1000027d5</span> <span style="color:#960050;background-color:#1e0010">&lt;+</span><span style="color:#ae81ff">165</span><span style="color:#960050;background-color:#1e0010">&gt;</span>: <span style="color:#66d9ef">xorl</span>   %r8d, %r8d
    <span style="color:#960050;background-color:#1e0010">0</span><span style="color:#a6e22e">x1000027d8</span> <span style="color:#960050;background-color:#1e0010">&lt;+</span><span style="color:#ae81ff">168</span><span style="color:#960050;background-color:#1e0010">&gt;</span>: <span style="color:#66d9ef">movl</span>   %r8d, %ecx
    <span style="color:#960050;background-color:#1e0010">0</span><span style="color:#a6e22e">x1000027db</span> <span style="color:#960050;background-color:#1e0010">&lt;+</span><span style="color:#ae81ff">171</span><span style="color:#960050;background-color:#1e0010">&gt;</span>: <span style="color:#66d9ef">movq</span>   %rax, %rdi
    <span style="color:#960050;background-color:#1e0010">0</span><span style="color:#a6e22e">x1000027de</span> <span style="color:#960050;background-color:#1e0010">&lt;+</span><span style="color:#ae81ff">174</span><span style="color:#960050;background-color:#1e0010">&gt;</span>: <span style="color:#66d9ef">leaq</span>   -<span style="color:#ae81ff">0x50</span>(%rbp), %rsi
    <span style="color:#960050;background-color:#1e0010">0</span><span style="color:#a6e22e">x1000027e2</span> <span style="color:#960050;background-color:#1e0010">&lt;+</span><span style="color:#ae81ff">178</span><span style="color:#960050;background-color:#1e0010">&gt;</span>: <span style="color:#66d9ef">movl</span>   <span style="color:#66d9ef">$0x21</span>, %edx
    <span style="color:#960050;background-color:#1e0010">0</span><span style="color:#a6e22e">x1000027e7</span> <span style="color:#960050;background-color:#1e0010">&lt;+</span><span style="color:#ae81ff">183</span><span style="color:#960050;background-color:#1e0010">&gt;</span>: <span style="color:#66d9ef">callq</span>  <span style="color:#ae81ff">0x100003b92</span>               <span style="color:#75715e">; symbol stub for: swift_beginAccess
</span><span style="color:#75715e"></span>    <span style="color:#ae81ff">0x1000027ec</span> <span style="color:#960050;background-color:#1e0010">&lt;+</span><span style="color:#ae81ff">188</span><span style="color:#960050;background-color:#1e0010">&gt;</span>: <span style="color:#66d9ef">movl</span>   <span style="color:#66d9ef">$0x64</span>, %edi
    <span style="color:#960050;background-color:#1e0010">0</span><span style="color:#a6e22e">x1000027f1</span> <span style="color:#960050;background-color:#1e0010">&lt;+</span><span style="color:#ae81ff">193</span><span style="color:#960050;background-color:#1e0010">&gt;</span>: <span style="color:#66d9ef">leaq</span>   <span style="color:#ae81ff">0x5980</span>(%rip), %r13        <span style="color:#75715e">; demo.foo : demo.Foo
</span><span style="color:#75715e"></span>    <span style="color:#75715e">; 将调用计算属性的 setter
</span><span style="color:#75715e"></span>    <span style="color:#ae81ff">0x1000027f8</span> <span style="color:#960050;background-color:#1e0010">&lt;+</span><span style="color:#ae81ff">200</span><span style="color:#960050;background-color:#1e0010">&gt;</span>: <span style="color:#66d9ef">callq</span>  <span style="color:#ae81ff">0x100002960</span>               <span style="color:#75715e">; demo.Foo.baz.setter : Swift.Int at main.swift:10
</span><span style="color:#75715e"></span>    <span style="color:#ae81ff">0x1000027fd</span> <span style="color:#960050;background-color:#1e0010">&lt;+</span><span style="color:#ae81ff">205</span><span style="color:#960050;background-color:#1e0010">&gt;</span>: <span style="color:#66d9ef">leaq</span>   -<span style="color:#ae81ff">0x50</span>(%rbp), %rdi
    <span style="color:#960050;background-color:#1e0010">0</span><span style="color:#a6e22e">x100002801</span> <span style="color:#960050;background-color:#1e0010">&lt;+</span><span style="color:#ae81ff">209</span><span style="color:#960050;background-color:#1e0010">&gt;</span>: <span style="color:#66d9ef">callq</span>  <span style="color:#ae81ff">0x100003b98</span>               <span style="color:#75715e">; symbol stub for: swift_endAccess
</span></code></pre></div><p>如上，计算属性将不会产生实际的变量，外界的使用将通过 <code>get</code> 和 <code>set</code> 中所生成的 <code>getter</code> 和 <code>setter</code> 方法访问或设置，因此也就不会占用实例对象的内存空间。</p>
<p>计算属性也支持只读（Read-only），只需要不实现 <code>set</code> 即可，此时也可省略显式的 <code>get</code> 关键字：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-swift" data-lang="swift"><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Foo</span> {
    <span style="color:#66d9ef">var</span> bar: Int = <span style="color:#ae81ff">0</span>

    <span style="color:#66d9ef">var</span> readonlyBaz1: Int {
        <span style="color:#66d9ef">get</span> {
            bar <span style="color:#f92672">*</span> <span style="color:#ae81ff">2</span>
        }
    }

    <span style="color:#66d9ef">var</span> readonlyBaz2: Int {
        bar <span style="color:#f92672">*</span> <span style="color:#ae81ff">2</span>
    }
}

<span style="color:#66d9ef">var</span> foo = Foo()

<span style="color:#75715e">// ERROR: Cannot assign to property: &#39;readonlyBaz1&#39; is a get-only property</span>
foo.readonlyBaz1 = <span style="color:#ae81ff">10</span>
<span style="color:#75715e">// ERROR: Cannot assign to property: &#39;readonlyBaz2&#39; is a get-only property</span>
foo.readonlyBaz2 = <span style="color:#ae81ff">10</span>
</code></pre></div><p>属性（存储属性与计算属性）也支持为 <code>get</code> 和 <code>set</code> 设置不同的访问控制级别：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-swift" data-lang="swift"><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Foo</span> {
    <span style="color:#66d9ef">var</span> bar: Int = <span style="color:#ae81ff">0</span>

    <span style="color:#66d9ef">internal</span> <span style="color:#66d9ef">private</span>(<span style="color:#66d9ef">set</span>) <span style="color:#66d9ef">var</span> privateSetBaz3: Int {
        <span style="color:#66d9ef">get</span> {
            bar <span style="color:#f92672">*</span> <span style="color:#ae81ff">2</span>
        }

        <span style="color:#66d9ef">set</span> {
            bar = newValue <span style="color:#f92672">/</span> <span style="color:#ae81ff">2</span>
        }
    }

    <span style="color:#66d9ef">private</span>(<span style="color:#66d9ef">set</span>) <span style="color:#66d9ef">var</span> privateSetBaz4: Int {
        <span style="color:#66d9ef">get</span> {
            bar <span style="color:#f92672">*</span> <span style="color:#ae81ff">2</span>
        }

        <span style="color:#66d9ef">set</span> {
            bar = newValue <span style="color:#f92672">/</span> <span style="color:#ae81ff">2</span>
        }
    }

    <span style="color:#66d9ef">func</span> <span style="color:#a6e22e">innerFunc</span>() {
        <span style="color:#66d9ef">self</span>.privateSetBaz3 = <span style="color:#ae81ff">10</span>
        <span style="color:#66d9ef">self</span>.privateSetBaz4 = <span style="color:#ae81ff">10</span>
    }
}

<span style="color:#66d9ef">var</span> foo = Foo()

foo.innerFunc()

<span style="color:#75715e">// ERROR: Cannot assign to property: &#39;privateSetBaz3&#39; setter is inaccessible</span>
foo.privateSetBaz3 = <span style="color:#ae81ff">10</span>
<span style="color:#75715e">// ERROR: Cannot assign to property: &#39;privateSetBaz4&#39; setter is inaccessible</span>
foo.privateSetBaz4 = <span style="color:#ae81ff">10</span>
</code></pre></div><p>那么计算属性有何使用场景呢？其实当定义的属性依赖于其它属性时，就可以使用计算属性。枚举中的原始值 <code>rawValue</code> 就是通过只读计算属性实现的：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-swift" data-lang="swift"><span style="color:#66d9ef">enum</span> <span style="color:#a6e22e">Foo</span>: Int {
    <span style="color:#66d9ef">case</span> bar = <span style="color:#ae81ff">0</span>, baz
}

<span style="color:#66d9ef">_</span> = Foo.bar.rawValue <span style="color:#75715e">// 0 // BREAKPOINT 🔴</span>
</code></pre></div><p>尝试运行后在断点处查看汇编：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-asm" data-lang="asm"><span style="color:#a6e22e">demo</span><span style="color:#960050;background-color:#1e0010">`</span><span style="color:#66d9ef">main</span>:
    <span style="color:#960050;background-color:#1e0010">0</span><span style="color:#a6e22e">x100002500</span> <span style="color:#960050;background-color:#1e0010">&lt;+</span><span style="color:#ae81ff">0</span><span style="color:#960050;background-color:#1e0010">&gt;</span>:  <span style="color:#66d9ef">pushq</span>  %rbp
    <span style="color:#960050;background-color:#1e0010">0</span><span style="color:#a6e22e">x100002501</span> <span style="color:#960050;background-color:#1e0010">&lt;+</span><span style="color:#ae81ff">1</span><span style="color:#960050;background-color:#1e0010">&gt;</span>:  <span style="color:#66d9ef">movq</span>   %rsp, %rbp
    <span style="color:#960050;background-color:#1e0010">0</span><span style="color:#a6e22e">x100002504</span> <span style="color:#960050;background-color:#1e0010">&lt;+</span><span style="color:#ae81ff">4</span><span style="color:#960050;background-color:#1e0010">&gt;</span>:  <span style="color:#66d9ef">subq</span>   <span style="color:#66d9ef">$0x20</span>, %rsp
    <span style="color:#960050;background-color:#1e0010">0</span><span style="color:#a6e22e">x100002508</span> <span style="color:#960050;background-color:#1e0010">&lt;+</span><span style="color:#ae81ff">8</span><span style="color:#960050;background-color:#1e0010">&gt;</span>:  <span style="color:#66d9ef">xorl</span>   %eax, %eax
    <span style="color:#960050;background-color:#1e0010">0</span><span style="color:#a6e22e">x10000250a</span> <span style="color:#960050;background-color:#1e0010">&lt;+</span><span style="color:#ae81ff">10</span><span style="color:#960050;background-color:#1e0010">&gt;</span>: <span style="color:#66d9ef">movl</span>   %edi, -<span style="color:#ae81ff">0x4</span>(%rbp)
<span style="color:#960050;background-color:#1e0010">-&gt;</span>  <span style="color:#960050;background-color:#1e0010">0</span><span style="color:#a6e22e">x10000250d</span> <span style="color:#960050;background-color:#1e0010">&lt;+</span><span style="color:#ae81ff">13</span><span style="color:#960050;background-color:#1e0010">&gt;</span>: <span style="color:#66d9ef">movl</span>   %eax, %edi
    <span style="color:#960050;background-color:#1e0010">0</span><span style="color:#a6e22e">x10000250f</span> <span style="color:#960050;background-color:#1e0010">&lt;+</span><span style="color:#ae81ff">15</span><span style="color:#960050;background-color:#1e0010">&gt;</span>: <span style="color:#66d9ef">movq</span>   %rsi, -<span style="color:#ae81ff">0x10</span>(%rbp)
    <span style="color:#75715e">; 将调用计算属性的 getter
</span><span style="color:#75715e"></span>    <span style="color:#960050;background-color:#1e0010">0</span><span style="color:#a6e22e">x100002513</span> <span style="color:#960050;background-color:#1e0010">&lt;+</span><span style="color:#ae81ff">19</span><span style="color:#960050;background-color:#1e0010">&gt;</span>: <span style="color:#66d9ef">callq</span>  <span style="color:#ae81ff">0x1000025a0</span>               <span style="color:#75715e">; demo.Foo.rawValue.getter : Swift.Int at &lt;compiler-generated&gt;
</span><span style="color:#75715e"></span>    <span style="color:#ae81ff">0x100002518</span> <span style="color:#960050;background-color:#1e0010">&lt;+</span><span style="color:#ae81ff">24</span><span style="color:#960050;background-color:#1e0010">&gt;</span>: <span style="color:#66d9ef">xorl</span>   %ecx, %ecx
    <span style="color:#960050;background-color:#1e0010">0</span><span style="color:#a6e22e">x10000251a</span> <span style="color:#960050;background-color:#1e0010">&lt;+</span><span style="color:#ae81ff">26</span><span style="color:#960050;background-color:#1e0010">&gt;</span>: <span style="color:#66d9ef">movq</span>   %rax, -<span style="color:#ae81ff">0x18</span>(%rbp)
    <span style="color:#960050;background-color:#1e0010">0</span><span style="color:#a6e22e">x10000251e</span> <span style="color:#960050;background-color:#1e0010">&lt;+</span><span style="color:#ae81ff">30</span><span style="color:#960050;background-color:#1e0010">&gt;</span>: <span style="color:#66d9ef">movl</span>   %ecx, %eax
    <span style="color:#960050;background-color:#1e0010">0</span><span style="color:#a6e22e">x100002520</span> <span style="color:#960050;background-color:#1e0010">&lt;+</span><span style="color:#ae81ff">32</span><span style="color:#960050;background-color:#1e0010">&gt;</span>: <span style="color:#66d9ef">addq</span>   <span style="color:#66d9ef">$0x20</span>, %rsp
    <span style="color:#960050;background-color:#1e0010">0</span><span style="color:#a6e22e">x100002524</span> <span style="color:#960050;background-color:#1e0010">&lt;+</span><span style="color:#ae81ff">36</span><span style="color:#960050;background-color:#1e0010">&gt;</span>: <span style="color:#66d9ef">popq</span>   %rbp
    <span style="color:#960050;background-color:#1e0010">0</span><span style="color:#a6e22e">x100002525</span> <span style="color:#960050;background-color:#1e0010">&lt;+</span><span style="color:#ae81ff">37</span><span style="color:#960050;background-color:#1e0010">&gt;</span>: <span style="color:#66d9ef">retq</span>
</code></pre></div><h2 id="延迟存储属性">延迟存储属性</h2>
<p>延迟存储属性是指该属性的初始化过程将延迟到首次使用时，而非跟随实例的创建而创建。当该类属性未被使用时，将避免消耗不必要的性能。延迟存储属性使用 <code>lazy</code> 关键字修饰：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-swift" data-lang="swift"><span style="color:#66d9ef">struct</span> <span style="color:#a6e22e">Foo</span> {
    <span style="color:#66d9ef">lazy</span> <span style="color:#66d9ef">var</span> bar: Int = {
        print(<span style="color:#e6db74">&#34;bar will init&#34;</span>)

        <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">1</span>
    }()

    <span style="color:#66d9ef">var</span> baz: Int = {
        print(<span style="color:#e6db74">&#34;baz will init&#34;</span>)

        <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">1</span>
    }()
}

<span style="color:#66d9ef">_</span> = Foo()

<span style="color:#75715e">// baz will init</span>
</code></pre></div><p>如上，当构造 <code>Foo</code> 实例对象时，延迟存储属性将暂时不初始化。另外，延迟存储属性需要有几个注意点：首先，延迟存储属性必须使用 <code>var</code> 修饰，而不可使用 <code>let</code> 修饰。这是因为 <code>let</code> 常量一旦创建后就不再改变，而延迟存储属性会在使用时再初始化将与此相悖；其次，结构体类型中若存在延迟存储属性，那么使用 <code>let</code> 声明的结构体常量将无法访问延迟存储属性，原因其实同理，在首次访问时将执行延迟存储属性的初始化，将会导致常量内存空间改变，也与常量本身相悖；但 <code>class</code> 类型的变量由于本质是引用类型，即使堆空间的内存空间改变，也不会导致指针指向的内存空间地址改变，因此 <code>class</code> 类型的常量仍可以访问延迟存储属性：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-swift" data-lang="swift"><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">FooClass</span> {
    <span style="color:#66d9ef">lazy</span> <span style="color:#66d9ef">var</span> a = <span style="color:#ae81ff">1</span>
}

<span style="color:#66d9ef">struct</span> <span style="color:#a6e22e">FooStruct</span> {
    <span style="color:#66d9ef">lazy</span> <span style="color:#66d9ef">var</span> a = <span style="color:#ae81ff">1</span>
}

<span style="color:#66d9ef">let</span> fc = FooClass()
print(fc.a)

<span style="color:#66d9ef">let</span> fs = FooStruct()
<span style="color:#75715e">// ERROR: Cannot use mutating getter on immutable value: &#39;fs&#39; is a &#39;let&#39; constant</span>
print(fs.a)
</code></pre></div><p>还需要注意的是，延迟存储属性是线程<strong>不</strong>安全的，即有可能在多线程中被多次初始化：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-swift" data-lang="swift"><span style="color:#66d9ef">import</span> <span style="color:#a6e22e">Foundation</span>

<span style="color:#66d9ef">struct</span> <span style="color:#a6e22e">Foo</span> {
    <span style="color:#66d9ef">lazy</span> <span style="color:#66d9ef">var</span> bar: Int = {
        print(<span style="color:#e6db74">&#34;bar will init&#34;</span>)

        <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">1</span>
    }()

     <span style="color:#66d9ef">var</span> baz: Int = {
        print(<span style="color:#e6db74">&#34;baz will init&#34;</span>)

        <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">1</span>
    }()
}

<span style="color:#66d9ef">var</span> foo = Foo()

<span style="color:#66d9ef">var</span> array = [Int]()

DispatchQueue.concurrentPerform(iterations: <span style="color:#ae81ff">3</span>) { <span style="color:#66d9ef">_</span> <span style="color:#66d9ef">in</span>
    print(<span style="color:#e6db74">&#34;--- </span><span style="color:#e6db74">\(</span>Thread.current<span style="color:#e6db74">)</span><span style="color:#e6db74"> ---&#34;</span>)
    print(foo.bar)
}

<span style="color:#75715e">// baz will init</span>
<span style="color:#75715e">// --- &lt;NSThread: 0x100611a40&gt;{number = 3, name = (null)} ---</span>
<span style="color:#75715e">// --- &lt;NSThread: 0x1029197f0&gt;{number = 2, name = (null)} ---</span>
<span style="color:#75715e">// --- &lt;NSThread: 0x10050c580&gt;{number = 1, name = main} ---</span>
<span style="color:#75715e">// bar will init</span>
<span style="color:#75715e">// bar will init</span>
<span style="color:#75715e">// 1</span>
<span style="color:#75715e">// 1</span>
<span style="color:#75715e">// bar will init</span>
<span style="color:#75715e">// 1</span>
</code></pre></div><p>如上，我们使用 GCD 的并发执行 API <code>concurrentPerform</code> 执行三次，如果延迟存储属性是线程安全的，那么将只会进入其构造方法一次，但此时其实输出了三句 <code>bar will init</code>。</p>
<blockquote>
<p><strong><code>lazy</code> 方法</strong></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-swift" data-lang="swift"><span style="color:#66d9ef">let</span> doubled = (<span style="color:#ae81ff">0.</span>.&lt;<span style="color:#ae81ff">3</span>).map { i -&gt; Int <span style="color:#66d9ef">in</span>
    print(<span style="color:#e6db74">&#34;mapping&#34;</span>)
    <span style="color:#66d9ef">return</span> i <span style="color:#f92672">*</span> <span style="color:#ae81ff">2</span>
}

<span style="color:#66d9ef">let</span> lazyDoubled = (<span style="color:#ae81ff">0.</span>.&lt;<span style="color:#ae81ff">3</span>).<span style="color:#66d9ef">lazy</span>.map { i -&gt; Int <span style="color:#66d9ef">in</span>
    print(<span style="color:#e6db74">&#34;lazy mapping&#34;</span>)
    <span style="color:#66d9ef">return</span> i <span style="color:#f92672">*</span> <span style="color:#ae81ff">2</span>
}

<span style="color:#75715e">// mapping</span>
<span style="color:#75715e">// mapping</span>
<span style="color:#75715e">// mapping</span>

lazyDoubled.forEach {
    print($0)
}

<span style="color:#75715e">// lazy mapping</span>
<span style="color:#75715e">// 0</span>
<span style="color:#75715e">// lazy mapping</span>
<span style="color:#75715e">// 2</span>
<span style="color:#75715e">// lazy mapping</span>
<span style="color:#75715e">// 4</span>
</code></pre></div><p>在 Swift 标准库中也有一些内置的 <code>lazy</code> 方法，它们的执行时机也将推迟到实际使用该方法的返回值时。</p>
</blockquote>
<h2 id="属性观察器">属性观察器</h2>
<p>在 Swift 中，我们还可以对非延迟存储属性添加属性观察器，以便在值发生改变之前和之后进行一些操作：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-swift" data-lang="swift"><span style="color:#66d9ef">struct</span> <span style="color:#a6e22e">Foo</span> {
    <span style="color:#66d9ef">var</span> bar: Int {
        <span style="color:#66d9ef">willSet</span> {
            print(<span style="color:#e6db74">&#34;</span><span style="color:#e6db74">\(</span>bar<span style="color:#e6db74">)</span><span style="color:#e6db74"> will set to </span><span style="color:#e6db74">\(</span>newValue<span style="color:#e6db74">)</span><span style="color:#e6db74">&#34;</span>)
        }

        <span style="color:#66d9ef">didSet</span> {
            print(<span style="color:#e6db74">&#34;</span><span style="color:#e6db74">\(</span>oldValue<span style="color:#e6db74">)</span><span style="color:#e6db74"> did set to </span><span style="color:#e6db74">\(</span>bar<span style="color:#e6db74">)</span><span style="color:#e6db74">&#34;</span>)
        }
    }

    <span style="color:#66d9ef">var</span> customValueParamsBar: Int = <span style="color:#ae81ff">0</span> {
        <span style="color:#66d9ef">willSet</span>(new) {
            print(<span style="color:#e6db74">&#34;</span><span style="color:#e6db74">\(</span>customValueParamsBar<span style="color:#e6db74">)</span><span style="color:#e6db74"> will set </span><span style="color:#e6db74">\(</span>new<span style="color:#e6db74">)</span><span style="color:#e6db74">&#34;</span>)
        }

        <span style="color:#66d9ef">didSet</span>(old) {
            print(<span style="color:#e6db74">&#34;</span><span style="color:#e6db74">\(</span>old<span style="color:#e6db74">)</span><span style="color:#e6db74"> did set to </span><span style="color:#e6db74">\(</span>customValueParamsBar<span style="color:#e6db74">)</span><span style="color:#e6db74">&#34;</span>)
        }
    }
}

<span style="color:#66d9ef">var</span> foo = Foo(bar: <span style="color:#ae81ff">10</span>)
foo.bar = <span style="color:#ae81ff">20</span> <span style="color:#75715e">// BREAKPOINT 🔴</span>

<span style="color:#75715e">// 10 will set to 20</span>
<span style="color:#75715e">// 10 did set to 20</span>
</code></pre></div><p>如上，在值被真正改变之前，将先通过 <code>willSet</code> 方法，新值将默认可以通过 <code>newValue</code> 变量访问，此时因为并为执行赋值，因此旧值即可通过变量本身 <code>bar</code> 访问；设置后同理可通过 <code>didSet</code> 方法，此时旧值将默认可以通过 <code>oldValue</code> 变量访问，新值则可直接通过变量本身 <code>bar</code> 访问。</p>
<p>尝试运行后在断点处查看汇编：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-asm" data-lang="asm"><span style="color:#960050;background-color:#1e0010">-&gt;</span>  <span style="color:#960050;background-color:#1e0010">0</span><span style="color:#a6e22e">x100001c2e</span> <span style="color:#960050;background-color:#1e0010">&lt;+</span><span style="color:#ae81ff">62</span><span style="color:#960050;background-color:#1e0010">&gt;</span>:  <span style="color:#66d9ef">movq</span>   %rcx, %rdi
    <span style="color:#960050;background-color:#1e0010">0</span><span style="color:#a6e22e">x100001c31</span> <span style="color:#960050;background-color:#1e0010">&lt;+</span><span style="color:#ae81ff">65</span><span style="color:#960050;background-color:#1e0010">&gt;</span>:  <span style="color:#66d9ef">leaq</span>   -<span style="color:#ae81ff">0x20</span>(%rbp), %rax
    <span style="color:#960050;background-color:#1e0010">0</span><span style="color:#a6e22e">x100001c35</span> <span style="color:#960050;background-color:#1e0010">&lt;+</span><span style="color:#ae81ff">69</span><span style="color:#960050;background-color:#1e0010">&gt;</span>:  <span style="color:#66d9ef">movq</span>   %rsi, -<span style="color:#ae81ff">0x38</span>(%rbp)
    <span style="color:#960050;background-color:#1e0010">0</span><span style="color:#a6e22e">x100001c39</span> <span style="color:#960050;background-color:#1e0010">&lt;+</span><span style="color:#ae81ff">73</span><span style="color:#960050;background-color:#1e0010">&gt;</span>:  <span style="color:#66d9ef">movq</span>   %rax, %rsi
    <span style="color:#960050;background-color:#1e0010">0</span><span style="color:#a6e22e">x100001c3c</span> <span style="color:#960050;background-color:#1e0010">&lt;+</span><span style="color:#ae81ff">76</span><span style="color:#960050;background-color:#1e0010">&gt;</span>:  <span style="color:#66d9ef">movl</span>   <span style="color:#66d9ef">$0x21</span>, %edx
    <span style="color:#960050;background-color:#1e0010">0</span><span style="color:#a6e22e">x100001c41</span> <span style="color:#960050;background-color:#1e0010">&lt;+</span><span style="color:#ae81ff">81</span><span style="color:#960050;background-color:#1e0010">&gt;</span>:  <span style="color:#66d9ef">movq</span>   -<span style="color:#ae81ff">0x38</span>(%rbp), %rcx
    <span style="color:#960050;background-color:#1e0010">0</span><span style="color:#a6e22e">x100001c45</span> <span style="color:#960050;background-color:#1e0010">&lt;+</span><span style="color:#ae81ff">85</span><span style="color:#960050;background-color:#1e0010">&gt;</span>:  <span style="color:#66d9ef">callq</span>  <span style="color:#ae81ff">0x100003bc0</span>               <span style="color:#75715e">; symbol stub for: swift_beginAccess
</span><span style="color:#75715e"></span>    <span style="color:#ae81ff">0x100001c4a</span> <span style="color:#960050;background-color:#1e0010">&lt;+</span><span style="color:#ae81ff">90</span><span style="color:#960050;background-color:#1e0010">&gt;</span>:  <span style="color:#66d9ef">movl</span>   <span style="color:#66d9ef">$0x14</span>, %edi
    <span style="color:#960050;background-color:#1e0010">0</span><span style="color:#a6e22e">x100001c4f</span> <span style="color:#960050;background-color:#1e0010">&lt;+</span><span style="color:#ae81ff">95</span><span style="color:#960050;background-color:#1e0010">&gt;</span>:  <span style="color:#66d9ef">leaq</span>   <span style="color:#ae81ff">0x655a</span>(%rip), %r13        <span style="color:#75715e">; demo.foo : demo.Foo
</span><span style="color:#75715e"></span>    <span style="color:#75715e">; 将调用 setter
</span><span style="color:#75715e"></span>    <span style="color:#ae81ff">0x100001c56</span> <span style="color:#960050;background-color:#1e0010">&lt;+</span><span style="color:#ae81ff">102</span><span style="color:#960050;background-color:#1e0010">&gt;</span>: <span style="color:#66d9ef">callq</span>  <span style="color:#ae81ff">0x100001cb0</span>               <span style="color:#75715e">; demo.Foo.bar.setter : Swift.Int at main.swift:4
</span><span style="color:#75715e"></span>    <span style="color:#ae81ff">0x100001c5b</span> <span style="color:#960050;background-color:#1e0010">&lt;+</span><span style="color:#ae81ff">107</span><span style="color:#960050;background-color:#1e0010">&gt;</span>: <span style="color:#66d9ef">leaq</span>   -<span style="color:#ae81ff">0x20</span>(%rbp), %rdi
    <span style="color:#960050;background-color:#1e0010">0</span><span style="color:#a6e22e">x100001c5f</span> <span style="color:#960050;background-color:#1e0010">&lt;+</span><span style="color:#ae81ff">111</span><span style="color:#960050;background-color:#1e0010">&gt;</span>: <span style="color:#66d9ef">callq</span>  <span style="color:#ae81ff">0x100003bd2</span>               <span style="color:#75715e">; symbol stub for: swift_endAccess
</span><span style="color:#75715e"></span>
<span style="color:#a6e22e">demo</span><span style="color:#960050;background-color:#1e0010">`</span><span style="color:#66d9ef">Foo.bar.setter</span>:
<span style="color:#960050;background-color:#1e0010">-&gt;</span>  <span style="color:#960050;background-color:#1e0010">0</span><span style="color:#a6e22e">x100001cb0</span> <span style="color:#960050;background-color:#1e0010">&lt;+</span><span style="color:#ae81ff">0</span><span style="color:#960050;background-color:#1e0010">&gt;</span>:  <span style="color:#66d9ef">pushq</span>  %rbp
    <span style="color:#960050;background-color:#1e0010">0</span><span style="color:#a6e22e">x100001cb1</span> <span style="color:#960050;background-color:#1e0010">&lt;+</span><span style="color:#ae81ff">1</span><span style="color:#960050;background-color:#1e0010">&gt;</span>:  <span style="color:#66d9ef">movq</span>   %rsp, %rbp
    <span style="color:#960050;background-color:#1e0010">0</span><span style="color:#a6e22e">x100001cb4</span> <span style="color:#960050;background-color:#1e0010">&lt;+</span><span style="color:#ae81ff">4</span><span style="color:#960050;background-color:#1e0010">&gt;</span>:  <span style="color:#66d9ef">pushq</span>  %r13
    <span style="color:#960050;background-color:#1e0010">0</span><span style="color:#a6e22e">x100001cb6</span> <span style="color:#960050;background-color:#1e0010">&lt;+</span><span style="color:#ae81ff">6</span><span style="color:#960050;background-color:#1e0010">&gt;</span>:  <span style="color:#66d9ef">subq</span>   <span style="color:#66d9ef">$0x38</span>, %rsp
    <span style="color:#960050;background-color:#1e0010">0</span><span style="color:#a6e22e">x100001cba</span> <span style="color:#960050;background-color:#1e0010">&lt;+</span><span style="color:#ae81ff">10</span><span style="color:#960050;background-color:#1e0010">&gt;</span>: <span style="color:#66d9ef">movq</span>   <span style="color:#66d9ef">$0x0</span>, -<span style="color:#ae81ff">0x10</span>(%rbp)
    <span style="color:#960050;background-color:#1e0010">0</span><span style="color:#a6e22e">x100001cc2</span> <span style="color:#960050;background-color:#1e0010">&lt;+</span><span style="color:#ae81ff">18</span><span style="color:#960050;background-color:#1e0010">&gt;</span>: <span style="color:#66d9ef">movq</span>   <span style="color:#66d9ef">$0x0</span>, -<span style="color:#ae81ff">0x18</span>(%rbp)
    <span style="color:#960050;background-color:#1e0010">0</span><span style="color:#a6e22e">x100001cca</span> <span style="color:#960050;background-color:#1e0010">&lt;+</span><span style="color:#ae81ff">26</span><span style="color:#960050;background-color:#1e0010">&gt;</span>: <span style="color:#66d9ef">movq</span>   <span style="color:#66d9ef">$0x0</span>, -<span style="color:#ae81ff">0x20</span>(%rbp)
    <span style="color:#960050;background-color:#1e0010">0</span><span style="color:#a6e22e">x100001cd2</span> <span style="color:#960050;background-color:#1e0010">&lt;+</span><span style="color:#ae81ff">34</span><span style="color:#960050;background-color:#1e0010">&gt;</span>: <span style="color:#66d9ef">movq</span>   %rdi, -<span style="color:#ae81ff">0x10</span>(%rbp)
    <span style="color:#960050;background-color:#1e0010">0</span><span style="color:#a6e22e">x100001cd6</span> <span style="color:#960050;background-color:#1e0010">&lt;+</span><span style="color:#ae81ff">38</span><span style="color:#960050;background-color:#1e0010">&gt;</span>: <span style="color:#66d9ef">movq</span>   %r13, -<span style="color:#ae81ff">0x18</span>(%rbp)
    <span style="color:#960050;background-color:#1e0010">0</span><span style="color:#a6e22e">x100001cda</span> <span style="color:#960050;background-color:#1e0010">&lt;+</span><span style="color:#ae81ff">42</span><span style="color:#960050;background-color:#1e0010">&gt;</span>: <span style="color:#66d9ef">movq</span>   (%r13), %rax
    <span style="color:#960050;background-color:#1e0010">0</span><span style="color:#a6e22e">x100001cde</span> <span style="color:#960050;background-color:#1e0010">&lt;+</span><span style="color:#ae81ff">46</span><span style="color:#960050;background-color:#1e0010">&gt;</span>: <span style="color:#66d9ef">movq</span>   %rax, -<span style="color:#ae81ff">0x20</span>(%rbp)
    <span style="color:#960050;background-color:#1e0010">0</span><span style="color:#a6e22e">x100001ce2</span> <span style="color:#960050;background-color:#1e0010">&lt;+</span><span style="color:#ae81ff">50</span><span style="color:#960050;background-color:#1e0010">&gt;</span>: <span style="color:#66d9ef">movq</span>   %rdi, -<span style="color:#ae81ff">0x28</span>(%rbp)
    <span style="color:#960050;background-color:#1e0010">0</span><span style="color:#a6e22e">x100001ce6</span> <span style="color:#960050;background-color:#1e0010">&lt;+</span><span style="color:#ae81ff">54</span><span style="color:#960050;background-color:#1e0010">&gt;</span>: <span style="color:#66d9ef">movq</span>   %r13, -<span style="color:#ae81ff">0x30</span>(%rbp)
    <span style="color:#960050;background-color:#1e0010">0</span><span style="color:#a6e22e">x100001cea</span> <span style="color:#960050;background-color:#1e0010">&lt;+</span><span style="color:#ae81ff">58</span><span style="color:#960050;background-color:#1e0010">&gt;</span>: <span style="color:#66d9ef">movq</span>   %rax, -<span style="color:#ae81ff">0x38</span>(%rbp)
    <span style="color:#75715e">; 将调用 willset
</span><span style="color:#75715e"></span>    <span style="color:#960050;background-color:#1e0010">0</span><span style="color:#a6e22e">x100001cee</span> <span style="color:#960050;background-color:#1e0010">&lt;+</span><span style="color:#ae81ff">62</span><span style="color:#960050;background-color:#1e0010">&gt;</span>: <span style="color:#66d9ef">callq</span>  <span style="color:#ae81ff">0x100001d20</span>               <span style="color:#75715e">; demo.Foo.bar.willset : Swift.Int at main.swift:5
</span><span style="color:#75715e"></span>    <span style="color:#ae81ff">0x100001cf3</span> <span style="color:#960050;background-color:#1e0010">&lt;+</span><span style="color:#ae81ff">67</span><span style="color:#960050;background-color:#1e0010">&gt;</span>: <span style="color:#66d9ef">movq</span>   -<span style="color:#ae81ff">0x30</span>(%rbp), %rax
    <span style="color:#960050;background-color:#1e0010">0</span><span style="color:#a6e22e">x100001cf7</span> <span style="color:#960050;background-color:#1e0010">&lt;+</span><span style="color:#ae81ff">71</span><span style="color:#960050;background-color:#1e0010">&gt;</span>: <span style="color:#66d9ef">movq</span>   -<span style="color:#ae81ff">0x28</span>(%rbp), %rcx
    <span style="color:#960050;background-color:#1e0010">0</span><span style="color:#a6e22e">x100001cfb</span> <span style="color:#960050;background-color:#1e0010">&lt;+</span><span style="color:#ae81ff">75</span><span style="color:#960050;background-color:#1e0010">&gt;</span>: <span style="color:#66d9ef">movq</span>   %rcx, (%rax)
    <span style="color:#960050;background-color:#1e0010">0</span><span style="color:#a6e22e">x100001cfe</span> <span style="color:#960050;background-color:#1e0010">&lt;+</span><span style="color:#ae81ff">78</span><span style="color:#960050;background-color:#1e0010">&gt;</span>: <span style="color:#66d9ef">movq</span>   -<span style="color:#ae81ff">0x38</span>(%rbp), %rdi
    <span style="color:#960050;background-color:#1e0010">0</span><span style="color:#a6e22e">x100001d02</span> <span style="color:#960050;background-color:#1e0010">&lt;+</span><span style="color:#ae81ff">82</span><span style="color:#960050;background-color:#1e0010">&gt;</span>: <span style="color:#66d9ef">movq</span>   %rax, %r13
    <span style="color:#75715e">; 将调用 didset
</span><span style="color:#75715e"></span>    <span style="color:#960050;background-color:#1e0010">0</span><span style="color:#a6e22e">x100001d05</span> <span style="color:#960050;background-color:#1e0010">&lt;+</span><span style="color:#ae81ff">85</span><span style="color:#960050;background-color:#1e0010">&gt;</span>: <span style="color:#66d9ef">callq</span>  <span style="color:#ae81ff">0x100001fd0</span>               <span style="color:#75715e">; demo.Foo.bar.didset : Swift.Int at main.swift:9
</span><span style="color:#75715e"></span>    <span style="color:#ae81ff">0x100001d0a</span> <span style="color:#960050;background-color:#1e0010">&lt;+</span><span style="color:#ae81ff">90</span><span style="color:#960050;background-color:#1e0010">&gt;</span>: <span style="color:#66d9ef">addq</span>   <span style="color:#66d9ef">$0x38</span>, %rsp
    <span style="color:#960050;background-color:#1e0010">0</span><span style="color:#a6e22e">x100001d0e</span> <span style="color:#960050;background-color:#1e0010">&lt;+</span><span style="color:#ae81ff">94</span><span style="color:#960050;background-color:#1e0010">&gt;</span>: <span style="color:#66d9ef">popq</span>   %r13
    <span style="color:#960050;background-color:#1e0010">0</span><span style="color:#a6e22e">x100001d10</span> <span style="color:#960050;background-color:#1e0010">&lt;+</span><span style="color:#ae81ff">96</span><span style="color:#960050;background-color:#1e0010">&gt;</span>: <span style="color:#66d9ef">popq</span>   %rbp
    <span style="color:#960050;background-color:#1e0010">0</span><span style="color:#a6e22e">x100001d11</span> <span style="color:#960050;background-color:#1e0010">&lt;+</span><span style="color:#ae81ff">97</span><span style="color:#960050;background-color:#1e0010">&gt;</span>: <span style="color:#66d9ef">retq</span>
</code></pre></div><p>此时可以发现，即使我们改变的变量本质是存储属性，但编译器仍然为其生成了 <code>setter</code> 方法，并在该行执行 <code>si</code> 进入后，即 <code>setter</code> 方法中先调用了 <code>willSet</code>，并在随后调用了 <code>didSet</code>。</p>
<p>另外需要注意的是，初始化方法或在属性定义时给予的默认值时，将不会触发属性观察器；另外，在 <code>willSet</code> 中如果继续编写更改原有变量值的代码时，既不会再次触发属性观察器，但更改也不会生效，但在 <code>didSet</code> 中，虽然也不会再次触发属性观察器，但更改将会生效：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-swift" data-lang="swift"><span style="color:#66d9ef">struct</span> <span style="color:#a6e22e">Foo</span> {
    <span style="color:#66d9ef">var</span> bar: Int {
        <span style="color:#66d9ef">willSet</span> {
            <span style="color:#75715e">// WARNING: Attempting to store to property &#39;bar&#39; within its own willSet, which is about to be overwritten by the new value</span>
            bar = <span style="color:#ae81ff">1000</span>
            print(<span style="color:#e6db74">&#34;</span><span style="color:#e6db74">\(</span>bar<span style="color:#e6db74">)</span><span style="color:#e6db74"> will set to </span><span style="color:#e6db74">\(</span>newValue<span style="color:#e6db74">)</span><span style="color:#e6db74">&#34;</span>)
        }

        <span style="color:#66d9ef">didSet</span> {
            bar = <span style="color:#ae81ff">2000</span>
            print(<span style="color:#e6db74">&#34;</span><span style="color:#e6db74">\(</span>oldValue<span style="color:#e6db74">)</span><span style="color:#e6db74"> did set to </span><span style="color:#e6db74">\(</span>bar<span style="color:#e6db74">)</span><span style="color:#e6db74">&#34;</span>)
            bar = <span style="color:#ae81ff">3000</span>
        }
    }
}

<span style="color:#66d9ef">var</span> foo = Foo(bar: <span style="color:#ae81ff">10</span>)
foo.bar = <span style="color:#ae81ff">20</span>

print(foo.bar)

<span style="color:#75715e">// 10 will set to 20</span>
<span style="color:#75715e">// 10 did set to 2000</span>
<span style="color:#75715e">// 3000</span>
</code></pre></div><p>虽然我们了解了这一行为，但在属性观察器中再次执行赋值操作本身就有些诡异，因此应当避免。</p>
<h2 id="计算属性属性观察器与-inout">计算属性、属性观察器与 inout</h2>
<p>在上面的示例中，我们通常直接通过实例对象对变量本身进行了更改，并触发了属性观察器，那么如果我们将它们传递给含有 <code>inout</code> 参数的方法并进行更改时，还会调用相应的 <code>willSet</code> 和 <code>didSet</code> 方法吗？</p>
<p>首先我们创建一个名为 <code>Foo</code> 的结构体类型，其中包含普通的存储属性、带有属性观察器的属性、和计算属性，并创建名为 <code>inoutFunc(_:)</code> 带有 <code>inout</code> 类型作为参数的方法：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-swift" data-lang="swift"><span style="color:#66d9ef">struct</span> <span style="color:#a6e22e">Foo</span>: CustomStringConvertible {
    <span style="color:#66d9ef">var</span> a = <span style="color:#ae81ff">1</span>

    <span style="color:#66d9ef">var</span> b = <span style="color:#ae81ff">1</span> {
        <span style="color:#66d9ef">willSet</span> {
            print(<span style="color:#e6db74">&#34;b(</span><span style="color:#e6db74">\(</span>b<span style="color:#e6db74">)</span><span style="color:#e6db74">) will set to </span><span style="color:#e6db74">\(</span>newValue<span style="color:#e6db74">)</span><span style="color:#e6db74">&#34;</span>)
        }

        <span style="color:#66d9ef">didSet</span> {
            print(<span style="color:#e6db74">&#34;b(</span><span style="color:#e6db74">\(</span>oldValue<span style="color:#e6db74">)</span><span style="color:#e6db74">) did set to </span><span style="color:#e6db74">\(</span>b<span style="color:#e6db74">)</span><span style="color:#e6db74">&#34;</span>)
        }
    }

    <span style="color:#66d9ef">var</span> c: Int {
        <span style="color:#66d9ef">get</span> {
            print(<span style="color:#e6db74">&#34;c get&#34;</span>)
            <span style="color:#66d9ef">return</span> a <span style="color:#f92672">*</span> <span style="color:#ae81ff">10</span>
        }

        <span style="color:#66d9ef">set</span> {
            print(<span style="color:#e6db74">&#34;c set&#34;</span>)
            a = newValue <span style="color:#f92672">/</span> <span style="color:#ae81ff">10</span>
        }
    }

    <span style="color:#66d9ef">var</span> description: String {
        <span style="color:#e6db74">&#34;a: </span><span style="color:#e6db74">\(</span>a<span style="color:#e6db74">)</span><span style="color:#e6db74">, b: </span><span style="color:#e6db74">\(</span>b<span style="color:#e6db74">)</span><span style="color:#e6db74">, c: </span><span style="color:#e6db74">\(</span>c<span style="color:#e6db74">)</span><span style="color:#e6db74">&#34;</span>
    }
}

<span style="color:#66d9ef">func</span> <span style="color:#a6e22e">inoutFunc</span>(<span style="color:#66d9ef">_</span> param: <span style="color:#66d9ef">inout</span> Int) {
    param = <span style="color:#ae81ff">100</span>
}

<span style="color:#66d9ef">var</span> foo = Foo()

print(foo)

<span style="color:#75715e">// c get</span>
<span style="color:#75715e">// a: 1, b: 1, c: 10</span>
</code></pre></div><p>首先我们尝试将不带属性观察器的变量传递到 <code>inoutFunc</code> 中：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-swift" data-lang="swift">inoutFunc(&amp;foo.a) <span style="color:#75715e">// BREAKPOINT 🔴</span>

print(foo)

<span style="color:#75715e">// c get</span>
<span style="color:#75715e">// a: 100, b: 1, c: 1000</span>
</code></pre></div><p>尝试运行后在断点处查看汇编：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-asm" data-lang="asm"><span style="color:#960050;background-color:#1e0010">-&gt;</span>  <span style="color:#960050;background-color:#1e0010">0</span><span style="color:#a6e22e">x100001958</span> <span style="color:#960050;background-color:#1e0010">&lt;+</span><span style="color:#ae81ff">296</span><span style="color:#960050;background-color:#1e0010">&gt;</span>: <span style="color:#66d9ef">movq</span>   %rax, %rdi
    <span style="color:#960050;background-color:#1e0010">0</span><span style="color:#a6e22e">x10000195b</span> <span style="color:#960050;background-color:#1e0010">&lt;+</span><span style="color:#ae81ff">299</span><span style="color:#960050;background-color:#1e0010">&gt;</span>: <span style="color:#66d9ef">leaq</span>   -<span style="color:#ae81ff">0x30</span>(%rbp), %rsi
    <span style="color:#960050;background-color:#1e0010">0</span><span style="color:#a6e22e">x10000195f</span> <span style="color:#960050;background-color:#1e0010">&lt;+</span><span style="color:#ae81ff">303</span><span style="color:#960050;background-color:#1e0010">&gt;</span>: <span style="color:#66d9ef">movl</span>   <span style="color:#66d9ef">$0x21</span>, %edx
    <span style="color:#960050;background-color:#1e0010">0</span><span style="color:#a6e22e">x100001964</span> <span style="color:#960050;background-color:#1e0010">&lt;+</span><span style="color:#ae81ff">308</span><span style="color:#960050;background-color:#1e0010">&gt;</span>: <span style="color:#66d9ef">callq</span>  <span style="color:#ae81ff">0x100003a3c</span>               <span style="color:#75715e">; symbol stub for: swift_beginAccess
</span><span style="color:#75715e"></span>    <span style="color:#75715e">; 将 rip 寄存器中的地址值加上 0x6850（根据注释，该地址对应的内容为 demo.foo）并存储到 rdi 寄存器（函数第一个参数）中
</span><span style="color:#75715e"></span>    <span style="color:#ae81ff">0x100001969</span> <span style="color:#960050;background-color:#1e0010">&lt;+</span><span style="color:#ae81ff">313</span><span style="color:#960050;background-color:#1e0010">&gt;</span>: <span style="color:#66d9ef">leaq</span>   <span style="color:#ae81ff">0x6850</span>(%rip), %rdi        <span style="color:#75715e">; demo.foo : demo.Foo
</span><span style="color:#75715e"></span>    <span style="color:#ae81ff">0x100001970</span> <span style="color:#960050;background-color:#1e0010">&lt;+</span><span style="color:#ae81ff">320</span><span style="color:#960050;background-color:#1e0010">&gt;</span>: <span style="color:#66d9ef">callq</span>  <span style="color:#ae81ff">0x1000026f0</span>               <span style="color:#75715e">; demo.inoutFunc(inout Swift.Int) -&gt; () at main.swift:33
</span></code></pre></div><p>由于结构体变量的首地址就等同于其中第一个声明的变量的地址，因此此时存储属性即按地址传递到 <code>inout</code> 修饰参数的方法中。那么带有属性观察器的存储属性呢？</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-swift" data-lang="swift"><span style="color:#75715e">// inoutFunc(&amp;foo.a)</span>

inoutFunc(&amp;foo.b) <span style="color:#75715e">// BREAKPOINT 🔴</span>

print(foo)

<span style="color:#75715e">// b(1) will set to 100</span>
<span style="color:#75715e">// b(1) did set to 100</span>
<span style="color:#75715e">// c get</span>
<span style="color:#75715e">// a: 1, b: 100, c: 10</span>
</code></pre></div><p>通过输出结果，我们可以看出属性观察器同样也被执行了。尝试运行后在断点处查看汇编：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-asm" data-lang="asm"><span style="color:#960050;background-color:#1e0010">-&gt;</span>  <span style="color:#960050;background-color:#1e0010">0</span><span style="color:#a6e22e">x100001942</span> <span style="color:#960050;background-color:#1e0010">&lt;+</span><span style="color:#ae81ff">50</span><span style="color:#960050;background-color:#1e0010">&gt;</span>:  <span style="color:#66d9ef">movq</span>   %rcx, %rdi
    <span style="color:#960050;background-color:#1e0010">0</span><span style="color:#a6e22e">x100001945</span> <span style="color:#960050;background-color:#1e0010">&lt;+</span><span style="color:#ae81ff">53</span><span style="color:#960050;background-color:#1e0010">&gt;</span>:  <span style="color:#66d9ef">leaq</span>   -<span style="color:#ae81ff">0x20</span>(%rbp), %rax
    <span style="color:#960050;background-color:#1e0010">0</span><span style="color:#a6e22e">x100001949</span> <span style="color:#960050;background-color:#1e0010">&lt;+</span><span style="color:#ae81ff">57</span><span style="color:#960050;background-color:#1e0010">&gt;</span>:  <span style="color:#66d9ef">movq</span>   %rsi, -<span style="color:#ae81ff">0x58</span>(%rbp)
    <span style="color:#960050;background-color:#1e0010">0</span><span style="color:#a6e22e">x10000194d</span> <span style="color:#960050;background-color:#1e0010">&lt;+</span><span style="color:#ae81ff">61</span><span style="color:#960050;background-color:#1e0010">&gt;</span>:  <span style="color:#66d9ef">movq</span>   %rax, %rsi
    <span style="color:#960050;background-color:#1e0010">0</span><span style="color:#a6e22e">x100001950</span> <span style="color:#960050;background-color:#1e0010">&lt;+</span><span style="color:#ae81ff">64</span><span style="color:#960050;background-color:#1e0010">&gt;</span>:  <span style="color:#66d9ef">movl</span>   <span style="color:#66d9ef">$0x21</span>, %edx
    <span style="color:#960050;background-color:#1e0010">0</span><span style="color:#a6e22e">x100001955</span> <span style="color:#960050;background-color:#1e0010">&lt;+</span><span style="color:#ae81ff">69</span><span style="color:#960050;background-color:#1e0010">&gt;</span>:  <span style="color:#66d9ef">movq</span>   -<span style="color:#ae81ff">0x58</span>(%rbp), %rcx
    <span style="color:#960050;background-color:#1e0010">0</span><span style="color:#a6e22e">x100001959</span> <span style="color:#960050;background-color:#1e0010">&lt;+</span><span style="color:#ae81ff">73</span><span style="color:#960050;background-color:#1e0010">&gt;</span>:  <span style="color:#66d9ef">callq</span>  <span style="color:#ae81ff">0x100003a2c</span>               <span style="color:#75715e">; symbol stub for: swift_beginAccess
</span><span style="color:#75715e"></span>    <span style="color:#ae81ff">0x10000195e</span> <span style="color:#960050;background-color:#1e0010">&lt;+</span><span style="color:#ae81ff">78</span><span style="color:#960050;background-color:#1e0010">&gt;</span>:  <span style="color:#66d9ef">movq</span>   <span style="color:#ae81ff">0x6863</span>(%rip), %rax        <span style="color:#75715e">; demo.foo : demo.Foo + 8
</span><span style="color:#75715e"></span>    <span style="color:#ae81ff">0x100001965</span> <span style="color:#960050;background-color:#1e0010">&lt;+</span><span style="color:#ae81ff">85</span><span style="color:#960050;background-color:#1e0010">&gt;</span>:  <span style="color:#66d9ef">movq</span>   %rax, -<span style="color:#ae81ff">0x28</span>(%rbp)
    <span style="color:#960050;background-color:#1e0010">0</span><span style="color:#a6e22e">x100001969</span> <span style="color:#960050;background-color:#1e0010">&lt;+</span><span style="color:#ae81ff">89</span><span style="color:#960050;background-color:#1e0010">&gt;</span>:  <span style="color:#66d9ef">leaq</span>   -<span style="color:#ae81ff">0x28</span>(%rbp), %rdi
    <span style="color:#960050;background-color:#1e0010">0</span><span style="color:#a6e22e">x10000196d</span> <span style="color:#960050;background-color:#1e0010">&lt;+</span><span style="color:#ae81ff">93</span><span style="color:#960050;background-color:#1e0010">&gt;</span>:  <span style="color:#66d9ef">callq</span>  <span style="color:#ae81ff">0x1000026e0</span>               <span style="color:#75715e">; demo.inoutFunc(inout Swift.Int) -&gt; () at main.swift:33
</span><span style="color:#75715e"></span>    <span style="color:#ae81ff">0x100001972</span> <span style="color:#960050;background-color:#1e0010">&lt;+</span><span style="color:#ae81ff">98</span><span style="color:#960050;background-color:#1e0010">&gt;</span>:  <span style="color:#66d9ef">movq</span>   -<span style="color:#ae81ff">0x28</span>(%rbp), %rdi
    <span style="color:#960050;background-color:#1e0010">0</span><span style="color:#a6e22e">x100001976</span> <span style="color:#960050;background-color:#1e0010">&lt;+</span><span style="color:#ae81ff">102</span><span style="color:#960050;background-color:#1e0010">&gt;</span>: <span style="color:#66d9ef">leaq</span>   <span style="color:#ae81ff">0x6843</span>(%rip), %r13        <span style="color:#75715e">; demo.foo : demo.Foo
</span><span style="color:#75715e"></span>    <span style="color:#75715e">; 将调用 setter
</span><span style="color:#75715e"></span>    <span style="color:#ae81ff">0x10000197d</span> <span style="color:#960050;background-color:#1e0010">&lt;+</span><span style="color:#ae81ff">109</span><span style="color:#960050;background-color:#1e0010">&gt;</span>: <span style="color:#66d9ef">callq</span>  <span style="color:#ae81ff">0x100001b30</span>               <span style="color:#75715e">; demo.Foo.b.setter : Swift.Int at main.swift:6
</span></code></pre></div><p>与之前不同的是，当执行完 <code>inoutFunc</code> 后，<code>setter</code> 仍然得到了调用，但具体原因我们先继续看下计算属性。我们知道计算属性并不需要内存来存储结果，而其结果来自于其它属性的计算。因此即使 <code>inoutFunc</code> 也并不会获取到变量 <code>c</code> 的内存地址：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-swift" data-lang="swift"><span style="color:#75715e">// inoutFunc(&amp;foo.a)</span>

<span style="color:#75715e">// inoutFunc(&amp;foo.b)</span>

inoutFunc(&amp;foo.c) <span style="color:#75715e">// BREAKPOINT 🔴</span>

print(foo)

<span style="color:#75715e">// c get</span>
<span style="color:#75715e">// c set</span>
<span style="color:#75715e">// c get</span>
<span style="color:#75715e">// a: 10, b: 1, c: 100</span>
</code></pre></div><p>尝试运行后在断点处查看汇编：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-asm" data-lang="asm"><span style="color:#960050;background-color:#1e0010">-&gt;</span>  <span style="color:#960050;background-color:#1e0010">0</span><span style="color:#a6e22e">x100001932</span> <span style="color:#960050;background-color:#1e0010">&lt;+</span><span style="color:#ae81ff">50</span><span style="color:#960050;background-color:#1e0010">&gt;</span>:  <span style="color:#66d9ef">movq</span>   %rcx, %rdi
    <span style="color:#960050;background-color:#1e0010">0</span><span style="color:#a6e22e">x100001935</span> <span style="color:#960050;background-color:#1e0010">&lt;+</span><span style="color:#ae81ff">53</span><span style="color:#960050;background-color:#1e0010">&gt;</span>:  <span style="color:#66d9ef">leaq</span>   -<span style="color:#ae81ff">0x20</span>(%rbp), %rax
    <span style="color:#960050;background-color:#1e0010">0</span><span style="color:#a6e22e">x100001939</span> <span style="color:#960050;background-color:#1e0010">&lt;+</span><span style="color:#ae81ff">57</span><span style="color:#960050;background-color:#1e0010">&gt;</span>:  <span style="color:#66d9ef">movq</span>   %rsi, -<span style="color:#ae81ff">0x58</span>(%rbp)
    <span style="color:#960050;background-color:#1e0010">0</span><span style="color:#a6e22e">x10000193d</span> <span style="color:#960050;background-color:#1e0010">&lt;+</span><span style="color:#ae81ff">61</span><span style="color:#960050;background-color:#1e0010">&gt;</span>:  <span style="color:#66d9ef">movq</span>   %rax, %rsi
    <span style="color:#960050;background-color:#1e0010">0</span><span style="color:#a6e22e">x100001940</span> <span style="color:#960050;background-color:#1e0010">&lt;+</span><span style="color:#ae81ff">64</span><span style="color:#960050;background-color:#1e0010">&gt;</span>:  <span style="color:#66d9ef">movl</span>   <span style="color:#66d9ef">$0x21</span>, %edx
    <span style="color:#960050;background-color:#1e0010">0</span><span style="color:#a6e22e">x100001945</span> <span style="color:#960050;background-color:#1e0010">&lt;+</span><span style="color:#ae81ff">69</span><span style="color:#960050;background-color:#1e0010">&gt;</span>:  <span style="color:#66d9ef">movq</span>   -<span style="color:#ae81ff">0x58</span>(%rbp), %rcx
    <span style="color:#960050;background-color:#1e0010">0</span><span style="color:#a6e22e">x100001949</span> <span style="color:#960050;background-color:#1e0010">&lt;+</span><span style="color:#ae81ff">73</span><span style="color:#960050;background-color:#1e0010">&gt;</span>:  <span style="color:#66d9ef">callq</span>  <span style="color:#ae81ff">0x100003a2c</span>               <span style="color:#75715e">; symbol stub for: swift_beginAccess
</span><span style="color:#75715e"></span>    <span style="color:#ae81ff">0x10000194e</span> <span style="color:#960050;background-color:#1e0010">&lt;+</span><span style="color:#ae81ff">78</span><span style="color:#960050;background-color:#1e0010">&gt;</span>:  <span style="color:#66d9ef">movq</span>   <span style="color:#ae81ff">0x686b</span>(%rip), %rdi        <span style="color:#75715e">; demo.foo : demo.Foo
</span><span style="color:#75715e"></span>    <span style="color:#ae81ff">0x100001955</span> <span style="color:#960050;background-color:#1e0010">&lt;+</span><span style="color:#ae81ff">85</span><span style="color:#960050;background-color:#1e0010">&gt;</span>:  <span style="color:#66d9ef">movq</span>   <span style="color:#ae81ff">0x686c</span>(%rip), %rsi        <span style="color:#75715e">; demo.foo : demo.Foo + 8
</span><span style="color:#75715e"></span>    <span style="color:#75715e">; 将调用计算属性的 getter
</span><span style="color:#75715e"></span>    <span style="color:#ae81ff">0x10000195c</span> <span style="color:#960050;background-color:#1e0010">&lt;+</span><span style="color:#ae81ff">92</span><span style="color:#960050;background-color:#1e0010">&gt;</span>:  <span style="color:#66d9ef">callq</span>  <span style="color:#ae81ff">0x1000020d0</span>               <span style="color:#75715e">; demo.Foo.c.getter : Swift.Int at main.swift:17
</span><span style="color:#75715e"></span>    <span style="color:#ae81ff">0x100001961</span> <span style="color:#960050;background-color:#1e0010">&lt;+</span><span style="color:#ae81ff">97</span><span style="color:#960050;background-color:#1e0010">&gt;</span>:  <span style="color:#66d9ef">movq</span>   %rax, -<span style="color:#ae81ff">0x28</span>(%rbp)
    <span style="color:#960050;background-color:#1e0010">0</span><span style="color:#a6e22e">x100001965</span> <span style="color:#960050;background-color:#1e0010">&lt;+</span><span style="color:#ae81ff">101</span><span style="color:#960050;background-color:#1e0010">&gt;</span>: <span style="color:#66d9ef">leaq</span>   -<span style="color:#ae81ff">0x28</span>(%rbp), %rdi
    <span style="color:#75715e">; 将调用 inoutFunc
</span><span style="color:#75715e"></span>    <span style="color:#960050;background-color:#1e0010">0</span><span style="color:#a6e22e">x100001969</span> <span style="color:#960050;background-color:#1e0010">&lt;+</span><span style="color:#ae81ff">105</span><span style="color:#960050;background-color:#1e0010">&gt;</span>: <span style="color:#66d9ef">callq</span>  <span style="color:#ae81ff">0x1000026e0</span>               <span style="color:#75715e">; demo.inoutFunc(inout Swift.Int) -&gt; () at main.swift:33
</span><span style="color:#75715e"></span>    <span style="color:#ae81ff">0x10000196e</span> <span style="color:#960050;background-color:#1e0010">&lt;+</span><span style="color:#ae81ff">110</span><span style="color:#960050;background-color:#1e0010">&gt;</span>: <span style="color:#66d9ef">movq</span>   -<span style="color:#ae81ff">0x28</span>(%rbp), %rdi
    <span style="color:#960050;background-color:#1e0010">0</span><span style="color:#a6e22e">x100001972</span> <span style="color:#960050;background-color:#1e0010">&lt;+</span><span style="color:#ae81ff">114</span><span style="color:#960050;background-color:#1e0010">&gt;</span>: <span style="color:#66d9ef">leaq</span>   <span style="color:#ae81ff">0x6847</span>(%rip), %r13        <span style="color:#75715e">; demo.foo : demo.Foo
</span><span style="color:#75715e"></span>    <span style="color:#75715e">; 将调用计算属性的 setter
</span><span style="color:#75715e"></span>    <span style="color:#ae81ff">0x100001979</span> <span style="color:#960050;background-color:#1e0010">&lt;+</span><span style="color:#ae81ff">121</span><span style="color:#960050;background-color:#1e0010">&gt;</span>: <span style="color:#66d9ef">callq</span>  <span style="color:#ae81ff">0x100002220</span>               <span style="color:#75715e">; demo.Foo.c.setter : Swift.Int at main.swift:22
</span></code></pre></div><p>根据汇编，当遇到计算属性或带有存储属性观察器的存储属性时，将先通过 <code>getter</code> 将值拷贝到一个外界的局部变量上，再将该变量的地址传递到 <code>inoutFunc</code> 方法中，得到结果后外界变量将重新通过 <code>setter</code> 将值设置回原有的计算属性。</p>
<h2 id="类型属性">类型属性</h2>
<p>类型属性指的是通过类型直接访问的属性，这样的存储属性将类似于全局变量，即只会在内存中保存一份。我们在结构体、类、枚举中均可以定义类型属性，通常使用 <code>static</code> 关键字；在类中，如果定义的类型属性是计算属性，那么也可以使用 <code>class</code> 关键字：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-swift" data-lang="swift"><span style="color:#66d9ef">struct</span> <span style="color:#a6e22e">Foo</span> {
    <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">var</span> foo: Int = <span style="color:#ae81ff">0</span>
}

<span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Bar</span> {
    <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">var</span> bar1: Int = <span style="color:#ae81ff">0</span>
    <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">let</span> bar2: Int = <span style="color:#ae81ff">0</span>

    <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">var</span> bar3: Int {
        <span style="color:#ae81ff">0</span>
    }
}

<span style="color:#66d9ef">enum</span> <span style="color:#a6e22e">Baz</span> {
    <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">var</span> baz = <span style="color:#ae81ff">0</span>
}

print(Foo.foo)  <span style="color:#75715e">// 0</span>
print(Bar.bar1) <span style="color:#75715e">// 0</span>
print(Bar.bar2) <span style="color:#75715e">// 0</span>
print(Bar.bar3) <span style="color:#75715e">// 0</span>
print(Baz.baz)  <span style="color:#75715e">// 0</span>
</code></pre></div><p>需要注意的是，由于类型属性非针对于某一实例对象，因此其必须在声明时即给定初始值；类型属性如果同时为存储属性，默认即为 <code>lazy</code> 延迟：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-swift" data-lang="swift"><span style="color:#66d9ef">struct</span> <span style="color:#a6e22e">Foo</span> {
    <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">var</span> foo: Int = <span style="color:#ae81ff">0</span>

    <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">var</span> calculateFoo: Int = {
        print(<span style="color:#e6db74">&#34;calculateFoo init&#34;</span>)
        <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>
    }()
}

<span style="color:#75715e">// 0</span>
<span style="color:#75715e">// calculateFoo init</span>
</code></pre></div><p>但此时的延迟存储属性是线程安全的：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-swift" data-lang="swift"><span style="color:#66d9ef">import</span> <span style="color:#a6e22e">Foundation</span>

<span style="color:#66d9ef">struct</span> <span style="color:#a6e22e">Foo</span> {
    <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">var</span> foo: Int = <span style="color:#ae81ff">0</span>

    <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">var</span> calculateFoo: Int = {
        print(<span style="color:#e6db74">&#34;calculateFoo init&#34;</span>)
        <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>
    }()
}

print(Foo.foo)

DispatchQueue.concurrentPerform(iterations: <span style="color:#ae81ff">5</span>) { <span style="color:#66d9ef">_</span> <span style="color:#66d9ef">in</span>
    print(<span style="color:#e6db74">&#34;--- </span><span style="color:#e6db74">\(</span>Thread.current<span style="color:#e6db74">)</span><span style="color:#e6db74"> ---&#34;</span>)
    print(Foo.calculateFoo)
}

<span style="color:#75715e">// 0</span>
<span style="color:#75715e">// --- &lt;NSThread: 0x1020be860&gt;{number = 4, name = (null)} ---</span>
<span style="color:#75715e">// calculateFoo init</span>
<span style="color:#75715e">// 0</span>
<span style="color:#75715e">// --- &lt;NSThread: 0x1007042d0&gt;{number = 3, name = (null)} ---</span>
<span style="color:#75715e">// 0</span>
<span style="color:#75715e">// --- &lt;NSThread: 0x1021040c0&gt;{number = 2, name = (null)} ---</span>
<span style="color:#75715e">// 0</span>
<span style="color:#75715e">// --- &lt;NSThread: 0x10200ab30&gt;{number = 1, name = main} ---</span>
<span style="color:#75715e">// 0</span>
<span style="color:#75715e">// --- &lt;NSThread: 0x1022040c0&gt;{number = 5, name = (null)} ---</span>
<span style="color:#75715e">// 0</span>
<span style="color:#75715e">// 0</span>
</code></pre></div><p>如上，即使同时 5 个线程并发访问，<code>calculateFoo</code> 也将被保证只初始化一次。类型属性通常可以用于单例模式，即整个生命周期内仅初始化一次：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-swift" data-lang="swift"><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">SomeManager</span> {
    <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">var</span> manager: SomeManager = {
        <span style="color:#66d9ef">var</span> manager = SomeManager()
        manager.foo = <span style="color:#ae81ff">10</span>
        <span style="color:#66d9ef">return</span> manager
    }()

    <span style="color:#66d9ef">var</span> foo: Int = <span style="color:#ae81ff">0</span>

    <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">init</span>() {}

    <span style="color:#66d9ef">func</span> <span style="color:#a6e22e">bar</span>() {
        print(<span style="color:#66d9ef">#function</span>, foo)
    }
}

SomeManager.manager.bar()

<span style="color:#75715e">// bar() 10</span>
</code></pre></div><h2 id="reference">Reference</h2>
<ul>
<li><a href="http://www.jianshu.com/p/80810efe5229">浅谈 Swift 3 中的访问控制</a></li>
<li><a href="https://developer.apple.com/library/content/documentation/Swift/Conceptual/Swift_Programming_Language/AccessControl.html">Access Control</a></li>
<li><a href="https://developer.apple.com/library/content/documentation/Swift/Conceptual/Swift_Programming_Language/Properties.html">Properties</a></li>
<li><a href="https://github.com/devxoul/Then">devxoul/Then</a></li>
<li><a href="http://swifter.tips/lazy/">lazy 修饰符和 lazy 方法</a></li>
<li><a href="https://www.bilibili.com/video/BV1cx411S7ay">【菜鸡 Playground 1】Swift 中 lazy initialization</a></li>
<li><a href="https://www.bilibili.com/video/av10142408/">【菜鸡 Playground 2】Swift 中 lazy initialization 的使用场景</a></li>
</ul>

    </div>
    
      <div class="pagination">
        <div class="pagination__title">
          <span class="pagination__title-h">Read other posts</span>
          <hr />
        </div>
        <div class="pagination__buttons">
          
          
            <span class="button next">
              <a href="/posts/2018/swift_autoclosure/">
                <span class="button__text">Swift 中的 @autoclosure</span>
                <span class="button__icon">→</span>
              </a>
            </span>
          
        </div>
      </div>
    

    

<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<table style="border: 0;">
  <tr>
  <td style="border: 0; width: 30%;">
    <img src='/img/about/1.jpg'>
  </td>
  <td style="border: 0;">
    <ins class="adsbygoogle"
     style="display:block"
     data-ad-client="ca-pub-9925978992661955"
     data-ad-slot="3213735320"
     data-ad-format="auto"
     data-full-width-responsive="true"></ins>
  </td>
  </tr>
</table>



<script>
     (adsbygoogle = window.adsbygoogle || []).push({});
</script>


    
    
    <div>
      <div id="github-comment">
      </div>

      <script type="text/javascript">
        function getUtterances(isDark) {
          var utterances = document.createElement('script');
          utterances.type = 'text/javascript';
          utterances.async = true;
          utterances.setAttribute('issue-term', "pathname")
          utterances.setAttribute('repo', "kingcos\/kingcos.github.io")
          utterances.setAttribute('label', "comments")
          isDark ? utterances.setAttribute('theme', "github-dark") : utterances.setAttribute('theme', "github-light")
          utterances.crossorigin = 'anonymous';
          utterances.src = 'https://utteranc.es/client.js';

          return utterances
        }

        var themeToggle = document.querySelector(".theme-toggle")
        themeToggle.addEventListener("click", function () {
          var getTheme = window.localStorage && window.localStorage.getItem("theme")
          var divNode = document.getElementById('github-comment')
          while(divNode.hasChildNodes()) {
            divNode.removeChild(divNode.firstChild);
          }
          
          
          

          
          
          
          
          
          
          document.getElementById('github-comment').appendChild(getUtterances(getTheme !== "dark"))
        })

        var getTheme = window.localStorage && window.localStorage.getItem("theme")
        document.getElementById('github-comment').appendChild(getUtterances(getTheme === "dark"))
      </script>
    </div>
    

    </div>

      </div>

      
        <footer class="footer">
  <div class="footer__inner">
    
      <div class="copyright copyright--user">All rights reserved by kingcos.me</div>
    
  </div>
</footer>

<script src="/assets/main.js"></script>
<script src="/assets/prism.js"></script>



      
    </div>

    
      
<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
	(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
	m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
	})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
	ga('create', 'UA-138311951-1', 'auto');
	
	ga('send', 'pageview');
}
</script>

    
  </body>
</html>
