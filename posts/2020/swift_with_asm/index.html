<!DOCTYPE html>
<html lang="en" >
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="author" content="kingcos" />
	
	
	
	<title>Swift 拾遗 - 汇编 ｜ 萌面大道</title>
	
    
    
    <meta name="description" content="《Swift 拾遗》是一个关于 Swift 的新文章专辑，这个系列的文章将不会涉及基本语法的层面，而是尝试从底层「拾」起之前所忽视的内容。本文涉及了各个部分关于汇编的内容。" />
    

    
    
    <meta name="keywords" content="Hugo, theme, zozo" />
    

	
    
    <link rel="shortcut icon" href="https://kingcos.me/images/favicon.png" />

    <link rel="stylesheet" type="text/css" media="screen" href="https://kingcos.me/css/normalize.css" />
    <link rel="stylesheet" type="text/css" media="screen" href="https://cdn.jsdelivr.net/npm/animate.css@4.1.0/animate.min.css" />
    <link rel="stylesheet" type="text/css" media="screen" href="https://kingcos.me/css/zozo.css" />
	<link rel="stylesheet" type="text/css" media="screen" href="https://cdn.jsdelivr.net/npm/remixicon@2.5.0/fonts/remixicon.css" />
    <link rel="stylesheet" type="text/css" media="screen" href="https://kingcos.me/css/highlight.css" />

    
    
</head>

<script data-ad-client="ca-pub-9925978992661955" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>


<body>
    <div class="main animate__animated animate__fadeInDown">
        <div class="nav_container animated fadeInDown">
    <div class="site_nav" id="site_nav">
        <ul>
            
            <li>
                <a href="/">Home</a>
            </li>
            
            <li>
                <a href="/posts/">Archive</a>
            </li>
            
            <li>
                <a href="/tags/">Tags</a>
            </li>
            
            <li>
                <a href="/about/">About</a>
            </li>
            
        </ul>
    </div>
    <div class="menu_icon">
        <a id="menu_icon"><i class="ri-menu-line"></i></a>
    </div>
</div>

<style>
.nav_container {
  height: 1rem;
}
table {
    width: 100%;
    table-layout: fixed;
}
.markdown code {
    white-space: normal;
    word-wrap: break-word;
     
}

.menu_icon a {
    font-size: 20px;
}

 

body {
    font-family: 'Hiragino Sans GB', 'SFMono', 'Lato';
    -webkit-font-smoothing: 'antialiased';
}

.markdown strong, .markdown b, .markdown em {
    font-weight: bold;
}

.markdown .book-hint.info {
    border-left-color:#6bf;
    background-color:rgba(102,187,255,.1);
    font-weight: bold;
}

.markdown .book-hint.warning{
    border-left-color:#fd6;
    background-color:rgba(255,221,102,.1);
    font-weight: bold;
}

.markdown .book-hint.danger{
    border-left-color:#f66;
    background-color:rgba(255,102,102,.1);
    font-weight: bold;
}

</style>

        <div class="header animated fadeInDown">
    <div class="site_title_container">
        <div class="site_title">
            <h1>
                <a href="https://kingcos.me/">
                    <span>萌面大道</span>
                </a>
            </h1>
        </div>
        <div class="description">
            <p class="sub_title">专注、坚持</p>
            <div class="my_socials">
                
                
                <a href="https://github.com/kingcos" title="github" target="_blank"><i class="ri-github-fill"></i></a>
                
                
                
                <a href="https://www.instagram.com/kingcos_v/" title="instagram" target="_blank"><i class="ri-instagram-fill"></i></a>
                
                
                
                <a href="https://twitter.com/kingcos_v" title="twitter" target="_blank"><i class="ri-twitter-fill"></i></a>
                
                
                
                <a href="https://weibo.com/u/1798410923" title="weibo" target="_blank"><i class="ri-weibo-fill"></i></a>
                
                
                <a href="https://kingcos.me/index.xml" type="application/rss+xml" title="rss" target="_blank"><i
                        class="ri-rss-fill"></i></a>
            </div>
        </div>
    </div>
</div>
        <div class="content">
            <div class="post_page">
                <div class="post animate__animated animate__fadeInDown">
                    <div class="post_title post_detail_title">
                        <h2><a href='/posts/2020/swift_with_asm/'>Swift 拾遗 - 汇编</a></h2>
                        <span class="date">2020.08.10</span>
                    </div>
                    <div class="post_content markdown"><table>
<thead>
<tr>
<th style="text-align:center">Date</th>
<th style="text-align:center">Notes</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">2020-08-10</td>
<td style="text-align:center">首次提交</td>
</tr>
</tbody>
</table>
<h2 id="preface">Preface</h2>
<p>《Swift 拾遗》是一个关于 Swift 的新文章专辑，这个系列的文章将不会涉及基本语法的层面，而是尝试从底层「拾」起之前所忽视的内容。本文涉及了各个部分关于汇编的内容。</p>
<!-- - 16 个常用寄存器：
  - `rax`、`rbx`、`rcx`、`rdx`、`rsi`、`rdi`、`rbp`、`rsp`
  - `r8`、`r9`、`r10`、`r11`、`r12`、`r13`、`r14`、`r15`
  - `r` 开头的寄存器均为 64 位(8 字节）寄存器，`e` 开头为 32 位，`ax`、`bx`、`cx` 为 16 位，`ah`、`al` 为 8 位。

  - 结构体和对象等均存储在内存（非寄存器） -->
<h2 id="struct--class">struct &amp; class</h2>
<h3 id="struct">struct</h3>
<h4 id="分配在栈区">分配在栈区</h4>
<div class="highlight"><pre class="chroma"><code class="language-swift" data-lang="swift"><span class="c1">// main.swift</span>

<span class="kd">struct</span> <span class="nc">Foo</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nv">a</span><span class="p">:</span> <span class="nb">Int</span>
    <span class="kd">var</span> <span class="nv">b</span><span class="p">:</span> <span class="nb">Int</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="nf">bar</span><span class="p">()</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nv">foo1</span> <span class="p">=</span> <span class="n">Foo</span><span class="p">(</span><span class="n">a</span><span class="p">:</span> <span class="mi">10</span><span class="p">,</span> <span class="n">b</span><span class="p">:</span> <span class="mi">11</span><span class="p">)</span> <span class="c1">// BREAKPOINT 🔴</span>
    <span class="kd">var</span> <span class="nv">foo2</span> <span class="p">=</span> <span class="n">foo1</span>

    <span class="n">foo2</span><span class="p">.</span><span class="n">a</span> <span class="p">=</span> <span class="mi">20</span>
    <span class="n">foo2</span><span class="p">.</span><span class="n">b</span> <span class="p">=</span> <span class="mi">22</span>
<span class="p">}</span>

<span class="n">bar</span><span class="p">()</span>
</code></pre></div><p>我们定义一个结构体 <code>Foo</code>，并在函数 <code>bar</code> 中声明和构造后赋值于 <code>foo1</code>，之后将 <code>foo1</code> 赋值给新变量 <code>foo2</code>；此时改变 <code>foo2</code> 中的值，由于结构体是值类型，因此对于 <code>foo2</code> 的改变将不会影响 <code>foo1</code>，我们尝试从汇编底层看一下这个过程：</p>
<div class="highlight"><pre class="chroma"><code class="language-asm" data-lang="asm"><span class="nf">demo</span><span class="err">`</span><span class="no">bar</span><span class="p">():</span>
    <span class="c">; ...
</span><span class="c"></span>    <span class="c">; 函数调用前要先传递参数：
</span><span class="c"></span>    <span class="c">; 将立即数 10 移动到 edi 寄存器（即 rdi 寄存器低 32 位）
</span><span class="c"></span>    <span class="err">0</span><span class="nf">x100000b73</span> <span class="err">&lt;+</span><span class="mi">19</span><span class="err">&gt;</span><span class="p">:</span> <span class="no">movl</span>   <span class="no">$0xa</span><span class="p">,</span> <span class="nv">%edi</span>
    <span class="c">; 将立即数 11 移动到 esi 寄存器（即 rsi 寄存器低 32 位）
</span><span class="c"></span>    <span class="err">0</span><span class="nf">x100000b78</span> <span class="err">&lt;+</span><span class="mi">24</span><span class="err">&gt;</span><span class="p">:</span> <span class="no">movl</span>   <span class="no">$0xb</span><span class="p">,</span> <span class="nv">%esi</span>
    <span class="c">; 构造函数调用：
</span><span class="c"></span><span class="err">-&gt;</span>  <span class="err">0</span><span class="nf">x100000b7d</span> <span class="err">&lt;+</span><span class="mi">29</span><span class="err">&gt;</span><span class="p">:</span> <span class="no">callq</span>  <span class="mi">0x100000b50</span>               <span class="c">; demo.Foo.init(a: Swift.Int, b: Swift.Int) -&gt; demo.Foo at main.swift:1
</span><span class="c"></span>    <span class="c">; 经构造函数调用后，此时 10 位于 rax，11 位于 rdx（详见下方 init 内汇编）
</span><span class="c"></span>    <span class="c">; (lldb) register read rax =&gt; rax = 0x000000000000000a
</span><span class="c"></span>    <span class="c">; (lldb) register read rdx =&gt; rdx = 0x000000000000000b
</span><span class="c"></span>    <span class="c">; ---
</span><span class="c"></span>    <span class="c">; (lldb) register read rbp =&gt; rbp = 0x00007ffeefbff4a0
</span><span class="c"></span>    <span class="c">; (lldb) po withUnsafePointer(to: &amp;foo1) { print(&#34;\($0)&#34;) } =&gt; 0x00007ffeefbff490
</span><span class="c"></span>    <span class="c">; 将 rax 寄存器内容（10）移动到 rbp - 0x10 地址（0x7FFEEFBFF490，即 foo1 的内存地址）
</span><span class="c"></span>    <span class="mi">0x100000b82</span> <span class="err">&lt;+</span><span class="mi">34</span><span class="err">&gt;</span><span class="p">:</span> <span class="no">movq</span>   <span class="nv">%rax</span><span class="p">,</span> <span class="p">-</span><span class="mi">0x10</span><span class="p">(</span><span class="nv">%rbp</span><span class="p">)</span>
    <span class="c">; 将 rdx 寄存器内容（11）移动到 rbp - 0x8 地址（0x7FFEEFBFF498）
</span><span class="c"></span>    <span class="err">0</span><span class="nf">x100000b86</span> <span class="err">&lt;+</span><span class="mi">38</span><span class="err">&gt;</span><span class="p">:</span> <span class="no">movq</span>   <span class="nv">%rdx</span><span class="p">,</span> <span class="p">-</span><span class="mi">0x8</span><span class="p">(</span><span class="nv">%rbp</span><span class="p">)</span>
    <span class="c">; (lldb) po withUnsafePointer(to: &amp;foo2) { print(&#34;\($0)&#34;) } =&gt; 0x00007ffeefbff480
</span><span class="c"></span>    <span class="c">; 将 rax 寄存器内容（10）移动到 rbp - 0x20 地址（0x7FFEEFBFF480，即 foo2 的内存地址）
</span><span class="c"></span>    <span class="err">0</span><span class="nf">x100000b8a</span> <span class="err">&lt;+</span><span class="mi">42</span><span class="err">&gt;</span><span class="p">:</span> <span class="no">movq</span>   <span class="nv">%rax</span><span class="p">,</span> <span class="p">-</span><span class="mi">0x20</span><span class="p">(</span><span class="nv">%rbp</span><span class="p">)</span>
    <span class="c">; 将 rdx 寄存器内容（11）移动到 rbp - 0x18 地址（0x7FFEEFBFF488）
</span><span class="c"></span>    <span class="err">0</span><span class="nf">x100000b8e</span> <span class="err">&lt;+</span><span class="mi">46</span><span class="err">&gt;</span><span class="p">:</span> <span class="no">movq</span>   <span class="nv">%rdx</span><span class="p">,</span> <span class="p">-</span><span class="mi">0x18</span><span class="p">(</span><span class="nv">%rbp</span><span class="p">)</span>
    <span class="c">; 将立即数 20 移动到 rbp - 0x20 寄存器（foo2.a）
</span><span class="c"></span>    <span class="err">0</span><span class="nf">x100000b92</span> <span class="err">&lt;+</span><span class="mi">50</span><span class="err">&gt;</span><span class="p">:</span> <span class="no">movq</span>   <span class="no">$0x14</span><span class="p">,</span> <span class="p">-</span><span class="mi">0x20</span><span class="p">(</span><span class="nv">%rbp</span><span class="p">)</span>
    <span class="c">; 将立即数 22 移动到 rbp - 0x18 寄存器（foo2.b）
</span><span class="c"></span>    <span class="err">0</span><span class="nf">x100000b9a</span> <span class="err">&lt;+</span><span class="mi">58</span><span class="err">&gt;</span><span class="p">:</span> <span class="no">movq</span>   <span class="no">$0x16</span><span class="p">,</span> <span class="p">-</span><span class="mi">0x18</span><span class="p">(</span><span class="nv">%rbp</span><span class="p">)</span>
    <span class="err">0</span><span class="nf">x100000ba2</span> <span class="err">&lt;+</span><span class="mi">66</span><span class="err">&gt;</span><span class="p">:</span> <span class="no">addq</span>   <span class="no">$0x20</span><span class="p">,</span> <span class="nv">%rsp</span>
    <span class="err">0</span><span class="nf">x100000ba6</span> <span class="err">&lt;+</span><span class="mi">70</span><span class="err">&gt;</span><span class="p">:</span> <span class="no">popq</span>   <span class="nv">%rbp</span>
    <span class="err">0</span><span class="nf">x100000ba7</span> <span class="err">&lt;+</span><span class="mi">71</span><span class="err">&gt;</span><span class="p">:</span> <span class="no">retq</span>

<span class="c">; 断点处执行 LLDB 命令 si：
</span><span class="c"></span><span class="nf">demo</span><span class="err">`</span><span class="no">Foo.init</span><span class="p">(</span><span class="no">a</span><span class="err">🅱️</span><span class="p">):</span>
<span class="err">-&gt;</span>  <span class="err">0</span><span class="nf">x100000b50</span> <span class="err">&lt;+</span><span class="mi">0</span><span class="err">&gt;</span><span class="p">:</span>  <span class="no">pushq</span>  <span class="nv">%rbp</span>
    <span class="err">0</span><span class="nf">x100000b51</span> <span class="err">&lt;+</span><span class="mi">1</span><span class="err">&gt;</span><span class="p">:</span>  <span class="no">movq</span>   <span class="nv">%rsp</span><span class="p">,</span> <span class="nv">%rbp</span>
    <span class="c">; 将参数放在函数内部的栈空间：
</span><span class="c"></span>    <span class="c">; 将 rdi 寄存器内容（10）移动到 rax 寄存器
</span><span class="c"></span>    <span class="err">0</span><span class="nf">x100000b54</span> <span class="err">&lt;+</span><span class="mi">4</span><span class="err">&gt;</span><span class="p">:</span>  <span class="no">movq</span>   <span class="nv">%rdi</span><span class="p">,</span> <span class="nv">%rax</span>
    <span class="c">; 将 rsi 寄存器内容（11）移动到 rdx 寄存器
</span><span class="c"></span>    <span class="err">0</span><span class="nf">x100000b57</span> <span class="err">&lt;+</span><span class="mi">7</span><span class="err">&gt;</span><span class="p">:</span>  <span class="no">movq</span>   <span class="nv">%rsi</span><span class="p">,</span> <span class="nv">%rdx</span>
    <span class="err">0</span><span class="nf">x100000b5a</span> <span class="err">&lt;+</span><span class="mi">10</span><span class="err">&gt;</span><span class="p">:</span> <span class="no">popq</span>   <span class="nv">%rbp</span>
    <span class="err">0</span><span class="nf">x100000b5b</span> <span class="err">&lt;+</span><span class="mi">11</span><span class="err">&gt;</span><span class="p">:</span> <span class="no">retq</span>
</code></pre></div><p>综上，变量的内存地址格式为：<code>-0x10(%rbp)</code> 一般是栈空间的局部变量。这是因为 <code>rbp</code> 会根据每次函数调用而有不一样的值，局部变量的内存地址也在每次调用时会重新分配。</p>
<h4 id="分配在全局区">分配在全局区</h4>
<div class="highlight"><pre class="chroma"><code class="language-swift" data-lang="swift"><span class="c1">// main.swift</span>

<span class="kd">struct</span> <span class="nc">Foo</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nv">a</span><span class="p">:</span> <span class="nb">Int</span>
    <span class="kd">var</span> <span class="nv">b</span><span class="p">:</span> <span class="nb">Int</span>
<span class="p">}</span>

<span class="kd">var</span> <span class="nv">foo1</span> <span class="p">=</span> <span class="n">Foo</span><span class="p">(</span><span class="n">a</span><span class="p">:</span> <span class="mi">10</span><span class="p">,</span> <span class="n">b</span><span class="p">:</span> <span class="mi">11</span><span class="p">)</span> <span class="c1">// BREAKPOINT 🔴</span>
<span class="kd">var</span> <span class="nv">foo2</span> <span class="p">=</span> <span class="n">foo1</span>

<span class="n">foo2</span><span class="p">.</span><span class="n">a</span> <span class="p">=</span> <span class="mi">20</span>
<span class="n">foo2</span><span class="p">.</span><span class="n">b</span> <span class="p">=</span> <span class="mi">22</span>
</code></pre></div><p>当 <code>foo1</code> 和 <code>foo2</code> 在全局区时则又有些不一样：</p>
<div class="highlight"><pre class="chroma"><code class="language-asm" data-lang="asm"><span class="nf">demo</span><span class="err">`</span><span class="no">main</span><span class="p">:</span>
    <span class="err">0</span><span class="nf">x100000a80</span> <span class="err">&lt;+</span><span class="mi">0</span><span class="err">&gt;</span><span class="p">:</span>   <span class="no">pushq</span>  <span class="nv">%rbp</span>
    <span class="err">0</span><span class="nf">x100000a81</span> <span class="err">&lt;+</span><span class="mi">1</span><span class="err">&gt;</span><span class="p">:</span>   <span class="no">movq</span>   <span class="nv">%rsp</span><span class="p">,</span> <span class="nv">%rbp</span>
    <span class="err">0</span><span class="nf">x100000a84</span> <span class="err">&lt;+</span><span class="mi">4</span><span class="err">&gt;</span><span class="p">:</span>   <span class="no">subq</span>   <span class="no">$0x60</span><span class="p">,</span> <span class="nv">%rsp</span>
    <span class="c">; 函数调用前要先传递参数：
</span><span class="c"></span>    <span class="c">; 将立即数 10 移动到 eax 寄存器（即 rax 寄存器低 32 位）
</span><span class="c"></span><span class="err">-&gt;</span>  <span class="err">0</span><span class="nf">x100000a88</span> <span class="err">&lt;+</span><span class="mi">8</span><span class="err">&gt;</span><span class="p">:</span>   <span class="no">movl</span>   <span class="no">$0xa</span><span class="p">,</span> <span class="nv">%eax</span>
    <span class="err">0</span><span class="nf">x100000a8d</span> <span class="err">&lt;+</span><span class="mi">13</span><span class="err">&gt;</span><span class="p">:</span>  <span class="no">movl</span>   <span class="nv">%edi</span><span class="p">,</span> <span class="p">-</span><span class="mi">0x4c</span><span class="p">(</span><span class="nv">%rbp</span><span class="p">)</span>
    <span class="c">; 将 rax 寄存器内容（10）移动到 rdi 寄存器
</span><span class="c"></span>    <span class="err">0</span><span class="nf">x100000a90</span> <span class="err">&lt;+</span><span class="mi">16</span><span class="err">&gt;</span><span class="p">:</span>  <span class="no">movq</span>   <span class="nv">%rax</span><span class="p">,</span> <span class="nv">%rdi</span>
    <span class="c">; 将立即数 11 移动到 eax 寄存器（即 rax 寄存器低 32 位）
</span><span class="c"></span>    <span class="err">0</span><span class="nf">x100000a93</span> <span class="err">&lt;+</span><span class="mi">19</span><span class="err">&gt;</span><span class="p">:</span>  <span class="no">movl</span>   <span class="no">$0xb</span><span class="p">,</span> <span class="nv">%eax</span>
    <span class="err">0</span><span class="nf">x100000a98</span> <span class="err">&lt;+</span><span class="mi">24</span><span class="err">&gt;</span><span class="p">:</span>  <span class="no">movq</span>   <span class="nv">%rsi</span><span class="p">,</span> <span class="p">-</span><span class="mi">0x58</span><span class="p">(</span><span class="nv">%rbp</span><span class="p">)</span>
    <span class="c">; 将 rax 寄存器内容（11）移动到 rsi 寄存器
</span><span class="c"></span>    <span class="err">0</span><span class="nf">x100000a9c</span> <span class="err">&lt;+</span><span class="mi">28</span><span class="err">&gt;</span><span class="p">:</span>  <span class="no">movq</span>   <span class="nv">%rax</span><span class="p">,</span> <span class="nv">%rsi</span>
    <span class="c">; 构造函数调用：
</span><span class="c"></span>    <span class="err">0</span><span class="nf">x100000a9f</span> <span class="err">&lt;+</span><span class="mi">31</span><span class="err">&gt;</span><span class="p">:</span>  <span class="no">callq</span>  <span class="mi">0x100000c00</span>               <span class="c">; demo.Foo.init(a: Swift.Int, b: Swift.Int) -&gt; demo.Foo at main.swift:3
</span><span class="c"></span>    <span class="c">; 经构造函数调用后，此时 10 位于 rax，11 位于 rdx（详见下方 init 内汇编）
</span><span class="c"></span>    <span class="c">; (lldb) register read rax =&gt; rax = 0x000000000000000a
</span><span class="c"></span>    <span class="c">; (lldb) register read rdx =&gt; rdx = 0x000000000000000b
</span><span class="c"></span>    <span class="mi">0x100000aa4</span> <span class="err">&lt;+</span><span class="mi">36</span><span class="err">&gt;</span><span class="p">:</span>  <span class="no">leaq</span>   <span class="mi">0x156d</span><span class="p">(</span><span class="nv">%rip</span><span class="p">),</span> <span class="nv">%rcx</span>        <span class="c">; demo.foo1 : demo.Foo
</span><span class="c"></span>    <span class="mi">0x100000aab</span> <span class="err">&lt;+</span><span class="mi">43</span><span class="err">&gt;</span><span class="p">:</span>  <span class="no">xorl</span>   <span class="nv">%r8d</span><span class="p">,</span> <span class="nv">%r8d</span>
    <span class="err">0</span><span class="nf">x100000aae</span> <span class="err">&lt;+</span><span class="mi">46</span><span class="err">&gt;</span><span class="p">:</span>  <span class="no">movl</span>   <span class="nv">%r8d</span><span class="p">,</span> <span class="nv">%esi</span>
    <span class="c">; (lldb) po withUnsafePointer(to: &amp;foo1) { print(&#34;\($0)&#34;) } =&gt; 0x0000000100002018
</span><span class="c"></span>    <span class="c">; 将 rax 寄存器内容（10）移动到 rip + 0x1560 地址（0x100002018，即 foo1 的内存地址）
</span><span class="c"></span>    <span class="err">0</span><span class="nf">x100000ab1</span> <span class="err">&lt;+</span><span class="mi">49</span><span class="err">&gt;</span><span class="p">:</span>  <span class="no">movq</span>   <span class="nv">%rax</span><span class="p">,</span> <span class="mi">0x1560</span><span class="p">(</span><span class="nv">%rip</span><span class="p">)</span>        <span class="c">; demo.foo1 : demo.Foo
</span><span class="c"></span>    <span class="c">; 将 rdx 寄存器内容（11）移动到 rip + 0x1561 地址（0x100002020）
</span><span class="c"></span>    <span class="mi">0x100000ab8</span> <span class="err">&lt;+</span><span class="mi">56</span><span class="err">&gt;</span><span class="p">:</span>  <span class="no">movq</span>   <span class="nv">%rdx</span><span class="p">,</span> <span class="mi">0x1561</span><span class="p">(</span><span class="nv">%rip</span><span class="p">)</span>        <span class="c">; demo.foo1 : demo.Foo + 8
</span><span class="c"></span>    <span class="mi">0x100000abf</span> <span class="err">&lt;+</span><span class="mi">63</span><span class="err">&gt;</span><span class="p">:</span>  <span class="no">movq</span>   <span class="nv">%rcx</span><span class="p">,</span> <span class="nv">%rdi</span>
    <span class="err">0</span><span class="nf">x100000ac2</span> <span class="err">&lt;+</span><span class="mi">66</span><span class="err">&gt;</span><span class="p">:</span>  <span class="no">leaq</span>   <span class="p">-</span><span class="mi">0x18</span><span class="p">(</span><span class="nv">%rbp</span><span class="p">),</span> <span class="nv">%rax</span>
    <span class="err">0</span><span class="nf">x100000ac6</span> <span class="err">&lt;+</span><span class="mi">70</span><span class="err">&gt;</span><span class="p">:</span>  <span class="no">movq</span>   <span class="nv">%rsi</span><span class="p">,</span> <span class="p">-</span><span class="mi">0x60</span><span class="p">(</span><span class="nv">%rbp</span><span class="p">)</span>
    <span class="err">0</span><span class="nf">x100000aca</span> <span class="err">&lt;+</span><span class="mi">74</span><span class="err">&gt;</span><span class="p">:</span>  <span class="no">movq</span>   <span class="nv">%rax</span><span class="p">,</span> <span class="nv">%rsi</span>
    <span class="err">0</span><span class="nf">x100000acd</span> <span class="err">&lt;+</span><span class="mi">77</span><span class="err">&gt;</span><span class="p">:</span>  <span class="no">movl</span>   <span class="no">$0x20</span><span class="p">,</span> <span class="nv">%edx</span>
    <span class="err">0</span><span class="nf">x100000ad2</span> <span class="err">&lt;+</span><span class="mi">82</span><span class="err">&gt;</span><span class="p">:</span>  <span class="no">movq</span>   <span class="p">-</span><span class="mi">0x60</span><span class="p">(</span><span class="nv">%rbp</span><span class="p">),</span> <span class="nv">%rcx</span>
    <span class="err">0</span><span class="nf">x100000ad6</span> <span class="err">&lt;+</span><span class="mi">86</span><span class="err">&gt;</span><span class="p">:</span>  <span class="no">callq</span>  <span class="mi">0x100000e42</span>               <span class="c">; symbol stub for: swift_beginAccess
</span><span class="c"></span>    <span class="c">; (lldb) po withUnsafePointer(to: &amp;foo2) { print(&#34;\($0)&#34;) } =&gt; 0x0000000100002028
</span><span class="c"></span>    <span class="c">; 将 rip + 0x1536 地址（0x100002018，即 foo1）内容（10）移动到 rax
</span><span class="c"></span>    <span class="mi">0x100000adb</span> <span class="err">&lt;+</span><span class="mi">91</span><span class="err">&gt;</span><span class="p">:</span>  <span class="no">movq</span>   <span class="mi">0x1536</span><span class="p">(</span><span class="nv">%rip</span><span class="p">),</span> <span class="nv">%rax</span>        <span class="c">; demo.foo1 : demo.Foo
</span><span class="c"></span>    <span class="c">; 将 rax 寄存器内容（10）移动到 rip + 0x153f 地址（00x100002028，即 foo2 的内存地址）
</span><span class="c"></span>    <span class="mi">0x100000ae2</span> <span class="err">&lt;+</span><span class="mi">98</span><span class="err">&gt;</span><span class="p">:</span>  <span class="no">movq</span>   <span class="nv">%rax</span><span class="p">,</span> <span class="mi">0x153f</span><span class="p">(</span><span class="nv">%rip</span><span class="p">)</span>        <span class="c">; demo.foo2 : demo.Foo
</span><span class="c"></span>    <span class="c">; 将 rip + 0x1530 地址（0x100002020）内容（11）移动到 rax
</span><span class="c"></span>    <span class="mi">0x100000ae9</span> <span class="err">&lt;+</span><span class="mi">105</span><span class="err">&gt;</span><span class="p">:</span> <span class="no">movq</span>   <span class="mi">0x1530</span><span class="p">(</span><span class="nv">%rip</span><span class="p">),</span> <span class="nv">%rax</span>        <span class="c">; demo.foo1 : demo.Foo + 8
</span><span class="c"></span>    <span class="c">; 将 rax 寄存器内容（11）移动到 rip + 0x1539 地址（0x100002030）
</span><span class="c"></span>    <span class="mi">0x100000af0</span> <span class="err">&lt;+</span><span class="mi">112</span><span class="err">&gt;</span><span class="p">:</span> <span class="no">movq</span>   <span class="nv">%rax</span><span class="p">,</span> <span class="mi">0x1539</span><span class="p">(</span><span class="nv">%rip</span><span class="p">)</span>        <span class="c">; demo.foo2 : demo.Foo + 8
</span><span class="c"></span>    <span class="mi">0x100000af7</span> <span class="err">&lt;+</span><span class="mi">119</span><span class="err">&gt;</span><span class="p">:</span> <span class="no">leaq</span>   <span class="p">-</span><span class="mi">0x18</span><span class="p">(</span><span class="nv">%rbp</span><span class="p">),</span> <span class="nv">%rdi</span>
    <span class="err">0</span><span class="nf">x100000afb</span> <span class="err">&lt;+</span><span class="mi">123</span><span class="err">&gt;</span><span class="p">:</span> <span class="no">callq</span>  <span class="mi">0x100000e48</span>               <span class="c">; symbol stub for: swift_endAccess
</span><span class="c"></span>    <span class="mi">0x100000b00</span> <span class="err">&lt;+</span><span class="mi">128</span><span class="err">&gt;</span><span class="p">:</span> <span class="no">leaq</span>   <span class="mi">0x1521</span><span class="p">(</span><span class="nv">%rip</span><span class="p">),</span> <span class="nv">%rax</span>        <span class="c">; demo.foo2 : demo.Foo
</span><span class="c"></span>    <span class="mi">0x100000b07</span> <span class="err">&lt;+</span><span class="mi">135</span><span class="err">&gt;</span><span class="p">:</span> <span class="no">xorl</span>   <span class="nv">%r8d</span><span class="p">,</span> <span class="nv">%r8d</span>
    <span class="err">0</span><span class="nf">x100000b0a</span> <span class="err">&lt;+</span><span class="mi">138</span><span class="err">&gt;</span><span class="p">:</span> <span class="no">movl</span>   <span class="nv">%r8d</span><span class="p">,</span> <span class="nv">%ecx</span>
    <span class="err">0</span><span class="nf">x100000b0d</span> <span class="err">&lt;+</span><span class="mi">141</span><span class="err">&gt;</span><span class="p">:</span> <span class="no">movq</span>   <span class="nv">%rax</span><span class="p">,</span> <span class="nv">%rdi</span>
    <span class="err">0</span><span class="nf">x100000b10</span> <span class="err">&lt;+</span><span class="mi">144</span><span class="err">&gt;</span><span class="p">:</span> <span class="no">leaq</span>   <span class="p">-</span><span class="mi">0x30</span><span class="p">(</span><span class="nv">%rbp</span><span class="p">),</span> <span class="nv">%rsi</span>
    <span class="err">0</span><span class="nf">x100000b14</span> <span class="err">&lt;+</span><span class="mi">148</span><span class="err">&gt;</span><span class="p">:</span> <span class="no">movl</span>   <span class="no">$0x21</span><span class="p">,</span> <span class="nv">%edx</span>
    <span class="err">0</span><span class="nf">x100000b19</span> <span class="err">&lt;+</span><span class="mi">153</span><span class="err">&gt;</span><span class="p">:</span> <span class="no">callq</span>  <span class="mi">0x100000e42</span>               <span class="c">; symbol stub for: swift_beginAccess
</span><span class="c"></span>    <span class="c">; 将立即数 20 移动到 rip + 0x14ff 寄存器（0x100002028，foo2.a）
</span><span class="c"></span>    <span class="mi">0x100000b1e</span> <span class="err">&lt;+</span><span class="mi">158</span><span class="err">&gt;</span><span class="p">:</span> <span class="no">movq</span>   <span class="no">$0x14</span><span class="p">,</span> <span class="mi">0x14ff</span><span class="p">(</span><span class="nv">%rip</span><span class="p">)</span>       <span class="c">; demo.foo1 : demo.Foo + 12
</span><span class="c"></span>    <span class="mi">0x100000b29</span> <span class="err">&lt;+</span><span class="mi">169</span><span class="err">&gt;</span><span class="p">:</span> <span class="no">leaq</span>   <span class="p">-</span><span class="mi">0x30</span><span class="p">(</span><span class="nv">%rbp</span><span class="p">),</span> <span class="nv">%rdi</span>
    <span class="err">0</span><span class="nf">x100000b2d</span> <span class="err">&lt;+</span><span class="mi">173</span><span class="err">&gt;</span><span class="p">:</span> <span class="no">callq</span>  <span class="mi">0x100000e48</span>               <span class="c">; symbol stub for: swift_endAccess
</span><span class="c"></span>    <span class="mi">0x100000b32</span> <span class="err">&lt;+</span><span class="mi">178</span><span class="err">&gt;</span><span class="p">:</span> <span class="no">leaq</span>   <span class="mi">0x14ef</span><span class="p">(</span><span class="nv">%rip</span><span class="p">),</span> <span class="nv">%rax</span>        <span class="c">; demo.foo2 : demo.Foo
</span><span class="c"></span>    <span class="mi">0x100000b39</span> <span class="err">&lt;+</span><span class="mi">185</span><span class="err">&gt;</span><span class="p">:</span> <span class="no">xorl</span>   <span class="nv">%r8d</span><span class="p">,</span> <span class="nv">%r8d</span>
    <span class="err">0</span><span class="nf">x100000b3c</span> <span class="err">&lt;+</span><span class="mi">188</span><span class="err">&gt;</span><span class="p">:</span> <span class="no">movl</span>   <span class="nv">%r8d</span><span class="p">,</span> <span class="nv">%ecx</span>
    <span class="err">0</span><span class="nf">x100000b3f</span> <span class="err">&lt;+</span><span class="mi">191</span><span class="err">&gt;</span><span class="p">:</span> <span class="no">movq</span>   <span class="nv">%rax</span><span class="p">,</span> <span class="nv">%rdi</span>
    <span class="err">0</span><span class="nf">x100000b42</span> <span class="err">&lt;+</span><span class="mi">194</span><span class="err">&gt;</span><span class="p">:</span> <span class="no">leaq</span>   <span class="p">-</span><span class="mi">0x48</span><span class="p">(</span><span class="nv">%rbp</span><span class="p">),</span> <span class="nv">%rsi</span>
    <span class="err">0</span><span class="nf">x100000b46</span> <span class="err">&lt;+</span><span class="mi">198</span><span class="err">&gt;</span><span class="p">:</span> <span class="no">movl</span>   <span class="no">$0x21</span><span class="p">,</span> <span class="nv">%edx</span>
    <span class="err">0</span><span class="nf">x100000b4b</span> <span class="err">&lt;+</span><span class="mi">203</span><span class="err">&gt;</span><span class="p">:</span> <span class="no">callq</span>  <span class="mi">0x100000e42</span>               <span class="c">; symbol stub for: swift_beginAccess
</span><span class="c"></span>     <span class="c">; 将立即数 22 移动到 rip + 0x14d5 寄存器（0x100002030，foo2.b）
</span><span class="c"></span>    <span class="mi">0x100000b50</span> <span class="err">&lt;+</span><span class="mi">208</span><span class="err">&gt;</span><span class="p">:</span> <span class="no">movq</span>   <span class="no">$0x16</span><span class="p">,</span> <span class="mi">0x14d5</span><span class="p">(</span><span class="nv">%rip</span><span class="p">)</span>       <span class="c">; demo.foo2 : demo.Foo + 4
</span><span class="c"></span>    <span class="mi">0x100000b5b</span> <span class="err">&lt;+</span><span class="mi">219</span><span class="err">&gt;</span><span class="p">:</span> <span class="no">leaq</span>   <span class="p">-</span><span class="mi">0x48</span><span class="p">(</span><span class="nv">%rbp</span><span class="p">),</span> <span class="nv">%rdi</span>
    <span class="err">0</span><span class="nf">x100000b5f</span> <span class="err">&lt;+</span><span class="mi">223</span><span class="err">&gt;</span><span class="p">:</span> <span class="no">callq</span>  <span class="mi">0x100000e48</span>               <span class="c">; symbol stub for: swift_endAccess
</span><span class="c"></span>    <span class="mi">0x100000b64</span> <span class="err">&lt;+</span><span class="mi">228</span><span class="err">&gt;</span><span class="p">:</span> <span class="no">xorl</span>   <span class="nv">%eax</span><span class="p">,</span> <span class="nv">%eax</span>
    <span class="err">0</span><span class="nf">x100000b66</span> <span class="err">&lt;+</span><span class="mi">230</span><span class="err">&gt;</span><span class="p">:</span> <span class="no">addq</span>   <span class="no">$0x60</span><span class="p">,</span> <span class="nv">%rsp</span>
    <span class="err">0</span><span class="nf">x100000b6a</span> <span class="err">&lt;+</span><span class="mi">234</span><span class="err">&gt;</span><span class="p">:</span> <span class="no">popq</span>   <span class="nv">%rbp</span>
    <span class="err">0</span><span class="nf">x100000b6b</span> <span class="err">&lt;+</span><span class="mi">235</span><span class="err">&gt;</span><span class="p">:</span> <span class="no">retq</span>

<span class="c">; 将断点加在 `0x100000a9f &lt;+31&gt;: callq 0x100000c00` 一行，并执行 `si`，进入函数内部；
</span><span class="c">; 因为 `init` 函数是结构体本身的函数，与结构体变量所在的内存区域无关，因此这部分的汇编与之前完全相同。
</span><span class="c"></span><span class="nf">demo</span><span class="err">`</span><span class="no">Foo.init</span><span class="p">(</span><span class="no">a</span><span class="err">🅱️</span><span class="p">):</span>
<span class="err">-&gt;</span>  <span class="err">0</span><span class="nf">x100000c00</span> <span class="err">&lt;+</span><span class="mi">0</span><span class="err">&gt;</span><span class="p">:</span>  <span class="no">pushq</span>  <span class="nv">%rbp</span>
    <span class="err">0</span><span class="nf">x100000c01</span> <span class="err">&lt;+</span><span class="mi">1</span><span class="err">&gt;</span><span class="p">:</span>  <span class="no">movq</span>   <span class="nv">%rsp</span><span class="p">,</span> <span class="nv">%rbp</span>
    <span class="c">; 将参数放在函数内部的栈空间：
</span><span class="c"></span>    <span class="c">; 将 rdi 寄存器内容（10）移动到 rax 寄存器
</span><span class="c"></span>    <span class="err">0</span><span class="nf">x100000c04</span> <span class="err">&lt;+</span><span class="mi">4</span><span class="err">&gt;</span><span class="p">:</span>  <span class="no">movq</span>   <span class="nv">%rdi</span><span class="p">,</span> <span class="nv">%rax</span>
    <span class="c">; 将 rsi 寄存器内容（11）移动到 rdx 寄存器
</span><span class="c"></span>    <span class="err">0</span><span class="nf">x100000c07</span> <span class="err">&lt;+</span><span class="mi">7</span><span class="err">&gt;</span><span class="p">:</span>  <span class="no">movq</span>   <span class="nv">%rsi</span><span class="p">,</span> <span class="nv">%rdx</span>
    <span class="err">0</span><span class="nf">x100000c0a</span> <span class="err">&lt;+</span><span class="mi">10</span><span class="err">&gt;</span><span class="p">:</span> <span class="no">popq</span>   <span class="nv">%rbp</span>
    <span class="err">0</span><span class="nf">x100000c0b</span> <span class="err">&lt;+</span><span class="mi">11</span><span class="err">&gt;</span><span class="p">:</span> <span class="no">retq</span>
</code></pre></div><p>与刚才在函数体内的栈区不同的是，全局区（数据段）大量使用了 <code>rip</code> 寄存器。<code>rip</code> 作为指令指针寄存器，存储着 CPU 下一条要执行的指令的地址，一旦 CPU 读取一条指令，<code>rip</code> 会自动指向下一条指令。而代码一旦装载，每条指令的地址就会得以确认，因此通常使用 <code>rip</code> 加偏移的地址来存放全局变量。</p>
<h3 id="class">class</h3>
<h4 id="分配在栈区-1">分配在栈区</h4>
<div class="highlight"><pre class="chroma"><code class="language-swift" data-lang="swift"><span class="c1">// main.swift</span>

<span class="kd">class</span> <span class="nc">Foo</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nv">a</span><span class="p">:</span> <span class="nb">Int</span>
    <span class="kd">var</span> <span class="nv">b</span><span class="p">:</span> <span class="nb">Int</span>

    <span class="kd">init</span><span class="p">(</span><span class="n">a</span><span class="p">:</span> <span class="nb">Int</span><span class="p">,</span> <span class="n">b</span><span class="p">:</span> <span class="nb">Int</span><span class="p">)</span> <span class="p">{</span>
        <span class="kc">self</span><span class="p">.</span><span class="n">a</span> <span class="p">=</span> <span class="n">a</span>
        <span class="kc">self</span><span class="p">.</span><span class="n">b</span> <span class="p">=</span> <span class="n">b</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="nf">bar</span><span class="p">()</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nv">foo1</span> <span class="p">=</span> <span class="n">Foo</span><span class="p">(</span><span class="n">a</span><span class="p">:</span> <span class="mi">10</span><span class="p">,</span> <span class="n">b</span><span class="p">:</span> <span class="mi">11</span><span class="p">)</span>
    <span class="kd">var</span> <span class="nv">foo2</span> <span class="p">=</span> <span class="n">foo1</span> <span class="c1">// BREAKPOINT 🔴</span>

    <span class="n">foo2</span><span class="p">.</span><span class="n">a</span> <span class="p">=</span> <span class="mi">20</span>
    <span class="n">foo2</span><span class="p">.</span><span class="n">b</span> <span class="p">=</span> <span class="mi">22</span>
<span class="p">}</span>

<span class="n">bar</span><span class="p">()</span>
</code></pre></div><div class="highlight"><pre class="chroma"><code class="language-asm" data-lang="asm"><span class="nf">demo</span><span class="err">`</span><span class="no">bar</span><span class="p">():</span>
    <span class="err">0</span><span class="nf">x100001cc0</span> <span class="err">&lt;+</span><span class="mi">0</span><span class="err">&gt;</span><span class="p">:</span>   <span class="no">pushq</span>  <span class="nv">%rbp</span>
    <span class="err">0</span><span class="nf">x100001cc1</span> <span class="err">&lt;+</span><span class="mi">1</span><span class="err">&gt;</span><span class="p">:</span>   <span class="no">movq</span>   <span class="nv">%rsp</span><span class="p">,</span> <span class="nv">%rbp</span>
    <span class="err">0</span><span class="nf">x100001cc4</span> <span class="err">&lt;+</span><span class="mi">4</span><span class="err">&gt;</span><span class="p">:</span>   <span class="no">pushq</span>  <span class="nv">%r13</span>
    <span class="err">0</span><span class="nf">x100001cc6</span> <span class="err">&lt;+</span><span class="mi">6</span><span class="err">&gt;</span><span class="p">:</span>   <span class="no">subq</span>   <span class="no">$0x38</span><span class="p">,</span> <span class="nv">%rsp</span>
    <span class="err">0</span><span class="nf">x100001cca</span> <span class="err">&lt;+</span><span class="mi">10</span><span class="err">&gt;</span><span class="p">:</span>  <span class="no">movq</span>   <span class="no">$0x0</span><span class="p">,</span> <span class="p">-</span><span class="mi">0x10</span><span class="p">(</span><span class="nv">%rbp</span><span class="p">)</span>
    <span class="err">0</span><span class="nf">x100001cd2</span> <span class="err">&lt;+</span><span class="mi">18</span><span class="err">&gt;</span><span class="p">:</span>  <span class="no">movq</span>   <span class="no">$0x0</span><span class="p">,</span> <span class="p">-</span><span class="mi">0x18</span><span class="p">(</span><span class="nv">%rbp</span><span class="p">)</span>
    <span class="err">0</span><span class="nf">x100001cda</span> <span class="err">&lt;+</span><span class="mi">26</span><span class="err">&gt;</span><span class="p">:</span>  <span class="no">xorl</span>   <span class="nv">%eax</span><span class="p">,</span> <span class="nv">%eax</span>
    <span class="err">0</span><span class="nf">x100001cdc</span> <span class="err">&lt;+</span><span class="mi">28</span><span class="err">&gt;</span><span class="p">:</span>  <span class="no">movl</span>   <span class="nv">%eax</span><span class="p">,</span> <span class="nv">%edi</span>
    <span class="err">0</span><span class="nf">x100001cde</span> <span class="err">&lt;+</span><span class="mi">30</span><span class="err">&gt;</span><span class="p">:</span>  <span class="no">callq</span>  <span class="mi">0x100001d90</span>               <span class="c">; type metadata accessor for demo.Foo at &lt;compiler-generated&gt;
</span><span class="c"></span>    <span class="c">; 函数调用前要先传递参数：
</span><span class="c"></span>    <span class="c">; 将立即数 10 移动到 edi 寄存器（即 rdi 寄存器低 32 位）
</span><span class="c"></span>    <span class="mi">0x100001ce3</span> <span class="err">&lt;+</span><span class="mi">35</span><span class="err">&gt;</span><span class="p">:</span>  <span class="no">movl</span>   <span class="no">$0xa</span><span class="p">,</span> <span class="nv">%edi</span>
    <span class="c">; 将立即数 11 移动到 esi 寄存器（即 rsi 寄存器低 32 位）
</span><span class="c"></span>    <span class="err">0</span><span class="nf">x100001ce8</span> <span class="err">&lt;+</span><span class="mi">40</span><span class="err">&gt;</span><span class="p">:</span>  <span class="no">movl</span>   <span class="no">$0xb</span><span class="p">,</span> <span class="nv">%esi</span>
    <span class="err">0</span><span class="nf">x100001ced</span> <span class="err">&lt;+</span><span class="mi">45</span><span class="err">&gt;</span><span class="p">:</span>  <span class="no">movq</span>   <span class="nv">%rax</span><span class="p">,</span> <span class="nv">%r13</span>
    <span class="err">0</span><span class="nf">x100001cf0</span> <span class="err">&lt;+</span><span class="mi">48</span><span class="err">&gt;</span><span class="p">:</span>  <span class="no">movq</span>   <span class="nv">%rdx</span><span class="p">,</span> <span class="p">-</span><span class="mi">0x20</span><span class="p">(</span><span class="nv">%rbp</span><span class="p">)</span>
    <span class="c">; 构造函数调用：
</span><span class="c"></span>    <span class="err">0</span><span class="nf">x100001cf4</span> <span class="err">&lt;+</span><span class="mi">52</span><span class="err">&gt;</span><span class="p">:</span>  <span class="no">callq</span>  <span class="mi">0x100001b50</span>               <span class="c">; demo.Foo.__allocating_init(a: Swift.Int, b: Swift.Int) -&gt; demo.Foo at main.swift:7
</span><span class="c"></span>    <span class="c">; rax 寄存器通常放置函数返回值（详见下文），这里即 foo1 指针所指向的堆空间内存地址
</span><span class="c"></span>    <span class="c">; (lldb) register read rax =&gt; rax = 0x000000010046d080
</span><span class="c"></span>    <span class="c">; (lldb) x --size 8 --format x --count 4 0x000000010046d080
</span><span class="c"></span>    <span class="c">; 0x10046d080: 0x0000000100003150 0x0000000000000002
</span><span class="c"></span>    <span class="c">; 0x10046d090: 0x000000000000000a 0x000000000000000b
</span><span class="c"></span>    <span class="c">; 此时可以尝试读取 foo1 的内存地址（指针本身的内存地址，位于栈空间）
</span><span class="c"></span>    <span class="c">; (lldb) po withUnsafeMutablePointer(to: &amp;foo1) { print(&#34;\($0)&#34;) } =&gt; 0x00007ffeefbff510
</span><span class="c"></span>    <span class="c">; (lldb) po withUnsafeMutablePointer(to: &amp;foo2) { print(&#34;\($0)&#34;) } =&gt; 0x00007ffeefbff508
</span><span class="c"></span>    <span class="mi">0x100001cf9</span> <span class="err">&lt;+</span><span class="mi">57</span><span class="err">&gt;</span><span class="p">:</span>  <span class="no">movq</span>   <span class="nv">%rax</span><span class="p">,</span> <span class="nv">%rdi</span>
    <span class="c">; 将 rax 寄存器内容（0x000000010046d080）移动到 rbp - 0x28 地址
</span><span class="c"></span>    <span class="err">0</span><span class="nf">x100001cfc</span> <span class="err">&lt;+</span><span class="mi">60</span><span class="err">&gt;</span><span class="p">:</span>  <span class="no">movq</span>   <span class="nv">%rax</span><span class="p">,</span> <span class="p">-</span><span class="mi">0x28</span><span class="p">(</span><span class="nv">%rbp</span><span class="p">)</span>
    <span class="err">0</span><span class="nf">x100001d00</span> <span class="err">&lt;+</span><span class="mi">64</span><span class="err">&gt;</span><span class="p">:</span>  <span class="no">callq</span>  <span class="mi">0x100001df6</span>               <span class="c">; symbol stub for: swift_retain
</span><span class="c"></span>    <span class="c">; 将 rbp - 0x28 地址内容（0x000000010046d080）移动到 rcx 寄存器
</span><span class="c"></span>    <span class="mi">0x100001d05</span> <span class="err">&lt;+</span><span class="mi">69</span><span class="err">&gt;</span><span class="p">:</span>  <span class="no">movq</span>   <span class="p">-</span><span class="mi">0x28</span><span class="p">(</span><span class="nv">%rbp</span><span class="p">),</span> <span class="nv">%rcx</span>
    <span class="c">; (lldb) register read rbp =&gt; rbp = 0x00007ffeefbff520
</span><span class="c"></span>    <span class="c">; 将 rcx 寄存器内容（0x000000010046d080）移动到 rbp - 0x10 地址（0x7FFEEFBFF510，即 foo1）
</span><span class="c"></span>    <span class="err">0</span><span class="nf">x100001d09</span> <span class="err">&lt;+</span><span class="mi">73</span><span class="err">&gt;</span><span class="p">:</span>  <span class="no">movq</span>   <span class="nv">%rcx</span><span class="p">,</span> <span class="p">-</span><span class="mi">0x10</span><span class="p">(</span><span class="nv">%rbp</span><span class="p">)</span>
    <span class="c">; (lldb) x --size 8 --format x --count 4 0x7FFEEFBFF510
</span><span class="c"></span>    <span class="c">; 0x7ffeefbff510: 0x000000010046d080 0x0000000000000000
</span><span class="c"></span>    <span class="c">; 0x7ffeefbff520: 0x00007ffeefbff540 0x00000001000017a4
</span><span class="c"></span><span class="err">-&gt;</span>  <span class="err">0</span><span class="nf">x100001d0d</span> <span class="err">&lt;+</span><span class="mi">77</span><span class="err">&gt;</span><span class="p">:</span>  <span class="no">movq</span>   <span class="nv">%rcx</span><span class="p">,</span> <span class="nv">%rdi</span>
    <span class="err">0</span><span class="nf">x100001d10</span> <span class="err">&lt;+</span><span class="mi">80</span><span class="err">&gt;</span><span class="p">:</span>  <span class="no">movq</span>   <span class="nv">%rax</span><span class="p">,</span> <span class="p">-</span><span class="mi">0x30</span><span class="p">(</span><span class="nv">%rbp</span><span class="p">)</span>
    <span class="err">0</span><span class="nf">x100001d14</span> <span class="err">&lt;+</span><span class="mi">84</span><span class="err">&gt;</span><span class="p">:</span>  <span class="no">callq</span>  <span class="mi">0x100001df6</span>               <span class="c">; symbol stub for: swift_retain
</span><span class="c"></span>    <span class="mi">0x100001d19</span> <span class="err">&lt;+</span><span class="mi">89</span><span class="err">&gt;</span><span class="p">:</span>  <span class="no">movq</span>   <span class="p">-</span><span class="mi">0x28</span><span class="p">(</span><span class="nv">%rbp</span><span class="p">),</span> <span class="nv">%rdi</span>
    <span class="err">0</span><span class="nf">x100001d1d</span> <span class="err">&lt;+</span><span class="mi">93</span><span class="err">&gt;</span><span class="p">:</span>  <span class="no">movq</span>   <span class="nv">%rax</span><span class="p">,</span> <span class="p">-</span><span class="mi">0x38</span><span class="p">(</span><span class="nv">%rbp</span><span class="p">)</span>
    <span class="err">0</span><span class="nf">x100001d21</span> <span class="err">&lt;+</span><span class="mi">97</span><span class="err">&gt;</span><span class="p">:</span>  <span class="no">callq</span>  <span class="mi">0x100001df6</span>               <span class="c">; symbol stub for: swift_retain
</span><span class="c"></span>    <span class="c">; 将 rbp - 0x28 地址内容（0x000000010046d080）移动到 rcx 寄存器
</span><span class="c"></span>    <span class="mi">0x100001d26</span> <span class="err">&lt;+</span><span class="mi">102</span><span class="err">&gt;</span><span class="p">:</span> <span class="no">movq</span>   <span class="p">-</span><span class="mi">0x28</span><span class="p">(</span><span class="nv">%rbp</span><span class="p">),</span> <span class="nv">%rcx</span>
    <span class="c">; 将 rcx 寄存器内容（0x000000010046d080）移动到 rbp - 0x18 地址（0x7FFEEFBFF508，即 foo2）
</span><span class="c"></span>    <span class="err">0</span><span class="nf">x100001d2a</span> <span class="err">&lt;+</span><span class="mi">106</span><span class="err">&gt;</span><span class="p">:</span> <span class="no">movq</span>   <span class="nv">%rcx</span><span class="p">,</span> <span class="p">-</span><span class="mi">0x18</span><span class="p">(</span><span class="nv">%rbp</span><span class="p">)</span>
    <span class="c">; (lldb) x --size 8 --format x --count 4 0x7FFEEFBFF508
</span><span class="c"></span>    <span class="c">; 0x7ffeefbff508: 0x000000010046d080 0x000000010046d080
</span><span class="c"></span>    <span class="c">; 0x7ffeefbff518: 0x0000000000000000 0x00007ffeefbff540
</span><span class="c"></span>    <span class="c">; 因此此时，foo1 和 foo2 中存储了相同的内存地址
</span><span class="c"></span>    <span class="err">0</span><span class="nf">x100001d2e</span> <span class="err">&lt;+</span><span class="mi">110</span><span class="err">&gt;</span><span class="p">:</span> <span class="no">movq</span>   <span class="p">(</span><span class="nv">%rcx</span><span class="p">),</span> <span class="nv">%rdx</span>
    <span class="err">0</span><span class="nf">x100001d31</span> <span class="err">&lt;+</span><span class="mi">113</span><span class="err">&gt;</span><span class="p">:</span> <span class="no">movq</span>   <span class="mi">0x68</span><span class="p">(</span><span class="nv">%rdx</span><span class="p">),</span> <span class="nv">%rdx</span>
    <span class="c">; 将立即数 20 移动到 edi 寄存器
</span><span class="c"></span>    <span class="err">0</span><span class="nf">x100001d35</span> <span class="err">&lt;+</span><span class="mi">117</span><span class="err">&gt;</span><span class="p">:</span> <span class="no">movl</span>   <span class="no">$0x14</span><span class="p">,</span> <span class="nv">%edi</span>
    <span class="err">0</span><span class="nf">x100001d3a</span> <span class="err">&lt;+</span><span class="mi">122</span><span class="err">&gt;</span><span class="p">:</span> <span class="no">movq</span>   <span class="nv">%rcx</span><span class="p">,</span> <span class="nv">%r13</span>
    <span class="err">0</span><span class="nf">x100001d3d</span> <span class="err">&lt;+</span><span class="mi">125</span><span class="err">&gt;</span><span class="p">:</span> <span class="no">movq</span>   <span class="nv">%rax</span><span class="p">,</span> <span class="p">-</span><span class="mi">0x40</span><span class="p">(</span><span class="nv">%rbp</span><span class="p">)</span>
    <span class="c">; 见下文
</span><span class="c"></span>    <span class="err">0</span><span class="nf">x100001d41</span> <span class="err">&lt;+</span><span class="mi">129</span><span class="err">&gt;</span><span class="p">:</span> <span class="no">callq</span>  <span class="p">*</span><span class="nv">%rdx</span>
    <span class="err">0</span><span class="nf">x100001d43</span> <span class="err">&lt;+</span><span class="mi">131</span><span class="err">&gt;</span><span class="p">:</span> <span class="no">movq</span>   <span class="p">-</span><span class="mi">0x28</span><span class="p">(</span><span class="nv">%rbp</span><span class="p">),</span> <span class="nv">%rdi</span>
    <span class="err">0</span><span class="nf">x100001d47</span> <span class="err">&lt;+</span><span class="mi">135</span><span class="err">&gt;</span><span class="p">:</span> <span class="no">callq</span>  <span class="mi">0x100001df0</span>               <span class="c">; symbol stub for: swift_release
</span><span class="c"></span>    <span class="mi">0x100001d4c</span> <span class="err">&lt;+</span><span class="mi">140</span><span class="err">&gt;</span><span class="p">:</span> <span class="no">movq</span>   <span class="p">-</span><span class="mi">0x28</span><span class="p">(</span><span class="nv">%rbp</span><span class="p">),</span> <span class="nv">%rax</span>
    <span class="err">0</span><span class="nf">x100001d50</span> <span class="err">&lt;+</span><span class="mi">144</span><span class="err">&gt;</span><span class="p">:</span> <span class="no">movq</span>   <span class="p">(</span><span class="nv">%rax</span><span class="p">),</span> <span class="nv">%rcx</span>
    <span class="err">0</span><span class="nf">x100001d53</span> <span class="err">&lt;+</span><span class="mi">147</span><span class="err">&gt;</span><span class="p">:</span> <span class="no">movq</span>   <span class="mi">0x80</span><span class="p">(</span><span class="nv">%rcx</span><span class="p">),</span> <span class="nv">%rcx</span>
    <span class="c">; 将立即数 22 移动到 edi 寄存器（同理）
</span><span class="c"></span>    <span class="err">0</span><span class="nf">x100001d5a</span> <span class="err">&lt;+</span><span class="mi">154</span><span class="err">&gt;</span><span class="p">:</span> <span class="no">movl</span>   <span class="no">$0x16</span><span class="p">,</span> <span class="nv">%edi</span>
    <span class="err">0</span><span class="nf">x100001d5f</span> <span class="err">&lt;+</span><span class="mi">159</span><span class="err">&gt;</span><span class="p">:</span> <span class="no">movq</span>   <span class="nv">%rax</span><span class="p">,</span> <span class="nv">%r13</span>
    <span class="err">0</span><span class="nf">x100001d62</span> <span class="err">&lt;+</span><span class="mi">162</span><span class="err">&gt;</span><span class="p">:</span> <span class="no">callq</span>  <span class="p">*</span><span class="nv">%rcx</span>
    <span class="err">0</span><span class="nf">x100001d64</span> <span class="err">&lt;+</span><span class="mi">164</span><span class="err">&gt;</span><span class="p">:</span> <span class="no">movq</span>   <span class="p">-</span><span class="mi">0x28</span><span class="p">(</span><span class="nv">%rbp</span><span class="p">),</span> <span class="nv">%rdi</span>
    <span class="err">0</span><span class="nf">x100001d68</span> <span class="err">&lt;+</span><span class="mi">168</span><span class="err">&gt;</span><span class="p">:</span> <span class="no">callq</span>  <span class="mi">0x100001df0</span>               <span class="c">; symbol stub for: swift_release
</span><span class="c"></span>    <span class="mi">0x100001d6d</span> <span class="err">&lt;+</span><span class="mi">173</span><span class="err">&gt;</span><span class="p">:</span> <span class="no">movq</span>   <span class="p">-</span><span class="mi">0x18</span><span class="p">(</span><span class="nv">%rbp</span><span class="p">),</span> <span class="nv">%rdi</span>
    <span class="err">0</span><span class="nf">x100001d71</span> <span class="err">&lt;+</span><span class="mi">177</span><span class="err">&gt;</span><span class="p">:</span> <span class="no">callq</span>  <span class="mi">0x100001df0</span>               <span class="c">; symbol stub for: swift_release
</span><span class="c"></span>    <span class="mi">0x100001d76</span> <span class="err">&lt;+</span><span class="mi">182</span><span class="err">&gt;</span><span class="p">:</span> <span class="no">movq</span>   <span class="p">-</span><span class="mi">0x10</span><span class="p">(</span><span class="nv">%rbp</span><span class="p">),</span> <span class="nv">%rdi</span>
    <span class="err">0</span><span class="nf">x100001d7a</span> <span class="err">&lt;+</span><span class="mi">186</span><span class="err">&gt;</span><span class="p">:</span> <span class="no">callq</span>  <span class="mi">0x100001df0</span>               <span class="c">; symbol stub for: swift_release
</span><span class="c"></span>    <span class="mi">0x100001d7f</span> <span class="err">&lt;+</span><span class="mi">191</span><span class="err">&gt;</span><span class="p">:</span> <span class="no">addq</span>   <span class="no">$0x38</span><span class="p">,</span> <span class="nv">%rsp</span>
    <span class="err">0</span><span class="nf">x100001d83</span> <span class="err">&lt;+</span><span class="mi">195</span><span class="err">&gt;</span><span class="p">:</span> <span class="no">popq</span>   <span class="nv">%r13</span>
    <span class="err">0</span><span class="nf">x100001d85</span> <span class="err">&lt;+</span><span class="mi">197</span><span class="err">&gt;</span><span class="p">:</span> <span class="no">popq</span>   <span class="nv">%rbp</span>
    <span class="err">0</span><span class="nf">x100001d86</span> <span class="err">&lt;+</span><span class="mi">198</span><span class="err">&gt;</span><span class="p">:</span> <span class="no">retq</span>

<span class="c">; 将断点加在 `0x100000a9f &lt;+31&gt;: callq 0x100000c00` 一行，并执行 `si`，进入函数内部：
</span><span class="c"></span><span class="nf">demo</span><span class="err">`</span><span class="no">Foo.__allocating_init</span><span class="p">(</span><span class="no">a</span><span class="err">🅱️</span><span class="p">):</span>
<span class="err">-&gt;</span>  <span class="err">0</span><span class="nf">x100001b50</span> <span class="err">&lt;+</span><span class="mi">0</span><span class="err">&gt;</span><span class="p">:</span>  <span class="no">pushq</span>  <span class="nv">%rbp</span>
    <span class="err">0</span><span class="nf">x100001b51</span> <span class="err">&lt;+</span><span class="mi">1</span><span class="err">&gt;</span><span class="p">:</span>  <span class="no">movq</span>   <span class="nv">%rsp</span><span class="p">,</span> <span class="nv">%rbp</span>
    <span class="err">0</span><span class="nf">x100001b54</span> <span class="err">&lt;+</span><span class="mi">4</span><span class="err">&gt;</span><span class="p">:</span>  <span class="no">pushq</span>  <span class="nv">%r13</span>
    <span class="err">0</span><span class="nf">x100001b56</span> <span class="err">&lt;+</span><span class="mi">6</span><span class="err">&gt;</span><span class="p">:</span>  <span class="no">subq</span>   <span class="no">$0x18</span><span class="p">,</span> <span class="nv">%rsp</span>
    <span class="err">0</span><span class="nf">x100001b5a</span> <span class="err">&lt;+</span><span class="mi">10</span><span class="err">&gt;</span><span class="p">:</span> <span class="no">movl</span>   <span class="no">$0x20</span><span class="p">,</span> <span class="nv">%eax</span>
    <span class="err">0</span><span class="nf">x100001b5f</span> <span class="err">&lt;+</span><span class="mi">15</span><span class="err">&gt;</span><span class="p">:</span> <span class="no">movl</span>   <span class="no">$0x7</span><span class="p">,</span> <span class="nv">%edx</span>
    <span class="c">; (lldb) register read rdi =&gt; rdi = 0x000000000000000a
</span><span class="c"></span>    <span class="c">; (lldb) register read rsi =&gt; rsi = 0x000000000000000b
</span><span class="c"></span>    <span class="c">; (lldb) register read rbp =&gt; rbp = 0x00007ffeefbff4d0
</span><span class="c"></span>    <span class="c">; 将 rdi 寄存器内容（10）移动到 rbp - 0x10 地址（0x7FFEEFBFF4C0）
</span><span class="c"></span>    <span class="err">0</span><span class="nf">x100001b64</span> <span class="err">&lt;+</span><span class="mi">20</span><span class="err">&gt;</span><span class="p">:</span> <span class="no">movq</span>   <span class="nv">%rdi</span><span class="p">,</span> <span class="p">-</span><span class="mi">0x10</span><span class="p">(</span><span class="nv">%rbp</span><span class="p">)</span>
    <span class="err">0</span><span class="nf">x100001b68</span> <span class="err">&lt;+</span><span class="mi">24</span><span class="err">&gt;</span><span class="p">:</span> <span class="no">movq</span>   <span class="nv">%r13</span><span class="p">,</span> <span class="nv">%rdi</span>
    <span class="c">; 将 rsi 寄存器内容（11）移动到 rbp - 0x18 地址（0x7FFEEFBFF4B8）
</span><span class="c"></span>    <span class="err">0</span><span class="nf">x100001b6b</span> <span class="err">&lt;+</span><span class="mi">27</span><span class="err">&gt;</span><span class="p">:</span> <span class="no">movq</span>   <span class="nv">%rsi</span><span class="p">,</span> <span class="p">-</span><span class="mi">0x18</span><span class="p">(</span><span class="nv">%rbp</span><span class="p">)</span>
    <span class="err">0</span><span class="nf">x100001b6f</span> <span class="err">&lt;+</span><span class="mi">31</span><span class="err">&gt;</span><span class="p">:</span> <span class="no">movq</span>   <span class="nv">%rax</span><span class="p">,</span> <span class="nv">%rsi</span>
    <span class="err">0</span><span class="nf">x100001b72</span> <span class="err">&lt;+</span><span class="mi">34</span><span class="err">&gt;</span><span class="p">:</span> <span class="no">callq</span>  <span class="mi">0x100001dd2</span>               <span class="c">; symbol stub for: swift_allocObject
</span><span class="c"></span>    <span class="c">; 将 rbp - 0x10 地址内容（10）移动到 rdi
</span><span class="c"></span>    <span class="mi">0x100001b77</span> <span class="err">&lt;+</span><span class="mi">39</span><span class="err">&gt;</span><span class="p">:</span> <span class="no">movq</span>   <span class="p">-</span><span class="mi">0x10</span><span class="p">(</span><span class="nv">%rbp</span><span class="p">),</span> <span class="nv">%rdi</span>
    <span class="c">; 将 rbp - 0x18 地址内容（11）移动到 rsi
</span><span class="c"></span>    <span class="err">0</span><span class="nf">x100001b7b</span> <span class="err">&lt;+</span><span class="mi">43</span><span class="err">&gt;</span><span class="p">:</span> <span class="no">movq</span>   <span class="p">-</span><span class="mi">0x18</span><span class="p">(</span><span class="nv">%rbp</span><span class="p">),</span> <span class="nv">%rsi</span>
    <span class="err">0</span><span class="nf">x100001b7f</span> <span class="err">&lt;+</span><span class="mi">47</span><span class="err">&gt;</span><span class="p">:</span> <span class="no">movq</span>   <span class="nv">%rax</span><span class="p">,</span> <span class="nv">%r13</span>
    <span class="c">; 构造函数调用：
</span><span class="c"></span>    <span class="err">0</span><span class="nf">x100001b82</span> <span class="err">&lt;+</span><span class="mi">50</span><span class="err">&gt;</span><span class="p">:</span> <span class="no">callq</span>  <span class="mi">0x100001b90</span>               <span class="c">; demo.Foo.init(a: Swift.Int, b: Swift.Int) -&gt; demo.Foo at main.swift:7
</span><span class="c"></span>    <span class="mi">0x100001b87</span> <span class="err">&lt;+</span><span class="mi">55</span><span class="err">&gt;</span><span class="p">:</span> <span class="no">addq</span>   <span class="no">$0x18</span><span class="p">,</span> <span class="nv">%rsp</span>
    <span class="err">0</span><span class="nf">x100001b8b</span> <span class="err">&lt;+</span><span class="mi">59</span><span class="err">&gt;</span><span class="p">:</span> <span class="no">popq</span>   <span class="nv">%r13</span>
    <span class="err">0</span><span class="nf">x100001b8d</span> <span class="err">&lt;+</span><span class="mi">61</span><span class="err">&gt;</span><span class="p">:</span> <span class="no">popq</span>   <span class="nv">%rbp</span>
    <span class="err">0</span><span class="nf">x100001b8e</span> <span class="err">&lt;+</span><span class="mi">62</span><span class="err">&gt;</span><span class="p">:</span> <span class="no">retq</span>

<span class="c">; 将断点加在 `0x100001b82 &lt;+50&gt;: callq  0x100001b90` 一行，并执行 `si`，进入函数内部：
</span><span class="c"></span><span class="nf">demo</span><span class="err">`</span><span class="no">Foo.init</span><span class="p">(</span><span class="no">a</span><span class="err">🅱️</span><span class="p">):</span>
<span class="err">-&gt;</span>  <span class="err">0</span><span class="nf">x100001b90</span> <span class="err">&lt;+</span><span class="mi">0</span><span class="err">&gt;</span><span class="p">:</span>   <span class="no">pushq</span>  <span class="nv">%rbp</span>
    <span class="err">0</span><span class="nf">x100001b91</span> <span class="err">&lt;+</span><span class="mi">1</span><span class="err">&gt;</span><span class="p">:</span>   <span class="no">movq</span>   <span class="nv">%rsp</span><span class="p">,</span> <span class="nv">%rbp</span>
    <span class="err">0</span><span class="nf">x100001b94</span> <span class="err">&lt;+</span><span class="mi">4</span><span class="err">&gt;</span><span class="p">:</span>   <span class="no">subq</span>   <span class="no">$0x80</span><span class="p">,</span> <span class="nv">%rsp</span>
    <span class="c">; 清零：
</span><span class="c"></span>    <span class="err">0</span><span class="nf">x100001b9b</span> <span class="err">&lt;+</span><span class="mi">11</span><span class="err">&gt;</span><span class="p">:</span>  <span class="no">movq</span>   <span class="no">$0x0</span><span class="p">,</span> <span class="p">-</span><span class="mi">0x8</span><span class="p">(</span><span class="nv">%rbp</span><span class="p">)</span>
    <span class="err">0</span><span class="nf">x100001ba3</span> <span class="err">&lt;+</span><span class="mi">19</span><span class="err">&gt;</span><span class="p">:</span>  <span class="no">movq</span>   <span class="no">$0x0</span><span class="p">,</span> <span class="p">-</span><span class="mi">0x10</span><span class="p">(</span><span class="nv">%rbp</span><span class="p">)</span>
    <span class="err">0</span><span class="nf">x100001bab</span> <span class="err">&lt;+</span><span class="mi">27</span><span class="err">&gt;</span><span class="p">:</span>  <span class="no">movq</span>   <span class="no">$0x0</span><span class="p">,</span> <span class="p">-</span><span class="mi">0x18</span><span class="p">(</span><span class="nv">%rbp</span><span class="p">)</span>
    <span class="c">; 参数局部变量化：
</span><span class="c"></span>    <span class="c">; 第一个参数 10 从 rdi 转移到 rbp - 0x8 地址
</span><span class="c"></span>    <span class="err">0</span><span class="nf">x100001bb3</span> <span class="err">&lt;+</span><span class="mi">35</span><span class="err">&gt;</span><span class="p">:</span>  <span class="no">movq</span>   <span class="nv">%rdi</span><span class="p">,</span> <span class="p">-</span><span class="mi">0x8</span><span class="p">(</span><span class="nv">%rbp</span><span class="p">)</span>
    <span class="c">; 第二个参数 11 从 rsi 转移到 rbp - 0x10 地址
</span><span class="c"></span>    <span class="err">0</span><span class="nf">x100001bb7</span> <span class="err">&lt;+</span><span class="mi">39</span><span class="err">&gt;</span><span class="p">:</span>  <span class="no">movq</span>   <span class="nv">%rsi</span><span class="p">,</span> <span class="p">-</span><span class="mi">0x10</span><span class="p">(</span><span class="nv">%rbp</span><span class="p">)</span>
    <span class="c">; ...
</span><span class="c"></span>
<span class="c">; 将断点加在 `0x100001d41 &lt;+129&gt;: callq  *%rdx` 一行，并执行 `si`，进入函数内部：
</span><span class="c"></span><span class="nf">demo</span><span class="err">`</span><span class="no">Foo.a.setter</span><span class="p">:</span>
<span class="err">-&gt;</span>  <span class="err">0</span><span class="nf">x1000018d0</span> <span class="err">&lt;+</span><span class="mi">0</span><span class="err">&gt;</span><span class="p">:</span>  <span class="no">pushq</span>  <span class="nv">%rbp</span>
    <span class="err">0</span><span class="nf">x1000018d1</span> <span class="err">&lt;+</span><span class="mi">1</span><span class="err">&gt;</span><span class="p">:</span>  <span class="no">movq</span>   <span class="nv">%rsp</span><span class="p">,</span> <span class="nv">%rbp</span>
    <span class="err">0</span><span class="nf">x1000018d4</span> <span class="err">&lt;+</span><span class="mi">4</span><span class="err">&gt;</span><span class="p">:</span>  <span class="no">subq</span>   <span class="no">$0x40</span><span class="p">,</span> <span class="nv">%rsp</span>
    <span class="err">0</span><span class="nf">x1000018d8</span> <span class="err">&lt;+</span><span class="mi">8</span><span class="err">&gt;</span><span class="p">:</span>  <span class="no">movq</span>   <span class="nv">%r13</span><span class="p">,</span> <span class="nv">%rax</span>
    <span class="err">0</span><span class="nf">x1000018db</span> <span class="err">&lt;+</span><span class="mi">11</span><span class="err">&gt;</span><span class="p">:</span> <span class="no">addq</span>   <span class="no">$0x10</span><span class="p">,</span> <span class="nv">%rax</span>
    <span class="err">0</span><span class="nf">x1000018df</span> <span class="err">&lt;+</span><span class="mi">15</span><span class="err">&gt;</span><span class="p">:</span> <span class="no">xorl</span>   <span class="nv">%ecx</span><span class="p">,</span> <span class="nv">%ecx</span>
    <span class="err">0</span><span class="nf">x1000018e1</span> <span class="err">&lt;+</span><span class="mi">17</span><span class="err">&gt;</span><span class="p">:</span> <span class="no">leaq</span>   <span class="p">-</span><span class="mi">0x18</span><span class="p">(</span><span class="nv">%rbp</span><span class="p">),</span> <span class="nv">%rdx</span>
    <span class="err">0</span><span class="nf">x1000018e5</span> <span class="err">&lt;+</span><span class="mi">21</span><span class="err">&gt;</span><span class="p">:</span> <span class="no">movl</span>   <span class="no">$0x21</span><span class="p">,</span> <span class="nv">%esi</span>
    <span class="c">; (lldb) register read rdi =&gt; rdi = 0x0000000000000014
</span><span class="c"></span>    <span class="c">; (lldb) register read rbp =&gt; rbp = 0x00007ffeefbff4d0
</span><span class="c"></span>    <span class="c">; 将 rdi 寄存器内容（14）移动到 rbp - 0x20 地址
</span><span class="c"></span>    <span class="err">0</span><span class="nf">x1000018ea</span> <span class="err">&lt;+</span><span class="mi">26</span><span class="err">&gt;</span><span class="p">:</span> <span class="no">movq</span>   <span class="nv">%rdi</span><span class="p">,</span> <span class="p">-</span><span class="mi">0x20</span><span class="p">(</span><span class="nv">%rbp</span><span class="p">)</span>
    <span class="err">0</span><span class="nf">x1000018ee</span> <span class="err">&lt;+</span><span class="mi">30</span><span class="err">&gt;</span><span class="p">:</span> <span class="no">movq</span>   <span class="nv">%rax</span><span class="p">,</span> <span class="nv">%rdi</span>
    <span class="err">0</span><span class="nf">x1000018f1</span> <span class="err">&lt;+</span><span class="mi">33</span><span class="err">&gt;</span><span class="p">:</span> <span class="no">movq</span>   <span class="nv">%rsi</span><span class="p">,</span> <span class="p">-</span><span class="mi">0x28</span><span class="p">(</span><span class="nv">%rbp</span><span class="p">)</span>
    <span class="err">0</span><span class="nf">x1000018f5</span> <span class="err">&lt;+</span><span class="mi">37</span><span class="err">&gt;</span><span class="p">:</span> <span class="no">movq</span>   <span class="nv">%rdx</span><span class="p">,</span> <span class="nv">%rsi</span>
    <span class="err">0</span><span class="nf">x1000018f8</span> <span class="err">&lt;+</span><span class="mi">40</span><span class="err">&gt;</span><span class="p">:</span> <span class="no">movq</span>   <span class="p">-</span><span class="mi">0x28</span><span class="p">(</span><span class="nv">%rbp</span><span class="p">),</span> <span class="nv">%rax</span>
    <span class="err">0</span><span class="nf">x1000018fc</span> <span class="err">&lt;+</span><span class="mi">44</span><span class="err">&gt;</span><span class="p">:</span> <span class="no">movq</span>   <span class="nv">%rdx</span><span class="p">,</span> <span class="p">-</span><span class="mi">0x30</span><span class="p">(</span><span class="nv">%rbp</span><span class="p">)</span>
    <span class="err">0</span><span class="nf">x100001900</span> <span class="err">&lt;+</span><span class="mi">48</span><span class="err">&gt;</span><span class="p">:</span> <span class="no">movq</span>   <span class="nv">%rax</span><span class="p">,</span> <span class="nv">%rdx</span>
    <span class="err">0</span><span class="nf">x100001903</span> <span class="err">&lt;+</span><span class="mi">51</span><span class="err">&gt;</span><span class="p">:</span> <span class="no">movq</span>   <span class="nv">%r13</span><span class="p">,</span> <span class="p">-</span><span class="mi">0x38</span><span class="p">(</span><span class="nv">%rbp</span><span class="p">)</span>
    <span class="err">0</span><span class="nf">x100001907</span> <span class="err">&lt;+</span><span class="mi">55</span><span class="err">&gt;</span><span class="p">:</span> <span class="no">callq</span>  <span class="mi">0x100001dd8</span>               <span class="c">; symbol stub for: swift_beginAccess
</span><span class="c"></span>    <span class="c">; 将 rbp - 0x38 地址（0x7FFEEFBFF498）内容（0x000000010046d080，foo1 和 foo2 指向的内存空间地址）移动到 rax 寄存器
</span><span class="c"></span>    <span class="mi">0x10000190c</span> <span class="err">&lt;+</span><span class="mi">60</span><span class="err">&gt;</span><span class="p">:</span> <span class="no">movq</span>   <span class="p">-</span><span class="mi">0x38</span><span class="p">(</span><span class="nv">%rbp</span><span class="p">),</span> <span class="nv">%rax</span>
    <span class="c">; 将 rbp - 0x20 地址内容（14）移动到 rcx 寄存器
</span><span class="c"></span>    <span class="err">0</span><span class="nf">x100001910</span> <span class="err">&lt;+</span><span class="mi">64</span><span class="err">&gt;</span><span class="p">:</span> <span class="no">movq</span>   <span class="p">-</span><span class="mi">0x20</span><span class="p">(</span><span class="nv">%rbp</span><span class="p">),</span> <span class="nv">%rcx</span>
    <span class="c">; 将 rcx 寄存器内容（14）移动到 rax + 0x10（0x10046D090）
</span><span class="c"></span>    <span class="err">0</span><span class="nf">x100001914</span> <span class="err">&lt;+</span><span class="mi">68</span><span class="err">&gt;</span><span class="p">:</span> <span class="no">movq</span>   <span class="nv">%rcx</span><span class="p">,</span> <span class="mi">0x10</span><span class="p">(</span><span class="nv">%rax</span><span class="p">)</span>
    <span class="c">; (lldb) x --size 8 --format x --count 4 0x000000010046d080
</span><span class="c"></span>    <span class="c">; 0x10046d080: 0x0000000100003150 0x0000000600000002
</span><span class="c"></span>    <span class="c">; 0x10046d090: 0x0000000000000014 0x000000000000000b
</span><span class="c"></span>    <span class="err">0</span><span class="nf">x100001918</span> <span class="err">&lt;+</span><span class="mi">72</span><span class="err">&gt;</span><span class="p">:</span> <span class="no">movq</span>   <span class="p">-</span><span class="mi">0x30</span><span class="p">(</span><span class="nv">%rbp</span><span class="p">),</span> <span class="nv">%rdi</span>
    <span class="err">0</span><span class="nf">x10000191c</span> <span class="err">&lt;+</span><span class="mi">76</span><span class="err">&gt;</span><span class="p">:</span> <span class="no">callq</span>  <span class="mi">0x100001de4</span>               <span class="c">; symbol stub for: swift_endAccess
</span><span class="c"></span>    <span class="mi">0x100001921</span> <span class="err">&lt;+</span><span class="mi">81</span><span class="err">&gt;</span><span class="p">:</span> <span class="no">addq</span>   <span class="no">$0x40</span><span class="p">,</span> <span class="nv">%rsp</span>
    <span class="err">0</span><span class="nf">x100001925</span> <span class="err">&lt;+</span><span class="mi">85</span><span class="err">&gt;</span><span class="p">:</span> <span class="no">popq</span>   <span class="nv">%rbp</span>
    <span class="err">0</span><span class="nf">x100001926</span> <span class="err">&lt;+</span><span class="mi">86</span><span class="err">&gt;</span><span class="p">:</span> <span class="no">retq</span>
</code></pre></div><p>当对象初始化后将通过 <code>rax</code> 返回给指针变量，再通过 <code>rax</code> 偏移去改变堆空间中的值，因此内存地址格式为：<code>0x10(%rax)</code> 的变量一般是堆空间。</p>
<h2 id="函数">函数</h2>
<h3 id="函数参数">函数参数</h3>
<div class="highlight"><pre class="chroma"><code class="language-swift" data-lang="swift"><span class="c1">// main.swift</span>

<span class="kd">func</span> <span class="nf">baz</span><span class="p">(</span><span class="kc">_</span> <span class="n">a</span><span class="p">:</span> <span class="nb">Int</span><span class="p">,</span> <span class="kc">_</span> <span class="n">b</span><span class="p">:</span> <span class="nb">Int</span><span class="p">,</span> <span class="kc">_</span> <span class="n">c</span><span class="p">:</span> <span class="nb">Int</span><span class="p">,</span> <span class="kc">_</span> <span class="n">d</span><span class="p">:</span> <span class="nb">Int</span><span class="p">,</span> <span class="kc">_</span> <span class="n">e</span><span class="p">:</span> <span class="nb">Int</span><span class="p">,</span>
         <span class="kc">_</span> <span class="n">f</span><span class="p">:</span> <span class="nb">Int</span><span class="p">,</span> <span class="kc">_</span> <span class="n">g</span><span class="p">:</span> <span class="nb">Int</span><span class="p">,</span> <span class="kc">_</span> <span class="n">h</span><span class="p">:</span> <span class="nb">Int</span><span class="p">,</span> <span class="kc">_</span> <span class="n">i</span><span class="p">:</span> <span class="nb">Int</span><span class="p">,</span> <span class="kc">_</span> <span class="n">j</span><span class="p">:</span> <span class="nb">Int</span><span class="p">)</span> <span class="p">{</span>

<span class="p">}</span>

<span class="n">baz</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span> <span class="c1">// BREAKPOINT 🔴</span>
</code></pre></div><p>定义一个需要 10 个参数的函数，我们尝试从汇编底层看一下这个过程：</p>
<div class="highlight"><pre class="chroma"><code class="language-asm" data-lang="asm"><span class="nf">demo</span><span class="err">`</span><span class="no">main</span><span class="p">:</span>
    <span class="err">0</span><span class="nf">x100000ea0</span> <span class="err">&lt;+</span><span class="mi">0</span><span class="err">&gt;</span><span class="p">:</span>   <span class="no">pushq</span>  <span class="nv">%rbp</span>
    <span class="err">0</span><span class="nf">x100000ea1</span> <span class="err">&lt;+</span><span class="mi">1</span><span class="err">&gt;</span><span class="p">:</span>   <span class="no">movq</span>   <span class="nv">%rsp</span><span class="p">,</span> <span class="nv">%rbp</span>
    <span class="err">0</span><span class="nf">x100000ea4</span> <span class="err">&lt;+</span><span class="mi">4</span><span class="err">&gt;</span><span class="p">:</span>   <span class="no">subq</span>   <span class="no">$0x30</span><span class="p">,</span> <span class="nv">%rsp</span>
    <span class="c">; 第一个参数先放在 eax（rax 的低 32 位）
</span><span class="c"></span><span class="err">-&gt;</span>  <span class="err">0</span><span class="nf">x100000ea8</span> <span class="err">&lt;+</span><span class="mi">8</span><span class="err">&gt;</span><span class="p">:</span>   <span class="no">movl</span>   <span class="no">$0x1</span><span class="p">,</span> <span class="nv">%eax</span>
    <span class="err">0</span><span class="nf">x100000ead</span> <span class="err">&lt;+</span><span class="mi">13</span><span class="err">&gt;</span><span class="p">:</span>  <span class="no">movl</span>   <span class="nv">%edi</span><span class="p">,</span> <span class="p">-</span><span class="mi">0x4</span><span class="p">(</span><span class="nv">%rbp</span><span class="p">)</span>
    <span class="c">; 第一个参数从 rax 转移到 rdi
</span><span class="c"></span>    <span class="err">0</span><span class="nf">x100000eb0</span> <span class="err">&lt;+</span><span class="mi">16</span><span class="err">&gt;</span><span class="p">:</span>  <span class="no">movq</span>   <span class="nv">%rax</span><span class="p">,</span> <span class="nv">%rdi</span>
    <span class="c">; 第二个参数先放在 eax（rax 的低 32 位）
</span><span class="c"></span>    <span class="err">0</span><span class="nf">x100000eb3</span> <span class="err">&lt;+</span><span class="mi">19</span><span class="err">&gt;</span><span class="p">:</span>  <span class="no">movl</span>   <span class="no">$0x2</span><span class="p">,</span> <span class="nv">%eax</span>
    <span class="err">0</span><span class="nf">x100000eb8</span> <span class="err">&lt;+</span><span class="mi">24</span><span class="err">&gt;</span><span class="p">:</span>  <span class="no">movq</span>   <span class="nv">%rsi</span><span class="p">,</span> <span class="p">-</span><span class="mi">0x10</span><span class="p">(</span><span class="nv">%rbp</span><span class="p">)</span>
    <span class="c">; 第二个参数从 rax 转移到 rsi
</span><span class="c"></span>    <span class="err">0</span><span class="nf">x100000ebc</span> <span class="err">&lt;+</span><span class="mi">28</span><span class="err">&gt;</span><span class="p">:</span>  <span class="no">movq</span>   <span class="nv">%rax</span><span class="p">,</span> <span class="nv">%rsi</span>
    <span class="c">; 第三个参数放在 edx（rdx 的低 32 位）
</span><span class="c"></span>    <span class="err">0</span><span class="nf">x100000ebf</span> <span class="err">&lt;+</span><span class="mi">31</span><span class="err">&gt;</span><span class="p">:</span>  <span class="no">movl</span>   <span class="no">$0x3</span><span class="p">,</span> <span class="nv">%edx</span>
    <span class="c">; 第四个参数放在 ecx（rcx 的低 32 位）
</span><span class="c"></span>    <span class="err">0</span><span class="nf">x100000ec4</span> <span class="err">&lt;+</span><span class="mi">36</span><span class="err">&gt;</span><span class="p">:</span>  <span class="no">movl</span>   <span class="no">$0x4</span><span class="p">,</span> <span class="nv">%ecx</span>
    <span class="c">; 第五个参数放在 r8d（r8 的低 32 位）
</span><span class="c"></span>    <span class="err">0</span><span class="nf">x100000ec9</span> <span class="err">&lt;+</span><span class="mi">41</span><span class="err">&gt;</span><span class="p">:</span>  <span class="no">movl</span>   <span class="no">$0x5</span><span class="p">,</span> <span class="nv">%r8d</span>
    <span class="c">; 第六个参数放在 r9d（r9 的低 32 位）
</span><span class="c"></span>    <span class="err">0</span><span class="nf">x100000ecf</span> <span class="err">&lt;+</span><span class="mi">47</span><span class="err">&gt;</span><span class="p">:</span>  <span class="no">movl</span>   <span class="no">$0x6</span><span class="p">,</span> <span class="nv">%r9d</span>
    <span class="c">; 第七个参数放在 rsp（(lldb) register read rsp =&gt; rsp = 0x00007ffeefbff510）
</span><span class="c"></span>    <span class="err">0</span><span class="nf">x100000ed5</span> <span class="err">&lt;+</span><span class="mi">53</span><span class="err">&gt;</span><span class="p">:</span>  <span class="no">movq</span>   <span class="no">$0x7</span><span class="p">,</span> <span class="p">(</span><span class="nv">%rsp</span><span class="p">)</span>
    <span class="c">; 第八个参数放在 rsp + 0x8 地址（0x7FFEEFBFF518）
</span><span class="c"></span>    <span class="err">0</span><span class="nf">x100000edd</span> <span class="err">&lt;+</span><span class="mi">61</span><span class="err">&gt;</span><span class="p">:</span>  <span class="no">movq</span>   <span class="no">$0x8</span><span class="p">,</span> <span class="mi">0x8</span><span class="p">(</span><span class="nv">%rsp</span><span class="p">)</span>
    <span class="c">; 第九个参数放在 rsp + 0x10 地址（0x7FFEEFBFF520）
</span><span class="c"></span>    <span class="err">0</span><span class="nf">x100000ee6</span> <span class="err">&lt;+</span><span class="mi">70</span><span class="err">&gt;</span><span class="p">:</span>  <span class="no">movq</span>   <span class="no">$0x9</span><span class="p">,</span> <span class="mi">0x10</span><span class="p">(</span><span class="nv">%rsp</span><span class="p">)</span>
    <span class="c">; 第十个参数放在 rsp + 0x18 地址（0x7FFEEFBFF528）
</span><span class="c"></span>    <span class="err">0</span><span class="nf">x100000eef</span> <span class="err">&lt;+</span><span class="mi">79</span><span class="err">&gt;</span><span class="p">:</span>  <span class="no">movq</span>   <span class="no">$0xa</span><span class="p">,</span> <span class="mi">0x18</span><span class="p">(</span><span class="nv">%rsp</span><span class="p">)</span>
    <span class="c">; 函数调用
</span><span class="c"></span>    <span class="err">0</span><span class="nf">x100000ef8</span> <span class="err">&lt;+</span><span class="mi">88</span><span class="err">&gt;</span><span class="p">:</span>  <span class="no">callq</span>  <span class="mi">0x100000f10</span>               <span class="c">; demo.baz(Swift.Int, Swift.Int, Swift.Int, Swift.Int, Swift.Int, Swift.Int, Swift.Int, Swift.Int, Swift.Int, Swift.Int) -&gt; () at main.swift:1
</span><span class="c"></span>    <span class="mi">0x100000efd</span> <span class="err">&lt;+</span><span class="mi">93</span><span class="err">&gt;</span><span class="p">:</span>  <span class="no">xorl</span>   <span class="nv">%eax</span><span class="p">,</span> <span class="nv">%eax</span>
    <span class="err">0</span><span class="nf">x100000eff</span> <span class="err">&lt;+</span><span class="mi">95</span><span class="err">&gt;</span><span class="p">:</span>  <span class="no">addq</span>   <span class="no">$0x30</span><span class="p">,</span> <span class="nv">%rsp</span>
    <span class="err">0</span><span class="nf">x100000f03</span> <span class="err">&lt;+</span><span class="mi">99</span><span class="err">&gt;</span><span class="p">:</span>  <span class="no">popq</span>   <span class="nv">%rbp</span>
    <span class="err">0</span><span class="nf">x100000f04</span> <span class="err">&lt;+</span><span class="mi">100</span><span class="err">&gt;</span><span class="p">:</span> <span class="no">retq</span>
</code></pre></div><p>由上我们可以得出：<code>rdi</code>（<code>edi</code>）、<code>rsi</code>（<code>esi</code>）、<code>rdx</code>（<code>edx</code>）、<code>rcx</code>（<code>ecx</code>）、<code>r8</code>（<code>r8d</code>）、<code>r9</code>（<code>r9d</code>）寄存器将依次存放函数参数，当以上寄存器个数仍不满足函数参数个数时，将从 <code>rsp</code> 开始放置函数参（其实 <code>rsp</code> 是函数栈空间的栈底，详见下文）。将断点加在 <code>0x100000ef8 &lt;+88&gt;: callq 0x100000f10</code> 一行，并执行 <code>si</code>，进入函数内部：</p>
<div class="highlight"><pre class="chroma"><code class="language-asm" data-lang="asm"><span class="nf">demo</span><span class="err">`</span><span class="no">baz</span><span class="p">(</span><span class="no">_</span><span class="p">:</span><span class="no">_</span><span class="p">:</span><span class="no">_</span><span class="p">:</span><span class="no">_</span><span class="p">:</span><span class="no">_</span><span class="p">:</span><span class="no">_</span><span class="p">:</span><span class="no">_</span><span class="p">:</span><span class="no">_</span><span class="p">:</span><span class="no">_</span><span class="p">:</span><span class="no">_</span><span class="p">:):</span>
    <span class="c">; 调用帧入栈
</span><span class="c"></span><span class="err">-&gt;</span>  <span class="err">0</span><span class="nf">x100000f10</span> <span class="err">&lt;+</span><span class="mi">0</span><span class="err">&gt;</span><span class="p">:</span>   <span class="no">pushq</span>  <span class="nv">%rbp</span>
    <span class="c">; 切换栈帧到当前栈帧
</span><span class="c"></span>    <span class="err">0</span><span class="nf">x100000f11</span> <span class="err">&lt;+</span><span class="mi">1</span><span class="err">&gt;</span><span class="p">:</span>   <span class="no">movq</span>   <span class="nv">%rsp</span><span class="p">,</span> <span class="nv">%rbp</span>
    <span class="c">; (lldb) register read rbp =&gt; rbp = 0x00007ffeefbff500
</span><span class="c"></span>    <span class="err">0</span><span class="nf">x100000f14</span> <span class="err">&lt;+</span><span class="mi">4</span><span class="err">&gt;</span><span class="p">:</span>   <span class="no">pushq</span>  <span class="nv">%rbx</span>
    <span class="c">; (lldb) register read rsp =&gt; rsp = 0x00007ffeefbff4f8
</span><span class="c"></span>    <span class="c">; rbp + 0x28（0x7FFEEFBFF528，即第十个参数 10）转移到 rax
</span><span class="c"></span>    <span class="err">0</span><span class="nf">x100000f15</span> <span class="err">&lt;+</span><span class="mi">5</span><span class="err">&gt;</span><span class="p">:</span>   <span class="no">movq</span>   <span class="mi">0x28</span><span class="p">(</span><span class="nv">%rbp</span><span class="p">),</span> <span class="nv">%rax</span>
    <span class="c">; rbp + 0x20（0x7FFEEFBFF520，即第九个参数 9）转移到 r10
</span><span class="c"></span>    <span class="err">0</span><span class="nf">x100000f19</span> <span class="err">&lt;+</span><span class="mi">9</span><span class="err">&gt;</span><span class="p">:</span>   <span class="no">movq</span>   <span class="mi">0x20</span><span class="p">(</span><span class="nv">%rbp</span><span class="p">),</span> <span class="nv">%r10</span>
    <span class="c">; rbp + 0x18（0x7FFEEFBFF518，即第八个参数 8）转移到 r11
</span><span class="c"></span>    <span class="err">0</span><span class="nf">x100000f1d</span> <span class="err">&lt;+</span><span class="mi">13</span><span class="err">&gt;</span><span class="p">:</span>  <span class="no">movq</span>   <span class="mi">0x18</span><span class="p">(</span><span class="nv">%rbp</span><span class="p">),</span> <span class="nv">%r11</span>
    <span class="c">; rbp + 0x10（0x7FFEEFBFF510，即第七个参数 7）转移到 rbx
</span><span class="c"></span>    <span class="err">0</span><span class="nf">x100000f21</span> <span class="err">&lt;+</span><span class="mi">17</span><span class="err">&gt;</span><span class="p">:</span>  <span class="no">movq</span>   <span class="mi">0x10</span><span class="p">(</span><span class="nv">%rbp</span><span class="p">),</span> <span class="nv">%rbx</span>
    <span class="c">; 清零：
</span><span class="c"></span>    <span class="err">0</span><span class="nf">x100000f25</span> <span class="err">&lt;+</span><span class="mi">21</span><span class="err">&gt;</span><span class="p">:</span>  <span class="no">movq</span>   <span class="no">$0x0</span><span class="p">,</span> <span class="p">-</span><span class="mi">0x10</span><span class="p">(</span><span class="nv">%rbp</span><span class="p">)</span>
    <span class="err">0</span><span class="nf">x100000f2d</span> <span class="err">&lt;+</span><span class="mi">29</span><span class="err">&gt;</span><span class="p">:</span>  <span class="no">movq</span>   <span class="no">$0x0</span><span class="p">,</span> <span class="p">-</span><span class="mi">0x18</span><span class="p">(</span><span class="nv">%rbp</span><span class="p">)</span>
    <span class="err">0</span><span class="nf">x100000f35</span> <span class="err">&lt;+</span><span class="mi">37</span><span class="err">&gt;</span><span class="p">:</span>  <span class="no">movq</span>   <span class="no">$0x0</span><span class="p">,</span> <span class="p">-</span><span class="mi">0x20</span><span class="p">(</span><span class="nv">%rbp</span><span class="p">)</span>
    <span class="err">0</span><span class="nf">x100000f3d</span> <span class="err">&lt;+</span><span class="mi">45</span><span class="err">&gt;</span><span class="p">:</span>  <span class="no">movq</span>   <span class="no">$0x0</span><span class="p">,</span> <span class="p">-</span><span class="mi">0x28</span><span class="p">(</span><span class="nv">%rbp</span><span class="p">)</span>
    <span class="err">0</span><span class="nf">x100000f45</span> <span class="err">&lt;+</span><span class="mi">53</span><span class="err">&gt;</span><span class="p">:</span>  <span class="no">movq</span>   <span class="no">$0x0</span><span class="p">,</span> <span class="p">-</span><span class="mi">0x30</span><span class="p">(</span><span class="nv">%rbp</span><span class="p">)</span>
    <span class="err">0</span><span class="nf">x100000f4d</span> <span class="err">&lt;+</span><span class="mi">61</span><span class="err">&gt;</span><span class="p">:</span>  <span class="no">movq</span>   <span class="no">$0x0</span><span class="p">,</span> <span class="p">-</span><span class="mi">0x38</span><span class="p">(</span><span class="nv">%rbp</span><span class="p">)</span>
    <span class="err">0</span><span class="nf">x100000f55</span> <span class="err">&lt;+</span><span class="mi">69</span><span class="err">&gt;</span><span class="p">:</span>  <span class="no">movq</span>   <span class="no">$0x0</span><span class="p">,</span> <span class="p">-</span><span class="mi">0x40</span><span class="p">(</span><span class="nv">%rbp</span><span class="p">)</span>
    <span class="err">0</span><span class="nf">x100000f5d</span> <span class="err">&lt;+</span><span class="mi">77</span><span class="err">&gt;</span><span class="p">:</span>  <span class="no">movq</span>   <span class="no">$0x0</span><span class="p">,</span> <span class="p">-</span><span class="mi">0x48</span><span class="p">(</span><span class="nv">%rbp</span><span class="p">)</span>
    <span class="err">0</span><span class="nf">x100000f65</span> <span class="err">&lt;+</span><span class="mi">85</span><span class="err">&gt;</span><span class="p">:</span>  <span class="no">movq</span>   <span class="no">$0x0</span><span class="p">,</span> <span class="p">-</span><span class="mi">0x50</span><span class="p">(</span><span class="nv">%rbp</span><span class="p">)</span>
    <span class="err">0</span><span class="nf">x100000f6d</span> <span class="err">&lt;+</span><span class="mi">93</span><span class="err">&gt;</span><span class="p">:</span>  <span class="no">movq</span>   <span class="no">$0x0</span><span class="p">,</span> <span class="p">-</span><span class="mi">0x58</span><span class="p">(</span><span class="nv">%rbp</span><span class="p">)</span>
    <span class="c">; 参数局部变量化：
</span><span class="c"></span>    <span class="c">; 第一个参数从 rdi 转移到 rbp - 0x10 地址（0x7FFEEFBFF4F0，高地址）
</span><span class="c"></span>    <span class="err">0</span><span class="nf">x100000f75</span> <span class="err">&lt;+</span><span class="mi">101</span><span class="err">&gt;</span><span class="p">:</span> <span class="no">movq</span>   <span class="nv">%rdi</span><span class="p">,</span> <span class="p">-</span><span class="mi">0x10</span><span class="p">(</span><span class="nv">%rbp</span><span class="p">)</span>
    <span class="c">; 第二个参数从 rsi 转移到 rbp - 0x18 地址（0x7FFEEFBFF4E8）
</span><span class="c"></span>    <span class="err">0</span><span class="nf">x100000f79</span> <span class="err">&lt;+</span><span class="mi">105</span><span class="err">&gt;</span><span class="p">:</span> <span class="no">movq</span>   <span class="nv">%rsi</span><span class="p">,</span> <span class="p">-</span><span class="mi">0x18</span><span class="p">(</span><span class="nv">%rbp</span><span class="p">)</span>
    <span class="c">; 第三个参数从 rdx 转移到 rbp - 0x20 地址（0x7FFEEFBFF4E0）
</span><span class="c"></span>    <span class="err">0</span><span class="nf">x100000f7d</span> <span class="err">&lt;+</span><span class="mi">109</span><span class="err">&gt;</span><span class="p">:</span> <span class="no">movq</span>   <span class="nv">%rdx</span><span class="p">,</span> <span class="p">-</span><span class="mi">0x20</span><span class="p">(</span><span class="nv">%rbp</span><span class="p">)</span>
    <span class="c">; 第四个参数从 rcx 转移到 rbp - 0x28 地址（0x7FFEEFBFF4D8）
</span><span class="c"></span>    <span class="err">0</span><span class="nf">x100000f81</span> <span class="err">&lt;+</span><span class="mi">113</span><span class="err">&gt;</span><span class="p">:</span> <span class="no">movq</span>   <span class="nv">%rcx</span><span class="p">,</span> <span class="p">-</span><span class="mi">0x28</span><span class="p">(</span><span class="nv">%rbp</span><span class="p">)</span>
    <span class="c">; 第五个参数从 r8 转移到 rbp - 0x30 地址（0x7FFEEFBFF4D0）
</span><span class="c"></span>    <span class="err">0</span><span class="nf">x100000f85</span> <span class="err">&lt;+</span><span class="mi">117</span><span class="err">&gt;</span><span class="p">:</span> <span class="no">movq</span>   <span class="nv">%r8</span><span class="p">,</span> <span class="p">-</span><span class="mi">0x30</span><span class="p">(</span><span class="nv">%rbp</span><span class="p">)</span>
    <span class="c">; 第六个参数从 r9 转移到 rbp - 0x38 地址（0x7FFEEFBFF4C8）
</span><span class="c"></span>    <span class="err">0</span><span class="nf">x100000f89</span> <span class="err">&lt;+</span><span class="mi">121</span><span class="err">&gt;</span><span class="p">:</span> <span class="no">movq</span>   <span class="nv">%r9</span><span class="p">,</span> <span class="p">-</span><span class="mi">0x38</span><span class="p">(</span><span class="nv">%rbp</span><span class="p">)</span>
    <span class="c">; 第七个参数从 rbx 转移到 rbp - 0x40 地址（0x7FFEEFBFF4C0）
</span><span class="c"></span>    <span class="err">0</span><span class="nf">x100000f8d</span> <span class="err">&lt;+</span><span class="mi">125</span><span class="err">&gt;</span><span class="p">:</span> <span class="no">movq</span>   <span class="nv">%rbx</span><span class="p">,</span> <span class="p">-</span><span class="mi">0x40</span><span class="p">(</span><span class="nv">%rbp</span><span class="p">)</span>
    <span class="c">; 第八个参数从 r11 转移到 rbp - 0x48 地址（0x7FFEEFBFF4B8）
</span><span class="c"></span>    <span class="err">0</span><span class="nf">x100000f91</span> <span class="err">&lt;+</span><span class="mi">129</span><span class="err">&gt;</span><span class="p">:</span> <span class="no">movq</span>   <span class="nv">%r11</span><span class="p">,</span> <span class="p">-</span><span class="mi">0x48</span><span class="p">(</span><span class="nv">%rbp</span><span class="p">)</span>
    <span class="c">; 第九个参数从 r10 转移到 rbp - 0x50 地址（0x7FFEEFBFF4B0）
</span><span class="c"></span>    <span class="err">0</span><span class="nf">x100000f95</span> <span class="err">&lt;+</span><span class="mi">133</span><span class="err">&gt;</span><span class="p">:</span> <span class="no">movq</span>   <span class="nv">%r10</span><span class="p">,</span> <span class="p">-</span><span class="mi">0x50</span><span class="p">(</span><span class="nv">%rbp</span><span class="p">)</span>
    <span class="c">; 第十个参数从 rax 转移到 rbp - 0x58 地址（0x7FFEEFBFF4A8，低地址）
</span><span class="c"></span>    <span class="err">0</span><span class="nf">x100000f99</span> <span class="err">&lt;+</span><span class="mi">137</span><span class="err">&gt;</span><span class="p">:</span> <span class="no">movq</span>   <span class="nv">%rax</span><span class="p">,</span> <span class="p">-</span><span class="mi">0x58</span><span class="p">(</span><span class="nv">%rbp</span><span class="p">)</span>
    <span class="err">0</span><span class="nf">x100000f9d</span> <span class="err">&lt;+</span><span class="mi">141</span><span class="err">&gt;</span><span class="p">:</span> <span class="no">popq</span>   <span class="nv">%rbx</span>
    <span class="err">0</span><span class="nf">x100000f9e</span> <span class="err">&lt;+</span><span class="mi">142</span><span class="err">&gt;</span><span class="p">:</span> <span class="no">popq</span>   <span class="nv">%rbp</span>
    <span class="err">0</span><span class="nf">x100000f9f</span> <span class="err">&lt;+</span><span class="mi">143</span><span class="err">&gt;</span><span class="p">:</span> <span class="no">retq</span>
</code></pre></div><p><code>rbp</code>（<code>(lldb) register read rbp =&gt; rbp = 0x00007ffeefbff500</code>，高地址，栈底）与 <code>rsp</code>（<code>(lldb) register read rsp =&gt; rsp = 0x00007ffeefbff4f8</code>，低地址，栈顶）寄存器之间为函数的栈空间，即栈帧。函数参数局部变量化时，将依次从高地址排列至低地址，即入栈。</p>
<h3 id="函数返回值">函数返回值</h3>
<div class="highlight"><pre class="chroma"><code class="language-swift" data-lang="swift"><span class="c1">// main.swift</span>

<span class="kd">func</span> <span class="nf">baz</span><span class="p">()</span> <span class="p">-&gt;</span> <span class="nb">Int</span> <span class="p">{</span>
    <span class="k">return</span> <span class="mi">10</span>
<span class="p">}</span>

<span class="kc">_</span> <span class="p">=</span> <span class="n">baz</span><span class="p">()</span>
</code></pre></div><p>定义一个需要返回值的函数，我们尝试从汇编底层看一下这个过程：</p>
<div class="highlight"><pre class="chroma"><code class="language-asm" data-lang="asm"><span class="nf">demo</span><span class="err">`</span><span class="no">baz</span><span class="p">():</span>
<span class="err">-&gt;</span>  <span class="err">0</span><span class="nf">x100000fa0</span> <span class="err">&lt;+</span><span class="mi">0</span><span class="err">&gt;</span><span class="p">:</span>  <span class="no">pushq</span>  <span class="nv">%rbp</span>
    <span class="err">0</span><span class="nf">x100000fa1</span> <span class="err">&lt;+</span><span class="mi">1</span><span class="err">&gt;</span><span class="p">:</span>  <span class="no">movq</span>   <span class="nv">%rsp</span><span class="p">,</span> <span class="nv">%rbp</span>
    <span class="c">; 将立即数 10 移动到 eax 寄存器（即 rax 寄存器低 32 位）
</span><span class="c"></span>    <span class="err">0</span><span class="nf">x100000fa4</span> <span class="err">&lt;+</span><span class="mi">4</span><span class="err">&gt;</span><span class="p">:</span>  <span class="no">movl</span>   <span class="no">$0xa</span><span class="p">,</span> <span class="nv">%eax</span>
    <span class="err">0</span><span class="nf">x100000fa9</span> <span class="err">&lt;+</span><span class="mi">9</span><span class="err">&gt;</span><span class="p">:</span>  <span class="no">popq</span>   <span class="nv">%rbp</span>
    <span class="err">0</span><span class="nf">x100000faa</span> <span class="err">&lt;+</span><span class="mi">10</span><span class="err">&gt;</span><span class="p">:</span> <span class="no">retq</span>
</code></pre></div><p>此时返回值将移动到 <code>rax</code> 寄存器供函数外部使用。通常来说，一个函数只有一个返回值，但 Swift 中支持元组类型，可以将多个元素同时返回，那么此时返回值存在哪里呢？</p>
<div class="highlight"><pre class="chroma"><code class="language-swift" data-lang="swift"><span class="c1">// main.swift</span>

<span class="kd">func</span> <span class="nf">baz</span><span class="p">()</span> <span class="p">-&gt;</span> <span class="p">(</span><span class="nb">Int</span><span class="p">,</span> <span class="nb">Int</span><span class="p">,</span> <span class="nb">Int</span><span class="p">,</span> <span class="nb">Int</span><span class="p">,</span> <span class="nb">Int</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">11</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="mi">13</span><span class="p">,</span> <span class="mi">14</span><span class="p">)</span>
<span class="p">}</span>

<span class="kd">var</span> <span class="nv">t</span> <span class="p">=</span> <span class="n">baz</span><span class="p">()</span>
<span class="kd">var</span> <span class="nv">a</span> <span class="p">=</span> <span class="n">t</span><span class="p">.</span><span class="mi">0</span>
<span class="kd">var</span> <span class="nv">b</span> <span class="p">=</span> <span class="n">t</span><span class="p">.</span><span class="mi">1</span>
<span class="kd">var</span> <span class="nv">c</span> <span class="p">=</span> <span class="n">t</span><span class="p">.</span><span class="mi">2</span>
<span class="kd">var</span> <span class="nv">d</span> <span class="p">=</span> <span class="n">t</span><span class="p">.</span><span class="mi">3</span>
<span class="kd">var</span> <span class="nv">e</span> <span class="p">=</span> <span class="n">t</span><span class="p">.</span><span class="mi">4</span>
</code></pre></div><p>转换为汇编代码：</p>
<div class="highlight"><pre class="chroma"><code class="language-asm" data-lang="asm"><span class="nf">demo</span><span class="err">`</span><span class="no">baz</span><span class="p">():</span>
<span class="err">-&gt;</span>  <span class="err">0</span><span class="nf">x100000f50</span> <span class="err">&lt;+</span><span class="mi">0</span><span class="err">&gt;</span><span class="p">:</span>  <span class="no">pushq</span>  <span class="nv">%rbp</span>
    <span class="err">0</span><span class="nf">x100000f51</span> <span class="err">&lt;+</span><span class="mi">1</span><span class="err">&gt;</span><span class="p">:</span>  <span class="no">movq</span>   <span class="nv">%rsp</span><span class="p">,</span> <span class="nv">%rbp</span>
    <span class="c">; 返回值元组第一个元素放在 rax
</span><span class="c"></span>    <span class="err">0</span><span class="nf">x100000f54</span> <span class="err">&lt;+</span><span class="mi">4</span><span class="err">&gt;</span><span class="p">:</span>  <span class="no">movq</span>   <span class="no">$0xa</span><span class="p">,</span> <span class="p">(</span><span class="nv">%rax</span><span class="p">)</span>
    <span class="c">; 返回值元组第二个元素放在 rax + 0x8
</span><span class="c"></span>    <span class="err">0</span><span class="nf">x100000f5b</span> <span class="err">&lt;+</span><span class="mi">11</span><span class="err">&gt;</span><span class="p">:</span> <span class="no">movq</span>   <span class="no">$0xb</span><span class="p">,</span> <span class="mi">0x8</span><span class="p">(</span><span class="nv">%rax</span><span class="p">)</span>
    <span class="c">; 返回值元组第三个元素放在 rax + 0x10
</span><span class="c"></span>    <span class="err">0</span><span class="nf">x100000f63</span> <span class="err">&lt;+</span><span class="mi">19</span><span class="err">&gt;</span><span class="p">:</span> <span class="no">movq</span>   <span class="no">$0xc</span><span class="p">,</span> <span class="mi">0x10</span><span class="p">(</span><span class="nv">%rax</span><span class="p">)</span>
    <span class="c">; 返回值元组第四个元素放在 rax + 0x18
</span><span class="c"></span>    <span class="err">0</span><span class="nf">x100000f6b</span> <span class="err">&lt;+</span><span class="mi">27</span><span class="err">&gt;</span><span class="p">:</span> <span class="no">movq</span>   <span class="no">$0xd</span><span class="p">,</span> <span class="mi">0x18</span><span class="p">(</span><span class="nv">%rax</span><span class="p">)</span>
    <span class="c">; 返回值元组第五个元素放在 rax + 0x20
</span><span class="c"></span>    <span class="err">0</span><span class="nf">x100000f73</span> <span class="err">&lt;+</span><span class="mi">35</span><span class="err">&gt;</span><span class="p">:</span> <span class="no">movq</span>   <span class="no">$0xe</span><span class="p">,</span> <span class="mi">0x20</span><span class="p">(</span><span class="nv">%rax</span><span class="p">)</span>
    <span class="err">0</span><span class="nf">x100000f7b</span> <span class="err">&lt;+</span><span class="mi">43</span><span class="err">&gt;</span><span class="p">:</span> <span class="no">popq</span>   <span class="nv">%rbp</span>
    <span class="err">0</span><span class="nf">x100000f7c</span> <span class="err">&lt;+</span><span class="mi">44</span><span class="err">&gt;</span><span class="p">:</span> <span class="no">retq</span>

<span class="nf">demo</span><span class="err">`</span><span class="no">main</span><span class="p">:</span>
    <span class="err">0</span><span class="nf">x100000dd0</span> <span class="err">&lt;+</span><span class="mi">0</span><span class="err">&gt;</span><span class="p">:</span>   <span class="no">pushq</span>  <span class="nv">%rbp</span>
    <span class="err">0</span><span class="nf">x100000dd1</span> <span class="err">&lt;+</span><span class="mi">1</span><span class="err">&gt;</span><span class="p">:</span>   <span class="no">movq</span>   <span class="nv">%rsp</span><span class="p">,</span> <span class="nv">%rbp</span>
    <span class="err">0</span><span class="nf">x100000dd4</span> <span class="err">&lt;+</span><span class="mi">4</span><span class="err">&gt;</span><span class="p">:</span>   <span class="no">subq</span>   <span class="no">$0xb0</span><span class="p">,</span> <span class="nv">%rsp</span>
    <span class="err">0</span><span class="nf">x100000ddb</span> <span class="err">&lt;+</span><span class="mi">11</span><span class="err">&gt;</span><span class="p">:</span>  <span class="no">leaq</span>   <span class="p">-</span><span class="mi">0x28</span><span class="p">(</span><span class="nv">%rbp</span><span class="p">),</span> <span class="nv">%rax</span>
    <span class="err">0</span><span class="nf">x100000ddf</span> <span class="err">&lt;+</span><span class="mi">15</span><span class="err">&gt;</span><span class="p">:</span>  <span class="no">movl</span>   <span class="nv">%edi</span><span class="p">,</span> <span class="p">-</span><span class="mi">0xa4</span><span class="p">(</span><span class="nv">%rbp</span><span class="p">)</span>
    <span class="err">0</span><span class="nf">x100000de5</span> <span class="err">&lt;+</span><span class="mi">21</span><span class="err">&gt;</span><span class="p">:</span>  <span class="no">movq</span>   <span class="nv">%rsi</span><span class="p">,</span> <span class="p">-</span><span class="mi">0xb0</span><span class="p">(</span><span class="nv">%rbp</span><span class="p">)</span>
<span class="err">-&gt;</span>  <span class="err">0</span><span class="nf">x100000dec</span> <span class="err">&lt;+</span><span class="mi">28</span><span class="err">&gt;</span><span class="p">:</span>  <span class="no">callq</span>  <span class="mi">0x100000f50</span>               <span class="c">; demo.baz() -&gt; (Swift.Int, Swift.Int, Swift.Int, Swift.Int, Swift.Int) at main.swift:3
</span><span class="c"></span>    <span class="c">; (lldb) register read rax =&gt; rax = 0x00007ffeefbff518
</span><span class="c"></span>    <span class="c">; (lldb) x --size 8 --format x --count 6 0x00007ffeefbff518
</span><span class="c"></span>    <span class="c">; 0x7ffeefbff518: 0x000000000000000a 0x000000000000000b
</span><span class="c"></span>    <span class="c">; 0x7ffeefbff528: 0x000000000000000c 0x000000000000000d
</span><span class="c"></span>    <span class="c">; 0x7ffeefbff538: 0x000000000000000e 0x00007ffeefbff550
</span><span class="c"></span>    <span class="mi">0x100000df1</span> <span class="err">&lt;+</span><span class="mi">33</span><span class="err">&gt;</span><span class="p">:</span>  <span class="no">leaq</span>   <span class="mi">0x1220</span><span class="p">(</span><span class="nv">%rip</span><span class="p">),</span> <span class="nv">%rax</span>        <span class="c">; demo.t : (Swift.Int, Swift.Int, Swift.Int, Swift.Int, Swift.Int)
</span><span class="c"></span>    <span class="mi">0x100000df8</span> <span class="err">&lt;+</span><span class="mi">40</span><span class="err">&gt;</span><span class="p">:</span>  <span class="no">xorl</span>   <span class="nv">%ecx</span><span class="p">,</span> <span class="nv">%ecx</span>
    <span class="c">; (lldb) register read rbp =&gt; rbp = 0x00007ffeefbff540
</span><span class="c"></span>    <span class="c">; 将 rbp - 0x28 地址（0x7FFEEFBFF518）内容（10）移动到 rdx
</span><span class="c"></span>    <span class="err">0</span><span class="nf">x100000dfa</span> <span class="err">&lt;+</span><span class="mi">42</span><span class="err">&gt;</span><span class="p">:</span>  <span class="no">movq</span>   <span class="p">-</span><span class="mi">0x28</span><span class="p">(</span><span class="nv">%rbp</span><span class="p">),</span> <span class="nv">%rdx</span>
    <span class="c">; 将 rbp - 0x20 地址（0x7FFEEFBFF518）内容（11）移动到 rsi
</span><span class="c"></span>    <span class="err">0</span><span class="nf">x100000dfe</span> <span class="err">&lt;+</span><span class="mi">46</span><span class="err">&gt;</span><span class="p">:</span>  <span class="no">movq</span>   <span class="p">-</span><span class="mi">0x20</span><span class="p">(</span><span class="nv">%rbp</span><span class="p">),</span> <span class="nv">%rsi</span>
    <span class="c">; 将 rbp - 0x18 地址（0x7FFEEFBFF518）内容（12）移动到 r8
</span><span class="c"></span>    <span class="err">0</span><span class="nf">x100000e02</span> <span class="err">&lt;+</span><span class="mi">50</span><span class="err">&gt;</span><span class="p">:</span>  <span class="no">movq</span>   <span class="p">-</span><span class="mi">0x18</span><span class="p">(</span><span class="nv">%rbp</span><span class="p">),</span> <span class="nv">%r8</span>
    <span class="c">; 将 rbp - 0x10 地址（0x7FFEEFBFF518）内容（13）移动到 r9
</span><span class="c"></span>    <span class="err">0</span><span class="nf">x100000e06</span> <span class="err">&lt;+</span><span class="mi">54</span><span class="err">&gt;</span><span class="p">:</span>  <span class="no">movq</span>   <span class="p">-</span><span class="mi">0x10</span><span class="p">(</span><span class="nv">%rbp</span><span class="p">),</span> <span class="nv">%r9</span>
    <span class="c">; 将 rbp - 0x8 地址（0x7FFEEFBFF518）内容（14）移动到 r10
</span><span class="c"></span>    <span class="err">0</span><span class="nf">x100000e0a</span> <span class="err">&lt;+</span><span class="mi">58</span><span class="err">&gt;</span><span class="p">:</span>  <span class="no">movq</span>   <span class="p">-</span><span class="mi">0x8</span><span class="p">(</span><span class="nv">%rbp</span><span class="p">),</span> <span class="nv">%r10</span>
    <span class="c">; ...
</span></code></pre></div><p>我们可以看出，当元组作为返回值时，将从 <code>rax</code> 开始偏移依次存放。</p>
<!--

- 寄存器：
  - 16 个常用寄存器：
    - `rax`、`rbx`、`rcx`、`rdx`、`rsi`、`rdi`、`rbp`、`rsp`
    - `r8`、`r9`、`r10`、`r11`、`r12`、`r13`、`r14`、`r15`
    - `r` 开头的寄存器均为 64 位(8 字节）寄存器，`e` 开头为 32 位，`ax`、`bx`、`cx` 为 16 位，`ah`、`al` 为 8 位。
  - 用途
    - `rax`、`rdx` 常作为函数返回值使用
  - 结构体和对象等均存储在内存（非寄存器）

## 汇编语言

- 汇编语言分类：
  - 8086 汇编（16 位（Bit），即每个寄存器的大小为 16 位，2 字节）
  - x86 汇编（32 位）
  - x64 汇编（64 位）
  - ARM 汇编等
- AT&T 汇编用于 iOS 模拟器，ARM 汇编用于 iOS 真机

|    项目     |                                AT&T                                 |                           Intel                           |                                                                                                                   说明                                                                                                                   |
| :---------: | :-----------------------------------------------------------------: | :-------------------------------------------------------: | :--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------: |
| 寄存器命名  |                               `%rax`                                |                           `rax`                           |                                                                                                                    -                                                                                                                     |
| 操作数顺序  |                          `movq %rax, %rdx`                          |                      `mov rdx, rax`                       |                                                                                                        将 `rax` 的值赋值给 `rdx`                                                                                                         |
| 常数/立即数 |                `movq $3, %rax`<br>`movq $0x10, %rax`                |              `mov rax, 3`<br>`mov rax, 0x10`              |                                                                                                将 `3` 赋值给 `rax` 将 `0x10` 赋值给 `rax`                                                                                                |
|  内存赋值   |                      `movq $0xa, 0x1ff7(%rip)`                      |             `mov qword ptr [rip+0x1ff7], 0xa`             |                                                                                            将 `0xa` 赋值给地址为 `rip` + `0x1ff7` 的内存空间                                                                                             |
| 取内存地址  |                      `leaq -0x18(%rbp), %rax`                       |                  `lea rax, [rbp – 0x18]`                  |                                                                                                  将 `rbp – 0x18` 这个地址值赋值给 `rax`                                                                                                  |
| `jmp` 指令  | `jmp *%rdx`<br>`jmp 0x4001002`<br>`jmp *(%rax)`（`*` 代表间接跳转） |        `jmp rdx`<br>`jmp 0x4001002`<br>`jmp [rax]`        |                                                                                  `call` 和 `jmp` 写法类似（`call` 后通常为函数地址，可配合 `ret` 使用）                                                                                  |
| 操作数长度  |   `movl %eax, %edx`<br>`movb $0x10, %al`<br>`leaw 0x10(%dx), %ax`   | `mov edx, eax`<br>`mov al, 0x10`<br>`lea ax, [dx + 0x10]` | **b** = byte (8-bit)<br>**s** = short (16-bit integer or 32-bit floating point)<br>**w** = word (16-bit)<br>**l** = long (32-bit integer or 64-bit floating point)<br>**q** = quad (64 bit)<br>**t** = ten bytes (80-bit floating point) |

- `movq -0x18(%rbp), %rax` & `leaq -0x18(%rbp), %rax` 的区别：
  - 前者为将 `%rbp - 0x18` 得到的地址对应存储空间的数据，存储到 `rax` 寄存器；
  - 后者为将 `%rbp - 0x18` 得到的地址，存储到 `rax` 寄存器。
- `call 0x10`：跳转至 `0x10` 函数地址处；
- `call *%rax`：跳转至 `rax` 寄存器存储的函数地址处。

## LLDB

|            操作            |                                            指令                                             |
| :------------------------: | :-----------------------------------------------------------------------------------------: |
|       列出所有寄存器       |                                       `register read`                                       |
|       读取寄存器的值       |                  `register read/格式 寄存器名称`<br>`register read/x rax`                   |
|       修改寄存器的值       |                 `register write 寄存器名称 数值`<br>`register write rax 0`                  |
|       读取内存中的值       |                    `x/数量-格式-字节大小 内存地址`<br>`x/3xw 0x0000010`                     |
|       修改内存中的值       |                 `memory write 内存地址 数值`<br>`memory write 0x0000010 10`                 |
|            格式            |                          `x` 是十六进制，`f` 是浮点，`d` 是十进制                           |
|          字节大小          | `b` – byte 1 字节<br>`h` – half word 2 字节<br>`w` – word 4 字节<br>`g` – giant word 8 字节 |
|     expression 表达式      |           可以简写为：`expr 表达式`<br>`expression $rax`<br>`expression $rax = 1`           |
| `po` 表达式 `print` 表达式 |                                `po/x $rax`<br>`po (int)$rax`                                |

```swift
func foo() {
    let a = 10
    let b = a + 1

    print(b) // BREAKPOINT ⚠️
}

foo()

// LLDB:
//    (lldb) register read // 读取所有寄存器
//    General Purpose Registers:
//           rax = 0x000000010313e1d0
//           rbx = 0x000000010313e1d0
//           rcx = 0x0000000000000000
//           rdx = 0x0000000000000004
//           rdi = 0x00000000000003e3
//           rsi = 0x000000010045d080
//           rbp = 0x00007ffeefbff4c0
//           rsp = 0x00007ffeefbff4b0
//            r8 = 0x0000000010313e1e
//            r9 = 0x0000000010313e21
//           r10 = 0x00000000fffffffe
//           r11 = 0x0000000000000000
//           r12 = 0x0000000000000000
//           r13 = 0x0000000000000000
//           r14 = 0x0000000000000000
//           r15 = 0x0000000000000000
//           rip = 0x0000000100000a59  demo`main + 41 [inlined] demo.foo() -> () + 37 at main.swift:8
//      demo`main + 4 at main.swift:8
//        rflags = 0x0000000000000202
//            cs = 0x000000000000002b
//            fs = 0x0000000000000000
//            gs = 0x0000000000000000
//
//    (lldb) register read rax // 读取 rax 寄存器
//         rax = 0x000000010313e1d0
//    (lldb) register read/x rax // 以十六进制读取 rax 寄存器
//         rax = 0x000000010313e1d0
//    (lldb) register write rax 10 // 写入 rax 寄存器 10
//    (lldb) register read/d rax // 以十进制读取 rax 寄存器
//         rax = 10
//    (lldb) x 0x000000010313e1d0 // 读取内存的值
//    0x10313e1d0: 60 52 a3 93 ff 7f 00 00 02 00 00 00 00 00 00 00  `R..............
//    0x10313e1e0: 01 00 00 00 00 00 00 00 02 00 00 00 00 00 00 00  ................
//    (lldb) x/3xw 0x000000010313e1d0 // 以一个字（4 字节）读取，读取三段，十六进制表示
//    0x10313e1d0: 0x93a35260 0x00007fff 0x00000002
//    (lldb) x/4xg 0x000000010313e1d0  // 以 8 字节读取，读取四段，十六进制表示
//    0x10313e1d0: 0x00007fff93a35260 0x0000000000000002
//    0x10313e1e0: 0x0000000000000001 0x0000000000000002
```

|                  指令                  |                               解释                               |
| :------------------------------------: | :--------------------------------------------------------------: |
|    `thread step-over`、`next`、`n`     |          单步运⾏，把子函数当做整体⼀步执行（源码级别）          |
|     `thread step-in`、`step`、`s`      |           单步运行，遇到子函数会进⼊子函数（源码级别）           |
| `thread step-inst-over`、`nexti`、`ni` |          单步运行，把子函数当做整体⼀步执⾏（汇编级别）          |
|   `thread step-inst`、`stepi`、`si`    |           单步运行，遇到子函数会进入子函数（汇编级别）           |
|      `thread step-out`、`finish`       | 直接执行完当前函数的所有代码，返回到上一个函数（遇到断点会卡住） |

## enum & switch-case

 -->
<h2 id="reference">Reference</h2>
<ul>
<li><a href="https://docs.microsoft.com/en-us/windows-hardware/drivers/debugger/x64-architecture?view=drivers-server-ver15">x64 Architecture - Microsoft</a></li>
</ul>
</div>
                    <div class="post_footer">
                        
                        <div class="meta">
                            <div class="info">
                                <span class="field tags">
                                    <i class="ri-stack-line"></i>
                                    
                                    <a href="https://kingcos.me/tags/swift/">Swift</a>
                                    
                                    <a href="https://kingcos.me/tags/swift-%E6%8B%BE%E9%81%97/">Swift 拾遗</a>
                                    
                                </span>
                            </div>
                        </div>
                        
                    </div>
                </div>
                
                
                <div class="doc_comments"><div id="disqus_thread"></div>
<script type="application/javascript">
    var disqus_config = function () {
    
    
    
    };
    (function() {
        if (["localhost", "127.0.0.1"].indexOf(window.location.hostname) != -1) {
            document.getElementById('disqus_thread').innerHTML = 'Disqus comments not available by default when the website is previewed locally.';
            return;
        }
        var d = document, s = d.createElement('script'); s.async = true;
        s.src = '//' + "kingcos" + '.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="https://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a></div>
                
            </div>
        </div>
    </div>
    <a id="back_to_top" href="#" class="back_to_top"><i class="ri-arrow-up-s-line"></i></a>
    <footer class="footer">
    <div class="powered_by">
        <a href="https://kingcos.me">Powered by kingcos with love.</a>
    </div>

    <div class="footer_slogan">
        <span>❤️</span>
    </div>
</footer>
    <script src="https://kingcos.me/js/jquery-3.5.1.min.js"></script>
<link href="https://kingcos.me/css/fancybox.min.css" rel="stylesheet">
<script src="https://kingcos.me/js/fancybox.min.js"></script>
<script src="https://kingcos.me/js/zozo.js"></script>


<script type="text/javascript" async
    src="https://cdn.bootcss.com/mathjax/2.7.5/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
        MathJax.Hub.Config({
            tex2jax: {
                inlineMath: [['$', '$'], ['\\(', '\\)']],
                displayMath: [['$$', '$$'], ['\[\[', '\]\]']],
                processEscapes: true,
                processEnvironments: true,
                skipTags: ['script', 'noscript', 'style', 'textarea', 'pre'],
                TeX: {
                    equationNumbers: { autoNumber: "AMS" },
                    extensions: ["AMSmath.js", "AMSsymbols.js"]
                }
            }
        });

        MathJax.Hub.Queue(function () {
            
            
            
            var all = MathJax.Hub.getAllJax(), i;
            for (i = 0; i < all.length; i += 1) {
                all[i].SourceElement().parentNode.className += ' has-jax';
            }
        });
    </script>

<style>
    code.has-jax {
        font: inherit;
        font-size: 100%;
        background: inherit;
        border: inherit;
        color: #515151;
    }
</style>



<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-138311951-1', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>

</body>

</html>