<!DOCTYPE html>
<html lang="en" >
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="author" content="kingcos" />
	
	
	
	<title>Swift 拾遗 - struct &amp; class ｜ 萌面大道</title>
	
    
    
    <meta name="description" content="《Swift 拾遗》是一个关于 Swift 的新文章专辑，这个系列的文章将不会涉及基本语法的层面，而是尝试从底层「拾」起之前所忽视的内容。今天我们将一起简单探究 Swift 中的枚举 struct 和 class。" />
    

    
    
    <meta name="keywords" content="Hugo, theme, zozo" />
    

	
    
    <link rel="shortcut icon" href="https://kingcos.me/images/favicon.png" />

    <link rel="stylesheet" type="text/css" media="screen" href="https://kingcos.me/css/normalize.css" />
    <link rel="stylesheet" type="text/css" media="screen" href="https://cdn.jsdelivr.net/npm/animate.css@4.1.0/animate.min.css" />
    <link rel="stylesheet" type="text/css" media="screen" href="https://kingcos.me/css/zozo.css" />
	<link rel="stylesheet" type="text/css" media="screen" href="https://cdn.jsdelivr.net/npm/remixicon@2.5.0/fonts/remixicon.css" />
    <link rel="stylesheet" type="text/css" media="screen" href="https://kingcos.me/css/highlight.css" />

    
    
</head>

<script data-ad-client="ca-pub-9925978992661955" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>


<body>
    <div class="main animate__animated animate__fadeInDown">
        <div class="nav_container animated fadeInDown">
    <div class="site_nav" id="site_nav">
        <ul>
            
            <li>
                <a href="/">Home</a>
            </li>
            
            <li>
                <a href="/posts/">Archive</a>
            </li>
            
            <li>
                <a href="/tags/">Tags</a>
            </li>
            
            <li>
                <a href="/about/">About</a>
            </li>
            
        </ul>
    </div>
    <div class="menu_icon">
        <a id="menu_icon"><i class="ri-menu-line"></i></a>
    </div>
</div>
        <div class="header animated fadeInDown">
    <div class="site_title_container">
        <div class="site_title">
            <h1>
                <a href="https://kingcos.me/">
                    <span>萌面大道</span>
                </a>
            </h1>
        </div>
        <div class="description">
            <p class="sub_title">kingcos | Focus</p>
            <div class="my_socials">
                
                
                <a href="https://github.com/kingcos" title="github" target="_blank"><i class="ri-github-fill"></i></a>
                
                
                
                <a href="https://www.instagram.com/kingcos_v/" title="instagram" target="_blank"><i class="ri-instagram-fill"></i></a>
                
                
                
                <a href="https://twitter.com/kingcos_v" title="twitter" target="_blank"><i class="ri-twitter-fill"></i></a>
                
                
                
                <a href="https://weibo.com/u/1798410923" title="weibo" target="_blank"><i class="ri-weibo-fill"></i></a>
                
                
                <a href="https://kingcos.me/index.xml" type="application/rss+xml" title="rss" target="_blank"><i
                        class="ri-rss-fill"></i></a>
            </div>
        </div>
    </div>
</div>
        <div class="content">
            <div class="post_page">
                <div class="post animate__animated animate__fadeInDown">
                    <div class="post_title post_detail_title">
                        <h2><a href='/posts/2020/swift_struct_and_class/'>Swift 拾遗 - struct &amp; class</a></h2>
                        <span class="date">2020.08.06</span>
                    </div>
                    <div class="post_content markdown"><table>
<thead>
<tr>
<th style="text-align:center">Date</th>
<th style="text-align:center">Notes</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">2020-08-06</td>
<td style="text-align:center">首次提交</td>
</tr>
</tbody>
</table>
<h2 id="preface">Preface</h2>
<p>《Swift 拾遗》是一个关于 Swift 的新文章专辑，这个系列的文章将不会涉及基本语法的层面，而是尝试从底层「拾」起之前所忽视的内容。今天我们将一起简单探究 Swift 中的枚举 <code>struct</code> 和 <code>class</code>。&quot;</p>
<h2 id="结构体">结构体</h2>
<p>Swift 中的结构体被广泛使用，这是因为它和枚举都是值类型，在操作时会更加安全。我们这里定义一个简单的结构体：</p>
<div class="highlight"><pre class="chroma"><code class="language-swift" data-lang="swift"><span class="kd">struct</span> <span class="nc">Foo</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nv">a</span> <span class="p">=</span> <span class="mi">1</span>
    <span class="kd">var</span> <span class="nv">b</span> <span class="p">=</span> <span class="mi">1</span>
<span class="p">}</span>

<span class="kd">var</span> <span class="nv">foo</span> <span class="p">=</span> <span class="n">Foo</span><span class="p">()</span> <span class="c1">// Breakpoint 🔴</span>
<span class="bp">withUnsafeMutablePointer</span><span class="p">(</span><span class="n">to</span><span class="p">:</span> <span class="p">&amp;</span><span class="n">foo</span><span class="p">)</span> <span class="p">{</span> <span class="bp">print</span><span class="p">(</span><span class="s">&#34;</span><span class="si">\(</span><span class="nv">$0</span><span class="si">)</span><span class="s">&#34;</span><span class="p">)</span> <span class="p">}</span> <span class="c1">// 0x00000001000030d8</span>

<span class="bp">print</span><span class="p">(</span><span class="n">MemoryLayout</span><span class="p">&lt;</span><span class="n">Foo</span><span class="p">&gt;.</span><span class="n">size</span><span class="p">)</span>      <span class="c1">// 16</span>
<span class="bp">print</span><span class="p">(</span><span class="n">MemoryLayout</span><span class="p">&lt;</span><span class="n">Foo</span><span class="p">&gt;.</span><span class="bp">stride</span><span class="p">)</span>    <span class="c1">// 16</span>
<span class="bp">print</span><span class="p">(</span><span class="n">MemoryLayout</span><span class="p">&lt;</span><span class="n">Foo</span><span class="p">&gt;.</span><span class="n">alignment</span><span class="p">)</span> <span class="c1">// 8</span>

<span class="c1">// (lldb) memory read 0x00000001000030d8</span>
<span class="c1">// 0x1000030d8: 01 00 00 00 00 00 00 00 01 00 00 00 00 00 00 00  ................</span>
<span class="c1">// 0x1000030e8: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................</span>
</code></pre></div><p>我们可以从以上的内存地址和对应的值中看出，结构体变量的地址就是结构体中第一个成员的地址，结构体中所有成员的地址是连续的；结构体变量占用内存的大小受其成员的影响。</p>
<p>再来一个更加复杂的嵌套类型的例子：</p>
<div class="highlight"><pre class="chroma"><code class="language-swift" data-lang="swift"><span class="c1">// ...</span>

<span class="bp">print</span><span class="p">(</span><span class="n">MemoryLayout</span><span class="p">&lt;</span><span class="nb">Int</span><span class="p">&gt;.</span><span class="bp">stride</span><span class="p">)</span>     <span class="c1">// 8</span>
<span class="bp">print</span><span class="p">(</span><span class="n">MemoryLayout</span><span class="p">&lt;</span><span class="nb">Bool</span><span class="p">&gt;.</span><span class="bp">stride</span><span class="p">)</span>    <span class="c1">// 1</span>
<span class="bp">print</span><span class="p">(</span><span class="n">MemoryLayout</span><span class="p">&lt;</span><span class="nb">Double</span><span class="p">&gt;.</span><span class="bp">stride</span><span class="p">)</span>  <span class="c1">// 8</span>
<span class="bp">print</span><span class="p">(</span><span class="n">MemoryLayout</span><span class="p">&lt;</span><span class="n">Foo</span><span class="p">&gt;.</span><span class="bp">stride</span><span class="p">)</span>     <span class="c1">// 16</span>

<span class="kd">struct</span> <span class="nc">Bar</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nv">a</span><span class="p">:</span> <span class="nb">Int</span>
    <span class="kd">var</span> <span class="nv">b</span><span class="p">:</span> <span class="nb">Bool</span>
    <span class="kd">var</span> <span class="nv">c</span><span class="p">:</span> <span class="nb">Bool</span>
    <span class="kd">var</span> <span class="nv">d</span><span class="p">:</span> <span class="nb">Int</span>
    <span class="kd">var</span> <span class="nv">e</span><span class="p">:</span> <span class="n">Foo</span>
<span class="p">}</span>

<span class="kd">var</span> <span class="nv">bar</span> <span class="p">=</span> <span class="n">Bar</span><span class="p">(</span><span class="n">a</span><span class="p">:</span> <span class="mi">10</span><span class="p">,</span> <span class="n">b</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span> <span class="n">c</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span> <span class="n">d</span><span class="p">:</span> <span class="mi">11</span><span class="p">,</span> <span class="n">e</span><span class="p">:</span> <span class="n">Foo</span><span class="p">(</span><span class="n">a</span><span class="p">:</span> <span class="mi">11</span><span class="p">,</span> <span class="n">b</span><span class="p">:</span> <span class="mi">12</span><span class="p">))</span>
<span class="kd">var</span> <span class="nv">baz</span> <span class="p">=</span> <span class="mi">20</span>

<span class="bp">print</span><span class="p">(</span><span class="n">MemoryLayout</span><span class="p">&lt;</span><span class="n">Bar</span><span class="p">&gt;.</span><span class="n">size</span><span class="p">)</span>      <span class="c1">// 40</span>
<span class="bp">print</span><span class="p">(</span><span class="n">MemoryLayout</span><span class="p">&lt;</span><span class="n">Bar</span><span class="p">&gt;.</span><span class="bp">stride</span><span class="p">)</span>    <span class="c1">// 40</span>
<span class="bp">print</span><span class="p">(</span><span class="n">MemoryLayout</span><span class="p">&lt;</span><span class="n">Bar</span><span class="p">&gt;.</span><span class="n">alignment</span><span class="p">)</span> <span class="c1">// 8</span>

<span class="c1">// (lldb) po withUnsafeMutablePointer(to: &amp;bar) { print(&#34;\($0)&#34;) }</span>
<span class="c1">// 0x0000000100004290</span>
<span class="c1">// (lldb) x/6xg 0x0000000100004290</span>
<span class="c1">// 0x100004290: 0x000000000000000a 0x0000000000000101</span>
<span class="c1">// 0x1000042a0: 0x000000000000000b 0x000000000000000b</span>
<span class="c1">// 0x1000042b0: 0x000000000000000c 0x0000000000000014</span>
</code></pre></div><p>此时虽然 <code>Bar</code> 结构体中嵌套了 <code>Foo</code> 结构体，但其仍按照 <code>8</code> 个字节进行内存对齐；其中连续的两个 <code>Bool</code> 类型的变量共同占用一份 <code>8</code> 个字节的内存。</p>
<h2 id="类">类</h2>
<p>Swift 中的类不同于结构体和枚举，是引用类型，即初始化后会在堆上开辟空间存储类中的变量，并将首地址通过栈上的指针变量引用。</p>
<p>当函数调用时，将会在栈上开辟一块内存空间供函数使用。为了更加直观，我们在函数中分别创建类和结构体的变量并初始化：</p>
<div class="highlight"><pre class="chroma"><code class="language-swift" data-lang="swift"><span class="kd">class</span> <span class="nc">Foo</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nv">a</span> <span class="p">=</span> <span class="mi">1</span>
    <span class="kd">var</span> <span class="nv">b</span> <span class="p">=</span> <span class="mi">2</span>
<span class="p">}</span>

<span class="kd">struct</span> <span class="nc">Bar</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nv">a</span> <span class="p">=</span> <span class="mi">3</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="nf">test</span><span class="p">()</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nv">foo</span> <span class="p">=</span> <span class="n">Foo</span><span class="p">()</span>
    <span class="kd">var</span> <span class="nv">bar</span> <span class="p">=</span> <span class="n">Bar</span><span class="p">()</span>
    <span class="kd">var</span> <span class="nv">baz</span> <span class="p">=</span> <span class="mi">4</span>

    <span class="bp">withUnsafeMutablePointer</span><span class="p">(</span><span class="n">to</span><span class="p">:</span> <span class="p">&amp;</span><span class="n">foo</span><span class="p">)</span> <span class="p">{</span> <span class="bp">print</span><span class="p">(</span><span class="s">&#34;</span><span class="si">\(</span><span class="nv">$0</span><span class="si">)</span><span class="s">&#34;</span><span class="p">)</span> <span class="p">}</span> <span class="c1">// 0x00007ffeefbff4a8</span>
    <span class="bp">withUnsafeMutablePointer</span><span class="p">(</span><span class="n">to</span><span class="p">:</span> <span class="p">&amp;</span><span class="n">bar</span><span class="p">)</span> <span class="p">{</span> <span class="bp">print</span><span class="p">(</span><span class="s">&#34;</span><span class="si">\(</span><span class="nv">$0</span><span class="si">)</span><span class="s">&#34;</span><span class="p">)</span> <span class="p">}</span> <span class="c1">// 0x00007ffeefbff4a0</span>
    <span class="bp">withUnsafeMutablePointer</span><span class="p">(</span><span class="n">to</span><span class="p">:</span> <span class="p">&amp;</span><span class="n">baz</span><span class="p">)</span> <span class="p">{</span> <span class="bp">print</span><span class="p">(</span><span class="s">&#34;</span><span class="si">\(</span><span class="nv">$0</span><span class="si">)</span><span class="s">&#34;</span><span class="p">)</span> <span class="p">}</span> <span class="c1">// 0x00007ffeefbff498</span>
<span class="p">}</span>

<span class="bp">print</span><span class="p">(</span><span class="n">MemoryLayout</span><span class="p">&lt;</span><span class="n">Foo</span><span class="p">&gt;.</span><span class="n">size</span><span class="p">)</span>      <span class="c1">// 8</span>
<span class="bp">print</span><span class="p">(</span><span class="n">MemoryLayout</span><span class="p">&lt;</span><span class="n">Foo</span><span class="p">&gt;.</span><span class="bp">stride</span><span class="p">)</span>    <span class="c1">// 8</span>
<span class="bp">print</span><span class="p">(</span><span class="n">MemoryLayout</span><span class="p">&lt;</span><span class="n">Foo</span><span class="p">&gt;.</span><span class="n">alignment</span><span class="p">)</span> <span class="c1">// 8</span>

<span class="n">test</span><span class="p">()</span>
</code></pre></div><p>在 <code>test</code> 函数的栈空间中，内存地址从高地址开始分配，因此 <code>foo</code> 首地址位于 <code>0x00007ffeefbff4a8</code>，而 <code>bar</code> 位于 <code>0x00007ffeefbff4a0</code>，<code>baz</code> 位于 <code>0x00007ffeefbff498</code>，它们的地址差值均为 <code>8</code>，即占用 8 个字节：</p>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback">(lldb) p 0x00007ffeefbff4a8 - 0x00007ffeefbff4a0
(Int) $R0 = 8
(lldb) p 0x00007ffeefbff4a0 - 0x00007ffeefbff498
(Int) $R2 = 8
</code></pre></div><p>接下来我们尝试使用 LLDB 中的 <code>memory read</code> 或 <code>x</code> 命令，查看这些变量对应内存地址中的内容：</p>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback">(lldb) x --size 8 --format x --count 4 0x00007ffeefbff498
0x7ffeefbff498: 0x0000000000000001 0x0000000000000003
0x7ffeefbff4a8: 0x00000001005052a0 0x0000000000000000
</code></pre></div><p>其中只有 <code>0x7ffeefbff4a8</code> 即 <code>foo</code> 中的内容有些不同，其中并没有直接存储类中变量的值，而是一段堆空间的内存地址。</p>
<blockquote>
<p><strong>如何确定分配堆空间</strong></p>
<p>内存可以被分为很多不同的区域，其中栈空间无需开发者手动申请和回收，比如函数调用时栈空间系统自动分配，而当函数返回时又会被系统自动回收；而堆空间需要手动开辟和回收。在 C/C++ 中，通常在调用 <code>alloc</code> / <code>malloc</code> 函数时将会在堆上开辟一段内存空间。在 Swift 中我们也可以观察是否调用了 <code>malloc</code> 函数来判断构造方法到底有没有在堆上开辟内存空间。我们在 <code>var foo = Foo()</code> 一行打个断点，并 Xcode Menu - Debug - Debug Workflow - Always Show Disassembly：</p>
<div class="highlight"><pre class="chroma"><code class="language-asm" data-lang="asm"><span class="nf">demo</span><span class="err">`</span><span class="no">test</span><span class="p">():</span>
    <span class="c">; ...
</span><span class="c"></span><span class="err">-&gt;</span>  <span class="err">0</span><span class="nf">x1000011eb</span> <span class="err">&lt;+</span><span class="mi">43</span><span class="err">&gt;</span><span class="p">:</span>  <span class="no">movq</span>   <span class="nv">%rdx</span><span class="p">,</span> <span class="nv">%rdi</span>
    <span class="c">; ...
</span><span class="c"></span>    <span class="err">0</span><span class="nf">x100001206</span> <span class="err">&lt;+</span><span class="mi">70</span><span class="err">&gt;</span><span class="p">:</span>  <span class="no">callq</span>  <span class="mi">0x100001050</span>               <span class="c">; demo.Foo.__allocating_init() -&gt; demo.Foo at main.swift:1
</span><span class="c"></span>    <span class="c">; ...
</span></code></pre></div><p>跳转到 <code>0x100001206</code> 一行并 <code>si</code>（Step Into）：</p>
<div class="highlight"><pre class="chroma"><code class="language-asm" data-lang="asm"><span class="nf">demo</span><span class="err">`</span><span class="no">Foo.__allocating_init</span><span class="p">():</span>
<span class="err">-&gt;</span>  <span class="err">0</span><span class="nf">x100001050</span> <span class="err">&lt;+</span><span class="mi">0</span><span class="err">&gt;</span><span class="p">:</span>  <span class="no">pushq</span>  <span class="nv">%rbp</span>
    <span class="c">; ...
</span><span class="c"></span>    <span class="err">0</span><span class="nf">x100001064</span> <span class="err">&lt;+</span><span class="mi">20</span><span class="err">&gt;</span><span class="p">:</span> <span class="no">callq</span>  <span class="mi">0x100001c4e</span>               <span class="c">; symbol stub for: swift_allocObject
</span><span class="c"></span>    <span class="c">; ...
</span></code></pre></div><p>跳转到 <code>0x100001064</code> 一行并 <code>si</code>：</p>
<div class="highlight"><pre class="chroma"><code class="language-asm" data-lang="asm"><span class="nf">demo</span><span class="err">`</span><span class="no">swift_allocObject</span><span class="p">:</span>
<span class="err">-&gt;</span>  <span class="err">0</span><span class="nf">x100001c4e</span> <span class="err">&lt;+</span><span class="mi">0</span><span class="err">&gt;</span><span class="p">:</span> <span class="no">jmpq</span>   <span class="p">*</span><span class="mi">0x13ec</span><span class="p">(</span><span class="nv">%rip</span><span class="p">)</span>             <span class="c">; (void *)0x0000000100001cec
</span></code></pre></div><p>从此处连续 <code>si</code> 多次直到进入 <code>libdyld.dylib`dyld_stub_binder:</code> 中，跳转至最后一行并<code>si</code>：</p>
<div class="highlight"><pre class="chroma"><code class="language-asm" data-lang="asm"><span class="nf">libswiftCore.dylib</span><span class="err">`</span><span class="no">swift_allocObject</span><span class="p">:</span>
<span class="err">-&gt;</span>  <span class="err">0</span><span class="nf">x7fff6df5dd00</span> <span class="err">&lt;+</span><span class="mi">0</span><span class="err">&gt;</span><span class="p">:</span>  <span class="no">pushq</span>  <span class="nv">%rbp</span>
    <span class="c">; ...
</span><span class="c"></span>    <span class="err">0</span><span class="nf">x7fff6df5dd22</span> <span class="err">&lt;+</span><span class="mi">34</span><span class="err">&gt;</span><span class="p">:</span> <span class="no">callq</span>  <span class="mi">0x7fff6df5dc90</span>            <span class="c">; swift_slowAlloc
</span><span class="c"></span>    <span class="c">; ...
</span></code></pre></div><p>跳转到 <code>0x7fff6df5dd22</code> 一行并 <code>si</code>：</p>
<div class="highlight"><pre class="chroma"><code class="language-asm" data-lang="asm"><span class="nf">libswiftCore.dylib</span><span class="err">`</span><span class="no">swift_slowAlloc</span><span class="p">:</span>
<span class="err">-&gt;</span>  <span class="err">0</span><span class="nf">x7fff6df5dc90</span> <span class="err">&lt;+</span><span class="mi">0</span><span class="err">&gt;</span><span class="p">:</span>  <span class="no">pushq</span>  <span class="nv">%rbp</span>
    <span class="c">; ...
</span><span class="c"></span>    <span class="err">0</span><span class="nf">x7fff6df5dca4</span> <span class="err">&lt;+</span><span class="mi">20</span><span class="err">&gt;</span><span class="p">:</span> <span class="no">callq</span>  <span class="mi">0x7fff6dfda28c</span>            <span class="c">; symbol stub for: malloc
</span><span class="c"></span>    <span class="c">; ...
</span></code></pre></div><p>此时我们就能看到符号桩 <code>malloc</code>，也可以进一步 <code>si</code> 直到进入 <code>libsystem_malloc.dylib`malloc:</code>，Obj-C 中的 <code>alloc</code> 其实也来自这里，这也验证了类的对象分配在堆空间。关于 <code>malloc</code> 可详见《<a href="/posts/2019/nsobject_in_ios">iOS 中的 NSObject</a>》一文。</p>
</blockquote>
<p>我们继续查看这个内存地址中的内容：</p>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback">(lldb) x --size 8 --format x --count 4 0x00000001005052a0
0x1005052a0: 0x00000001000031a8 0x0000000000000002
0x1005052b0: 0x0000000000000001 0x0000000000000002
</code></pre></div><p>虽然 <code>Foo</code> 类型的变量只占用 8 个字节，这是因为在 64 位下，指针存储的内存地址占用 8 个字节。而指针指向的内存地址，即对象实际占用的内存空间这里我们可以看出一共占用了 32 个字节，其中的内容如下表：</p>
<table>
<thead>
<tr>
<th style="text-align:center">内存地址</th>
<th style="text-align:center">内容</th>
<th style="text-align:center">信息</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">0x1005052a0</td>
<td style="text-align:center">0x00000001000031a8</td>
<td style="text-align:center">指向类型信息</td>
</tr>
<tr>
<td style="text-align:center">0x1005052a8</td>
<td style="text-align:center">0x0000000000000002</td>
<td style="text-align:center">引用计数</td>
</tr>
<tr>
<td style="text-align:center">0x1005052b0</td>
<td style="text-align:center">0x0000000000000001</td>
<td style="text-align:center"><code>bar.a</code></td>
</tr>
<tr>
<td style="text-align:center">0x1005052b8</td>
<td style="text-align:center">0x0000000000000002</td>
<td style="text-align:center"><code>bar.b</code></td>
</tr>
</tbody>
</table>
<p>我们也可以通过 <code>Foundation</code> 中的 <code>malloc_size</code> 函数获取对象实际被分配的内存大小：</p>
<div class="highlight"><pre class="chroma"><code class="language-swift" data-lang="swift"><span class="kd">import</span> <span class="nc">Foundation</span>

<span class="c1">// ...</span>

<span class="kd">var</span> <span class="nv">foo</span> <span class="p">=</span> <span class="n">Foo</span><span class="p">()</span>

<span class="c1">// Swift / Obj-C 中的对象将按照 16 的倍数进行对齐</span>
<span class="bp">print</span><span class="p">(</span><span class="n">malloc_size</span><span class="p">(</span><span class="nb">Unmanaged</span><span class="p">.</span><span class="n">passUnretained</span><span class="p">(</span><span class="n">foo</span><span class="p">).</span><span class="n">toOpaque</span><span class="p">()))</span> <span class="c1">// 32</span>

<span class="c1">// class_getInstanceSize 并非对象实际被分配的内存大小</span>
<span class="bp">print</span><span class="p">(</span><span class="n">class_getInstanceSize</span><span class="p">(</span><span class="n">Foo</span><span class="p">.</span><span class="kc">self</span><span class="p">))</span>                       <span class="c1">// 32</span>
<span class="bp">print</span><span class="p">(</span><span class="n">class_getInstanceSize</span><span class="p">(</span><span class="n">type</span><span class="p">(</span><span class="n">of</span><span class="p">:</span> <span class="n">foo</span><span class="p">)))</span>                  <span class="c1">// 32</span>
</code></pre></div><h2 id="reference">Reference</h2>
<ul>
<li><a href="/posts/2019/nsobject_in_ios">iOS 中的 NSObject - kingcos</a></li>
</ul>
</div>
                    <div class="post_footer">
                        
                        <div class="meta">
                            <div class="info">
                                <span class="field tags">
                                    <i class="ri-stack-line"></i>
                                    
                                    <a href="https://kingcos.me/tags/swift/">Swift</a>
                                    
                                    <a href="https://kingcos.me/tags/swift-%E6%8B%BE%E9%81%97/">Swift 拾遗</a>
                                    
                                </span>
                            </div>
                        </div>
                        
                    </div>
                </div>
                
                
                <div class="doc_comments"><div id="disqus_thread"></div>
<script type="application/javascript">
    var disqus_config = function () {
    
    
    
    };
    (function() {
        if (["localhost", "127.0.0.1"].indexOf(window.location.hostname) != -1) {
            document.getElementById('disqus_thread').innerHTML = 'Disqus comments not available by default when the website is previewed locally.';
            return;
        }
        var d = document, s = d.createElement('script'); s.async = true;
        s.src = '//' + "kingcos" + '.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="https://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a></div>
                
            </div>
        </div>
    </div>
    <a id="back_to_top" href="#" class="back_to_top"><i class="ri-arrow-up-s-line"></i></a>
    <footer class="footer">
    <div class="powered_by">
        <a href="https://kingcos.me">Powered by kingcos with love.</a>
    </div>

    <div class="footer_slogan">
        <span>❤️</span>
    </div>
</footer>
    <script src="https://kingcos.me/js/jquery-3.5.1.min.js"></script>
<link href="https://kingcos.me/css/fancybox.min.css" rel="stylesheet">
<script src="https://kingcos.me/js/fancybox.min.js"></script>
<script src="https://kingcos.me/js/zozo.js"></script>


<script type="text/javascript" async
    src="https://cdn.bootcss.com/mathjax/2.7.5/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
        MathJax.Hub.Config({
            tex2jax: {
                inlineMath: [['$', '$'], ['\\(', '\\)']],
                displayMath: [['$$', '$$'], ['\[\[', '\]\]']],
                processEscapes: true,
                processEnvironments: true,
                skipTags: ['script', 'noscript', 'style', 'textarea', 'pre'],
                TeX: {
                    equationNumbers: { autoNumber: "AMS" },
                    extensions: ["AMSmath.js", "AMSsymbols.js"]
                }
            }
        });

        MathJax.Hub.Queue(function () {
            
            
            
            var all = MathJax.Hub.getAllJax(), i;
            for (i = 0; i < all.length; i += 1) {
                all[i].SourceElement().parentNode.className += ' has-jax';
            }
        });
    </script>

<style>
    code.has-jax {
        font: inherit;
        font-size: 100%;
        background: inherit;
        border: inherit;
        color: #515151;
    }
</style>



<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-138311951-1', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>

</body>

</html>