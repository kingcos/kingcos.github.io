<!DOCTYPE html>
<html lang="en" >
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="author" content="kingcos" />
	
	
	
	<title>Swift æ‹¾é— - struct &amp; class ï½œ èŒé¢å¤§é“</title>
	
    
    
    <meta name="description" content="ã€ŠSwift æ‹¾é—ã€‹æ˜¯ä¸€ä¸ªå…³äº Swift çš„æ–°æ–‡ç« ä¸“è¾‘ï¼Œè¿™ä¸ªç³»åˆ—çš„æ–‡ç« å°†ä¸ä¼šæ¶‰åŠåŸºæœ¬è¯­æ³•çš„å±‚é¢ï¼Œè€Œæ˜¯å°è¯•ä»åº•å±‚ã€Œæ‹¾ã€èµ·ä¹‹å‰æ‰€å¿½è§†çš„å†…å®¹ã€‚ä»Šå¤©æˆ‘ä»¬å°†ä¸€èµ·ç®€å•æ¢ç©¶ Swift ä¸­çš„æšä¸¾ struct å’Œ classã€‚" />
    

    
    
    <meta name="keywords" content="Hugo, theme, zozo" />
    

	
    
    <link rel="shortcut icon" href="https://kingcos.me/images/favicon.png" />

    <link rel="stylesheet" type="text/css" media="screen" href="https://kingcos.me/css/normalize.css" />
    <link rel="stylesheet" type="text/css" media="screen" href="https://cdn.jsdelivr.net/npm/animate.css@4.1.0/animate.min.css" />
    <link rel="stylesheet" type="text/css" media="screen" href="https://kingcos.me/css/zozo.css" />
	<link rel="stylesheet" type="text/css" media="screen" href="https://cdn.jsdelivr.net/npm/remixicon@2.5.0/fonts/remixicon.css" />
    <link rel="stylesheet" type="text/css" media="screen" href="https://kingcos.me/css/highlight.css" />

    
    
</head>

<script data-ad-client="ca-pub-9925978992661955" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>


<body>
    <div class="main animate__animated animate__fadeInDown">
        <div class="nav_container animated fadeInDown">
    <div class="site_nav" id="site_nav">
        <ul>
            
            <li>
                <a href="/">Home</a>
            </li>
            
            <li>
                <a href="/posts/">Archive</a>
            </li>
            
            <li>
                <a href="/tags/">Tags</a>
            </li>
            
            <li>
                <a href="/about/">About</a>
            </li>
            
        </ul>
    </div>
    <div class="menu_icon">
        <a id="menu_icon"><i class="ri-menu-line"></i></a>
    </div>
</div>
        <div class="header animated fadeInDown">
    <div class="site_title_container">
        <div class="site_title">
            <h1>
                <a href="https://kingcos.me/">
                    <span>èŒé¢å¤§é“</span>
                </a>
            </h1>
        </div>
        <div class="description">
            <p class="sub_title">kingcos | Focus</p>
            <div class="my_socials">
                
                
                <a href="https://github.com/kingcos" title="github" target="_blank"><i class="ri-github-fill"></i></a>
                
                
                
                <a href="https://www.instagram.com/kingcos_v/" title="instagram" target="_blank"><i class="ri-instagram-fill"></i></a>
                
                
                
                <a href="https://twitter.com/kingcos_v" title="twitter" target="_blank"><i class="ri-twitter-fill"></i></a>
                
                
                
                <a href="https://weibo.com/u/1798410923" title="weibo" target="_blank"><i class="ri-weibo-fill"></i></a>
                
                
                <a href="https://kingcos.me/index.xml" type="application/rss+xml" title="rss" target="_blank"><i
                        class="ri-rss-fill"></i></a>
            </div>
        </div>
    </div>
</div>
        <div class="content">
            <div class="post_page">
                <div class="post animate__animated animate__fadeInDown">
                    <div class="post_title post_detail_title">
                        <h2><a href='/posts/2020/swift_struct_and_class/'>Swift æ‹¾é— - struct &amp; class</a></h2>
                        <span class="date">2020.08.06</span>
                    </div>
                    <div class="post_content markdown"><table>
<thead>
<tr>
<th style="text-align:center">Date</th>
<th style="text-align:center">Notes</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">2020-08-06</td>
<td style="text-align:center">é¦–æ¬¡æäº¤</td>
</tr>
</tbody>
</table>
<h2 id="preface">Preface</h2>
<p>ã€ŠSwift æ‹¾é—ã€‹æ˜¯ä¸€ä¸ªå…³äº Swift çš„æ–°æ–‡ç« ä¸“è¾‘ï¼Œè¿™ä¸ªç³»åˆ—çš„æ–‡ç« å°†ä¸ä¼šæ¶‰åŠåŸºæœ¬è¯­æ³•çš„å±‚é¢ï¼Œè€Œæ˜¯å°è¯•ä»åº•å±‚ã€Œæ‹¾ã€èµ·ä¹‹å‰æ‰€å¿½è§†çš„å†…å®¹ã€‚ä»Šå¤©æˆ‘ä»¬å°†ä¸€èµ·ç®€å•æ¢ç©¶ Swift ä¸­çš„æšä¸¾ <code>struct</code> å’Œ <code>class</code>ã€‚&quot;</p>
<h2 id="ç»“æ„ä½“">ç»“æ„ä½“</h2>
<p>Swift ä¸­çš„ç»“æ„ä½“è¢«å¹¿æ³›ä½¿ç”¨ï¼Œè¿™æ˜¯å› ä¸ºå®ƒå’Œæšä¸¾éƒ½æ˜¯å€¼ç±»å‹ï¼Œåœ¨æ“ä½œæ—¶ä¼šæ›´åŠ å®‰å…¨ã€‚æˆ‘ä»¬è¿™é‡Œå®šä¹‰ä¸€ä¸ªç®€å•çš„ç»“æ„ä½“ï¼š</p>
<div class="highlight"><pre class="chroma"><code class="language-swift" data-lang="swift"><span class="kd">struct</span> <span class="nc">Foo</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nv">a</span> <span class="p">=</span> <span class="mi">1</span>
    <span class="kd">var</span> <span class="nv">b</span> <span class="p">=</span> <span class="mi">1</span>
<span class="p">}</span>

<span class="kd">var</span> <span class="nv">foo</span> <span class="p">=</span> <span class="n">Foo</span><span class="p">()</span> <span class="c1">// Breakpoint ğŸ”´</span>
<span class="bp">withUnsafeMutablePointer</span><span class="p">(</span><span class="n">to</span><span class="p">:</span> <span class="p">&amp;</span><span class="n">foo</span><span class="p">)</span> <span class="p">{</span> <span class="bp">print</span><span class="p">(</span><span class="s">&#34;</span><span class="si">\(</span><span class="nv">$0</span><span class="si">)</span><span class="s">&#34;</span><span class="p">)</span> <span class="p">}</span> <span class="c1">// 0x00000001000030d8</span>

<span class="bp">print</span><span class="p">(</span><span class="n">MemoryLayout</span><span class="p">&lt;</span><span class="n">Foo</span><span class="p">&gt;.</span><span class="n">size</span><span class="p">)</span>      <span class="c1">// 16</span>
<span class="bp">print</span><span class="p">(</span><span class="n">MemoryLayout</span><span class="p">&lt;</span><span class="n">Foo</span><span class="p">&gt;.</span><span class="bp">stride</span><span class="p">)</span>    <span class="c1">// 16</span>
<span class="bp">print</span><span class="p">(</span><span class="n">MemoryLayout</span><span class="p">&lt;</span><span class="n">Foo</span><span class="p">&gt;.</span><span class="n">alignment</span><span class="p">)</span> <span class="c1">// 8</span>

<span class="c1">// (lldb) memory read 0x00000001000030d8</span>
<span class="c1">// 0x1000030d8: 01 00 00 00 00 00 00 00 01 00 00 00 00 00 00 00  ................</span>
<span class="c1">// 0x1000030e8: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................</span>
</code></pre></div><p>æˆ‘ä»¬å¯ä»¥ä»ä»¥ä¸Šçš„å†…å­˜åœ°å€å’Œå¯¹åº”çš„å€¼ä¸­çœ‹å‡ºï¼Œç»“æ„ä½“å˜é‡çš„åœ°å€å°±æ˜¯ç»“æ„ä½“ä¸­ç¬¬ä¸€ä¸ªæˆå‘˜çš„åœ°å€ï¼Œç»“æ„ä½“ä¸­æ‰€æœ‰æˆå‘˜çš„åœ°å€æ˜¯è¿ç»­çš„ï¼›ç»“æ„ä½“å˜é‡å ç”¨å†…å­˜çš„å¤§å°å—å…¶æˆå‘˜çš„å½±å“ã€‚</p>
<p>å†æ¥ä¸€ä¸ªæ›´åŠ å¤æ‚çš„åµŒå¥—ç±»å‹çš„ä¾‹å­ï¼š</p>
<div class="highlight"><pre class="chroma"><code class="language-swift" data-lang="swift"><span class="c1">// ...</span>

<span class="bp">print</span><span class="p">(</span><span class="n">MemoryLayout</span><span class="p">&lt;</span><span class="nb">Int</span><span class="p">&gt;.</span><span class="bp">stride</span><span class="p">)</span>     <span class="c1">// 8</span>
<span class="bp">print</span><span class="p">(</span><span class="n">MemoryLayout</span><span class="p">&lt;</span><span class="nb">Bool</span><span class="p">&gt;.</span><span class="bp">stride</span><span class="p">)</span>    <span class="c1">// 1</span>
<span class="bp">print</span><span class="p">(</span><span class="n">MemoryLayout</span><span class="p">&lt;</span><span class="nb">Double</span><span class="p">&gt;.</span><span class="bp">stride</span><span class="p">)</span>  <span class="c1">// 8</span>
<span class="bp">print</span><span class="p">(</span><span class="n">MemoryLayout</span><span class="p">&lt;</span><span class="n">Foo</span><span class="p">&gt;.</span><span class="bp">stride</span><span class="p">)</span>     <span class="c1">// 16</span>

<span class="kd">struct</span> <span class="nc">Bar</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nv">a</span><span class="p">:</span> <span class="nb">Int</span>
    <span class="kd">var</span> <span class="nv">b</span><span class="p">:</span> <span class="nb">Bool</span>
    <span class="kd">var</span> <span class="nv">c</span><span class="p">:</span> <span class="nb">Bool</span>
    <span class="kd">var</span> <span class="nv">d</span><span class="p">:</span> <span class="nb">Int</span>
    <span class="kd">var</span> <span class="nv">e</span><span class="p">:</span> <span class="n">Foo</span>
<span class="p">}</span>

<span class="kd">var</span> <span class="nv">bar</span> <span class="p">=</span> <span class="n">Bar</span><span class="p">(</span><span class="n">a</span><span class="p">:</span> <span class="mi">10</span><span class="p">,</span> <span class="n">b</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span> <span class="n">c</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span> <span class="n">d</span><span class="p">:</span> <span class="mi">11</span><span class="p">,</span> <span class="n">e</span><span class="p">:</span> <span class="n">Foo</span><span class="p">(</span><span class="n">a</span><span class="p">:</span> <span class="mi">11</span><span class="p">,</span> <span class="n">b</span><span class="p">:</span> <span class="mi">12</span><span class="p">))</span>
<span class="kd">var</span> <span class="nv">baz</span> <span class="p">=</span> <span class="mi">20</span>

<span class="bp">print</span><span class="p">(</span><span class="n">MemoryLayout</span><span class="p">&lt;</span><span class="n">Bar</span><span class="p">&gt;.</span><span class="n">size</span><span class="p">)</span>      <span class="c1">// 40</span>
<span class="bp">print</span><span class="p">(</span><span class="n">MemoryLayout</span><span class="p">&lt;</span><span class="n">Bar</span><span class="p">&gt;.</span><span class="bp">stride</span><span class="p">)</span>    <span class="c1">// 40</span>
<span class="bp">print</span><span class="p">(</span><span class="n">MemoryLayout</span><span class="p">&lt;</span><span class="n">Bar</span><span class="p">&gt;.</span><span class="n">alignment</span><span class="p">)</span> <span class="c1">// 8</span>

<span class="c1">// (lldb) po withUnsafeMutablePointer(to: &amp;bar) { print(&#34;\($0)&#34;) }</span>
<span class="c1">// 0x0000000100004290</span>
<span class="c1">// (lldb) x/6xg 0x0000000100004290</span>
<span class="c1">// 0x100004290: 0x000000000000000a 0x0000000000000101</span>
<span class="c1">// 0x1000042a0: 0x000000000000000b 0x000000000000000b</span>
<span class="c1">// 0x1000042b0: 0x000000000000000c 0x0000000000000014</span>
</code></pre></div><p>æ­¤æ—¶è™½ç„¶ <code>Bar</code> ç»“æ„ä½“ä¸­åµŒå¥—äº† <code>Foo</code> ç»“æ„ä½“ï¼Œä½†å…¶ä»æŒ‰ç…§ <code>8</code> ä¸ªå­—èŠ‚è¿›è¡Œå†…å­˜å¯¹é½ï¼›å…¶ä¸­è¿ç»­çš„ä¸¤ä¸ª <code>Bool</code> ç±»å‹çš„å˜é‡å…±åŒå ç”¨ä¸€ä»½ <code>8</code> ä¸ªå­—èŠ‚çš„å†…å­˜ã€‚</p>
<h2 id="ç±»">ç±»</h2>
<p>Swift ä¸­çš„ç±»ä¸åŒäºç»“æ„ä½“å’Œæšä¸¾ï¼Œæ˜¯å¼•ç”¨ç±»å‹ï¼Œå³åˆå§‹åŒ–åä¼šåœ¨å †ä¸Šå¼€è¾Ÿç©ºé—´å­˜å‚¨ç±»ä¸­çš„å˜é‡ï¼Œå¹¶å°†é¦–åœ°å€é€šè¿‡æ ˆä¸Šçš„æŒ‡é’ˆå˜é‡å¼•ç”¨ã€‚</p>
<p>å½“å‡½æ•°è°ƒç”¨æ—¶ï¼Œå°†ä¼šåœ¨æ ˆä¸Šå¼€è¾Ÿä¸€å—å†…å­˜ç©ºé—´ä¾›å‡½æ•°ä½¿ç”¨ã€‚ä¸ºäº†æ›´åŠ ç›´è§‚ï¼Œæˆ‘ä»¬åœ¨å‡½æ•°ä¸­åˆ†åˆ«åˆ›å»ºç±»å’Œç»“æ„ä½“çš„å˜é‡å¹¶åˆå§‹åŒ–ï¼š</p>
<div class="highlight"><pre class="chroma"><code class="language-swift" data-lang="swift"><span class="kd">class</span> <span class="nc">Foo</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nv">a</span> <span class="p">=</span> <span class="mi">1</span>
    <span class="kd">var</span> <span class="nv">b</span> <span class="p">=</span> <span class="mi">2</span>
<span class="p">}</span>

<span class="kd">struct</span> <span class="nc">Bar</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nv">a</span> <span class="p">=</span> <span class="mi">3</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="nf">test</span><span class="p">()</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nv">foo</span> <span class="p">=</span> <span class="n">Foo</span><span class="p">()</span>
    <span class="kd">var</span> <span class="nv">bar</span> <span class="p">=</span> <span class="n">Bar</span><span class="p">()</span>
    <span class="kd">var</span> <span class="nv">baz</span> <span class="p">=</span> <span class="mi">4</span>

    <span class="bp">withUnsafeMutablePointer</span><span class="p">(</span><span class="n">to</span><span class="p">:</span> <span class="p">&amp;</span><span class="n">foo</span><span class="p">)</span> <span class="p">{</span> <span class="bp">print</span><span class="p">(</span><span class="s">&#34;</span><span class="si">\(</span><span class="nv">$0</span><span class="si">)</span><span class="s">&#34;</span><span class="p">)</span> <span class="p">}</span> <span class="c1">// 0x00007ffeefbff4a8</span>
    <span class="bp">withUnsafeMutablePointer</span><span class="p">(</span><span class="n">to</span><span class="p">:</span> <span class="p">&amp;</span><span class="n">bar</span><span class="p">)</span> <span class="p">{</span> <span class="bp">print</span><span class="p">(</span><span class="s">&#34;</span><span class="si">\(</span><span class="nv">$0</span><span class="si">)</span><span class="s">&#34;</span><span class="p">)</span> <span class="p">}</span> <span class="c1">// 0x00007ffeefbff4a0</span>
    <span class="bp">withUnsafeMutablePointer</span><span class="p">(</span><span class="n">to</span><span class="p">:</span> <span class="p">&amp;</span><span class="n">baz</span><span class="p">)</span> <span class="p">{</span> <span class="bp">print</span><span class="p">(</span><span class="s">&#34;</span><span class="si">\(</span><span class="nv">$0</span><span class="si">)</span><span class="s">&#34;</span><span class="p">)</span> <span class="p">}</span> <span class="c1">// 0x00007ffeefbff498</span>
<span class="p">}</span>

<span class="bp">print</span><span class="p">(</span><span class="n">MemoryLayout</span><span class="p">&lt;</span><span class="n">Foo</span><span class="p">&gt;.</span><span class="n">size</span><span class="p">)</span>      <span class="c1">// 8</span>
<span class="bp">print</span><span class="p">(</span><span class="n">MemoryLayout</span><span class="p">&lt;</span><span class="n">Foo</span><span class="p">&gt;.</span><span class="bp">stride</span><span class="p">)</span>    <span class="c1">// 8</span>
<span class="bp">print</span><span class="p">(</span><span class="n">MemoryLayout</span><span class="p">&lt;</span><span class="n">Foo</span><span class="p">&gt;.</span><span class="n">alignment</span><span class="p">)</span> <span class="c1">// 8</span>

<span class="n">test</span><span class="p">()</span>
</code></pre></div><p>åœ¨ <code>test</code> å‡½æ•°çš„æ ˆç©ºé—´ä¸­ï¼Œå†…å­˜åœ°å€ä»é«˜åœ°å€å¼€å§‹åˆ†é…ï¼Œå› æ­¤ <code>foo</code> é¦–åœ°å€ä½äº <code>0x00007ffeefbff4a8</code>ï¼Œè€Œ <code>bar</code> ä½äº <code>0x00007ffeefbff4a0</code>ï¼Œ<code>baz</code> ä½äº <code>0x00007ffeefbff498</code>ï¼Œå®ƒä»¬çš„åœ°å€å·®å€¼å‡ä¸º <code>8</code>ï¼Œå³å ç”¨ 8 ä¸ªå­—èŠ‚ï¼š</p>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback">(lldb) p 0x00007ffeefbff4a8 - 0x00007ffeefbff4a0
(Int) $R0 = 8
(lldb) p 0x00007ffeefbff4a0 - 0x00007ffeefbff498
(Int) $R2 = 8
</code></pre></div><p>æ¥ä¸‹æ¥æˆ‘ä»¬å°è¯•ä½¿ç”¨ LLDB ä¸­çš„ <code>memory read</code> æˆ– <code>x</code> å‘½ä»¤ï¼ŒæŸ¥çœ‹è¿™äº›å˜é‡å¯¹åº”å†…å­˜åœ°å€ä¸­çš„å†…å®¹ï¼š</p>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback">(lldb) x --size 8 --format x --count 4 0x00007ffeefbff498
0x7ffeefbff498: 0x0000000000000001 0x0000000000000003
0x7ffeefbff4a8: 0x00000001005052a0 0x0000000000000000
</code></pre></div><p>å…¶ä¸­åªæœ‰ <code>0x7ffeefbff4a8</code> å³ <code>foo</code> ä¸­çš„å†…å®¹æœ‰äº›ä¸åŒï¼Œå…¶ä¸­å¹¶æ²¡æœ‰ç›´æ¥å­˜å‚¨ç±»ä¸­å˜é‡çš„å€¼ï¼Œè€Œæ˜¯ä¸€æ®µå †ç©ºé—´çš„å†…å­˜åœ°å€ã€‚</p>
<blockquote>
<p><strong>å¦‚ä½•ç¡®å®šåˆ†é…å †ç©ºé—´</strong></p>
<p>å†…å­˜å¯ä»¥è¢«åˆ†ä¸ºå¾ˆå¤šä¸åŒçš„åŒºåŸŸï¼Œå…¶ä¸­æ ˆç©ºé—´æ— éœ€å¼€å‘è€…æ‰‹åŠ¨ç”³è¯·å’Œå›æ”¶ï¼Œæ¯”å¦‚å‡½æ•°è°ƒç”¨æ—¶æ ˆç©ºé—´ç³»ç»Ÿè‡ªåŠ¨åˆ†é…ï¼Œè€Œå½“å‡½æ•°è¿”å›æ—¶åˆä¼šè¢«ç³»ç»Ÿè‡ªåŠ¨å›æ”¶ï¼›è€Œå †ç©ºé—´éœ€è¦æ‰‹åŠ¨å¼€è¾Ÿå’Œå›æ”¶ã€‚åœ¨ C/C++ ä¸­ï¼Œé€šå¸¸åœ¨è°ƒç”¨ <code>alloc</code> / <code>malloc</code> å‡½æ•°æ—¶å°†ä¼šåœ¨å †ä¸Šå¼€è¾Ÿä¸€æ®µå†…å­˜ç©ºé—´ã€‚åœ¨ Swift ä¸­æˆ‘ä»¬ä¹Ÿå¯ä»¥è§‚å¯Ÿæ˜¯å¦è°ƒç”¨äº† <code>malloc</code> å‡½æ•°æ¥åˆ¤æ–­æ„é€ æ–¹æ³•åˆ°åº•æœ‰æ²¡æœ‰åœ¨å †ä¸Šå¼€è¾Ÿå†…å­˜ç©ºé—´ã€‚æˆ‘ä»¬åœ¨ <code>var foo = Foo()</code> ä¸€è¡Œæ‰“ä¸ªæ–­ç‚¹ï¼Œå¹¶ Xcode Menu - Debug - Debug Workflow - Always Show Disassemblyï¼š</p>
<div class="highlight"><pre class="chroma"><code class="language-asm" data-lang="asm"><span class="nf">demo</span><span class="err">`</span><span class="no">test</span><span class="p">():</span>
    <span class="c">; ...
</span><span class="c"></span><span class="err">-&gt;</span>  <span class="err">0</span><span class="nf">x1000011eb</span> <span class="err">&lt;+</span><span class="mi">43</span><span class="err">&gt;</span><span class="p">:</span>  <span class="no">movq</span>   <span class="nv">%rdx</span><span class="p">,</span> <span class="nv">%rdi</span>
    <span class="c">; ...
</span><span class="c"></span>    <span class="err">0</span><span class="nf">x100001206</span> <span class="err">&lt;+</span><span class="mi">70</span><span class="err">&gt;</span><span class="p">:</span>  <span class="no">callq</span>  <span class="mi">0x100001050</span>               <span class="c">; demo.Foo.__allocating_init() -&gt; demo.Foo at main.swift:1
</span><span class="c"></span>    <span class="c">; ...
</span></code></pre></div><p>è·³è½¬åˆ° <code>0x100001206</code> ä¸€è¡Œå¹¶ <code>si</code>ï¼ˆStep Intoï¼‰ï¼š</p>
<div class="highlight"><pre class="chroma"><code class="language-asm" data-lang="asm"><span class="nf">demo</span><span class="err">`</span><span class="no">Foo.__allocating_init</span><span class="p">():</span>
<span class="err">-&gt;</span>  <span class="err">0</span><span class="nf">x100001050</span> <span class="err">&lt;+</span><span class="mi">0</span><span class="err">&gt;</span><span class="p">:</span>  <span class="no">pushq</span>  <span class="nv">%rbp</span>
    <span class="c">; ...
</span><span class="c"></span>    <span class="err">0</span><span class="nf">x100001064</span> <span class="err">&lt;+</span><span class="mi">20</span><span class="err">&gt;</span><span class="p">:</span> <span class="no">callq</span>  <span class="mi">0x100001c4e</span>               <span class="c">; symbol stub for: swift_allocObject
</span><span class="c"></span>    <span class="c">; ...
</span></code></pre></div><p>è·³è½¬åˆ° <code>0x100001064</code> ä¸€è¡Œå¹¶ <code>si</code>ï¼š</p>
<div class="highlight"><pre class="chroma"><code class="language-asm" data-lang="asm"><span class="nf">demo</span><span class="err">`</span><span class="no">swift_allocObject</span><span class="p">:</span>
<span class="err">-&gt;</span>  <span class="err">0</span><span class="nf">x100001c4e</span> <span class="err">&lt;+</span><span class="mi">0</span><span class="err">&gt;</span><span class="p">:</span> <span class="no">jmpq</span>   <span class="p">*</span><span class="mi">0x13ec</span><span class="p">(</span><span class="nv">%rip</span><span class="p">)</span>             <span class="c">; (void *)0x0000000100001cec
</span></code></pre></div><p>ä»æ­¤å¤„è¿ç»­ <code>si</code> å¤šæ¬¡ç›´åˆ°è¿›å…¥ <code>libdyld.dylib`dyld_stub_binder:</code> ä¸­ï¼Œè·³è½¬è‡³æœ€åä¸€è¡Œå¹¶<code>si</code>ï¼š</p>
<div class="highlight"><pre class="chroma"><code class="language-asm" data-lang="asm"><span class="nf">libswiftCore.dylib</span><span class="err">`</span><span class="no">swift_allocObject</span><span class="p">:</span>
<span class="err">-&gt;</span>  <span class="err">0</span><span class="nf">x7fff6df5dd00</span> <span class="err">&lt;+</span><span class="mi">0</span><span class="err">&gt;</span><span class="p">:</span>  <span class="no">pushq</span>  <span class="nv">%rbp</span>
    <span class="c">; ...
</span><span class="c"></span>    <span class="err">0</span><span class="nf">x7fff6df5dd22</span> <span class="err">&lt;+</span><span class="mi">34</span><span class="err">&gt;</span><span class="p">:</span> <span class="no">callq</span>  <span class="mi">0x7fff6df5dc90</span>            <span class="c">; swift_slowAlloc
</span><span class="c"></span>    <span class="c">; ...
</span></code></pre></div><p>è·³è½¬åˆ° <code>0x7fff6df5dd22</code> ä¸€è¡Œå¹¶ <code>si</code>ï¼š</p>
<div class="highlight"><pre class="chroma"><code class="language-asm" data-lang="asm"><span class="nf">libswiftCore.dylib</span><span class="err">`</span><span class="no">swift_slowAlloc</span><span class="p">:</span>
<span class="err">-&gt;</span>  <span class="err">0</span><span class="nf">x7fff6df5dc90</span> <span class="err">&lt;+</span><span class="mi">0</span><span class="err">&gt;</span><span class="p">:</span>  <span class="no">pushq</span>  <span class="nv">%rbp</span>
    <span class="c">; ...
</span><span class="c"></span>    <span class="err">0</span><span class="nf">x7fff6df5dca4</span> <span class="err">&lt;+</span><span class="mi">20</span><span class="err">&gt;</span><span class="p">:</span> <span class="no">callq</span>  <span class="mi">0x7fff6dfda28c</span>            <span class="c">; symbol stub for: malloc
</span><span class="c"></span>    <span class="c">; ...
</span></code></pre></div><p>æ­¤æ—¶æˆ‘ä»¬å°±èƒ½çœ‹åˆ°ç¬¦å·æ¡© <code>malloc</code>ï¼Œä¹Ÿå¯ä»¥è¿›ä¸€æ­¥ <code>si</code> ç›´åˆ°è¿›å…¥ <code>libsystem_malloc.dylib`malloc:</code>ï¼ŒObj-C ä¸­çš„ <code>alloc</code> å…¶å®ä¹Ÿæ¥è‡ªè¿™é‡Œï¼Œè¿™ä¹ŸéªŒè¯äº†ç±»çš„å¯¹è±¡åˆ†é…åœ¨å †ç©ºé—´ã€‚å…³äº <code>malloc</code> å¯è¯¦è§ã€Š<a href="/posts/2019/nsobject_in_ios">iOS ä¸­çš„ NSObject</a>ã€‹ä¸€æ–‡ã€‚</p>
</blockquote>
<p>æˆ‘ä»¬ç»§ç»­æŸ¥çœ‹è¿™ä¸ªå†…å­˜åœ°å€ä¸­çš„å†…å®¹ï¼š</p>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback">(lldb) x --size 8 --format x --count 4 0x00000001005052a0
0x1005052a0: 0x00000001000031a8 0x0000000000000002
0x1005052b0: 0x0000000000000001 0x0000000000000002
</code></pre></div><p>è™½ç„¶ <code>Foo</code> ç±»å‹çš„å˜é‡åªå ç”¨ 8 ä¸ªå­—èŠ‚ï¼Œè¿™æ˜¯å› ä¸ºåœ¨ 64 ä½ä¸‹ï¼ŒæŒ‡é’ˆå­˜å‚¨çš„å†…å­˜åœ°å€å ç”¨ 8 ä¸ªå­—èŠ‚ã€‚è€ŒæŒ‡é’ˆæŒ‡å‘çš„å†…å­˜åœ°å€ï¼Œå³å¯¹è±¡å®é™…å ç”¨çš„å†…å­˜ç©ºé—´è¿™é‡Œæˆ‘ä»¬å¯ä»¥çœ‹å‡ºä¸€å…±å ç”¨äº† 32 ä¸ªå­—èŠ‚ï¼Œå…¶ä¸­çš„å†…å®¹å¦‚ä¸‹è¡¨ï¼š</p>
<table>
<thead>
<tr>
<th style="text-align:center">å†…å­˜åœ°å€</th>
<th style="text-align:center">å†…å®¹</th>
<th style="text-align:center">ä¿¡æ¯</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">0x1005052a0</td>
<td style="text-align:center">0x00000001000031a8</td>
<td style="text-align:center">æŒ‡å‘ç±»å‹ä¿¡æ¯</td>
</tr>
<tr>
<td style="text-align:center">0x1005052a8</td>
<td style="text-align:center">0x0000000000000002</td>
<td style="text-align:center">å¼•ç”¨è®¡æ•°</td>
</tr>
<tr>
<td style="text-align:center">0x1005052b0</td>
<td style="text-align:center">0x0000000000000001</td>
<td style="text-align:center"><code>bar.a</code></td>
</tr>
<tr>
<td style="text-align:center">0x1005052b8</td>
<td style="text-align:center">0x0000000000000002</td>
<td style="text-align:center"><code>bar.b</code></td>
</tr>
</tbody>
</table>
<p>æˆ‘ä»¬ä¹Ÿå¯ä»¥é€šè¿‡ <code>Foundation</code> ä¸­çš„ <code>malloc_size</code> å‡½æ•°è·å–å¯¹è±¡å®é™…è¢«åˆ†é…çš„å†…å­˜å¤§å°ï¼š</p>
<div class="highlight"><pre class="chroma"><code class="language-swift" data-lang="swift"><span class="kd">import</span> <span class="nc">Foundation</span>

<span class="c1">// ...</span>

<span class="kd">var</span> <span class="nv">foo</span> <span class="p">=</span> <span class="n">Foo</span><span class="p">()</span>

<span class="c1">// Swift / Obj-C ä¸­çš„å¯¹è±¡å°†æŒ‰ç…§ 16 çš„å€æ•°è¿›è¡Œå¯¹é½</span>
<span class="bp">print</span><span class="p">(</span><span class="n">malloc_size</span><span class="p">(</span><span class="nb">Unmanaged</span><span class="p">.</span><span class="n">passUnretained</span><span class="p">(</span><span class="n">foo</span><span class="p">).</span><span class="n">toOpaque</span><span class="p">()))</span> <span class="c1">// 32</span>

<span class="c1">// class_getInstanceSize å¹¶éå¯¹è±¡å®é™…è¢«åˆ†é…çš„å†…å­˜å¤§å°</span>
<span class="bp">print</span><span class="p">(</span><span class="n">class_getInstanceSize</span><span class="p">(</span><span class="n">Foo</span><span class="p">.</span><span class="kc">self</span><span class="p">))</span>                       <span class="c1">// 32</span>
<span class="bp">print</span><span class="p">(</span><span class="n">class_getInstanceSize</span><span class="p">(</span><span class="n">type</span><span class="p">(</span><span class="n">of</span><span class="p">:</span> <span class="n">foo</span><span class="p">)))</span>                  <span class="c1">// 32</span>
</code></pre></div><h2 id="reference">Reference</h2>
<ul>
<li><a href="/posts/2019/nsobject_in_ios">iOS ä¸­çš„ NSObject - kingcos</a></li>
</ul>
</div>
                    <div class="post_footer">
                        
                        <div class="meta">
                            <div class="info">
                                <span class="field tags">
                                    <i class="ri-stack-line"></i>
                                    
                                    <a href="https://kingcos.me/tags/swift/">Swift</a>
                                    
                                    <a href="https://kingcos.me/tags/swift-%E6%8B%BE%E9%81%97/">Swift æ‹¾é—</a>
                                    
                                </span>
                            </div>
                        </div>
                        
                    </div>
                </div>
                
                
                <div class="doc_comments"><div id="disqus_thread"></div>
<script type="application/javascript">
    var disqus_config = function () {
    
    
    
    };
    (function() {
        if (["localhost", "127.0.0.1"].indexOf(window.location.hostname) != -1) {
            document.getElementById('disqus_thread').innerHTML = 'Disqus comments not available by default when the website is previewed locally.';
            return;
        }
        var d = document, s = d.createElement('script'); s.async = true;
        s.src = '//' + "kingcos" + '.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="https://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a></div>
                
            </div>
        </div>
    </div>
    <a id="back_to_top" href="#" class="back_to_top"><i class="ri-arrow-up-s-line"></i></a>
    <footer class="footer">
    <div class="powered_by">
        <a href="https://kingcos.me">Powered by kingcos with love.</a>
    </div>

    <div class="footer_slogan">
        <span>â¤ï¸</span>
    </div>
</footer>
    <script src="https://kingcos.me/js/jquery-3.5.1.min.js"></script>
<link href="https://kingcos.me/css/fancybox.min.css" rel="stylesheet">
<script src="https://kingcos.me/js/fancybox.min.js"></script>
<script src="https://kingcos.me/js/zozo.js"></script>


<script type="text/javascript" async
    src="https://cdn.bootcss.com/mathjax/2.7.5/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
        MathJax.Hub.Config({
            tex2jax: {
                inlineMath: [['$', '$'], ['\\(', '\\)']],
                displayMath: [['$$', '$$'], ['\[\[', '\]\]']],
                processEscapes: true,
                processEnvironments: true,
                skipTags: ['script', 'noscript', 'style', 'textarea', 'pre'],
                TeX: {
                    equationNumbers: { autoNumber: "AMS" },
                    extensions: ["AMSmath.js", "AMSsymbols.js"]
                }
            }
        });

        MathJax.Hub.Queue(function () {
            
            
            
            var all = MathJax.Hub.getAllJax(), i;
            for (i = 0; i < all.length; i += 1) {
                all[i].SourceElement().parentNode.className += ' has-jax';
            }
        });
    </script>

<style>
    code.has-jax {
        font: inherit;
        font-size: 100%;
        background: inherit;
        border: inherit;
        color: #515151;
    }
</style>



<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-138311951-1', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>

</body>

</html>