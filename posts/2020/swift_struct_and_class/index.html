<!DOCTYPE html>
<html lang="en">
  <head>
    
      <title>Swift æ‹¾é— - struct &amp; class :: iBlog</title>
    
    <meta http-equiv="content-type" content="text/html; charset=utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">
<meta name="description" content="Date Notes     2020-08-06 é¦–æ¬¡æäº¤    Preface ã€ŠSwift æ‹¾é—ã€‹æ˜¯ä¸€ä¸ªå…³äº Swift çš„æ–°æ–‡ç« ä¸“è¾‘ï¼Œè¿™ä¸ªç³»åˆ—çš„æ–‡ç« å°†ä¸ä¼šæ¶‰åŠåŸºæœ¬è¯­æ³•çš„å±‚é¢ï¼Œè€Œæ˜¯å°è¯•ä»åº•å±‚ã€Œæ‹¾ã€èµ·ä¹‹å‰æ‰€å¿½è§†çš„å†…å®¹ã€‚ä»Šå¤©æˆ‘ä»¬å°†ä¸€èµ·ç®€å•æ¢ç©¶ Swift ä¸­çš„æšä¸¾ struct å’Œ classã€‚&amp;quot;
ç»“æ„ä½“ Swift ä¸­çš„ç»“æ„ä½“è¢«å¹¿æ³›ä½¿ç”¨ï¼Œè¿™æ˜¯å› ä¸ºå®ƒå’Œæšä¸¾éƒ½æ˜¯å€¼ç±»å‹ï¼Œåœ¨æ“ä½œæ—¶ä¼šæ›´åŠ å®‰å…¨ã€‚æˆ‘ä»¬è¿™é‡Œå®šä¹‰ä¸€ä¸ªç®€å•çš„ç»“æ„ä½“ï¼š
struct Foo { var a = 1 var b = 1 } var foo = Foo() // Breakpoint ğŸ”´ withUnsafeMutablePointer(to: &amp;amp;foo) { print(&amp;#34;\($0)&amp;#34;) } // 0x00000001000030d8 print(MemoryLayout&amp;lt;Foo&amp;gt;.size) // 16 print(MemoryLayout&amp;lt;Foo&amp;gt;.stride) // 16 print(MemoryLayout&amp;lt;Foo&amp;gt;.alignment) // 8 // (lldb) memory read 0x00000001000030d8 // 0x1000030d8: 01 00 00 00 00 00 00 00 01 00 00 00 00 00 00 00 ."/>
<meta name="keywords" content="kingcos.me,maimieng.comios,swift,objective-c,obj-c,objc,oc,geek,python,ruby,golang,go,apple,mac"/>
<meta name="robots" content="noodp"/>
<link rel="canonical" href="/posts/2020/swift_struct_and_class/" />





<link rel="stylesheet" href="/assets/style.css">


<link rel="stylesheet" href="/style.css">


<link rel="apple-touch-icon-precomposed" sizes="144x144" href="/img/apple-touch-icon-144-precomposed.png">
<link rel="shortcut icon" href="/img/favicon.png">


<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Swift æ‹¾é— - struct &amp; class"/>
<meta name="twitter:description" content="ã€ŠSwift æ‹¾é—ã€‹æ˜¯ä¸€ä¸ªå…³äº Swift çš„æ–°æ–‡ç« ä¸“è¾‘ï¼Œè¿™ä¸ªç³»åˆ—çš„æ–‡ç« å°†ä¸ä¼šæ¶‰åŠåŸºæœ¬è¯­æ³•çš„å±‚é¢ï¼Œè€Œæ˜¯å°è¯•ä»åº•å±‚ã€Œæ‹¾ã€èµ·ä¹‹å‰æ‰€å¿½è§†çš„å†…å®¹ã€‚ä»Šå¤©æˆ‘ä»¬å°†ä¸€èµ·ç®€å•æ¢ç©¶ Swift ä¸­çš„æšä¸¾ `struct` å’Œ `class`ã€‚"/>



<meta property="og:title" content="Swift æ‹¾é— - struct &amp; class" />
<meta property="og:description" content="ã€ŠSwift æ‹¾é—ã€‹æ˜¯ä¸€ä¸ªå…³äº Swift çš„æ–°æ–‡ç« ä¸“è¾‘ï¼Œè¿™ä¸ªç³»åˆ—çš„æ–‡ç« å°†ä¸ä¼šæ¶‰åŠåŸºæœ¬è¯­æ³•çš„å±‚é¢ï¼Œè€Œæ˜¯å°è¯•ä»åº•å±‚ã€Œæ‹¾ã€èµ·ä¹‹å‰æ‰€å¿½è§†çš„å†…å®¹ã€‚ä»Šå¤©æˆ‘ä»¬å°†ä¸€èµ·ç®€å•æ¢ç©¶ Swift ä¸­çš„æšä¸¾ `struct` å’Œ `class`ã€‚" />
<meta property="og:type" content="article" />
<meta property="og:url" content="/posts/2020/swift_struct_and_class/" />
<meta property="article:published_time" content="2020-08-06T00:00:00+00:00" />
<meta property="article:modified_time" content="2020-08-06T00:00:00+00:00" /><meta property="og:site_name" content="iBlog" />




<script data-ad-client="ca-pub-9925978992661955" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>

  </head>
  <body class="">
    <div class="container">
      <header class="header">
  <span class="header__inner">
    <a href="/" class="logo" style="text-decoration: none;">
  
    <span class="logo__mark"><svg xmlns="http://www.w3.org/2000/svg" class="greater-icon" viewBox="0 0 44 44">
  <path fill="none" d="M15 8l14.729 14.382L15 35.367"/>
</svg>
</span>
    <span class="logo__text">kingcos.me</span>
    <span class="logo__cursor"></span>
  
</a>

    <span class="header__right">
      
        <nav class="menu">
  <ul class="menu__inner menu__inner--desktop">
    
      
        
          <li><a href="/about">About</a></li>
        
      
        
          <li><a href="/read">Read</a></li>
        
      
      
    
  </ul>

  <ul class="menu__inner menu__inner--mobile">
    
      
        <li><a href="/about">About</a></li>
      
    
      
        <li><a href="/read">Read</a></li>
      
    
  </ul>
</nav>

        <span class="menu-trigger">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
            <path d="M0 0h24v24H0z" fill="none"/>
            <path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"/>
          </svg>
        </span>
      
      <span class="theme-toggle">
        <svg class="theme-toggler" width="24" height="24" viewBox="0 0 48 48" fill="none" xmlns="http://www.w3.org/2000/svg">
  <path d="M22 41C32.4934 41 41 32.4934 41 22C41 11.5066 32.4934 3 22
  3C11.5066 3 3 11.5066 3 22C3 32.4934 11.5066 41 22 41ZM7 22C7
  13.7157 13.7157 7 22 7V37C13.7157 37 7 30.2843 7 22Z"/>
</svg>

      </span>
    </span>
  </span>
</header>


      <div class="content">
        
  <div class="post">
    <h2 class="post-title"><a href="/posts/2020/swift_struct_and_class/">Swift æ‹¾é— - struct &amp; class</a></h2>
    <div class="post-meta">
      
        <span class="post-date">
            2020-08-06
        </span>
      
      
      
        <span class="post-read-time">â€” 3 min read</span>
      
    </div>

    
      <span class="post-tags">
        
          #<a href="/tags/swift/">Swift</a>&nbsp;
        
          #<a href="/tags/swift-%E6%8B%BE%E9%81%97/">Swift æ‹¾é—</a>&nbsp;
        
      </span>
    

    

    <div class="post-content">
      <table>
<thead>
<tr>
<th style="text-align:center">Date</th>
<th style="text-align:center">Notes</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">2020-08-06</td>
<td style="text-align:center">é¦–æ¬¡æäº¤</td>
</tr>
</tbody>
</table>
<h2 id="preface">Preface</h2>
<p>ã€ŠSwift æ‹¾é—ã€‹æ˜¯ä¸€ä¸ªå…³äº Swift çš„æ–°æ–‡ç« ä¸“è¾‘ï¼Œè¿™ä¸ªç³»åˆ—çš„æ–‡ç« å°†ä¸ä¼šæ¶‰åŠåŸºæœ¬è¯­æ³•çš„å±‚é¢ï¼Œè€Œæ˜¯å°è¯•ä»åº•å±‚ã€Œæ‹¾ã€èµ·ä¹‹å‰æ‰€å¿½è§†çš„å†…å®¹ã€‚ä»Šå¤©æˆ‘ä»¬å°†ä¸€èµ·ç®€å•æ¢ç©¶ Swift ä¸­çš„æšä¸¾ <code>struct</code> å’Œ <code>class</code>ã€‚&quot;</p>
<h2 id="ç»“æ„ä½“">ç»“æ„ä½“</h2>
<p>Swift ä¸­çš„ç»“æ„ä½“è¢«å¹¿æ³›ä½¿ç”¨ï¼Œè¿™æ˜¯å› ä¸ºå®ƒå’Œæšä¸¾éƒ½æ˜¯å€¼ç±»å‹ï¼Œåœ¨æ“ä½œæ—¶ä¼šæ›´åŠ å®‰å…¨ã€‚æˆ‘ä»¬è¿™é‡Œå®šä¹‰ä¸€ä¸ªç®€å•çš„ç»“æ„ä½“ï¼š</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-swift" data-lang="swift"><span style="color:#66d9ef">struct</span> <span style="color:#a6e22e">Foo</span> {
    <span style="color:#66d9ef">var</span> a = <span style="color:#ae81ff">1</span>
    <span style="color:#66d9ef">var</span> b = <span style="color:#ae81ff">1</span>
}

<span style="color:#66d9ef">var</span> foo = Foo() <span style="color:#75715e">// Breakpoint ğŸ”´</span>
withUnsafeMutablePointer(to: &amp;foo) { print(<span style="color:#e6db74">&#34;</span><span style="color:#e6db74">\(</span>$0<span style="color:#e6db74">)</span><span style="color:#e6db74">&#34;</span>) } <span style="color:#75715e">// 0x00000001000030d8</span>

print(MemoryLayout&lt;Foo&gt;.size)      <span style="color:#75715e">// 16</span>
print(MemoryLayout&lt;Foo&gt;.stride)    <span style="color:#75715e">// 16</span>
print(MemoryLayout&lt;Foo&gt;.alignment) <span style="color:#75715e">// 8</span>

<span style="color:#75715e">// (lldb) memory read 0x00000001000030d8</span>
<span style="color:#75715e">// 0x1000030d8: 01 00 00 00 00 00 00 00 01 00 00 00 00 00 00 00  ................</span>
<span style="color:#75715e">// 0x1000030e8: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................</span>
</code></pre></div><p>æˆ‘ä»¬å¯ä»¥ä»ä»¥ä¸Šçš„å†…å­˜åœ°å€å’Œå¯¹åº”çš„å€¼ä¸­çœ‹å‡ºï¼Œç»“æ„ä½“å˜é‡çš„åœ°å€å°±æ˜¯ç»“æ„ä½“ä¸­ç¬¬ä¸€ä¸ªæˆå‘˜çš„åœ°å€ï¼Œç»“æ„ä½“ä¸­æ‰€æœ‰æˆå‘˜çš„åœ°å€æ˜¯è¿ç»­çš„ï¼›ç»“æ„ä½“å˜é‡å ç”¨å†…å­˜çš„å¤§å°å—å…¶æˆå‘˜çš„å½±å“ã€‚</p>
<p>å†æ¥ä¸€ä¸ªæ›´åŠ å¤æ‚çš„åµŒå¥—ç±»å‹çš„ä¾‹å­ï¼š</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-swift" data-lang="swift"><span style="color:#75715e">// ...</span>

print(MemoryLayout&lt;Int&gt;.stride)     <span style="color:#75715e">// 8</span>
print(MemoryLayout&lt;Bool&gt;.stride)    <span style="color:#75715e">// 1</span>
print(MemoryLayout&lt;Double&gt;.stride)  <span style="color:#75715e">// 8</span>
print(MemoryLayout&lt;Foo&gt;.stride)     <span style="color:#75715e">// 16</span>

<span style="color:#66d9ef">struct</span> <span style="color:#a6e22e">Bar</span> {
    <span style="color:#66d9ef">var</span> a: Int
    <span style="color:#66d9ef">var</span> b: Bool
    <span style="color:#66d9ef">var</span> c: Bool
    <span style="color:#66d9ef">var</span> d: Int
    <span style="color:#66d9ef">var</span> e: Foo
}

<span style="color:#66d9ef">var</span> bar = Bar(a: <span style="color:#ae81ff">10</span>, b: <span style="color:#66d9ef">true</span>, c: <span style="color:#66d9ef">true</span>, d: <span style="color:#ae81ff">11</span>, e: Foo(a: <span style="color:#ae81ff">11</span>, b: <span style="color:#ae81ff">12</span>))
<span style="color:#66d9ef">var</span> baz = <span style="color:#ae81ff">20</span>

print(MemoryLayout&lt;Bar&gt;.size)      <span style="color:#75715e">// 40</span>
print(MemoryLayout&lt;Bar&gt;.stride)    <span style="color:#75715e">// 40</span>
print(MemoryLayout&lt;Bar&gt;.alignment) <span style="color:#75715e">// 8</span>

<span style="color:#75715e">// (lldb) po withUnsafeMutablePointer(to: &amp;bar) { print(&#34;\($0)&#34;) }</span>
<span style="color:#75715e">// 0x0000000100004290</span>
<span style="color:#75715e">// (lldb) x/6xg 0x0000000100004290</span>
<span style="color:#75715e">// 0x100004290: 0x000000000000000a 0x0000000000000101</span>
<span style="color:#75715e">// 0x1000042a0: 0x000000000000000b 0x000000000000000b</span>
<span style="color:#75715e">// 0x1000042b0: 0x000000000000000c 0x0000000000000014</span>
</code></pre></div><p>æ­¤æ—¶è™½ç„¶ <code>Bar</code> ç»“æ„ä½“ä¸­åµŒå¥—äº† <code>Foo</code> ç»“æ„ä½“ï¼Œä½†å…¶ä»æŒ‰ç…§ <code>8</code> ä¸ªå­—èŠ‚è¿›è¡Œå†…å­˜å¯¹é½ï¼›å…¶ä¸­è¿ç»­çš„ä¸¤ä¸ª <code>Bool</code> ç±»å‹çš„å˜é‡å…±åŒå ç”¨ä¸€ä»½ <code>8</code> ä¸ªå­—èŠ‚çš„å†…å­˜ã€‚</p>
<h2 id="ç±»">ç±»</h2>
<p>Swift ä¸­çš„ç±»ä¸åŒäºç»“æ„ä½“å’Œæšä¸¾ï¼Œæ˜¯å¼•ç”¨ç±»å‹ï¼Œå³åˆå§‹åŒ–åä¼šåœ¨å †ä¸Šå¼€è¾Ÿç©ºé—´å­˜å‚¨ç±»ä¸­çš„å˜é‡ï¼Œå¹¶å°†é¦–åœ°å€é€šè¿‡æ ˆä¸Šçš„æŒ‡é’ˆå˜é‡å¼•ç”¨ã€‚</p>
<p>å½“å‡½æ•°è°ƒç”¨æ—¶ï¼Œå°†ä¼šåœ¨æ ˆä¸Šå¼€è¾Ÿä¸€å—å†…å­˜ç©ºé—´ä¾›å‡½æ•°ä½¿ç”¨ã€‚ä¸ºäº†æ›´åŠ ç›´è§‚ï¼Œæˆ‘ä»¬åœ¨å‡½æ•°ä¸­åˆ†åˆ«åˆ›å»ºç±»å’Œç»“æ„ä½“çš„å˜é‡å¹¶åˆå§‹åŒ–ï¼š</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-swift" data-lang="swift"><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Foo</span> {
    <span style="color:#66d9ef">var</span> a = <span style="color:#ae81ff">1</span>
    <span style="color:#66d9ef">var</span> b = <span style="color:#ae81ff">2</span>
}

<span style="color:#66d9ef">struct</span> <span style="color:#a6e22e">Bar</span> {
    <span style="color:#66d9ef">var</span> a = <span style="color:#ae81ff">3</span>
}

<span style="color:#66d9ef">func</span> <span style="color:#a6e22e">test</span>() {
    <span style="color:#66d9ef">var</span> foo = Foo()
    <span style="color:#66d9ef">var</span> bar = Bar()
    <span style="color:#66d9ef">var</span> baz = <span style="color:#ae81ff">4</span>

    withUnsafeMutablePointer(to: &amp;foo) { print(<span style="color:#e6db74">&#34;</span><span style="color:#e6db74">\(</span>$0<span style="color:#e6db74">)</span><span style="color:#e6db74">&#34;</span>) } <span style="color:#75715e">// 0x00007ffeefbff4a8</span>
    withUnsafeMutablePointer(to: &amp;bar) { print(<span style="color:#e6db74">&#34;</span><span style="color:#e6db74">\(</span>$0<span style="color:#e6db74">)</span><span style="color:#e6db74">&#34;</span>) } <span style="color:#75715e">// 0x00007ffeefbff4a0</span>
    withUnsafeMutablePointer(to: &amp;baz) { print(<span style="color:#e6db74">&#34;</span><span style="color:#e6db74">\(</span>$0<span style="color:#e6db74">)</span><span style="color:#e6db74">&#34;</span>) } <span style="color:#75715e">// 0x00007ffeefbff498</span>
}

print(MemoryLayout&lt;Foo&gt;.size)      <span style="color:#75715e">// 8</span>
print(MemoryLayout&lt;Foo&gt;.stride)    <span style="color:#75715e">// 8</span>
print(MemoryLayout&lt;Foo&gt;.alignment) <span style="color:#75715e">// 8</span>

test()
</code></pre></div><p>åœ¨ <code>test</code> å‡½æ•°çš„æ ˆç©ºé—´ä¸­ï¼Œå†…å­˜åœ°å€ä»é«˜åœ°å€å¼€å§‹åˆ†é…ï¼Œå› æ­¤ <code>foo</code> é¦–åœ°å€ä½äº <code>0x00007ffeefbff4a8</code>ï¼Œè€Œ <code>bar</code> ä½äº <code>0x00007ffeefbff4a0</code>ï¼Œ<code>baz</code> ä½äº <code>0x00007ffeefbff498</code>ï¼Œå®ƒä»¬çš„åœ°å€å·®å€¼å‡ä¸º <code>8</code>ï¼Œå³å ç”¨ 8 ä¸ªå­—èŠ‚ï¼š</p>
<pre><code class="language-lldb" data-lang="lldb">(lldb) p 0x00007ffeefbff4a8 - 0x00007ffeefbff4a0
(Int) $R0 = 8
(lldb) p 0x00007ffeefbff4a0 - 0x00007ffeefbff498
(Int) $R2 = 8
</code></pre><p>æ¥ä¸‹æ¥æˆ‘ä»¬å°è¯•ä½¿ç”¨ LLDB ä¸­çš„ <code>memory read</code> æˆ– <code>x</code> å‘½ä»¤ï¼ŒæŸ¥çœ‹è¿™äº›å˜é‡å¯¹åº”å†…å­˜åœ°å€ä¸­çš„å†…å®¹ï¼š</p>
<pre><code class="language-lldb" data-lang="lldb">(lldb) x --size 8 --format x --count 4 0x00007ffeefbff498
0x7ffeefbff498: 0x0000000000000001 0x0000000000000003
0x7ffeefbff4a8: 0x00000001005052a0 0x0000000000000000
</code></pre><p>å…¶ä¸­åªæœ‰ <code>0x7ffeefbff4a8</code> å³ <code>foo</code> ä¸­çš„å†…å®¹æœ‰äº›ä¸åŒï¼Œå…¶ä¸­å¹¶æ²¡æœ‰ç›´æ¥å­˜å‚¨ç±»ä¸­å˜é‡çš„å€¼ï¼Œè€Œæ˜¯ä¸€æ®µå †ç©ºé—´çš„å†…å­˜åœ°å€ã€‚</p>
<blockquote>
<p><strong>å¦‚ä½•ç¡®å®šåˆ†é…å †ç©ºé—´</strong></p>
<p>å†…å­˜å¯ä»¥è¢«åˆ†ä¸ºå¾ˆå¤šä¸åŒçš„åŒºåŸŸï¼Œå…¶ä¸­æ ˆç©ºé—´æ— éœ€å¼€å‘è€…æ‰‹åŠ¨ç”³è¯·å’Œå›æ”¶ï¼Œæ¯”å¦‚å‡½æ•°è°ƒç”¨æ—¶æ ˆç©ºé—´ç³»ç»Ÿè‡ªåŠ¨åˆ†é…ï¼Œè€Œå½“å‡½æ•°è¿”å›æ—¶åˆä¼šè¢«ç³»ç»Ÿè‡ªåŠ¨å›æ”¶ï¼›è€Œå †ç©ºé—´éœ€è¦æ‰‹åŠ¨å¼€è¾Ÿå’Œå›æ”¶ã€‚åœ¨ C/C++ ä¸­ï¼Œé€šå¸¸åœ¨è°ƒç”¨ <code>alloc</code> / <code>malloc</code> å‡½æ•°æ—¶å°†ä¼šåœ¨å †ä¸Šå¼€è¾Ÿä¸€æ®µå†…å­˜ç©ºé—´ã€‚åœ¨ Swift ä¸­æˆ‘ä»¬ä¹Ÿå¯ä»¥è§‚å¯Ÿæ˜¯å¦è°ƒç”¨äº† <code>malloc</code> å‡½æ•°æ¥åˆ¤æ–­æ„é€ æ–¹æ³•åˆ°åº•æœ‰æ²¡æœ‰åœ¨å †ä¸Šå¼€è¾Ÿå†…å­˜ç©ºé—´ã€‚æˆ‘ä»¬åœ¨ <code>var foo = Foo()</code> ä¸€è¡Œæ‰“ä¸ªæ–­ç‚¹ï¼Œå¹¶ Xcode Menu - Debug - Debug Workflow - Always Show Disassemblyï¼š</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-asm" data-lang="asm"><span style="color:#a6e22e">demo</span><span style="color:#960050;background-color:#1e0010">`</span><span style="color:#66d9ef">test</span>():
    <span style="color:#75715e">; ...
</span><span style="color:#75715e"></span><span style="color:#960050;background-color:#1e0010">-&gt;</span>  <span style="color:#960050;background-color:#1e0010">0</span><span style="color:#a6e22e">x1000011eb</span> <span style="color:#960050;background-color:#1e0010">&lt;+</span><span style="color:#ae81ff">43</span><span style="color:#960050;background-color:#1e0010">&gt;</span>:  <span style="color:#66d9ef">movq</span>   %rdx, %rdi
    <span style="color:#75715e">; ...
</span><span style="color:#75715e"></span>    <span style="color:#960050;background-color:#1e0010">0</span><span style="color:#a6e22e">x100001206</span> <span style="color:#960050;background-color:#1e0010">&lt;+</span><span style="color:#ae81ff">70</span><span style="color:#960050;background-color:#1e0010">&gt;</span>:  <span style="color:#66d9ef">callq</span>  <span style="color:#ae81ff">0x100001050</span>               <span style="color:#75715e">; demo.Foo.__allocating_init() -&gt; demo.Foo at main.swift:1
</span><span style="color:#75715e"></span>    <span style="color:#75715e">; ...
</span></code></pre></div><p>è·³è½¬åˆ° <code>0x100001206</code> ä¸€è¡Œå¹¶ <code>si</code>ï¼ˆStep Intoï¼‰ï¼š</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-asm" data-lang="asm"><span style="color:#a6e22e">demo</span><span style="color:#960050;background-color:#1e0010">`</span><span style="color:#66d9ef">Foo.__allocating_init</span>():
<span style="color:#960050;background-color:#1e0010">-&gt;</span>  <span style="color:#960050;background-color:#1e0010">0</span><span style="color:#a6e22e">x100001050</span> <span style="color:#960050;background-color:#1e0010">&lt;+</span><span style="color:#ae81ff">0</span><span style="color:#960050;background-color:#1e0010">&gt;</span>:  <span style="color:#66d9ef">pushq</span>  %rbp
    <span style="color:#75715e">; ...
</span><span style="color:#75715e"></span>    <span style="color:#960050;background-color:#1e0010">0</span><span style="color:#a6e22e">x100001064</span> <span style="color:#960050;background-color:#1e0010">&lt;+</span><span style="color:#ae81ff">20</span><span style="color:#960050;background-color:#1e0010">&gt;</span>: <span style="color:#66d9ef">callq</span>  <span style="color:#ae81ff">0x100001c4e</span>               <span style="color:#75715e">; symbol stub for: swift_allocObject
</span><span style="color:#75715e"></span>    <span style="color:#75715e">; ...
</span></code></pre></div><p>è·³è½¬åˆ° <code>0x100001064</code> ä¸€è¡Œå¹¶ <code>si</code>ï¼š</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-asm" data-lang="asm"><span style="color:#a6e22e">demo</span><span style="color:#960050;background-color:#1e0010">`</span><span style="color:#66d9ef">swift_allocObject</span>:
<span style="color:#960050;background-color:#1e0010">-&gt;</span>  <span style="color:#960050;background-color:#1e0010">0</span><span style="color:#a6e22e">x100001c4e</span> <span style="color:#960050;background-color:#1e0010">&lt;+</span><span style="color:#ae81ff">0</span><span style="color:#960050;background-color:#1e0010">&gt;</span>: <span style="color:#66d9ef">jmpq</span>   *<span style="color:#ae81ff">0x13ec</span>(%rip)             <span style="color:#75715e">; (void *)0x0000000100001cec
</span></code></pre></div><p>ä»æ­¤å¤„è¿ç»­ <code>si</code> å¤šæ¬¡ç›´åˆ°è¿›å…¥ <code>libdyld.dylib`dyld_stub_binder:</code> ä¸­ï¼Œè·³è½¬è‡³æœ€åä¸€è¡Œå¹¶<code>si</code>ï¼š</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-asm" data-lang="asm"><span style="color:#a6e22e">libswiftCore.dylib</span><span style="color:#960050;background-color:#1e0010">`</span><span style="color:#66d9ef">swift_allocObject</span>:
<span style="color:#960050;background-color:#1e0010">-&gt;</span>  <span style="color:#960050;background-color:#1e0010">0</span><span style="color:#a6e22e">x7fff6df5dd00</span> <span style="color:#960050;background-color:#1e0010">&lt;+</span><span style="color:#ae81ff">0</span><span style="color:#960050;background-color:#1e0010">&gt;</span>:  <span style="color:#66d9ef">pushq</span>  %rbp
    <span style="color:#75715e">; ...
</span><span style="color:#75715e"></span>    <span style="color:#960050;background-color:#1e0010">0</span><span style="color:#a6e22e">x7fff6df5dd22</span> <span style="color:#960050;background-color:#1e0010">&lt;+</span><span style="color:#ae81ff">34</span><span style="color:#960050;background-color:#1e0010">&gt;</span>: <span style="color:#66d9ef">callq</span>  <span style="color:#ae81ff">0x7fff6df5dc90</span>            <span style="color:#75715e">; swift_slowAlloc
</span><span style="color:#75715e"></span>    <span style="color:#75715e">; ...
</span></code></pre></div><p>è·³è½¬åˆ° <code>0x7fff6df5dd22</code> ä¸€è¡Œå¹¶ <code>si</code>ï¼š</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-asm" data-lang="asm"><span style="color:#a6e22e">libswiftCore.dylib</span><span style="color:#960050;background-color:#1e0010">`</span><span style="color:#66d9ef">swift_slowAlloc</span>:
<span style="color:#960050;background-color:#1e0010">-&gt;</span>  <span style="color:#960050;background-color:#1e0010">0</span><span style="color:#a6e22e">x7fff6df5dc90</span> <span style="color:#960050;background-color:#1e0010">&lt;+</span><span style="color:#ae81ff">0</span><span style="color:#960050;background-color:#1e0010">&gt;</span>:  <span style="color:#66d9ef">pushq</span>  %rbp
    <span style="color:#75715e">; ...
</span><span style="color:#75715e"></span>    <span style="color:#960050;background-color:#1e0010">0</span><span style="color:#a6e22e">x7fff6df5dca4</span> <span style="color:#960050;background-color:#1e0010">&lt;+</span><span style="color:#ae81ff">20</span><span style="color:#960050;background-color:#1e0010">&gt;</span>: <span style="color:#66d9ef">callq</span>  <span style="color:#ae81ff">0x7fff6dfda28c</span>            <span style="color:#75715e">; symbol stub for: malloc
</span><span style="color:#75715e"></span>    <span style="color:#75715e">; ...
</span></code></pre></div><p>æ­¤æ—¶æˆ‘ä»¬å°±èƒ½çœ‹åˆ°ç¬¦å·æ¡© <code>malloc</code>ï¼Œä¹Ÿå¯ä»¥è¿›ä¸€æ­¥ <code>si</code> ç›´åˆ°è¿›å…¥ <code>libsystem_malloc.dylib`malloc:</code>ï¼ŒObj-C ä¸­çš„ <code>alloc</code> å…¶å®ä¹Ÿæ¥è‡ªè¿™é‡Œï¼Œè¿™ä¹ŸéªŒè¯äº†ç±»çš„å¯¹è±¡åˆ†é…åœ¨å †ç©ºé—´ã€‚å…³äº <code>malloc</code> å¯è¯¦è§ã€Š<a href="/posts/2019/nsobject_in_ios">iOS ä¸­çš„ NSObject</a>ã€‹ä¸€æ–‡ã€‚</p>
</blockquote>
<p>æˆ‘ä»¬ç»§ç»­æŸ¥çœ‹è¿™ä¸ªå†…å­˜åœ°å€ä¸­çš„å†…å®¹ï¼š</p>
<pre><code class="language-lldb" data-lang="lldb">(lldb) x --size 8 --format x --count 4 0x00000001005052a0
0x1005052a0: 0x00000001000031a8 0x0000000000000002
0x1005052b0: 0x0000000000000001 0x0000000000000002
</code></pre><p>è™½ç„¶ <code>Foo</code> ç±»å‹çš„å˜é‡åªå ç”¨ 8 ä¸ªå­—èŠ‚ï¼Œè¿™æ˜¯å› ä¸ºåœ¨ 64 ä½ä¸‹ï¼ŒæŒ‡é’ˆå­˜å‚¨çš„å†…å­˜åœ°å€å ç”¨ 8 ä¸ªå­—èŠ‚ã€‚è€ŒæŒ‡é’ˆæŒ‡å‘çš„å†…å­˜åœ°å€ï¼Œå³å¯¹è±¡å®é™…å ç”¨çš„å†…å­˜ç©ºé—´è¿™é‡Œæˆ‘ä»¬å¯ä»¥çœ‹å‡ºä¸€å…±å ç”¨äº† 32 ä¸ªå­—èŠ‚ï¼Œå…¶ä¸­çš„å†…å®¹å¦‚ä¸‹è¡¨ï¼š</p>
<table>
<thead>
<tr>
<th style="text-align:center">å†…å­˜åœ°å€</th>
<th style="text-align:center">å†…å®¹</th>
<th style="text-align:center">ä¿¡æ¯</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">0x1005052a0</td>
<td style="text-align:center">0x00000001000031a8</td>
<td style="text-align:center">æŒ‡å‘ç±»å‹ä¿¡æ¯</td>
</tr>
<tr>
<td style="text-align:center">0x1005052a8</td>
<td style="text-align:center">0x0000000000000002</td>
<td style="text-align:center">å¼•ç”¨è®¡æ•°</td>
</tr>
<tr>
<td style="text-align:center">0x1005052b0</td>
<td style="text-align:center">0x0000000000000001</td>
<td style="text-align:center"><code>bar.a</code></td>
</tr>
<tr>
<td style="text-align:center">0x1005052b8</td>
<td style="text-align:center">0x0000000000000002</td>
<td style="text-align:center"><code>bar.b</code></td>
</tr>
</tbody>
</table>
<p>æˆ‘ä»¬ä¹Ÿå¯ä»¥é€šè¿‡ <code>Foundation</code> ä¸­çš„ <code>malloc_size</code> å‡½æ•°è·å–å¯¹è±¡å®é™…è¢«åˆ†é…çš„å†…å­˜å¤§å°ï¼š</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-swift" data-lang="swift"><span style="color:#66d9ef">import</span> <span style="color:#a6e22e">Foundation</span>

<span style="color:#75715e">// ...</span>

<span style="color:#66d9ef">var</span> foo = Foo()

<span style="color:#75715e">// Swift / Obj-C ä¸­çš„å¯¹è±¡å°†æŒ‰ç…§ 16 çš„å€æ•°è¿›è¡Œå¯¹é½</span>
print(malloc_size(Unmanaged.passUnretained(foo).toOpaque())) <span style="color:#75715e">// 32</span>

<span style="color:#75715e">// class_getInstanceSize å¹¶éå¯¹è±¡å®é™…è¢«åˆ†é…çš„å†…å­˜å¤§å°</span>
print(class_getInstanceSize(Foo.<span style="color:#66d9ef">self</span>))                       <span style="color:#75715e">// 32</span>
print(class_getInstanceSize(type(of: foo)))                  <span style="color:#75715e">// 32</span>
</code></pre></div><h2 id="reference">Reference</h2>
<ul>
<li><a href="/posts/2019/nsobject_in_ios">iOS ä¸­çš„ NSObject - kingcos</a></li>
</ul>

    </div>
    
      <div class="pagination">
        <div class="pagination__title">
          <span class="pagination__title-h">Read other posts</span>
          <hr />
        </div>
        <div class="pagination__buttons">
          
            <span class="button previous">
              <a href="/posts/2020/swift_with_asm/">
                <span class="button__icon">â†</span>
                <span class="button__text">Swift æ‹¾é— - æ±‡ç¼–</span>
              </a>
            </span>
          
          
            <span class="button next">
              <a href="/posts/2020/swift_enum/">
                <span class="button__text">Swift æ‹¾é— - enum</span>
                <span class="button__icon">â†’</span>
              </a>
            </span>
          
        </div>
      </div>
    

    

<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<table style="border: 0;">
  <tr>
  <td style="border: 0; width: 30%;">
    <img src='/img/about/1.jpg'>
  </td>
  <td style="border: 0;">
    <ins class="adsbygoogle"
     style="display:block"
     data-ad-client="ca-pub-9925978992661955"
     data-ad-slot="3213735320"
     data-ad-format="auto"
     data-full-width-responsive="true"></ins>
  </td>
  </tr>
</table>



<script>
     (adsbygoogle = window.adsbygoogle || []).push({});
</script>


    
    
    <div>
      <div id="github-comment">
      </div>

      <script type="text/javascript">
        function getUtterances(isDark) {
          var utterances = document.createElement('script');
          utterances.type = 'text/javascript';
          utterances.async = true;
          utterances.setAttribute('issue-term', "pathname")
          utterances.setAttribute('repo', "kingcos\/kingcos.github.io")
          utterances.setAttribute('label', "comments")
          isDark ? utterances.setAttribute('theme', "github-dark") : utterances.setAttribute('theme', "github-light")
          utterances.crossorigin = 'anonymous';
          utterances.src = 'https://utteranc.es/client.js';

          return utterances
        }

        var themeToggle = document.querySelector(".theme-toggle")
        themeToggle.addEventListener("click", function () {
          var getTheme = window.localStorage && window.localStorage.getItem("theme")
          var divNode = document.getElementById('github-comment')
          while(divNode.hasChildNodes()) {
            divNode.removeChild(divNode.firstChild);
          }
          
          
          

          
          
          
          
          
          
          document.getElementById('github-comment').appendChild(getUtterances(getTheme !== "dark"))
        })

        var getTheme = window.localStorage && window.localStorage.getItem("theme")
        document.getElementById('github-comment').appendChild(getUtterances(getTheme === "dark"))
      </script>
    </div>
    

    </div>

      </div>

      
        <footer class="footer">
  <div class="footer__inner">
    
      <div class="copyright copyright--user">All rights reserved by kingcos.me</div>
    
  </div>
</footer>

<script src="/assets/main.js"></script>
<script src="/assets/prism.js"></script>



      
    </div>

    
      
<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
	(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
	m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
	})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
	ga('create', 'UA-138311951-1', 'auto');
	
	ga('send', 'pageview');
}
</script>

    
  </body>
</html>
