<!DOCTYPE html>
<html lang="en" >
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="author" content="kingcos" />
	
	
	
	<title>Combine 基础 ｜ kingcos</title>
	
    
    
    <meta name="description" content="30-day challenge" />
    

    
    
    <meta name="keywords" content="Hugo, theme, zozo" />
    

	
    
    <link rel="shortcut icon" href="https://kingcos.me/images/favicon.png" />

    <link rel="stylesheet" type="text/css" media="screen" href="https://kingcos.me/css/normalize.css" />
    <link rel="stylesheet" type="text/css" media="screen" href="https://cdn.jsdelivr.net/npm/animate.css@4.1.0/animate.min.css" />
    <link rel="stylesheet" type="text/css" media="screen" href="https://kingcos.me/css/zozo.css" />
	<link rel="stylesheet" type="text/css" media="screen" href="https://cdn.jsdelivr.net/npm/remixicon@2.5.0/fonts/remixicon.css" />
    <link rel="stylesheet" type="text/css" media="screen" href="https://kingcos.me/css/highlight.css" />

    
    
</head>




<body>
    <div class="main animate__animated animate__fadeInDown">
        <div class="nav_container animated fadeInDown">
    <div class="site_nav" id="site_nav">
        <ul>
            
            <li>
                <a href="/">Home</a>
            </li>
            
            <li>
                <a href="/posts/">Archive</a>
            </li>
            
            <li>
                <a href="/tags/">Tags</a>
            </li>
            
            <li>
                <a href="/about/">About</a>
            </li>
            
        </ul>
    </div>
    <div class="menu_icon">
        <a id="menu_icon"><i class="ri-menu-line"></i></a>
    </div>
</div>


<link rel="stylesheet" href="https://kingcos.me/scss/main.min.75b49085bfb07b1bf150a1d59b4773d857e0452a747e37243805218b528a4045.css" integrity="sha256-dbSQhb&#43;wexvxUKHVm0dz2FfgRSp0fjckOAUhi1KKQEU=" media="screen">

<style>
.nav_container {
  height: 1rem;
}
 
table {
    width: 100%;
    table-layout: fixed;
}

 
.markdown code {
    white-space: normal;
    word-wrap: break-word;
    word-break: break-word;
    line-height: 1.5em;
    font-size: 0.85em;
    font-weight: bold;
    display: inline-block;
     
}

 
.menu_icon a {
    font-size: 16px;
}

 
body {
    font-family: 'Hiragino Sans GB', 'SFMono', 'Lato', '-apple-system';
    -webkit-font-smoothing: 'antialiased';
}

 
.markdown strong, .markdown b, .markdown em {
    font-weight: bold;
}

.post .post_content p {
     

    line-height: 1.75em;
}

 
.markdown img {
    max-width: 100%;
    margin: 0 auto;
    display: block;
    border-radius: 0.25rem;
}

 
.ri-stack-line {
    vertical-align: middle;
}

 
.ri-map-pin-time-line {
    vertical-align: middle;
}

 
.chroma .lntd:nth-child(2) {
    width: 100%;
}

 

 
.markdown .book-hint::before {
    content: none;
}

.markdown .book-hint {
    margin: 1rem 0;
    padding: 0.5rem 1rem 0.5rem 0.75rem;

    border-inline-start: 0.25rem solid #e9ecef;
    border-radius: 0.25rem;

    font-style: normal;
     
}

.book-hint strong {
    background-color: transparent;
}

.markdown .book-hint.info {
    border-left-color:#6bf;
    background-color:rgba(102,187,255,.1);
}

.markdown .book-hint.warning {
    border-left-color:#fd6;
    background-color:rgba(255,221,102,.1);
}

.markdown .book-hint.danger {
    border-left-color:#f66;
    background-color:rgba(255,102,102,.1);
}

</style>

        <div class="header animated fadeInDown">
    <div class="site_title_container">
        <div class="site_title">
            
                <a href="https://kingcos.me/">
                    
                    <img class="kingcos" style="margin-top: -20px; margin-left: -10px;" src="/title.svg" width="150px">
                </a>
            
        </div>
        <div class="description">
            <p class="sub_title">专注、坚持</p>
            <div class="my_socials">
                
                
                <a href="https://github.com/kingcos" title="github" target="_blank"><i class="ri-github-fill"></i></a>
                
                
                
                <a href="https://www.instagram.com/kingcos_v/" title="instagram" target="_blank"><i class="ri-instagram-fill"></i></a>
                
                
                
                <a href="https://twitter.com/kingcos_v" title="twitter" target="_blank"><i class="ri-twitter-fill"></i></a>
                
                
                
                <a href="https://weibo.com/u/1798410923" title="weibo" target="_blank"><i class="ri-weibo-fill"></i></a>
                
                
                
            </div>
        </div>
    </div>
</div>
        <div class="content">
            <div class="post_page">
                <div class="post animate__animated animate__fadeInDown">
                    <div class="post_title post_detail_title">
                        <h2><a href='/posts/2022/swift_combine_basics/'>Combine 基础</a></h2>
                        <span class="date">2022.07.02</span>
                        <span>by kingcos</span>
                        
                        
                        
                        
                    </div>
                    <div class="post_content markdown">
<div class="book-expand">
  <label>
    <div class="book-expand-head flex justify-between">
      <span>Release Notes</span>
      <span>↕</span>
    </div>
    <input type="checkbox" class="hidden" />
    <div class="book-expand-content markdown-inner">
      <table>
<thead>
<tr>
<th style="text-align:center">Date</th>
<th style="text-align:center">Notes</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">2022-06-29</td>
<td style="text-align:center">首次提交</td>
</tr>
</tbody>
</table>

    </div>
  </label>
</div>

<h2 id="preface">Preface</h2>
<p>Combine 是 Apple 为响应式编程推出的全新框架。</p>
<h2 id="概览">概览</h2>
<p>Combine 中最基本的三个元素是：</p>
<ul>
<li>Pulisher（发布者）-&gt; Operator（操作符）-&gt; Subscriber（订阅者）</li>
</ul>
<p>即发布事件、操作与转换、订阅事件。</p>
<h2 id="pulisher">Pulisher</h2>
<h3 id="介绍">介绍</h3>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-swift" data-lang="swift"><span class="line"><span class="cl"><span class="c1">/// Declares that a type can transmit a sequence of values over time.</span>
</span></span><span class="line"><span class="cl"><span class="c1">/// 声明一种可以随时间传输（发布）值序列的类型。</span>
</span></span><span class="line"><span class="cl"><span class="c1">///</span>
</span></span><span class="line"><span class="cl"><span class="c1">/// A publisher delivers elements to one or more ``Subscriber`` instances.</span>
</span></span><span class="line"><span class="cl"><span class="c1">/// 发布者将元素传递给一个或多个 ``Subscriber`` 实例。</span>
</span></span><span class="line"><span class="cl"><span class="c1">/// The subscriber’s ``Subscriber/Input`` and ``Subscriber/Failure`` associated types must match the ``Publisher/Output`` and ``Publisher/Failure`` types declared by the publisher.</span>
</span></span><span class="line"><span class="cl"><span class="c1">/// 订阅者的 ``Subscriber/Input`` 和 ``Subscriber/Failure`` 的关联类型必须与发布者声明的 ``Publisher/Output`` 和 ``Publisher/Failure`` 类型匹配。</span>
</span></span><span class="line"><span class="cl"><span class="c1">/// The publisher implements the ``Publisher/receive(subscriber:)``method to accept a subscriber.</span>
</span></span><span class="line"><span class="cl"><span class="c1">/// 发布者实现 ``Publisher/receive(subscriber:)`` 方法来接受订阅者。</span>
</span></span><span class="line"><span class="cl"><span class="c1">///</span>
</span></span><span class="line"><span class="cl"><span class="c1">/// After this, the publisher can call the following methods on the subscriber:</span>
</span></span><span class="line"><span class="cl"><span class="c1">/// 在此之后，发布者可以在订阅者上调用以下方法：</span>
</span></span><span class="line"><span class="cl"><span class="c1">/// - ``Subscriber/receive(subscription:)``: Acknowledges the subscribe request and returns a ``Subscription`` instance. The subscriber uses the subscription to demand elements from the publisher and can use it to cancel publishing.</span>
</span></span><span class="line"><span class="cl"><span class="c1">/// - ``Subscriber/receive(subscription:)``: 确认订阅请求并返回 ``Subscription`` 实例。订阅者使用 subscription 从发布者请求元素，并可以用其取消发布。</span>
</span></span><span class="line"><span class="cl"><span class="c1">/// - ``Subscriber/receive(_:)``: Delivers one element from the publisher to the subscriber.</span>
</span></span><span class="line"><span class="cl"><span class="c1">/// - ``Subscriber/receive(_:)``: 将一个元素从发布者传递给订阅者。</span>
</span></span><span class="line"><span class="cl"><span class="c1">/// - ``Subscriber/receive(completion:)``: Informs the subscriber that publishing has ended, either normally or with an error.</span>
</span></span><span class="line"><span class="cl"><span class="c1">/// - ``Subscriber/receive(completion:)``: 通知订阅者发布已结束（正常或出现错误）。</span>
</span></span><span class="line"><span class="cl"><span class="c1">///</span>
</span></span><span class="line"><span class="cl"><span class="c1">/// Every `Publisher` must adhere to this contract for downstream subscribers to function correctly.</span>
</span></span><span class="line"><span class="cl"><span class="c1">/// 每个 `Publisher` 都必须遵守本协议，以便下游订阅者正常工作。</span>
</span></span><span class="line"><span class="cl"><span class="c1">///</span>
</span></span><span class="line"><span class="cl"><span class="c1">/// Extensions on `Publisher` define a wide variety of _operators_ that you compose to create sophisticated event-processing chains.</span>
</span></span><span class="line"><span class="cl"><span class="c1">/// `Publisher` 上的扩展定义了各种各样的符，可以组合这些操作符来创建复杂的事件处理链。</span>
</span></span><span class="line"><span class="cl"><span class="c1">/// Each operator returns a type that implements the ``Publisher`` protocol</span>
</span></span><span class="line"><span class="cl"><span class="c1">/// 每个操作符返回一个实现 `Publisher` 上协议的类型</span>
</span></span><span class="line"><span class="cl"><span class="c1">/// Most of these types exist as extensions on the ``Publishers`` enumeration.</span>
</span></span><span class="line"><span class="cl"><span class="c1">/// 这些类型中的大多数作为 ``Publishers`` 枚举的扩展存在。</span>
</span></span><span class="line"><span class="cl"><span class="c1">/// For example, the ``Publisher/map(_:)-99evh`` operator returns an instance of ``Publishers/Map``.</span>
</span></span><span class="line"><span class="cl"><span class="c1">/// 例如，``Publisher/map(_:)-99evh`` 操作符返回 ``Publishers/Map`` 的实例。</span>
</span></span><span class="line"><span class="cl"><span class="c1">///</span>
</span></span><span class="line"><span class="cl"><span class="c1">/// &gt; Tip: A Combine publisher fills a role similar to, but distinct from, the</span>
</span></span><span class="line"><span class="cl"><span class="c1">/// &lt;doc://com.apple.documentation/documentation/Swift/AsyncSequence&gt; in the</span>
</span></span><span class="line"><span class="cl"><span class="c1">/// Swift standard library. A `Publisher` and an</span>
</span></span><span class="line"><span class="cl"><span class="c1">/// `AsyncSequence` both produce elements over time. However, the pull model in Combine</span>
</span></span><span class="line"><span class="cl"><span class="c1">/// uses a ``Combine/Subscriber`` to request elements from a publisher, while Swift</span>
</span></span><span class="line"><span class="cl"><span class="c1">/// concurrency uses the `for`-`await`-`in` syntax to iterate over elements</span>
</span></span><span class="line"><span class="cl"><span class="c1">/// published by an `AsyncSequence`. Both APIs offer methods to modify the sequence</span>
</span></span><span class="line"><span class="cl"><span class="c1">/// by mapping or filtering elements, while only Combine provides time-based</span>
</span></span><span class="line"><span class="cl"><span class="c1">/// operations like</span>
</span></span><span class="line"><span class="cl"><span class="c1">/// ``Publisher/debounce(for:scheduler:options:)`` and</span>
</span></span><span class="line"><span class="cl"><span class="c1">/// ``Publisher/throttle(for:scheduler:latest:)``, and combining operations like</span>
</span></span><span class="line"><span class="cl"><span class="c1">/// ``Publisher/merge(with:)-7fk3a`` and ``Publisher/combineLatest(_:_:)-1n30g``.</span>
</span></span><span class="line"><span class="cl"><span class="c1">/// To bridge the two approaches, the property ``Publisher/values-1dm9r`` exposes</span>
</span></span><span class="line"><span class="cl"><span class="c1">/// a publisher&#39;s elements as an `AsyncSequence`, allowing you to iterate over</span>
</span></span><span class="line"><span class="cl"><span class="c1">/// them with `for`-`await`-`in` rather than attaching a ``Subscriber``.</span>
</span></span><span class="line"><span class="cl"><span class="c1">/// &gt; 提示</span>
</span></span><span class="line"><span class="cl"><span class="c1">/// &gt; Combine 发布者扮演的角色类似于但不同于 Swift 标准库中的 &lt;doc://com.apple.documentation/documentation/Swift/AsyncSequence&gt;。</span>
</span></span><span class="line"><span class="cl"><span class="c1">/// &gt; `Publisher` 和 `AsyncSequence` 都可以随时间产生元素。但是，Combine 中的拉取模型（pull model）使用 ``Combine/Subscriber`` 来从发布者请求元素，而 Swift 并发中使用 `for`-`await`-`in` 语法来遍历 `AsyncSequence` 发布的元素。</span>
</span></span><span class="line"><span class="cl"><span class="c1">/// &gt; 两个 API 均提供通过映射（map）或过滤（filter）元素的方法来修改序列，但只有 Combine 提供了基于时间的操作，例如：</span>
</span></span><span class="line"><span class="cl"><span class="c1">/// &gt; ``Publisher/debounce(for:scheduler:options:)`` 和 ``Publisher/throttle(for:scheduler:latest:)``，以及组合操作，例如 ``Publisher/merge(with:)-7fk3a`` 和  ``Publisher/combineLatest(_:_:)-1n30g``。</span>
</span></span><span class="line"><span class="cl"><span class="c1">/// &gt; 为了桥接这两种方法，`Publisher/values-1dm9r`` 属性暴露一个发布者元素作为 `AsyncSequence`，允许使用 `for`-`await`-`in` 迭代元素，而不是附加一个 ``Subscriber``。</span>
</span></span><span class="line"><span class="cl"><span class="c1">///</span>
</span></span><span class="line"><span class="cl"><span class="c1">/// # Creating Your Own Publishers</span>
</span></span><span class="line"><span class="cl"><span class="c1">/// # 创建你自己的发布者</span>
</span></span><span class="line"><span class="cl"><span class="c1">///</span>
</span></span><span class="line"><span class="cl"><span class="c1">/// Rather than implementing the `Publisher` protocol yourself, you can create your own publisher by using one of several types provided by the Combine framework:</span>
</span></span><span class="line"><span class="cl"><span class="c1">/// 可以使用 Combine 提供的几种类型中的一种来创建自己的发布者，而不是自己实现 `Publisher` 协议：</span>
</span></span><span class="line"><span class="cl"><span class="c1">///</span>
</span></span><span class="line"><span class="cl"><span class="c1">/// - Use a concrete subclass of ``Subject``, such as ``PassthroughSubject``, to publish values on-demand by calling its ``Subject/send(_:)`` method.</span>
</span></span><span class="line"><span class="cl"><span class="c1">/// - 使用 ``Subject`` 的具体子类，例如 ``PassthroughSubject``，通过调用其 ``Subject/send(_:)`` 方法按需发布值。</span>
</span></span><span class="line"><span class="cl"><span class="c1">/// - Use a ``CurrentValueSubject`` to publish whenever you update the subject’s underlying value.</span>
</span></span><span class="line"><span class="cl"><span class="c1">/// - 使用 ``CurrentValueSubject`` 来根据当前值来发布值。</span>
</span></span><span class="line"><span class="cl"><span class="c1">/// - Add the `@Published` annotation to a property of one of your own types. In doing so, the property gains a publisher that emits an event whenever the property’s value changes. See the ``Published`` type for an example of this approach.</span>
</span></span><span class="line"><span class="cl"><span class="c1">/// - 将 `@Published` 标记添加到自己的类型的属性上，这样属性就会获得一个发布者，它会在属性的值发生变化时发布一个事件。请参考 ``Published`` 类的示例来了解这种方法。</span>
</span></span><span class="line"><span class="cl"><span class="p">@</span><span class="n">available</span><span class="p">(</span><span class="n">macOS</span> <span class="mf">10.15</span><span class="p">,</span> <span class="n">iOS</span> <span class="mf">13.0</span><span class="p">,</span> <span class="n">tvOS</span> <span class="mf">13.0</span><span class="p">,</span> <span class="n">watchOS</span> <span class="mf">6.0</span><span class="p">,</span> <span class="o">*</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">protocol</span> <span class="nc">Publisher</span><span class="p">&lt;</span><span class="n">Output</span><span class="p">,</span> <span class="n">Failure</span><span class="p">&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">/// The kind of values published by this publisher.</span>
</span></span><span class="line"><span class="cl">    <span class="c1">/// 该发布者发布的值的类型。</span>
</span></span><span class="line"><span class="cl">    <span class="n">associatedtype</span> <span class="n">Output</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">/// The kind of errors this publisher might publish.</span>
</span></span><span class="line"><span class="cl">    <span class="c1">/// 该发布者可能会发布的错误类型。</span>
</span></span><span class="line"><span class="cl">    <span class="c1">///</span>
</span></span><span class="line"><span class="cl">    <span class="c1">/// Use `Never` if this `Publisher` does not publish errors.</span>
</span></span><span class="line"><span class="cl">    <span class="c1">/// 如果该发布者不会发布错误，请使用 `Never`。</span>
</span></span><span class="line"><span class="cl">    <span class="n">associatedtype</span> <span class="n">Failure</span> <span class="p">:</span> <span class="n">Error</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">/// Attaches the specified subscriber to this publisher.</span>
</span></span><span class="line"><span class="cl">    <span class="c1">/// 将指定的订阅者附加到该发布者。</span>
</span></span><span class="line"><span class="cl">    <span class="c1">///</span>
</span></span><span class="line"><span class="cl">    <span class="c1">/// Implementations of ``Publisher`` must implement this method.</span>
</span></span><span class="line"><span class="cl">    <span class="c1">/// ``Publisher`` 的实现必须实现该方法。</span>
</span></span><span class="line"><span class="cl">    <span class="c1">///</span>
</span></span><span class="line"><span class="cl">    <span class="c1">/// The provided implementation of ``Publisher/subscribe(_:)-4u8kn``calls this method.</span>
</span></span><span class="line"><span class="cl">    <span class="c1">/// ``Publisher/subscribe(_:)-4u8kn`` 提供的实现调用此方法。</span>
</span></span><span class="line"><span class="cl">    <span class="c1">///</span>
</span></span><span class="line"><span class="cl">    <span class="c1">/// - Parameter subscriber: The subscriber to attach to this ``Publisher``, after which it can receive values.</span>
</span></span><span class="line"><span class="cl">    <span class="c1">/// - 参数订阅者：附加到此 ``Publisher`` 的订阅者，在此之后可以接收值。</span>
</span></span><span class="line"><span class="cl">    <span class="c1">/// </span>
</span></span><span class="line"><span class="cl">    <span class="kd">func</span> <span class="nf">receive</span><span class="p">&lt;</span><span class="n">S</span><span class="p">&gt;(</span><span class="n">subscriber</span><span class="p">:</span> <span class="n">S</span><span class="p">)</span> <span class="k">where</span> <span class="n">S</span> <span class="p">:</span> <span class="n">Subscriber</span><span class="p">,</span> <span class="kc">Self</span><span class="p">.</span><span class="n">Failure</span> <span class="p">==</span> <span class="n">S</span><span class="p">.</span><span class="n">Failure</span><span class="p">,</span> <span class="kc">Self</span><span class="p">.</span><span class="n">Output</span> <span class="p">==</span> <span class="n">S</span><span class="p">.</span><span class="n">Input</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>Pulisher 可以发布三种事件：</p>
<ol>
<li>Output 值</li>
<li>Failure 错误，并结束</li>
<li>完成，并结束</li>
</ol>
<p>以及事件流可以分为有限事件流和无限事件流。</p>
<h3 id="subject">Subject</h3>
<h2 id="operator">Operator</h2>
<p>由上一节可以得知 Pulisher 负责发布事件，但有时发出的事件仍然需要转换才能为我所用，此时就需要 Operator。Operator 以上游 Publisher 作为输入，经过转换产生新的数据，然后再作为 Publisher 输出给下游。</p>
<h3 id="scan">scan</h3>

<div class="book-expand">
  <label>
    <div class="book-expand-head flex justify-between">
      <span>scan in Xcode</span>
      <span>↕</span>
    </div>
    <input type="checkbox" class="hidden" />
    <div class="book-expand-content markdown-inner">
      <div class="highlight"><pre tabindex="0" class="chroma"><code class="language-swift" data-lang="swift"><span class="line"><span class="cl"><span class="p">@</span><span class="n">available</span><span class="p">(</span><span class="n">macOS</span> <span class="mf">10.15</span><span class="p">,</span> <span class="n">iOS</span> <span class="mf">13.0</span><span class="p">,</span> <span class="n">tvOS</span> <span class="mf">13.0</span><span class="p">,</span> <span class="n">watchOS</span> <span class="mf">6.0</span><span class="p">,</span> <span class="o">*</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="kd">extension</span> <span class="nc">Publisher</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">/// Transforms elements from the upstream publisher by providing the current</span>
</span></span><span class="line"><span class="cl">    <span class="c1">/// element to a closure along with the last value returned by the closure.</span>
</span></span><span class="line"><span class="cl">    <span class="c1">///</span>
</span></span><span class="line"><span class="cl">    <span class="c1">/// Use ``Publisher/scan(_:_:)`` to accumulate all previously-published values into a single</span>
</span></span><span class="line"><span class="cl">    <span class="c1">/// value, which you then combine with each newly-published value.</span>
</span></span><span class="line"><span class="cl">    <span class="c1">///</span>
</span></span><span class="line"><span class="cl">    <span class="c1">/// The following example logs a running total of all values received</span>
</span></span><span class="line"><span class="cl">    <span class="c1">/// from the sequence publisher.</span>
</span></span><span class="line"><span class="cl">    <span class="c1">///</span>
</span></span><span class="line"><span class="cl">    <span class="c1">///     let range = (0...5)</span>
</span></span><span class="line"><span class="cl">    <span class="c1">///     cancellable = range.publisher</span>
</span></span><span class="line"><span class="cl">    <span class="c1">///         .scan(0) { return $0 + $1 }</span>
</span></span><span class="line"><span class="cl">    <span class="c1">///         .sink { print (&#34;\($0)&#34;, terminator: &#34; &#34;) }</span>
</span></span><span class="line"><span class="cl">    <span class="c1">///      // Prints: &#34;0 1 3 6 10 15 &#34;.</span>
</span></span><span class="line"><span class="cl">    <span class="c1">///</span>
</span></span><span class="line"><span class="cl">    <span class="c1">/// - Parameters:</span>
</span></span><span class="line"><span class="cl">    <span class="c1">///   - initialResult: The previous result returned by the `nextPartialResult` closure.</span>
</span></span><span class="line"><span class="cl">    <span class="c1">///   - nextPartialResult: A closure that takes as its arguments the previous value returned by the closure and the next element emitted from the upstream publisher.</span>
</span></span><span class="line"><span class="cl">    <span class="c1">/// - Returns: A publisher that transforms elements by applying a closure that receives its previous return value and the next element from the upstream publisher.</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kd">func</span> <span class="nf">scan</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;(</span><span class="kc">_</span> <span class="n">initialResult</span><span class="p">:</span> <span class="n">T</span><span class="p">,</span> <span class="kc">_</span> <span class="n">nextPartialResult</span><span class="p">:</span> <span class="p">@</span><span class="n">escaping</span> <span class="p">(</span><span class="n">T</span><span class="p">,</span> <span class="kc">Self</span><span class="p">.</span><span class="n">Output</span><span class="p">)</span> <span class="p">-&gt;</span> <span class="n">T</span><span class="p">)</span> <span class="p">-&gt;</span> <span class="n">Publishers</span><span class="p">.</span><span class="n">Scan</span><span class="p">&lt;</span><span class="kc">Self</span><span class="p">,</span> <span class="n">T</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">/// Transforms elements from the upstream publisher by providing the current element to an error-throwing closure along with the last value returned by the closure.</span>
</span></span><span class="line"><span class="cl">    <span class="c1">///</span>
</span></span><span class="line"><span class="cl">    <span class="c1">/// Use ``Publisher/tryScan(_:_:)`` to accumulate all previously-published values into a single value, which you then combine with each newly-published value.</span>
</span></span><span class="line"><span class="cl">    <span class="c1">/// If your accumulator closure throws an error, the publisher terminates with the error.</span>
</span></span><span class="line"><span class="cl">    <span class="c1">///</span>
</span></span><span class="line"><span class="cl">    <span class="c1">/// In the example below, ``Publisher/tryScan(_:_:)`` calls a division function on elements of a collection publisher. The ``Publishers/TryScan`` publisher publishes each result until the function encounters a `DivisionByZeroError`, which terminates the publisher.</span>
</span></span><span class="line"><span class="cl">    <span class="c1">///</span>
</span></span><span class="line"><span class="cl">    <span class="c1">///     struct DivisionByZeroError: Error {}</span>
</span></span><span class="line"><span class="cl">    <span class="c1">///</span>
</span></span><span class="line"><span class="cl">    <span class="c1">///     /// A function that throws a DivisionByZeroError if `current` provided by the TryScan publisher is zero.</span>
</span></span><span class="line"><span class="cl">    <span class="c1">///     func myThrowingFunction(_ lastValue: Int, _ currentValue: Int) throws -&gt; Int {</span>
</span></span><span class="line"><span class="cl">    <span class="c1">///         guard currentValue != 0 else { throw DivisionByZeroError() }</span>
</span></span><span class="line"><span class="cl">    <span class="c1">///         return (lastValue + currentValue) / currentValue</span>
</span></span><span class="line"><span class="cl">    <span class="c1">///      }</span>
</span></span><span class="line"><span class="cl">    <span class="c1">///</span>
</span></span><span class="line"><span class="cl">    <span class="c1">///     let numbers = [1,2,3,4,5,0,6,7,8,9]</span>
</span></span><span class="line"><span class="cl">    <span class="c1">///     cancellable = numbers.publisher</span>
</span></span><span class="line"><span class="cl">    <span class="c1">///         .tryScan(10) { try myThrowingFunction($0, $1) }</span>
</span></span><span class="line"><span class="cl">    <span class="c1">///         .sink(</span>
</span></span><span class="line"><span class="cl">    <span class="c1">///             receiveCompletion: { print (&#34;\($0)&#34;) },</span>
</span></span><span class="line"><span class="cl">    <span class="c1">///             receiveValue: { print (&#34;\($0)&#34;, terminator: &#34; &#34;) }</span>
</span></span><span class="line"><span class="cl">    <span class="c1">///          )</span>
</span></span><span class="line"><span class="cl">    <span class="c1">///</span>
</span></span><span class="line"><span class="cl">    <span class="c1">///     // Prints: &#34;11 6 3 1 1 -1 failure(DivisionByZeroError())&#34;.</span>
</span></span><span class="line"><span class="cl">    <span class="c1">///</span>
</span></span><span class="line"><span class="cl">    <span class="c1">/// If the closure throws an error, the publisher fails with the error.</span>
</span></span><span class="line"><span class="cl">    <span class="c1">///</span>
</span></span><span class="line"><span class="cl">    <span class="c1">/// - Parameters:</span>
</span></span><span class="line"><span class="cl">    <span class="c1">///   - initialResult: The previous result returned by the `nextPartialResult` closure.</span>
</span></span><span class="line"><span class="cl">    <span class="c1">///   - nextPartialResult: An error-throwing closure that takes as its arguments the previous value returned by the closure and the next element emitted from the upstream publisher.</span>
</span></span><span class="line"><span class="cl">    <span class="c1">/// - Returns: A publisher that transforms elements by applying a closure that receives its previous return value and the next element from the upstream publisher.</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kd">func</span> <span class="nf">tryScan</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;(</span><span class="kc">_</span> <span class="n">initialResult</span><span class="p">:</span> <span class="n">T</span><span class="p">,</span> <span class="kc">_</span> <span class="n">nextPartialResult</span><span class="p">:</span> <span class="p">@</span><span class="n">escaping</span> <span class="p">(</span><span class="n">T</span><span class="p">,</span> <span class="kc">Self</span><span class="p">.</span><span class="n">Output</span><span class="p">)</span> <span class="kr">throws</span> <span class="p">-&gt;</span> <span class="n">T</span><span class="p">)</span> <span class="p">-&gt;</span> <span class="n">Publishers</span><span class="p">.</span><span class="n">TryScan</span><span class="p">&lt;</span><span class="kc">Self</span><span class="p">,</span> <span class="n">T</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div>
    </div>
  </label>
</div>

<p><code>scan</code> 操作符以上游数据和一个固定的初始值为输入，以闭包返回的数据作为新的发布者为输出：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-swift" data-lang="swift"><span class="line"><span class="cl"><span class="kd">let</span> <span class="nv">array</span> <span class="p">=</span> <span class="p">[</span><span class="mf">1.0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">]</span> <span class="c1">// (1...4)</span>
</span></span><span class="line"><span class="cl"><span class="kd">let</span> <span class="nv">initialValue</span> <span class="p">=</span> <span class="mi">100</span>
</span></span><span class="line"><span class="cl"><span class="kc">_</span> <span class="p">=</span> <span class="n">array</span>
</span></span><span class="line"><span class="cl">    <span class="p">.</span><span class="n">publisher</span>             <span class="c1">// 将数组作为发布者，依次发布其中的值</span>
</span></span><span class="line"><span class="cl">    <span class="p">.</span><span class="n">scan</span><span class="p">(</span><span class="n">initialValue</span><span class="p">)</span> <span class="p">{</span> <span class="nv">$0</span> <span class="o">+</span> <span class="nb">Int</span><span class="p">(</span><span class="nv">$1</span><span class="p">)</span> <span class="p">}</span> <span class="c1">// scan 操作符：传入一个初始值，以及一个处理初始值和上游输出的闭包，闭包返回的数据将作为新的发布者发布</span>
</span></span><span class="line"><span class="cl">    <span class="p">.</span><span class="n">sink</span> <span class="p">{</span> <span class="bp">print</span> <span class="p">(</span><span class="nv">$0</span><span class="p">,</span> <span class="n">terminator</span><span class="p">:</span> <span class="s">&#34; &#34;</span><span class="p">)</span> <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// 101.0 103.0 106.0 110.0</span>
</span></span></code></pre></div><p>需要注意的是，<code>func scan&lt;T&gt;(_ initialResult: T, _ nextPartialResult: @escaping (T, Self.Output) -&gt; T) -&gt; Publishers.Scan&lt;Self, T&gt;</code>，<code>scan</code> 操作符返回的发布者的输出类型是 <code>T</code>，即<strong>初始值的类型</strong>。</p>
<h3 id="map">map</h3>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-swift" data-lang="swift"><span class="line"><span class="cl"><span class="p">@</span><span class="n">available</span><span class="p">(</span><span class="n">macOS</span> <span class="mf">10.15</span><span class="p">,</span> <span class="n">iOS</span> <span class="mf">13.0</span><span class="p">,</span> <span class="n">tvOS</span> <span class="mf">13.0</span><span class="p">,</span> <span class="n">watchOS</span> <span class="mf">6.0</span><span class="p">,</span> <span class="o">*</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="kd">extension</span> <span class="nc">Publishers</span><span class="p">.</span><span class="n">Sequence</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// ...</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kd">func</span> <span class="nf">map</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;(</span><span class="kc">_</span> <span class="n">transform</span><span class="p">:</span> <span class="p">(</span><span class="n">Elements</span><span class="p">.</span><span class="n">Element</span><span class="p">)</span> <span class="p">-&gt;</span> <span class="n">T</span><span class="p">)</span> <span class="p">-&gt;</span> <span class="n">Publishers</span><span class="p">.</span><span class="n">Sequence</span><span class="o">&lt;</span><span class="p">[</span><span class="n">T</span><span class="p">],</span> <span class="n">Failure</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// ...</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p><code>map</code> 操作符则类似平时使用的高阶函数，可以对输入的上游数据进行映射或转换，同样以以闭包返回的数据作为新的发布者为输出：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-swift" data-lang="swift"><span class="line"><span class="cl"><span class="kd">let</span> <span class="nv">array</span> <span class="p">=</span> <span class="p">[</span><span class="mf">1.0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">]</span> <span class="c1">// (1...4)</span>
</span></span><span class="line"><span class="cl"><span class="kd">let</span> <span class="nv">initialValue</span> <span class="p">=</span> <span class="mi">100</span>
</span></span><span class="line"><span class="cl"><span class="kc">_</span> <span class="p">=</span> <span class="n">array</span>
</span></span><span class="line"><span class="cl">    <span class="p">.</span><span class="n">publisher</span>             <span class="c1">// 将数组作为发布者，依次发布其中的值</span>
</span></span><span class="line"><span class="cl">    <span class="p">.</span><span class="n">scan</span><span class="p">(</span><span class="n">initialValue</span><span class="p">)</span> <span class="p">{</span> <span class="nv">$0</span> <span class="o">+</span> <span class="nb">Int</span><span class="p">(</span><span class="nv">$1</span><span class="p">)</span> <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">.</span><span class="bp">map</span> <span class="p">{</span> <span class="nb">String</span><span class="p">(</span><span class="nv">$0</span><span class="p">)</span> <span class="p">}</span>    <span class="c1">// map  操作符：可在闭包内对上游输出做映射或转换，闭包返回的数据将作为新的发布者发布</span>
</span></span><span class="line"><span class="cl">    <span class="p">.</span><span class="n">sink</span> <span class="p">{</span> <span class="bp">print</span> <span class="p">(</span><span class="nv">$0</span><span class="p">,</span> <span class="n">terminator</span><span class="p">:</span> <span class="s">&#34; &#34;</span><span class="p">)</span> <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// 101 103 106 110 </span>
</span></span></code></pre></div><h2 id="subscriber">Subscriber</h2>
<h3 id="介绍-1">介绍</h3>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-swift" data-lang="swift"><span class="line"><span class="cl"><span class="c1">/// A protocol that declares a type that can receive input from a publisher.</span>
</span></span><span class="line"><span class="cl"><span class="c1">/// 声明一种可以接收发布者输入的类型的协议。</span>
</span></span><span class="line"><span class="cl"><span class="c1">///</span>
</span></span><span class="line"><span class="cl"><span class="c1">/// A ``Subscriber`` instance receives a stream of elements from a ``Publisher``, along with life cycle events describing changes to their relationship. A given subscriber’s ``Subscriber/Input`` and ``Subscriber/Failure`` associated types must match the ``Publisher/Output`` and ``Publisher/Failure`` of its corresponding publisher.</span>
</span></span><span class="line"><span class="cl"><span class="c1">/// ``Subscriber`` 实例从 ``Publisher`` 接收元素流，以及描述其关系变化的生命周期事件。给定订阅者的 ``Subscriber/Input`` 和 ``Subscriber/Failure`` 关联类型必须与其相应发布者的 ``Publisher/Output`` 和 ``Publisher/Failure`` 匹配。</span>
</span></span><span class="line"><span class="cl"><span class="c1">///</span>
</span></span><span class="line"><span class="cl"><span class="c1">/// You connect a subscriber to a publisher by calling the publisher’s ``Publisher/subscribe(_:)-4u8kn`` method.  After making this call, the publisher invokes the subscriber’s ``Subscriber/receive(subscription:)`` method. This gives the subscriber a ``Subscription`` instance, which it uses to demand elements from the publisher, and to optionally cancel the subscription. After the subscriber makes an initial demand, the publisher calls ``Subscriber/receive(_:)``, possibly asynchronously, to deliver newly-published elements. If the publisher stops publishing, it calls ``Subscriber/receive(completion:)``, using a parameter of type ``Subscribers/Completion`` to indicate whether publishing completes normally or with an error.</span>
</span></span><span class="line"><span class="cl"><span class="c1">/// 可以通过调用发布者的``Publisher/subscribe(_:)-4u8kn`` 方法将订阅者连接到发布者。调用该方法后，发布者调用订阅者的 ``Subscriber/receive(subscription:)`` 方法。这为订阅者提供了一个 ``Subscription`` 实例，其使用该实例向发布者请求元素，并可以选择取消订阅。订阅者发出初始请求后，发布者调用（可能是异步）``Subscriber/receive(_:)``，以交付新发布的元素。如果发布者停止发布，其将使用类型为 ``Subscribers/Completion`` 的参数调用 ``Subscriber/receive(completion:)``，以指示发布是否正常完成或出现错误。</span>
</span></span><span class="line"><span class="cl"><span class="c1">///</span>
</span></span><span class="line"><span class="cl"><span class="c1">/// Combine provides the following subscribers as operators on the ``Publisher`` type:</span>
</span></span><span class="line"><span class="cl"><span class="c1">/// Combine 在 ``Publisher`` 类型上提供以下订阅者作为操作符：</span>
</span></span><span class="line"><span class="cl"><span class="c1">///</span>
</span></span><span class="line"><span class="cl"><span class="c1">/// - ``Publisher/sink(receiveCompletion:receiveValue:)`` executes arbitrary closures when it receives a completion signal and each time it receives a new element.</span>
</span></span><span class="line"><span class="cl"><span class="c1">/// - ``Publisher/sink(receiveCompletion:receiveValue:)`` 在接收到完成信号以及每次接收到新元素时执行任意闭包。</span>
</span></span><span class="line"><span class="cl"><span class="c1">/// - ``Publisher/assign(to🔛)`` writes each newly-received value to a property identified by a key path on a given instance.</span>
</span></span><span class="line"><span class="cl"><span class="c1">/// - ``Publisher/assign(to🔛)`` 将每个新接收的值写入由给定实例上的键路径标识的属性。</span>
</span></span><span class="line"><span class="cl"><span class="p">@</span><span class="n">available</span><span class="p">(</span><span class="n">macOS</span> <span class="mf">10.15</span><span class="p">,</span> <span class="n">iOS</span> <span class="mf">13.0</span><span class="p">,</span> <span class="n">tvOS</span> <span class="mf">13.0</span><span class="p">,</span> <span class="n">watchOS</span> <span class="mf">6.0</span><span class="p">,</span> <span class="o">*</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">protocol</span> <span class="nc">Subscriber</span><span class="p">&lt;</span><span class="n">Input</span><span class="p">,</span> <span class="n">Failure</span><span class="p">&gt;</span> <span class="p">:</span> <span class="n">CustomCombineIdentifierConvertible</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">/// The kind of values this subscriber receives.</span>
</span></span><span class="line"><span class="cl">    <span class="c1">/// 此订阅者接收的值的类型。</span>
</span></span><span class="line"><span class="cl">    <span class="n">associatedtype</span> <span class="n">Input</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">/// The kind of errors this subscriber might receive.</span>
</span></span><span class="line"><span class="cl">    <span class="c1">/// 此订阅者可能收到的错误类型。</span>
</span></span><span class="line"><span class="cl">    <span class="c1">///</span>
</span></span><span class="line"><span class="cl">    <span class="c1">/// Use `Never` if this `Subscriber` cannot receive errors.</span>
</span></span><span class="line"><span class="cl">    <span class="c1">/// 如果此 `Subscriber` 不接收错误，请使用 `Never`。</span>
</span></span><span class="line"><span class="cl">    <span class="n">associatedtype</span> <span class="n">Failure</span> <span class="p">:</span> <span class="n">Error</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">/// Tells the subscriber that it has successfully subscribed to the publisher and may request items.</span>
</span></span><span class="line"><span class="cl">    <span class="c1">/// 告知订阅者已成功订阅发布者，并可能请求项目。</span>
</span></span><span class="line"><span class="cl">    <span class="c1">///</span>
</span></span><span class="line"><span class="cl">    <span class="c1">/// Use the received ``Subscription`` to request items from the publisher.</span>
</span></span><span class="line"><span class="cl">    <span class="c1">/// 使用收到的 ``Subscription`` 从发布者请求项目。</span>
</span></span><span class="line"><span class="cl">    <span class="c1">/// - Parameter subscription: A subscription that represents the connection between publisher and subscriber.</span>
</span></span><span class="line"><span class="cl">    <span class="c1">/// - 参数 subscription: 表示发布者和订阅者之间连接的订阅。</span>
</span></span><span class="line"><span class="cl">    <span class="kd">func</span> <span class="nf">receive</span><span class="p">(</span><span class="n">subscription</span><span class="p">:</span> <span class="n">Subscription</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">/// Tells the subscriber that the publisher has produced an element.</span>
</span></span><span class="line"><span class="cl">    <span class="c1">/// 告诉订阅者，发布者已生成元素。</span>
</span></span><span class="line"><span class="cl">    <span class="c1">///</span>
</span></span><span class="line"><span class="cl">    <span class="c1">/// - Parameter input: The published element.</span>
</span></span><span class="line"><span class="cl">    <span class="c1">/// - 参数 input: 发布的元素。</span>
</span></span><span class="line"><span class="cl">    <span class="c1">/// - Returns: A `Subscribers.Demand` instance indicating how many more elements the subscriber expects to receive.</span>
</span></span><span class="line"><span class="cl">    <span class="c1">/// - 返回值: 表示订阅者预期接收多少个元素的 ``Subscribers.Demand`` 实例。</span>
</span></span><span class="line"><span class="cl">    <span class="kd">func</span> <span class="nf">receive</span><span class="p">(</span><span class="kc">_</span> <span class="n">input</span><span class="p">:</span> <span class="kc">Self</span><span class="p">.</span><span class="n">Input</span><span class="p">)</span> <span class="p">-&gt;</span> <span class="n">Subscribers</span><span class="p">.</span><span class="n">Demand</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">/// Tells the subscriber that the publisher has completed publishing, either normally or with an error.</span>
</span></span><span class="line"><span class="cl">    <span class="c1">/// 告诉订阅者，发布者已完成发布，可能是正常或出现错误。</span>
</span></span><span class="line"><span class="cl">    <span class="c1">///</span>
</span></span><span class="line"><span class="cl">    <span class="c1">/// - Parameter completion: A ``Subscribers/Completion`` case indicating whether publishing completed normally or with an error.</span>
</span></span><span class="line"><span class="cl">    <span class="c1">/// - 参数 completion: 表示发布是否正常完成或出现错误的 ``Subscribers/Completion`` 的实例。</span>
</span></span><span class="line"><span class="cl">    <span class="kd">func</span> <span class="nf">receive</span><span class="p">(</span><span class="n">completion</span><span class="p">:</span> <span class="n">Subscribers</span><span class="p">.</span><span class="n">Completion</span><span class="p">&lt;</span><span class="kc">Self</span><span class="p">.</span><span class="n">Failure</span><span class="p">&gt;)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><h3 id="sink">sink</h3>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-swift" data-lang="swift"><span class="line"><span class="cl"><span class="p">@</span><span class="n">available</span><span class="p">(</span><span class="n">macOS</span> <span class="mf">10.15</span><span class="p">,</span> <span class="n">iOS</span> <span class="mf">13.0</span><span class="p">,</span> <span class="n">tvOS</span> <span class="mf">13.0</span><span class="p">,</span> <span class="n">watchOS</span> <span class="mf">6.0</span><span class="p">,</span> <span class="o">*</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="kd">extension</span> <span class="nc">Publisher</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">/// Attaches a subscriber with closure-based behavior.</span>
</span></span><span class="line"><span class="cl">    <span class="c1">/// 将闭包行为的订阅者附加到发布者。</span>
</span></span><span class="line"><span class="cl">    <span class="c1">///</span>
</span></span><span class="line"><span class="cl">    <span class="c1">/// Use ``Publisher/sink(receiveCompletion:receiveValue:)`` to observe values received by the publisher and process them using a closure you specify.</span>
</span></span><span class="line"><span class="cl">    <span class="c1">/// 使用 ``Publisher/sink(receiveCompletion:receiveValue:)`` 来观察发布者接收到的值，并使用指定的闭包处理。</span>
</span></span><span class="line"><span class="cl">    <span class="c1">///</span>
</span></span><span class="line"><span class="cl">    <span class="c1">/// In this example, a &lt;doc://com.apple.documentation/documentation/Swift/Range&gt; publisher publishes integers to a ``Publisher/sink(receiveCompletion:receiveValue:)`` operator’s `receiveValue` closure that prints them to the console. Upon completion the ``Publisher/sink(receiveCompletion:receiveValue:)`` operator’s `receiveCompletion` closure indicates the successful termination of the stream.</span>
</span></span><span class="line"><span class="cl">    <span class="c1">/// 在此示例中，一个 &lt;doc://com.apple.documentation/documentation/Swift/Range&gt; 发布者将整数发布到 ``Publisher/sink(receiveCompletion:receiveValue:)`` 操作符的 ``receiveValue`` 闭包中，该闭包将它们打印到控制台。在完成后，``Publisher/sink(receiveCompletion:receiveValue:)`` 操作符的 ``receiveCompletion`` 闭包将标识为成功终止流。</span>
</span></span><span class="line"><span class="cl">    <span class="c1">///</span>
</span></span><span class="line"><span class="cl">    <span class="c1">///     let myRange = (0...3)</span>
</span></span><span class="line"><span class="cl">    <span class="c1">///     cancellable = myRange.publisher</span>
</span></span><span class="line"><span class="cl">    <span class="c1">///         .sink(receiveCompletion: { print (&#34;completion: \($0)&#34;) },</span>
</span></span><span class="line"><span class="cl">    <span class="c1">///               receiveValue: { print (&#34;value: \($0)&#34;) })</span>
</span></span><span class="line"><span class="cl">    <span class="c1">///</span>
</span></span><span class="line"><span class="cl">    <span class="c1">///     // Prints:</span>
</span></span><span class="line"><span class="cl">    <span class="c1">///     //  value: 0</span>
</span></span><span class="line"><span class="cl">    <span class="c1">///     //  value: 1</span>
</span></span><span class="line"><span class="cl">    <span class="c1">///     //  value: 2</span>
</span></span><span class="line"><span class="cl">    <span class="c1">///     //  value: 3</span>
</span></span><span class="line"><span class="cl">    <span class="c1">///     //  completion: finished</span>
</span></span><span class="line"><span class="cl">    <span class="c1">///</span>
</span></span><span class="line"><span class="cl">    <span class="c1">/// This method creates the subscriber and immediately requests an unlimited number of values, prior to returning the subscriber.</span>
</span></span><span class="line"><span class="cl">    <span class="c1">/// 该方法创建订阅者并立即请求无限数量的值，然后返回订阅者。</span>
</span></span><span class="line"><span class="cl">    <span class="c1">/// The return value should be held, otherwise the stream will be canceled.</span>
</span></span><span class="line"><span class="cl">    <span class="c1">/// 返回值应保留，否则流将被取消。</span>
</span></span><span class="line"><span class="cl">    <span class="c1">///</span>
</span></span><span class="line"><span class="cl">    <span class="c1">/// - parameter receiveComplete: The closure to execute on completion.</span>
</span></span><span class="line"><span class="cl">    <span class="c1">/// - 参数 receiveComplete: 在完成时执行的闭包。</span>
</span></span><span class="line"><span class="cl">    <span class="c1">/// - parameter receiveValue: The closure to execute on receipt of a value.</span>
</span></span><span class="line"><span class="cl">    <span class="c1">/// - 参数 receiveValue: 在接收到值时执行的闭包。</span>
</span></span><span class="line"><span class="cl">    <span class="c1">/// - Returns: A cancellable instance, which you use when you end assignment of the received value. Deallocation of the result will tear down the subscription stream.</span>
</span></span><span class="line"><span class="cl">    <span class="c1">/// - 返回值: 一个可取消的实例，当结束接收到的值的赋值时使用。结果的释放将中断订阅流。</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kd">func</span> <span class="nf">sink</span><span class="p">(</span><span class="n">receiveCompletion</span><span class="p">:</span> <span class="p">@</span><span class="n">escaping</span> <span class="p">((</span><span class="n">Subscribers</span><span class="p">.</span><span class="n">Completion</span><span class="p">&lt;</span><span class="kc">Self</span><span class="p">.</span><span class="n">Failure</span><span class="p">&gt;)</span> <span class="p">-&gt;</span> <span class="nb">Void</span><span class="p">),</span> <span class="n">receiveValue</span><span class="p">:</span> <span class="p">@</span><span class="n">escaping</span> <span class="p">((</span><span class="kc">Self</span><span class="p">.</span><span class="n">Output</span><span class="p">)</span> <span class="p">-&gt;</span> <span class="nb">Void</span><span class="p">))</span> <span class="p">-&gt;</span> <span class="n">AnyCancellable</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">@</span><span class="n">available</span><span class="p">(</span><span class="n">macOS</span> <span class="mf">10.15</span><span class="p">,</span> <span class="n">iOS</span> <span class="mf">13.0</span><span class="p">,</span> <span class="n">tvOS</span> <span class="mf">13.0</span><span class="p">,</span> <span class="n">watchOS</span> <span class="mf">6.0</span><span class="p">,</span> <span class="o">*</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="kd">extension</span> <span class="nc">Publisher</span> <span class="k">where</span> <span class="kc">Self</span><span class="p">.</span><span class="n">Failure</span> <span class="p">==</span> <span class="n">Never</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">/// Attaches a subscriber with closure-based behavior to a publisher that never fails.</span>
</span></span><span class="line"><span class="cl">    <span class="c1">/// 将具有闭包行为的订阅者附加到从不失败的发布者上。</span>
</span></span><span class="line"><span class="cl">    <span class="c1">///</span>
</span></span><span class="line"><span class="cl">    <span class="c1">/// Use ``Publisher/sink(receiveValue:)`` to observe values received by the publisher and print them to the console. This operator can only be used when the stream doesn’t fail, that is, when the publisher’s ``Publisher/Failure`` type is &lt;doc://com.apple.documentation/documentation/Swift/Never&gt;.</span>
</span></span><span class="line"><span class="cl">    <span class="c1">/// 使用 ``Publisher/sink(receiveValue:)`` 以观察发布者接收到的值，并将其打印到控制台。仅当流未失败时，即发布者的 ``Publisher/Failure`` 类型为 &lt;doc://com.apple.documentation/documentation/Swift/Never&gt; 时，才可使用此操作符.</span>
</span></span><span class="line"><span class="cl">    <span class="c1">///</span>
</span></span><span class="line"><span class="cl">    <span class="c1">/// In this example, a &lt;doc://com.apple.documentation/documentation/Swift/Range&gt; publisher publishes integers to a ``Publisher/sink(receiveValue:)`` operator’s</span>
</span></span><span class="line"><span class="cl">    <span class="c1">/// `receiveValue` closure that prints them to the console:</span>
</span></span><span class="line"><span class="cl">    <span class="c1">/// 以下例子中，&lt;doc://com.apple.documentation/documentation/Swift/Range&gt; 发布者发布整型到 ``Publisher/sink(receiveValue:)`` 操作符的 ``receiveValue`` 闭包中，并将其打印到控制台：</span>
</span></span><span class="line"><span class="cl">    <span class="c1">///</span>
</span></span><span class="line"><span class="cl">    <span class="c1">///     let integers = (0...3)</span>
</span></span><span class="line"><span class="cl">    <span class="c1">///     integers.publisher</span>
</span></span><span class="line"><span class="cl">    <span class="c1">///         .sink { print(&#34;Received \($0)&#34;) }</span>
</span></span><span class="line"><span class="cl">    <span class="c1">///</span>
</span></span><span class="line"><span class="cl">    <span class="c1">///     // Prints:</span>
</span></span><span class="line"><span class="cl">    <span class="c1">///     //  Received 0</span>
</span></span><span class="line"><span class="cl">    <span class="c1">///     //  Received 1</span>
</span></span><span class="line"><span class="cl">    <span class="c1">///     //  Received 2</span>
</span></span><span class="line"><span class="cl">    <span class="c1">///     //  Received 3</span>
</span></span><span class="line"><span class="cl">    <span class="c1">///</span>
</span></span><span class="line"><span class="cl">    <span class="c1">/// This method creates the subscriber and immediately requests an unlimited number of values, prior to returning the subscriber.</span>
</span></span><span class="line"><span class="cl">    <span class="c1">/// 此方法创建订阅者，并在返回订阅服务器之前立即请求无限数量的值。</span>
</span></span><span class="line"><span class="cl">    <span class="c1">/// The return value should be held, otherwise the stream will be canceled.</span>
</span></span><span class="line"><span class="cl">    <span class="c1">/// 返回值应保留，否则流将被取消。</span>
</span></span><span class="line"><span class="cl">    <span class="c1">///</span>
</span></span><span class="line"><span class="cl">    <span class="c1">/// - parameter receiveValue: The closure to execute on receipt of a value.</span>
</span></span><span class="line"><span class="cl">    <span class="c1">/// - 参数 receiveValue：在收到值时执行的闭包。</span>
</span></span><span class="line"><span class="cl">    <span class="c1">/// - Returns: A cancellable instance, which you use when you end assignment of the received value. Deallocation of the result will tear down the subscription stream.</span>
</span></span><span class="line"><span class="cl">    <span class="c1">/// - 返回值：一个可取消的实例，当结束接收值的赋值时可使用。结果的释放将销毁订阅流。</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kd">func</span> <span class="nf">sink</span><span class="p">(</span><span class="n">receiveValue</span><span class="p">:</span> <span class="p">@</span><span class="n">escaping</span> <span class="p">((</span><span class="kc">Self</span><span class="p">.</span><span class="n">Output</span><span class="p">)</span> <span class="p">-&gt;</span> <span class="nb">Void</span><span class="p">))</span> <span class="p">-&gt;</span> <span class="n">AnyCancellable</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>上文中使用的 <code>sink</code> 其实算是订阅者（虽然注释中称为 operator）。需要注意其返回值是否保存的差异：</p>
<ul>
<li>不接收完成事件：</li>
</ul>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-swift" data-lang="swift"><span class="line"><span class="cl"><span class="kd">let</span> <span class="nv">p</span> <span class="p">=</span> <span class="n">CurrentValueSubject</span><span class="p">&lt;</span><span class="nb">Int</span><span class="p">,</span> <span class="n">Never</span><span class="p">&gt;(</span><span class="mi">1</span><span class="p">)</span>    <span class="c1">// 创建后立即发布 1</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// sink(receiveValue:) -&gt; AnyCancellable</span>
</span></span><span class="line"><span class="cl"><span class="kc">_</span> <span class="p">=</span> <span class="n">p</span><span class="p">.</span><span class="n">sink</span> <span class="p">{</span> <span class="bp">print</span><span class="p">(</span><span class="s">&#34;_</span><span class="si">\(</span><span class="nv">$0</span><span class="si">)</span><span class="s">&#34;</span><span class="p">)</span> <span class="p">}</span>                <span class="c1">// 不保存，仅接收一次</span>
</span></span><span class="line"><span class="cl"><span class="kd">let</span> <span class="nv">cancellable</span> <span class="p">=</span> <span class="n">p</span><span class="p">.</span><span class="n">sink</span> <span class="p">{</span> <span class="bp">print</span><span class="p">(</span><span class="s">&#34;c_</span><span class="si">\(</span><span class="nv">$0</span><span class="si">)</span><span class="s">&#34;</span><span class="p">)</span> <span class="p">}</span> <span class="c1">// 保存</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">p</span><span class="p">.</span><span class="n">send</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">cancellable</span><span class="p">.</span><span class="n">cancel</span><span class="p">()</span>                          <span class="c1">// 取消后，不再接收</span>
</span></span><span class="line"><span class="cl"><span class="n">p</span><span class="p">.</span><span class="n">send</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// _1</span>
</span></span><span class="line"><span class="cl"><span class="c1">// c_1</span>
</span></span><span class="line"><span class="cl"><span class="c1">// c_2</span>
</span></span></code></pre></div><ul>
<li>接收完成事件：</li>
</ul>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-swift" data-lang="swift"><span class="line"><span class="cl"><span class="kd">let</span> <span class="nv">p</span> <span class="p">=</span> <span class="n">CurrentValueSubject</span><span class="p">&lt;</span><span class="nb">Int</span><span class="p">,</span> <span class="n">Never</span><span class="p">&gt;(</span><span class="mi">1</span><span class="p">)</span>                                <span class="c1">// 创建后立即发布 1</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// sink(receiveCompletion:, receiveValue:) -&gt; AnyCancellable</span>
</span></span><span class="line"><span class="cl"><span class="kc">_</span> <span class="p">=</span> <span class="n">p</span><span class="p">.</span><span class="n">sink</span><span class="p">(</span><span class="n">receiveCompletion</span><span class="p">:</span> <span class="p">{</span> <span class="kc">_</span> <span class="k">in</span> <span class="bp">print</span><span class="p">(</span><span class="s">&#34;_end&#34;</span><span class="p">)</span> <span class="p">})</span> <span class="p">{</span>                   <span class="c1">// 不保存，仅最初的接收一次，也不接收完成</span>
</span></span><span class="line"><span class="cl">    <span class="bp">print</span><span class="p">(</span><span class="s">&#34;_</span><span class="si">\(</span><span class="nv">$0</span><span class="si">)</span><span class="s">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="kd">let</span> <span class="nv">cancellable2</span> <span class="p">=</span> <span class="n">p</span><span class="p">.</span><span class="n">sink</span><span class="p">(</span><span class="n">receiveCompletion</span><span class="p">:</span> <span class="p">{</span> <span class="kc">_</span> <span class="k">in</span> <span class="bp">print</span><span class="p">(</span><span class="s">&#34;c2_end&#34;</span><span class="p">)</span> <span class="p">})</span> <span class="p">{</span>  <span class="c1">// 保存</span>
</span></span><span class="line"><span class="cl">    <span class="bp">print</span><span class="p">(</span><span class="s">&#34;c2_</span><span class="si">\(</span><span class="nv">$0</span><span class="si">)</span><span class="s">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">p</span><span class="p">.</span><span class="n">send</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">p</span><span class="p">.</span><span class="n">send</span><span class="p">(</span><span class="n">completion</span><span class="p">:</span> <span class="p">.</span><span class="n">finished</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">p</span><span class="p">.</span><span class="n">send</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span> <span class="c1">// 已结束的发布者，即使调用发布也不会再次发布</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">cancellable2</span><span class="p">.</span><span class="n">cancel</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// _1</span>
</span></span><span class="line"><span class="cl"><span class="c1">// c2_1</span>
</span></span><span class="line"><span class="cl"><span class="c1">// c2_4</span>
</span></span><span class="line"><span class="cl"><span class="c1">// c2_end</span>
</span></span></code></pre></div><h3 id="assign">assign</h3>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-swift" data-lang="swift"><span class="line"><span class="cl"><span class="p">@</span><span class="n">available</span><span class="p">(</span><span class="n">macOS</span> <span class="mf">10.15</span><span class="p">,</span> <span class="n">iOS</span> <span class="mf">13.0</span><span class="p">,</span> <span class="n">tvOS</span> <span class="mf">13.0</span><span class="p">,</span> <span class="n">watchOS</span> <span class="mf">6.0</span><span class="p">,</span> <span class="o">*</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="kd">extension</span> <span class="nc">Publisher</span> <span class="k">where</span> <span class="kc">Self</span><span class="p">.</span><span class="n">Failure</span> <span class="p">==</span> <span class="n">Never</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">/// Assigns each element from a publisher to a property on an object.</span>
</span></span><span class="line"><span class="cl">    <span class="c1">/// 将发布者中的每个元素分配给对象上的属性。</span>
</span></span><span class="line"><span class="cl">    <span class="c1">///</span>
</span></span><span class="line"><span class="cl">    <span class="c1">/// Use the ``Publisher/assign(to🔛)`` subscriber when you want to set a given property each time a publisher produces a value.</span>
</span></span><span class="line"><span class="cl">    <span class="c1">/// 当想要设置给定属性每次发布值时，使用 ``Publisher/assign(to🔛)`` 订阅者。</span>
</span></span><span class="line"><span class="cl">    <span class="c1">///</span>
</span></span><span class="line"><span class="cl">    <span class="c1">/// In this example, the ``Publisher/assign(to🔛)`` sets the value of the `anInt` property on an instance of `MyClass`:</span>
</span></span><span class="line"><span class="cl">    <span class="c1">/// 在这个例子中，``Publisher/assign(to🔛)`` 将设置 `MyClass` 的 `anInt` 属性的值：</span>
</span></span><span class="line"><span class="cl">    <span class="c1">///</span>
</span></span><span class="line"><span class="cl">    <span class="c1">///     class MyClass {</span>
</span></span><span class="line"><span class="cl">    <span class="c1">///         var anInt: Int = 0 {</span>
</span></span><span class="line"><span class="cl">    <span class="c1">///             didSet {</span>
</span></span><span class="line"><span class="cl">    <span class="c1">///                 print(&#34;anInt was set to: \(anInt)&#34;, terminator: &#34;; &#34;)</span>
</span></span><span class="line"><span class="cl">    <span class="c1">///             }</span>
</span></span><span class="line"><span class="cl">    <span class="c1">///         }</span>
</span></span><span class="line"><span class="cl">    <span class="c1">///     }</span>
</span></span><span class="line"><span class="cl">    <span class="c1">///</span>
</span></span><span class="line"><span class="cl">    <span class="c1">///     var myObject = MyClass()</span>
</span></span><span class="line"><span class="cl">    <span class="c1">///     let myRange = (0...2)</span>
</span></span><span class="line"><span class="cl">    <span class="c1">///     cancellable = myRange.publisher</span>
</span></span><span class="line"><span class="cl">    <span class="c1">///         .assign(to: \.anInt, on: myObject)</span>
</span></span><span class="line"><span class="cl">    <span class="c1">///</span>
</span></span><span class="line"><span class="cl">    <span class="c1">///     // Prints: &#34;anInt was set to: 0; anInt was set to: 1; anInt was set to: 2&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="c1">///</span>
</span></span><span class="line"><span class="cl">    <span class="c1">///  &gt; Important: The ``Subscribers/Assign`` instance created by this operator maintains a strong reference to `object`, and sets it to `nil` when the upstream publisher completes (either normally or with an error).</span>
</span></span><span class="line"><span class="cl">    <span class="c1">///  &gt; 重点：此操作符创建的 ``Subscribers/Assign`` 实例将保持对 `object` 的强引用，并在上游发布者完成（或者是因为错误而完成）时将其设置为 `nil`。</span>
</span></span><span class="line"><span class="cl">    <span class="c1">///</span>
</span></span><span class="line"><span class="cl">    <span class="c1">/// - Parameters:</span>
</span></span><span class="line"><span class="cl">    <span class="c1">/// - 参数：</span>
</span></span><span class="line"><span class="cl">    <span class="c1">///   - keyPath: A key path that indicates the property to assign. See [Key-Path Expression](https://developer.apple.com/library/archive/documentation/Swift/Conceptual/Swift_Programming_Language/Expressions.html#//apple_ref/doc/uid/TP40014097-CH32-ID563) in _The Swift Programming Language_ to learn how to use key paths to specify a property of an object.</span>
</span></span><span class="line"><span class="cl">    <span class="c1">///   - keyPath: 指示要分配的属性的键路径。请参见[关键路径表达式](https://developer.apple.com/library/archive/documentation/Swift/Conceptual/Swift_Programming_Language/Expressions.html#//apple_ref/doc/uid/TP40014097-CH32-ID563学习如何使用键路径指定对象的属性。</span>
</span></span><span class="line"><span class="cl">    <span class="c1">///   - object: The object that contains the property. The subscriber assigns the object’s property every time it receives a new value.</span>
</span></span><span class="line"><span class="cl">    <span class="c1">///   - object: 包含属性的对象。订阅者每次接收新值时，都将对象的属性分配。</span>
</span></span><span class="line"><span class="cl">    <span class="c1">/// - Returns: An ``AnyCancellable`` instance. Call ``Cancellable/cancel()`` on this instance when you no longer want the publisher to automatically assign the property. Deinitializing this instance will also cancel automatic assignment.</span>
</span></span><span class="line"><span class="cl">    <span class="c1">/// - 返回值：一个 ``AnyCancellable`` 实例。当不再需要发布者自动分配属性时，请调用 ``Cancellable/cancel()`` 方法来取消该实例的订阅。销毁该实例时，也会取消自动分配。</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kd">func</span> <span class="nf">assign</span><span class="p">&lt;</span><span class="n">Root</span><span class="p">&gt;(</span><span class="n">to</span> <span class="n">keyPath</span><span class="p">:</span> <span class="n">ReferenceWritableKeyPath</span><span class="p">&lt;</span><span class="n">Root</span><span class="p">,</span> <span class="kc">Self</span><span class="p">.</span><span class="n">Output</span><span class="p">&gt;,</span> <span class="n">on</span> <span class="n">object</span><span class="p">:</span> <span class="n">Root</span><span class="p">)</span> <span class="p">-&gt;</span> <span class="n">AnyCancellable</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>需要注意的是，<code>assign</code> 设置的对象本身需要是 <code>class</code> 类型的对象：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-swift" data-lang="swift"><span class="line"><span class="cl"><span class="kd">class</span> <span class="nc">Foo</span><span class="p">:</span> <span class="n">CustomStringConvertible</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">var</span> <span class="nv">bar</span> <span class="p">=</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="kd">var</span> <span class="nv">description</span><span class="p">:</span> <span class="nb">String</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="s">&#34;Foo - </span><span class="si">\(</span><span class="n">bar</span><span class="si">)</span><span class="s">&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">let</span> <span class="nv">p</span> <span class="p">=</span> <span class="n">CurrentValueSubject</span><span class="p">&lt;</span><span class="nb">Int</span><span class="p">,</span> <span class="n">Never</span><span class="p">&gt;(</span><span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">var</span> <span class="nv">f</span> <span class="p">=</span> <span class="n">Foo</span><span class="p">()</span>                                <span class="c1">// Foo - 0</span>
</span></span><span class="line"><span class="cl"><span class="kd">let</span> <span class="nv">cancellable</span> <span class="p">=</span> <span class="n">p</span><span class="p">.</span><span class="n">assign</span><span class="p">(</span><span class="n">to</span><span class="p">:</span> <span class="err">\</span><span class="p">.</span><span class="n">bar</span><span class="p">,</span> <span class="n">on</span><span class="p">:</span> <span class="n">f</span><span class="p">)</span> <span class="c1">// Foo - 1</span>
</span></span><span class="line"><span class="cl"><span class="n">p</span><span class="p">.</span><span class="n">send</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>                                    <span class="c1">// Foo - 2</span>
</span></span></code></pre></div><h2 id="其他">其他</h2>
<h3 id="subject-1">Subject</h3>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-swift" data-lang="swift"><span class="line"><span class="cl"><span class="c1">/// A publisher that exposes a method for outside callers to publish elements.</span>
</span></span><span class="line"><span class="cl"><span class="c1">/// 发布者，允许外部调用者发布元素。</span>
</span></span><span class="line"><span class="cl"><span class="c1">///</span>
</span></span><span class="line"><span class="cl"><span class="c1">/// A subject is a publisher that you can use to ”inject” values into a stream, by calling its ``Subject/send(_:)`` method. This can be useful for adapting existing imperative code to the Combine model.</span>
</span></span><span class="line"><span class="cl"><span class="c1">/// Subject 是一个发布者，可以用来「注入」值，通过调用其 ``Subject/send(_:)`` 方法来实现。这对适配现有的面向对象语言的代码很有用。</span>
</span></span><span class="line"><span class="cl"><span class="p">@</span><span class="n">available</span><span class="p">(</span><span class="n">macOS</span> <span class="mf">10.15</span><span class="p">,</span> <span class="n">iOS</span> <span class="mf">13.0</span><span class="p">,</span> <span class="n">tvOS</span> <span class="mf">13.0</span><span class="p">,</span> <span class="n">watchOS</span> <span class="mf">6.0</span><span class="p">,</span> <span class="o">*</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">protocol</span> <span class="nc">Subject</span><span class="p">&lt;</span><span class="n">Output</span><span class="p">,</span> <span class="n">Failure</span><span class="p">&gt;</span> <span class="p">:</span> <span class="nb">AnyObject</span><span class="p">,</span> <span class="n">Publisher</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">/// Sends a value to the subscriber.</span>
</span></span><span class="line"><span class="cl">    <span class="c1">/// 发送一个值给订阅者。</span>
</span></span><span class="line"><span class="cl">    <span class="c1">///</span>
</span></span><span class="line"><span class="cl">    <span class="c1">/// - Parameter value: The value to send.</span>
</span></span><span class="line"><span class="cl">    <span class="c1">/// - 参数 value: 要发送的值。</span>
</span></span><span class="line"><span class="cl">    <span class="kd">func</span> <span class="nf">send</span><span class="p">(</span><span class="kc">_</span> <span class="n">value</span><span class="p">:</span> <span class="kc">Self</span><span class="p">.</span><span class="n">Output</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">/// Sends a completion signal to the subscriber.</span>
</span></span><span class="line"><span class="cl">    <span class="c1">/// 发送一个完成信号给订阅者。</span>
</span></span><span class="line"><span class="cl">    <span class="c1">///</span>
</span></span><span class="line"><span class="cl">    <span class="c1">/// - Parameter completion: A `Completion` instance which indicates whether publishing has finished normally or failed with an error.</span>
</span></span><span class="line"><span class="cl">    <span class="c1">/// - 参数 completion: 一个 ``Completion`` 实例，该实例指示发布是否完成正常或者失败。</span>
</span></span><span class="line"><span class="cl">    <span class="kd">func</span> <span class="nf">send</span><span class="p">(</span><span class="n">completion</span><span class="p">:</span> <span class="n">Subscribers</span><span class="p">.</span><span class="n">Completion</span><span class="p">&lt;</span><span class="kc">Self</span><span class="p">.</span><span class="n">Failure</span><span class="p">&gt;)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">/// Sends a subscription to the subscriber.</span>
</span></span><span class="line"><span class="cl">    <span class="c1">/// 发送一个订阅给订阅者。</span>
</span></span><span class="line"><span class="cl">    <span class="c1">///</span>
</span></span><span class="line"><span class="cl">    <span class="c1">/// This call provides the ``Subject`` an opportunity to establish demand for any new upstream subscriptions.</span>
</span></span><span class="line"><span class="cl">    <span class="c1">/// 该调用提供 ``Subject`` 一个机会，以便它可以建立任何新的上游订阅。</span>
</span></span><span class="line"><span class="cl">    <span class="c1">///</span>
</span></span><span class="line"><span class="cl">    <span class="c1">/// - Parameter subscription: The subscription instance through which the subscriber can request elements.</span>
</span></span><span class="line"><span class="cl">    <span class="c1">/// - 参数 subscription: 订阅者可以通过该实例请求元素的订阅实例。</span>
</span></span><span class="line"><span class="cl">    <span class="kd">func</span> <span class="nf">send</span><span class="p">(</span><span class="n">subscription</span><span class="p">:</span> <span class="n">Subscription</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p><code>Subject</code> 也是发布者，外界可以通过 <code>send</code> 方法主动发布不同的值。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-swift" data-lang="swift"><span class="line"><span class="cl"><span class="kd">let</span> <span class="nv">p1</span> <span class="p">=</span> <span class="n">CurrentValueSubject</span><span class="p">&lt;</span><span class="nb">Int</span><span class="p">,</span> <span class="n">Never</span><span class="p">&gt;(</span><span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">p1</span><span class="p">.</span><span class="n">send</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">let</span> <span class="nv">c1</span> <span class="p">=</span> <span class="n">p1</span><span class="p">.</span><span class="n">sink</span><span class="p">(</span><span class="n">receiveCompletion</span><span class="p">:</span> <span class="p">{</span> <span class="kc">_</span> <span class="k">in</span> <span class="bp">print</span><span class="p">(</span><span class="s">&#34;c1_end&#34;</span><span class="p">)</span> <span class="p">})</span> <span class="p">{</span> <span class="bp">print</span><span class="p">(</span><span class="s">&#34;c1_</span><span class="si">\(</span><span class="nv">$0</span><span class="si">)</span><span class="s">&#34;</span><span class="p">)</span> <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">p1</span><span class="p">.</span><span class="n">send</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">p1</span><span class="p">.</span><span class="n">send</span><span class="p">(</span><span class="n">completion</span><span class="p">:</span> <span class="p">.</span><span class="n">finished</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">p1</span><span class="p">.</span><span class="n">send</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">c1</span><span class="p">.</span><span class="n">cancel</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// c1_2</span>
</span></span><span class="line"><span class="cl"><span class="c1">// c1_3</span>
</span></span><span class="line"><span class="cl"><span class="c1">// c1_end</span>
</span></span><span class="line"><span class="cl"><span class="c1">// ---</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">let</span> <span class="nv">p2</span> <span class="p">=</span> <span class="n">PassthroughSubject</span><span class="p">&lt;</span><span class="nb">Int</span><span class="p">,</span> <span class="n">Never</span><span class="p">&gt;()</span> <span class="c1">// 不会对订阅前的值保留 / 发布</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">p2</span><span class="p">.</span><span class="n">send</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">let</span> <span class="nv">c2</span> <span class="p">=</span> <span class="n">p2</span><span class="p">.</span><span class="n">sink</span><span class="p">(</span><span class="n">receiveCompletion</span><span class="p">:</span> <span class="p">{</span> <span class="kc">_</span> <span class="k">in</span> <span class="bp">print</span><span class="p">(</span><span class="s">&#34;c2_end&#34;</span><span class="p">)</span> <span class="p">})</span> <span class="p">{</span> <span class="bp">print</span><span class="p">(</span><span class="s">&#34;c2_</span><span class="si">\(</span><span class="nv">$0</span><span class="si">)</span><span class="s">&#34;</span><span class="p">)</span> <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">p2</span><span class="p">.</span><span class="n">send</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">p2</span><span class="p">.</span><span class="n">send</span><span class="p">(</span><span class="n">completion</span><span class="p">:</span> <span class="p">.</span><span class="n">finished</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">p2</span><span class="p">.</span><span class="n">send</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">c2</span><span class="p">.</span><span class="n">cancel</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="c1">// c2_2</span>
</span></span><span class="line"><span class="cl"><span class="c1">// c2_end</span>
</span></span></code></pre></div><h3 id="scheduler">Scheduler</h3>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-swift" data-lang="swift"><span class="line"><span class="cl"><span class="c1">/// A protocol that defines when and how to execute a closure.</span>
</span></span><span class="line"><span class="cl"><span class="c1">/// 一个定义何时以及怎样执行一个闭包的协议。</span>
</span></span><span class="line"><span class="cl"><span class="c1">///</span>
</span></span><span class="line"><span class="cl"><span class="c1">/// You can use a scheduler to execute code as soon as possible, or after a future date.</span>
</span></span><span class="line"><span class="cl"><span class="c1">/// 你可以使用一个调度器来立即执行代码，或者在未来的某个时间点执行代码。</span>
</span></span><span class="line"><span class="cl"><span class="c1">/// Individual scheduler implementations use whatever time-keeping system makes sense for them. Schedulers express this as their `SchedulerTimeType`. Since this type conforms to ``SchedulerTimeIntervalConvertible``, you can always express these times with the convenience functions like `.milliseconds(500)`. Schedulers can accept options to control how they execute the actions passed to them. These options may control factors like which threads or dispatch queues execute the actions.</span>
</span></span><span class="line"><span class="cl"><span class="c1">/// 不同的调度器实现使用对其有意义的计时系统。调度器将其表示为 `SchedulerTimeType`。由于此类型遵守了 ``SchedulerTimeIntervalConvertible``，所以可以始终使用诸如 `.milliseconds(500)` 的函数来表示这些时间。调度器可以接受选项来控制如何执行传递给它们的操作。这些选项可能会控制执行操作的线程或调度队列等因素。</span>
</span></span><span class="line"><span class="cl"><span class="p">@</span><span class="n">available</span><span class="p">(</span><span class="n">macOS</span> <span class="mf">10.15</span><span class="p">,</span> <span class="n">iOS</span> <span class="mf">13.0</span><span class="p">,</span> <span class="n">tvOS</span> <span class="mf">13.0</span><span class="p">,</span> <span class="n">watchOS</span> <span class="mf">6.0</span><span class="p">,</span> <span class="o">*</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">protocol</span> <span class="nc">Scheduler</span><span class="p">&lt;</span><span class="n">SchedulerTimeType</span><span class="p">&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">/// Describes an instant in time for this scheduler.</span>
</span></span><span class="line"><span class="cl">    <span class="c1">/// 描述此调度器的一个时间点。</span>
</span></span><span class="line"><span class="cl">    <span class="n">associatedtype</span> <span class="n">SchedulerTimeType</span> <span class="p">:</span> <span class="nb">Strideable</span> <span class="k">where</span> <span class="kc">Self</span><span class="p">.</span><span class="n">SchedulerTimeType</span><span class="p">.</span><span class="n">Stride</span> <span class="p">:</span> <span class="n">SchedulerTimeIntervalConvertible</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">/// A type that defines options accepted by the scheduler.</span>
</span></span><span class="line"><span class="cl">    <span class="c1">/// 表示调度器接受的选项的类型。</span>
</span></span><span class="line"><span class="cl">    <span class="c1">///</span>
</span></span><span class="line"><span class="cl">    <span class="c1">/// This type is freely definable by each `Scheduler`. Typically, operations that take a `Scheduler` parameter will also take `SchedulerOptions`.</span>
</span></span><span class="line"><span class="cl">    <span class="c1">/// 这个类型是自由定义的。通常，将一个 `Scheduler` 参数传递给操作时也会传递 `SchedulerOptions`。</span>
</span></span><span class="line"><span class="cl">    <span class="n">associatedtype</span> <span class="n">SchedulerOptions</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">/// This scheduler’s definition of the current moment in time.</span>
</span></span><span class="line"><span class="cl">    <span class="c1">/// 该调度器的当前时间点的定义。</span>
</span></span><span class="line"><span class="cl">    <span class="kd">var</span> <span class="nv">now</span><span class="p">:</span> <span class="kc">Self</span><span class="p">.</span><span class="n">SchedulerTimeType</span> <span class="p">{</span> <span class="kr">get</span> <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">/// The minimum tolerance allowed by the scheduler.</span>
</span></span><span class="line"><span class="cl">    <span class="c1">/// 调度器允许的最小容忍度。</span>
</span></span><span class="line"><span class="cl">    <span class="kd">var</span> <span class="nv">minimumTolerance</span><span class="p">:</span> <span class="kc">Self</span><span class="p">.</span><span class="n">SchedulerTimeType</span><span class="p">.</span><span class="n">Stride</span> <span class="p">{</span> <span class="kr">get</span> <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">/// Performs the action at the next possible opportunity.</span>
</span></span><span class="line"><span class="cl">    <span class="c1">/// 在下一个可能的机会执行操作。</span>
</span></span><span class="line"><span class="cl">    <span class="kd">func</span> <span class="nf">schedule</span><span class="p">(</span><span class="n">options</span><span class="p">:</span> <span class="kc">Self</span><span class="p">.</span><span class="n">SchedulerOptions</span><span class="p">?,</span> <span class="kc">_</span> <span class="n">action</span><span class="p">:</span> <span class="p">@</span><span class="n">escaping</span> <span class="p">()</span> <span class="p">-&gt;</span> <span class="nb">Void</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">/// Performs the action at some time after the specified date.</span>
</span></span><span class="line"><span class="cl">    <span class="c1">/// 在指定时间之后执行操作。</span>
</span></span><span class="line"><span class="cl">    <span class="kd">func</span> <span class="nf">schedule</span><span class="p">(</span><span class="n">after</span> <span class="n">date</span><span class="p">:</span> <span class="kc">Self</span><span class="p">.</span><span class="n">SchedulerTimeType</span><span class="p">,</span> <span class="n">tolerance</span><span class="p">:</span> <span class="kc">Self</span><span class="p">.</span><span class="n">SchedulerTimeType</span><span class="p">.</span><span class="n">Stride</span><span class="p">,</span> <span class="n">options</span><span class="p">:</span> <span class="kc">Self</span><span class="p">.</span><span class="n">SchedulerOptions</span><span class="p">?,</span> <span class="kc">_</span> <span class="n">action</span><span class="p">:</span> <span class="p">@</span><span class="n">escaping</span> <span class="p">()</span> <span class="p">-&gt;</span> <span class="nb">Void</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">/// Performs the action at some time after the specified date, at the specified frequency, optionally taking into account tolerance if possible.</span>
</span></span><span class="line"><span class="cl">    <span class="c1">/// 在指定时间之后执行操作，在指定的频率，可以选择是否考虑容忍度。</span>
</span></span><span class="line"><span class="cl">    <span class="kd">func</span> <span class="nf">schedule</span><span class="p">(</span><span class="n">after</span> <span class="n">date</span><span class="p">:</span> <span class="kc">Self</span><span class="p">.</span><span class="n">SchedulerTimeType</span><span class="p">,</span> <span class="n">interval</span><span class="p">:</span> <span class="kc">Self</span><span class="p">.</span><span class="n">SchedulerTimeType</span><span class="p">.</span><span class="n">Stride</span><span class="p">,</span> <span class="n">tolerance</span><span class="p">:</span> <span class="kc">Self</span><span class="p">.</span><span class="n">SchedulerTimeType</span><span class="p">.</span><span class="n">Stride</span><span class="p">,</span> <span class="n">options</span><span class="p">:</span> <span class="kc">Self</span><span class="p">.</span><span class="n">SchedulerOptions</span><span class="p">?,</span> <span class="kc">_</span> <span class="n">action</span><span class="p">:</span> <span class="p">@</span><span class="n">escaping</span> <span class="p">()</span> <span class="p">-&gt;</span> <span class="nb">Void</span><span class="p">)</span> <span class="p">-&gt;</span> <span class="n">Cancellable</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><ul>
<li><code>receive(on:options:)</code> 从上游接收并将数据发送到下游，并且在指定的线程上执行。</li>
</ul>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-swift" data-lang="swift"><span class="line"><span class="cl"><span class="p">@</span><span class="n">available</span><span class="p">(</span><span class="n">macOS</span> <span class="mf">10.15</span><span class="p">,</span> <span class="n">iOS</span> <span class="mf">13.0</span><span class="p">,</span> <span class="n">tvOS</span> <span class="mf">13.0</span><span class="p">,</span> <span class="n">watchOS</span> <span class="mf">6.0</span><span class="p">,</span> <span class="o">*</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="kd">extension</span> <span class="nc">Publisher</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">/// Specifies the scheduler on which to receive elements from the publisher.</span>
</span></span><span class="line"><span class="cl">    <span class="c1">///</span>
</span></span><span class="line"><span class="cl">    <span class="c1">/// You use the ``Publisher/receive(on:options:)`` operator to receive results and completion on a specific scheduler, such as performing UI work on the main run loop. In contrast with ``Publisher/subscribe(on:options:)``, which affects upstream messages, ``Publisher/receive(on:options:)`` changes the execution context of downstream messages.</span>
</span></span><span class="line"><span class="cl">    <span class="c1">///</span>
</span></span><span class="line"><span class="cl">    <span class="c1">/// In the following example, the ``Publisher/subscribe(on:options:)`` operator causes `jsonPublisher` to receive requests on `backgroundQueue`, while the</span>
</span></span><span class="line"><span class="cl">    <span class="c1">/// ``Publisher/receive(on:options:)`` causes `labelUpdater` to receive elements and completion on `RunLoop.main`.</span>
</span></span><span class="line"><span class="cl">    <span class="c1">///</span>
</span></span><span class="line"><span class="cl">    <span class="c1">///     let jsonPublisher = MyJSONLoaderPublisher() // Some publisher.</span>
</span></span><span class="line"><span class="cl">    <span class="c1">///     let labelUpdater = MyLabelUpdateSubscriber() // Some subscriber that updates the UI.</span>
</span></span><span class="line"><span class="cl">    <span class="c1">///</span>
</span></span><span class="line"><span class="cl">    <span class="c1">///     jsonPublisher</span>
</span></span><span class="line"><span class="cl">    <span class="c1">///         .subscribe(on: backgroundQueue)</span>
</span></span><span class="line"><span class="cl">    <span class="c1">///         .receive(on: RunLoop.main)</span>
</span></span><span class="line"><span class="cl">    <span class="c1">///         .subscribe(labelUpdater)</span>
</span></span><span class="line"><span class="cl">    <span class="c1">///</span>
</span></span><span class="line"><span class="cl">    <span class="c1">///</span>
</span></span><span class="line"><span class="cl">    <span class="c1">/// Prefer ``Publisher/receive(on:options:)`` over explicit use of dispatch queues when performing work in subscribers. For example, instead of the following pattern:</span>
</span></span><span class="line"><span class="cl">    <span class="c1">///</span>
</span></span><span class="line"><span class="cl">    <span class="c1">///     pub.sink {</span>
</span></span><span class="line"><span class="cl">    <span class="c1">///         DispatchQueue.main.async {</span>
</span></span><span class="line"><span class="cl">    <span class="c1">///             // Do something.</span>
</span></span><span class="line"><span class="cl">    <span class="c1">///         }</span>
</span></span><span class="line"><span class="cl">    <span class="c1">///     }</span>
</span></span><span class="line"><span class="cl">    <span class="c1">///</span>
</span></span><span class="line"><span class="cl">    <span class="c1">/// Use this pattern instead:</span>
</span></span><span class="line"><span class="cl">    <span class="c1">///</span>
</span></span><span class="line"><span class="cl">    <span class="c1">///     pub.receive(on: DispatchQueue.main).sink {</span>
</span></span><span class="line"><span class="cl">    <span class="c1">///         // Do something.</span>
</span></span><span class="line"><span class="cl">    <span class="c1">///     }</span>
</span></span><span class="line"><span class="cl">    <span class="c1">///</span>
</span></span><span class="line"><span class="cl">    <span class="c1">///  &gt; Note: ``Publisher/receive(on:options:)`` doesn’t affect the scheduler used to call the subscriber’s ``Subscriber/receive(subscription:)`` method.</span>
</span></span><span class="line"><span class="cl">    <span class="c1">///</span>
</span></span><span class="line"><span class="cl">    <span class="c1">/// - Parameters:</span>
</span></span><span class="line"><span class="cl">    <span class="c1">///   - scheduler: The scheduler the publisher uses for element delivery.</span>
</span></span><span class="line"><span class="cl">    <span class="c1">///   - options: Scheduler options used to customize element delivery.</span>
</span></span><span class="line"><span class="cl">    <span class="c1">/// - Returns: A publisher that delivers elements using the specified scheduler.</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kd">func</span> <span class="nf">receive</span><span class="p">&lt;</span><span class="n">S</span><span class="p">&gt;(</span><span class="n">on</span> <span class="n">scheduler</span><span class="p">:</span> <span class="n">S</span><span class="p">,</span> <span class="n">options</span><span class="p">:</span> <span class="n">S</span><span class="p">.</span><span class="n">SchedulerOptions</span><span class="p">?</span> <span class="p">=</span> <span class="kc">nil</span><span class="p">)</span> <span class="p">-&gt;</span> <span class="n">Publishers</span><span class="p">.</span><span class="n">ReceiveOn</span><span class="p">&lt;</span><span class="kc">Self</span><span class="p">,</span> <span class="n">S</span><span class="p">&gt;</span> <span class="k">where</span> <span class="n">S</span> <span class="p">:</span> <span class="n">Scheduler</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><ul>
<li><code>delay</code> 延迟一段时间发出：</li>
</ul>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-swift" data-lang="swift"><span class="line"><span class="cl"><span class="kd">import</span> <span class="nc">UIKit</span>
</span></span><span class="line"><span class="cl"><span class="kd">import</span> <span class="nc">Combine</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">class</span> <span class="nc">ViewController</span><span class="p">:</span> <span class="n">UIViewController</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="kd">let</span> <span class="nv">p</span> <span class="p">=</span> <span class="n">PassthroughSubject</span><span class="p">&lt;</span><span class="nb">String</span><span class="p">,</span> <span class="n">Never</span><span class="p">&gt;()</span> <span class="c1">// 发布者</span>
</span></span><span class="line"><span class="cl">    <span class="kd">var</span> <span class="nv">c</span><span class="p">:</span> <span class="n">AnyCancellable</span><span class="p">?</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kr">override</span> <span class="kd">func</span> <span class="nf">viewDidLoad</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="kc">super</span><span class="p">.</span><span class="n">viewDidLoad</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// Do any additional setup after loading the view.</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="n">c</span> <span class="p">=</span> <span class="n">p</span>
</span></span><span class="line"><span class="cl">            <span class="p">.</span><span class="n">delay</span><span class="p">(</span><span class="k">for</span><span class="p">:</span> <span class="p">.</span><span class="n">seconds</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="n">scheduler</span><span class="p">:</span> <span class="n">RunLoop</span><span class="p">.</span><span class="n">main</span><span class="p">)</span> <span class="c1">// 延迟一秒</span>
</span></span><span class="line"><span class="cl">            <span class="p">.</span><span class="n">sink</span> <span class="p">{</span> <span class="bp">print</span><span class="p">(</span><span class="s">&#34;</span><span class="si">\(</span><span class="n">Date</span><span class="si">())</span><span class="s"> - </span><span class="si">\(</span><span class="nv">$0</span><span class="si">)</span><span class="s">&#34;</span><span class="p">)</span> <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kr">override</span> <span class="kd">func</span> <span class="nf">touchesBegan</span><span class="p">(</span><span class="kc">_</span> <span class="n">touches</span><span class="p">:</span> <span class="n">Set</span><span class="p">&lt;</span><span class="n">UITouch</span><span class="p">&gt;,</span> <span class="n">with</span> <span class="n">event</span><span class="p">:</span> <span class="n">UIEvent</span><span class="p">?)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="bp">print</span><span class="p">(</span><span class="n">Date</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">        <span class="n">p</span><span class="p">.</span><span class="n">send</span><span class="p">(</span><span class="s">&#34;touched&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// 2022-07-03 06:27:16 +0000</span>
</span></span><span class="line"><span class="cl"><span class="c1">// 2022-07-03 06:27:17 +0000 - touched</span>
</span></span></code></pre></div><ul>
<li><code>debounce</code> 为防抖，接收前一事件后，开启定时器，定时器有效时间内每次接收到新事件则将定时器重置，除非在定时器失效后且有后续事件到达才再次发出：</li>
</ul>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-swift" data-lang="swift"><span class="line"><span class="cl"><span class="kd">import</span> <span class="nc">UIKit</span>
</span></span><span class="line"><span class="cl"><span class="kd">import</span> <span class="nc">Combine</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">class</span> <span class="nc">ViewController</span><span class="p">:</span> <span class="n">UIViewController</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="kd">let</span> <span class="nv">p</span> <span class="p">=</span> <span class="n">PassthroughSubject</span><span class="p">&lt;</span><span class="nb">String</span><span class="p">,</span> <span class="n">Never</span><span class="p">&gt;()</span> <span class="c1">// 发布者</span>
</span></span><span class="line"><span class="cl">    <span class="kd">var</span> <span class="nv">c</span><span class="p">:</span> <span class="n">AnyCancellable</span><span class="p">?</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kr">override</span> <span class="kd">func</span> <span class="nf">viewDidLoad</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="kc">super</span><span class="p">.</span><span class="n">viewDidLoad</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// Do any additional setup after loading the view.</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="n">c</span> <span class="p">=</span> <span class="n">p</span>
</span></span><span class="line"><span class="cl">            <span class="p">.</span><span class="n">debounce</span><span class="p">(</span><span class="k">for</span><span class="p">:</span> <span class="p">.</span><span class="n">seconds</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="n">scheduler</span><span class="p">:</span> <span class="n">RunLoop</span><span class="p">.</span><span class="n">main</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="p">.</span><span class="n">sink</span> <span class="p">{</span> <span class="bp">print</span><span class="p">(</span><span class="s">&#34;</span><span class="si">\(</span><span class="n">Date</span><span class="si">())</span><span class="s"> - </span><span class="si">\(</span><span class="nv">$0</span><span class="si">)</span><span class="s">&#34;</span><span class="p">)</span> <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kr">override</span> <span class="kd">func</span> <span class="nf">touchesBegan</span><span class="p">(</span><span class="kc">_</span> <span class="n">touches</span><span class="p">:</span> <span class="n">Set</span><span class="p">&lt;</span><span class="n">UITouch</span><span class="p">&gt;,</span> <span class="n">with</span> <span class="n">event</span><span class="p">:</span> <span class="n">UIEvent</span><span class="p">?)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="bp">print</span><span class="p">(</span><span class="n">Date</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">        <span class="n">p</span><span class="p">.</span><span class="n">send</span><span class="p">(</span><span class="s">&#34;touched&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// 2022-07-03 06:28:30 +0000</span>
</span></span><span class="line"><span class="cl"><span class="c1">// 2022-07-03 06:28:31 +0000 - touched</span>
</span></span><span class="line"><span class="cl"><span class="c1">// 2022-07-03 06:28:32 +0000</span>
</span></span><span class="line"><span class="cl"><span class="c1">// 2022-07-03 06:28:32 +0000</span>
</span></span><span class="line"><span class="cl"><span class="c1">// 2022-07-03 06:28:33 +0000</span>
</span></span><span class="line"><span class="cl"><span class="c1">// 2022-07-03 06:28:34 +0000</span>
</span></span><span class="line"><span class="cl"><span class="c1">// 2022-07-03 06:28:34 +0000</span>
</span></span><span class="line"><span class="cl"><span class="c1">// 2022-07-03 06:28:35 +0000 - touched</span>
</span></span></code></pre></div><h2 id="参考">参考</h2>
<ul>
<li><a href="https://developer.apple.com/documentation/combine">Combine - Apple</a></li>
<li><a href="https://objccn.io/products/swift-ui">SwiftUI 与 Combine 编程 - 王巍</a></li>
</ul>
</div>
                    <div class="post_footer">
                        
                        <div class="meta">
                            <div class="info">
                                <span class="field tags">
                                    <i class="ri-stack-line"></i>
                                    
                                    <a href="https://kingcos.me/tags/focus/">Focus</a>
                                    
                                    <a href="https://kingcos.me/tags/ios/">iOS</a>
                                    
                                    <a href="https://kingcos.me/tags/swift/">Swift</a>
                                    
                                    <a href="https://kingcos.me/tags/swiftui/">SwiftUI</a>
                                    
                                </span>
                            </div>
                        </div>
                        
                    </div>
                </div>
                <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<table style="border: 0;">
  <tr>
  <td style="border: 0; width: 30%;">
    <img width='100%' src='/img/about/1.jpg'>
  </td>
  <td style="border: 0; width: 50%;">
    
    <ins class="adsbygoogle"
     style="display:block;width:100%;"
     data-ad-client="ca-pub-9925978992661955"
     data-ad-slot="3213735320"
     data-ad-format="rectangle"
     data-full-width-responsive="false"></ins>
  </td>
  </tr>
</table>

<hr>

<script>
    (adsbygoogle = window.adsbygoogle || []).push({});
</script>
                
                
                







    
    
    
    <div>
        <div id="github-comment">
        </div>

        <script type="text/javascript">
        function getUtterances(isDark) {
            var utterances = document.createElement('script');
            utterances.type = 'text/javascript';
            utterances.async = true;
            utterances.setAttribute('issue-term', "pathname")
            utterances.setAttribute('repo', "kingcos\/kingcos.github.io")
            utterances.setAttribute('label', "comments")
            isDark ? utterances.setAttribute('theme', "github-dark") : utterances.setAttribute('theme', "github-light")
            utterances.crossorigin = 'anonymous';
            utterances.src = 'https://utteranc.es/client.js';

            return utterances
        }
        document.getElementById('github-comment').appendChild(getUtterances(false))
        </script>
    </div>
    




                
            </div>
        </div>
    </div>
    <a id="back_to_top" href="#" class="back_to_top"><i class="ri-arrow-up-s-line"></i></a>
    <footer class="footer">
    <div class="powered_by">
        <a href="https://kingcos.me">Powered by kingcos with love.</a>
    </div>

    <div class="footer_slogan">
        <span>❤️</span>
    </div>
</footer>
    <script src="https://kingcos.me/js/jquery-3.5.1.min.js"></script>
<link href="https://kingcos.me/css/fancybox.min.css" rel="stylesheet">
<script src="https://kingcos.me/js/fancybox.min.js"></script>
<script src="https://kingcos.me/js/zozo.js"></script>


<script type="text/javascript" async
    src="https://cdn.bootcss.com/mathjax/2.7.5/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
        MathJax.Hub.Config({
            tex2jax: {
                inlineMath: [['$', '$'], ['\\(', '\\)']],
                displayMath: [['$$', '$$'], ['\[\[', '\]\]']],
                processEscapes: true,
                processEnvironments: true,
                skipTags: ['script', 'noscript', 'style', 'textarea', 'pre'],
                TeX: {
                    equationNumbers: { autoNumber: "AMS" },
                    extensions: ["AMSmath.js", "AMSsymbols.js"]
                }
            }
        });

        MathJax.Hub.Queue(function () {
            
            
            
            var all = MathJax.Hub.getAllJax(), i;
            for (i = 0; i < all.length; i += 1) {
                all[i].SourceElement().parentNode.className += ' has-jax';
            }
        });
    </script>

<style>
    code.has-jax {
        font: inherit;
        font-size: 100%;
        background: inherit;
        border: inherit;
        color: #515151;
    }
</style>



<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-138311951-1', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>

</body>

</html>